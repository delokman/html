<!DOCTYPE html>
<!-- saved from url=(0079)https://docs.evolveum.com/book/practical-identity-management-with-midpoint.html -->
<html lang="en" class="fa-events-icons-ready" style="--fade-opacity:1;"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="keywords" content="Identity management, IDM, Identity and Access Management, IAM, Open source, OSS, midPoint, Evolveum">
<meta name="author" content="Radovan Semančík et al.">
<meta name="copyright" content="CC-BY-NC-ND 4.0">
<title>Practical Identity Management With MidPoint</title>
<link rel="stylesheet" href="./Practical Identity Management With MidPoint_files/css">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="./Practical Identity Management With MidPoint_files/font-awesome.min.css">
<link href="./Practical Identity Management With MidPoint_files/840a321d95.css" media="all" rel="stylesheet"></head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Practical Identity Management With MidPoint</h1>


</div>
<div id="content">

<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
It’s a dangerous business, Frodo, going out your door.<br><span class="segmentSeparator"></span>You step onto the road, and if you don’t keep your feet, there’s no knowing where you might be swept off to.<br><span class="segmentSeparator"></span></blockquote>
<div class="attribution">
— Bilbo Baggins<br>
<cite>The Lord of the Rings by J.R.R.<br><span class="segmentSeparator"></span>Tolkien</cite>
</div>
</div>
<div class="paragraph">
<p>Many years ago we started a project.<br><span class="segmentSeparator"></span>Because we had to.<br><span class="segmentSeparator"></span>Back then we didn’t think too much about business and markets and things like that.<br><span class="segmentSeparator"></span>We were focused on the technology.<br><span class="segmentSeparator"></span>And the project simply went on.<br><span class="segmentSeparator"></span>It had its ups and downs – but all the time there was pure engineering passion.<br><span class="segmentSeparator"></span>The effort brought fruits and now there is a product like no other: midPoint.</p>
</div>
<div class="paragraph">
<p>MidPoint is an identity management and governance system.<br><span class="segmentSeparator"></span>We built it from scratch.<br><span class="segmentSeparator"></span>It is a comprehensive and feature-rich system.<br><span class="segmentSeparator"></span>MidPoint can handle complete identity lifecycle management and some parts of identity governance and compliance.<br><span class="segmentSeparator"></span>It can speed up the process that create accounts for new employee.<br><span class="segmentSeparator"></span>MidPoint can automatically disable accounts of an employee after his contract has expired.<br><span class="segmentSeparator"></span>MidPoint manages assignment of roles and privileges to employees, partners, agents, contractors, customers or students.<br><span class="segmentSeparator"></span>MidPoint keeps an eye that the policies are continually maintained and enforced.<br><span class="segmentSeparator"></span>It governs the processes of access reviews.<br><span class="segmentSeparator"></span>It provides auditing and reporting based on the identity data.<br><span class="segmentSeparator"></span>And recent midPoint versions are heading towards the field of compliance: management of new and changed policies, evaluation how compliant is your setup according to those policies and governing smooth adoption of the policies.</p>
</div>
<div class="paragraph">
<p>MidPoint is such a comprehensive system that there are not many products in existence that can compete with midPoint.<br><span class="segmentSeparator"></span>But midPoint has one critical advantage over those few competing products: it is completely open source.<br><span class="segmentSeparator"></span>Open source is the fundamental philosophy of midPoint.<br><span class="segmentSeparator"></span>We believe that open source is a critical aspect in the development of modern quality software.<br><span class="segmentSeparator"></span>And open source principle is absolutely essential for the midPoint community: partners, contributors supporters and in fact all the engineers that work with midPoint.<br><span class="segmentSeparator"></span>Open source strategy means that any engineer can completely understand midPoint.<br><span class="segmentSeparator"></span>It also means that midPoint can be modified as needed, that issues can be fixed quickly and especially to ensure the continuity of midPoint development.<br><span class="segmentSeparator"></span>After all these years with midPoint we simply cannot imagine using any identity technology which is not open source.</p>
</div>
<div class="paragraph">
<p>Significant part of the team that have built midPoint have been dealing with identity management deployments since early 2000s.<br><span class="segmentSeparator"></span>The term “Identity and Access Management” (IAM) was not even invented at that time.<br><span class="segmentSeparator"></span>We have seen a lot of IAM solutions during our careers.<br><span class="segmentSeparator"></span>The IDM system was the core of vast majority of these solutions.<br><span class="segmentSeparator"></span>Whether it is given by our point of view or whether that is the generic rule we do not know for sure.<br><span class="segmentSeparator"></span>All we know is that midPoint is a really useful tool.<br><span class="segmentSeparator"></span>When it is used by the right hands, midPoint can do miracles.<br><span class="segmentSeparator"></span>And this is exactly what this book is all about: the right use of midPoint to build a practical Identity Management solutions.<br><span class="segmentSeparator"></span>This book will tell you how to deploy a practical IDM solution.<br><span class="segmentSeparator"></span>But it will also tell you why to do it in the first place.<br><span class="segmentSeparator"></span>The book will explain not just the features and configuration options.<br><span class="segmentSeparator"></span>It will also describe the motivation and the underlying principles.<br><span class="segmentSeparator"></span>Understanding the principles is as at least as important as knowing the mechanics of an IDM product.<br><span class="segmentSeparator"></span>The book usually describes how the things work when they work.<br><span class="segmentSeparator"></span>But we also try to describe the limitations, drawbacks and pitfalls.<br><span class="segmentSeparator"></span>The limitations are often much more important than the features, especially when designing a new solution on a green field.</p>
</div>
<div class="paragraph">
<p>First chapter is an introduction to the basic concepts of Identity and Access Management (IAM).<br><span class="segmentSeparator"></span>It is very general and does not deal with midPoint at all.<br><span class="segmentSeparator"></span>Therefore if you are familiar with Identity and Access Management feel free to skip the first chapter.<br><span class="segmentSeparator"></span>If you are impatient and want to start directly with midPoint then do the same (you would do that anyway, right?).<br><span class="segmentSeparator"></span>But in that case please find the time to return to the first chapter later.<br><span class="segmentSeparator"></span>That chapter contains important information to put midPoint in broader context.<br><span class="segmentSeparator"></span>You will need that information to build a complete IAM solution.</p>
</div>
<div class="paragraph">
<p>Second chapter describes the midPoint big picture.<br><span class="segmentSeparator"></span>It shows how midPoint looks like from the outside.<br><span class="segmentSeparator"></span>It describes how midPoint is usually used and how it behaves.<br><span class="segmentSeparator"></span>The purpose of this chapter is to familiarize the reader with midPoint workings and basic principles.<br><span class="segmentSeparator"></span>It describes how midPoint is used.</p>
</div>
<div class="paragraph">
<p>Third chapter describes the basic concepts of midPoint deployment and configuration.<br><span class="segmentSeparator"></span>It guides the reader through midPoint installation.<br><span class="segmentSeparator"></span>It describes how midPoint is customized to suit the needs of a particular deployment.<br><span class="segmentSeparator"></span>However midPoint customization is a very complex matter.<br><span class="segmentSeparator"></span>This chapter describes just the basic principles.<br><span class="segmentSeparator"></span>It will take most of the book to fill in the details.</p>
</div>
<div class="paragraph">
<p>Fourth chapter describes the concepts of resource and mappings.<br><span class="segmentSeparator"></span>This is the bread-and-butter of an identity management.<br><span class="segmentSeparator"></span>This chapter will tell you how to create very basic midPoint deployment, how to connect target systems and how to map and transform the data.</p>
</div>
<div class="paragraph">
<p>Fifth chapter is all about synchronization.<br><span class="segmentSeparator"></span>Primary purpose of synchronization is to get the data from the source systems such as HR system to midPoint.<br><span class="segmentSeparator"></span>But midPoint synchronization is much more powerful than that.<br><span class="segmentSeparator"></span>This chapter also expands the explanation of underlying midPoint principles such as mappings and deltas.</p>
</div>
<div class="paragraph">
<p>Sixth chapter talks about midPoint schema.<br><span class="segmentSeparator"></span>MidPoint has a built-in identity data model.<br><span class="segmentSeparator"></span>But even though this data model is quite rich, it is usually not sufficient to cover all the real-world use cases.<br><span class="segmentSeparator"></span>Therefore the data model is designed to be extensible.<br><span class="segmentSeparator"></span>This chapter describes the methods how a new data items can be defined in midPoint schema.</p>
</div>
<div class="paragraph">
<p>Seventh chapter is all about role-based access control (RBAC).<br><span class="segmentSeparator"></span>MidPoint role-based model is a very powerful tool to set up complex structures describing job roles, responsibilities, privileges and so on.<br><span class="segmentSeparator"></span>But the role model, and especially the concept of assignment, are generic mechanisms that are used in almost every part of midPoint.<br><span class="segmentSeparator"></span>Organizational structure management and many identity governance features are built on the foundations described in this chapter.</p>
</div>
<div class="paragraph">
<p>Eighth chapter is an introduction to object templates.<br><span class="segmentSeparator"></span>Those templates form a basis of an internal data consistency in midPoint.<br><span class="segmentSeparator"></span>They can be used to set up simple policies and automation rules.</p>
</div>
<div class="paragraph">
<p>Ninth chapter is about troubleshooting.<br><span class="segmentSeparator"></span>To err is human.<br><span class="segmentSeparator"></span>And given all the flexibility of midPoint mechanisms configuration mistakes just happen and it may not be easy to figure out the root cause of problems.<br><span class="segmentSeparator"></span>Therefore this chapter provides an overview of midPoint diagnostic facilities and recommendations for their use.</p>
</div>
<div class="paragraph">
<p>Tenth chapter provides overview of midPoint development process and overall approach.<br><span class="segmentSeparator"></span>It is also explained how midPoint development is funded and how midPoint subscriptions work.</p>
</div>
<div class="paragraph">
<p>Eleventh chapter is a collections of pointers to additional information.<br><span class="segmentSeparator"></span>This includes a pointer to sample files that accompany this book.</p>
</div>
<div class="paragraph">
<p>The following chapters are not written yet.<br><span class="segmentSeparator"></span>The description of policies, entitlements, authorizations, archetypes and all the other advanced topics is missing.<br><span class="segmentSeparator"></span>This book is not finished yet.<br><span class="segmentSeparator"></span>Similarly to midPoint itself, this book is written in an incremental and iterative way.<br><span class="segmentSeparator"></span>Writing a good book is a huge task in itself and it takes a lot of time.<br><span class="segmentSeparator"></span>And we cannot dedicate that much time to writing the book in one huge chunk.<br><span class="segmentSeparator"></span>But obviously a book like this is needed for midPoint community.<br><span class="segmentSeparator"></span>Therefore we have decided not to wait until the book is complete.<br><span class="segmentSeparator"></span>We will be continuously publishing those chapters that are reasonably well finished.<br><span class="segmentSeparator"></span>It is better to have something than to have nothing, isn’t it?<br><span class="segmentSeparator"></span>Therefore please be patient.<br><span class="segmentSeparator"></span>The whole book will be finished eventually.<br><span class="segmentSeparator"></span>And as always – your support, contributions and sponsoring may considerably speed up things here.</p>
</div>
<div class="paragraph">
<p>We would like to thank all the midPoint developers, contributors and supporters.<br><span class="segmentSeparator"></span>There was a lot of people involved in midPoint during all these years.<br><span class="segmentSeparator"></span>All these people pushed midPoint forward.<br><span class="segmentSeparator"></span>But most of all we would like to thank the people that were there when the midPoint project was young and that are still there until this day.<br><span class="segmentSeparator"></span>We would like to thank Katka Stanovská, Katka Valaliková, Igor Farinič, Ivan Noris, Vilo Repáň, Pavol Mederly and Radovan Semančík.<br><span class="segmentSeparator"></span>Those were the people that were there when midPoint was young.<br><span class="segmentSeparator"></span>And those are still the people who are the force that drives midPoint into the future.</p>
</div>
<div class="paragraph">
<p>Anything that is stated in this book are the opinions of the authors.<br><span class="segmentSeparator"></span>We have tried really hard to remain objective.<br><span class="segmentSeparator"></span>However as hard as we might try some points of view are difficult to change.<br><span class="segmentSeparator"></span>We work for Evolveum – a company that is also an IDM vendor.<br><span class="segmentSeparator"></span>Therefore our opinions may be slightly biased.<br><span class="segmentSeparator"></span>We have honestly tried to avoid any biases and follow proper engineering practices.<br><span class="segmentSeparator"></span>And you are the judge and the jury in this matter.<br><span class="segmentSeparator"></span>You, the reader, will decide whether we have succeeded or not.<br><span class="segmentSeparator"></span>You have free access to all the necessary information to do that: this book is freely available as is all the midPoint documentation and the source code.<br><span class="segmentSeparator"></span>We are not hiding anything.<br><span class="segmentSeparator"></span>Unlike many other vendors we do not want or need to hide any aspect of the software that we are producing.</p>
</div>
<div class="paragraph">
<p>This work is licensed under a Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License (CC&nbsp;BY-NC-ND).<br><span class="segmentSeparator"></span>This essentially means that you can freely use this book for a personal use.<br><span class="segmentSeparator"></span>You can retrieve and distribute it at no cost.<br><span class="segmentSeparator"></span>However you are not allowed to sell it, modify it or use any parts of this book in commercial projects.<br><span class="segmentSeparator"></span>There is no direct profit that we make from this book.<br><span class="segmentSeparator"></span>The primary reason for writing this book is to spread knowledge about midPoint.<br><span class="segmentSeparator"></span>However even open source projects such as midPoint need funding.<br><span class="segmentSeparator"></span>If you use midPoint in a commercial project that is a source of profit we think it is only fair if you share part of that profit with midPoint authors.<br><span class="segmentSeparator"></span>Therefore we have chosen the CC&nbsp;BY-NC-ND license for this book.<br><span class="segmentSeparator"></span>You can use this book freely to learn about midPoint.<br><span class="segmentSeparator"></span>However this license does not give you right to take parts of this book and include it in your project documentation.<br><span class="segmentSeparator"></span>You can point to this book by URL, but you are not allowed to pass this book to the customer as a part of product documentation in a commercial project.<br><span class="segmentSeparator"></span>You are not allowed to use this book as material during commercial training.<br><span class="segmentSeparator"></span>You are not allowed use the book in any way that generates profit.<br><span class="segmentSeparator"></span>If you need to use this book in such a way please contact Evolveum and you can obtain special license to do this.<br><span class="segmentSeparator"></span>The license fees collected in this way will be used to improve midPoint and especially midPoint documentation.<br><span class="segmentSeparator"></span>You know as well as we do that this is needed.</p>
</div>
<div class="paragraph">
<p>Following people have worked on the words and pictures that make up this book:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Radovan Semančík (author and maintainer)</p>
</li>
<li>
<p>Veronika Kolpaščiková (illustrations, corrections)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Yet there is much more people whose work was needed to make this work happen: midPoint developers, contributors, analysts and deployment engineers, specialists and generalists, theoretical scientists and practical engineers, technical staff and business people, people of Evolveum and the people that work for our partners, our families, friends and all the engineers and scientists for generations and generations past.<br><span class="segmentSeparator"></span>We indeed stand on the shoulders of giants.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="01-idm-intro">1.<br><span class="segmentSeparator"></span>Understanding Identity and Access Management</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
The beginning of knowledge is the discovery of something we do not understand.<br><span class="segmentSeparator"></span></blockquote>
<div class="attribution">
— Frank Herbert
</div>
</div>
<div class="paragraph">
<p>What is identity and access management?<br><span class="segmentSeparator"></span>Answer to that question is both easy and very complex.<br><span class="segmentSeparator"></span>The easy part is: Identity and access management (IAM) is a set of information technologies that deal with identities in the cyberspace.<br><span class="segmentSeparator"></span>The complex part of the answer takes the rest of this book.</p>
</div>
<div class="paragraph">
<p>This book deals mostly with <em>Enterprise Identity and Access Management</em>.<br><span class="segmentSeparator"></span>That is identity and access management applied to larger organizations such as enterprises, financial institutions, government agencies, universities, health care, etc.<br><span class="segmentSeparator"></span>The focus is on managing employees, contractors, customers, partners, students and other people that cooperate with the organization.<br><span class="segmentSeparator"></span>However, many of the mechanisms and principles described in this book can be applied to non-enterprise environments.</p>
</div>
<div class="paragraph">
<p>The story of identity and access management starts with information security.<br><span class="segmentSeparator"></span>The security requirements dictate the need for authentication and authorization of the users.<br><span class="segmentSeparator"></span>Authentication is a mechanism by which the computer checks that the user is really the one he pretends to be.<br><span class="segmentSeparator"></span>And authorization is a related mechanism by which the computer determines whether to allow of deny specific action to a user.<br><span class="segmentSeparator"></span>Almost every computer system has some means of authentication and authorization.</p>
</div>
<div class="paragraph">
<p>Perhaps the most widespread form of authentication is a password-based "log in" procedure.<br><span class="segmentSeparator"></span>The user presents an identifier and a password.<br><span class="segmentSeparator"></span>The computer checks whether the password is valid.<br><span class="segmentSeparator"></span>For this procedure to work the computer needs an access to the database of all valid users and passwords.<br><span class="segmentSeparator"></span>Early stand-alone information systems had their own databases that were isolated from the rest of the cyberspace.<br><span class="segmentSeparator"></span>The data were maintained manually.<br><span class="segmentSeparator"></span>But the advent of computer networking changed everything.<br><span class="segmentSeparator"></span>Users were able to access many systems and the systems themselves were connected to each other.<br><span class="segmentSeparator"></span>Maintaining an isolated user database in each system no longer made much sense.<br><span class="segmentSeparator"></span>And that’s where the real story of digital identity begins.</p>
</div>
<div class="sect2">
<h3 id="_directory_services_and_other_user_databases">Directory Services and Other User Databases</h3>
<div class="paragraph">
<p>The central concept of identity management is a data record that contains information about a person.<br><span class="segmentSeparator"></span>This concept has many names: user profile, persona, user record, digital identity and many more.<br><span class="segmentSeparator"></span>The most common name in the context of identity management is <em>user account</em>.<br><span class="segmentSeparator"></span>Accounts usually hold the information that describes the real-world person using a set of attributes such as given name and family name.<br><span class="segmentSeparator"></span>But probably the most important part is the technical information that relates to operation of an information system for which the account is created.<br><span class="segmentSeparator"></span>This includes operational parameters such as location of users home directory, wide variety of permission information such as group and role membership, system resource limits and so on.<br><span class="segmentSeparator"></span>User accounts are represented in a wide variety of forms ranging from relational database records through structured data files to semi-structured text files.<br><span class="segmentSeparator"></span>But regardless of the specific method used to store and process the records the <em>account</em> is undoubtedly one of the most important concepts of IAM field.<br><span class="segmentSeparator"></span>And so are the databases where the accounts are stored as accounts, being data records, have to be stored somewhere.</p>
</div>
<div class="paragraph">
<p>The account databases are as varied as are the account types.<br><span class="segmentSeparator"></span>Most account databases in the past were implemented as an integral part of the monolithic information system using the same database technology as the system itself used.<br><span class="segmentSeparator"></span>This is an obvious choice and it remains very popular even today.<br><span class="segmentSeparator"></span>Therefore many accounts are stored in relational database tables and similar application data stores.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/01-01-applications.png" alt="Applications">
</div>
</div>
<div class="paragraph">
<p>Application data stores are usually tightly bound to the application.<br><span class="segmentSeparator"></span>Therefore accounts stored in such databases are difficult to share with other applications.<br><span class="segmentSeparator"></span>However, sharing account data across the organization is more than desirable.<br><span class="segmentSeparator"></span>It makes very little sense to maintain account data in each database separately – especially if most the accounts are the same in each application.<br><span class="segmentSeparator"></span>Therefore there is a strong motivation to deploy account databases that can be shared by many applications.</p>
</div>
<div class="paragraph">
<p>Shared data storage is the purpose of directory servers.<br><span class="segmentSeparator"></span>While application databases usually use their own proprietary protocol, <em>directory servers</em> implement standardized protocols.<br><span class="segmentSeparator"></span>While databases are built for completely custom data model, directory servers usually extend standardized data model which improves interoperability.<br><span class="segmentSeparator"></span>While databases are often heavyweight and expensive to scale, directory servers are lightweight and designed for massive scalability.<br><span class="segmentSeparator"></span>That makes directory servers ideal candidates for shared account database.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/01-02-directory-server.png" alt="Directory server">
</div>
</div>
<div class="paragraph">
<p>Shared identity store is making user management easier.<br><span class="segmentSeparator"></span>An account needs to be created and managed in one place only.<br><span class="segmentSeparator"></span>Authentication still happens in each application separately.<br><span class="segmentSeparator"></span>But as the applications use the same credentials from the shared store, the user may use the same password for all the connected applications.</p>
</div>
<div class="paragraph">
<p>Lightweight Directory Access Protocol (LDAP) is a standard protocol for directory service access.<br><span class="segmentSeparator"></span>It is an old protocol when judging by Internet age standards.<br><span class="segmentSeparator"></span>LDAP roots are going as far back as 1980s to a family of telecommunication protocols known as X.500.<br><span class="segmentSeparator"></span>Even though LDAP may be old it is far from being obsolete.<br><span class="segmentSeparator"></span>Quite the contrary.<br><span class="segmentSeparator"></span>It is a very efficient binary protocol that was designed to support massively distributed shared databases.<br><span class="segmentSeparator"></span>It has small set of well defined simple operations.<br><span class="segmentSeparator"></span>The operations and the data model implied by the protocol allow very efficient data replication and horizontal scalability of directory servers.<br><span class="segmentSeparator"></span>This allows low latencies and extreme throughput for read operations.<br><span class="segmentSeparator"></span>The horizontal scalability and relative autonomy of directory server instances increase the availability of the directory system.<br><span class="segmentSeparator"></span>These benefits often come at the expense of slow write operations.<br><span class="segmentSeparator"></span>But as identity data are often read but seldom modified this is usually a perfectly acceptable trade-off.<br><span class="segmentSeparator"></span>Therefore LDAP-based directory servers were and still remain the most popular databases for identity data.</p>
</div>
<div class="paragraph">
<p>LDAP is one of the precious few established standards in the IAM field.<br><span class="segmentSeparator"></span>And almost all organizations store identities in LDAP-enabled data stores.<br><span class="segmentSeparator"></span>Therefore we will be getting back to the LDAP protocol many times in this book.</p>
</div>
<div class="paragraph">
<p>Identity management solutions based on shared directory servers are simple and quite cost-efficient.<br><span class="segmentSeparator"></span>Therefore we have been giving the same advice for many years: if you can connect all your applications to an LDAP server, do not think too much about it and just do it.<br><span class="segmentSeparator"></span>The problem is that this usually works only for very simple systems.</p>
</div>
</div>
<div class="sect2">
<h3 id="_directory_servers_are_databases">Directory Servers are Databases</h3>
<div class="paragraph">
<p>Directory servers are just databases that store information.<br><span class="segmentSeparator"></span>Nothing more.<br><span class="segmentSeparator"></span>The protocols and APIs used to access directory servers are designed as database interfaces.<br><span class="segmentSeparator"></span>It means that they are excellent for <em>storing, searching and retrieving</em> data.<br><span class="segmentSeparator"></span>While the user account data often contain entitlement information (permissions, groups, roles, etc.), identity stores are not well suited to <em>evaluate</em> them.<br><span class="segmentSeparator"></span>I.e.<br><span class="segmentSeparator"></span>directory server can provide information what permissions an account has but it is not designed to make a <em>decision</em> whether to allow or deny a specific operation.<br><span class="segmentSeparator"></span>And that is not all.<br><span class="segmentSeparator"></span>Directory servers do not contain data about user <em>sessions</em>.<br><span class="segmentSeparator"></span>It means that directory servers do not know whether user is currently logged in or not.<br><span class="segmentSeparator"></span>Many directory servers are used for basic authentication and even authorization.<br><span class="segmentSeparator"></span>But the directories were not designed to do it.<br><span class="segmentSeparator"></span>Directory servers provide only the very basic capabilities.<br><span class="segmentSeparator"></span>There are plug-ins and extensions that provide partial capabilities to support authentication and authorization.<br><span class="segmentSeparator"></span>But that does not change the fundamental design principles.<br><span class="segmentSeparator"></span>Directory servers are databases, not authentication or authorization servers.</p>
</div>
</div>
<div class="sect2">
<h3 id="_single_directory_server_myth">Single Directory Server Myth</h3>
<div class="paragraph">
<p>Shared directory server makes user management easier.<br><span class="segmentSeparator"></span>But this is not a complete solution and there are serious limitations to this approach.<br><span class="segmentSeparator"></span>The heterogeneity of information systems makes it nearly impossible to put all required data into a single directory system.</p>
</div>
<div class="paragraph">
<p>The obvious problem is the lack of a single, coherent source of information.<br><span class="segmentSeparator"></span>There are usually several sources of information for a single user.<br><span class="segmentSeparator"></span>For example a human resources (HR) system is authoritative for the existence of a user in the enterprise.<br><span class="segmentSeparator"></span>But the HR system is usually not authoritative for assignment of employee identifier such as <em>username</em>.<br><span class="segmentSeparator"></span>There needs to be an algorithm that ensures uniqueness of the username, possibly including uniqueness across all the current and past employees, contractors and partners.<br><span class="segmentSeparator"></span>And there may be additional sources of information.<br><span class="segmentSeparator"></span>For example Management information system may responsible for determination of user’s roles (e.g.<br><span class="segmentSeparator"></span>in project-oriented organizational structure).<br><span class="segmentSeparator"></span>Inventory management system may be responsible for assigning telephone number to the user.<br><span class="segmentSeparator"></span>The groupware system may be an authoritative source of the user’s e-mail address and other electronic contact data.<br><span class="segmentSeparator"></span>There are usually 2 to 20 systems that provide authoritative information for a single user.<br><span class="segmentSeparator"></span>Therefore there is no simple way how to feed and maintain the data in the directory system.</p>
</div>
<div class="paragraph">
<p>And then there are spacial and technological barriers.<br><span class="segmentSeparator"></span>Many complex applications need local user database.<br><span class="segmentSeparator"></span>They must store the copies of user records in their own databases to operate efficiently.<br><span class="segmentSeparator"></span>For example, large billing systems cannot work efficiently with external data (e.g.<br><span class="segmentSeparator"></span>because of a need to make relational database <em>join</em>).<br><span class="segmentSeparator"></span>Therefore even if directory server is deployed these applications still need to maintain a local copy of identity data.<br><span class="segmentSeparator"></span>Keeping the copy synchronized with the directory data may seem like a simple task.<br><span class="segmentSeparator"></span>But it is not.<br><span class="segmentSeparator"></span>And there are legacy systems which usually cannot access the external data at all (e.g.<br><span class="segmentSeparator"></span>they do not support LDAP protocol).</p>
</div>
<div class="paragraph">
<p>Some services need to keep even more state than just a simple database record.<br><span class="segmentSeparator"></span>For example file servers usually create home directories for users.<br><span class="segmentSeparator"></span>While the account creation can usually be done in on-demand fashion (e.g.<br><span class="segmentSeparator"></span>create user directory at first user log-on), the modification and deletion of the account is much more difficult.<br><span class="segmentSeparator"></span>Directory server will not do that.</p>
</div>
<div class="paragraph">
<p>But perhaps the most painful problem is the complexity of access control policies.<br><span class="segmentSeparator"></span>Role names and access control attributes may not have the same meaning in all systems.<br><span class="segmentSeparator"></span>Different systems usually have different authorization algorithms that are not mutually compatible.<br><span class="segmentSeparator"></span>While this issue can be solved with per-application access control attributes, the maintenance of these attributes is seldom trivial.<br><span class="segmentSeparator"></span>And if every application has its own set of attributes to control access control policies then the centralized directory does provide very little advantage.<br><span class="segmentSeparator"></span>The attributes may as well reside in the applications themselves.<br><span class="segmentSeparator"></span>And that’s exactly how most deployments end up.<br><span class="segmentSeparator"></span>Directory servers only contain groups that roughly approximate RBAC roles.<br><span class="segmentSeparator"></span>And even LDAP standards themselves do not make this situation very easy.<br><span class="segmentSeparator"></span>There are at least three or four different and incompatible specifications for group definition in LDAP directories.<br><span class="segmentSeparator"></span>The usual approach to LDAP groups is not ideal at all and it has problems with big groups.<br><span class="segmentSeparator"></span>Therefore many directory servers provide their own non-standard improvements.<br><span class="segmentSeparator"></span>But even those improvements cannot support complex access control policies.<br><span class="segmentSeparator"></span>Therefore access control policies and fine-grained authorizations are often maintained directly in the application databases.</p>
</div>
<div class="paragraph">
<p>Single directory approach is feasible only in very simple environments or in almost entirely homogeneous environments.<br><span class="segmentSeparator"></span>In all other cases there is a need to supplement the solution by other identity management technologies.</p>
</div>
<div class="paragraph">
<p>This does not mean that the directory servers are useless.<br><span class="segmentSeparator"></span>Quite the contrary.<br><span class="segmentSeparator"></span>They are very useful when used properly.<br><span class="segmentSeparator"></span>They just cannot be used alone.<br><span class="segmentSeparator"></span>More components are needed to build a complete solution.</p>
</div>
</div>
<div class="sect2">
<h3 id="_access_management">Access Management</h3>
<div class="paragraph">
<p>While directory systems are not designed to handle complex authentication the <em>access management</em> (AM) systems are built to handle just that.<br><span class="segmentSeparator"></span>They handle all the flavors of authentication and some authorization aspects.<br><span class="segmentSeparator"></span>The principle of all access management systems is basically the same:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Access management system gets between the user and the target application.<br><span class="segmentSeparator"></span>This can be done by a variety of mechanisms but the most common is that the applications themselves redirect the user to the AM system if they do not have existing session.</p>
</li>
<li>
<p>Access management system prompts user for username and password, requests the certificate, creates a challenge and prompts for the response or in any other way initiates the authentication procedure.</p>
</li>
<li>
<p>User enters the credentials.</p>
</li>
<li>
<p>Access management system checks the validity of credentials and evaluates access policies.</p>
</li>
<li>
<p>If access is allowed then the AM system redirects user back to the application.<br><span class="segmentSeparator"></span>The redirection usually contains an access token: small piece of information that tells the application that the user is authenticated.</p>
</li>
<li>
<p>Application validates the token, creates local session and allows the access.</p>
</li>
</ol>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/01-03-am-flow.png" alt="Access management flow">
</div>
</div>
<div class="paragraph">
<p>After that procedure the user works with the application normally.<br><span class="segmentSeparator"></span>So only the first access goes through the AM server.<br><span class="segmentSeparator"></span>This is important for AM system performance and sizing.</p>
</div>
<div class="paragraph">
<p>The applications only need to provide code that integrates with the AM system.<br><span class="segmentSeparator"></span>Except for that small integration code applications do not need to provide any authentication code at all.<br><span class="segmentSeparator"></span>It is the AM system that prompts for password, not the application.<br><span class="segmentSeparator"></span>This is a fundamental difference when compared to LDAP-based authentication.<br><span class="segmentSeparator"></span>In the LDAP case it is the application that prompts for password.<br><span class="segmentSeparator"></span>In the AM case the Access Management server does everything.<br><span class="segmentSeparator"></span>Many applications do not even care how the user was authenticated.<br><span class="segmentSeparator"></span>All they need to know is that he was authenticated and that the authentication was good enough.<br><span class="segmentSeparator"></span>This feature brings a very desirable flexibility to the entire application infrastructure.<br><span class="segmentSeparator"></span>The authentication mechanism can be changed at any time without disrupting the applications.<br><span class="segmentSeparator"></span>We live in an era when passwords are migrated to a stronger authentication mechanisms.<br><span class="segmentSeparator"></span>The flexibility that the AM-based approach brings may play a key part in that migration.</p>
</div>
</div>
<div class="sect2">
<h3 id="_web_single_sign_on">Web Single Sign-On</h3>
<div class="paragraph">
<p>Single Sign-On (SSO) systems allow user to authenticate once and then access number of different system.<br><span class="segmentSeparator"></span>There many SSO systems for web applications, however it looks like these systems are all using the same basic principle.<br><span class="segmentSeparator"></span>The web SSO is based on the general access management principle described above:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Application A redirects the user to the access management server (SSO server).</p>
</li>
<li>
<p>The access management server authenticates the user.</p>
</li>
<li>
<p>The access management server establishes session (SSO session) with the user browser.<br><span class="segmentSeparator"></span>This is the crucial part of the SSO mechanism.</p>
</li>
<li>
<p>User is redirected back to the application A.<br><span class="segmentSeparator"></span>Application A usually establishes local session with the user.</p>
</li>
<li>
<p>User interacts with application A</p>
</li>
<li>
<p>When user tries to access application B, the application B redirects user to the access management server.</p>
</li>
<li>
<p>The access management server checks for existence of SSO session.<br><span class="segmentSeparator"></span>As the user authenticated with the access management server before, there is a valid SSO session.</p>
</li>
<li>
<p>Access management server does not need to authenticate the user again and immediately redirects user back to application B.</p>
</li>
<li>
<p>Application B establishes local session with the user and proceeds normally.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The user usually does not even realize that he was redirected when accessing application B.<br><span class="segmentSeparator"></span>There is no interaction between the redirects and the redirects and the processing on the access management server is usually very fast.<br><span class="segmentSeparator"></span>It looks like the user was logged into the application B all the time.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/01-04-web-sso-flow.png" alt="Web SSO flow">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_authorization_in_access_management">Authorization in Access Management</h3>
<div class="paragraph">
<p>The request of a user accessing an application is directly or indirectly passed through the access management server.<br><span class="segmentSeparator"></span>Therefore the access management server can, in theory, analyze the request and evaluate whether the user request is authorized or not.<br><span class="segmentSeparator"></span>That is a theory.<br><span class="segmentSeparator"></span>But the situation is much more complicated in practice.</p>
</div>
<div class="paragraph">
<p>The AM server usually intercepts only the first request to access the application because it would be a performance impact to intercept all the requests.<br><span class="segmentSeparator"></span>After the first request the application established local sessions and proceeds with the operation without any communication with the AM server.<br><span class="segmentSeparator"></span>Therefore the AM server can only evaluate authorization during the first request.<br><span class="segmentSeparator"></span>Which means it can only evaluate a very rough-grained authorization decisions.<br><span class="segmentSeparator"></span>In practice it usually means that the AM server can make only all-or-nothing authorization decisions: whether a particular user can access all parts of a particular application or that he cannot access the application at all.<br><span class="segmentSeparator"></span>The AM server usually cannot make any finer-grain decisions just by itself.</p>
</div>
<div class="paragraph">
<p>Some AM systems provide agents that can be deployed to applications and that enforce a finer-grain authorization decisions.<br><span class="segmentSeparator"></span>Such agents often rely on HTTP communication and they are making decisions based on the URLs that the user is accessing.<br><span class="segmentSeparator"></span>This approach might work well in 1990s, but it has only very limited applicability in the age of single-page web applications and mobile applications.</p>
</div>
<div class="paragraph">
<p>Sophisticated applications often need to make authorization decisions based on context which is simply not available in the request or user profile at all.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>an e-banking application may allow or deny a transaction based on the sum of previous transactions that were made earlier that day.<br><span class="segmentSeparator"></span>While it is usually possible to synchronize all the authorization information into the user profile, it is usually not desirable.<br><span class="segmentSeparator"></span>It would be a major burden to keep such information updated and consistent.</p>
</div>
<div class="paragraph">
<p>AM systems often come with a promise to unify authorization across all the applications and to centralize management of organization-wide security policies.<br><span class="segmentSeparator"></span>Unfortunately, such broad promises are almost always false.<br><span class="segmentSeparator"></span>The AM system can theoretically evaluate and enforce some authorization statements.<br><span class="segmentSeparator"></span>And this may work well during demonstrations and in very simple deployments.<br><span class="segmentSeparator"></span>But in complex practical deployments this capability is extremely limited.<br><span class="segmentSeparator"></span>Vast majority of the authorization decisions is carried out by each individual application and is completely outside of the reach of an AM system.</p>
</div>
</div>
<div class="sect2">
<h3 id="_saml_and_openid_connect">SAML and OpenID Connect</h3>
<div class="paragraph">
<p>Many access management systems use proprietary protocols to communicate with the applications and agents.<br><span class="segmentSeparator"></span>This is obviously an interoperability issue – especially when the AM principles are used in the Internet environment.<br><span class="segmentSeparator"></span>And it is the Internet that motivated standardization in this field.</p>
</div>
<div class="paragraph">
<p>The first widespread standardized protocol in this field was Security Assertion Markup Language (SAML).<br><span class="segmentSeparator"></span>The original intent of SAML was to allow cross-domain sign-on and identity data sharing across organizations on the Internet.<br><span class="segmentSeparator"></span>It is quite complex protocol and security token format heavily based on XML standards.<br><span class="segmentSeparator"></span>SAML philosophy and design is very close to the SOAP-based web services and in fact it was designed to integrate easily into the SOAP web service world.<br><span class="segmentSeparator"></span>SAML specifications are long, divided into several profiles, there are many optional elements and features and overall SAML is a set of very rich and flexible mechanisms.</p>
</div>
<div class="paragraph">
<p>Primary purpose of SAML is transfer of identity information between organizations.<br><span class="segmentSeparator"></span>There are big federations with hundreds of organizations based on SAML tokens and protocols.<br><span class="segmentSeparator"></span>Many e-government solutions are based on SAML, there are big partner networks running on SAML and overall it looks like SAML is a success.<br><span class="segmentSeparator"></span>But SAML was a victim of its own flexibility and complexity.<br><span class="segmentSeparator"></span>And the latest fashion trends are not very favorable to SAML.<br><span class="segmentSeparator"></span>XML and SOAP-based web service mechanisms are getting out of fashion.<br><span class="segmentSeparator"></span>All of that has probably motivated the inception of other protocols.</p>
</div>
<div class="paragraph">
<p>The latest fashion favors RESTful services and similar simpler architectural approaches.<br><span class="segmentSeparator"></span>All of that probably contributed to the development of OpenID Connect protocol (OIDC).<br><span class="segmentSeparator"></span>OpenID Connect is based on much simpler mechanisms than SAML, but it is reusing the same basic principles.<br><span class="segmentSeparator"></span>OpenID connect has a very eventful history.<br><span class="segmentSeparator"></span>It all started with a bunch of homebrew protocols such as LID or SXIP that are now mostly forgotten.<br><span class="segmentSeparator"></span>That was followed by the development of OpenID protocol, which was still very simple.<br><span class="segmentSeparator"></span>OpenID gained some attention especially with providers of Internet services.<br><span class="segmentSeparator"></span>But despite its simplicity OpenID was not very well engineered and it quickly reached its technological limits.<br><span class="segmentSeparator"></span>It was obvious that OpenID needs to be significantly improved.<br><span class="segmentSeparator"></span>Then there was almost unrelated protocol called OAuth which was designed for management of cross-domain authorizations.<br><span class="segmentSeparator"></span>That protocol was developed into something that was almost, but not quite, entirely unlike the original OAuth protocol.<br><span class="segmentSeparator"></span>As the result had almost nothing to do with the original OAuth protocol it is perfectly understandable that is was dubbed OAuth2.<br><span class="segmentSeparator"></span>And in fact OAuth2 is not really a protocol at all.<br><span class="segmentSeparator"></span>It is rather a vaguely-defined framework to build other protocols.<br><span class="segmentSeparator"></span>OAuth2 framework was used to build a cross-domain authentication and user profile protocol.<br><span class="segmentSeparator"></span>This new protocol is much more similar to SAML than to the original OpenID, so it was an obvious choice to call it OpenID Connect.<br><span class="segmentSeparator"></span>Some traditions are just worth maintaining.</p>
</div>
<div class="paragraph">
<p>Now there are two protocols that are using the same principle and do almost the same thing.<br><span class="segmentSeparator"></span>The principle is illustrated in the following diagram.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/01-05-saml-oidc-flow.png" alt="SAML/OIDC flow">
</div>
</div>
<div class="paragraph">
<p>The interaction goes like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User is accessing a resource.<br><span class="segmentSeparator"></span>This can be web page or web application on the target site.</p>
</li>
<li>
<p>Target site does not have a valid session for the user.<br><span class="segmentSeparator"></span>Therefore it redirects user browser to the source site.<br><span class="segmentSeparator"></span>It will add authentication request into that redirect.</p>
</li>
<li>
<p>Browser follows the redirect to the source site.<br><span class="segmentSeparator"></span>The source site gets the authentication request and parses it.</p>
</li>
<li>
<p>If the user is not already authenticated with the source site then the authentication happens now.<br><span class="segmentSeparator"></span>The source site prompts for username, password, certificate, one-time password or whatever credential that is required by the policy.<br><span class="segmentSeparator"></span>With a bit of luck the authentication succeeds.</p>
</li>
<li>
<p>The source site redirects the browser back to the target site.<br><span class="segmentSeparator"></span>The source site adds authentication response to the redirect.<br><span class="segmentSeparator"></span>The most important part of the response is a token.<br><span class="segmentSeparator"></span>The token directly or indirectly asserts user’s identity.</p>
</li>
<li>
<p>The target site will parse the authentication response and process the token.<br><span class="segmentSeparator"></span>The token may by just a reference to the real token (SAML artifact) or it may be access key to another service that provides the identity (OIDC UserInfo).<br><span class="segmentSeparator"></span>In that case the target site makes another request (6a).<br><span class="segmentSeparator"></span>This request is usually a direct one and does not use browser redirects.<br><span class="segmentSeparator"></span>One way or another, the target site now has claims about user identity.</p>
</li>
<li>
<p>Target site evaluates the identity, processes authorizations and so on.<br><span class="segmentSeparator"></span>Local session with the user is usually established at this point to skip the authenticaiton redirects on the next request.<br><span class="segmentSeparator"></span>The target site finally provides the content.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Following table compares the terminology and technologies used in SAML and OIDC worlds.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">SAML World</th>
<th class="tableblock halign-left valign-top">OpenID Connect World</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Source site</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Identity Provider (IdP)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Identity Provider (IDP) or OpenID Provider (OP)</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Target site</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Service Provider (SP)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Relying Party (RP)</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Token</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">SAML Assertion (or artifact)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ID token, access token</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Intended for</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">Web applications, web services (SOAP)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Web applications, mobile applications, REST services</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Based on</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">N/A</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">OAuth2</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Data representation</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">XML</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JSON</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Cryptography framework</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">XMLenc, XMLdsig</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JOSE</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Token format</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">SAML</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JWT</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Careful reader will notice the similarity with the web-based access management mechanisms.<br><span class="segmentSeparator"></span>That’s right.<br><span class="segmentSeparator"></span>This is the same wheel reinvented over and over again.<br><span class="segmentSeparator"></span>However, to be completely honest we have limited our description to cover flows for web browser only.<br><span class="segmentSeparator"></span>Both SAML and OIDC has broader applicability that just web browser flows.<br><span class="segmentSeparator"></span>And the differences between the protocols are much more obvious in these extended use cases.<br><span class="segmentSeparator"></span>But the web browser case nicely illustrates the principles and similarities of SAML, OpenID Connect and also the simple web-SSO systems.</p>
</div>
<div class="paragraph">
<p>Maybe the most important differences between SAML, OIDC and web-SSO systems is the intended use:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SAML was designed for the web applications and SOAP web services world.<br><span class="segmentSeparator"></span>It will handle centralized (single-IDP) scenarios very will, but it can also work in decentralized federations.<br><span class="segmentSeparator"></span>Go for SAML if you are using SOAP and WS-Security or if you plan to build big decentralized federation.</p>
</li>
<li>
<p>OpenID Connect was designed mostly for use with social network and similar Internet services.<br><span class="segmentSeparator"></span>Its philosophy is still somehow centralized.<br><span class="segmentSeparator"></span>It will work well if there is one strong identity provider and many relying parties.<br><span class="segmentSeparator"></span>Technologically it will fit into RESTful world much better than SAML.<br><span class="segmentSeparator"></span>Current fashion trends are favorable to OIDC.</p>
</li>
<li>
<p>Web-SSO systems are designed to be used inside a single organization.<br><span class="segmentSeparator"></span>This is ideal to implement SSO between several customer-facing applications so the customers will have no idea that they interact with many applications and not just one.<br><span class="segmentSeparator"></span>The web-SSO systems are not designed to work across organizational boundaries.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Although SAML and OIDC are designed primarily for cross-domain use, it is no big surprise to see them inside a single organization.<br><span class="segmentSeparator"></span>There is a clear benefit in using an open standardized protocol instead of a proprietary mechanism.<br><span class="segmentSeparator"></span>However, it has to be expected that the SSO system based on SAML or OIDC will have slightly more complicated setup than a simple Web-SSO system.</p>
</div>
</div>
<div class="sect2">
<h3 id="_kerberos_enterprise_sso_and_friends">Kerberos, Enterprise SSO and Friends</h3>
<div class="paragraph">
<p>Many of us would like to think that everything is based on web technologies today and that non-web mechanisms are things of the past.<br><span class="segmentSeparator"></span>But there are still cases that are not web-based and where web-based SSO and AM mechanisms will not work.<br><span class="segmentSeparator"></span>There is still a lot of legacy applications, especially in the enterprise environment.<br><span class="segmentSeparator"></span>Applications based on rich clients or even character-based terminal interactions are still not that difficult to find.<br><span class="segmentSeparator"></span>And then there are network operating systems such as Windows and numerous UNIX variants, there are network access technologies such as VPN or 802.1X and so on.<br><span class="segmentSeparator"></span>There are still many cases where web-based access management and SSO simply won’t work.</p>
</div>
<div class="paragraph">
<p>These technologies usually pre-date the web.<br><span class="segmentSeparator"></span>And honestly, the centralized authentication and SSO are not entirely new ideas.<br><span class="segmentSeparator"></span>Therefore it is perhaps no big surprise that there are authentication and SSO solutions even for non-web applications.</p>
</div>
<div class="paragraph">
<p>The classic classroom example of non-web SSO system is Kerberos.<br><span class="segmentSeparator"></span>The protocol originated at MIT in 1980s.<br><span class="segmentSeparator"></span>It is a single sign-on protocol for operating systems and rich clients based on symmetric cryptography.<br><span class="segmentSeparator"></span>Even though it is a cryptographic protocol it is not too complicated to understand and it definitely withstood the test of time.<br><span class="segmentSeparator"></span>It has been used to this day, especially for authentication and SSO of network operating systems.<br><span class="segmentSeparator"></span>It is a part of Windows network domain and it is often the preferred solution for authentication of UNIX servers.<br><span class="segmentSeparator"></span>The most serious limitation of Kerberos is given by its use of symmetric cryptography.<br><span class="segmentSeparator"></span>The weakness of symmetric cryptography is key management.<br><span class="segmentSeparator"></span>Kerberos key management can be quite difficult especially when Kerberos realm gets very big.<br><span class="segmentSeparator"></span>Key management is also one of the reasons why it is not very realistic to use Kerberos in cross-domain scenarios.<br><span class="segmentSeparator"></span>However inside a closed organization Kerberos is still a very useful solution.</p>
</div>
<div class="paragraph">
<p>The major drawback in using Kerberos is that every application and client needs to be "kerberized".<br><span class="segmentSeparator"></span>In other words everybody that wants to take part in Kerberos authentication needs to have Kerberos support in one’s software.<br><span class="segmentSeparator"></span>There are kerberized versions of many network utilities so this is usually not a problem for UNIX-based networks.<br><span class="segmentSeparator"></span>But it is a problem for generic applications.<br><span class="segmentSeparator"></span>There is some support for Kerberos in common web browsers which is often referred to as "SPNEGO".<br><span class="segmentSeparator"></span>However this support is usually limited to interoperability with Windows domains.<br><span class="segmentSeparator"></span>Therefore even though Kerberos is still useful for operating system SSO it is not a generic solution for all applications.</p>
</div>
<div class="paragraph">
<p>Many network devices use RADIUS protocol for what network engineers call "Authentication, Authorization and Accounting" (AAA).<br><span class="segmentSeparator"></span>However RADIUS is a back-end protocol.<br><span class="segmentSeparator"></span>It does not take care of client interactions.<br><span class="segmentSeparator"></span>The goal of RADIUS is that the network device (e.g.<br><span class="segmentSeparator"></span>WiFi access point, router or VPN gateway) can validate user credentials that it has received as part of other protocol.<br><span class="segmentSeparator"></span>The client connecting to VPN or WiFi network does not know anything about RADIUS.<br><span class="segmentSeparator"></span>Therefore RADIUS is similar to the LDAP protocol and it is not really an access management technology.</p>
</div>
<div class="paragraph">
<p>Obviously there is no simple and elegant solution that can provide SSO for all enterprise applications.<br><span class="segmentSeparator"></span>Despite that one technology appeared in 1990s and early 2000s and promised to deliver universal enterprise SSO solution.<br><span class="segmentSeparator"></span>It was called "Enterprise Single Sign-On" (ESSO).<br><span class="segmentSeparator"></span>The ESSO approach was to use agents installed on every client device.<br><span class="segmentSeparator"></span>The agent detects when login dialog appears on the screen, fills in the username and password and submits the dialog.<br><span class="segmentSeparator"></span>If the agent is fast enough the user does not even notice the dialog and this creates the impression of Single Sign-On.<br><span class="segmentSeparator"></span>However, there are obvious drawbacks.<br><span class="segmentSeparator"></span>The agents needs to know all the passwords in a cleartext form.<br><span class="segmentSeparator"></span>There are ESSO variations with passwords randomly generated or even single-user passwords which partially alleviates this problem.<br><span class="segmentSeparator"></span>But the drawback is that the ESSO also needs to be integrated with password management of all the applications, which is not entirely easy.<br><span class="segmentSeparator"></span>However the most serious drawback of ESSO are the agents.<br><span class="segmentSeparator"></span>These only work on workstations that are strictly controlled by the enterprise.<br><span class="segmentSeparator"></span>Yet the world is changing, enterprise perimeter has efficiently disappeared and the enterprise cannot really control all the client devices.<br><span class="segmentSeparator"></span>Therefore also ESSO is now mostly a thing of the past.</p>
</div>
</div>
<div class="sect2">
<h3 id="_access_management_and_the_data">Access Management and the Data</h3>
<div class="paragraph">
<p>Access Management servers and Identity Providers need to know the data about users to work properly.<br><span class="segmentSeparator"></span>But it is complicated.<br><span class="segmentSeparator"></span>The purpose of access management systems is to manage access of users to the applications.<br><span class="segmentSeparator"></span>Which usually means processing authentication, authorization (partially), auditing the access and so on.<br><span class="segmentSeparator"></span>For this to work, the AM system needs access to the database where the user data are stored.<br><span class="segmentSeparator"></span>It needs access to usernames, passwords and other credentials, authorization policies, attributes and so on.<br><span class="segmentSeparator"></span>The AM systems usually do not store these data themselves.<br><span class="segmentSeparator"></span>They rely on external databases.<br><span class="segmentSeparator"></span>And in vast majority of cases those databases are directory services.<br><span class="segmentSeparator"></span>This is an obvious choice: directory services are lightweight, highly available and extremely scalable.<br><span class="segmentSeparator"></span>The AM system usually need just a simple attributes, therefore the limited capabilities of directory data models are not a limiting factor here.<br><span class="segmentSeparator"></span>Marriage of access management and directory service is an obvious and very smart match.</p>
</div>
<div class="paragraph">
<p>However, there is one critical issue – especially if the AM system is also used as a single sign-on server.<br><span class="segmentSeparator"></span>The data in the directory service and the data in the applications must be consistent.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>it is a huge problem if one user has different usernames in several applications.<br><span class="segmentSeparator"></span>Which username should he use to log in?<br><span class="segmentSeparator"></span>Which username should be sent to the applications?<br><span class="segmentSeparator"></span>There are ways how to handle such situations, but this is usually very cumbersome and expensive.<br><span class="segmentSeparator"></span>It is much easier to unify the data before the AM system is deployed.</p>
</div>
<div class="paragraph">
<p>Even though the "M" in AM stands for "management", typical AM system has only a very limited data management capabilities.<br><span class="segmentSeparator"></span>The AM systems usually assume that the underlying directory system is already properly managed.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>a typical AM system has only a very minimalistic user interface to create, modify and delete user records.<br><span class="segmentSeparator"></span>Some AM systems may have self-service functionality (such as password reset), but even that functionality is usually very limited.<br><span class="segmentSeparator"></span>Even though the AM relies on the fact that the data in the AM directory service and the data in applications are consistent there is usually no way how to fully synchronize the data by using the AM system itself.<br><span class="segmentSeparator"></span>There may be methods for on-demand or opportunistic data updates, e.g.<br><span class="segmentSeparator"></span>creating user record in the database when the user logs in for the first time.<br><span class="segmentSeparator"></span>But there are usually no solutions for deleting the records or for updating the records of inactive users.</p>
</div>
<div class="paragraph">
<p>Therefore the AM systems are usually not deployed alone.<br><span class="segmentSeparator"></span>The underlying directory service is almost always a hard requirement for even the most humble AM functionality.<br><span class="segmentSeparator"></span>But for the AM system to really work properly it needs something to manage and synchronize the data.<br><span class="segmentSeparator"></span>Identity Management (IDM) system is usually used for that purpose.<br><span class="segmentSeparator"></span>And in fact, it is usually strongly recommended to deploy the directory and the IDM system before the AM system.<br><span class="segmentSeparator"></span>The AM system cannot work without the data.<br><span class="segmentSeparator"></span>And if it works on data that are not maintained properly it will not take a long time until it fails.</p>
</div>
</div>
<div class="sect2">
<h3 id="_advantages_and_disadvantages_of_access_management_systems">Advantages and Disadvantages of Access Management Systems</h3>
<div class="paragraph">
<p>Access management and web SSO systems have significant advantages.<br><span class="segmentSeparator"></span>Most of the characteristics are given by the AM principle of centralized authentication.<br><span class="segmentSeparator"></span>As the authentication is carried out by a central access management server it can be easily controlled and audited.<br><span class="segmentSeparator"></span>Such centralization can be used to consistently apply authentication policies - and to easily change them when needed.<br><span class="segmentSeparator"></span>It also allows better utilization of an investment into authentication technologies.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>multi-factor or adaptive authentication can be quite expensive if it has to be implemented by every application.<br><span class="segmentSeparator"></span>But when it is implemented in the AM server then it is re-used by all the applications without additional investment.</p>
</div>
<div class="paragraph">
<p>However there are also drawbacks.<br><span class="segmentSeparator"></span>As the access management is centralized it is obviously a single point of failure.<br><span class="segmentSeparator"></span>Nobody is going to log in in case that the AM server fails.<br><span class="segmentSeparator"></span>This obviously means major impact on functionality of all applications.<br><span class="segmentSeparator"></span>Therefore AM servers need to be highly available and scalable.<br><span class="segmentSeparator"></span>Which is not always an easy task.<br><span class="segmentSeparator"></span>The AM servers need a very careful sizing as they may easily become a performance bottlenecks.<br><span class="segmentSeparator"></span>But perhaps the most severe drawback is the total cost.<br><span class="segmentSeparator"></span>The cost of the AM server itself is usually not a major issue.<br><span class="segmentSeparator"></span>But the server needs to be integrated with every application.<br><span class="segmentSeparator"></span>Even though there are some standards the integration is usually quite painful.<br><span class="segmentSeparator"></span>Support for AM standards and protocols in the applications is far from being perfect.<br><span class="segmentSeparator"></span>Especially older enterprise applications need to be modified to switch their authentication subsystem to the AM server.<br><span class="segmentSeparator"></span>This is often so costly that the adoption of AM technologies is often limited just to a handful of enterprise applications.</p>
</div>
<div class="paragraph">
<p>Even though many enterprises are planning deployment of an AM system as their first step in the IAM project, this approach seldom succeeds.<br><span class="segmentSeparator"></span>The project usually plans to integrate 50-80% applications into the AM solution.<br><span class="segmentSeparator"></span>But the reality is that only a handful of applications is integrated with the AM system.<br><span class="segmentSeparator"></span>The rest of the applications is integrated using an IDM system that is hastily added to the project.<br><span class="segmentSeparator"></span>Therefore it is better to plan ahead: analyze the AM integration effort and make a realistic plan for the AM solution.<br><span class="segmentSeparator"></span>Make sure that the AM can really bring the promised benefits.<br><span class="segmentSeparator"></span>Starting with IDM and adding AM part later is often much more reasonable strategy.</p>
</div>
</div>
<div class="sect2">
<h3 id="_single_access_management_myth">Single Access Management Myth</h3>
<div class="paragraph">
<p>The redirection approach of Access Management systems assumes that the user has something that can display authentication prompts and carry out user interaction.<br><span class="segmentSeparator"></span>Which is usually a web browser.<br><span class="segmentSeparator"></span>Therefore this approach applies mostly to conventional web-based applications.<br><span class="segmentSeparator"></span>Variations of this approach are also applicable to single-page web applications.<br><span class="segmentSeparator"></span>However this approach is usually not directly applicable for applications that use rich clients, operating system authentication and mobile applications.<br><span class="segmentSeparator"></span>Browser is not the primary environment that can be used to carry out the authentication in those cases.<br><span class="segmentSeparator"></span>There are some solutions that usually rely on embedded browser, however that does not change the basic fact that the AM technologies are not entirely suitable for this environment.<br><span class="segmentSeparator"></span>These applications usually rely on Kerberos as an SSO system or do not integrate with any SSO system at all.</p>
</div>
<div class="paragraph">
<p>As typical enterprise environment is composed of a wild mix of technologies and not all of them are entirely web-based.<br><span class="segmentSeparator"></span>Therefore it is unlikely that a single AM system can apply to everything that is deployed in the enterprise.<br><span class="segmentSeparator"></span>Authentication is very tightly bound to the user interaction, therefore it depends on the method how the user interacts with the application.<br><span class="segmentSeparator"></span>As the user is using different technologies to interact with the web application, mobile application and operating system then it is obvious that also authentication and SSO methods for these systems will be different.</p>
</div>
<div class="paragraph">
<p>Therefore it has to be expected that there will be several AM or SSO systems in the enterprise, each one serving its own technological island.<br><span class="segmentSeparator"></span>And each island needs to be managed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_practical_access_management">Practical Access Management</h3>
<div class="paragraph">
<p>Unifying access management system, Single Sign-On, cross-domain identity federation, universally-applicable 2-factor authentication – there are the things that people usually want when they think about Identity and Access Management (IAM).<br><span class="segmentSeparator"></span>And these are all perfectly valid requirements.<br><span class="segmentSeparator"></span>However, everything has its cost.<br><span class="segmentSeparator"></span>And it is notoriously difficult to estimate the cost of access management solutions because majority of the cost is not in the AM software.<br><span class="segmentSeparator"></span>Huge part of the total cost is hidden inside existing applications, services and clients.<br><span class="segmentSeparator"></span>All of this has to be considered when planning an access management project.</p>
</div>
<div class="paragraph">
<p>Even though the AM is what people usually want, it is usually wise <strong>not</strong> to start with AM as the first step.<br><span class="segmentSeparator"></span>AM deployment has many dependencies: unified user database, managed and continually synchronized data, applications that are flexible enough to be integrated and so on.<br><span class="segmentSeparator"></span>Unless your IT infrastructure is extremely homogeneous and simple, it is very unlikely that these dependencies are satisfied.<br><span class="segmentSeparator"></span>Therefore it is almost sure that the AM project attempted at the beginning of the IAM program will not reach its goals.<br><span class="segmentSeparator"></span>And it is quite likely for such AM projects to fail entirely.<br><span class="segmentSeparator"></span>However if the AM project is properly scoped and planned and has realistic goals there is high chance of success and it can bring substantial value.</p>
</div>
<div class="paragraph">
<p>Perhaps the best way to evaluate an AM project is to ask several questions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Do I really need access management for all applications?<br><span class="segmentSeparator"></span>Do I need 100% coverage?<br><span class="segmentSeparator"></span>Can I afford all the costs?<br><span class="segmentSeparator"></span>Maybe it is enough to integrate just a couple of applications that are source of the worst pain.<br><span class="segmentSeparator"></span>Do I know which applications are these?<br><span class="segmentSeparator"></span>Do I know what my users really use during they workday?<br><span class="segmentSeparator"></span>Do I know what they need?</p>
</li>
<li>
<p>Do I fully realize that the effect of AM and SSO is mostly user convenience?<br><span class="segmentSeparator"></span>What are the real security benefits of AM deployment?<br><span class="segmentSeparator"></span>Will I be disabling the native authentication to the applications?<br><span class="segmentSeparator"></span>Even for system administrators?<br><span class="segmentSeparator"></span>What will I do in case of administration emergencies (e.g.<br><span class="segmentSeparator"></span>system recovery)?<br><span class="segmentSeparator"></span>Would system administrators still be able to circumvent the AM system?<br><span class="segmentSeparator"></span>If yes then what is the real security benefit?<br><span class="segmentSeparator"></span>If not then what will be the recovery procedure in case the AM system fails?</p>
</li>
<li>
<p>Do I really need SSO for older and rarely used applications?<br><span class="segmentSeparator"></span>What is the real problem here?<br><span class="segmentSeparator"></span>Is the problem that users are entering the password several times per day?<br><span class="segmentSeparator"></span>Or is the real problem that they have to enter different username or password to different applications and they keep forgetting the credentials?<br><span class="segmentSeparator"></span>Maybe simple data cleanup and password management will solve the worst problems and I case save a huge amount of money on AM project?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The AM technologies are the most visible part of the IAM program.<br><span class="segmentSeparator"></span>But it is also the most expensive part and the most difficult to set up and maintain.<br><span class="segmentSeparator"></span>Therefore do not underestimate other IAM technologies and do not try to solve every problem with AM golden hammer.<br><span class="segmentSeparator"></span>Using the right tool for the job is a good approach in every situation.<br><span class="segmentSeparator"></span>But in IAM program it is absolutely critical for success.</p>
</div>
</div>
<div class="sect2">
<h3 id="_identity_management">Identity Management</h3>
<div class="paragraph">
<p><em>Identity management</em> (IDM) is maybe the most overlooked and underestimated technology in the whole identity and access management (IAM) field.<br><span class="segmentSeparator"></span>Yet IDM is a crucial part of almost every IAM solution.<br><span class="segmentSeparator"></span>And it is IDM that can bring substantial benefits to almost any organization.<br><span class="segmentSeparator"></span>So, what that mysterious IDM really is?</p>
</div>
<div class="paragraph">
<p>Identity management is exactly what the name says: it is all about managing identities.<br><span class="segmentSeparator"></span>It is about the processes to create Active Directory accounts and mailboxes for a new employee.<br><span class="segmentSeparator"></span>IDM makes it possible to immediately disable all access to a suspicious user during a security incident.<br><span class="segmentSeparator"></span>IDM takes care of adding new privileges and removing old privileges of users during reorganization.<br><span class="segmentSeparator"></span>IDM makes sure that all the accounts are properly disabled when the employee leaves the company.<br><span class="segmentSeparator"></span>IDM records access privileges of temporary workers, partners, support engineers and all the third-party identities that are not maintained in your human resources (HR) system.<br><span class="segmentSeparator"></span>IDM automates the processes of role request and approval.<br><span class="segmentSeparator"></span>IDM records every change in user privileges in the audit trail.<br><span class="segmentSeparator"></span>IDM governs the annual reviews of roles and access privileges.<br><span class="segmentSeparator"></span>IDM makes sure the copies of user data that are kept in the applications are synchronized and properly managed.<br><span class="segmentSeparator"></span>And IDM does many other things that are absolutely essential for every organization to operate in an efficient and secure manner.</p>
</div>
<div class="paragraph">
<p>It looks like IDM is the best thing since the sliced bread.<br><span class="segmentSeparator"></span>So where’s the catch?<br><span class="segmentSeparator"></span>Oh yes, there is a catch.<br><span class="segmentSeparator"></span>Or it is perhaps better to say that there was a catch.<br><span class="segmentSeparator"></span>The IDM systems used to be expensive.<br><span class="segmentSeparator"></span>Very expensive.<br><span class="segmentSeparator"></span>The IDM systems used to be so expensive that it was very difficult to justify the cost even with such substantial and clear benefits.<br><span class="segmentSeparator"></span>But that time is over now.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Terminology.</div>
The term <em>identity management</em> is often used for the whole identity and access management (IAM) field.<br><span class="segmentSeparator"></span>This is somehow confusing because technologies such as single sign-on or access management do not really manage the identities.<br><span class="segmentSeparator"></span>Such technologies manage the access to the applications.<br><span class="segmentSeparator"></span>Even directory servers do not exactly <em>manage</em> the identities.<br><span class="segmentSeparator"></span>Directory servers store the identities and provide access to them.<br><span class="segmentSeparator"></span>There is in fact one whole branch of technologies that manage identities.<br><span class="segmentSeparator"></span>Those systems are responsible for creating identities and maintaining them.<br><span class="segmentSeparator"></span>Those are sometimes referred to as <em>identity provisioning</em>, <em>identity lifecycle management</em> or <em>identity administration systems</em>.<br><span class="segmentSeparator"></span>But given the current state of the technology such names are indeed an understatement.<br><span class="segmentSeparator"></span>Those systems can do much more than just provisioning or management of identity lifecycle.<br><span class="segmentSeparator"></span>We will refer to these systems simply as <em>identity management</em> (IDM) systems.<br><span class="segmentSeparator"></span>When we refer to the entire field that contains access management, directory services, identity management and governance we will use the term <em>identity and access management</em> (IAM).<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Let’s start at the beginning.<br><span class="segmentSeparator"></span>In 1990s there was no technology that would be clearly identified as "identity management".<br><span class="segmentSeparator"></span>Of course, all the problems above had existed almost since the beginning of modern computing.<br><span class="segmentSeparator"></span>And there had always been some solutions for those problems.<br><span class="segmentSeparator"></span>But most of that solutions were based on paperwork and scripting.<br><span class="segmentSeparator"></span>That worked quite well - until the big system integration wave spread through the industry in 1990s and 2000s.<br><span class="segmentSeparator"></span>As data and processes in individual applications got integrated, the IDM problems became much more pronounced.<br><span class="segmentSeparator"></span>Manual paper-based processes were just too slow for the age of information superhighways.<br><span class="segmentSeparator"></span>The scripts were too difficult to maintain in the world where new application is deployed every couple of weeks.<br><span class="segmentSeparator"></span>The identity integration effort naturally started with the state-of-the-art identity technology of the day: directory services.<br><span class="segmentSeparator"></span>But as we have already shown the directories were not ideal tool for the job.<br><span class="segmentSeparator"></span>The directories were not entirely suitable for environment where people though that LDAP is some kind of exotic disease, where usernames and identifiers were assigned quite randomly and where every application insisted that the only authoritative data are those stored in its own database.</p>
</div>
</div>
<div class="sect2">
<h3 id="_first_generation">First Generation</h3>
<div class="paragraph">
<p>The integration problems motivated the inception of IDM technologies in early 2000s.<br><span class="segmentSeparator"></span>Early IDM systems were just data synchronization engines that were somehow hard-coded to operate with users and accounts.<br><span class="segmentSeparator"></span>Some simple Role-Based Access Control (RBAC) engines and administration interfaces were added a bit later.<br><span class="segmentSeparator"></span>During mid-2000s there were several more-or-less complete IDM systems.<br><span class="segmentSeparator"></span>This was the first generation of the IDM systems.<br><span class="segmentSeparator"></span>These systems were able to synchronize identity data between applications and also provide some basic management capabilities.<br><span class="segmentSeparator"></span>But even such a simple functionality was a huge success.<br><span class="segmentSeparator"></span>The IDM systems could synchronize the data without any major modification of the applications, therefore they brought the integration cost to a reasonable level.<br><span class="segmentSeparator"></span>The problem was that the cost of the IDM systems themselves was quite high.<br><span class="segmentSeparator"></span>And these systems were still somehow crude, therefore the configuration and customization required a very specialized class of engineers.<br><span class="segmentSeparator"></span>This made the deployment of IDM solutions prohibitively expensive for many mid-size and smaller organizations.<br><span class="segmentSeparator"></span>And even big organizations often deployed IDM solution with quite limited features to make the cost acceptable.<br><span class="segmentSeparator"></span>These IDM systems later evolved and improved.<br><span class="segmentSeparator"></span>And there were companion products for governance and compliance that augmented the functionality.<br><span class="segmentSeparator"></span>But it often was almost impossible to change the original architecture or a product.<br><span class="segmentSeparator"></span>Therefore many first-generation products still struggle with limitations that originated in the early product design.</p>
</div>
<div class="paragraph">
<p>All the first-generation IDM systems were commercial closed-source software.<br><span class="segmentSeparator"></span>Many of these products are still available on the market and they are even considered to be leaders.<br><span class="segmentSeparator"></span>However, the closed-source character of the IDM products is itself a huge problem.<br><span class="segmentSeparator"></span>Every IDM solution has to be more-or-less customized.<br><span class="segmentSeparator"></span>Which usually means more rather than less.<br><span class="segmentSeparator"></span>It has to be the IDM system that adapts and not the applications.<br><span class="segmentSeparator"></span>Requiring each application to adapt to a standardized IDM interface means a lot of changes in a lot of different places, platforms and languages.<br><span class="segmentSeparator"></span>The total cost adds up to a huge number.<br><span class="segmentSeparator"></span>Such approach is being tried from time to time but it almost always fails.<br><span class="segmentSeparator"></span>It is not a practical approach.<br><span class="segmentSeparator"></span>While there are many applications in the IT infrastructure, there is just one IDM system.<br><span class="segmentSeparator"></span>If the IDM system adapts to applications and business processes, the changes are usually smaller and they are all in one place and implemented in a single platform.<br><span class="segmentSeparator"></span>So the IDM system must be able to adapt.<br><span class="segmentSeparator"></span>And it has to adapt a great deal and it has to adapt easily and quickly.<br><span class="segmentSeparator"></span>Closed-source software is notoriously bad at adapting to requirements that are difficult to predict.<br><span class="segmentSeparator"></span>Which in practice means that the IDM projects based on first-generation products were hard, slow and expensive.<br><span class="segmentSeparator"></span>Also the closed-source software is prone to vendor lock-in.<br><span class="segmentSeparator"></span>Once the IDM system is deployed and integrated it is extremely difficult to replace it with a competing system.<br><span class="segmentSeparator"></span>The closed-source vendor is the only entity that can modify the system and the system cannot be efficiently replaced.<br><span class="segmentSeparator"></span>Which means that the end customer is not in a position to negotiate.<br><span class="segmentSeparator"></span>Which means high maintenance costs.<br><span class="segmentSeparator"></span>Naturally the first generation of IDM system was a huge commercial success.<br><span class="segmentSeparator"></span>But only for the vendors.<br><span class="segmentSeparator"></span>This generation of IDM solutions really worked only for some customers and even there the real long-term benefits were often questionable.</p>
</div>
</div>
<div class="sect2">
<h3 id="_second_generation">Second Generation</h3>
<div class="paragraph">
<p>We can only speculate what were the reasons, but the fact is that around the years 2009-2011 several very interesting new IDM products appeared on the market.<br><span class="segmentSeparator"></span>One interesting thing is that all of them were more-or-less open source.<br><span class="segmentSeparator"></span>But there is much more.<br><span class="segmentSeparator"></span>Although all of the products are targeting the IDM space they are all significantly different.<br><span class="segmentSeparator"></span>They differ in their philosophy and governing principles.<br><span class="segmentSeparator"></span>One product is just a simple framework that can be programmed and extended ad nauseam while another product is a full-fledged IDM product with support for governance and compliance features.<br><span class="segmentSeparator"></span>Architecture of one product is quite heavyweight, based on Service-Oriented Architecture (SOA) principles.<br><span class="segmentSeparator"></span>And that product actually contains complete Enterprise Service Bus (ESB) embedded inside the system.<br><span class="segmentSeparator"></span>On the other hand, architecture of another product is a loosely coupled set of components that can be glued together with JavaScript.<br><span class="segmentSeparator"></span>Couple of other products are mostly based on proven and efficient lightweight Java architecture.<br><span class="segmentSeparator"></span>While some products are following good open source standards and they are building user communities, other products are open source only by the source code license and they are obviously not so much community-oriented.<br><span class="segmentSeparator"></span>So, there is a lot of variability.<br><span class="segmentSeparator"></span>Which means that are plenty options to choose from.</p>
</div>
<div class="paragraph">
<p>To be completely honest, not all second-generation IDM products are entirely ready for prime time.<br><span class="segmentSeparator"></span>It takes some time for a product to mature.<br><span class="segmentSeparator"></span>But there are few products that can handle all common IDM scenarios without any problems.<br><span class="segmentSeparator"></span>And at least one product is a comprehensive and feature-complete IDM system.<br><span class="segmentSeparator"></span>Some of the products stagnate and at least one product is practically dead.<br><span class="segmentSeparator"></span>But there are products that are actively maintained and continuously improved.</p>
</div>
<div class="paragraph">
<p>The most significant advantage of the second-generation IDM products is their open source character.<br><span class="segmentSeparator"></span>This is a characteristic that is easy to overlook, but it is almost impossible to overstate.<br><span class="segmentSeparator"></span>As every single IDM engineer knows, understanding of the IDM product and the ability to adapt the product are two critical aspects of any IDM project.<br><span class="segmentSeparator"></span>Open source is the best way to support both understanding and flexibility.<br><span class="segmentSeparator"></span>And there is also third important advantage: it is almost impossible to create a vendor lock-in situation with an open source product.<br><span class="segmentSeparator"></span>All of the open source products are backed by companies that offer professional support services that are equivalent to the services offered by commercial IDM products.<br><span class="segmentSeparator"></span>Therefore there are no disadvantages originating from the open source character of these projects.<br><span class="segmentSeparator"></span>Yet there are huge advantages that make this approach really revolutionary.</p>
</div>
<div class="paragraph">
<p>The second-generation IDM products are obvious choice for new IDM deployment projects.<br><span class="segmentSeparator"></span>The advantages of these products are quite clear and there is a great potential for future development.<br><span class="segmentSeparator"></span>However, as always, you must choose wisely.</p>
</div>
</div>
<div class="sect2">
<h3 id="_what_is_this_identity_management_anyway">What is This Identity Management, Anyway?</h3>
<div class="paragraph">
<p><em>Identity management</em> is a simple term which encompasses a very rich and comprehensive functionality.<br><span class="segmentSeparator"></span>It contains identity provisioning (and reprovisioning and deprovisioning), synchronization, organizational structure management, role-based access control, data consistency, approval processes, auditing and few dozens of other features.<br><span class="segmentSeparator"></span>All of that is thoroughly blended and mixed with a pinch of scripting and other seasoning until there is a smooth IDM solution.<br><span class="segmentSeparator"></span>Therefore it is quite difficult to tell what identity management is just by using a dictionary-like definition.<br><span class="segmentSeparator"></span>We would rather describe what identity management is by using a couple of typical usage scenarios.</p>
</div>
<div class="paragraph">
<p>Let’s have a fictional company called ExAmPLE, Inc.<br><span class="segmentSeparator"></span>This company has few thousand employees, decent partner network, customers and suppliers and all the other things as real-world companies have.<br><span class="segmentSeparator"></span>And ExAmPLE company has an IDM system running in its IT infrastructure.</p>
</div>
<div class="paragraph">
<p>ExAmPLE hires a new employee called Alice.<br><span class="segmentSeparator"></span>Alice signs an employee contract few days before she starts her employment.<br><span class="segmentSeparator"></span>The contract is entered into the HR system by the ExAmPLE HR staff.<br><span class="segmentSeparator"></span>The IDM system periodically scans the HR records and it discovers the record of a new hire.<br><span class="segmentSeparator"></span>The IDM systems pulls in the record and analyzes it.<br><span class="segmentSeparator"></span>The IDM system will take user’s name and employee number from the HR record, it will generate a unique username and based on that information it creates a user record in the IDM system.<br><span class="segmentSeparator"></span>The IDM system also gets the organization code of <code>11001</code> from the HR record.<br><span class="segmentSeparator"></span>The IDM will look inside its organizational tree and discovers that the code <code>11001</code> belongs to sales department.<br><span class="segmentSeparator"></span>Therefore IDM will automatically assign the user to the sales department.<br><span class="segmentSeparator"></span>The IDM will also process the work position code of <code>S007</code> in the HR record.<br><span class="segmentSeparator"></span>The IDM policies say that the code <code>S007</code> means sales agent and that anybody with that code should automatically receive the "Sales Agent" role.<br><span class="segmentSeparator"></span>Therefore the IDM will assign that role.<br><span class="segmentSeparator"></span>As this is a core employee, the IDM will automatically create an Active Directory account for the user together with the company mailbox.<br><span class="segmentSeparator"></span>The account will be placed into the Sales Department organizational unit.<br><span class="segmentSeparator"></span>The "Sales Agent" role entitles the user to more privileges.<br><span class="segmentSeparator"></span>Therefore the Active Directory account is automatically assigned to sales groups and distribution lists.<br><span class="segmentSeparator"></span>The role also gives access to the CRM system, therefore CRM account is also automatically created and assigned to appropriate groups.<br><span class="segmentSeparator"></span>All of that happens in a couple of seconds after the new HR record is detected.<br><span class="segmentSeparator"></span>And it all happens automatically.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/01-06-example-idm.png" alt="ExAmPLE IDM system">
</div>
</div>
<div class="paragraph">
<p>Alice starts her career and she is a really efficient employee.<br><span class="segmentSeparator"></span>Therefore she gets more responsibilities.<br><span class="segmentSeparator"></span>Alice is going to prepare specialized market analyses based on empirical data gathered in the field.<br><span class="segmentSeparator"></span>ExAmPLE is a really flexible company, always inventing new ways how to make business operations more efficient.<br><span class="segmentSeparator"></span>Therefore they invented this work position especially to take advantage of Alice’s skills.<br><span class="segmentSeparator"></span>Which means there is no work position code for Alice’s new job.<br><span class="segmentSeparator"></span>But she needs new privileges in the CRM system to do her work efficiently.<br><span class="segmentSeparator"></span>And she needs that right now.<br><span class="segmentSeparator"></span>Fortunately the ExAmPLE has a flexible IDM system.<br><span class="segmentSeparator"></span>Alice can log into the IDM system, select the privileges that she needs and request them.<br><span class="segmentSeparator"></span>The request has to be approved by Alice’s manager and also by the CRM system owner.<br><span class="segmentSeparator"></span>They get the notification about the request and they can easily approve or reject it in the IDM system.<br><span class="segmentSeparator"></span>Once the request is approved Alice’s CRM account will be automatically assigned to appropriate CRM groups.<br><span class="segmentSeparator"></span>Alice may start working on her analysis minutes or hours after she has requested the privileges.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/01-07-example-idm-approval.png" alt="ExAmPLE IDM approval">
</div>
</div>
<div class="paragraph">
<p>Alice lives happily ever after.<br><span class="segmentSeparator"></span>And one day she decides to get married.<br><span class="segmentSeparator"></span>Alice, similarly to many other women, has the strange habit of changing her surname after the marriage.<br><span class="segmentSeparator"></span>But now Alice has a really responsible work position and she has accounts in a dozen information systems.<br><span class="segmentSeparator"></span>This is no easy task to change her name in all of them, is it?<br><span class="segmentSeparator"></span>In fact it is very easy because ExAmPLE has its IDM system.<br><span class="segmentSeparator"></span>Alice goes to the HR department and the HR staff changes her surname in the HR system.<br><span class="segmentSeparator"></span>The IDM system will pick up the change and propagate that to all the affected systems.<br><span class="segmentSeparator"></span>Alice even automatically gets a new e-mail address with her new surname (keeping the old one as an alias).<br><span class="segmentSeparator"></span>Alice will receive a notification that now she can use her new e-mail address.<br><span class="segmentSeparator"></span>The change is fast, clean and effortless.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/01-08-example-idm-rename.png" alt="ExAmPLE IDM rename">
</div>
</div>
<div class="paragraph">
<p>Later that day Alice discovers that her password is about to expire.<br><span class="segmentSeparator"></span>Changing the password in all the applications would be a huge task.<br><span class="segmentSeparator"></span>But Alice knows what to do.<br><span class="segmentSeparator"></span>She logs into the IDM system and changes her password there.<br><span class="segmentSeparator"></span>The password change is automatically propagated to each affected system according to policy set up by the IT security office.</p>
</div>
<div class="paragraph">
<p>The following month something unexpected happens.<br><span class="segmentSeparator"></span>There is a security incident.<br><span class="segmentSeparator"></span>The security office discovered the incident and now they are investigating it.<br><span class="segmentSeparator"></span>It looks like it was an insider job.<br><span class="segmentSeparator"></span>The security officers are using the data from the IDM system to focus their investigation on users that had privileges to access affected information assets.<br><span class="segmentSeparator"></span>They pinpoint Mallory as a prime suspect.<br><span class="segmentSeparator"></span>The interesting thing is that Mallory should not have these privileges at all.<br><span class="segmentSeparator"></span>Luckily the IDM system also keeps an audit trail about every privilege change.<br><span class="segmentSeparator"></span>Therefore they discover that it was Mallory’s colleague Oscar that assigned these privileges to Mallory.<br><span class="segmentSeparator"></span>Both men are to be interviewed.<br><span class="segmentSeparator"></span>But as this incident affects sensitive assets there are some preventive measures to be executed before any word about the incident spreads.<br><span class="segmentSeparator"></span>The security officers use the IDM system to immediately disable all the accounts that Mallory and Oscar have.<br><span class="segmentSeparator"></span>It takes just a few seconds for IDM to disable these accounts in all the affected applications.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/01-09-example-idm-disable.png" alt="ExAmPLE IDM disable">
</div>
</div>
<div class="paragraph">
<p>The investigation later reveals that Oscar is mostly innocent.<br><span class="segmentSeparator"></span>Mallory misused Oscar’s trust and tricked him to assign the extra privileges.<br><span class="segmentSeparator"></span>Mallory abused the privileges to get sensitive data and he tried to sell them.<br><span class="segmentSeparator"></span>The decision is that Mallory has to immediately leave the company while Oscar may stay.<br><span class="segmentSeparator"></span>However, as Oscar has shown poor judgment in this case his responsibilities are reduced.<br><span class="segmentSeparator"></span>The IDM is now used to permanently disable all Mallory’s accounts, to re-enable Oscar’s accounts and also to revoke sensitive privileges that are considered too risky for Oscar to have.</p>
</div>
<div class="paragraph">
<p>Few months later Oscar is still ashamed because of his failure.<br><span class="segmentSeparator"></span>He decides not to prolong his employee contract with ExAmPLE and to leave the company without causing more trouble.<br><span class="segmentSeparator"></span>Oscar’s contract expires at the end of the month.<br><span class="segmentSeparator"></span>This date is recorded in the HR system and the IDM system takes it from there.<br><span class="segmentSeparator"></span>Therefore at midnight of the last Oscar’s day at work the IDM system automatically deletes all Oscar’s accounts.<br><span class="segmentSeparator"></span>Oscar starts a new career as a barman in New York.<br><span class="segmentSeparator"></span>He is very successful.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/01-10-example-idm-termination.png" alt="ExAmPLE IDM termination">
</div>
</div>
<div class="paragraph">
<p>The security office has handled the security incident in a professional way and the IDM system provided crucial data to make the security response quick and efficient.<br><span class="segmentSeparator"></span>They receive praise from the board of directors.<br><span class="segmentSeparator"></span>But the team always tries to improve.<br><span class="segmentSeparator"></span>They try to learn from the incident and reduce the possibility of such a thing happening again.<br><span class="segmentSeparator"></span>The team is using data from the IDM system to analyze the privileges assigned to individual users.<br><span class="segmentSeparator"></span>The usual job of the IDM system is to create and modify accounts in the applications.<br><span class="segmentSeparator"></span>But the IDM system is using bidirectional communication with the applications.<br><span class="segmentSeparator"></span>Therefore this analysis is far from being yet another pointless spreadsheet exercise.<br><span class="segmentSeparator"></span>The analysis is based on real application data processes and unified by the IDM system: what are the real accounts, to which user they belong, what roles they have, which groups they belong and so on.<br><span class="segmentSeparator"></span>The IDM system can detect accounts that do not have any clear owner.<br><span class="segmentSeparator"></span>The security team discovers quite a rich collection of testing accounts that were obviously used during the last data center outage half a year ago.<br><span class="segmentSeparator"></span>The IT operations staff obviously forgot about these accounts after the outage.<br><span class="segmentSeparator"></span>The security staff disables the accounts using the IDM tools and sets up an automated process to watch out for such accounts in the future.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/01-11-example-idm-orphans.png" alt="ExAmPLE IDM orphan detection">
</div>
</div>
<div class="paragraph">
<p>Based on the IDM data the security officers suspect that there are users that have too many privileges.<br><span class="segmentSeparator"></span>This is most likely a consequence of the request-and-approval process and these privileges simply accumulated over time.<br><span class="segmentSeparator"></span>But this is just a suspicion.<br><span class="segmentSeparator"></span>It is always difficult for a security staff to assess whether particular user should have certain privilege or should not have it.<br><span class="segmentSeparator"></span>This is especially difficult in flexible organizations such as ExAmPLE, where work responsibilities are often cumulated and organizational structures is somehow fuzzy.<br><span class="segmentSeparator"></span>Yet there are people that know what each employee should do: the managers.<br><span class="segmentSeparator"></span>However, there are many managers on many departments and it would be a huge task to talk to each one of them and consult the privileges.<br><span class="segmentSeparator"></span>The IDM system comes to the rescue once again.<br><span class="segmentSeparator"></span>The security officers set up automated access recertification campaign.<br><span class="segmentSeparator"></span>They sort all users to their managers based on the organizational structure which is maintained in the IDM system.<br><span class="segmentSeparator"></span>Each manager will receive an interactive list of their users and their privileges.<br><span class="segmentSeparator"></span>The manager must confirm (re-certify) that the user still needs those privileges.<br><span class="segmentSeparator"></span>This campaign is executed in a very efficient manner as the work is evenly distributed through the organization.<br><span class="segmentSeparator"></span>Therefore the campaign is completed in a couple of days.<br><span class="segmentSeparator"></span>At the end the security officers know which privileges are no longer needed and can be removed.<br><span class="segmentSeparator"></span>This reduces the exposure of the assets which is a very efficient way to reduce residual security risk.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Experienced identity management professionals certainly realized that this description is slightly idealized.<br><span class="segmentSeparator"></span>The real world is not a fairy tale and real life with an IDM system is much more complicated that this simple story suggests.<br><span class="segmentSeparator"></span>Even though the real life is harder than a story in a book, the IDM system remains an indispensable tool for automation and information security management.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_how_does_identity_management_technology_work">How Does Identity Management Technology Work?</h3>
<div class="paragraph">
<p>Obviously identity management systems have a lot of advantages for business, processes, efficiency and all that stuff.<br><span class="segmentSeparator"></span>But how does it really works on a technological level?<br><span class="segmentSeparator"></span>The basic principle is very simple: identity management system is just a sophisticated data synchronization engine.</p>
</div>
<div class="paragraph">
<p>Identity management system takes data from the source systems, such as HR databases.<br><span class="segmentSeparator"></span>It is processing the data, mapping and transforming the values as necessary.<br><span class="segmentSeparator"></span>It will figure out which records are new.<br><span class="segmentSeparator"></span>The IDM engine will do some (usually quite complex) processing on the records.<br><span class="segmentSeparator"></span>That usually includes processing policies such as Role-Based Access Control (RBAC), organizational policies, password policies and so on.<br><span class="segmentSeparator"></span>The result of this processing is creation or modification of user accounts in other systems such as Active Directory, CRM systems and so on.<br><span class="segmentSeparator"></span>So basically it is all about getting the data, changing them and moving them around.<br><span class="segmentSeparator"></span>This does not seem very revolutionary, does it?<br><span class="segmentSeparator"></span>But it is all about the details.<br><span class="segmentSeparator"></span>It is the way how the IDM system gathers the data, how it is processing the data and how it is propagating the changes that make all the difference.</p>
</div>
</div>
<div class="sect2">
<h3 id="_identity_management_connectors">Identity Management Connectors</h3>
<div class="paragraph">
<p>Identity management system must connect to many different applications, databases and information systems.<br><span class="segmentSeparator"></span>Typical IDM deployment has tens or even hundreds of such connections.<br><span class="segmentSeparator"></span>Therefore the ease of connecting IDM system with its environment is one of its essential qualities.</p>
</div>
<div class="paragraph">
<p>Current IDM systems use <em>connectors</em> to communicate with all surrounding systems.<br><span class="segmentSeparator"></span>These connectors are based on similar principles that database drivers.<br><span class="segmentSeparator"></span>On one end there is unified connector interface that presents that data from all the systems using the same "protocol".<br><span class="segmentSeparator"></span>On the end of the connector is the native protocol that the application supports.<br><span class="segmentSeparator"></span>Therefore there are connectors for LDAP and various LDAP variants, SQL protocols and dialects, connectors that are file-based, connectors that invoke web services or REST services and so on.<br><span class="segmentSeparator"></span>Every slightly advanced IDM system has tens of different connects.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/01-12-connectors.png" alt="Connectors">
</div>
</div>
<div class="paragraph">
<p>Connector is usually relatively simple piece of code.<br><span class="segmentSeparator"></span>Primary responsibility of a connector is to adapt communication protocols.<br><span class="segmentSeparator"></span>Therefore LDAP connector translates the LDAP protocol messages into data represented using a common connector interface.<br><span class="segmentSeparator"></span>The SQL connector does the same thing with SQL-based protocols.<br><span class="segmentSeparator"></span>The connector also interprets the operations invoked on the common connector interface by the IDM system.<br><span class="segmentSeparator"></span>Therefore the LDAP protocol will execute the "create" operation by sending LDAP "add" message to the LDAP server and parsing the reply.<br><span class="segmentSeparator"></span>Connectors usually implement the basic set of create-read-update-delete (CRUD) operations.<br><span class="segmentSeparator"></span>Therefore a typical connector is quite simple piece of code.<br><span class="segmentSeparator"></span>Despite its simplicity the whole connector idea is a clever one.<br><span class="segmentSeparator"></span>The IDM system does not need to deal with the communication details.<br><span class="segmentSeparator"></span>The core of the IDM system can be built to focus on the generic identity management logic which is typically quite complex just by itself.<br><span class="segmentSeparator"></span>Therefore any simplification that the connectors provide is more than welcome.</p>
</div>
<div class="paragraph">
<p>Connectors are usually accessing external interfaces of source and target systems.<br><span class="segmentSeparator"></span>It is natural that the connector authors will choose interfaces that are public, well-documented and based on open standards.<br><span class="segmentSeparator"></span>Many newer systems have interfaces like that.<br><span class="segmentSeparator"></span>But there are notorious cases that refuse to provide such interface.<br><span class="segmentSeparator"></span>Despite that there is almost always some way to build a connector.<br><span class="segmentSeparator"></span>The connector may create record directly in the application database.<br><span class="segmentSeparator"></span>Or it may execute a database routine.<br><span class="segmentSeparator"></span>Or it may execute a command-line tool for account management.<br><span class="segmentSeparator"></span>Or it may even do crazy things such as simulation of a user working with text terminal and filling out a form to create new account.<br><span class="segmentSeparator"></span>There is almost always a way to do what connector needs to do.<br><span class="segmentSeparator"></span>Just some ways are nicer than others.</p>
</div>
<div class="paragraph">
<p>The connector-based architecture is pretty much standard among all advanced IDM systems.<br><span class="segmentSeparator"></span>Yet the connector interfaces significantly vary from one IDM system to another.<br><span class="segmentSeparator"></span>Therefore the connectors are not interchangeable between different IDM systems.<br><span class="segmentSeparator"></span>The connector interfaces are all proprietary.<br><span class="segmentSeparator"></span>And the connectors are often used as weapons to somehow artificially increase the profit from IDM solution deployment.<br><span class="segmentSeparator"></span>Except for one case.<br><span class="segmentSeparator"></span>The ConnId connector framework is the only connector interface that is actively used and developed by several competing IDM systems.<br><span class="segmentSeparator"></span>It is perhaps no big surprise that ConnId is an open source framework.</p>
</div>
<div class="paragraph">
<p>Even though connector-based approach is quite widespread, some older IDM systems are not using connectors.<br><span class="segmentSeparator"></span>Some IDM products use agents instead of connectors.<br><span class="segmentSeparator"></span>Agent does similar job than the connector does.<br><span class="segmentSeparator"></span>However, agent is not part of the IDM system instance.<br><span class="segmentSeparator"></span>Agents are installed in each connected application and they communicate with the IDM system using a remote network protocol.<br><span class="segmentSeparator"></span>This is a major burden.<br><span class="segmentSeparator"></span>The agents needs to be installed everywhere.<br><span class="segmentSeparator"></span>And then they need to be maintained, upgraded, there may be subtle incompatibilities and so on.<br><span class="segmentSeparator"></span>Also running a third-party code inside every application can be a major security issue.<br><span class="segmentSeparator"></span>Overall the agent-based systems are too cumbersome (and too costly) to operate.<br><span class="segmentSeparator"></span>The whole agent idea perhaps originated somewhere in our digital past when applications and databases haven’t supported any native remote interfaces.<br><span class="segmentSeparator"></span>In such a situation the agents are obviously better than connectors.<br><span class="segmentSeparator"></span>Fortunately, this is a thing of the past.<br><span class="segmentSeparator"></span>Today even old applications have some way to manage identities using a remote interface.<br><span class="segmentSeparator"></span>This is typically some web or REST service that are easy to access from a connector.<br><span class="segmentSeparator"></span>But even if the application provides only a command-line interface or interactive terminal session there are connectors that can handle that sufficiently well.<br><span class="segmentSeparator"></span>Therefore today the agent-based systems are generally considered to be obsolete.</p>
</div>
</div>
<div class="sect2">
<h3 id="_identity_provisioning">Identity Provisioning</h3>
<div class="paragraph">
<p>Provisioning is perhaps the most frequently used feature in any IDM system.<br><span class="segmentSeparator"></span>In the generic sense <em>provisioning</em> means maintenance of user accounts in applications, databases and other target systems.<br><span class="segmentSeparator"></span>This includes creation of the account, various modifications during the account lifetime and permanent disable or delete at the end of the lifetime.<br><span class="segmentSeparator"></span>The IDM system is using <em>connectors</em> to manipulate the accounts.<br><span class="segmentSeparator"></span>And in fact good IDM systems can manage much more than just accounts.<br><span class="segmentSeparator"></span>Management of groups and group membership was quite a rare feature in early years of IDM technology.<br><span class="segmentSeparator"></span>Yet today an IDM system that cannot manage groups is almost useless.<br><span class="segmentSeparator"></span>Almost all IDM systems work with roles.<br><span class="segmentSeparator"></span>But only few IDM systems can also provision and synchronize the roles (e.g.<br><span class="segmentSeparator"></span>automatically create LDAP group for each new role).<br><span class="segmentSeparator"></span>Good IDM system can also manage, provision and synchronize organizational structures.<br><span class="segmentSeparator"></span>However, this feature still is still not entirely common.</p>
</div>
</div>
<div class="sect2">
<h3 id="_synchronization_and_reconciliation">Synchronization and Reconciliation</h3>
<div class="paragraph">
<p>Identity provisioning may be the most important feature of an IDM system.<br><span class="segmentSeparator"></span>But if an IDM system did just the provisioning and nothing else it would be a quick an utter failure.<br><span class="segmentSeparator"></span>It is not enough to create an account when a new employee is hired or delete that account when an employee leaves.<br><span class="segmentSeparator"></span>Reality works in mysterious ways and it can easily make a big mess in a very short time.<br><span class="segmentSeparator"></span>Maybe there was a crash in one of the applications and the data were restored from a backup.<br><span class="segmentSeparator"></span>So an account that was deleted few hours ago is unexpectedly resurrected.<br><span class="segmentSeparator"></span>It stays there, alive, unchecked and dangerous.<br><span class="segmentSeparator"></span>Maybe an administrator manually created an account for a new assistant because the HR people were all busy to process the papers.<br><span class="segmentSeparator"></span>And the new assistant had such pretty eyes.<br><span class="segmentSeparator"></span>When the record finally gets to the HR system and it is processed the IDM system discovers that there is already a conflicting account and it simply stops with an error.<br><span class="segmentSeparator"></span>Maybe few (hundred) accounts get accidentally deleted by junior system administrator trying out an innovative system administration routine.<br><span class="segmentSeparator"></span>There are simply too many ways how things can go wrong.<br><span class="segmentSeparator"></span>And in reality they do go wrong surprisingly often.<br><span class="segmentSeparator"></span>It is not enough for an IDM system to just set things up and then forget about it.<br><span class="segmentSeparator"></span>One of the most important features of any self-respecting IDM system is to make sure that everything is right and also that it stays right all the time.<br><span class="segmentSeparator"></span>Identity management is all about continuous maintenance of the identities.<br><span class="segmentSeparator"></span>Without that continuity the whole IDM system is almost useless.</p>
</div>
<div class="paragraph">
<p>The trick to keep the data in order is to know when they get out of order.<br><span class="segmentSeparator"></span>In other words, the IDM system must detect when the data in the application databases change.<br><span class="segmentSeparator"></span>If an IDM system detects that there was a change then it is not that difficult to react to the change and fix it.<br><span class="segmentSeparator"></span>The secret ingredient is the ability to detect changes.<br><span class="segmentSeparator"></span>But there’s a slight issue with that, isn’t it?<br><span class="segmentSeparator"></span>We cannot expect that the application will send a notification to the IDM system every time a change happens.<br><span class="segmentSeparator"></span>We do not want to modify the applications, otherwise the IDM deployment will be prohibitively expensive.<br><span class="segmentSeparator"></span>The application needs to be passive and the IDM system needs to be active.<br><span class="segmentSeparator"></span>Fortunately, there are several ways how to do that.</p>
</div>
<div class="paragraph">
<p>Some applications already keep a track of the changes.<br><span class="segmentSeparator"></span>Some databases record a timestamp of the last change for each row.<br><span class="segmentSeparator"></span>Some directory servers keep a record of recent changes for the purpose of data replication.<br><span class="segmentSeparator"></span>Such meta-data can be used by the IDM system.<br><span class="segmentSeparator"></span>The IDM system may periodically scan the timestamps or replication logs for new changes.<br><span class="segmentSeparator"></span>When the IDM detects a change it can retrieve the changed objects and react to the change based on its policies.<br><span class="segmentSeparator"></span>The scanning for changes based on meta-data is usually very efficient therefore it can be executed every couple of minutes.<br><span class="segmentSeparator"></span>Therefore the reaction to the change can be done almost in the real-time.<br><span class="segmentSeparator"></span>This method has many names in various IDM systems.<br><span class="segmentSeparator"></span>It is called "live synchronization", "active synchronization" or simply just "synchronization".<br><span class="segmentSeparator"></span>Sadly, this method is not always available.<br><span class="segmentSeparator"></span>In fact this ability is quite rare.</p>
</div>
<div class="paragraph">
<p>But all is not lost.<br><span class="segmentSeparator"></span>Even if the application does not maintain good meta-data that allow near-real-time change detection there is still one very simple way that works for almost any system.<br><span class="segmentSeparator"></span>The IDM system gets the list of all accounts in the application.<br><span class="segmentSeparator"></span>Then it compares that list with the list of accounts that are <em>supposed</em> to be there.<br><span class="segmentSeparator"></span>Therefore it compares the reality (what <em>is</em> there) with the policy (what <em>should be</em> there).<br><span class="segmentSeparator"></span>The IDM system can react to any discrepancies and repair them.<br><span class="segmentSeparator"></span>This method is called <em>reconciliation</em>.<br><span class="segmentSeparator"></span>It is quite a brutal method, almost barbaric.<br><span class="segmentSeparator"></span>But it does the job.</p>
</div>
<div class="paragraph">
<p>Listing all accounts and processing each of them may seem as a straightforward job.<br><span class="segmentSeparator"></span>But it can be extremely slow if the number of accounts is high and the policies are complex.<br><span class="segmentSeparator"></span>It can take anything from few minutes to few days.<br><span class="segmentSeparator"></span>Therefore it cannot be executed frequently.<br><span class="segmentSeparator"></span>Running that once per day is feasible only for small and simple systems.<br><span class="segmentSeparator"></span>Running it once per week (on weekends) is a more common practice.<br><span class="segmentSeparator"></span>But many systems cannot afford to run it more frequently than once per month.</p>
</div>
<div class="paragraph">
<p>There are also other methods.<br><span class="segmentSeparator"></span>But synchronization and reconciliations are the most frequently used.<br><span class="segmentSeparator"></span>The drawback of synchronization is that it is not entirely reliable.<br><span class="segmentSeparator"></span>The IDM system may miss some changes, e.g.<br><span class="segmentSeparator"></span>due to change log expiration, system times not being synchronized or variety of other reasons.<br><span class="segmentSeparator"></span>On the other hand, reconciliation is mostly reliable.<br><span class="segmentSeparator"></span>But it is a very demanding task.<br><span class="segmentSeparator"></span>Therefore these two methods are often used together.<br><span class="segmentSeparator"></span>Synchronization runs all the time and handles vast majority of the changes.<br><span class="segmentSeparator"></span>Reconciliation runs weekly or monthly and it acts as a safety net to catch the changes that might have escaped during synchronization.</p>
</div>
<div class="paragraph">
<p>Listing all accounts and processing each of them may seem as a straightforward job.<br><span class="segmentSeparator"></span>But it can be extremely slow if the number of accounts is high and the policies are complex.<br><span class="segmentSeparator"></span>It can take anything from few minutes to few days.<br><span class="segmentSeparator"></span>Therefore it cannot be executed frequently.<br><span class="segmentSeparator"></span>Running that once per day is feasible only for small and simple systems.<br><span class="segmentSeparator"></span>Running it once per week (on weekends) is a more common practice.<br><span class="segmentSeparator"></span>But many systems cannot afford to run it more frequently than once per month.</p>
</div>
<div class="paragraph">
<p>There are also other methods.<br><span class="segmentSeparator"></span>But synchronization and reconciliations are the most frequently used.<br><span class="segmentSeparator"></span>The drawback of synchronization is that it is not entirely reliable.<br><span class="segmentSeparator"></span>The IDM system may miss some changes, e.g.<br><span class="segmentSeparator"></span>due to change log expiration, system times not being synchronized or variety of other reasons.<br><span class="segmentSeparator"></span>On the other hand, reconciliation is mostly reliable.<br><span class="segmentSeparator"></span>But it is a very demanding task.<br><span class="segmentSeparator"></span>Therefore these two methods are often used together.<br><span class="segmentSeparator"></span>Synchronization runs all the time and handles vast majority of the changes.<br><span class="segmentSeparator"></span>Reconciliation runs weekly or monthly and it acts as a safety net to catch the changes that might have escaped during synchronization.</p>
</div>
</div>
<div class="sect2">
<h3 id="_identity_management_and_role_based_access_control">Identity Management and Role-Based Access Control</h3>
<div class="paragraph">
<p>Managing permissions for every user individually is a feasible options only if the number of users is very low.<br><span class="segmentSeparator"></span>Individual management of permissions becomes very difficult with populations as small as few hundreds of users.<br><span class="segmentSeparator"></span>When the number of users goes over a thousand such management usually becomes an unbearable burden.<br><span class="segmentSeparator"></span>The individual management of permissions is not only a huge amount of work, it is also quite an error-prone routine.<br><span class="segmentSeparator"></span>This has been known for decades.<br><span class="segmentSeparator"></span>Therefore many systems unified common combinations of permissions into roles and the concept of Role-Based Access Control (RBAC) was born.<br><span class="segmentSeparator"></span>The roles often represent work positions or responsibilities that are much closer to the “business” than technical permissions.<br><span class="segmentSeparator"></span>A role may reflect the concepts of bank teller, website administrator or sales manager.<br><span class="segmentSeparator"></span>User has a role, the role contains permissions, permissions are used for authorization - that is the basic principle of RBAC.<br><span class="segmentSeparator"></span>The low-level permissions are hidden from the users.<br><span class="segmentSeparator"></span>Users are quite happy when they deal with the business-friendly role names.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Terminology.</div>
The term <em>RBAC</em> is frequently used in the industry, however the actual meaning of RBAC is not always clear.<br><span class="segmentSeparator"></span>The confusion is perhaps caused by the fact that there is a formal RBAC specification known as <em>NIST RBAC model</em>.<br><span class="segmentSeparator"></span>When people say RBAC some of them mean that specific formal model, others mean anything that is similar to that formal model and yet others mean anything that deals with roles.<br><span class="segmentSeparator"></span>We use the term RBAC in quite a broad sense.<br><span class="segmentSeparator"></span>Major identity management systems usually implement a mechanism that is inspired by the formal NIST RBAC model, but the mechanism deviates form the formal model as necessary.<br><span class="segmentSeparator"></span>That is what we mean when we use the term RBAC.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Most RBAC systems allow for roles to be placed inside other roles thus creating role hierarchy.<br><span class="segmentSeparator"></span>Top of the hierarchy is usually composed of business roles such as “marketing specialist”.<br><span class="segmentSeparator"></span>Business roles contain a lower-level roles.<br><span class="segmentSeparator"></span>These are often application roles such as “web site analytics” or “CMS administrator”.<br><span class="segmentSeparator"></span>These lower-level roles may contain concrete permissions.<br><span class="segmentSeparator"></span>Or they may contain other roles that are even closer to the underlying technology.<br><span class="segmentSeparator"></span>And so and so on, there are proverbial turtles all the way down.<br><span class="segmentSeparator"></span>Role hierarchy is often a must when the number of permissions and users gets higher.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/01-13-role-hierarchy.png" alt="Role hierarchy">
</div>
</div>
<div class="paragraph">
<p>No IDM system can be really complete without RBAC mechanism in place.<br><span class="segmentSeparator"></span>Therefore vast majority of IDM systems support roles in one way or another.<br><span class="segmentSeparator"></span>However, the quality of RBAC support significantly varies.<br><span class="segmentSeparator"></span>Some IDM systems only support the bare minimum that is required to claim RBAC support.<br><span class="segmentSeparator"></span>Other systems have excellent and very advanced dynamic and parametric hybrid RBAC systems.<br><span class="segmentSeparator"></span>Most IDM systems are somewhere in between.</p>
</div>
<div class="paragraph">
<p>Role-based mechanism is a very useful management tool.<br><span class="segmentSeparator"></span>In fact the efficiency of role-based mechanism often leads to its overuse.<br><span class="segmentSeparator"></span>This is a real danger especially in bigger and somehow complex environments.<br><span class="segmentSeparator"></span>The people that design roles in such environment have a strong motivation to maintain order by dividing the roles to smallest reusable pieces and then re-combining them in a form of application and business roles.<br><span class="segmentSeparator"></span>This is further amplified by the security best practices such as the <em>principle of least privilege</em>.<br><span class="segmentSeparator"></span>This is completely understandable and perfectly valid motivation.<br><span class="segmentSeparator"></span>However, it requires extreme care to keep such RBAC structure maintainable.<br><span class="segmentSeparator"></span>Even though this may seem counter-intuitive, it is quite common that the number of roles exceeds the number of users in the system.<br><span class="segmentSeparator"></span>Unfortunately, this approach turns the complex problem of user management to even more complex problem of role management.<br><span class="segmentSeparator"></span>This phenomenon is known as <em>role explosion</em>.</p>
</div>
<div class="paragraph">
<p>Role explosion is a real danger and it is definitely not something that can be avoided easily.<br><span class="segmentSeparator"></span>The approach that prevailed in the first-generation IDM deployments was to simply live with the consequences of role explosion.<br><span class="segmentSeparator"></span>Some IDM deployments even created tools that were able to automatically generate and (more-or-less successfully) manage hundreds of thousands of roles.<br><span class="segmentSeparator"></span>However, this is not a sustainable approach.<br><span class="segmentSeparator"></span>The second-generation IDM systems bring features that may help to avoid the role explosion in the first place.<br><span class="segmentSeparator"></span>Such mechanisms are usually based on the idea to make the roles <em>dynamic</em>.<br><span class="segmentSeparator"></span>The roles are no longer just a static set of privileges.<br><span class="segmentSeparator"></span>Dynamic roles may contain small pieces of algorithmic logic used to construct the privileges.<br><span class="segmentSeparator"></span>Input to these algorithms are parameters that are specified when the role is assigned.<br><span class="segmentSeparator"></span>Therefore the same role can be reused for many related purposes without a need to duplicate the roles.<br><span class="segmentSeparator"></span>This can significantly limit the number of roles required to model a complex system.<br><span class="segmentSeparator"></span>This is the best weapon against role explosion that we currently have.</p>
</div>
<div class="paragraph">
<p>Even though the RBAC system has some drawbacks it is necessary for almost any practical IDM solutions.<br><span class="segmentSeparator"></span>There were several attempts to replace the RBAC system with a completely different approach.<br><span class="segmentSeparator"></span>Such attempts have some success in the access management and related field.<br><span class="segmentSeparator"></span>But those alternatives cannot easily replace RBAC in the identity management.<br><span class="segmentSeparator"></span>Attribute-Based Access Control (ABAC) is one such popular example.<br><span class="segmentSeparator"></span>The ABAC idea is based on replacing the roles with pure algorithmic policies.<br><span class="segmentSeparator"></span>Simply speaking, ABAC policy is a set of algorithms that take user attributes as input.<br><span class="segmentSeparator"></span>The policy combines that input with the data about operation and context.<br><span class="segmentSeparator"></span>Output of the policy is a decision whether an operation should be allowed or denied.<br><span class="segmentSeparator"></span>This approach is simple and it may work reasonably well in the access management world where the AM server knows a lot of details about the operation that just takes place.<br><span class="segmentSeparator"></span>But in the IDM field we need to set up the account before the user logs in for the first time.<br><span class="segmentSeparator"></span>There are no data about the operation yet.<br><span class="segmentSeparator"></span>And even contextual data are very limited.<br><span class="segmentSeparator"></span>That, together with other issues, makes ABAC a very poor choice for an IDM system.<br><span class="segmentSeparator"></span>Therefore whether you like it or not, RBAC is the primary mechanism of any practical IDM solution.<br><span class="segmentSeparator"></span>And it is here to stay.</p>
</div>
</div>
<div class="sect2">
<h3 id="_identity_management_and_authorizations">Identity Management and Authorizations</h3>
<div class="paragraph">
<p>The basic principle of authorization in the information security is quite straightforward:
take the <em>subject</em> (user), <em>object</em> (the things that user is trying to access) and the <em>operation</em>.<br><span class="segmentSeparator"></span>Evaluate whether the policy allows that subject-object-operation triple.<br><span class="segmentSeparator"></span>If policy does not allow it then deny the operation.<br><span class="segmentSeparator"></span>This is quite simple.<br><span class="segmentSeparator"></span>But in the identity management field we need to think quite differently.<br><span class="segmentSeparator"></span>We need to work backwards.<br><span class="segmentSeparator"></span>The IDM system needs to setup an account for a user before the user initiates any operation.<br><span class="segmentSeparator"></span>And when user really starts an operation then the IDM system will not know anything about it.<br><span class="segmentSeparator"></span>Therefore the concept of authorization in the IDM world is somehow turned completely upside down.</p>
</div>
<div class="paragraph">
<p>The IDM system does not take direct part in authorization.<br><span class="segmentSeparator"></span>IDM system sets up accounts in applications and databases.<br><span class="segmentSeparator"></span>But the IDM system itself is not active when user logs into an application and executes the operations.<br><span class="segmentSeparator"></span>Does that mean IDM system cannot do anything about authorizations?<br><span class="segmentSeparator"></span>Definitely not.<br><span class="segmentSeparator"></span>The IDM system does not enforce authorization decisions.<br><span class="segmentSeparator"></span>But the IDM can manage the data that determine how the authorization is evaluated.<br><span class="segmentSeparator"></span>IDM system can place the account to the correct groups, which will cause certain operations to be allowed and other operations denied.<br><span class="segmentSeparator"></span>IDM system can set up an access control lists (ACLs) for each account that it manages.<br><span class="segmentSeparator"></span>IDM system is not evaluating or enforcing the authorizations directly.<br><span class="segmentSeparator"></span>But it indirectly manages the data that are used to evaluate authorizations.<br><span class="segmentSeparator"></span>And this is extremely important feature.</p>
</div>
<div class="paragraph">
<p>Authentication and authorizations are two very prominent concepts of information security.<br><span class="segmentSeparator"></span>And they are vitally important for any identity and access management solution.<br><span class="segmentSeparator"></span>However, authentication is quite simple in principle.<br><span class="segmentSeparator"></span>Yes, the user may have several credential types used in adaptive multi-factor authentication.<br><span class="segmentSeparator"></span>But while that description sounds a bit scary it is still not that complex.<br><span class="segmentSeparator"></span>There are just a couple of policy statements that govern authentication.<br><span class="segmentSeparator"></span>Also, authentication is typically quite uniform: most users are authenticating using the same mechanism.<br><span class="segmentSeparator"></span>Authentication is not that difficult to centralize (although it may be expensive).<br><span class="segmentSeparator"></span>Authentication is therefore relatively easy to manage.</p>
</div>
<div class="paragraph">
<p>But it is quite a different story for authorization.<br><span class="segmentSeparator"></span>Every application has slightly different authorization mechanism.<br><span class="segmentSeparator"></span>And these mechanisms are not easy to unify.<br><span class="segmentSeparator"></span>One of the major obstacles is that every application works with different objects, the objects may have complex relations with other objects and all of them may also have complex relations with the subjects.<br><span class="segmentSeparator"></span>The operations are also far from being straightforward as they may be parametrized.<br><span class="segmentSeparator"></span>And then there is context.<br><span class="segmentSeparator"></span>There may be per-operation limits, daily limits, operations allowed only during certain times or when system is in certain state.<br><span class="segmentSeparator"></span>And so on.<br><span class="segmentSeparator"></span>This is very difficult to centralize.<br><span class="segmentSeparator"></span>Also, almost every user has slightly different combination of authorizations.<br><span class="segmentSeparator"></span>Which means that there is a great variability and a lot of policies to manage.<br><span class="segmentSeparator"></span>And then there are two crucial aspects that add whole new dimension of complexity: performance and scalability.<br><span class="segmentSeparator"></span>Authorization decisions are evaluated all the time.<br><span class="segmentSeparator"></span>It is not rare to see an authorization evaluated several times for each request.<br><span class="segmentSeparator"></span>Authorization processing needs to be fast.<br><span class="segmentSeparator"></span>Really fast.<br><span class="segmentSeparator"></span>Even a round-trip across a local network may be a performance killer.<br><span class="segmentSeparator"></span>Due to complexity and performance reasons the authorization mechanisms are often tightly integrated into the fabric of each individual application.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>it is a common practice that authorization policies are translated to SQL and they are used as an additional clauses in application-level SQL queries.<br><span class="segmentSeparator"></span>This technique is taking advantage of the database engine to quickly filter out the data that the user is not authorized to access.<br><span class="segmentSeparator"></span>This method is very efficient and it is perhaps the only practical option when dealing with large-scale data sets.<br><span class="segmentSeparator"></span>However this approach is tightly bound to the application data model and it is usually almost impossible to externalize.</p>
</div>
<div class="paragraph">
<p>Therefore it is not realistic to expect that the authorization could be centralized anytime soon.<br><span class="segmentSeparator"></span>The authorization policies need to be distributed into the applications.<br><span class="segmentSeparator"></span>But managing partial and distributed policies is not an easy task.<br><span class="segmentSeparator"></span>Someone has to make sure that the application policies are consistent with the overall security policy of the organization.<br><span class="segmentSeparator"></span>Fortunately, the IDM systems are designed especially to handle management and synchronization of data in broad range of systems.<br><span class="segmentSeparator"></span>Therefore the IDM system is the obvious choice when it comes to management of authorization policies.</p>
</div>
</div>
<div class="sect2">
<h3 id="_organizational_structure_roles_services_and_other_wildlife">Organizational Structure, Roles, Services and Other Wildlife</h3>
<div class="paragraph">
<p>Back in 2000s the IDM was all about managing user accounts.<br><span class="segmentSeparator"></span>It was enough to create, disable and delete an account to a have an successful IDM deployment.<br><span class="segmentSeparator"></span>But the world is a different place now.<br><span class="segmentSeparator"></span>Managing the accounts is simply not enough any more.<br><span class="segmentSeparator"></span>Yes, automated account management brings significant benefits and it is a necessary condition to get at least a minimal level of security in complex systems.<br><span class="segmentSeparator"></span>But account management is often not enough to justify the cost of an IDM system.<br><span class="segmentSeparator"></span>Therefore current IDM systems can do much more than just a simple account management.</p>
</div>
<div class="paragraph">
<p>There are many things that an advanced IDM system can manage:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Accounts.<br><span class="segmentSeparator"></span>Obviously.<br><span class="segmentSeparator"></span>Many IDM systems can fully manage account attributes, groups membership, privileges, account status (enabled/disabled), validity dates and all the other details.</p>
</li>
<li>
<p>Groups and roles.<br><span class="segmentSeparator"></span>Apart from managing the membership of accounts in groups the IDM system can take care of the whole group life-cycle: create a group, manage it and delete it.</p>
</li>
<li>
<p>Organizational structure.<br><span class="segmentSeparator"></span>The IDM system can take organizational structure from its authoritative source (usually HR) and synchronize it to all the applications that need it.<br><span class="segmentSeparator"></span>Or the IDM itself may be used to manually maintain an organizational structure.</p>
</li>
<li>
<p>Servers, services, devices and "things".<br><span class="segmentSeparator"></span>While this is not yet IDM mainstream, there are some experimental solutions that use IDM principles to manage concepts that are slightly outside the traditional IDM scope.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>there is an IDM-based solution that can automatically deploy predefined set of virtual machines for each new project.<br><span class="segmentSeparator"></span>The new IDM systems are so flexible that they can theoretically manage everything that is at least marginally related to the concept of identity: virtual machines, networks, applications, configurations, devices … almost anything.<br><span class="segmentSeparator"></span>This is still quite a unique functionality.<br><span class="segmentSeparator"></span>But it is very likely that we will see more stories about this in the future.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>While all these features are interesting, some of them clearly stand out.<br><span class="segmentSeparator"></span>The management of groups and organizational structure are those that are absolutely critical for almost any new IDM deployment.<br><span class="segmentSeparator"></span>Your organizational structure may be almost flat and project-oriented or you may have twelve levels of divisions and sections.<br><span class="segmentSeparator"></span>But regardless of the size and shape of your organizational structure it needs to be managed and synchronized across applications in pretty much the same way as identities are synchronized.<br><span class="segmentSeparator"></span>You may need to create groups in Active Directory for each of your organizational unit.<br><span class="segmentSeparator"></span>You want them to be correctly nested.<br><span class="segmentSeparator"></span>You may want to create distribution list for each of your ad-hoc team.<br><span class="segmentSeparator"></span>And you want this operation to have as little overhead as possible otherwise the teams cannot really be managed in ad-hoc fashion.<br><span class="segmentSeparator"></span>You may want to synchronize the information about projects into your issue tracking system.<br><span class="segmentSeparator"></span>You may also want to automatically create a separate wiki space and a new source code repository for each new development project.<br><span class="segmentSeparator"></span>The possibilities are almost endless.<br><span class="segmentSeparator"></span>Both the traditional organizations and the new lean and agile companies will benefit from that.</p>
</div>
<div class="paragraph">
<p>Organizational structure management is closely related to group management.<br><span class="segmentSeparator"></span>The groups are often bound to workgroups, projects or organizational units.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>and IDM system can automatically maintain several groups for each project (admin and member groups).<br><span class="segmentSeparator"></span>Those groups can be used for authorization.<br><span class="segmentSeparator"></span>Similarly an IDM system can automatically maintain application-level roles, access control lists (ACLs) and other data structures that are usually used for authorization.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/01-14-org-sync.png" alt="Organizational tree synchronization">
</div>
</div>
<div class="paragraph">
<p>While this functionality provides benefits in almost any deployment, organizational structure management is absolutely crucial for organizations that are based on tree-like functional organizational structures.<br><span class="segmentSeparator"></span>These organizations heavily rely on the information derived from organizational structure.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>direct manager of the document author can review an approve the document in the document management system.<br><span class="segmentSeparator"></span>Only the employees in the same division can see the document draft.<br><span class="segmentSeparator"></span>Only the employees of a marketing section can see marketing plans.<br><span class="segmentSeparator"></span>And so on.<br><span class="segmentSeparator"></span>Traditionally, such data are encoded into an incomprehensible set of authorization groups and lists.<br><span class="segmentSeparator"></span>And that contributes to the fact that reorganizations are a total nightmare for IT administrators.<br><span class="segmentSeparator"></span>However, an IDM system can significantly improve the situation.<br><span class="segmentSeparator"></span>IDM can create the groups automatically.<br><span class="segmentSeparator"></span>It can make sure that the right users are assigned into these groups.<br><span class="segmentSeparator"></span>It can synchronize information about the managers into all affected applications.<br><span class="segmentSeparator"></span>And so on.<br><span class="segmentSeparator"></span>And a good IDM system can do all of that using just a handful of configuration objects.</p>
</div>
<div class="paragraph">
<p>This seems to be almost too good to be true.<br><span class="segmentSeparator"></span>And it is fair to admit that the quality of organizational management features significantly varies among IDM systems.<br><span class="segmentSeparator"></span>Group management and organizational structure management seem to be a very problematic feature.<br><span class="segmentSeparator"></span>Only few IDM systems support these concepts at the level that allows practical out-of-box deployment.<br><span class="segmentSeparator"></span>Most IDM systems have some support for that, but any practical solution requires heavy customization.<br><span class="segmentSeparator"></span>It is not clear why IDM vendors do not pay attention to features that are required for almost any IDM deployment.<br><span class="segmentSeparator"></span>Therefore when it comes to a comprehensive IDM solution there is one crucial advice that we could give: choose the IDM product wisely.</p>
</div>
</div>
<div class="sect2">
<h3 id="_everybody_needs_identity_management">Everybody Needs Identity Management</h3>
<div class="paragraph">
<p>Such a title may look like a huge exaggeration.<br><span class="segmentSeparator"></span>But it fact it is very close to the truth.<br><span class="segmentSeparator"></span>Every non-trivial system has a need for identity management, even though the system owners may not realize that.<br><span class="segmentSeparator"></span>As you are reading this book, chances are that you are one of the few people that can see the need.<br><span class="segmentSeparator"></span>In that case it is all mostly about costs/benefits calculation.<br><span class="segmentSeparator"></span>Identity management has some inherent complexity.<br><span class="segmentSeparator"></span>While even very small systems need IDM, the benefits are likely to be too small to justify the costs.<br><span class="segmentSeparator"></span>The cost/benefit ratio is much better for mid-size.<br><span class="segmentSeparator"></span>And IDM is an absolute necessity for large-scale systems.<br><span class="segmentSeparator"></span>There seems be a rule of thumb that has quite broad applicability:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Number of users</th>
<th class="tableblock halign-left valign-top">Recommendation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Less than 200</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">You may need IDM, but the benefits are probably too small to justify the costs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">200 – 2 000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">You need IDM and the benefits may be just enough to justify the costs.<br><span class="segmentSeparator"></span>But you still need to look for a very cost-efficient solution.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2 000 – 20 000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">You really need IDM.<br><span class="segmentSeparator"></span>You simply cannot manage that crowd manually.<br><span class="segmentSeparator"></span>If you implement IDM properly the benefits will be much higher than the costs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">More than 20 000</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">I can’t believe that you do not have any IDM yet.<br><span class="segmentSeparator"></span>Go and get one.<br><span class="segmentSeparator"></span>Right now.<br><span class="segmentSeparator"></span>You can thank me later.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_identity_governance_and_compliance">Identity Governance and Compliance</h3>
<div class="paragraph">
<p><em>Identity governance</em> is basically an identity management taken to a higher business level.<br><span class="segmentSeparator"></span>The identity management proper is focused mainly on technical aspects of identity life-cycle such as automatic provisioning, synchronization, evaluation of the roles and computing attributes.<br><span class="segmentSeparator"></span>On the other hand, identity governance abstracts from the technical details and it is focused on policies, roles, business rules, processes and data analysis.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>a governance system may deal with segregation of duties policy.<br><span class="segmentSeparator"></span>It may drive the process of access re-certification.<br><span class="segmentSeparator"></span>It may focus on automatic analysis and reporting of the identity, auditing and policy data.<br><span class="segmentSeparator"></span>It will drive remediation processes to address policy violations.<br><span class="segmentSeparator"></span>It will manage application of new and changed policies, evaluate how is your system compliant with policies and regulations and so on.<br><span class="segmentSeparator"></span>This field is sometimes referred to as <em>governance, risk management and compliance</em> (GRC).</p>
</div>
<div class="paragraph">
<p>Almost all IDM systems will need at least some governance features to be of any use in practical deployments.<br><span class="segmentSeparator"></span>And many governance features are just refinement of concepts that originated in the IDM field many years ago.<br><span class="segmentSeparator"></span>Therefore the boundary between identity management and identity governance is quite fuzzy.<br><span class="segmentSeparator"></span>The boundary is so fuzzy that new terms were invented for the unified field that includes the identity management proper together with identity governance.<br><span class="segmentSeparator"></span><em>Identity governance and administration</em> (IGA) is one of these terms.<br><span class="segmentSeparator"></span>This field (or sub-field) is still quite young, therefore it is expected that the terminology and even the concepts need some time to settle down.<br><span class="segmentSeparator"></span>For us the governance is just a natural continuation of identity management evolution.</p>
</div>
<div class="paragraph">
<p>However, it seems to be a common practice that identity governance features are implemented by specialized products that are separated from their underlying IDM platforms.<br><span class="segmentSeparator"></span>Almost all commercial IDM and governance solutions are divided into (at least) two products.<br><span class="segmentSeparator"></span>This strategy obviously brings new revenue streams for the vendors.<br><span class="segmentSeparator"></span>But it makes almost no sense at all from customer point of view.<br><span class="segmentSeparator"></span>The industry has even coined a term <em>closed-loop remediation</em> (CLR) which in fact means that the governance system is somehow integrated with the underlying IDM solution.<br><span class="segmentSeparator"></span>Industry sometimes has a need for inventing fancy marketing terms for something that should be natural part of any reasonable solution.<br><span class="segmentSeparator"></span>It perhaps comes without saying that reasonable IDM solutions should offer both the IDM and governance features in one unified and well aligned product.</p>
</div>
<div class="paragraph">
<p>Below is a list of features that belong to the governance/compliance category.<br><span class="segmentSeparator"></span>As the boundary of governance is so fuzzy, there are also features that are just related to governance.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Delegated administration.</strong> Basic IDM deployments are usually based on the idea of an omnipotent system administrator that can do almost anything.<br><span class="segmentSeparator"></span>And then there are end users that can do almost nothing.<br><span class="segmentSeparator"></span>While this concept may work in small and simple deployments, it is not sufficient for larger systems.<br><span class="segmentSeparator"></span>Large organizations usually need to delegate some of the administration privileges to other users.<br><span class="segmentSeparator"></span>There may be HR personnel, people that are responsible for management of their organizational units, administrator responsible for a particular group of systems and so on.</p>
</li>
<li>
<p><strong>Deputies.</strong> Delegated administration is very useful, but it is quite static.<br><span class="segmentSeparator"></span>It is given by policies that are not entirely easy to change.<br><span class="segmentSeparator"></span>But there is often a need for ad-hoc delegation, such as a temporary delegation of privileges during manager’s vacation.<br><span class="segmentSeparator"></span>Such manager could nominate a deputy that should receive parts of manager’s privileges.<br><span class="segmentSeparator"></span>This is all done on an ad-hoc basis, initiated by an explicit action of the manager.</p>
</li>
<li>
<p><strong>RBAC-related policies</strong>, such as Segregation of Duties (SoD) policy.<br><span class="segmentSeparator"></span>Simply speaking SoD policy ensures that conflicting duties cannot be accumulated with a single person.<br><span class="segmentSeparator"></span>This is usually implemented by using a role exclusion mechanisms.<br><span class="segmentSeparator"></span>However, it may go deeper.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>it may be required that each request is approved by at least two people.</p>
</li>
<li>
<p><strong>Policies related to organizational structure.</strong> Organizational structure may look like a simple harmless tree, but in reality it is far from being simple or harmless.<br><span class="segmentSeparator"></span>In theory the organizational structure should be managed by business or operations departments such as HR.<br><span class="segmentSeparator"></span>But the reality is often quite different.<br><span class="segmentSeparator"></span>Business departments lack the tools and processes to efficiently manage organizational structure.<br><span class="segmentSeparator"></span>Therefore it is often an IDM system that assumes the responsibility for organizational structure management.<br><span class="segmentSeparator"></span>In such cases there is a need to police the organizational structure.<br><span class="segmentSeparator"></span>For example there may be policies that mandate a single manager for each department.<br><span class="segmentSeparator"></span>In that case the IDM system may need to handle situations that there is no manager or too many managers.</p>
</li>
<li>
<p><strong>Dynamic approval schemes.</strong> Approval processes are usually considered to be part of basic identity management functionality.<br><span class="segmentSeparator"></span>Those are usually implemented by some kind of general-purpose workflow engine.<br><span class="segmentSeparator"></span>However, this is often a source of maintenance problems, especially in deployments that are focused on identity governance functionality.<br><span class="segmentSeparator"></span>In such cases the approval processes are no longer simple quasi-linear workflows.<br><span class="segmentSeparator"></span>Approval processes tend to be very dynamic and their nature is determined by the polices.<br><span class="segmentSeparator"></span>Workflow engines have a very hard time coping with such a dynamic situation.<br><span class="segmentSeparator"></span>IDM system that implement special-purpose policy-based approval engines provide much better solutions.</p>
</li>
<li>
<p><strong>Entitlement management</strong> is mostly and identity management thing.<br><span class="segmentSeparator"></span>It deals with entitlements of user’s accounts in target systems such as role or group membership.<br><span class="segmentSeparator"></span>However, this process can go both ways.<br><span class="segmentSeparator"></span>Governance systems may provide a “entitlement discovery” features that take entitlements as inputs.<br><span class="segmentSeparator"></span>This can be used evaluate compliance and policy violations, but it may also be a valuable input for role engineering.</p>
</li>
<li>
<p><strong>Role mining.</strong> IDM systems are seldom deployed on a green field.<br><span class="segmentSeparator"></span>In the common case there are existing systems in place, there are application roles, entitlements and privileges.<br><span class="segmentSeparator"></span>It is not an easy job to create IDM roles that map to this environment.<br><span class="segmentSeparator"></span>This is usually a slow and tedious process.<br><span class="segmentSeparator"></span>However, IDM system can retrieve all the existing information and use it to propose role structure.<br><span class="segmentSeparator"></span>This is not a fully deterministic process, it requires a lot of user interaction, tuning and it is often based on a machine learning capabilities.<br><span class="segmentSeparator"></span>It is not a replacement for role engineering expertise.<br><span class="segmentSeparator"></span>However, machine-assisted role mining can significantly speed up the process.</p>
</li>
<li>
<p><strong>Re-certification campaigns.</strong> Assignment of roles is often an easy task.<br><span class="segmentSeparator"></span>Request a role, role goes through an approval process and the role is assigned.<br><span class="segmentSeparator"></span>And then everybody forgets about it.<br><span class="segmentSeparator"></span>There is a significant incentive to request assignment of a new role.<br><span class="segmentSeparator"></span>But there is almost no incentive to request unassignment of a role that is no longer needed.<br><span class="segmentSeparator"></span>This leads to a accumulation of privileges over time.<br><span class="segmentSeparator"></span>And such accumulation may reach dangerous levels for employees with long and rich job transfer history.<br><span class="segmentSeparator"></span>Therefore there are re-certification campaigns that are also known as “certification”, “access certification” or “attestation” mechanisms.<br><span class="segmentSeparator"></span>The goal of those campaign is to confirm (“certify” or “testify”) that the user still needs the privileges that were assigned previously.<br><span class="segmentSeparator"></span>Re-certification campaigns are designed to be conducted on a large number of users in a very efficient manner.<br><span class="segmentSeparator"></span>Therefore there are special processes and a very specific user interface is provided to conduct such campaigns.</p>
</li>
<li>
<p><strong>Role governance</strong> is usually quite a complex matter.<br><span class="segmentSeparator"></span>Typical IDM deployments will have a large number of roles.<br><span class="segmentSeparator"></span>It is quite hard to define those roles in the first place.<br><span class="segmentSeparator"></span>But then it is even harder to maintain them.<br><span class="segmentSeparator"></span>Environment is changing all the time, therefore the roles have to change as well.<br><span class="segmentSeparator"></span>It is usually beyond the powers of a single administrator to do so.<br><span class="segmentSeparator"></span>Therefore many role owners are usually nominated to take care of role maintenance.<br><span class="segmentSeparator"></span>Roles are often grouped into applications, categories, catalogs or functional areas.<br><span class="segmentSeparator"></span>The IDM system must make sure that the owners have the right privileges to do their job.<br><span class="segmentSeparator"></span>The IDM system should also take care that each role has at least one owner, that role definitions are periodically reviewed and so on.</p>
</li>
<li>
<p><strong>Role lifecycle management</strong> is a dynamic part of role governance.<br><span class="segmentSeparator"></span>Role changes are likely to have a serious impact on overall security of the system.<br><span class="segmentSeparator"></span>Therefore it may not be desirable to simply delegate role management duties.<br><span class="segmentSeparator"></span>It may be much more sensible to require that role changes has to be approved before being applied.<br><span class="segmentSeparator"></span>New roles are also created all the time and old roles are decommissioned.<br><span class="segmentSeparator"></span>The IDM system may need to make sure that a decommissioned role is not assigned to any new user.<br><span class="segmentSeparator"></span>But such role may still be needed in the system during a phase-out period.</p>
</li>
<li>
<p><strong>Role modeling.</strong> A change of a single role often does not make much sense just by itself.<br><span class="segmentSeparator"></span>The roles are usually designed in such a way that a set of roles works together and forms a role model.<br><span class="segmentSeparator"></span>Therefore approval of each individual role change may be too annoying and even harmful.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>there may be an inconsistent situation in case that one change is approved and another is rejected.<br><span class="segmentSeparator"></span>Therefore roles and policies are grouped into models, the models are reviewed, versioned and applied in their entirety.</p>
</li>
<li>
<p><strong>Simulation.</strong> IDM deployments tend to be complex.<br><span class="segmentSeparator"></span>There are many relations, interactions and policies.<br><span class="segmentSeparator"></span>It is no easy task to predict the effects of a change in a role, policy or organizational structure.<br><span class="segmentSeparator"></span>Therefore some IDM systems provide a simulation features that provide predictions and impact analyses of planed changes.</p>
</li>
<li>
<p><strong>Compliance policies</strong>, reporting and management.<br><span class="segmentSeparator"></span>Policies in the identity management world are usually designed to be strictly enforced.<br><span class="segmentSeparator"></span>This works fine for fundamental policies that are part of simple IDM deployments.<br><span class="segmentSeparator"></span>However, the big problem is how to apply new policies - especially policies that are mandated by regulations, recommendations and best practices.<br><span class="segmentSeparator"></span>In such cases it is almost certain that significant part of your organization will not be compliant with such new policy.<br><span class="segmentSeparator"></span>Applying the policy and immediately enforcing it is likely to cause a major business disruption.<br><span class="segmentSeparator"></span>However, it is almost impossible to prepare for new policies and to mitigate their impact without knowing which users and roles are affected.<br><span class="segmentSeparator"></span>Therefore the policies are usually applied, but they are not enforced yet.<br><span class="segmentSeparator"></span>The policies are used to evaluate the compliance impact.<br><span class="segmentSeparator"></span>Compliance reports can be used to find the users that are affected by the policy in order to remedy the situation.<br><span class="segmentSeparator"></span>Compliance reports may also be used to track the extent and progress of compliance.</p>
</li>
<li>
<p><strong>Remediation.</strong> Good IDM deployments strive for automation.<br><span class="segmentSeparator"></span>All the processes and actions that can be automated are automated.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>if a role is unassigned and user does no longer needs an account, such account is automatically deleted or disabled.<br><span class="segmentSeparator"></span>However, there are actions that cannot be automated because they require decision of a living and thinking human being.<br><span class="segmentSeparator"></span>Approvals are one example of such processes.<br><span class="segmentSeparator"></span>However, there are more situations like that.<br><span class="segmentSeparator"></span>And many of those require more initiative than a simple yes/no decision.<br><span class="segmentSeparator"></span>One such example is organizational structure management.<br><span class="segmentSeparator"></span>There is usually a rule that each department must have a manager.<br><span class="segmentSeparator"></span>But what should IDM system do in case that a department manager is fired?<br><span class="segmentSeparator"></span>IDM system cannot stop that operation, as there are certainly good reasons to revoke all privileges of that manager.<br><span class="segmentSeparator"></span>Therefore the result is that there is now a department without a manager.<br><span class="segmentSeparator"></span>And the IDM system itself cannot do anything about that.<br><span class="segmentSeparator"></span>That is where remediation comes to the rescue.<br><span class="segmentSeparator"></span>Remediation process is started after the operation.<br><span class="segmentSeparator"></span>The remediation process will ask responsible person to nominate a new manager for the department.<br><span class="segmentSeparator"></span>There may be a broad variety of remediation processes.<br><span class="segmentSeparator"></span>Simple process will ask for yes/no decisions or may ask to nominate a users.<br><span class="segmentSeparator"></span>But there are often a generic processes that apply to completely unexpected situations.</p>
</li>
<li>
<p><strong>Risk management automation.</strong>
Information security is not a project, it is a process.<br><span class="segmentSeparator"></span>It starts with risk analysis, planning, actions and then it goes back to analysis and planning and actions and so on and so on for ever and ever.<br><span class="segmentSeparator"></span>Risk analysis is the part that takes a huge amount of time and effort - especially when it comes to analysis of insider threat as there is usually a lot of insiders to analyze.<br><span class="segmentSeparator"></span>However, an IDM system can help to reduce the risk analysis effort.<br><span class="segmentSeparator"></span>Each role assigned to a user is a risk.<br><span class="segmentSeparator"></span>If roles are marked with relative risk levels, IDM system can compute the accumulation of risk for each user.<br><span class="segmentSeparator"></span>As each role gives access to a particular set of assets, the IDM system may provide data to evaluate asset exposure to users.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_complete_identity_and_access_management_solution">Complete Identity and Access Management Solution</h3>
<div class="paragraph">
<p>A comprehensive Identity and Access Management solution cannot be built by using just a single component.<br><span class="segmentSeparator"></span>There is no single product or solution that will provide all the necessary features.<br><span class="segmentSeparator"></span>And as the requirements are so complex and often even contradictory it is very unlikely that there ever will be any single product that can do it all.</p>
</div>
<div class="paragraph">
<p>A clever combination of several components is needed to build complete solution.<br><span class="segmentSeparator"></span>The right mix of ingredients for this IAM soup will always be slightly different as no two IAM solutions are the same.<br><span class="segmentSeparator"></span>But there are three basic components that are required for any practical IAM deployment:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Directory service</strong> or a similar identity store is the first component.<br><span class="segmentSeparator"></span>This is the database that stores user account information.<br><span class="segmentSeparator"></span>The accounts are stored there in a “clean” form that can be used by other applications.<br><span class="segmentSeparator"></span>And this database is indeed widely shared by applications that are capable to connect to it.<br><span class="segmentSeparator"></span>This part of the solution is usually implemented as a replicated LDAP server topology or Active Directory domain.<br><span class="segmentSeparator"></span>This has an advantage of relatively low cost and high availability.<br><span class="segmentSeparator"></span>And especially the LDAP sever topologies can usually scale ad nauseam.<br><span class="segmentSeparator"></span>But there is one major limitation: the data model needs to be simple.<br><span class="segmentSeparator"></span>Very simple.<br><span class="segmentSeparator"></span>And the identity store needs to be properly managed.</p>
</li>
<li>
<p><strong>Access Management</strong> is a second major component of the solution.<br><span class="segmentSeparator"></span>It takes care of authentication and (partially) authorization.<br><span class="segmentSeparator"></span>Access management unifies authentication mechanisms.<br><span class="segmentSeparator"></span>If an authentication mechanism is implemented in the access management server then all integrated applications can easily benefit.<br><span class="segmentSeparator"></span>It also provides Single Sign-On (SSO), centralizes access logs and so on.<br><span class="segmentSeparator"></span>It is very useful component.<br><span class="segmentSeparator"></span>But of course, there are limitations.<br><span class="segmentSeparator"></span>AM system needs access to identity data.<br><span class="segmentSeparator"></span>Therefore it needs reliable, very scalable and absolutely consistent identity database as a back-end.<br><span class="segmentSeparator"></span>This is usually provided by the directory service.<br><span class="segmentSeparator"></span>Performance and availability are the obvious obstacles here.<br><span class="segmentSeparator"></span>But there is one more obstacle which is less obvious but every bit as important: data quality.<br><span class="segmentSeparator"></span>The data in the directory service must be up to date and properly managed.<br><span class="segmentSeparator"></span>But that is only part of the picture.<br><span class="segmentSeparator"></span>As most applications store some pieces of identity data locally, these data also need to be synchronized with the directory database.<br><span class="segmentSeparator"></span>No access management system can do this well enough.<br><span class="segmentSeparator"></span>And there is no point for AM to do it at all.<br><span class="segmentSeparator"></span>The AM system has a very different architectural responsibilities.<br><span class="segmentSeparator"></span>Therefore yet another component is needed.</p>
</li>
<li>
<p><strong>Identity Management</strong> is the last but in many ways the most important component.<br><span class="segmentSeparator"></span>This is the real brain of the whole solution.<br><span class="segmentSeparator"></span>The IDM system maintains the data.<br><span class="segmentSeparator"></span>It is the component that keeps the entire system from falling apart.<br><span class="segmentSeparator"></span>It makes sure that the data are up to date and compliant with the policies.<br><span class="segmentSeparator"></span>It synchronizes all the pieces of identity data that those pesky little applications always keep creating.<br><span class="segmentSeparator"></span>It maintains groups, privileges, roles, organizational structures and all the other things necessary for the directory and the access management to work properly.<br><span class="segmentSeparator"></span>It maintains order in the system.<br><span class="segmentSeparator"></span>And it allows living and breathing system administrators and security officers to live happily, to breath easily and to keep control over the whole solution.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following diagram shows how all these components fit together.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/01-15-iam-arch.png" alt="IAM architecture">
</div>
</div>
<div class="paragraph">
<p>This is truly a composite solution.<br><span class="segmentSeparator"></span>There are several components that have vastly different features and characteristics.<br><span class="segmentSeparator"></span>But when bound together into one solution, the result is something that is much more than just a sum of its part.<br><span class="segmentSeparator"></span>The components support each other.<br><span class="segmentSeparator"></span>The solution cannot be complete unless all three components are in place.</p>
</div>
<div class="paragraph">
<p>However, building a complete solution may be quite expensive and it may take a long time.<br><span class="segmentSeparator"></span>You have to start somewhere.<br><span class="segmentSeparator"></span>But if you have resources for just one product then choose identity management.<br><span class="segmentSeparator"></span>IDM is a good start.<br><span class="segmentSeparator"></span>It is not that expensive as access management.<br><span class="segmentSeparator"></span>And IDM brings good value even quite early in the IAM program.<br><span class="segmentSeparator"></span>Especially the second generation IDM systems are very good at repaying the investment.<br><span class="segmentSeparator"></span>Going for open source product will also keep the initial investment down.<br><span class="segmentSeparator"></span>Staring with IDM is usually the best choice to start the IAM program.</p>
</div>
</div>
<div class="sect2">
<h3 id="_iam_and_security">IAM and Security</h3>
<div class="paragraph">
<p>Strictly speaking, Identity and Access Management (IAM) does not entirely fit into the information security field.<br><span class="segmentSeparator"></span>The IAM goes far beyond information security.<br><span class="segmentSeparator"></span>IAM can bring user comfort, reduce operation costs, speed up processes and generally improve the efficiency of the organization.<br><span class="segmentSeparator"></span>This is not what information security is concerned with.<br><span class="segmentSeparator"></span>But even though IAM is not strictly part of information security there is still a huge overlap.<br><span class="segmentSeparator"></span>IAM deals with authentication, authorization, auditing, role management and governance of objects that are directly related to the information security.<br><span class="segmentSeparator"></span>Therefore IAM and information security have an intimate and very complicated relationship.</p>
</div>
<div class="paragraph">
<p>It is perhaps not too bold to say that the IAM is a pre-requisite to good information security.<br><span class="segmentSeparator"></span>Especially the identity management (IDM) part is absolutely critical - even though this may not be that obvious at the first sight.<br><span class="segmentSeparator"></span>But the evidence speaks clearly.<br><span class="segmentSeparator"></span>Security studies quite consistency rate the insider threat as one of the most severe threats for an organization.<br><span class="segmentSeparator"></span>However, there is not much that the technical countermeasures can do about the insider threat.<br><span class="segmentSeparator"></span>The employee, contractor, partner, serviceman - they all are getting the access rights to your systems easily and legally.<br><span class="segmentSeparator"></span>They will legally pass through even the strongest encryption and authentication because they have got the keys.<br><span class="segmentSeparator"></span>Firewalls and VPNs will not stop them because those people are meant to pass through them to do their jobs.</p>
</div>
<div class="paragraph">
<p>Vulnerabilities are there, obviously.<br><span class="segmentSeparator"></span>And with the population of thousands of users there is a good change that there is also an attacker.<br><span class="segmentSeparator"></span>Maybe one particular engineer was fired yesterday.<br><span class="segmentSeparator"></span>But he still has VPN access and administration rights to the servers.<br><span class="segmentSeparator"></span>And as he might not be entirely happy about the way how he has been treated the chances are he might be quite inclined to make your life a bit harder.<br><span class="segmentSeparator"></span>Maybe leaking some of the company records would do the trick.<br><span class="segmentSeparator"></span>Now we have a motivated attacker who will not be stopped by any countermeasures and who can easily access the assets.<br><span class="segmentSeparator"></span>Any security officer can predict the result without a need for a comprehensive risk analysis.</p>
</div>
<div class="paragraph">
<p>Information security has no clear answers to the insider threat.<br><span class="segmentSeparator"></span>And this is no easy issue to solve as there is obviously a major security trade-off.<br><span class="segmentSeparator"></span>The business wants users to access the assets easily to do their jobs.<br><span class="segmentSeparator"></span>To keep the wheels of an organization turning.<br><span class="segmentSeparator"></span>But security needs to protect the assets from the very same users.<br><span class="segmentSeparator"></span>And there is no silver bullet to solve this issue.<br><span class="segmentSeparator"></span>However there is a couple of things that can be done to improve the situation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Record who has access to what.</strong> Each user has accounts in many applications through the enterprise.<br><span class="segmentSeparator"></span>Keep track which account belongs to which user.<br><span class="segmentSeparator"></span>It is very difficult to do that manually.<br><span class="segmentSeparator"></span>But even the worst IDM system can do that.</p>
</li>
<li>
<p><strong>Remove access quickly.</strong> If there is a security incident then the access rights need to be removed in order of seconds.<br><span class="segmentSeparator"></span>If an employee is fired then the accounts have to be disabled in order of minutes.<br><span class="segmentSeparator"></span>It is not a problem for a system administrator to do that manually.<br><span class="segmentSeparator"></span>But will the administrator be available during a security incident late in the night?<br><span class="segmentSeparator"></span>Would you synchronize layoffs with the work time of system administrators?<br><span class="segmentSeparator"></span>Wouldn’t system administrators forget to stop all the processes and background jobs that the user might have left behind?<br><span class="segmentSeparator"></span>IDM system can do that easily.<br><span class="segmentSeparator"></span>Security staff can simply disable all the accounts by using IDM system.<br><span class="segmentSeparator"></span>Single click is all that is needed.</p>
</li>
<li>
<p><strong>Enforce policies.</strong> Keep track about the privileges that were assigned to users.<br><span class="segmentSeparator"></span>This usually means managing assignment of roles (and other entitlements) to users.<br><span class="segmentSeparator"></span>Make sure that the assignment of sensitive roles is approved before user gets the privileges.<br><span class="segmentSeparator"></span>Compare the policies and the reality.<br><span class="segmentSeparator"></span>System administrators that create accounts and assign entitlements are not robots.<br><span class="segmentSeparator"></span>Mistakes can happen.<br><span class="segmentSeparator"></span>Make sure the mistakes are discovered and remediated.<br><span class="segmentSeparator"></span>This is the natural best practice.<br><span class="segmentSeparator"></span>But it is almost impossible to do manually.<br><span class="segmentSeparator"></span>Yet even an average IDM system can do that without any problems.</p>
</li>
<li>
<p><strong>Remove unnecessary roles.</strong> Role assignments and entitlements tend to accumulate over time.<br><span class="segmentSeparator"></span>Long-time employees often have access to almost any asset simply because they needed the data at some point in their career.<br><span class="segmentSeparator"></span>And the access to the asset was never removed since.<br><span class="segmentSeparator"></span>This is a huge security risk.<br><span class="segmentSeparator"></span>It can be mitigated by inventing a paper-based process to review the entitlements.<br><span class="segmentSeparator"></span>But that process is very slow, costly, error-prone and it has to be repeated in regular intervals.<br><span class="segmentSeparator"></span>But advanced IDM systems already support automation of this re-certification process.</p>
</li>
<li>
<p><strong>Maintain order.</strong> If you closely follow the principle of least privilege then you have probably realized that you have more roles that you have users.<br><span class="segmentSeparator"></span>Roles are abstract concepts and they are constantly evolving.<br><span class="segmentSeparator"></span>Even experienced security professionals can easily get lost in the role hierarchies and structures.<br><span class="segmentSeparator"></span>The ordinary end users often have absolutely no idea what roles they need.<br><span class="segmentSeparator"></span>Yet, it is not that hard to sort the roles to categories if you maintain them in a good IDM system.<br><span class="segmentSeparator"></span>This creates a role catalog that is much easier to understand, use and maintain.</p>
</li>
<li>
<p><strong>Keep track.</strong> Keep an audit record about any privilege change.<br><span class="segmentSeparator"></span>This means keeping track of all new accounts, account modifications, deletions, user and account renames, role assignments and unassignments, approvals, role definition changes, policy changes and so on.<br><span class="segmentSeparator"></span>This is a huge task to do manually.<br><span class="segmentSeparator"></span>And it is almost impossible to avoid mistakes.<br><span class="segmentSeparator"></span>But a machine can do that easily and reliably.</p>
</li>
<li>
<p><strong>Scan for vulnerabilities.</strong> Mistakes happen.<br><span class="segmentSeparator"></span>System administrators often create testing accounts for troubleshooting purposes.<br><span class="segmentSeparator"></span>And there is a old tradition to set trivial passwords to such accounts.<br><span class="segmentSeparator"></span>These accounts are not always cleaned up after the troubleshooting is done.<br><span class="segmentSeparator"></span>And there may be worse mistakes.<br><span class="segmentSeparator"></span>System administrators may assign privileges to a wrong user.<br><span class="segmentSeparator"></span>Help desk may enable account that should be permanently disabled.<br><span class="segmentSeparator"></span>Therefore all the applications have to be permanently scanned for accounts that should not be there and for entitlements that should not be assigned.<br><span class="segmentSeparator"></span>This is simply too much work to be done manually.<br><span class="segmentSeparator"></span>It is not really feasible unless a machine can scan all the system automatically.<br><span class="segmentSeparator"></span>This is called reconciliation and it is one of the basic functionalities of any decent IDM system.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Theoretically all of these things can be done manually.<br><span class="segmentSeparator"></span>But it is not feasible in practice.<br><span class="segmentSeparator"></span>The reality is that information security seriously suffers - unless there is and IDM system that brings automation and visibility.<br><span class="segmentSeparator"></span>Good information security without an IDM system is hardly possible.</p>
</div>
</div>
<div class="sect2">
<h3 id="_building_identity_and_access_management_solution">Building Identity and Access Management Solution</h3>
<div class="paragraph">
<p>There is no single identity and access management solution that would suit everybody.<br><span class="segmentSeparator"></span>Every deployment has specific needs and characteristics.<br><span class="segmentSeparator"></span>Deployment in a big bank will probably focus on governance, role management and security.<br><span class="segmentSeparator"></span>Deployment in small enterprise will focus on cost efficiency.<br><span class="segmentSeparator"></span>Cloud provider will focus on scalability, user experience and comfort.<br><span class="segmentSeparator"></span>Simply speaking one size does not fit all.<br><span class="segmentSeparator"></span>Almost all IAM solutions use the same principal components.<br><span class="segmentSeparator"></span>But product choice and configuration will significantly vary.<br><span class="segmentSeparator"></span>Do not expect that you download a product, install it and that it will solve all your problems.<br><span class="segmentSeparator"></span>It won’t.<br><span class="segmentSeparator"></span>Customization is the key.</p>
</div>
<div class="paragraph">
<p>We consider identity management to be heart and brain of any IAM solution.<br><span class="segmentSeparator"></span>This is one of the reasons why we have started midPoint project.<br><span class="segmentSeparator"></span>The rest of this book will focus almost exclusively on identity management and the use of midPoint as the IDM component.<br><span class="segmentSeparator"></span>This is the place where theory ends and practice begins.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="02-midpoint-overview">2.<br><span class="segmentSeparator"></span>MidPoint Overview</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
Chaos was the law of nature; Order was the dream of man.<br><span class="segmentSeparator"></span></blockquote>
<div class="attribution">
— Henry Adams
</div>
</div>
<div class="paragraph">
<p>MidPoint is an open source identity management (IDM) and identity governance system.<br><span class="segmentSeparator"></span>It is a very rich and sophisticated system that provides many advanced features.<br><span class="segmentSeparator"></span>MidPoint is maintained by Evolveum – a company dedicated to open source development.<br><span class="segmentSeparator"></span>All midPoint core developers work for Evolveum.<br><span class="segmentSeparator"></span>However, there are also partners and other engineers that are contributing to midPoint development.</p>
</div>
<div class="paragraph">
<p>MidPoint is a second-generation IDM system.<br><span class="segmentSeparator"></span>There are few veterans in midPoint development team that deployed first-generation IDM systems since early 2000s.<br><span class="segmentSeparator"></span>That was not always a pleasant experience.<br><span class="segmentSeparator"></span>Therefore in 2011 we started midPoint project to correct the mistakes of early IDM systems.<br><span class="segmentSeparator"></span>One of the main differences between midPoint and other IDM systems is that midPoint is designed and implemented with one primary goal in mind: to be practical.<br><span class="segmentSeparator"></span>We had been dealing (and struggling) with first-generation IDM systems in the past and we do not want to live through that experience again.<br><span class="segmentSeparator"></span>Therefore practicality goes very deep into the very foundations of midPoint.<br><span class="segmentSeparator"></span>To be more concrete, practicality means:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Things that are simple or used often should be easy to configure.<br><span class="segmentSeparator"></span>Propagation of changed password, user enable/disable, account synchronization – these should be as easy as possible.<br><span class="segmentSeparator"></span>As simple as flicking a switch or setting few configuration properties.</p>
</li>
<li>
<p>Things that are more complex or used less frequently may be a bit harder.<br><span class="segmentSeparator"></span>Such as editing XML or JSON file or writing few lines of Groovy or Python script.</p>
</li>
<li>
<p>Things that are very complex or very unusual should be still possible.<br><span class="segmentSeparator"></span>However these might not be easy.<br><span class="segmentSeparator"></span>It may require longer scripts or implementing some Java classes.<br><span class="segmentSeparator"></span>It may require forking and modifying the source code.<br><span class="segmentSeparator"></span>But it must be possible to do almost anything.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This means that simple solutions which do not deviate from the usual requirements will be easy to implement.<br><span class="segmentSeparator"></span>Most IAM programs start like this.<br><span class="segmentSeparator"></span>This approach allows to gain the benefits very early in the project.<br><span class="segmentSeparator"></span>The effort grows as the requirements are getting more complex and more unusual.<br><span class="segmentSeparator"></span>But the effort is still much lower than implementing everything from scratch.<br><span class="segmentSeparator"></span>And there is always an option to stop the project at any point where the costs are getting too high to justify the benefits.<br><span class="segmentSeparator"></span>MidPoint is an open source system.<br><span class="segmentSeparator"></span>Therefore there is no license cost that would offset the initial costs.<br><span class="segmentSeparator"></span>Even small projects are feasible with midPoint.</p>
</div>
<div class="paragraph">
<p>Simply speaking, midPoint is following the Pareto principle: 20% effort brings 80% benefits.<br><span class="segmentSeparator"></span>There are many mechanisms that support this approach.<br><span class="segmentSeparator"></span>Some are based in midPoint design, some originate from midPoint development practices and some are even supported by the Evolveum business model.<br><span class="segmentSeparator"></span>But more about that later.</p>
</div>
<div class="sect2">
<h3 id="_how_midpoint_works">How MidPoint Works</h3>
<div class="paragraph">
<p>MidPoint does what any identity management system is supposed to do: it manages identities.<br><span class="segmentSeparator"></span>The very basic functionality of midPoint is the synchronization of identity data that are stored in various applications, databases, directory servers, text files and so on.<br><span class="segmentSeparator"></span>We call all these systems <em>resources</em>.<br><span class="segmentSeparator"></span>MidPoint is using <em>connectors</em> to reach the resources.<br><span class="segmentSeparator"></span>MidPoint can propagate change that happened in one resource to other resources.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>an employee record appears in the HR system, it is picked up by midPoint, processed, transformed and then new Active Directory and CRM accounts are created.<br><span class="segmentSeparator"></span>This is the process that we call <em>synchronization</em>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/02-01-midpoint.png" alt="midPoint">
</div>
</div>
<div class="paragraph">
<p>MidPoint has a rich graphical user interface (GUI) that can be used to manage the identities.<br><span class="segmentSeparator"></span>Changes made by system administrators are automatically propagated to all affected resources.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>security officer disables a user by clicking on disable button in midPoint user interface.<br><span class="segmentSeparator"></span>Then MidPoint makes sure that all accounts that belong to the user are immediately disabled.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/02-02-midpoint-gui.png" alt="midPoint GUI">
</div>
</div>
<div class="paragraph">
<p>This is the essence of midPoint operation.<br><span class="segmentSeparator"></span>This may sound simple, but this description is extremely simplified.<br><span class="segmentSeparator"></span>The reality is much more complicated.<br><span class="segmentSeparator"></span>Most of the important things happen inside midPoint before the changes are applied to target resources.<br><span class="segmentSeparator"></span>This may look simple at the first sight, but it is not.<br><span class="segmentSeparator"></span>For each change that midPoint detects it needs to evaluate:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Roles:</strong> MidPoint computes where the user should have access.<br><span class="segmentSeparator"></span>This is usually given by the roles that the user has.<br><span class="segmentSeparator"></span>The role structure is often quite rich.<br><span class="segmentSeparator"></span>There may be hierarchical roles, parametric roles, conditional roles and a lot of other advanced mechanisms.</p>
</li>
<li>
<p><strong>Organizational structure:</strong> Users usually belong to some organizational units, projects, teams or groups.<br><span class="segmentSeparator"></span>Some of them may give additional privileges to the user.</p>
</li>
<li>
<p><strong>Status and life cycle:</strong> Accounts can be created, enabled, disabled, archived or deleted.<br><span class="segmentSeparator"></span>There are many situations that need to be processed.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>we may want to create a disabled account one week before a new employee starts his work, enable the account on his first day, disable the account on his last day and delete it three months after he leaves.</p>
</li>
<li>
<p><strong>Attributes and identifiers:</strong> Simple synchronization scenarios assume that attributes and values will be the same in all the synchronized systems.<br><span class="segmentSeparator"></span>That is a nice theory, bit it almost never works like that in real world.<br><span class="segmentSeparator"></span>Attribute names need to be translated, values need to be transformed, data types need to be converted.<br><span class="segmentSeparator"></span>This is different for each system and even for each instance of each system.<br><span class="segmentSeparator"></span>Small algorithms in form of scripting expressions are usually needed to properly transform the values.</p>
</li>
<li>
<p><strong>Credential management:</strong> Password changes need to be propagated to the resources.<br><span class="segmentSeparator"></span>Sometimes we want to synchronize password with all systems, sometimes we want just a subset of systems.<br><span class="segmentSeparator"></span>Password policies need to be evaluated, password history needs to be checked, password may need to be encoded and hashed before storage.</p>
</li>
<li>
<p><strong>Consistency:</strong> The account in the target application might have changed since midPoint has updated it.<br><span class="segmentSeparator"></span>The current change may no longer be applicable to the current state of the account.<br><span class="segmentSeparator"></span>The change that midPoint wants to make may conflict with the native change, the change may be partially applied already, the account may have attribute values that it should not have or the account may not exist at all.<br><span class="segmentSeparator"></span>MidPoint has to detect such situations are react accordingly, e.g.<br><span class="segmentSeparator"></span>by re-creating a deleted account before applying the changes.</p>
</li>
<li>
<p><strong>Approvals:</strong> MidPoint determines if any of the changes need to be approved before they are applied.<br><span class="segmentSeparator"></span>If that is the case then midPoint drives the request through an approval process.</p>
</li>
<li>
<p><strong>Notifications:</strong> MidPoint notifies the user that he can access a new account.<br><span class="segmentSeparator"></span>It notifies the administrator if something goes wrong.</p>
</li>
<li>
<p><strong>Audit:</strong> MidPoint records all the changes into an audit trail.<br><span class="segmentSeparator"></span>This can later by used by security officers or specialized analytic engines.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is a lot of things to process, evaluate and execute.<br><span class="segmentSeparator"></span>Some of these steps are quite complex.<br><span class="segmentSeparator"></span>And indeed there are many complex algorithms implemented in midPoint.<br><span class="segmentSeparator"></span>There are algorithms that evaluate complex role structures, organizational structures, temporal constraints, password policies and so on.<br><span class="segmentSeparator"></span>The only thing that is needed is to configure them properly.</p>
</div>
<div class="paragraph">
<p>However, midPoint does even more than that.<br><span class="segmentSeparator"></span>MidPoint does not only manage identities, it can also manage any object that is anyhow related to identity management.<br><span class="segmentSeparator"></span>MidPoint can manage roles, role catalogs, organizational structures, groups, projects, teams, services, devices and almost any other object.</p>
</div>
<div class="paragraph">
<p>MidPoint is also an <em>identity governance system</em>.<br><span class="segmentSeparator"></span>The job of identity management features is to make sure that the policies are consistently applied through the organization.<br><span class="segmentSeparator"></span>The governance features assist with the maintenance and evolution of those policies.<br><span class="segmentSeparator"></span>MidPoint implements access recertification process.<br><span class="segmentSeparator"></span>This is a recurring process that asks managers to confirm that the users still need the privileges that they have previously received.<br><span class="segmentSeparator"></span>MidPoint contains mechanism to sort roles into hierarchies and categories.<br><span class="segmentSeparator"></span>That is necessary to maintain order during role engineering and maintenance of role definitions.<br><span class="segmentSeparator"></span>MidPoint has mechanisms for selective enforcement of role which comes very useful during migrations and when new system is connected to midPoint.<br><span class="segmentSeparator"></span>MidPoint has support for policy lifecycle, general policy rules and so on.<br><span class="segmentSeparator"></span>And more work in that direction is planned in future midPoint versions.<br><span class="segmentSeparator"></span>We fully understand that it is not enough to simply apply the policies.<br><span class="segmentSeparator"></span>Policies are living things and they need to evolve.</p>
</div>
</div>
<div class="sect2">
<h3 id="_case_study">Case Study</h3>
<div class="paragraph">
<p>This book is about practical identity management.<br><span class="segmentSeparator"></span>Therefore we will get very close to a practice by demonstrating midPoint features using a case study.<br><span class="segmentSeparator"></span>This is a case study of a fictional company ExAmPLE, Inc.<br><span class="segmentSeparator"></span>The name stands for "Exemplary Amplified Placeholder Enterprise".<br><span class="segmentSeparator"></span>ExAmPLE is a mid-sized financial company.<br><span class="segmentSeparator"></span>Its operation heavily relies on information technologies, therefore there is a diverse set of applications and information systems ranging from legacy applications to cloud services.<br><span class="segmentSeparator"></span>As ExAmPLE has few thousand employees and there is a good potential for growth the management has decided to start an IAM program.<br><span class="segmentSeparator"></span>The first step of the program is deployment of midPoint as the identity management system.</p>
</div>
<div class="paragraph">
<p>Eric is an IT engineer at ExAmPLE.<br><span class="segmentSeparator"></span>He has taken the responsibility to install and configure midPoint.<br><span class="segmentSeparator"></span>Eric spins up a new Linux virtual machine for midPoint.<br><span class="segmentSeparator"></span>He downloads midPoint distribution package and follows the installation instructions.<br><span class="segmentSeparator"></span>Couple of minutes later midPoint instance starts up.<br><span class="segmentSeparator"></span>Eric logs in to the midPoint user interface.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/02-03-dashboard.png" alt="Dashboard">
</div>
</div>
<div class="paragraph">
<p>MidPoint instance is almost empty after fresh installation.<br><span class="segmentSeparator"></span>It contains only a couple of essential objects.<br><span class="segmentSeparator"></span>But Eric is a smart engineer.<br><span class="segmentSeparator"></span>He has already read through this book and he knows exactly what he needs to do.</p>
</div>
<div class="paragraph">
<p>First thing to do is to populate midPoint with employee data.<br><span class="segmentSeparator"></span>The primary source of ExAmPLE employee data is an HR system.<br><span class="segmentSeparator"></span>The HR system is quite big piece of software and it is not easy to connect to that system directly.<br><span class="segmentSeparator"></span>Fortunately, it is quite easy to get a text export of the employee data in comma-separated (CSV) format.<br><span class="segmentSeparator"></span>Eric plans to use this file to get employee data to midPoint.</p>
</div>
</div>
<div class="sect2">
<h3 id="_connectors_and_resources">Connectors and Resources</h3>
<div class="paragraph">
<p>MidPoint communicates with all the source and target systems by the means of connectors.<br><span class="segmentSeparator"></span>Connectors are relatively small Java components that are plugged into midPoint.<br><span class="segmentSeparator"></span>There is usually one connector for each type of the connected system.<br><span class="segmentSeparator"></span>Therefore there are connectors for LDAP servers, Active Directory, databases, UNIX operating systems and so on.<br><span class="segmentSeparator"></span>The responsibility of a connector is to translate protocols.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>LDAP connector will translate midPoint search commands to LDAP search requests.<br><span class="segmentSeparator"></span>The UNIX connector will create an SSH session and translate midPoint create command to the invocation of Linux useradd binary.<br><span class="segmentSeparator"></span>And so on.<br><span class="segmentSeparator"></span>Each connector talks using its own communication protocol on one side.<br><span class="segmentSeparator"></span>But on the other side the connectors translate the information to a common format that is understood by midPoint.</p>
</div>
<div class="paragraph">
<p>There is no distinction between source and target system when it comes to the connector.<br><span class="segmentSeparator"></span>The same connectors are used for source and target systems.<br><span class="segmentSeparator"></span>The difference is only in midPoint configuration.</p>
</div>
<div class="paragraph">
<p>The connectors are distributed as Java binaries (JAR files).<br><span class="segmentSeparator"></span>To deploy them to midPoint you just need to place them in the correct directory and restart midPoint.<br><span class="segmentSeparator"></span>MidPoint will automatically discover and examine the connectors during start-up.<br><span class="segmentSeparator"></span>A handful of frequently used connectors is bundled into midPoint distribution.<br><span class="segmentSeparator"></span>These connectors do not need to be deployed.<br><span class="segmentSeparator"></span>They are automatically available.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/02-04-connectors-resources.png" alt="Connectors and resources">
</div>
</div>
<div class="paragraph">
<p>Connector of a specific type works for all the systems that communicate by the protocol supported by connector.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>LDAP connector works for all the LDAP-compliant servers.<br><span class="segmentSeparator"></span>Connector is just a very generic piece of code.<br><span class="segmentSeparator"></span>It does not know the hostname, port or passwords that are needed to establish a connection to a particular server.<br><span class="segmentSeparator"></span>The configuration that specify connection parameters for individual server is stored in special configuration object called <em>resource</em>.<br><span class="segmentSeparator"></span>The term <em>resource</em> in midPoint terminology generally means any system which is connected to a midPoint instance.</p>
</div>
<div class="paragraph">
<p>Therefore what Eric the Engineer needs to do to get ExAmPLE employees into midPoint is to define a new resource.<br><span class="segmentSeparator"></span>This resource will represent the CSV file exported from the HR system.<br><span class="segmentSeparator"></span>MidPoint distribution contains CSV file connector already, therefore there is no need to deploy it explicitly.<br><span class="segmentSeparator"></span>All that Eric has to do is to create a new resource definition.<br><span class="segmentSeparator"></span>There are (at least) two ways how to do it.<br><span class="segmentSeparator"></span>Firstly, there is a configuration wizard in midPoint user interface.<br><span class="segmentSeparator"></span>Eric can use the wizard to configure a new resource from scratch.<br><span class="segmentSeparator"></span>But as you will see later in this book, the resource definition is quite complex and it has many configuration options.<br><span class="segmentSeparator"></span>This makes the configuration wizard very rich and it may be quite confusing for new users.<br><span class="segmentSeparator"></span>Therefore it is better for Eric to use the other approach: start from an example.<br><span class="segmentSeparator"></span>There are examples of various resource definitions in the midPoint distribution package and even more examples are available on-line.<br><span class="segmentSeparator"></span>Therefore Eric quickly locates a XML file that contains a complete example of a CSV resource.<br><span class="segmentSeparator"></span>He edits the file to change the filesystem path to his CSV file and adjusts the names of the columns to match the format of his file.<br><span class="segmentSeparator"></span>The very minimal resource configuration specifies just the resource name, connector and connector configuration.<br><span class="segmentSeparator"></span>The XML file that Eric creates looks approximately like this (simplified for clarity):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;resource</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">03c3ceea-78e2-11e6-954d-dfdfa9ace0cf</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>HR System<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;connectorRef</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">ConnectorType</span><span class="delimiter">"</span></span><span class="tag">&gt;</span> ...<span class="tag">&lt;/connectorRef&gt;</span>
    <span class="tag">&lt;connectorConfiguration&gt;</span>
        <span class="tag">&lt;configurationProperties&gt;</span>
            <span class="tag">&lt;filePath&gt;</span>/opt/midpoint/var/resources/hr.csv<span class="tag">&lt;/filePath&gt;</span>
            <span class="tag">&lt;uniqueAttribute&gt;</span>empno<span class="tag">&lt;/uniqueAttribute&gt;</span>
        <span class="tag">&lt;/configurationProperties&gt;</span>
     <span class="tag">&lt;/connectorConfiguration&gt;</span>
<span class="tag">&lt;/resource&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you are a hands-on type of an engineer you probably want to follow what Eric is doing in your own midPoint instance.<br><span class="segmentSeparator"></span>All the files that Eric is using are provided in a form of ready-to-use samples.<br><span class="segmentSeparator"></span>Please see <a href="https://docs.evolveum.com/book/practical-identity-management-with-midpoint.html#92-additional-information">Additional Information</a> chapter at the end of this book for the details.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Then Eric goes to <em>Configuration</em> section of midPoint user interface and imports the XML file into midPoint.<br><span class="segmentSeparator"></span>Import operation creates new resource definition in midPoint.<br><span class="segmentSeparator"></span>Eric now navigates to <em>Resources</em> section of the midPoint user interface.<br><span class="segmentSeparator"></span>The new CSV resource is there.<br><span class="segmentSeparator"></span>When Eric clicks on the resource name a resource details screen appears.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/02-05-resource-hr.png" alt="HR resource">
</div>
</div>
<div class="paragraph">
<p>Eric can click on the button at the bottom of the screen to test connection to the resource.<br><span class="segmentSeparator"></span>As this is a local CSV file there is no real connection.<br><span class="segmentSeparator"></span>But the test checks that the filesystem path is correct, that the file exists and that it can be opened.<br><span class="segmentSeparator"></span>The test also loads <em>resource schema</em>.<br><span class="segmentSeparator"></span>MidPoint reads the CSV file header to discover the structure of the data in the CSV file.<br><span class="segmentSeparator"></span>The resource is now prepared for use.</p>
</div>
<div class="paragraph">
<p>There is not much that Eric can do with the resource yet.<br><span class="segmentSeparator"></span>We need to explain a couple of essential midPoint concepts before moving forward with our case study.</p>
</div>
</div>
<div class="sect2">
<h3 id="_user_and_accounts">User and Accounts</h3>
<div class="paragraph">
<p>The concept of user is perhaps the most important concept in the entire IDM field.<br><span class="segmentSeparator"></span>The term <em>user</em> represents physical person: an employee, support engineer, temporary worker, student, customer, etc.<br><span class="segmentSeparator"></span>On the other hand the term <em>account</em> refers to the data structure that allows the user to access applications.<br><span class="segmentSeparator"></span>This may be an account in the operating system, LDAP entry, row in the database table and so on.<br><span class="segmentSeparator"></span>Typically, one user has many accounts – usually one account for each resource.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/02-06-user-account.png" alt="User and accounts">
</div>
</div>
<div class="paragraph">
<p>The data that represent users are stored directly in midPoint.<br><span class="segmentSeparator"></span>While the data that represent accounts are stored "on the resource side".<br><span class="segmentSeparator"></span>Which means accounts are stored in the connected applications, databases, directories and operating systems.<br><span class="segmentSeparator"></span>Accounts are not stored in midPoint.<br><span class="segmentSeparator"></span>Under normal circumstances MidPoint keeps just account identifiers and some meta-data about the accounts.<br><span class="segmentSeparator"></span>All other attributes are retrieved when needed.<br><span class="segmentSeparator"></span>MidPoint is using the connectors to fetch account data.</p>
</div>
<div class="paragraph">
<p>We will strictly distinguish the terms <em>user</em> and <em>account</em> in this book.<br><span class="segmentSeparator"></span>Such a strong distinction is also made in the midPoint user interface and documentation.<br><span class="segmentSeparator"></span>It is very helpful to get used to this terminology.</p>
</div>
<div class="paragraph">
<p>Accounts are linked to users that own the accounts.<br><span class="segmentSeparator"></span>Therefore midPoint knows which account belongs to which user.<br><span class="segmentSeparator"></span>MidPoint can list all the accounts for any user, it can synchronize the data, it can disable all the accounts of a particular user and so on.<br><span class="segmentSeparator"></span>This user-account <em>link</em> is almost always automatically established and maintained by midPoint.</p>
</div>
<div class="paragraph">
<p>MidPoint comes with a built-in data model (schema) for users.<br><span class="segmentSeparator"></span>It contains properties that are very often used to describe users such as full name, e-mail address and telephone number.<br><span class="segmentSeparator"></span>There is a reasonable set of properties that should be a good starting point for most deployments.<br><span class="segmentSeparator"></span>Of course, as most midPoint objects, the user schema can be extended with custom properties if needed.</p>
</div>
<div class="paragraph">
<p>However, there is no built-in data model for accounts.<br><span class="segmentSeparator"></span>Such data model would not be possible.<br><span class="segmentSeparator"></span>Every resource may have different account attributes.<br><span class="segmentSeparator"></span>There may be different names, different types and the values may have different meaning.<br><span class="segmentSeparator"></span>MidPoint is designed to handle those differences.<br><span class="segmentSeparator"></span>Schema for resource accounts is dynamically discovered when midPoint connects to the resource for the first time.<br><span class="segmentSeparator"></span>MidPoint interprets the schema and automatically adapts to it.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>when midPoint displays information about an account, the user interface fields are dynamically generated from the discovered schema.<br><span class="segmentSeparator"></span>MidPoint does that all by itself.<br><span class="segmentSeparator"></span>No extra configuration and no coding is necessary.</p>
</div>
<div class="paragraph">
<p><em>Account schema</em> may significantly differ from resource to resource.<br><span class="segmentSeparator"></span>Yet midPoint must be able to synchronize all the accounts from any kind of resource imaginable.<br><span class="segmentSeparator"></span>In this case the <em>user schema</em> works as a unified data model.<br><span class="segmentSeparator"></span>The schema of each account is mapped to the user schema.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/02-07-user-account-mapping.png" alt="User-account mapping">
</div>
</div>
<div class="paragraph">
<p>Getting back to our ExAmPLE story, Eric has a HR resource configured.<br><span class="segmentSeparator"></span>Therefore he can see the "accounts" that the users have in the HR system.<br><span class="segmentSeparator"></span>Eric opens the resource detail page in the midPoint GUI, cliks on <em>Accounts</em> tab and then on the <em>Resource</em> button (we’ll explain that later).<br><span class="segmentSeparator"></span>The list of accounts appears:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/02-08-resource-hr-accounts.png" alt="Resource HR accounts">
</div>
</div>
<div class="paragraph">
<p>All that can be seen in this list are just employee numbers, because employee number is set as the primary identifier for the HR system.<br><span class="segmentSeparator"></span>Clicking on the link will display more details.<br><span class="segmentSeparator"></span>In fact these are not real accounts.<br><span class="segmentSeparator"></span>These are lines in the CSV file exported from the HR database.<br><span class="segmentSeparator"></span>But they describe some aspects of <em>identity</em> and therefore midPoint interprets them as accounts.<br><span class="segmentSeparator"></span>For midPoint "account" is a generic term used to describe any resource-side data structure that represents the user.</p>
</div>
</div>
<div class="sect2">
<h3 id="_initial_import">Initial Import</h3>
<div class="paragraph">
<p>The <em>user</em> is a central concept for any IDM system and midPoint is no exception.<br><span class="segmentSeparator"></span>MidPoint needs reliable information about users to work correctly it.<br><span class="segmentSeparator"></span>The HR system is usually a good source of user information.<br><span class="segmentSeparator"></span>Eric needs to get that information from the HR system into midPoint.<br><span class="segmentSeparator"></span>He has already set up a resource that connects to the CSV file exported from the HR system.<br><span class="segmentSeparator"></span>But the resource does not do anything by default.<br><span class="segmentSeparator"></span>It has to be configured to pull the information from the file into midPoint.<br><span class="segmentSeparator"></span>What Eric needs is a set of <em>mappings</em>.<br><span class="segmentSeparator"></span>Mapping is a mechanism for synchronization of attribute values between user and linked accounts.<br><span class="segmentSeparator"></span>In this case Eric needs <em>inbound</em> mappings to import the data.<br><span class="segmentSeparator"></span>Inbound mappings synchronize the value in the direction from the resource into midPoint.<br><span class="segmentSeparator"></span>Eric can open the resource definition in the configuration wizard in GUI and he can add the mappings there.<br><span class="segmentSeparator"></span>Or he can simply look at the configuration samples again and add the mappings in the XML form.<br><span class="segmentSeparator"></span>Inbound mapping looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;attribute&gt;</span>
        <span class="tag">&lt;ref&gt;</span>ri:firstname<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;inbound&gt;</span>
            <span class="tag">&lt;target&gt;</span>
                <span class="tag">&lt;path&gt;</span>givenName<span class="tag">&lt;/path&gt;</span>
            <span class="tag">&lt;/target&gt;</span>
        <span class="tag">&lt;/inbound&gt;</span>
   <span class="tag">&lt;/attribute&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a mapping that maps the account (HR) attribute <code>firstname</code> to user (midPoint) property <code>givenName</code>.<br><span class="segmentSeparator"></span>This tells midPoint to always update a value of user’s given name when the mapped HR attribute changes.<br><span class="segmentSeparator"></span>Eric adds similar mappings for all the attributes in the HR export file.<br><span class="segmentSeparator"></span>Eric also needs to add <em>synchronization</em> section to the resource definition.<br><span class="segmentSeparator"></span>The synchronization section instructs midPoint to create a new user for each new account.<br><span class="segmentSeparator"></span>This is exactly what Eric wants: create a user for each HR account.<br><span class="segmentSeparator"></span>Eric then re-imports the modified XML file into midPoint.</p>
</div>
<div class="paragraph">
<p>MidPoint is now ready to synchronize the attributes.<br><span class="segmentSeparator"></span>But we still need a <em>task</em> to pull all the data from the HR system.<br><span class="segmentSeparator"></span>Eric navigates to the page that shows the list of HR accounts.<br><span class="segmentSeparator"></span>At the bottom of that page there is a big <em>Import</em> button that can be used to manage the import tasks.<br><span class="segmentSeparator"></span>Eric clicks on that button and creates a new import task.<br><span class="segmentSeparator"></span>The task is started and it runs for a couple of seconds.<br><span class="segmentSeparator"></span>After the task is done Eric can look at users in midPoint:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/02-09-users.png" alt="Users">
</div>
</div>
<div class="paragraph">
<p>Eric can see details about the user by clicking on the username:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/02-10-user-details.png" alt="User details">
</div>
</div>
<div class="paragraph">
<p>This page shows all the details about the user that midPoint knows about.<br><span class="segmentSeparator"></span>The details are sorted to several tabs and we are going to explain all of that later in this book.<br><span class="segmentSeparator"></span>For now we only care about first two tabs.<br><span class="segmentSeparator"></span>The <em>Basic</em> tab shows user properties as midPoint knows them.<br><span class="segmentSeparator"></span>These properties are stored in midPoint repository.<br><span class="segmentSeparator"></span>MidPoint has quite a rich data model that can be used out-of-the-box, but the GUI only shows those properties that are actually used.<br><span class="segmentSeparator"></span>The "name", given name and family name were imported from the HR resource and that’s what the page shows.</p>
</div>
<div class="paragraph">
<p>Let’s have a look at the second tab now:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/02-11-user-projections.png" alt="User projections">
</div>
</div>
<div class="paragraph">
<p>The <em>Projections</em> tab shows user’s accounts.<br><span class="segmentSeparator"></span>Currently there is only one account and it is the HR account that was used to import the data.<br><span class="segmentSeparator"></span>Account details are displayed by clicking on account identifier:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/02-12-user-projection-hr.png" alt="User HR projection">
</div>
</div>
<div class="paragraph">
<p>The data that are displayed here are really fresh.<br><span class="segmentSeparator"></span>Account details were retrieved from the resource at the very moment that the account was displayed.<br><span class="segmentSeparator"></span>This is the difference between user data and account data: user data are kept in midPoint repository, while account data are retrieved from the resource as needed.</p>
</div>
<div class="paragraph">
<p>The user and the account are linked.<br><span class="segmentSeparator"></span>MidPoint remembers that this user originated from this specific HR account.<br><span class="segmentSeparator"></span>If the HR account is modified then the change is synchronized and applied to the user data.<br><span class="segmentSeparator"></span>The mappings are not just for the import.<br><span class="segmentSeparator"></span>They can work continually and keep the account and user data synchronized all the time.</p>
</div>
</div>
<div class="sect2">
<h3 id="_assignments_and_projections">Assignments and Projections</h3>
<div class="paragraph">
<p>The concepts of an account is all about the reality: it shows the data that are there at this very moment.<br><span class="segmentSeparator"></span>It shows what <em>is</em> there.<br><span class="segmentSeparator"></span>But identity management is all about policies.<br><span class="segmentSeparator"></span>Policies, by definition, specify what <em>should be</em> there.<br><span class="segmentSeparator"></span>Policies specify what is right.<br><span class="segmentSeparator"></span>But as every citizen knows all too well, the things that <em>are</em> and the things that <em>should be</em> do not always match perfectly.<br><span class="segmentSeparator"></span>We are no idealists.<br><span class="segmentSeparator"></span>Therefore we have designed midPoint from the day one to acknowledge that there may be a difference between reality and policy.<br><span class="segmentSeparator"></span>Primary role of midPoint is to manage that difference.<br><span class="segmentSeparator"></span>And completely align policy and reality in the long run.</p>
</div>
<div class="paragraph">
<p>This kind of thinking is easy to see in midPoint user interface.<br><span class="segmentSeparator"></span>There is <em>Projections</em> tab in the user details page.<br><span class="segmentSeparator"></span>It shows the accounts that the user has right now.<br><span class="segmentSeparator"></span>It shows the real state in which the accounts are.<br><span class="segmentSeparator"></span>It shows the reality.<br><span class="segmentSeparator"></span>And then there is <em>Assignments</em> tab.<br><span class="segmentSeparator"></span>This tab shows the policy.<br><span class="segmentSeparator"></span>This tab shows what accounts, roles, organizations, or services are assigned to the user.<br><span class="segmentSeparator"></span>This tab shows what user should have.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/02-13-assignments-empty.png" alt="Assignments">
</div>
</div>
<div class="paragraph">
<p>To demonstrate how the assignments work we need a new resource.<br><span class="segmentSeparator"></span>Therefore let Eric connect a new resource to midPoint.<br><span class="segmentSeparator"></span>This time it will be new, clean and empty LDAP server.<br><span class="segmentSeparator"></span>So Eric once again locates the proper example, modifies the configuration and imports it to midPoint.<br><span class="segmentSeparator"></span>In a while there is a new LDAP resource.<br><span class="segmentSeparator"></span>Eric wants to synchronize all the users to the LDAP server.<br><span class="segmentSeparator"></span>Therefore Eric has to define mappings once again.<br><span class="segmentSeparator"></span>But this time these will be <em>outbound</em> mappings as Eric wants to propagate data out of midPoint into the (LDAP) resource.<br><span class="segmentSeparator"></span>We will cover the details of mapping configuration later, so now let’s just see the results.<br><span class="segmentSeparator"></span>We have two resources now:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/02-14-resources.png" alt="Resources">
</div>
</div>
<div class="paragraph">
<p>But how do we create an account on that LDAP resource?<br><span class="segmentSeparator"></span>The right way to do this is to let midPoint know that a user <em>should have</em> an account on that resource.<br><span class="segmentSeparator"></span>In midPoint terminology we say, that we are <em>assigning</em> the resource to the user.<br><span class="segmentSeparator"></span>All that Eric needs to do is to navigate to user details page, click on the <em>Assignments</em> tab, use <em>New assignment</em> button to add an assignment for the LDAP resource and click <em>Save</em>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/02-15-assign-ldap.png" alt="Assign LDAP account">
</div>
</div>
<div class="paragraph">
<p>After the click on <em>Save</em> button a lot of complex things happen.<br><span class="segmentSeparator"></span>But simply speaking midPoint recomputes what the user should have and what the user has.<br><span class="segmentSeparator"></span>MidPoint detects that the user should have an LDAP account now (because there is a new assignment for it).<br><span class="segmentSeparator"></span>But no such account exists.<br><span class="segmentSeparator"></span>Therefore midPoint creates the account.</p>
</div>
<div class="paragraph">
<p>When Eric opens the user details again and navigates to the <em>Projections</em> tab he can see that there are two accounts now:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/02-16-user-projections-2.png" alt="User projections">
</div>
</div>
<div class="paragraph">
<p>There is an HR account that was used to create the user in the first place.<br><span class="segmentSeparator"></span>And there is also LDAP account that was created as a reaction to a new assignment.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/02-17-user-projection-ldap.png" alt="User LDAP projection">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Careful reader may have noticed that the two accounts have vastly different attributes.<br><span class="segmentSeparator"></span>That’s right.<br><span class="segmentSeparator"></span>Every account has a different <em>schema</em>.<br><span class="segmentSeparator"></span>MidPoint automatically discovers the schema.<br><span class="segmentSeparator"></span>Then midPoint dynamically interprets the schema to display the attributes in GUI, to validate the inputs, to check for errors in mappings and so on.<br><span class="segmentSeparator"></span>MidPoint does everything by itself without any need to write a single line of code.<br><span class="segmentSeparator"></span>MidPoint is completely based on the concept of schema and it takes full advantage of it.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>There is reality and there is policy.<br><span class="segmentSeparator"></span>There are accounts and there are assignments.<br><span class="segmentSeparator"></span>Ideally these two things should match perfectly.<br><span class="segmentSeparator"></span>And midPoint will try really hard to make them match.<br><span class="segmentSeparator"></span>But there may be exceptions.<br><span class="segmentSeparator"></span>Careful reader surely noticed that there is HR account but there is no assignment for that account.<br><span class="segmentSeparator"></span>And yet midPoint has not deleted the HR account.<br><span class="segmentSeparator"></span>That is because the HR system is what we call a "pure source" system.<br><span class="segmentSeparator"></span>MidPoint does not write to the HR, it only reads from it.<br><span class="segmentSeparator"></span>Writes to the CSV export file would be overwritten by the next export anyway, so there is no point in writing there.<br><span class="segmentSeparator"></span>Therefore the HR resource has an exception specified in its configuration: it allows the HR account to exist even if there is no assignment for it.<br><span class="segmentSeparator"></span>We can keep the HR account linked to the user by using this method.<br><span class="segmentSeparator"></span>We can see the data that were used to create the user.<br><span class="segmentSeparator"></span>This improves overall visibility and it greatly helps with diagnostics of configuration issues.</p>
</div>
</div>
<div class="sect2">
<h3 id="_roles">Roles</h3>
<div class="paragraph">
<p>It would be a daunting task if Eric had to assign every individual account for every individual resource to every user.<br><span class="segmentSeparator"></span>Typical IDM deployment has thousands of users and dozens of resources.<br><span class="segmentSeparator"></span>Such deployment would be very difficult to manage using only direct resource assignments.</p>
</div>
<div class="paragraph">
<p>But there is a better way, of course.<br><span class="segmentSeparator"></span>We can define some <em>roles</em>.<br><span class="segmentSeparator"></span>The concept of <em>role-based access control (RBAC)</em> is a well-established practice and the roles are really the bread-and-butter of identity management.<br><span class="segmentSeparator"></span>The basic idea of RBAC is to group privileges into roles.<br><span class="segmentSeparator"></span>Then the roles are assigned to the users instead of privileges.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>let’s create a <code>Webmaster</code> role.<br><span class="segmentSeparator"></span>Then put all the privileges that webmaster should have into that role.<br><span class="segmentSeparator"></span>And let’s assign the role to every user that works as a webmaster.<br><span class="segmentSeparator"></span>This simplifies the privilege management.<br><span class="segmentSeparator"></span>If there are two webmasters there is no need to think about the individual privileges that a webmaster should have.<br><span class="segmentSeparator"></span>Just assign the role and the role has everything that is needed.<br><span class="segmentSeparator"></span>It is also easy to change webmasters: unassign role from one user, assign to another user.<br><span class="segmentSeparator"></span>It is also easy if you add a new web server.<br><span class="segmentSeparator"></span>Just add the privilege for accessing new server into the <code>Webmaster</code> role.<br><span class="segmentSeparator"></span>And all webmasters will have it.</p>
</div>
<div class="paragraph">
<p>That’s the theory.<br><span class="segmentSeparator"></span>But how does it work for Eric?<br><span class="segmentSeparator"></span>First of all let’s add a handful of new resources – to get some material for the roles.<br><span class="segmentSeparator"></span>So now we have four resources: HR, LDAP, CRM and Portal.<br><span class="segmentSeparator"></span>That’s a good start.<br><span class="segmentSeparator"></span>Let’s do some role engineering now.</p>
</div>
<div class="paragraph">
<p>Many organizations have one role that almost every user has.<br><span class="segmentSeparator"></span>It is often <code>Employee</code> or <code>Staff</code> role.<br><span class="segmentSeparator"></span>This role gives access to all the systems that an employee should have access to: Windows domain login, e-mail, employee portal – things like that.<br><span class="segmentSeparator"></span>The ExAmPLE company is no exception.<br><span class="segmentSeparator"></span>In this case the basic role should create accounts in two systems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>LDAP server:</strong> many applications are connected to LDAP and use it for authentication.<br><span class="segmentSeparator"></span>We want every ExAmPLE employee to have account there.</p>
</li>
<li>
<p><strong>Portal:</strong> this is enterprise intranet portal with lots of small services essential for every employee.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is simple to create such role in midPoint user interface.<br><span class="segmentSeparator"></span>Eric navigates to <em>Roles &gt; New role</em>.<br><span class="segmentSeparator"></span>Fills in the name of the new role (<code>Employee</code>).<br><span class="segmentSeparator"></span>Then he goes to the <em>Inducements</em> tab.<br><span class="segmentSeparator"></span>This is where the role definition takes place.<br><span class="segmentSeparator"></span>Inducements are almost the same as assignments.<br><span class="segmentSeparator"></span>However, inducements do not give access to the role itself.<br><span class="segmentSeparator"></span>Inducements give access to the users that have this role.<br><span class="segmentSeparator"></span>So they are kind of indirect assignments.<br><span class="segmentSeparator"></span>Eric clicks on <em>New inducement</em> button and adds inducements for the two resources into the role:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/02-18-role-employee-inducements.png" alt="Role Employee inducements">
</div>
</div>
<div class="paragraph">
<p>Eric clicks on <em>Save</em> button and the new role is created.<br><span class="segmentSeparator"></span>Now it is ready to be assigned to the users.<br><span class="segmentSeparator"></span>Eric goes on and assigns <code>Employee</code> role to user Bob:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/02-19-user-bob-employee.png" alt="Employee Bob">
</div>
</div>
<div class="paragraph">
<p>MidPoint automatically creates all the accounts given by the role:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/02-20-user-bob-accounts.png" alt="Employee Bob accounts">
</div>
</div>
<div class="paragraph">
<p>There is the HR account that was used to create the Bob user record in the first place.<br><span class="segmentSeparator"></span>And then there are the two accounts that were created because Bob has the <code>Employee</code> role.</p>
</div>
<div class="paragraph">
<p>This operation works in both directions: if Eric unassigns the <code>Employee</code> role, the accounts given by the role will be deleted.<br><span class="segmentSeparator"></span>Eric can create any number of roles like this: roles for Sales agents with CRM access, roles for Sales managers with higher CRM privileges and so on.<br><span class="segmentSeparator"></span>MidPoint is designed to handle large number of roles.<br><span class="segmentSeparator"></span>Each role can have its own combination of resources.<br><span class="segmentSeparator"></span>MidPoint seamlessly merges the privileges given by all the roles a user has.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>if two roles give CRM access to the user, only one CRM account will be created.<br><span class="segmentSeparator"></span>If one of these roles is unassigned then CRM account remains there.<br><span class="segmentSeparator"></span>The account is not deleted yet because it is given by the other role.<br><span class="segmentSeparator"></span>Only when the last CRM role is removed that’s the point where the account gets deleted.<br><span class="segmentSeparator"></span>MidPoint takes care of all that logic.</p>
</div>
<div class="paragraph">
<p>Of course, there is much more that the roles can do:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Roles can assign accounts to groups, give the privileges and manage account entitlements.</p>
</li>
<li>
<p>Roles can mandate specific account attribute values, e.g.<br><span class="segmentSeparator"></span>clearance levels, compartments, etc.</p>
</li>
<li>
<p>Roles may contain custom logic (scripts).</p>
</li>
<li>
<p>Roles may be hierarchical: there may be roles within roles.</p>
</li>
<li>
<p>Roles may be assigned for a specified time.</p>
</li>
<li>
<p>Roles may be conditional and parametric.</p>
</li>
<li>
<p>…​ and much much more.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Roles are really the essence of identity management.<br><span class="segmentSeparator"></span>We will be dealing with roles in almost all the parts of this book.</p>
</div>
</div>
<div class="sect2">
<h3 id="_there_is_much_more">There Is Much More</h3>
<div class="paragraph">
<p>Eric the Engineer has done a few basic steps to configure midPoint as an identity management system for his company.<br><span class="segmentSeparator"></span>But this is still a very basic configuration.<br><span class="segmentSeparator"></span>Careful readers have already noticed a lot of things that need to be done.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>employee full name is not automatically generated.<br><span class="segmentSeparator"></span>Employee numbers are used as identifiers and we would like to have something that is more user-friendly.<br><span class="segmentSeparator"></span>We would like to automatically assign the <code>Employee</code> role instead of doing that manually.<br><span class="segmentSeparator"></span>And so on.<br><span class="segmentSeparator"></span>There are still a lot of things to improve.<br><span class="segmentSeparator"></span>Fortunately, all of that is very easy to do with midPoint once you know where to look.<br><span class="segmentSeparator"></span>And we will be dealing with all these things in the rest of this book.<br><span class="segmentSeparator"></span>New functionality will be administered to the ExAmPLE solution in small doses in each chapter – together with a proper explanation of midPoint principles.<br><span class="segmentSeparator"></span>MidPoint is a very flexible and comprehensive system and there are still a lot of things to learn.<br><span class="segmentSeparator"></span>This chapter covered only a minuscule part of midPoint functionality.</p>
</div>
</div>
<div class="sect2">
<h3 id="_what_midpoint_is_not">What MidPoint Is Not</h3>
<div class="paragraph">
<p>Now you probably have some idea what midPoint is.<br><span class="segmentSeparator"></span>However, it is also very important to understand what midPoint is not.<br><span class="segmentSeparator"></span>Identity and Access Management (IAM) field is a combination of many technologies and it may sometimes be quite confusing.<br><span class="segmentSeparator"></span>That is perhaps the reason why the midPoint team occasionally gets questions about midPoint functionality that simply do not make much sense.</p>
</div>
<div class="paragraph">
<p>First of all, midPoint is not an authentication server.<br><span class="segmentSeparator"></span>MidPoint is not designed to validate your username and password.<br><span class="segmentSeparator"></span>Yes, midPoint maintains data about users (including passwords).<br><span class="segmentSeparator"></span>But the data model that midPoint maintains is quite complex.<br><span class="segmentSeparator"></span>It is not meant to be exposed to applications directly.<br><span class="segmentSeparator"></span>That would not be efficient.</p>
</div>
<div class="paragraph">
<p>If you want midPoint to manage users but you also want your applications to have a centralized authentication services there is a solution: publish the data to the LDAP server.<br><span class="segmentSeparator"></span>Connect LDAP server to midPoint as a resource and let midPoint populate and maintain the LDAP sever data.<br><span class="segmentSeparator"></span>The application will not talk to midPoint directly.<br><span class="segmentSeparator"></span>They will talk to the LDAP server.<br><span class="segmentSeparator"></span>This is better for everybody: LDAP is a standard protocol well supported in many applications.<br><span class="segmentSeparator"></span>LDAP servers are also extremely fast and scalable ad nauseam.<br><span class="segmentSeparator"></span>Therefore use the combination of midPoint and an LDAP server of your choice.<br><span class="segmentSeparator"></span>That’s what people usually do and it works perfectly.</p>
</div>
<div class="paragraph">
<p>As midPoint is not an authentication server it obviously is not a Single Sign-On (SSO) server either.<br><span class="segmentSeparator"></span>If you want SSO you will need a dedicated SSO server.<br><span class="segmentSeparator"></span>There are plenty of SSO servers to choose from in both the closed-source and open-source worlds.<br><span class="segmentSeparator"></span>You will also need a scalable directory system (LDAP) to store the data for the SSO server.<br><span class="segmentSeparator"></span>And you will probably still need midPoint to manage the data.</p>
</div>
<div class="paragraph">
<p>One of the things that seems to be shrouded in a lot of confusion is authorization.<br><span class="segmentSeparator"></span>To get the record straight from the beginning: midPoint is not an authorization server.<br><span class="segmentSeparator"></span>It is not a policy decision point (PDP) and it definitely is not a policy enforcement point (PEP).<br><span class="segmentSeparator"></span>You cannot rip authorization out of your application and just “use midPoint for that”.<br><span class="segmentSeparator"></span>That does not work.</p>
</div>
<div class="paragraph">
<p>You can think of midPoint as a policy management point (PMP).<br><span class="segmentSeparator"></span>MidPoint has a lot of sophisticated authorization-related logic inside its core.<br><span class="segmentSeparator"></span>But that logic is not designed to answer questions such as "Is subject S authorized to execute operation O on object X?".<br><span class="segmentSeparator"></span>MidPoint logic is different.<br><span class="segmentSeparator"></span>MidPoint is not concerned with making authorization decisions.<br><span class="segmentSeparator"></span>It is concerned about managing the authorization policies.<br><span class="segmentSeparator"></span>MidPoint sets up the authorization policies in target applications.<br><span class="segmentSeparator"></span>And the applications evaluate these policies themselves.<br><span class="segmentSeparator"></span>This is a much more efficient and more reliable method.<br><span class="segmentSeparator"></span>Unlike authentication, the authorizations decisions are done all the time.<br><span class="segmentSeparator"></span>Authorization is evaluated at least once per every request.<br><span class="segmentSeparator"></span>If the application makes these decision internally then there is no need to a round-trip to the authorization server.<br><span class="segmentSeparator"></span>Performance is significantly increased.<br><span class="segmentSeparator"></span>And there is no single point of failure.<br><span class="segmentSeparator"></span>MidPoint failure will not interrupt authorization flow because the application has all the data inside.<br><span class="segmentSeparator"></span>One less component to cause a failure.<br><span class="segmentSeparator"></span>And still, the policies are centrally managed by midPoint.<br><span class="segmentSeparator"></span>When a policy changes midPoint updates all the affected applications.<br><span class="segmentSeparator"></span>You get all the benefits without the usual drawbacks.</p>
</div>
<div class="paragraph">
<p>MidPoint does what it is supposed to do: it <em>manages</em> identities, entitlements, organizational structures and policies.<br><span class="segmentSeparator"></span>But midPoint does not do things that are not necessary.<br><span class="segmentSeparator"></span>It does not do the things that other technologies already do well.<br><span class="segmentSeparator"></span>MidPoint does not reinvent the wheel.<br><span class="segmentSeparator"></span>There is no need for this.<br><span class="segmentSeparator"></span>MidPoint is not the wheel.<br><span class="segmentSeparator"></span>MidPoint sits above all the wheels.<br><span class="segmentSeparator"></span>MidPoint is the chauffeur.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="03-installation">3.<br><span class="segmentSeparator"></span>Installation and Configuration Principles</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
The <em>Guide</em> is definitive.<br><span class="segmentSeparator"></span>Reality is frequently inaccurate.<br><span class="segmentSeparator"></span></blockquote>
<div class="attribution">
— The Hitchhiker's Guide to the Galaxy<br>
<cite>The Restaurant at the End of the Universe by Douglas Adams</cite>
</div>
</div>
<div class="paragraph">
<p>This chapter provides instructions for installation and initial configuration of a midPoint system.<br><span class="segmentSeparator"></span>The instructions describe installation on Linux system because that is by far the most common operating environment for midPoint deployments.<br><span class="segmentSeparator"></span>However, midPoint is platform-independent and it can run on any environment where Java is running.<br><span class="segmentSeparator"></span>Any experienced engineer will have no trouble adapting these instructions to fit a different operating system.</p>
</div>
<div class="paragraph">
<p>MidPoint installation described in this chapter is a very basic one.<br><span class="segmentSeparator"></span>It is ideal for initial exploration of midPoint, development of midPoint configurations, demonstrations and similar purposes.<br><span class="segmentSeparator"></span>It is a very convenient installation and we use it every day for development work.<br><span class="segmentSeparator"></span>However, to use midPoint in a production deployment the installation need to be slightly adjusted.<br><span class="segmentSeparator"></span>The adjustments are mentioned in this chapter, but the full description of the production-ready installation is provided in later chapters.<br><span class="segmentSeparator"></span>This chapter gives you midPoint installation that is ideal to get you started.</p>
</div>
<div class="sect2">
<h3 id="_requirements">Requirements</h3>
<div class="paragraph">
<p>MidPoint will run on almost any machine.<br><span class="segmentSeparator"></span>All you need is approximately 4GB RAM.<br><span class="segmentSeparator"></span>That’s perhaps the only real limiting factor.<br><span class="segmentSeparator"></span>If you look for more formal system requirements definition then you will find that in midPoint wiki (see <a href="https://docs.evolveum.com/book/practical-identity-management-with-midpoint.html#92-additional-information">Additional Information</a> chapter at the end of the book).</p>
</div>
<div class="paragraph">
<p>From the software side you will need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Java 11</strong> runtime environment (JRE) or development environment (JDK).<br><span class="segmentSeparator"></span>Any JRE or JDK should work.<br><span class="segmentSeparator"></span>You can use the packages from your operating system distribution.<br><span class="segmentSeparator"></span>Or you can download Java and install it as a standalone package.<br><span class="segmentSeparator"></span>Both should work well.<br><span class="segmentSeparator"></span>Just do not forget to set your <code>PATH</code> and <code>JAVA_HOME</code> environment variables to point to the Java installation.</p>
</li>
<li>
<p><strong>MidPoint distribution package.</strong> Download the latest version of midPoint from the Evolveum website.<br><span class="segmentSeparator"></span>You are looking for an archive that looks like <code>midpoint-4.0-dist.zip</code>.<br><span class="segmentSeparator"></span>This archive contains everything that you will need to run midPoint.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We recommend to use the latest available versions of all software packages when dealing with midPoint.<br><span class="segmentSeparator"></span>We are trying really hard to always keep midPoint up-to-date with the rest of the technologies.</p>
</div>
</div>
<div class="sect2">
<h3 id="_installation">Installation</h3>
<div class="paragraph">
<p>MidPoint is Java web application distributed in a stand-alone package.<br><span class="segmentSeparator"></span>The distribution package contains everything that midPoint needs to run – except for Java platform itself.<br><span class="segmentSeparator"></span>Therefore as long as the Java platform is installed all that is needed to run midPoint is to start it:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Extract the files from the distribution package to a location where you want to install midPoint.</p>
</li>
<li>
<p>Locate <code>start.sh</code> (Unix) or <code>start.bat</code> (Windows) script in midPoint distribution package.<br><span class="segmentSeparator"></span>It should be located in bin directory.</p>
</li>
<li>
<p>Execute the start script</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>And that is pretty much it.<br><span class="segmentSeparator"></span>MidPoint will start.<br><span class="segmentSeparator"></span>It will initialize the embedded web container, database and all the other midPoint components.<br><span class="segmentSeparator"></span>That can take a minute or two.<br><span class="segmentSeparator"></span>After the application is initialized you can access it by connecting to midPoint HTTP port, which defaults to 8080.<br><span class="segmentSeparator"></span>You can start working with midPoint now.</p>
</div>
</div>
<div class="sect2">
<h3 id="_midpoint_user_interface">MidPoint User Interface</h3>
<div class="paragraph">
<p>Use the following URL to access midPoint user interface:</p>
</div>
<div class="paragraph">
<p><code><a href="http://hostname:8080/midpoint" class="bare">http://hostname:8080/midpoint</a></code></p>
</div>
<div class="paragraph">
<p>Log in with the following credentials:</p>
</div>
<div class="paragraph">
<p>Username:&nbsp;<code>administrator</code><br>
Password:&nbsp;<code>5ecr3t</code></p>
</div>
<div class="paragraph">
<p>Now you are logged-in as the <code>administrator</code>.<br><span class="segmentSeparator"></span>This user has superuser privileges therefore you can see everything and you can do anything in the midPoint user interface.</p>
</div>
<div class="paragraph">
<p>MidPoint user interface is structured.<br><span class="segmentSeparator"></span>It has the same layout and controls for all the user interface areas:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/03-01-gui-controls.png" alt="GUI controls">
</div>
</div>
<div class="paragraph">
<p>Primary tool for user interface interaction is the menu.<br><span class="segmentSeparator"></span>MidPoint user interface is functionally divided into three parts, therefore there are also three parts of the menu:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Self-service</strong> user interface deals with the things that the user can do for oneself: displaying list of account, changing password, requesting a role and so on.<br><span class="segmentSeparator"></span>This is relatively simple part of the user interface.<br><span class="segmentSeparator"></span>It is often accessible to all the users.</p>
</li>
<li>
<p><strong>Administration</strong> user interface deals with management of other users, roles, organizational structures and similar midPoint objects.<br><span class="segmentSeparator"></span>This is a very comprehensive and considerably complex part of the user interface.<br><span class="segmentSeparator"></span>Usually only privileged users have access to this part of the user interface.<br><span class="segmentSeparator"></span>This part of user interface is often used to support delegated administration and role management therefore it is also meant for security officers, resource owners, role engineers and similar expert users.</p>
</li>
<li>
<p><strong>Configuration</strong> user interface deals with configuration of midPoint system itself.<br><span class="segmentSeparator"></span>It is used to customize midPoint behavior, set fundamental policies and rules that form the foundation of midPoint deployments.<br><span class="segmentSeparator"></span>This part of user interface is usually used only by identity management engineers.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The menu can be hidden by clicking on the button at the top of the screen.<br><span class="segmentSeparator"></span>The top bar also contains the title of the current user interface page and breadcrumbs.<br><span class="segmentSeparator"></span>Breadcrumbs show where you currently are in the user interface and how you got there.<br><span class="segmentSeparator"></span>The breadcrumbs can be used to “find your way home” and back to the previous page.<br><span class="segmentSeparator"></span>The use of browser <em>Back</em> button is not recommended.<br><span class="segmentSeparator"></span>Please use the <em>Back</em> buttons that are present in midPoint user interface or use breadcrumbs.</p>
</div>
</div>
<div class="sect2">
<h3 id="_user_interface_areas">User Interface Areas</h3>
<div class="paragraph">
<p>MidPoint user interface is quite rich.<br><span class="segmentSeparator"></span>Following list provides short description of the most important parts of the user interface.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Home</strong> page gives a brief status about users own accounts, requests, work items and so on.<br><span class="segmentSeparator"></span>This is a page designed to be the first page that will be displayed to the end user after log in to midPoint.</p>
</li>
<li>
<p><strong>Profile</strong> page allows users to see or edit their own profile.</p>
</li>
<li>
<p><strong>Credentials</strong> page allows users to change their own credentials, such as password.</p>
</li>
<li>
<p><strong>Role request</strong> page allows users to select the roles that they need and then request assignment of the roles.</p>
</li>
<li>
<p><strong>Dashboard</strong> pages shows a couple of dashboards designed to provide a lot of useful information at the first sight.<br><span class="segmentSeparator"></span>The built-in system dashboard shows statistics about midPoint installation.</p>
</li>
<li>
<p><strong>User</strong> pages list users in midPoint, allows to create and edit users.</p>
</li>
<li>
<p><strong>Organizational structure</strong> pages show the organizational structure trees.<br><span class="segmentSeparator"></span>Many parallel organizational structures can be managed here, such as tree-like functional organizational structure, flat project-oriented structure, role catalogs and so on.</p>
</li>
<li>
<p><strong>Role</strong> pages allow to list and manage roles.<br><span class="segmentSeparator"></span>Roles can be created and defined in this part of the user interface.</p>
</li>
<li>
<p><strong>Service</strong> pages allow to list and define services, such as devices, servers, applications and so on.</p>
</li>
<li>
<p><strong>Archetype</strong> pages define specific object types that can be used to customize behavior of midPoint objects.</p>
</li>
<li>
<p><strong>Resource</strong> pages list and manage resources.<br><span class="segmentSeparator"></span>New resource can be defined here, associated with the connector, tested, etc.</p>
</li>
<li>
<p><strong>Cases</strong> pages list the things that the users have to do.<br><span class="segmentSeparator"></span>Work items are created if user has to approve something or if there is some manual step in the process.</p>
</li>
<li>
<p><strong>Certification</strong> pages deal with access certification (re-certification, attestation).<br><span class="segmentSeparator"></span>Certification campaigns can be created and managed here.</p>
</li>
<li>
<p><strong>Server task</strong> pages show the tasks that are running on midPoint servers.<br><span class="segmentSeparator"></span>These may be scheduled synchronization tasks, import tasks, running user requests – everything that runs on the servers and cannot be executed immediately in a synchronous way.</p>
</li>
<li>
<p><strong>Report</strong> pages allow to define and run reports.<br><span class="segmentSeparator"></span>These pages typically deal with scheduled printable reports.</p>
</li>
<li>
<p><strong>Configuration</strong> area contains many pages that manage midPoint configuration: system default configuration, repository objects, logging, bulk actions and so on.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_user_interface_concepts">User Interface Concepts</h3>
<div class="paragraph">
<p>MidPoint user interface is using the same concepts and controls in all its parts.<br><span class="segmentSeparator"></span>For example all the lists of all the objects (users, roles, …​) look like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/03-02-list-controls.png" alt="GUI list controls">
</div>
</div>
<div class="paragraph">
<p>Each row represents one object: user, roles, service, task, etc.<br><span class="segmentSeparator"></span>There is also a color-coded object icon.<br><span class="segmentSeparator"></span>The search bar at the top can be used to look for a specific object or to filter the object view.<br><span class="segmentSeparator"></span>Left side is reserved for action buttons.<br><span class="segmentSeparator"></span>Buttons in the table header trigger actions that apply to all selected objects.<br><span class="segmentSeparator"></span>Buttons in each table row trigger actions that apply only to that individual object.<br><span class="segmentSeparator"></span>The buttons in the bottom-left corner execute global actions, such as creating or importing new object, exporting objects and refreshing the view.<br><span class="segmentSeparator"></span>The <em>Import</em> button is especially useful.<br><span class="segmentSeparator"></span>It allows to import new object in XML/JSON/YAML form.<br><span class="segmentSeparator"></span>Paging controls are in the bottom-right corner.</p>
</div>
<div class="paragraph">
<p>MidPoint has a unified color-code that makes the navigation easier.<br><span class="segmentSeparator"></span>Users, roles and other object types have their specific color and icon.<br><span class="segmentSeparator"></span>This indicates the object type and it is used whenever possible: menu, information boxes, lists, box title accents and so on.<br><span class="segmentSeparator"></span>The primary colors and icons are shown in the dashboard:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/03-03-dashboard-object-types.png" alt="Dashboarad object types">
</div>
</div>
<div class="paragraph">
<p>All user-related controls are red, all controls that deal with organizational structure are yellow.<br><span class="segmentSeparator"></span>Roles are green.<br><span class="segmentSeparator"></span>And so on.<br><span class="segmentSeparator"></span>This color code is applied consistently through the midPoint user interface.</p>
</div>
<div class="paragraph">
<p>Similar color code applies to object icons when displayed in user lists.<br><span class="segmentSeparator"></span>However, the color that is used there does not indicate object type but rather an <em>archetype</em>.<br><span class="segmentSeparator"></span>Archetypes are sub-types that are often used to distinguish similar objects.<br><span class="segmentSeparator"></span>For example archetypes can be used to sort users to employees, contractors, customers and so on.<br><span class="segmentSeparator"></span>Look and behavior of "archetyped" objects is configurable.<br><span class="segmentSeparator"></span>Default midPoint configuration contains just a couple of archetypes.<br><span class="segmentSeparator"></span>Those archetypes apply red color to system users and roles.<br><span class="segmentSeparator"></span>Objects that do have any archetype behave in a different way.<br><span class="segmentSeparator"></span>Their color indicate status of the object:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Black icons indicate normal state.<br><span class="segmentSeparator"></span>It suggests that there is nothing special to see here.</p>
</li>
<li>
<p>Gray icons indicate non-active state.<br><span class="segmentSeparator"></span>It suggests that the object is disabled, archived or there is another reason why the object is not active.</p>
</li>
<li>
<p>Blue icons indicate typical end-user access.<br><span class="segmentSeparator"></span>It suggests that the object has an access, but the access is limited only to safe, non-privileges operations.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>users with end-user role.</p>
</li>
<li>
<p>Yellow icons indicate management capabilities.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>users that are managers of organizational units.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
All objects are equal in midPoint.<br><span class="segmentSeparator"></span>MidPoint will handle users, roles, organizational units and services in the same way.<br><span class="segmentSeparator"></span>The lists used to display these objects are the same, the pages that display object details are the same.<br><span class="segmentSeparator"></span>All the objects have properties, they can be enabled/disabled in the same way, they are subject to authorizations in the same way and so on.<br><span class="segmentSeparator"></span>It is a midPoint philosophy to design several powerful principles and then apply them over and over again.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_object_details_page">Object Details Page</h3>
<div class="paragraph">
<p>When a user clicks on a name of any object in the object list then object details page appears.<br><span class="segmentSeparator"></span>The detail pages for common midPoint objects such as user or role are very similar to each other.<br><span class="segmentSeparator"></span>They have the same layout and controls.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>user details page looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/03-04-user-details.png" alt="User details">
</div>
</div>
<div class="paragraph">
<p>There is an information area at the top of the page.<br><span class="segmentSeparator"></span>That area shows user photo (or icon) and provides some basic information such as user name and identifier.<br><span class="segmentSeparator"></span>It also shows where the object belongs in the organizational structure.<br><span class="segmentSeparator"></span>There is also a couple of "tags" that show interesting details about the object: whether the object is enabled, whether it has special privileges and so on.</p>
</div>
<div class="paragraph">
<p>The screen below the information area is divided into several tabs.<br><span class="segmentSeparator"></span>Each tab shows one aspect of the object.<br><span class="segmentSeparator"></span>There are tabs that show projections, assignments, inducements – we will come to that later in this book.<br><span class="segmentSeparator"></span>The first tab is perhaps the most interesting right now.<br><span class="segmentSeparator"></span>It contains a dialog that shows basic object properties: the attributes of the object.<br><span class="segmentSeparator"></span>Properties are displayed and they can be edited – depending on the authorizations of currently logged-in user.<br><span class="segmentSeparator"></span>In addition to the basic properties there are also other sections.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>activation section shows whether the object is enabled or disabled, it shows the activation dates and other activation details.<br><span class="segmentSeparator"></span>The credentials section allows to change password and other credentials.<br><span class="segmentSeparator"></span>There are several little buttons at the top of each section.<br><span class="segmentSeparator"></span>One of them can be used to change the ordering in which the properties are shown.<br><span class="segmentSeparator"></span>The other button toggles the display of metadata.<br><span class="segmentSeparator"></span>There may be additional buttons depending on the situation.</p>
</div>
<div class="paragraph">
<p>Operation options and buttons are located at the bottom of the details page.<br><span class="segmentSeparator"></span>The buttons initiate the operations.<br><span class="segmentSeparator"></span>The most common operation is just to save the changes and that’s what the <em>Save</em> button is for.<br><span class="segmentSeparator"></span>Saving the changes is a universal way how to start almost any operation: change of user properties, assignment of roles, change of password, user disable, etc.<br><span class="segmentSeparator"></span>When you make edits in any of the tabs on the details page then nothing really happens yet.<br><span class="segmentSeparator"></span>MidPoint just remembers what you are editing.<br><span class="segmentSeparator"></span>The operation is executed only when you click the Save button.<br><span class="segmentSeparator"></span>This is our method how to execute several changes in one operation.<br><span class="segmentSeparator"></span>It may require some time to get used to it.<br><span class="segmentSeparator"></span>Just do not forget to click the save Button.</p>
</div>
<div class="paragraph">
<p>Operation options are used to modify the behavior of the operation.<br><span class="segmentSeparator"></span>These options may force to execute operations that fail to pass midPoint internal checks.<br><span class="segmentSeparator"></span>There is an option to reconcile the data even if midPoint thinks that reconciliation is not needed.<br><span class="segmentSeparator"></span>And so on.<br><span class="segmentSeparator"></span>Checking or unchecking these options influences the way how midPoint executes the operation.</p>
</div>
<div class="paragraph">
<p>MidPoint user interface often needs to present objects that are internally quite complex.<br><span class="segmentSeparator"></span>It does not make sense to present all the details at once.<br><span class="segmentSeparator"></span>These objects need to be presented in quite a compact form that can be expanded to show the details.<br><span class="segmentSeparator"></span>This applies to list of user’s accounts, assignments, role inducements, etc.<br><span class="segmentSeparator"></span>The objects are initially displayed as in a form of a simple list, displaying only the basic data:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/03-05-user-projections.png" alt="User projections">
</div>
</div>
<div class="paragraph">
<p>The list above shows user’s <em>projections</em>.<br><span class="segmentSeparator"></span>Those are usually accounts that are linked to user object.<br><span class="segmentSeparator"></span>Click on account name shows account details:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/03-06-user-projection-details.png" alt="Projection details">
</div>
</div>
<div class="paragraph">
<p>Account details display is shown in place of user details.<br><span class="segmentSeparator"></span>This may be slightly confusing.<br><span class="segmentSeparator"></span>But account details can be often complex, therefore all the available screen space is needed to display them.<br><span class="segmentSeparator"></span>The <em>Cancel</em> and <em>Done</em> buttons at the bottom can be used to return back to <em>Projections</em> tab.<br><span class="segmentSeparator"></span>Click on <em>Done</em> button will not start the operation yet, it only changes the view.<br><span class="segmentSeparator"></span>Therefore do not confuse those buttons with <em>Back</em> and <em>Save</em> buttons on the very bottom on the page.<br><span class="segmentSeparator"></span>The operation starts when <em>Save</em> button is clicked.</p>
</div>
</div>
<div class="sect2">
<h3 id="_midpoint_configuration_basics">MidPoint Configuration Basics</h3>
<div class="paragraph">
<p>The principle of midPoint configuration is quite different from what would a typical system administrator expect.<br><span class="segmentSeparator"></span>There are almost no configuration files in midPoint.<br><span class="segmentSeparator"></span>MidPoint is storing vast majority of its configuration in its configuration database.<br><span class="segmentSeparator"></span>There are several reasons for this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>MidPoint configuration is <strong>complex</strong>.<br><span class="segmentSeparator"></span>MidPoint configuration is not what a typical system administrator would think of like a "configuration".<br><span class="segmentSeparator"></span>It contains numerous resource definitions that in turn contains mappings that in turn may contain scripts.<br><span class="segmentSeparator"></span>There are roles, policies, templates, …​ and these objects are too complex to be expressed in simple configuration files.</p>
</li>
<li>
<p>MidPoint configuration is <strong>scalable</strong>.<br><span class="segmentSeparator"></span>It is no exception that a midPoint deployment has thousands of role definitions or organizational units, tens of resource definitions and a significant number of templates and policies.<br><span class="segmentSeparator"></span>All of that needs to be stored efficiently, so midPoint can handle deployments that manage millions of identities.<br><span class="segmentSeparator"></span>The configuration also needs to be searchable.<br><span class="segmentSeparator"></span>Managing thousands of roles in plain text files simply won’t work.</p>
</li>
<li>
<p>MidPoint configuration needs to be <strong>available</strong>.<br><span class="segmentSeparator"></span>There are midPoint deployments with several nodes working together in a cluster.<br><span class="segmentSeparator"></span>Configuration change done on one node has to be seem by other nodes.<br><span class="segmentSeparator"></span>Simple configuration files would not work here.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Therefore midPoint has a completely different approach to configuration.<br><span class="segmentSeparator"></span>The configuration is stored in a form of well-defined structured objects in the midPoint database.<br><span class="segmentSeparator"></span>We call that database <em>midPoint repository</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_objects">Configuration Objects</h3>
<div class="paragraph">
<p>Everything is an object in midPoint.<br><span class="segmentSeparator"></span>Every piece of configuration is represented as a structured object and stored in midPoint repository.<br><span class="segmentSeparator"></span>Object may look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">8ebab0bc-7e7e-11e6-a7bc-57de1cd45ecc</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Basic User<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;description&gt;</span>Basic user role.<br><span class="segmentSeparator"></span>Almost all users have it.<span class="tag">&lt;/description&gt;</span>
    <span class="tag">&lt;requestable&gt;</span>true<span class="tag">&lt;/requestable&gt;</span>
    <span class="tag">&lt;inducement&gt;</span>
        <span class="tag">&lt;targetRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">f92e67c2-7e7e-11e6-a306-7bf6aa2e8c61</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">RoleType</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/inducement&gt;</span>
<span class="tag">&lt;/role&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Every object has its identifier.<br><span class="segmentSeparator"></span>We call that identifier <em>OID</em> which stands for "object identifier" (it has nothing to do with LDAP or ASN.1 OIDs).<br><span class="segmentSeparator"></span>OID is usually randomly-generated universally unique identifier (UUID).<br><span class="segmentSeparator"></span>OID value has to be unique in a whole system.<br><span class="segmentSeparator"></span>This identifier is <em>persistent</em> – it is assigned to the object and it should never change.<br><span class="segmentSeparator"></span>OID is used for internal purposes and it is almost never displayed to midPoint user.</p>
</div>
<div class="paragraph">
<p>Every object has a <em>name</em>.<br><span class="segmentSeparator"></span>Name is human-readable and it can change any time.<br><span class="segmentSeparator"></span>The value of name is usually displayed to users.<br><span class="segmentSeparator"></span>This is the values that ordinary users understand as an identifier.</p>
</div>
<div class="paragraph">
<p>And then there are other object properties.<br><span class="segmentSeparator"></span>Or rather <em>items</em>.<br><span class="segmentSeparator"></span>Each type of midPoint object has a slightly different set of these items.<br><span class="segmentSeparator"></span>That’s what we call <em>schema</em>.<br><span class="segmentSeparator"></span>The items may be simple properties such as string, integer or boolean values.<br><span class="segmentSeparator"></span>But there also may be complex structures and references between objects.<br><span class="segmentSeparator"></span>MidPoint data model is quite rich.<br><span class="segmentSeparator"></span>It is in fact so rich that its description will take better part of this book, because description of the data model is also description of midPoint features.</p>
</div>
<div class="paragraph">
<p>You can see midPoint configuration objects in midPoint user interface by navigating to <em>Configuration &gt; Repository Objects</em> and selecting object type.<br><span class="segmentSeparator"></span>The following picture shows objects of type "Role":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/03-07-repository-objects.png" alt="Repository objects">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_xml_json_and_yaml">XML, JSON and YAML</h3>
<div class="paragraph">
<p>The objects are stored in the midPoint repository in a native form which is hidden from midPoint users.<br><span class="segmentSeparator"></span>However, the objects also have a human-readable representation.<br><span class="segmentSeparator"></span>They can be represented in XML, JSON and YAML forms.<br><span class="segmentSeparator"></span>All the objects can be imported into midPoint in any of those forms.<br><span class="segmentSeparator"></span>They can be exported from midPoint in any of those forms.<br><span class="segmentSeparator"></span>They can be even edited directly in midPoint using embedded editor.<br><span class="segmentSeparator"></span>Just click on any object in the <em>Repository objects</em> page:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/03-08-repository-object-edit.png" alt="Repository object details">
</div>
</div>
<div class="paragraph">
<p>The ability to export, import and edit objects in XML/JSON/YAML form is absolutely essential, because:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It is <strong>human-readable</strong> (or rather administrator-readable).<br><span class="segmentSeparator"></span>The configuration can be created, edited and maintained in your favorite editor and then imported into midPoint.<br><span class="segmentSeparator"></span>It can be reviewed.<br><span class="segmentSeparator"></span>It can be copied and pasted.<br><span class="segmentSeparator"></span>Especially that.<br><span class="segmentSeparator"></span>No system administrator can live efficiently without an ability to copy and paste.</p>
</li>
<li>
<p>It is <strong>transferable</strong>.<br><span class="segmentSeparator"></span>It can be exported from one system (e.g.<br><span class="segmentSeparator"></span>development environment) and easily transferred to another system (e.g.<br><span class="segmentSeparator"></span>testing environment).<br><span class="segmentSeparator"></span>It can be easily backed-up and restored.<br><span class="segmentSeparator"></span>It can be easily shared, e.g.<br><span class="segmentSeparator"></span>in a form of configuration samples.</p>
</li>
<li>
<p>It is <strong>versionable</strong>.<br><span class="segmentSeparator"></span>The exported configuration can be easily put under any ordinary version control system.<br><span class="segmentSeparator"></span>This is essential for deployment projects and configuration management.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Therefore the midPoint configuration has the best of both worlds.<br><span class="segmentSeparator"></span>It is stored in database, so it can be processed efficiently, it can be made available and so on.<br><span class="segmentSeparator"></span>But it also has a text form, so it can be easily managed.</p>
</div>
<div class="paragraph">
<p>The XML, JSON and YAML forms are considered to be equivalent.<br><span class="segmentSeparator"></span>Objects can be written in any of these forms.</p>
</div>
<div class="listingblock">
<div class="title">XML form of role object</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">8ebab0bc-7e7e-11e6-a7bc-57de1cd45ecc</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Basic User<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;description&gt;</span>Basic user role.<br><span class="segmentSeparator"></span>Almost all users have it.<span class="tag">&lt;/description&gt;</span>
    <span class="tag">&lt;requestable&gt;</span>true<span class="tag">&lt;/requestable&gt;</span>
    <span class="tag">&lt;inducement&gt;</span>
        <span class="tag">&lt;targetRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">f92e67c2-7e7e-11e6-a306-7bf6aa2e8c61</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">RoleType</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/inducement&gt;</span>
<span class="tag">&lt;/role&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">JSON form of role object</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
    <span class="key"><span class="delimiter">"</span><span class="content">role</span><span class="delimiter">"</span></span> : {
        <span class="key"><span class="delimiter">"</span><span class="content">oid</span><span class="delimiter">"</span></span> : <span class="string"><span class="delimiter">"</span><span class="content">8ebab0bc-7e7e-11e6-a7bc-57de1cd45ecc</span><span class="delimiter">"</span></span>,
        <span class="key"><span class="delimiter">"</span><span class="content">name</span><span class="delimiter">"</span></span> : <span class="string"><span class="delimiter">"</span><span class="content">Basic User</span><span class="delimiter">"</span></span>,
        <span class="key"><span class="delimiter">"</span><span class="content">description</span><span class="delimiter">"</span></span> : <span class="string"><span class="delimiter">"</span><span class="content">Basic user role.<br><span class="segmentSeparator"></span>Almost all users have it.</span><span class="delimiter">"</span></span>,
        <span class="key"><span class="delimiter">"</span><span class="content">requestable</span><span class="delimiter">"</span></span> : <span class="value">true</span>,
        <span class="key"><span class="delimiter">"</span><span class="content">inducement</span><span class="delimiter">"</span></span> : {
            <span class="key"><span class="delimiter">"</span><span class="content">targetRef</span><span class="delimiter">"</span></span> : {
                <span class="key"><span class="delimiter">"</span><span class="content">oid</span><span class="delimiter">"</span></span> : <span class="string"><span class="delimiter">"</span><span class="content">f92e67c2-7e7e-11e6-a306-7bf6aa2e8c61</span><span class="delimiter">"</span></span>,
                <span class="key"><span class="delimiter">"</span><span class="content">type</span><span class="delimiter">"</span></span> : <span class="string"><span class="delimiter">"</span><span class="content">RoleType</span><span class="delimiter">"</span></span>
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">YAML form of role object</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span class="key">role</span>:
    <span class="key">oid</span>: <span class="string"><span class="delimiter">"</span><span class="content">8ebab0bc-7e7e-11e6-a7bc-57de1cd45ecc</span><span class="delimiter">"</span></span>
    <span class="key">name</span>: <span class="string"><span class="delimiter">"</span><span class="content">Basic User</span><span class="delimiter">"</span></span>
    <span class="key">description</span>: <span class="string"><span class="delimiter">"</span><span class="content">Basic user role.<br><span class="segmentSeparator"></span>Almost all users have it.</span><span class="delimiter">"</span></span>
    <span class="key">requestable</span>: <span class="string"><span class="content">true</span></span>
    <span class="key">inducement</span>:
      - <span class="string"><span class="content">targetRef:</span><span class="content">
            oid: "f92e67c2-7e7e-11e6-a306-7bf6aa2e8c61"
            type: "RoleType"</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Most of the examples in this book are in XML notation.<br><span class="segmentSeparator"></span>The XML form is almost always simplified for clarity: there are no namespace definitions, no namespace prefixes and so on.<br><span class="segmentSeparator"></span>The complete files with all the details can be found in midPoint distribution package, midPoint source code or in other places.<br><span class="segmentSeparator"></span>See <a href="https://docs.evolveum.com/book/practical-identity-management-with-midpoint.html#92-additional-information">Additional Information</a> chapter for more details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_maintaining_midpoint_configuration">Maintaining MidPoint Configuration</h3>
<div class="paragraph">
<p>When it comes to maintenance of midPoint configuration there are two practical methods how to do that.</p>
</div>
<div class="paragraph">
<p>First method is to maintain the configuration in midPoint: use midPoint wizards and user interface tools to create new objects and modify them.<br><span class="segmentSeparator"></span>Export the objects in regular intervals so they are backed up, placed under version control and so on.<br><span class="segmentSeparator"></span>This is an easy method to start with.<br><span class="segmentSeparator"></span>But sooner or later you will probably figure out that you need the ability to copy and paste parts of the configuration.<br><span class="segmentSeparator"></span>That you need to share the configuration with other team members.<br><span class="segmentSeparator"></span>And that no user interface is ever as efficient as an experienced engineer with a good text editor.</p>
</div>
<div class="paragraph">
<p>Then there is a second method: maintain the configuration files in text form outside of midPoint.<br><span class="segmentSeparator"></span>Import them to midPoint as needed.<br><span class="segmentSeparator"></span>The objects can be imported in midPoint user interface by going to <em>Configuration &gt; Import object</em> page.<br><span class="segmentSeparator"></span>There are also import buttons in almost all the object list tables that also lead to that page.</p>
</div>
<div class="paragraph">
<p>It is much easier to maintain a proper version control and a good teamwork using the import method.<br><span class="segmentSeparator"></span>It also seems to be more efficient once you get used to midPoint: pieces of configuration can be copied from samples, documentation or from other projects.<br><span class="segmentSeparator"></span>This makes the work efficient.<br><span class="segmentSeparator"></span>Although work with midPoint is "just" configuration and there is usually almost no programming, this method of work is quite close to the methods that software developers use.<br><span class="segmentSeparator"></span>And we know that these methods work quite efficiently.</p>
</div>
<div class="paragraph">
<p>If you maintain the configuration files out of midPoint you can import them individually using midPoint user interface.<br><span class="segmentSeparator"></span>This may seem like quite an uncomfortable way.<br><span class="segmentSeparator"></span>But it works surprisingly well even for a mid-size projects.<br><span class="segmentSeparator"></span>However, there is also a much better way.<br><span class="segmentSeparator"></span>MidPoint has a plug-in into Eclipse IDE environment that allows you to maintain the configuration files in form of Eclipse projects.<br><span class="segmentSeparator"></span>The plug-in allows easy download and upload of changed configuration files.<br><span class="segmentSeparator"></span>As Eclipse also has good integration for version control systems and other development tools this seems like an ideal approach for large and complex projects.</p>
</div>
</div>
<div class="sect2">
<h3 id="_looking_around_midpoint_installation">Looking Around MidPoint Installation</h3>
<div class="paragraph">
<p>Now we have a running midPoint installation and you should have some understanding of how to configure it.<br><span class="segmentSeparator"></span>But before we plunge into the details about configuration let’s have a look at midPoint installation.<br><span class="segmentSeparator"></span>There are few things that need to be understood before going on.<br><span class="segmentSeparator"></span>It will save a lot of time later on.</p>
</div>
<div class="paragraph">
<p>MidPoint needs its own database to work.<br><span class="segmentSeparator"></span>We call that database <em>midPoint repository</em>.<br><span class="segmentSeparator"></span>The database is used to store the configuration, users, resource definitions, account links, audit trails and a lot of other things.<br><span class="segmentSeparator"></span>Proper relational database (PostgreSQL, MySQL/MariaDB, Microsoft SQL or Oracle) is strongly recommended for production deployment.<br><span class="segmentSeparator"></span>But for development and demonstration purposes midPoint contains an embedded database engine (H2 database).<br><span class="segmentSeparator"></span>This embedded database is initialized by default when midPoint is installed.<br><span class="segmentSeparator"></span>And it is that embedded database that is used to store the configuration objects right now in your fresh midPoint deployment.<br><span class="segmentSeparator"></span>This database does not need any special configuration, the database schema is applied automatically and it is started and stopped together with midPoint.<br><span class="segmentSeparator"></span>Therefore it is ideal for demonstration and development purposes.</p>
</div>
<div class="paragraph">
<p>Vast majority of midPoint configuration is stored in the database.<br><span class="segmentSeparator"></span>But there are few things that cannot be stored there.<br><span class="segmentSeparator"></span>Such as connection parameters to the database itself.<br><span class="segmentSeparator"></span>For that purpose midPoint has a small configuration file called <code>config.xml</code>.<br><span class="segmentSeparator"></span>MidPoint also needs a place where to store other data that cannot be in the database, such as cryptographic keys, connector binaries and so on.</p>
</div>
<div class="paragraph">
<p>MidPoint needs a special directory on a filesystem for that purpose.<br><span class="segmentSeparator"></span>We call it midPoint home directory.<br><span class="segmentSeparator"></span>New directory with the name var is created in directory where midPoint distribution package was installed, i.e.<br><span class="segmentSeparator"></span>at the same level as the bin directory where midPoint start start scripts are located.<br><span class="segmentSeparator"></span>Assuming that midPoint was installed in <code>/opt/midpoint</code> directory then midPoint home will be located in <code>/opt/midpoint/var</code> directory.</p>
</div>
<div class="paragraph">
<p>The location of midPoint home directory can be changed by using the midpoint.home Java system property.<br><span class="segmentSeparator"></span>This is done by specifying <code>-Dmidpoint.home</code> in the JVM command-line.<br><span class="segmentSeparator"></span>Or in case that the default midPoint start scripts are used <code>MIDPOINT_HOME</code> environment variable can be used to set the location of midPoint home directory.</p>
</div>
<div class="paragraph">
<p>When midPoint starts for the first time it starts with an empty database.<br><span class="segmentSeparator"></span>MidPoint populates the database with a minimal set of configuration objects.<br><span class="segmentSeparator"></span>This set contains objects such as the <code>Superuser</code> role and user <code>administrator</code>.<br><span class="segmentSeparator"></span>These objects get imported automatically because if they are not there you will not be able to log into the new midPoint instance.<br><span class="segmentSeparator"></span>These objects are imported only if they are not already present in the database.<br><span class="segmentSeparator"></span>If you modify them later then midPoint will not overwrite them.</p>
</div>
</div>
<div class="sect2">
<h3 id="_logging">Logging</h3>
<div class="paragraph">
<p>Logging is perhaps the most important mechanism to diagnose any issues with midPoint.<br><span class="segmentSeparator"></span>Logging should be <em>the</em> thing that comes to your mind anytime you cast a puzzled look at midPoint user interface.<br><span class="segmentSeparator"></span>We try to make midPoint user interface convenient to use and we pay a lot of attention to good error reporting.<br><span class="segmentSeparator"></span>But there are always some limits.<br><span class="segmentSeparator"></span>The error that the user interface displays may be just a result of a long chain of causes and effects.<br><span class="segmentSeparator"></span>Error messages in the user interface may not directly point to the primary cause.<br><span class="segmentSeparator"></span>Or maybe there is no error at all, just midPoint does not do what it is supposed to do.<br><span class="segmentSeparator"></span>That is the point where logging comes to the rescue.</p>
</div>
<div class="paragraph">
<p>MidPoint is using Java logging facilities to log its messages.<br><span class="segmentSeparator"></span>MidPoint log file name is <code>midpoint.log</code> and it is stored in the log subdirectory in midPoint home directory (<code>/opt/midpoint/var/log/midpoint.log</code>).<br><span class="segmentSeparator"></span>The default logging level is set up more-or-less to suit normal midPoint operation.<br><span class="segmentSeparator"></span>This means that the messages on level <code>INFO</code> and above are logged while the finer levels are not logged.<br><span class="segmentSeparator"></span>If you want to diagnose midPoint issues you will need to switch the logging levels to <code>DEBUG</code>, or in extreme cases even to <code>TRACE</code>.<br><span class="segmentSeparator"></span>The logging levels can be adjusted in midPoint user interface.<br><span class="segmentSeparator"></span>Navigate to <em>Configuration &gt; System &gt; Logging</em>.</p>
</div>
<div class="paragraph">
<p>MidPoint is not a simple system.<br><span class="segmentSeparator"></span>There are complex interactions, there is usually a lot of custom configuration, customizations, expressions and so on.<br><span class="segmentSeparator"></span>Diagnostics of midPoint issues is in itself no easy task.<br><span class="segmentSeparator"></span>Therefore there is a dedicated <a href="https://docs.evolveum.com/book/practical-identity-management-with-midpoint.html#90-troubleshooting">Troubleshooting</a> chapter in this book.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="04-resources-and-mappings">4.<br><span class="segmentSeparator"></span>Resources and Mappings</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
The pessimist complains about the wind; the optimist expects it to change; the realist adjusts the sails.<br><span class="segmentSeparator"></span></blockquote>
<div class="attribution">
— William Arthur Ward
</div>
</div>
<div class="paragraph">
<p>Reading an&lt; writing resource objects, attribute synchronization, mapping of attribute values, their transformation using scripts – these are the basic midPoint features.<br><span class="segmentSeparator"></span>These features are absolutely essential for any self-respecting IDM deployment and all IDM engineers should be more than familiar with them.<br><span class="segmentSeparator"></span>And this is exactly the purpose of this chapter: describe necessary configuration to use midPoint as a provisioning engine.</p>
</div>
<div class="paragraph">
<p>It is not very realistic to expect that all the systems will agree on the same interface, communication protocol and schema for identity management.<br><span class="segmentSeparator"></span>There were several attempts to unify the IAM landscape, but none of them was entirely successful.<br><span class="segmentSeparator"></span>The LDAP protocol was created in 1990s.<br><span class="segmentSeparator"></span>But even for such a mature protocol the LDAP implementations are sill not 100% interoperable.<br><span class="segmentSeparator"></span>The situation is even worse for identity provisioning protocols.<br><span class="segmentSeparator"></span>There were several attempts to specify a standard provisioning protocol, but all of them failed to deliver complete interoperability.<br><span class="segmentSeparator"></span>The worst pain point of identity integration is undoubtedly the schema.<br><span class="segmentSeparator"></span>Every application has its own data model for representation of accounts, groups, privileges and other identity-related objects.<br><span class="segmentSeparator"></span>Even if the application tries to expose that data model using some kind of standard schema there will always be small (but important) differences.<br><span class="segmentSeparator"></span>MidPoint provides a practical solution to this problem.<br><span class="segmentSeparator"></span>Application interfaces and their schemas need to be aligned or <em>mapped</em> to a common identity schema that you choose to use for your deployment.<br><span class="segmentSeparator"></span>This chapter will tell you how to do it.</p>
</div>
<div class="sect2">
<h3 id="_resource_definitions">Resource Definitions</h3>
<div class="paragraph">
<p><em>Resource</em> is one of the most important concepts in midPoint.<br><span class="segmentSeparator"></span>Any system connected to midPoint is a <em>resource</em>.<br><span class="segmentSeparator"></span>Resources are typically target systems where midPoint manages accounts.<br><span class="segmentSeparator"></span>But source systems such as HR databases are also considered to be resources.<br><span class="segmentSeparator"></span>There is no strict distinction between source and target resource in midPoint.<br><span class="segmentSeparator"></span>Both source and target resources are defined in exactly the same way.<br><span class="segmentSeparator"></span>Resource can even act as both source and target at the same time.</p>
</div>
<div class="paragraph">
<p>MidPoint needs a way how to communicate with the resource.<br><span class="segmentSeparator"></span>MidPoint has to know communication protocol, hostname, passwords, etc.<br><span class="segmentSeparator"></span>For that purpose midPoint has <em>resource definition objects</em>.<br><span class="segmentSeparator"></span>These are ordinary midPoint configuration objects stored in midPoint repository.<br><span class="segmentSeparator"></span>Resource definition usually contains:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Name</strong> of the resource and its description</p>
</li>
<li>
<p><strong>Reference to the connector</strong> which used to communicate with the resource</p>
</li>
<li>
<p><strong>Connector configuration properties</strong> that define resource host name, port, communication settings and so on.<br><span class="segmentSeparator"></span>Those properties are used to initialize the connector.</p>
</li>
<li>
<p>Definition of <strong>object types</strong> that are interesting for midPoint.<br><span class="segmentSeparator"></span>This is typically a definition that describes how a typical account looks like.<br><span class="segmentSeparator"></span>But there may be much more: groups, roles, organizational units, …</p>
</li>
<li>
<p>Object type definitions typically contain <strong>mappings</strong>.<br><span class="segmentSeparator"></span>Mappings define how attributes are synchronized from midPoint to resource or from resource to midPoint.</p>
</li>
<li>
<p><strong>Synchronization</strong> settings that define what midPoint should do if it discovers unknown account, if the account is deleted on the resource and so on.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Resource definition looks like this in its XML form (simplified):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;resource</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">b4101662-7902-11e6-9f14-53e18426fe81</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>LDAP<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;connectorRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">028159cc-f976-457f-be70-9e9fa079bcf7</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;connectorConfiguration&gt;</span>
        <span class="tag">&lt;configurationProperties&gt;</span>
            <span class="tag">&lt;port&gt;</span>389<span class="tag">&lt;/port&gt;</span>
            <span class="tag">&lt;host&gt;</span>localhost<span class="tag">&lt;/host&gt;</span>
            <span class="tag">&lt;baseContext&gt;</span>dc=example,dc=com<span class="tag">&lt;/baseContext&gt;</span>
            ...<br><span class="segmentSeparator"></span>        <span class="tag">&lt;/configurationProperties&gt;</span>
    <span class="tag">&lt;/connectorConfiguration&gt;</span>
    <span class="tag">&lt;schemaHandling&gt;</span>
        <span class="tag">&lt;objectType&gt;</span>
            <span class="tag">&lt;kind&gt;</span>account<span class="tag">&lt;/kind&gt;</span>
            <span class="tag">&lt;default&gt;</span>true<span class="tag">&lt;/default&gt;</span>
            <span class="tag">&lt;objectClass&gt;</span>ri:inetOrgPerson<span class="tag">&lt;/objectClass&gt;</span>
            ...<br><span class="segmentSeparator"></span>        <span class="tag">&lt;/objectType&gt;</span>
    <span class="tag">&lt;/schemaHandling&gt;</span>
<span class="tag">&lt;/resource&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Resource definition is a very rich (and powerful) configuration object.<br><span class="segmentSeparator"></span>It is maybe the richest configuration object in the entire midPoint system.<br><span class="segmentSeparator"></span>Creating resource definition from scratch is usually no easy task.<br><span class="segmentSeparator"></span>There is a lot of things to consider: connector configuration, identifier conventions, mandatory attributes, attribute value formats and so on.<br><span class="segmentSeparator"></span>What we usually do is to locate a resource definition sample for a similar resource.<br><span class="segmentSeparator"></span>Then we modify the sample to suit our needs.<br><span class="segmentSeparator"></span>However, you need to understand how the resource definitions work to do this efficiently.<br><span class="segmentSeparator"></span>Next few sections will explain the structure and function of resource definitions.</p>
</div>
<div class="paragraph">
<p>Believe it or not, there are people that do not like XML/JSON/YAML.<br><span class="segmentSeparator"></span>There are also people that really want to start creating the resource from scratch.<br><span class="segmentSeparator"></span>For all those people there is a resource wizard in the midPoint user interface.<br><span class="segmentSeparator"></span>The wizard can be used to create and edit resource using a graphical user interface.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/04-01-resource-wizard.png" alt="Applications">
</div>
</div>
<div class="paragraph">
<p>However, even if resource wizard is your preferred way, it may be still easier to start with an existing sample.<br><span class="segmentSeparator"></span>Find the sample that is the best match for your situation, import it in midPoint and then use the wizard to modify it.</p>
</div>
<div class="paragraph">
<p>There are many resource samples to start from.<br><span class="segmentSeparator"></span>Most of them are located in midPoint distribution package.<br><span class="segmentSeparator"></span>But there are other places to look for samples.<br><span class="segmentSeparator"></span>Please see <a href="https://docs.evolveum.com/book/practical-identity-management-with-midpoint.html#92-additional-information">Additional Information</a> chapter for suggestions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_connectors">Connectors</h3>
<div class="paragraph">
<p>Every resource needs a connector to work.<br><span class="segmentSeparator"></span>Connectors are small pieces of Java code that are used to communicate with the resource.<br><span class="segmentSeparator"></span>MidPoint looks for available connectors when it starts up.<br><span class="segmentSeparator"></span>MidPoint will automatically create new configuration object for each connector that it discovers during startup.<br><span class="segmentSeparator"></span>The list of discovered connectors can be seen in midPoint user interface in <em>Configuration &gt; Repository objects &gt; Connector</em>.<br><span class="segmentSeparator"></span>The connector objects look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;connector</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">028159cc-f976-457f-be70-9e9fa079bcf7</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;name&gt;</span>ConnId com.evolveum.polygon.connector.ldap.LdapConnector v2.0<span class="tag">&lt;/name&gt;</span>
  <span class="tag">&lt;framework&gt;</span>http://midpoint.evolveum.com/xml/ns/public/connector/icf-1<span class="tag">&lt;/framework&gt;</span>
  <span class="tag">&lt;connectorType&gt;</span>com.evolveum.polygon.connector.ldap.LdapConnector<span class="tag">&lt;/connectorType&gt;</span>
  <span class="tag">&lt;connectorVersion&gt;</span>2.0<span class="tag">&lt;/connectorVersion&gt;</span>
  <span class="tag">&lt;connectorBundle&gt;</span>com.evolveum.polygon.connector-ldap<span class="tag">&lt;/connectorBundle&gt;</span>
  <span class="tag">&lt;namespace&gt;</span>http://midpoint.evolveum.com/xml/ns/…<span class="tag">&lt;/namespace&gt;</span>
  <span class="tag">&lt;schema&gt;</span>
      ...<br><span class="segmentSeparator"></span>  <span class="tag">&lt;/schema&gt;</span>
<span class="tag">&lt;connector&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The resource definition needs to point to the appropriate connector object.<br><span class="segmentSeparator"></span>Therefore select the right connector from the connector list and remember its OID.<br><span class="segmentSeparator"></span>Then use the connector OID in the resource configuration like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;resource&gt;</span>
    <span class="tag">&lt;name&gt;</span>My LDAP Server<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;connectorRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">028159cc-f976-457f-be70-9e9fa079bcf7</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/resource&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a straightforward way how to link connector and resource.<br><span class="segmentSeparator"></span>However, it is not the most convenient one.<br><span class="segmentSeparator"></span>MidPoint creates connector objects automatically.<br><span class="segmentSeparator"></span>Therefore the OIDs of the connector objects are not fixed.<br><span class="segmentSeparator"></span>Every midPoint instance will have different OID for the discovered connectors.<br><span class="segmentSeparator"></span>Therefore if we want a resource that is always using the LDAP connector in all the midPoint instances we cannot do that by just using OIDs.<br><span class="segmentSeparator"></span>But there is another way.<br><span class="segmentSeparator"></span>You can use search filter instead of fixed OID:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;resource&gt;</span>
    <span class="tag">&lt;name&gt;</span>My LDAP Server<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;connectorRef</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">ConnectorType</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;filter&gt;</span>
           <span class="tag">&lt;q:equal&gt;</span>
               <span class="tag">&lt;q:path&gt;</span>connectorType<span class="tag">&lt;/q:path&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;q:value&gt;</span>com.evolveum.polygon.connector.ldap.LdapConnector<span class="tag">&lt;/q:value&gt;</span>
           <span class="tag">&lt;/q:equal&gt;</span>
        <span class="tag">&lt;/filter&gt;</span>
    <span class="tag">&lt;/connectorRef&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/resource&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The detailed explanation of the search filters will come later.<br><span class="segmentSeparator"></span>For now it is important to know just few basic principles.<br><span class="segmentSeparator"></span>When this resource definition is imported, midPoint notices that there is no OID in the <code>connectorRef</code> reference.<br><span class="segmentSeparator"></span>It also notices that there is a search filter.<br><span class="segmentSeparator"></span>Therefore midPoint executes that search filter.<br><span class="segmentSeparator"></span>In this case it looks for object of <code>ConnectorType</code> type that has property <code>connectorType</code> with value <code>com.evolveum.polygon.connector.ldap.LdapConnector</code>.<br><span class="segmentSeparator"></span>Therefore midPoint finds LDAP connector regardless of the OID that was generated when midPoint discovered that connector.<br><span class="segmentSeparator"></span>Then midPoint takes the OID of the object that it has found.<br><span class="segmentSeparator"></span>The OID is placed to the <code>connectorRef</code> reference, so midPoint can find the connector directly and it does not need to execute the search every time the resource is used.</p>
</div>
<div class="paragraph">
<p>This is the method that is frequently used to bind resource definition to a specific connector type.<br><span class="segmentSeparator"></span>It has the advantage that it works in all midPoint deployments.<br><span class="segmentSeparator"></span>Therefore it is also used in configuration the samples.</p>
</div>
</div>
<div class="sect2">
<h3 id="_bundled_and_deployed_connectors">Bundled and Deployed Connectors</h3>
<div class="paragraph">
<p>Each class of resources needs its own connector.<br><span class="segmentSeparator"></span>There is an LDAP connector that supports all the common LDAP servers.<br><span class="segmentSeparator"></span>There are connectors that work with generic database tables.<br><span class="segmentSeparator"></span>These connectors are quite generic.<br><span class="segmentSeparator"></span>But most connectors are built for a specific application or software system: Linux servers, SAP R/3, Siebel, etc.</p>
</div>
<div class="paragraph">
<p>There is a handful of connectors that are so generic that they are used in almost all midPoint deployments.<br><span class="segmentSeparator"></span>These connectors are bundled with midPoint.<br><span class="segmentSeparator"></span>That means that they are part of the midPoint application package and they are always available.<br><span class="segmentSeparator"></span>These three connector bundles are part of midPoint:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>LDAP Connector bundle, which contains:</p>
<div class="ulist">
<ul>
<li>
<p><strong>LDAP</strong> connector that works with most LDAPv3-compliant servers.</p>
</li>
<li>
<p><strong>Active Directory</strong> connector that can work with Microsoft Active Directory over LDAP protocol.</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>DatabaseTable</strong> connector bundle with a connector that can connect to a generic relational database table.</p>
</li>
<li>
<p><strong>CSV</strong> connector bundle with a connector that works with comma-separated (CSV) text files.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These connectors are always available in midPoint.<br><span class="segmentSeparator"></span>Other connectors must be deployed into midPoint.<br><span class="segmentSeparator"></span>Connector deployment is a very straightforward process:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Locate the connector binary (JAR file).</p>
</li>
<li>
<p>Copy the binary into the <code>icf-connectors</code> directory which is located in midPoint home directory.</p>
</li>
<li>
<p>Restart midPoint</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>MidPoint will scan the <code>icf-connectors</code> directory when it starts up.<br><span class="segmentSeparator"></span>It will discover any new connectors and create a connector configuration objects for them.</p>
</div>
</div>
<div class="sect2">
<h3 id="_connector_configuration_properties">Connector Configuration Properties</h3>
<div class="paragraph">
<p>Connector need a configuration to be able to work with resource.<br><span class="segmentSeparator"></span>This configuration usually consists of connection parameters such as hostname, port, administrative username, password, connection security settings and so on.<br><span class="segmentSeparator"></span>The connector configuration properties are specified in resource definition object.<br><span class="segmentSeparator"></span>In a simplified from it looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;resource</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">b4101662-7902-11e6-9f14-53e18426fe81</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>My LDAP Server<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;connectorRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">028159cc-f976-457f-be70-9e9fa079bcf7</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;connectorConfiguration&gt;</span>
        <span class="tag">&lt;configurationProperties&gt;</span>
            <span class="tag">&lt;port&gt;</span>389<span class="tag">&lt;/port&gt;</span>
            <span class="tag">&lt;host&gt;</span>localhost<span class="tag">&lt;/host&gt;</span>
            <span class="tag">&lt;baseContext&gt;</span>dc=example,dc=com<span class="tag">&lt;/baseContext&gt;</span>
            ...<br><span class="segmentSeparator"></span>        <span class="tag">&lt;/configurationProperties&gt;</span>
    <span class="tag">&lt;/connectorConfiguration&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/resource&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There may be a very broad range of configuration properties - and every connector has its own set.<br><span class="segmentSeparator"></span>While working just with the text representation of the resource definition you will need to find out the names of the configuration properties by looking at the samples, connector documentation or maybe even connector source code.<br><span class="segmentSeparator"></span>It may look difficult but this is perfectly viable approach.<br><span class="segmentSeparator"></span>However, there are other ways.<br><span class="segmentSeparator"></span>Firstly there is the resource wizard.<br><span class="segmentSeparator"></span>The wizard knows all the connector configuration properties and it will present the properties in a configuration form.<br><span class="segmentSeparator"></span>The wizard takes the definition of the configuration properties from <em>connector schema</em>.<br><span class="segmentSeparator"></span>Connector schema is a definition of the properties that the connector supports: their names, types, multiplicity and so on.<br><span class="segmentSeparator"></span>The connector schema is stored in the connector configuration object under the schema tag.<br><span class="segmentSeparator"></span>Therefore even if you are working only with the XML/JSON/YAML files you can have a look at that schema to figure out what connector configuration properties are supported.</p>
</div>
<div class="paragraph">
<p>The connector schema also defines connector namespace.<br><span class="segmentSeparator"></span>Generally speaking namespaces in midPoint are used to isolate schema extensions that might conflict and they are also used for data model versioning.<br><span class="segmentSeparator"></span>The use of namespaces is optional in almost all parts of midPoint - but not yet in all the parts.<br><span class="segmentSeparator"></span>Connector configuration is one of the few parts where namespaces should still be used.<br><span class="segmentSeparator"></span>And it also makes some sense, as namespaces are used here as an additional safety mechanism.<br><span class="segmentSeparator"></span>To keep a long story short, the configuration properties should be properly namespace-qualified:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;resource</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">b4101662-7902-11e6-9f14-53e18426fe81</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>LDAP<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;connectorRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">028159cc-f976-457f-be70-9e9fa079bcf7</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;connectorConfiguration</span>
<span class="error">&nbsp;</span><span class="error">&nbsp;</span><span class="error">&nbsp;</span><span class="error">&nbsp;</span><span class="error">&nbsp;</span><span class="error">&nbsp;</span><span class="error">&nbsp;</span><span class="attribute-name">xmlns:icfc</span>=<span class="string"><span class="delimiter">"</span><span class="content">http://⁠midpoint.evolveum.com/⁠xml/⁠ns/⁠public⁠/⁠connector⁠/⁠icf⁠-⁠1⁠/⁠connector-schema-3</span><span class="delimiter">"</span></span>
<span class="error">&nbsp;</span><span class="error">&nbsp;</span><span class="error">&nbsp;</span><span class="error">&nbsp;</span><span class="error">&nbsp;</span><span class="error">&nbsp;</span><span class="error">&nbsp;</span><span class="attribute-name">xmlns:icfcldap</span>=<span class="string"><span class="delimiter">"</span><span class="content">http://midpoint.evolveum.com⁠/⁠xml⁠/⁠ns⁠/⁠public⁠/⁠connector⁠/⁠icf⁠-⁠1⁠/⁠bundle⁠/⁠com.evolveum.polygon.connector⁠-⁠ldap/⁠com.evolveum.polygon.connector.ldap.LdapConnector</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;icfc:configurationProperties&gt;</span>
            <span class="tag">&lt;icfcldap:port&gt;</span>389<span class="tag">&lt;/icfcldap:port&gt;</span>
            <span class="tag">&lt;icfcldap:host&gt;</span>localhost<span class="tag">&lt;/icfcldap:host&gt;</span>
            <span class="tag">&lt;icfcldap:baseContext&gt;</span>dc=example,dc=com<span class="tag">&lt;/icfcldap:baseContext&gt;</span>
            ...<br><span class="segmentSeparator"></span>        <span class="tag">&lt;/icfc:configurationProperties&gt;</span>
    <span class="tag">&lt;/connectorConfiguration&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/resource&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The use of namespaces will be completely optional in later midPoint versions.<br><span class="segmentSeparator"></span>For now just copy the namespace URIs from the samples.<br><span class="segmentSeparator"></span>You do not have to completely understand what is going on.<br><span class="segmentSeparator"></span>Just one thing: the namespace of the configuration properties should be the same as the namespace defined in the connector object.<br><span class="segmentSeparator"></span>This is a long URI that is composed from connector bundle name and connector name.<br><span class="segmentSeparator"></span>E.g.</p>
</div>
<div class="paragraph">
<p><code><a href="http://midpoint.evolveum.com/%E2%81%A0xml/%E2%81%A0ns/%E2%81%A0public/%E2%81%A0connector/%E2%81%A0icf-%E2%81%A01/%E2%81%A0bundle/%E2%81%A0com.evolveum.polygon.connector-%E2%81%A0ldap/%E2%81%A0com.evolveum.polygon.connector.ldap.LdapConnector" class="bare">http://⁠midpoint.evolveum.com/⁠xml/⁠ns/⁠public/⁠connector/⁠icf-⁠1/⁠bundle/⁠com.evolveum.polygon.connector-⁠ldap/⁠com.evolveum.polygon.connector.ldap.LdapConnector</a></code></p>
</div>
<div class="paragraph">
<p>If the namespace does not match then the connector will refuse to work.<br><span class="segmentSeparator"></span>This is a safety mechanism that prohibits accidental use of configuration from one connector in another connector where the configuration properties may have the same name but a completely different meaning.</p>
</div>
</div>
<div class="sect2">
<h3 id="_testing_the_resource">Testing the Resource</h3>
<div class="paragraph">
<p>Minimal resource definition has just the name, connector reference and connector configuration properties.<br><span class="segmentSeparator"></span>After that the resource should show the first signs of life.<br><span class="segmentSeparator"></span>Therefore select a suitable sample file now.<br><span class="segmentSeparator"></span>Strip it down to the minimum, modify connector configuration properties and import the resource into midPoint.<br><span class="segmentSeparator"></span>You should be able to see your resource in the list in <em>Resources &gt; List resources</em>.<br><span class="segmentSeparator"></span>The icon next to your resource is most likely black - not green and not red.<br><span class="segmentSeparator"></span>Green icon means that the resource is working, red icon means that there is an error, black means "I do not know yet".<br><span class="segmentSeparator"></span>Click on the resource label.<br><span class="segmentSeparator"></span>Resource details page should appear.<br><span class="segmentSeparator"></span>There is a <em>Test Connection</em> button at the bottom of the page.<br><span class="segmentSeparator"></span>Click on that button.<br><span class="segmentSeparator"></span>It may take a while now.<br><span class="segmentSeparator"></span>MidPoint is initializing the connector with the configuration properties that you have specified.<br><span class="segmentSeparator"></span>Then the connector will be used to check connection to the resource.<br><span class="segmentSeparator"></span>If the parameters were correct and midPoint can reach the resource you will see green lights:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/04-02-test-resource.png" alt="Test resource">
</div>
</div>
<div class="paragraph">
<p>If there are any errors during connector initialization, configuration or network connection you will see the errors here.<br><span class="segmentSeparator"></span>In that case correct the configuration properties and try again.<br><span class="segmentSeparator"></span>If everything works well then the resource icon turns green.<br><span class="segmentSeparator"></span>Now we have a minimal working resource.</p>
</div>
<div class="paragraph">
<p>There are few more things that you can do with such a minimal resource.<br><span class="segmentSeparator"></span>For example you can look at the resource content.<br><span class="segmentSeparator"></span>Navigate to the resource details page and switch to <em>Uncategorized</em> tab.<br><span class="segmentSeparator"></span>Select one of the object classes that the resource supports.<br><span class="segmentSeparator"></span>Just click inside the <em>Object class</em> input box and the suggestions will appear.<br><span class="segmentSeparator"></span>Now click on the <em>Resource</em> button on the right side.<br><span class="segmentSeparator"></span>MidPoint connects to the resource, lists all the objects of the given object class and displays the list.<br><span class="segmentSeparator"></span>Now you can click on any object to see the details.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/04-03-list-accounts.png" alt="List resource account">
</div>
</div>
<div class="paragraph">
<p>That is a very useful feature for several reasons.<br><span class="segmentSeparator"></span>Firstly, you can check that not just the resource connection works, but that the connector can actually retrieve the objects.<br><span class="segmentSeparator"></span>Secondly, you will get some idea about the object classes that the resource supports.<br><span class="segmentSeparator"></span>And thirdly, by looking at several objects you can get basic overview of how the data are structured: what attributes are used and what are the typical values.<br><span class="segmentSeparator"></span>You will appreciate that information later on when we will be setting up mappings.</p>
</div>
</div>
<div class="sect2">
<h3 id="_resource_schema_basics">Resource Schema Basics</h3>
<div class="paragraph">
<p>The only resource object that early identity management systems dealt with was an <em>account</em>.<br><span class="segmentSeparator"></span>That is not sufficient any more.<br><span class="segmentSeparator"></span>Good identity management system needs to manage may different types of resource objects: accounts, groups, organizational units, privileges, roles, access control lists and so on.<br><span class="segmentSeparator"></span>In midPoint these are the <em>object classes</em>: types of resource objects that are made accessible to midPoint by the connector.<br><span class="segmentSeparator"></span>A minimal resource supports at least the <em>account</em> object class, but a typical resource supports more object classes.<br><span class="segmentSeparator"></span>Each object class may have a completely different set of attributes: different names, different types, some may be mandatory, some optional.</p>
</div>
<div class="paragraph">
<p>The collective definition of the object classes and their attributes is what we call <em>resource schema</em>.<br><span class="segmentSeparator"></span>Obviously, resource schema is different for every resource.<br><span class="segmentSeparator"></span>Even resources that are using the same connector may have different resource schema (e.g.<br><span class="segmentSeparator"></span>two LDAP servers with different custom schema extensions).<br><span class="segmentSeparator"></span>MidPoint is a smart system and it is capable of automatic resource schema discovery.<br><span class="segmentSeparator"></span>MidPoint will reach out to the resource and retrieve the schema when the resource is used for the first time.<br><span class="segmentSeparator"></span>Retrieved resource schema is stored under the schema tag in resource definition object.<br><span class="segmentSeparator"></span>You can have a look and examine the schema there.<br><span class="segmentSeparator"></span>But beware, the schema may be quite rich and big.</p>
</div>
<div class="paragraph">
<p>Resource schema is absolutely crucial concept.<br><span class="segmentSeparator"></span>MidPoint takes advantage of resource schema whenever it needs to work with resource objects such as accounts or groups.<br><span class="segmentSeparator"></span>MidPoint uses resource schema to validate mappings.<br><span class="segmentSeparator"></span>The schema is used for automatic type conversions.<br><span class="segmentSeparator"></span>And most importantly of all: resource schema is used to display resource objects in user interface.<br><span class="segmentSeparator"></span>MidPoint adapts to resource schema automatically.<br><span class="segmentSeparator"></span>Not a single line of custom code is needed to do that.</p>
</div>
</div>
<div class="sect2">
<h3 id="_hub_and_spoke">Hub and Spoke</h3>
<div class="paragraph">
<p>MidPoint topology is a star (a.k.a.<br><span class="segmentSeparator"></span>"hub and spoke") with midPoint at the center.<br><span class="segmentSeparator"></span>This is both physical and logical topology of midPoint deployments.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/04-04-hub-and-spoke.png" alt="Hub and spoke">
</div>
</div>
<div class="paragraph">
<p>This means that the <em>account A</em> can be synchronized with midPoint user and then midPoint user can be synchronized with <em>account B</em>.<br><span class="segmentSeparator"></span>But <em>account A</em> cannot be synchronized directly to <em>account B</em>.<br><span class="segmentSeparator"></span>This is deliberate decision that was made very early in midPoint design and we have very good reasons for it.</p>
</div>
<div class="paragraph">
<p><em>Accounts</em> and user that represent the same person are <em>linked</em> together.<br><span class="segmentSeparator"></span>This <em>link</em> is a relation that midPoint creates and maintains.<br><span class="segmentSeparator"></span>Therefore midPoint knows who is the owner of a particular account.<br><span class="segmentSeparator"></span>MidPoint also knows which accounts the user has.<br><span class="segmentSeparator"></span>That is how midPoint knows which account needs to be synchronized with which user.<br><span class="segmentSeparator"></span>It is critical for the links to be correct otherwise midPoint cannot reliably synchronize the data.<br><span class="segmentSeparator"></span>Therefore midPoint takes great care to maintain the links.<br><span class="segmentSeparator"></span>And that is not always an easy task.<br><span class="segmentSeparator"></span>There are strange corner cases such as renamed accounts or accounts that were deleted by mistake and re-created.<br><span class="segmentSeparator"></span>But midPoint is built to handle such cases.<br><span class="segmentSeparator"></span>The links are always maintained.<br><span class="segmentSeparator"></span>And it is the link that allows midPoint to list all user’s accounts in the user interface.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/04-05-user-bob-projections.png" alt="Projections">
</div>
</div>
<div class="paragraph">
<p>The user in midPoint is known as <em>focus</em> in midPoint terminology.<br><span class="segmentSeparator"></span>The accounts are known as <em>projections</em>.<br><span class="segmentSeparator"></span>You can imagine a light projector that sends many light beams from its focal point to create a projection on the screen.<br><span class="segmentSeparator"></span>This is the metaphor that we have chosen when building midPoint.<br><span class="segmentSeparator"></span>And for the lack of better words this terminology remains in use even now.<br><span class="segmentSeparator"></span>We will get back to the concept of focus and projections many times in this book.<br><span class="segmentSeparator"></span>For now you just need to remember that <em>projection</em> means an <em>account</em>.</p>
</div>
<div class="paragraph">
<p>MidPoint knows which account belongs to which user by following links that it maintains.<br><span class="segmentSeparator"></span>But how does midPoint know which attributes to synchronize?<br><span class="segmentSeparator"></span>How to transform the values?<br><span class="segmentSeparator"></span>And which side is the authoritative one?<br><span class="segmentSeparator"></span>Mappings take care of that.<br><span class="segmentSeparator"></span>Mapping is like a flexible data replication recipe.<br><span class="segmentSeparator"></span>MidPoint allows to define mappings for each attribute in any direction.<br><span class="segmentSeparator"></span>The mappings are used to control the synchronization on a very fine granularity.</p>
</div>
<div class="paragraph">
<p>Perhaps the best way to summarize synchronization principles is to illustrate them using a couple of examples.<br><span class="segmentSeparator"></span>The first example is a modification of user properties in midPoint user interface.<br><span class="segmentSeparator"></span>When the Save button is pressed then midPoint user interface sends the modification to midPoint core engine.<br><span class="segmentSeparator"></span>The synchronization code in midPoint core follows the links to find all the accounts that belong to this specific user.<br><span class="segmentSeparator"></span>Then the mappings are applied to synchronize the changed user properties to the accounts.<br><span class="segmentSeparator"></span>Account changes are propagated to the resources and user changes are stored in midPoint repository.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/04-06-user-account-gui.png" alt="User-account GUI change">
</div>
</div>
<div class="paragraph">
<p>The second example is slightly different.<br><span class="segmentSeparator"></span>This case starts with a change of account data.<br><span class="segmentSeparator"></span>This may be a change of an employee record in HR system.<br><span class="segmentSeparator"></span>MidPoint detects that change and reads the changed account.<br><span class="segmentSeparator"></span>MidPoint follows the link to find the user to which the account belongs.<br><span class="segmentSeparator"></span>Then it follows other links from the user to find all the other accounts that may be affected.<br><span class="segmentSeparator"></span>Similarly to the previous case the mappings are applied.<br><span class="segmentSeparator"></span>The mappings from the HR account to the user are applied first.<br><span class="segmentSeparator"></span>The result is a modification of user properties.<br><span class="segmentSeparator"></span>Then an process identical to the previous case takes place.<br><span class="segmentSeparator"></span>User modifications are automatically applied to all affected accounts.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/04-07-user-account-inbound.png" alt="User-account GUI inbound mapping">
</div>
</div>
<div class="paragraph">
<p>Those two cases look to be quite different.<br><span class="segmentSeparator"></span>First case is a manual change of data by system administrator.<br><span class="segmentSeparator"></span>Second case is an automatic data feed from the HR system.<br><span class="segmentSeparator"></span>But as you can see the principles that are used to implement those two cases are almost exactly the same.<br><span class="segmentSeparator"></span>This is the consequence of midPoint philosophy: radical reuse of functionality and generic application of principles.<br><span class="segmentSeparator"></span>You just need to define what you want to do (the policy).<br><span class="segmentSeparator"></span>MidPoint takes care that it is done when it needs to be done.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Why the star topology?</div>
The star or "hub and spoke" were (and still are) the big buzzwords of system integration.<br><span class="segmentSeparator"></span>And the basic idea makes a lot of sense.<br><span class="segmentSeparator"></span>If every node needs to be synchronized with every other node then the number of required connections grows quite steeply.<br><span class="segmentSeparator"></span>It is in fact proportional to the square of the number of nodes.<br><span class="segmentSeparator"></span>Mathematicians say that is has O(n<sup>2</sup>) complexity.<br><span class="segmentSeparator"></span>However, if you rearrange the connections so that they all point to the central "hub" then the number of connections is significantly reduced.<br><span class="segmentSeparator"></span>It is proportional to the number of nodes: O(n) complexity.<br><span class="segmentSeparator"></span>This is a huge difference, especially in deployments with many resources.<br><span class="segmentSeparator"></span>However, this approach works well only if the star topology is both physical and logical.<br><span class="segmentSeparator"></span>I.e.<br><span class="segmentSeparator"></span>it makes very little sense to connect all resources to a central “hub” if that hub still internally needs O(n<sup>2</sup>) policies to synchronize the data.<br><span class="segmentSeparator"></span>That would only hide the complexity in a black box, but the complexity is still there.<br><span class="segmentSeparator"></span>However, midPoint is different.<br><span class="segmentSeparator"></span>MidPoint is a real "hub".<br><span class="segmentSeparator"></span>This is the reason why midPoint does not support synchronization of accounts directly with each other.<br><span class="segmentSeparator"></span>We want to have simple, clean and maintainable system, both externally and internally.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_schema_handling">Schema Handling</h3>
<div class="paragraph">
<p>Resource schema is a very important concept.<br><span class="segmentSeparator"></span>It defines what object classes are supported by the resource and how they look like.<br><span class="segmentSeparator"></span>But it is not important to know only how the objects look like.<br><span class="segmentSeparator"></span>It is also important to know what to do with them.<br><span class="segmentSeparator"></span>And that is what the <em>schema handling</em> is all about.</p>
</div>
<div class="paragraph">
<p><em>Schema handling</em> is a part of resource definition object.<br><span class="segmentSeparator"></span>It specifies which object classes from the resource schema are actually used by midPoint.<br><span class="segmentSeparator"></span>And most importantly of all it specifies how they are used.<br><span class="segmentSeparator"></span>This is the place where mappings are stored.<br><span class="segmentSeparator"></span>This is the place where account-group associations are defined.<br><span class="segmentSeparator"></span>This is the place where schema can be augmented and tweaked.<br><span class="segmentSeparator"></span>Simply speaking, this is the place where most of the resource-related configuration takes place.</p>
</div>
<div class="paragraph">
<p><em>Schema handling</em> section contains definition of several <em>object types</em>.<br><span class="segmentSeparator"></span>Each <em>object type</em> refers to one "thing" that midPoint works with: default account, testing account, group, organizational unit and so on.<br><span class="segmentSeparator"></span>Let’s start with something simple and let’s define just one object type now: default account.<br><span class="segmentSeparator"></span>It looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;resource</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">b4101662-7902-11e6-9f14-53e18426fe81</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>My LDAP Server<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;schemaHandling&gt;</span>
        <span class="tag">&lt;objectType&gt;</span>
            <span class="tag">&lt;kind&gt;</span>account<span class="tag">&lt;/kind&gt;</span>
            <span class="tag">&lt;default&gt;</span>true<span class="tag">&lt;/default&gt;</span>
            <span class="tag">&lt;objectClass&gt;</span>ri:inetOrgPerson<span class="tag">&lt;/objectClass&gt;</span>
        <span class="tag">&lt;/objectType&gt;</span>
    <span class="tag">&lt;/schemaHandling&gt;</span>
<span class="tag">&lt;/resource&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This may seem trivial, but even such a minimal definition is important for midPoint.<br><span class="segmentSeparator"></span>This definition tells midPoint that default account on this resource has <code>inetOrgPerson</code> object class.<br><span class="segmentSeparator"></span>Resources such as LDAP servers may have dozens of object classes.<br><span class="segmentSeparator"></span>Most of them are not used at all.<br><span class="segmentSeparator"></span>There are often several alternative object classes that can be used to create accounts.<br><span class="segmentSeparator"></span>It is important to tell midPoint which object class is the right one.<br><span class="segmentSeparator"></span>And that’s what this definition does.<br><span class="segmentSeparator"></span>Once this definition is in place, the accounts appear on the <em>Accounts</em> tab of the resource details page (they were visible only on the <em>Generics</em> tab before).<br><span class="segmentSeparator"></span>This is a sign that the definition works correctly.</p>
</div>
<div class="paragraph">
<p>A clever reader surely noticed definition of <em>kind</em> in the above example.<br><span class="segmentSeparator"></span>Setting <em>kind</em> to <code>account</code> indicates that this object type definition represents (surprisingly) an account.<br><span class="segmentSeparator"></span>MidPoint supports many types of objects.<br><span class="segmentSeparator"></span>But two types have a special place: <em>accounts</em> that represents the users and <em>entitlements</em> that give privileges to accounts.<br><span class="segmentSeparator"></span>MidPoint can handle the objects in a smart way if it knows that it is either account or entitlement.<br><span class="segmentSeparator"></span>And the <em>kind</em> definition tells just that.<br><span class="segmentSeparator"></span>There is also optional <em>intent</em> setting that can be used to define subtypes.<br><span class="segmentSeparator"></span>But more on that later.</p>
</div>
<div class="paragraph">
<p>The schema handling section can also be used to augment (or even override) some parts of the resource schema.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>following example sets a display name for this object type.<br><span class="segmentSeparator"></span>The display name will be used by the user interface when it displays the account.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;resource</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">b4101662-7902-11e6-9f14-53e18426fe81</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>My LDAP Server<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;schemaHandling&gt;</span>
        <span class="tag">&lt;objectType&gt;</span>
            <span class="tag">&lt;kind&gt;</span>account<span class="tag">&lt;/kind&gt;</span>
            <span class="tag">&lt;displayName&gt;</span>Default account<span class="tag">&lt;/displayName&gt;</span>
            <span class="tag">&lt;default&gt;</span>true<span class="tag">&lt;/default&gt;</span>
            <span class="tag">&lt;objectClass&gt;</span>ri:inetOrgPerson<span class="tag">&lt;/objectClass&gt;</span>
        <span class="tag">&lt;/objectType&gt;</span>
    <span class="tag">&lt;/schemaHandling&gt;</span>
<span class="tag">&lt;/resource&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, the most powerful feature that is used in the schema handling is the ability to deal with attributes.<br><span class="segmentSeparator"></span>Following sections are all about that.</p>
</div>
</div>
<div class="sect2">
<h3 id="_attribute_handling">Attribute Handling</h3>
<div class="paragraph">
<p>Resource objects such as accounts or groups are mostly just a bunch of attributes.<br><span class="segmentSeparator"></span>Almost all of the IDM magic is about setting the correct attribute to the correct value.<br><span class="segmentSeparator"></span>The schema handling section of the resource definition is the place where the basic attribute behavior is defined.</p>
</div>
<div class="paragraph">
<p>The object type definition contains sections that define behavior of each attribute that we care about:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;resource</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">b4101662-7902-11e6-9f14-53e18426fe81</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>My LDAP Server<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;schemaHandling&gt;</span>
        <span class="tag">&lt;objectType&gt;</span>
            <span class="tag">&lt;kind&gt;</span>account<span class="tag">&lt;/kind&gt;</span>
            <span class="tag">&lt;default&gt;</span>true<span class="tag">&lt;/default&gt;</span>
            <span class="tag">&lt;objectClass&gt;</span>ri:inetOrgPerson<span class="tag">&lt;/objectClass&gt;</span>
            <span class="tag">&lt;attribute&gt;</span>
                <span class="tag">&lt;ref&gt;</span>ri:dn<span class="tag">&lt;/ref&gt;</span>
                <span class="comment">&lt;!-- behavior of "dn" attribute defined here --&gt;</span>
            <span class="tag">&lt;/attribute&gt;</span>
            <span class="tag">&lt;attribute&gt;</span>
                <span class="tag">&lt;ref&gt;</span>ri:cn<span class="tag">&lt;/ref&gt;</span>
                <span class="comment">&lt;!-- behavior of "cn" attribute defined here --&gt;</span>
            <span class="tag">&lt;/attribute&gt;</span>
            ...<br><span class="segmentSeparator"></span>        <span class="tag">&lt;/objectType&gt;</span>
    <span class="tag">&lt;/schemaHandling&gt;</span>
<span class="tag">&lt;/resource&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There is an <code>attribute</code> element for every attribute that we need.<br><span class="segmentSeparator"></span>Lot of details can be defined here: display name of the attribute that will be used by the user interface, limitations and schema augmentation, override settings and so on.<br><span class="segmentSeparator"></span>But the most important things that go there are the mappings.<br><span class="segmentSeparator"></span>In the simplest form a mapping looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;resource</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">b4101662-7902-11e6-9f14-53e18426fe81</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>My LDAP Server<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;schemaHandling&gt;</span>
        <span class="tag">&lt;objectType&gt;</span>
            <span class="tag">&lt;kind&gt;</span>account<span class="tag">&lt;/kind&gt;</span>
            <span class="tag">&lt;default&gt;</span>true<span class="tag">&lt;/default&gt;</span>
            <span class="tag">&lt;objectClass&gt;</span>ri:inetOrgPerson<span class="tag">&lt;/objectClass&gt;</span>
            ...<br><span class="segmentSeparator"></span>            <span class="tag">&lt;attribute&gt;</span>
                <span class="tag">&lt;ref&gt;</span>ri:cn<span class="tag">&lt;/ref&gt;</span>
                <span class="tag">&lt;outbound&gt;</span>
                    <span class="tag">&lt;source&gt;</span>
                        <span class="tag">&lt;path&gt;</span>$focus/fullName<span class="tag">&lt;/path&gt;</span>
                    <span class="tag">&lt;/source&gt;</span>
                <span class="tag">&lt;/outbound&gt;</span>
            <span class="tag">&lt;/attribute&gt;</span>
            ...<br><span class="segmentSeparator"></span>        <span class="tag">&lt;/objectType&gt;</span>
    <span class="tag">&lt;/schemaHandling&gt;</span>
<span class="tag">&lt;/resource&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This means that the value of the cn attribute will be taken from the <code>fullName</code> property of the focal object (which is typically a user).<br><span class="segmentSeparator"></span>This a very simple mapping, there is no value transformation, no condition – nothing complicated at all.<br><span class="segmentSeparator"></span>This is how a lot of mappings look like.<br><span class="segmentSeparator"></span>But mappings can also be very powerful and complex.<br><span class="segmentSeparator"></span>That will be described in next section.</p>
</div>
<div class="paragraph">
<p>The <code>attribute</code> sections are used to set up the attributes that a typical user account on the resource has.<br><span class="segmentSeparator"></span>Those will assign identifiers, set up full name, set description and telephone number attributes and things like that.<br><span class="segmentSeparator"></span>It is a very convenient approach to have this directly in the resource definition.<br><span class="segmentSeparator"></span>We can simply assign the accounts to the user without specifying any details.<br><span class="segmentSeparator"></span>MidPoint evaluates the mappings in <code>attribute</code> sections to populate account attributes with the correct values.<br><span class="segmentSeparator"></span>Now it is perhaps a good time to have a look at some sample resource definitions to get a feel how a real-world resource definition looks like.<br><span class="segmentSeparator"></span>The samples are located in the midPoint distribution package or you can find them on-line.<br><span class="segmentSeparator"></span>See <a href="https://docs.evolveum.com/book/practical-identity-management-with-midpoint.html#92-additional-information">Additional Information</a> chapter for more details.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">The "ri" namespace.</div>
You may have noticed that "ri" namespace prefix is used whenever we refer to the object classes or attributes.<br><span class="segmentSeparator"></span>In a strict sense this is the correct notation.<br><span class="segmentSeparator"></span>Object classes and attributes are defined in resource schema and the "ri" is the namespace of that schema.<br><span class="segmentSeparator"></span>While the use of namespaces should be optional in almost all parts of midPoint, we are still using the "ri" namespace in samples.<br><span class="segmentSeparator"></span>Mostly due to the nostalgic reasons.<br><span class="segmentSeparator"></span>By the way, "ri" stands for "resource instance".<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_mappings">Mappings</h3>
<div class="paragraph">
<p>Mapping is a very flexible mechanism that takes one or more input properties, transforms them and puts the result in another property.<br><span class="segmentSeparator"></span>Mappings are used all over midPoint.<br><span class="segmentSeparator"></span>But perhaps the most important use of mappings is in the schema handling part of the resource definition where they set up account attribute values.<br><span class="segmentSeparator"></span>We have already seen a very simple mapping that simply copies the values from one place to another.<br><span class="segmentSeparator"></span>Now it is the time to look at mapping in its entirety.</p>
</div>
<div class="paragraph">
<p>Mapping consists of the three basic parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Source</strong> part defines the data sources of the mapping.<br><span class="segmentSeparator"></span>These are usually understood as mapping input variables.<br><span class="segmentSeparator"></span>Source defines where mapping gets its data from.</p>
</li>
<li>
<p><strong>Expression</strong> part defines how the data are transformed, generated or passed on to the "other side".<br><span class="segmentSeparator"></span>This is the most flexible part of the mapping as it contains the logic.<br><span class="segmentSeparator"></span>There is a broad variety of possibilities, including support for scripting expressions.</p>
</li>
<li>
<p><strong>Target</strong> part defines what to do with the results of the mapping, where the computed values should go.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The three parts of the mapping as well as the basic principle is illustrated in the following diagram:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/04-08-mapping.png" alt="Mapping">
</div>
</div>
<div class="paragraph">
<p>The diagram shows a mapping that takes <code>employeeNumber</code> user property and transforms it to <code>description</code> account attribute by using a simple Groovy script expression.</p>
</div>
<div class="paragraph">
<p>The <code>source</code> part of the mapping defines that there is a single source which is based on <code>employeeNumber</code> user property.<br><span class="segmentSeparator"></span>Source definitions are important for the mapping to correctly process relative changes (deltas), mapping dependencies, etc.<br><span class="segmentSeparator"></span>The source definition tells mapping that the value of <code>employeeNumber</code> user property should be passed to an expression.</p>
</div>
<div class="paragraph">
<p>The <code>expression</code> part contains a simple Groovy script that prepends the prefix <code>emp#</code> to the employee number value specified by the source definition.<br><span class="segmentSeparator"></span>The <code>expression</code> part of the mapping is very flexible and there is a lot of ways that can be used to transform a value, generate new value, use a fixed value, pass a value without any change and so on.</p>
</div>
<div class="paragraph">
<p>The <code>target</code> part defines how the result of the expression should be used.<br><span class="segmentSeparator"></span>In this case the result is to be used as a <code>description</code> account attribute.<br><span class="segmentSeparator"></span>The <code>target</code> definition is necessary so the mapping can locate appropriate definition of the target property and therefore make sure that the expression produces a correct data type and that other schema constraints are maintained (e.g.<br><span class="segmentSeparator"></span>single vs multiple values).</p>
</div>
<div class="paragraph">
<p>This mapping can be expressed in XML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;mapping&gt;</span>
    <span class="tag">&lt;source&gt;</span>
        <span class="tag">&lt;path&gt;</span>$focus/employeeNumber<span class="tag">&lt;/path&gt;</span>
    <span class="tag">&lt;/source&gt;</span>
    <span class="tag">&lt;expression&gt;</span>
        <span class="tag">&lt;script&gt;</span>
<span class="inline">            <span class="tag">&lt;code&gt;</span>'emp#' + employeeNumber<span class="tag">&lt;/code&gt;</span></span>
        <span class="tag">&lt;/script&gt;</span>
    <span class="tag">&lt;/expression&gt;</span>
    <span class="tag">&lt;target&gt;</span>
        <span class="tag">&lt;path&gt;</span>$projection/attributes/description<span class="tag">&lt;/path&gt;</span>
    <span class="tag">&lt;/target&gt;</span>
<span class="tag">&lt;/mapping&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Not all parts of the mapping are mandatory.<br><span class="segmentSeparator"></span>If the expression is not present then "as is" expression is assumed.<br><span class="segmentSeparator"></span>Such expression simply copies the source to target without any transformation.<br><span class="segmentSeparator"></span>Some parts of the mapping may be implicitly defined by the surrounding context.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>target or source is implicit if the mapping is used to define attribute behavior in the schema handling section.<br><span class="segmentSeparator"></span>Therefore it is usually sufficient to define either source or target for mappings in <code>schemaHandling</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;schemaHandling&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;attribute&gt;</span>
        <span class="tag">&lt;ref&gt;</span>ri:sn<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;outbound&gt;</span>
             <span class="tag">&lt;source&gt;</span>
                  <span class="tag">&lt;path&gt;</span>$focus/familyName<span class="tag">&lt;/path&gt;</span>
            <span class="tag">&lt;/source&gt;</span>
        <span class="tag">&lt;/outbound&gt;</span>
    <span class="tag">&lt;/attribute&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/schemaHandling&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the notation that you have seen in the previous section.<br><span class="segmentSeparator"></span>Mapping source is explicitly specified as the <code>familyName</code> property of the user.<br><span class="segmentSeparator"></span>Mapping target is implicitly set to be the attribute for which the mapping is defined.<br><span class="segmentSeparator"></span>As no expression is explicitly defined it defaults to a simple copy of the value without any transformation (<code>asIs</code>).</p>
</div>
<div class="paragraph">
<p>Mapping notation can even be shortened a bit more in this case.<br><span class="segmentSeparator"></span>It is quite clear that the mapping source will be one of the properties of the focal object (user).<br><span class="segmentSeparator"></span>Therefore the <code>$focus</code> prefix can be omitted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;schemaHandling&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;attribute&gt;</span>
        <span class="tag">&lt;ref&gt;</span>ri:sn<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;outbound&gt;</span>
            <span class="tag">&lt;source&gt;</span>
                 <span class="tag">&lt;path&gt;</span>familyName<span class="tag">&lt;/path&gt;</span>
            <span class="tag">&lt;/source&gt;</span>
        <span class="tag">&lt;/outbound&gt;</span>
    <span class="tag">&lt;/attribute&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/schemaHandling&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Those examples are still very simple.<br><span class="segmentSeparator"></span>Mappings can do much more – as you will learn later on.<br><span class="segmentSeparator"></span>But there is one more thing that we need to explain here.<br><span class="segmentSeparator"></span>Mappings are designed to work with more than just a single source.<br><span class="segmentSeparator"></span>Following diagram illustrates a mapping that takes two arguments: given name and family name.<br><span class="segmentSeparator"></span>The mapping produces full name by concatenating these value with a space in between.<br><span class="segmentSeparator"></span>This is the kind of mapping that is frequently used to construct user’s full name from its components.<br><span class="segmentSeparator"></span>While the mapping may seem simple there are some sophisticated mechanisms hidden inside.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/04-09-mapping-multisource.png" alt="Mapping with two sources">
</div>
</div>
<div class="paragraph">
<p>The mapping is represented in the XML form as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;mapping&gt;</span>
    <span class="tag">&lt;source&gt;</span>
        <span class="tag">&lt;path&gt;</span>givenName<span class="tag">&lt;/path&gt;</span>
    <span class="tag">&lt;/source&gt;</span>
    <span class="tag">&lt;source&gt;</span>
        <span class="tag">&lt;path&gt;</span>familyName<span class="tag">&lt;/path&gt;</span>
    <span class="tag">&lt;/source&gt;</span>
    <span class="tag">&lt;expression&gt;</span>
        <span class="tag">&lt;script&gt;</span>
<span class="inline">            <span class="tag">&lt;code&gt;</span>givenName + ' ' + familyName<span class="tag">&lt;/code&gt;</span></span>
        <span class="tag">&lt;/script&gt;</span>
    <span class="tag">&lt;/expression&gt;</span>
    <span class="tag">&lt;target&gt;</span>
        <span class="tag">&lt;path&gt;</span>fullName<span class="tag">&lt;/path&gt;</span>
    <span class="tag">&lt;/target&gt;</span>
<span class="tag">&lt;/mapping&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are two sources specified by the source definitions: user property <code>givenName</code> and another user property <code>familyName</code>.<br><span class="segmentSeparator"></span>The mapping is using <em>script expression</em> to combine the values into a single value which is used to populate user’s <code>fullName</code> property.</p>
</div>
<div class="paragraph">
<p>This example also illustrates that the mappings are smart.<br><span class="segmentSeparator"></span>The mapping may be evaluated only if one of the sources changes or if a full recompute is requested.<br><span class="segmentSeparator"></span>In case that neither <code>givenName</code> not <code>familyName</code> changes there is no need to re-evaluate that expression.<br><span class="segmentSeparator"></span>This is one of the reasons for requiring explicit source definition in the mappings.<br><span class="segmentSeparator"></span>Without such definitions it is not (realistically) possible to reliably determine when and how the expression should be re-evaluated.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title"><code>$user</code> and <code>$account</code> variables.</div>
Variables <code>$focus</code> and <code>$projection</code> were introduced in midPoint 3.0 as a consequence of the generic synchronization feature.<br><span class="segmentSeparator"></span>The objects that the expression works with might not be just user or account.<br><span class="segmentSeparator"></span>A much broader range of objects may be used.<br><span class="segmentSeparator"></span>Therefore generic concepts of focus and projections were introduced and the variable names were changed to reflect that.<br><span class="segmentSeparator"></span>The old variables <code>$user</code> and <code>$account</code> can still be used, but their use is deprecated.<br><span class="segmentSeparator"></span>Despite that they are still used in some older examples.<br><span class="segmentSeparator"></span>It is never easy to completely eliminate the burden of history, is it?<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Mappings are used all over midPoint, in many places and situations.<br><span class="segmentSeparator"></span>Sometimes a mapping needs to be really authoritative.<br><span class="segmentSeparator"></span>It has to enforce the value to the target.<br><span class="segmentSeparator"></span>But sometimes we want to provide a default value and the mapping should never change the target value once it is set.<br><span class="segmentSeparator"></span>Therefore mapping can be set to various levels of <em>strength</em>: from weak to strong.<br><span class="segmentSeparator"></span>Following table describes how that works:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Strength</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>weak</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapping is applied only if the target has no value.<br><span class="segmentSeparator"></span>Weak mappings are usually used to set <em>default values</em>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>normal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapping is applied only if there is a change in source properties.<br><span class="segmentSeparator"></span>Normal-strength mappings are used to implement the <em>last change wins</em> strategy.<br><span class="segmentSeparator"></span>If the value was modified in midPoint then the mapping is applied and target is modified.<br><span class="segmentSeparator"></span>If the target is modified directly then the mapping does not overwrite the target value – until the next change in midPoint.<br><span class="segmentSeparator"></span>This is the default behavior of mappings.<br><span class="segmentSeparator"></span>If no strength is specified then <code>normal</code> is assumed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>strong</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mapping is always applied.<br><span class="segmentSeparator"></span>Strong mappings <em>enforce</em> particular values.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The strength can be specified in any mapping by using the <code>strength</code> tag:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;attribute&gt;</span>
    <span class="tag">&lt;ref&gt;</span>ri:sn<span class="tag">&lt;/ref&gt;</span>
    <span class="tag">&lt;outbound&gt;</span>
        <span class="tag">&lt;strength&gt;</span>strong<span class="tag">&lt;/strength&gt;</span>
        <span class="tag">&lt;source&gt;</span>
             <span class="tag">&lt;path&gt;</span>$focus/familyName<span class="tag">&lt;/path&gt;</span>
        <span class="tag">&lt;/source&gt;</span>
    <span class="tag">&lt;/outbound&gt;</span>
<span class="tag">&lt;/attribute&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When it comes to mapping strength then the following rule of the thumb may be useful: If you want to enforce policy use <em>strong</em> mappings.<br><span class="segmentSeparator"></span>If you just want to set a default value use <em>weak</em> mapping.<br><span class="segmentSeparator"></span>If you are not sure what you are doing then <em>normal</em> mappings will probably work just fine.</p>
</div>
</div>
<div class="sect2">
<h3 id="_expressions">Expressions</h3>
<div class="paragraph">
<p>Expression is the most flexible part of the mapping.<br><span class="segmentSeparator"></span>There are approximately dozen different type of expressions ranging from the simplest <em>as is</em> expression through the <em>scripting expressions</em> all the way to a special purpose expressions that search through midPoint repository.<br><span class="segmentSeparator"></span>Expression type is determined by the element that is used inside the <code>expression</code> section of the mapping.<br><span class="segmentSeparator"></span>We refer to those elements as <em>expression evaluators</em>.<br><span class="segmentSeparator"></span>You can find detailed description of expression evaluators in midPoint Wiki.<br><span class="segmentSeparator"></span>We are going to deal only with few types that are most frequently used now:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Expression Evaluator</th>
<th class="tableblock halign-left valign-top">Element</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">As is</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>asIs</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Copies the value without any transformation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Literal</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>value</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Stores literal (constant) value in the target.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generate</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>generate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generates a random value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Script</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>script</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Executes a script, stores script output in the target.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The simplest expression evaluator is <code>asIs</code>.<br><span class="segmentSeparator"></span>It simply takes the source and copies that to the target.<br><span class="segmentSeparator"></span>It obviously works only if there is just one source.<br><span class="segmentSeparator"></span>It is also the default expression evaluator.<br><span class="segmentSeparator"></span>If no expression is specified in the mapping then <code>asIs</code> is assumed.<br><span class="segmentSeparator"></span>It is used like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;attribute&gt;</span>
    <span class="tag">&lt;ref&gt;</span>ri:sn<span class="tag">&lt;/ref&gt;</span>
    <span class="tag">&lt;outbound&gt;</span>
        <span class="tag">&lt;source&gt;</span>
             <span class="tag">&lt;path&gt;</span>familyName<span class="tag">&lt;/path&gt;</span>
        <span class="tag">&lt;/source&gt;</span>
        <span class="tag">&lt;expression&gt;</span>
            <span class="tag">&lt;asIs</span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/expression&gt;</span>
    <span class="tag">&lt;/outbound&gt;</span>
<span class="tag">&lt;/attribute&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Literal expression evaluator is used to place a constant value in the target.<br><span class="segmentSeparator"></span>This expression does not need any source at all.<br><span class="segmentSeparator"></span>It always produces the same value.<br><span class="segmentSeparator"></span>It looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;attribute&gt;</span>
    <span class="tag">&lt;ref&gt;</span>ri:o<span class="tag">&lt;/ref&gt;</span>
    <span class="tag">&lt;outbound&gt;</span>
        <span class="tag">&lt;expression&gt;</span>
            <span class="tag">&lt;value&gt;</span>ExAmPLE, Inc.<span class="tag">&lt;/value&gt;</span>
        <span class="tag">&lt;/expression&gt;</span>
    <span class="tag">&lt;/outbound&gt;</span>
<span class="tag">&lt;/attribute&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>generate</code> expression evaluator is used to generate a random value.<br><span class="segmentSeparator"></span>As such it is used almost exclusively to generate passwords.<br><span class="segmentSeparator"></span>We will deal with that expression later when we will be dealing with credentials.</p>
</div>
</div>
<div class="sect2">
<h3 id="_script_expressions">Script Expressions</h3>
<div class="paragraph">
<p>The most interesting expression evaluator is undoubtedly the <code>script</code> expression evaluator.<br><span class="segmentSeparator"></span>It allows to execute arbitrary scripting code to transform the value.<br><span class="segmentSeparator"></span>Basic principle is simple: values from source properties are stored in the script variables.<br><span class="segmentSeparator"></span>Script is executed and it produces an output.<br><span class="segmentSeparator"></span>The output is stored in the target.</p>
</div>
<div class="paragraph">
<p>We have already seen a mapping that has a scripting expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;mapping&gt;</span>
    <span class="tag">&lt;source&gt;</span>
        <span class="tag">&lt;path&gt;</span>givenName<span class="tag">&lt;/path&gt;</span>
    <span class="tag">&lt;/source&gt;</span>
    <span class="tag">&lt;source&gt;</span>
        <span class="tag">&lt;path&gt;</span>familyName<span class="tag">&lt;/path&gt;</span>
    <span class="tag">&lt;/source&gt;</span>
    <span class="tag">&lt;expression&gt;</span>
        <span class="tag">&lt;script&gt;</span>
<span class="inline">            <span class="tag">&lt;code&gt;</span>givenName + ' ' + familyName<span class="tag">&lt;/code&gt;</span></span>
        <span class="tag">&lt;/script&gt;</span>
    <span class="tag">&lt;/expression&gt;</span>
    <span class="tag">&lt;target&gt;</span>
        <span class="tag">&lt;path&gt;</span>fullName<span class="tag">&lt;/path&gt;</span>
    <span class="tag">&lt;/target&gt;</span>
<span class="tag">&lt;/mapping&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are two sources: <code>givenName</code> and <code>familyName</code>.<br><span class="segmentSeparator"></span>The values of these user properties are placed in variables used by the script.<br><span class="segmentSeparator"></span>The variables that have the same names: <code>givenName</code> and <code>familyName</code>.<br><span class="segmentSeparator"></span>Then the script may do whatever it does with the variables.<br><span class="segmentSeparator"></span>At the end the script has to return a value.<br><span class="segmentSeparator"></span>The script above is written in Groovy, therefore the return value is the value of the last evaluated expression.<br><span class="segmentSeparator"></span>In this case it is the only expression in the script which concatenates the two variables with a space in between.<br><span class="segmentSeparator"></span>Script return value is placed in the output, which in this case is <code>fullName</code> user property.</p>
</div>
<div class="paragraph">
<p>Scripts are often used to transform the values before they are stored in account attributes.<br><span class="segmentSeparator"></span>One very common case is construction of LDAP distinguished name (DN).<br><span class="segmentSeparator"></span>The DN is a complex value in the form of <code>uid=foobar,ou=people,dc=example,dc=com</code>.<br><span class="segmentSeparator"></span>However it is easy to construct such value using a simple script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;attribute&gt;</span>
    <span class="tag">&lt;ref&gt;</span>ri:dn<span class="tag">&lt;/ref&gt;</span>
    <span class="tag">&lt;outbound&gt;</span>
        <span class="tag">&lt;source&gt;</span>
             <span class="tag">&lt;path&gt;</span>name<span class="tag">&lt;/path&gt;</span>
        <span class="tag">&lt;/source&gt;</span>
        <span class="tag">&lt;expression&gt;</span>
            <span class="tag">&lt;script&gt;</span>
<span class="inline">                <span class="tag">&lt;code&gt;</span>
                    'uid=' + name + ',ou=people,dc=example,dc=com'
                <span class="tag">&lt;/code&gt;</span></span>
            <span class="tag">&lt;/script&gt;</span>
        <span class="tag">&lt;expression&gt;</span>
    <span class="tag">&lt;/outbound&gt;</span>
<span class="tag">&lt;/attribute&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>(A clever reader surely has a suspicious look on his face now.<br><span class="segmentSeparator"></span>Of course, this is not entirely correct way how to compose LDAP DN.<br><span class="segmentSeparator"></span>But please bear with us.<br><span class="segmentSeparator"></span>We will correct that later.)</p>
</div>
<div class="paragraph">
<p>Midpoint supports three scripting languages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Groovy:</strong> This is the default scripting language.</p>
</li>
<li>
<p><strong>JavaScript</strong> (ECMAscript)</p>
</li>
<li>
<p><strong>Python</strong></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All three languages can be arbitrarily mixed even in a single midPoint deployment.<br><span class="segmentSeparator"></span>Although quite understandably such a practice is not recommended.<br><span class="segmentSeparator"></span>The language can be selected for each individual expression by using language URI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;expression&gt;</span>
    <span class="tag">&lt;script&gt;</span>
<span class="inline"><span class="error">&nbsp;</span><span class="error">&nbsp;</span><span class="error">&nbsp;</span><span class="error">&nbsp;</span><span class="error">&nbsp;</span><span class="error">&nbsp;</span><span class="error">&nbsp;</span><span class="error">&nbsp;</span><span class="tag">&lt;language&gt;</span>http://midpoint.evolveum.com/xml/ns/public/expression/language#python<span class="tag">&lt;/language&gt;</span>
        <span class="tag">&lt;code&gt;</span>
            "Python is %s, name is %s" % ("king", name)
        <span class="tag">&lt;/code&gt;</span></span>
    <span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;expression&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When writing scripting expression, please keep in mind that some characters must be properly escaped in the text format that you are using (XML, JSON or YAML).<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>the ampersand character (<code>&amp;</code>) so frequently used for logical operations needs to be escaped as <code>&amp;amp;</code> in XML.</p>
</div>
<div class="paragraph">
<p>Scripting expressions can do almost anything.<br><span class="segmentSeparator"></span>And there is still more to them that meets the eye.<br><span class="segmentSeparator"></span>This section provides only the very basic description to get you started.<br><span class="segmentSeparator"></span>Will get back to the scripting expressions many times in this book.</p>
</div>
</div>
<div class="sect2">
<h3 id="_activation">Activation</h3>
<div class="paragraph">
<p>The term <em>activation</em> is used in midPoint to denote a set of properties that describe whether an object is active.<br><span class="segmentSeparator"></span>This includes properties that describe whether the user is enabled, disabled, archived, since when he should be enabled, to what date he should be active and so on.<br><span class="segmentSeparator"></span>The simple enabled/disabled flag might have been sufficient in 1990s.<br><span class="segmentSeparator"></span>But that was a long time ago.<br><span class="segmentSeparator"></span>We need much more than that.<br><span class="segmentSeparator"></span>Therefore the <em>activation</em> is quite a rich data structure in midPoint.<br><span class="segmentSeparator"></span>We are going to describe just the basic idea now, the details will follow later.</p>
</div>
<div class="paragraph">
<p>The most important activation concept is <em>administrative status</em>.<br><span class="segmentSeparator"></span>Administrative status defines "administrative state" of the object (user).<br><span class="segmentSeparator"></span>I.e.<br><span class="segmentSeparator"></span>the explicit decision of an administrator whether the user is enabled or disabled.<br><span class="segmentSeparator"></span>Except for administrative status there are also validity times, lockout status, various timestamps and metadata.<br><span class="segmentSeparator"></span>But we will get to that later.</p>
</div>
<div class="paragraph">
<p>The important thing to realize is that both user and the accounts have activation properties - and they are almost the same.<br><span class="segmentSeparator"></span>The user and account activation are using the same property names, meaning and data formats.<br><span class="segmentSeparator"></span>This is important, because you would probably want account activation to follow user activation.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>if user is disabled then also all his accounts should be disabled.<br><span class="segmentSeparator"></span>This is very easy to do in midPoint because the user and account activation are compatible.<br><span class="segmentSeparator"></span>Therefore all it takes is a very simple mapping.<br><span class="segmentSeparator"></span>There is a special place in the resource schema handling section for that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;resource</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">b4101662-7902-11e6-9f14-53e18426fe81</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>My LDAP Server<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;schemaHandling&gt;</span>
        <span class="tag">&lt;objectType&gt;</span>
            <span class="tag">&lt;kind&gt;</span>account<span class="tag">&lt;/kind&gt;</span>
            <span class="tag">&lt;default&gt;</span>true<span class="tag">&lt;/default&gt;</span>
            <span class="tag">&lt;objectClass&gt;</span>ri:inetOrgPerson<span class="tag">&lt;/objectClass&gt;</span>
            <span class="comment">&lt;!-- attribute handling comes here ---&gt;</span>
            <span class="tag">&lt;activation&gt;</span>
                <span class="tag">&lt;administrativeStatus&gt;</span>
                    <span class="tag">&lt;outbound</span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/administrativeStatus&gt;</span>
            <span class="tag">&lt;/activation&gt;</span>
        <span class="tag">&lt;/objectType&gt;</span>
    <span class="tag">&lt;/schemaHandling&gt;</span>
<span class="tag">&lt;/resource&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It is as simple as that.<br><span class="segmentSeparator"></span>Just an empty mapping represented by empty <code>outbount</code> element.<br><span class="segmentSeparator"></span>User has <code>administrativeStatus</code> property, account has <code>administrativeStatus</code> property, therefore midPoint knows what is the source and target of the mapping.<br><span class="segmentSeparator"></span>The values of the <code>administrativeStatus</code> property has the same type and meaning on both sides.<br><span class="segmentSeparator"></span>Therefore the default <code>asIs</code> mapping is just fine.<br><span class="segmentSeparator"></span>All that midPoint needs to know is that the mapping exists at all.<br><span class="segmentSeparator"></span>That we want to map the value.<br><span class="segmentSeparator"></span>That is a reason for having empty <code>outbound</code> element there.<br><span class="segmentSeparator"></span>MidPoint will fill in all the details.</p>
</div>
<div class="paragraph">
<p>When this mapping is in place and the user gets disabled, the account will be disabled as well.<br><span class="segmentSeparator"></span>When the user gets enabled, the account will follow suit.</p>
</div>
</div>
<div class="sect2">
<h3 id="_credentials">Credentials</h3>
<div class="paragraph">
<p>Credential management is important part of identity management.<br><span class="segmentSeparator"></span>MidPoint is built to easily synchronize credentials to many accounts.<br><span class="segmentSeparator"></span>Similarly to activation, credential data structures of user and accounts are aligned.<br><span class="segmentSeparator"></span>Therefore all that is needed to synchronize password to an account is a simple empty mapping:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;resource</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">b4101662-7902-11e6-9f14-53e18426fe81</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>My LDAP Server<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;schemaHandling&gt;</span>
        <span class="tag">&lt;objectType&gt;</span>
            <span class="tag">&lt;kind&gt;</span>account<span class="tag">&lt;/kind&gt;</span>
            <span class="tag">&lt;default&gt;</span>true<span class="tag">&lt;/default&gt;</span>
            <span class="tag">&lt;objectClass&gt;</span>ri:inetOrgPerson<span class="tag">&lt;/objectClass&gt;</span>
            <span class="comment">&lt;!-- attribute handling comes here ---&gt;</span>
            <span class="tag">&lt;credentials&gt;</span>
                <span class="tag">&lt;password&gt;</span>
                    <span class="tag">&lt;outbound</span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/password&gt;</span>
            <span class="tag">&lt;/credentials&gt;</span>
        <span class="tag">&lt;/objectType&gt;</span>
    <span class="tag">&lt;/schemaHandling&gt;</span>
<span class="tag">&lt;/resource&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the user password in midPoint is changed the changed password will be propagated to all the resources that have a mapping like this.</p>
</div>
</div>
<div class="sect2">
<h3 id="_complete_provisioning_example">Complete Provisioning Example</h3>
<div class="paragraph">
<p>This section describes a complete working example of connection to the LDAP directory.<br><span class="segmentSeparator"></span>The configuration below is used to automatically create accounts in OpenLDAP server.<br><span class="segmentSeparator"></span>Entire configuration is contained in a single resource definition file.<br><span class="segmentSeparator"></span>Following paragraphs explain individual parts of the file.<br><span class="segmentSeparator"></span>Simplified XML notation is used for clarity.<br><span class="segmentSeparator"></span>Complete file in a form directly usable in midPoint can be found at the same place as all the other samples in this book
(see <a href="https://docs.evolveum.com/book/practical-identity-management-with-midpoint.html#92-additional-information">Additional Information</a> chapter for details).</p>
</div>
<div class="paragraph">
<p>Resource definition begins with object type, OID, name and description.<br><span class="segmentSeparator"></span>These are self-explanatory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;resource</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">8a83b1a4-be18-11e6-ae84-7301fdab1d7c</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;name&gt;</span>OpenLDAP<span class="tag">&lt;/name&gt;</span>

    <span class="tag">&lt;description&gt;</span>
        LDAP resource using a ConnId LDAP connector.<br><span class="segmentSeparator"></span>It contains configuration
        for use with OpenLDAP servers.<br><span class="segmentSeparator"></span>        This is a sample used in the "Practical Identity Management with MidPoint"
        book, chapter 4.<br><span class="segmentSeparator"></span>    <span class="tag">&lt;/description&gt;</span>
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Connector reference comes next.<br><span class="segmentSeparator"></span>We want to point to the LDAP connector.<br><span class="segmentSeparator"></span>Here we use dynamic reference that is using search filter to locate the connector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;connectorRef</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">ConnectorType</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;filter&gt;</span>
            <span class="tag">&lt;q:equal&gt;</span>
                <span class="tag">&lt;q:path&gt;</span>c:connectorType<span class="tag">&lt;/q:path&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;q:value&gt;</span>com.evolveum.polygon.connector.ldap.LdapConnector<span class="tag">&lt;/q:value&gt;</span>
            <span class="tag">&lt;/q:equal&gt;</span>
        <span class="tag">&lt;/filter&gt;</span>
    <span class="tag">&lt;/connectorRef&gt;</span>
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The reference is resolved when this object is imported to midPoint.<br><span class="segmentSeparator"></span>The resolution process takes the search filter and it looks for connector object with the <code>connectorType</code> specified in the filter.</p>
</div>
<div class="paragraph">
<p>Connector configuration goes next.<br><span class="segmentSeparator"></span>This block specifies connector configuration properties such as hostname, port, passwords and so on.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;connectorConfiguration&gt;</span>
        <span class="tag">&lt;icfc:configurationProperties&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;icfcldap:port&gt;</span>389<span class="tag">&lt;/icfcldap:port&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;icfcldap:host&gt;</span>localhost<span class="tag">&lt;/icfcldap:host&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;icfcldap:baseContext&gt;</span>dc=example,dc=com<span class="tag">&lt;/icfcldap:baseContext&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;icfcldap:bindDn&gt;</span>cn=idm,ou=Administrators,dc=example,dc=com<span class="tag">&lt;/icfcldap:bindDn&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;icfcldap:bindPassword&gt;</span><span class="tag">&lt;t:clearValue&gt;</span>secret<span class="tag">&lt;/t:clearValue&gt;</span><span class="tag">&lt;/icfcldap:bindPassword&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;icfcldap:passwordHashAlgorithm&gt;</span>SSHA<span class="tag">&lt;/icfcldap:passwordHashAlgorithm&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;icfcldap:vlvSortAttribute&gt;</span>uid,cn,ou,dc<span class="tag">&lt;/icfcldap:vlvSortAttribute&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;icfcldap:vlvSortOrderingRule&gt;</span>2.5.13.3<span class="tag">&lt;/icfcldap:vlvSortOrderingRule&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;icfcldap:operationalAttributes&gt;</span>memberOf<span class="tag">&lt;/icfcldap:operationalAttributes&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;icfcldap:operationalAttributes&gt;</span>createTimestamp<span class="tag">&lt;/icfcldap:operationalAttributes&gt;</span>
        <span class="tag">&lt;/icfc:configurationProperties&gt;</span>
        <span class="tag">&lt;icfc:resultsHandlerConfiguration&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;icfc:enableNormalizingResultsHandler&gt;</span>false<span class="tag">&lt;/icfc:enableNormalizingResultsHandler&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;icfc:enableFilteredResultsHandler&gt;</span>false<span class="tag">&lt;/icfc:enableFilteredResultsHandler&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;icfc:enableAttributesToGetSearchResultsHandler&gt;</span>false<span class="tag">&lt;/icfc:enableAttributesToGetSearchResultsHandler&gt;</span>
        <span class="tag">&lt;/icfc:resultsHandlerConfiguration&gt;</span>
    <span class="tag">&lt;/connectorConfiguration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The last part of this block defines that the ConnId framework result handlers should be disabled.<br><span class="segmentSeparator"></span>ConnId result filtering is a legacy mechanism and most connectors do not need that any more.<br><span class="segmentSeparator"></span>It may even be harmful in many cases.<br><span class="segmentSeparator"></span>Unfortunately this mechanism is turned on by default.<br><span class="segmentSeparator"></span>Therefore most resource configurations contain this part to explicitly turn all the handlers off.</p>
</div>
<div class="paragraph">
<p>These parts alone should already define a minimal resource.<br><span class="segmentSeparator"></span>If you define just the name, connector reference and connector configuration you should be able to import the resource to midPoint.<br><span class="segmentSeparator"></span>The connection test should pass and you should be able to browse resource content.<br><span class="segmentSeparator"></span>However there is absolutely no IDM logic or automation yet.<br><span class="segmentSeparator"></span>That is what we are going to add next.</p>
</div>
<div class="paragraph">
<p>Element that usually follows connector configuration is schema.<br><span class="segmentSeparator"></span>However if you look at almost any file that contains resource definition you will find no such element.<br><span class="segmentSeparator"></span>The schema element is automatically generated by midPoint when midPoint connects to the resource for the first time.<br><span class="segmentSeparator"></span>Therefore there is no need to include it in the definition.</p>
</div>
<div class="paragraph">
<p>What we have to include in the definition is the way how midPoint handles the schema.<br><span class="segmentSeparator"></span>This is defined in <code>schemaHandling</code> section.<br><span class="segmentSeparator"></span>Our <code>schemaHandling</code> section contains just one <code>objectType</code> definition.<br><span class="segmentSeparator"></span>We are going to define how to handle ordinary user accounts on our OpenLDAP server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;schemaHandling&gt;</span>
        <span class="tag">&lt;objectType&gt;</span>
            <span class="tag">&lt;kind&gt;</span>account<span class="tag">&lt;/kind&gt;</span>
            <span class="tag">&lt;displayName&gt;</span>Normal Account<span class="tag">&lt;/displayName&gt;</span>
            <span class="tag">&lt;default&gt;</span>true<span class="tag">&lt;/default&gt;</span>
            <span class="tag">&lt;objectClass&gt;</span>ri:inetOrgPerson<span class="tag">&lt;/objectClass&gt;</span>
            ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the place where we define the <em>kind</em> of objects that we are going to handle.<br><span class="segmentSeparator"></span>In this case it is <code>account</code>.<br><span class="segmentSeparator"></span>This object is <em>default</em> account.<br><span class="segmentSeparator"></span>Which means that it will be used in case that the account type is not explicitly specified.<br><span class="segmentSeparator"></span>There is also specification of a display name.<br><span class="segmentSeparator"></span>Display name is not used in automation logic.<br><span class="segmentSeparator"></span>It is used by the user interface when referring to this definition.<br><span class="segmentSeparator"></span>And finally, there is specification of the <em>object class</em>.<br><span class="segmentSeparator"></span>The <code>inetOrgPerson</code> object class will be used to create new accounts.<br><span class="segmentSeparator"></span>The object class specification determines what attributes the account can have.</p>
</div>
<div class="paragraph">
<p>The <code>objectType</code> definition also includes a specification of attribute handling.<br><span class="segmentSeparator"></span>There is one section for each attribute that we want to handle in automated or special way.<br><span class="segmentSeparator"></span>It starts with the most important attribute: LDAP distinguished name (DN):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">            ...<br><span class="segmentSeparator"></span>            <span class="tag">&lt;attribute&gt;</span>
                <span class="tag">&lt;ref&gt;</span>ri:dn<span class="tag">&lt;/ref&gt;</span>
                <span class="tag">&lt;displayName&gt;</span>Distinguished Name<span class="tag">&lt;/displayName&gt;</span>
                <span class="tag">&lt;limitations&gt;</span>
                    <span class="tag">&lt;minOccurs&gt;</span>0<span class="tag">&lt;/minOccurs&gt;</span>
                <span class="tag">&lt;/limitations&gt;</span>
                <span class="tag">&lt;outbound&gt;</span>
                    <span class="tag">&lt;source&gt;</span>
                        <span class="tag">&lt;path&gt;</span>$focus/name<span class="tag">&lt;/path&gt;</span>
                    <span class="tag">&lt;/source&gt;</span>
                    <span class="tag">&lt;expression&gt;</span>
                        <span class="tag">&lt;script&gt;</span>
<span class="inline">                            <span class="tag">&lt;code&gt;</span>
                                basic.composeDnWithSuffix('uid', name, 'ou=people,dc=example,dc=com')
                            <span class="tag">&lt;/code&gt;</span></span>
                        <span class="tag">&lt;/script&gt;</span>
                    <span class="tag">&lt;/expression&gt;</span>
                <span class="tag">&lt;/outbound&gt;</span>
            <span class="tag">&lt;/attribute&gt;</span>
            ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ref</code> element specifies name of the attribute that we are going to work with.<br><span class="segmentSeparator"></span>In fact this is a reference to automatically-generated schema part of resource definition.<br><span class="segmentSeparator"></span>Definition of display name follows.<br><span class="segmentSeparator"></span>Display name is used by the user interface as a label for the user interface elements (fields) that work with this attribute.<br><span class="segmentSeparator"></span>This definition sets a nice "Distinguished Name" label instead of cryptic "dn" which would be used by default.</p>
</div>
<div class="paragraph">
<p>Let’s skip the limitation definition now.<br><span class="segmentSeparator"></span>We will come back to that later.</p>
</div>
<div class="paragraph">
<p>The outbound mapping definition follows.<br><span class="segmentSeparator"></span>This is where the automation logic is specified.<br><span class="segmentSeparator"></span>This is the place where the DN value is computed.<br><span class="segmentSeparator"></span>The name property of the user object is the source for this mapping.<br><span class="segmentSeparator"></span>The name property usually contains username (login name).<br><span class="segmentSeparator"></span>This value is used by scripting expression in this mapping.<br><span class="segmentSeparator"></span>The expression is supposed to create a DN in the form:</p>
</div>
<div class="paragraph">
<p><code>uid=<em>username</em>,ou=people,dc=example,dc=com</code></p>
</div>
<div class="paragraph">
<p>The expression here is a clever one.<br><span class="segmentSeparator"></span>It does not do the work all by itself.<br><span class="segmentSeparator"></span>It invokes a library function to compose the DN.<br><span class="segmentSeparator"></span>It may look like a good idea to use simple string concatenation to construct a DN.<br><span class="segmentSeparator"></span>However, that will fail in case that the DN components contain certain characters that need to be escaped in the final DN.<br><span class="segmentSeparator"></span>The <code>composeDnWithSuffix</code> library function takes care of that and creates a proper DN.</p>
</div>
<div class="paragraph">
<p>The outbound mapping will be evaluated whenever we need to construct a DN.<br><span class="segmentSeparator"></span>This obviously happens when a new object is created.<br><span class="segmentSeparator"></span>But the same mapping is used when a user is renamed (i.e.<br><span class="segmentSeparator"></span>his username changes).<br><span class="segmentSeparator"></span>This is the reason that the mapping needs specification of source.<br><span class="segmentSeparator"></span>Rename is often quite tricky and complicated operation.<br><span class="segmentSeparator"></span>It may not be cheap and in some applications it may not be entirely reversible.<br><span class="segmentSeparator"></span>We definitely do not want to trigger DN changes unless they are really needed.<br><span class="segmentSeparator"></span>The specification of the mapping source tells us <em>when</em> the DN change is needed.<br><span class="segmentSeparator"></span>In this case it tells us to change the DN in the name property of the user object changes.</p>
</div>
<div class="paragraph">
<p>Now it is the right time to go back to the <code>limitations</code> section.<br><span class="segmentSeparator"></span>The dn attribute is defines as mandatory attribute by the schema.<br><span class="segmentSeparator"></span>And that is perfectly correct: LDAP object cannot be created without a DN.<br><span class="segmentSeparator"></span>MidPoint is using schema for everything.<br><span class="segmentSeparator"></span>Therefore when midPoint displays a form to edit this LDAP account it will check that DN has a value because it is a mandatory attribute.<br><span class="segmentSeparator"></span>However, normally we do not want users to enter the DN in the user interface forms.<br><span class="segmentSeparator"></span>We want to compute DN automatically.<br><span class="segmentSeparator"></span>And that is exactly the point of the outbound mapping.<br><span class="segmentSeparator"></span>Yet midPoint does not know when the expression computes a value and when it does not.<br><span class="segmentSeparator"></span>The expression is a generic piece of Groovy code.<br><span class="segmentSeparator"></span>As far as midPoint can see the expression can produce any value, including empty one.<br><span class="segmentSeparator"></span>Therefore even if there is an expression, midPoint sticks to the schema and it still requires that DN value is entered by the user.<br><span class="segmentSeparator"></span>However we have written the expression and we know that it will produce a value for any (reasonable) input.<br><span class="segmentSeparator"></span>Therefore we want to tell midPoint that the DN is no longer mandatory – that it is OK for user to enter no DN value in user interface forms.<br><span class="segmentSeparator"></span>And that is exactly what the <code>limitations</code> section does.<br><span class="segmentSeparator"></span>This section overrides the automatically generated schema and it turns the dn attribute from mandatory to optional.</p>
</div>
<div class="paragraph">
<p>And that is all.<br><span class="segmentSeparator"></span>Now we have defined the behavior of the dn attribute.<br><span class="segmentSeparator"></span>We can use similar approach to define the behavior of other attributes as well.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>the handling of the <code>cn</code> attribute has similar definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">            ...<br><span class="segmentSeparator"></span>            <span class="tag">&lt;attribute&gt;</span>
                <span class="tag">&lt;ref&gt;</span>ri:cn<span class="tag">&lt;/ref&gt;</span>
                <span class="tag">&lt;displayName&gt;</span>Common Name<span class="tag">&lt;/displayName&gt;</span>
                <span class="tag">&lt;limitations&gt;</span>
                    <span class="tag">&lt;minOccurs&gt;</span>0<span class="tag">&lt;/minOccurs&gt;</span>
                <span class="tag">&lt;/limitations&gt;</span>
                <span class="tag">&lt;outbound&gt;</span>
                    <span class="tag">&lt;source&gt;</span>
                        <span class="tag">&lt;path&gt;</span>$focus/fullName<span class="tag">&lt;/path&gt;</span>
                    <span class="tag">&lt;/source&gt;</span>
                <span class="tag">&lt;/outbound&gt;</span>
            <span class="tag">&lt;/attribute&gt;</span>
            ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case there is outbound mapping, but it has no explicit expression.<br><span class="segmentSeparator"></span>Which means that the value is taken from the source without any change ("as is").<br><span class="segmentSeparator"></span>Therefore the attribute cn will have the same value as user property <code>fullName</code>.</p>
</div>
<div class="paragraph">
<p>It is also possible to define an attribute without any mapping:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">            ...<br><span class="segmentSeparator"></span>            <span class="tag">&lt;attribute&gt;</span>
                <span class="tag">&lt;ref&gt;</span>ri:entryUUID<span class="tag">&lt;/ref&gt;</span>
                <span class="tag">&lt;displayName&gt;</span>Entry UUID<span class="tag">&lt;/displayName&gt;</span>
            <span class="tag">&lt;/attribute&gt;</span>
            ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This means that midPoint will not provide any automatic handling for the <code>entryUUID</code> attribute.<br><span class="segmentSeparator"></span>This definition is used just to set a user-friendly display name for the attribute.</p>
</div>
<div class="paragraph">
<p>Mappings and expressions have almost unlimited flexibility.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>the following definition sets a static value for the <code>description</code> attribute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">            ...<br><span class="segmentSeparator"></span>            <span class="tag">&lt;attribute&gt;</span>
                <span class="tag">&lt;ref&gt;</span>ri:description<span class="tag">&lt;/ref&gt;</span>
                <span class="tag">&lt;outbound&gt;</span>
                    <span class="tag">&lt;strength&gt;</span>weak<span class="tag">&lt;/strength&gt;</span>
                    <span class="tag">&lt;expression&gt;</span>
                        <span class="tag">&lt;value&gt;</span>Created by midPoint<span class="tag">&lt;/value&gt;</span>
                    <span class="tag">&lt;/expression&gt;</span>
                <span class="tag">&lt;/outbound&gt;</span>
            <span class="tag">&lt;/attribute&gt;</span>
            ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This mapping has no source because the source does not make any sense for static value.<br><span class="segmentSeparator"></span>Static values are always the same.<br><span class="segmentSeparator"></span>You can also notice that this mapping is <em>weak</em>.<br><span class="segmentSeparator"></span>It will be used to set the <code>description</code> attribute only if that attribute does not have any value already.<br><span class="segmentSeparator"></span>It will not overwrite existing values.</p>
</div>
<div class="paragraph">
<p>The <code>inetOrgPerson</code> object class has much more attributes than those defined in the <code>schemaHandling</code> section.<br><span class="segmentSeparator"></span>Those attributes will be automatically displayed in the user interface.<br><span class="segmentSeparator"></span>MidPoint will use the generated resource schema to determine their names and types.<br><span class="segmentSeparator"></span>MidPoint will display these attributes, the user can change them and midPoint will execute those changes.<br><span class="segmentSeparator"></span>But apart from that midPoint will not do any special handling on those attributes.<br><span class="segmentSeparator"></span>It is all right not to enumerate all the attributes in <code>schemaHandling</code> section.<br><span class="segmentSeparator"></span>You only need to define those attributes which you want to handle in a special way.</p>
</div>
<div class="paragraph">
<p>There are two more definitions to describe before our example is complete.<br><span class="segmentSeparator"></span>First definition is the <code>activation</code> definition.<br><span class="segmentSeparator"></span>It is very simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">            ...<br><span class="segmentSeparator"></span>            <span class="tag">&lt;activation&gt;</span>
                <span class="tag">&lt;administrativeStatus&gt;</span>
                    <span class="tag">&lt;outbound</span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/administrativeStatus&gt;</span>
            <span class="tag">&lt;/activation&gt;</span>
            ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a definition that specifies handling of the activation administrative status.<br><span class="segmentSeparator"></span>This status property specifies whether account is enabled or disabled.<br><span class="segmentSeparator"></span>Activation properties are somehow special in midPoint.<br><span class="segmentSeparator"></span>MidPoint understands the meaning and the values of activation properties.<br><span class="segmentSeparator"></span>MidPoint also expects that user activation and account activation will be usually mapped together.<br><span class="segmentSeparator"></span>Therefore it is enough to tell midPoint that you want such mapping.<br><span class="segmentSeparator"></span>MidPoint already knows the source (user activation) and the target (account activation).<br><span class="segmentSeparator"></span>If the user is disabled then the account will get disabled.<br><span class="segmentSeparator"></span>If the user is enabled than the account will get enabled.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Clever reader is surely scratching his head now.<br><span class="segmentSeparator"></span>There is no LDAP standard that specifies how to enable or disable accounts.<br><span class="segmentSeparator"></span>In addition to this, OpenLDAP does not even have a concept of disabled account at all!
Therefore how does midPoint know how to disable an LDAP account?<br><span class="segmentSeparator"></span>To tell the truth, midPoint does not know it.<br><span class="segmentSeparator"></span>We have taken a bit of a poetic license here as we wanted to demonstrate a simple activation mapping.<br><span class="segmentSeparator"></span>But in this case it will not work just by itself.<br><span class="segmentSeparator"></span>OpenLDAP resource simply does not have this <em>capability</em>.<br><span class="segmentSeparator"></span>However there is a way.<br><span class="segmentSeparator"></span>Activation capability can be simulated.<br><span class="segmentSeparator"></span>We will deal with that later.<br><span class="segmentSeparator"></span>For now let’s just marvel in the beauty of this very elegant activation mapping that does absolutely nothing.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The last thing that we need for the resource to work well is to define a mapping for <em>credentials</em>.<br><span class="segmentSeparator"></span>In this case it is a password mapping:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">            ...<br><span class="segmentSeparator"></span>            <span class="tag">&lt;credentials&gt;</span>
                <span class="tag">&lt;password&gt;</span>
                    <span class="tag">&lt;outbound</span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/password&gt;</span>
            <span class="tag">&lt;/credentials&gt;</span>
            ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly to activation, the credentials are handled in a special way in midPoint.<br><span class="segmentSeparator"></span>MidPoint understands how credentials work, what are their values and how they are used.<br><span class="segmentSeparator"></span>MidPoint also expects that user credentials such as passwords will be usually mapped to the account credentials.<br><span class="segmentSeparator"></span>Therefore all that midPoint needs to know is that you want to do that mapping.<br><span class="segmentSeparator"></span>It can automatically determine the source and target.<br><span class="segmentSeparator"></span>The account will have the same password as the user.<br><span class="segmentSeparator"></span>User’s password is used when a new account is created.<br><span class="segmentSeparator"></span>And when user changes his password the change is also propagated to the account.</p>
</div>
<div class="paragraph">
<p>That is it.<br><span class="segmentSeparator"></span>Now you have your first (almost) working resource.<br><span class="segmentSeparator"></span>You can import the definition to midPoint and test it.<br><span class="segmentSeparator"></span>Simply assign the resource to a user.<br><span class="segmentSeparator"></span>The OpenLDAP account will be created - the DN and all the essential attributes will be automatically computed.<br><span class="segmentSeparator"></span>When midPoint creates an account for a user remembers who is the owner of that account.<br><span class="segmentSeparator"></span>Therefore it can be easily delete the account when needed.<br><span class="segmentSeparator"></span>Unassign the resource and the account will get deleted.<br><span class="segmentSeparator"></span>This is how automated provisioning and deprovisioning works.<br><span class="segmentSeparator"></span>No real programming is needed.<br><span class="segmentSeparator"></span>Just a declarative specification and a line or two of very simple scripting.<br><span class="segmentSeparator"></span>Such configuration can be done in a couple of minutes.<br><span class="segmentSeparator"></span>And it is essentially the same process for all the applications.<br><span class="segmentSeparator"></span>Just the connector is different.<br><span class="segmentSeparator"></span>The connector has different configuration properties, the attribute names are different - but the principles and the tools are the same.<br><span class="segmentSeparator"></span>It is easy to connect many heterogeneous applications in this way.<br><span class="segmentSeparator"></span>The connectors and the mappings are hiding the differences.<br><span class="segmentSeparator"></span>In the end all the "resources" look the same to midPoint.<br><span class="segmentSeparator"></span>The same principles are used to manage them.<br><span class="segmentSeparator"></span>Therefore the management can be done efficiently even at a large scale.</p>
</div>
<div class="paragraph">
<p>Yet this configuration is still extremely simple.<br><span class="segmentSeparator"></span>We are just scratching the surface of what midPoint can do.<br><span class="segmentSeparator"></span>There is much more to see in next chapters.<br><span class="segmentSeparator"></span>But we need to explain more of the fundamental midPoint concepts before getting there.</p>
</div>
</div>
<div class="sect2">
<h3 id="_shadows">Shadows</h3>
<div class="paragraph">
<p>Linking users and accounts is one of the basic principle of any decent identity management system.<br><span class="segmentSeparator"></span>However it is surprisingly difficult to implement such link.<br><span class="segmentSeparator"></span>There are numerous methods how to reliably identify accounts and they vary from system to system.<br><span class="segmentSeparator"></span>Some systems identify accounts only by username - which makes reliable detection of renames quite difficult.<br><span class="segmentSeparator"></span>Other systems improve on that by introducing another identifier, an identifier that is persistent.<br><span class="segmentSeparator"></span>Identifier value is assigned by the resource and it never changes.<br><span class="segmentSeparator"></span>However, username is still used as secondary identifier and it has to be unique.<br><span class="segmentSeparator"></span>Yet another system has compound identifiers that consist of two or more values.<br><span class="segmentSeparator"></span>Some system have globally-unique identifiers while other systems have identifiers that are only unique in their own object class.<br><span class="segmentSeparator"></span>Some systems have hierarchical structured identifiers, others have flat unstructured identifiers.<br><span class="segmentSeparator"></span>Some identifiers are case-sensitive strings, others are case-insensitive, some identifiers follow complex normalization rules and yet another identifiers are binary and completely opaque.<br><span class="segmentSeparator"></span>To make long story short: reliable identification is really complicated.</p>
</div>
<div class="paragraph">
<p>We do not want to pollute user object with all the delicate details of account identification.<br><span class="segmentSeparator"></span>Therefore we have created a separate midPoint object that hides all the resource-related details and identification complexities.<br><span class="segmentSeparator"></span>We call it simply <em>shadow</em> because it behaves as a shadow of the real account.<br><span class="segmentSeparator"></span>When midPoint detects new account a <em>shadow</em> is automatically created to represent the account in midPoint repository.<br><span class="segmentSeparator"></span>When midPoint detects that account has changed (e.g.<br><span class="segmentSeparator"></span>it was renamed) then midPoint automatically updates the shadow.<br><span class="segmentSeparator"></span>When the account is deleted midPoint also deletes the shadow.<br><span class="segmentSeparator"></span>Technically, shadow is still an ordinary midPoint object.<br><span class="segmentSeparator"></span>Therefore shadow has object identifier (OID).<br><span class="segmentSeparator"></span>Other objects can simply point to the shadow using ordinary object reference.<br><span class="segmentSeparator"></span>And that is exactly how user-account links are implemented:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/04-10-user-shadow-account.png" alt="User-shadow-account">
</div>
</div>
<div class="paragraph">
<p>The <em>shadow</em> objects contain all the data that are needed to reliably identify an account - or any other resource object such as group or organizational unit.<br><span class="segmentSeparator"></span>Shadow also points to the corresponding resource definition to make the identification complete.<br><span class="segmentSeparator"></span>Shadows are multi-purpose objects and they have many uses in midPoint.<br><span class="segmentSeparator"></span>Shadows record meta-data about resource objects.<br><span class="segmentSeparator"></span>They are used to hold cached values of the attributes (this functionality is still experimental in midPoint 4.0).<br><span class="segmentSeparator"></span>Shadows can be used to hold the state of the resource objects for which midPoint does not have on-line communication channel and the operations are executed manually (a.k.a.<br><span class="segmentSeparator"></span>"manual resources").<br><span class="segmentSeparator"></span>Therefore shadows are quite complex objects.<br><span class="segmentSeparator"></span>Following picture provides more substantial example of a shadow.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/04-11-user-shadow-resource.png" alt="User-shadow-resource">
</div>
</div>
<div class="paragraph">
<p>Do not worry if that picture looks a bit scary.<br><span class="segmentSeparator"></span>Shadows may be complex, but they are almost always invisible to midPoint users.<br><span class="segmentSeparator"></span>Shadows are automatically and transparently maintained by midPoint core.<br><span class="segmentSeparator"></span>Under normal circumstances, MidPoint takes all that is needed to maintain the shadow and no special configuration is needed for that.<br><span class="segmentSeparator"></span>We describe the mechanics of the shadow objects here mostly for the sake of completeness.<br><span class="segmentSeparator"></span>But there may be situations when this knowledge may be useful.<br><span class="segmentSeparator"></span>These are usually situations when midPoint was mis-configured and the shadows were created incorrectly.<br><span class="segmentSeparator"></span>In that case you may need to purge all shadows and start over.<br><span class="segmentSeparator"></span>But beware: shadows are used to link users and accounts therefore if you purge the shadows you will lose the links.<br><span class="segmentSeparator"></span>Yet, even that is usually not that painful.<br><span class="segmentSeparator"></span>The synchronization methods described in the next chapter may be used to easily re-create the links.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="05-synchronization">5.<br><span class="segmentSeparator"></span>Synchronization</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
It is a capital mistake to theorize before one has data.<br><span class="segmentSeparator"></span></blockquote>
<div class="attribution">
— Sherlock Holmes<br>
<cite>The Adventures of Sherlock Holmes by Arthur Conan Doyle</cite>
</div>
</div>
<div class="paragraph">
<p>Data are the lifeblood of any software system.<br><span class="segmentSeparator"></span>Ensuring proper management of the data is one the primary responsibilities of a software architect.<br><span class="segmentSeparator"></span>But data management can be very tricky – as any experienced software architect knows only too well.<br><span class="segmentSeparator"></span>One of the important principle of software architecture is often formulated as "do not repeat yourself".<br><span class="segmentSeparator"></span>This applies to code as it applies to data: though shall not repeat the data.<br><span class="segmentSeparator"></span>There is one original, authoritative value.<br><span class="segmentSeparator"></span>And there should not be any copies of that value.<br><span class="segmentSeparator"></span>Ever.<br><span class="segmentSeparator"></span>There is just one universal source of truth.<br><span class="segmentSeparator"></span>If there are no copies then the data are always consistent.<br><span class="segmentSeparator"></span>No copies means no contradictions.<br><span class="segmentSeparator"></span>Just one truth, precise and crystal-clear.<br><span class="segmentSeparator"></span>Keep data in one place and one place only.</p>
</div>
<div class="paragraph">
<p>That is the theory.</p>
</div>
<div class="paragraph">
<p>However, practice has a different opinion to offer.<br><span class="segmentSeparator"></span>In practice there are many incompatible technologies.<br><span class="segmentSeparator"></span>Applications built on relational databases cannot directly use data from directory services.<br><span class="segmentSeparator"></span>Even relational databases do not fit together easily.<br><span class="segmentSeparator"></span>Each application is designed with a different data model in mind.<br><span class="segmentSeparator"></span>There are data translation and bridging technologies that work as adapters to resolve compatibility issues.<br><span class="segmentSeparator"></span>Those are elegant solutions.<br><span class="segmentSeparator"></span>But there is a cost to pay.<br><span class="segmentSeparator"></span>The adapters add latencies and they almost always have major negative impact on performance.<br><span class="segmentSeparator"></span>Even worse, transaction handling and data consistency is very problematic.<br><span class="segmentSeparator"></span>Such adapters are additional components on a critical path and they failures are very painful.<br><span class="segmentSeparator"></span>The resulting system is often operationally fragile: failure of even a minor component means a failure of the entire system.<br><span class="segmentSeparator"></span>Not to speak about the enormous complexity and cost of the solution.</p>
</div>
<div class="paragraph">
<p>On the other hand, copying all the data into my application database is so convenient.<br><span class="segmentSeparator"></span>The application can access the data easily, using just one homogeneous mechanism.<br><span class="segmentSeparator"></span>Failure of other components are not affecting the critical path.<br><span class="segmentSeparator"></span>And it is all so much better for performance.<br><span class="segmentSeparator"></span>Copying the data solves almost all of the troublesome issues.<br><span class="segmentSeparator"></span>Except for one small detail: the problem of keeping the data up to date.<br><span class="segmentSeparator"></span>And that is where the synchronization mechanisms come in.</p>
</div>
<div class="paragraph">
<p>However hard you may try, it is almost impossible to avoid maintaining copies of the data.<br><span class="segmentSeparator"></span>Identity data are no exception.<br><span class="segmentSeparator"></span>In fact identity data are often the most heavily affected.<br><span class="segmentSeparator"></span>And it makes a lot of sense.<br><span class="segmentSeparator"></span>Applications are built for users to use them.<br><span class="segmentSeparator"></span>Therefore almost every application keeps some kind of data about users.<br><span class="segmentSeparator"></span>In addition to that, such data are usually very sensitive from security and privacy point of view.</p>
</div>
<div class="paragraph">
<p>We cannot avoid copying the data.<br><span class="segmentSeparator"></span>The best thing that we can do is to keep the copies managed and synchronized.<br><span class="segmentSeparator"></span>Some applications have built-in support for LDAP or directory synchronization.<br><span class="segmentSeparator"></span>But those mechanisms are usually quite weak and fragile.<br><span class="segmentSeparator"></span>For example many applications provide capability for on-demand synchronization with directory service on login time.<br><span class="segmentSeparator"></span>It usually works like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User enters username and password to application login dialog.</p>
</li>
<li>
<p>The application connects to the directory service to validate the password.</p>
</li>
<li>
<p>If the password is correct then the application retrieves user data from the directory.</p>
</li>
<li>
<p>The application stores copy of user data locally.</p>
</li>
<li>
<p>Business as usual.<br><span class="segmentSeparator"></span>Local copy of the data is used ever since.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This approach works quite well at the beginning.<br><span class="segmentSeparator"></span>But after a while the data begin to stink.<br><span class="segmentSeparator"></span>Users are renamed, but the local copies are not updated.<br><span class="segmentSeparator"></span>Users are deleted, but the local copies stay around forever.<br><span class="segmentSeparator"></span>There are local accounts and privileges that are not reflected back to the directory service and therefore remain undetected for years.<br><span class="segmentSeparator"></span>Which means that we have a serious security and data protection problem here.<br><span class="segmentSeparator"></span>And we do not even know that the problem is there.</p>
</div>
<div class="paragraph">
<p>Some applications have more advanced synchronization processes that can do better than this.<br><span class="segmentSeparator"></span>However, an application that does synchronization well is still an extremely rare sight.<br><span class="segmentSeparator"></span>And there is a good reason for this.<br><span class="segmentSeparator"></span>Synchronization is much harder than it seems.<br><span class="segmentSeparator"></span>There may be data inconsistencies on both sides.<br><span class="segmentSeparator"></span>There may be networking errors.<br><span class="segmentSeparator"></span>Configuration errors.<br><span class="segmentSeparator"></span>Data models are evolving in time.<br><span class="segmentSeparator"></span>Policies are changing.<br><span class="segmentSeparator"></span>It is no easy task to reliably synchronize the data in such environment.<br><span class="segmentSeparator"></span>Therefore there is a special breed of systems that specialize in synchronization of identity data: identity management systems.</p>
</div>
<div class="sect2">
<h3 id="_synchronization_in_midpoint">Synchronization in MidPoint</h3>
<div class="paragraph">
<p>Synchronization is one of the basic mechanisms of midPoint.<br><span class="segmentSeparator"></span>Synchronization mechanisms are integral part of midPoint design from its very beginning.<br><span class="segmentSeparator"></span>Many of the things that midPoint normally does are in fact just different flavors of synchronization.<br><span class="segmentSeparator"></span>There are obvious cases such as reconciliation process synchronizing account attributes with midPoint user properties.<br><span class="segmentSeparator"></span>But there are also less obvious cases, such as a completely ordinary provisioning case when midPoint needs to create a new account for a user.<br><span class="segmentSeparator"></span>Even that case is in fact a synchronization: midPoint user properties are synchronized with a new empty account on the resource.<br><span class="segmentSeparator"></span>Majority of midPoint operations are directly or indirectly using the synchronization principles.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Reuse of the mechanisms is one of fundamental principles of midPoint design.<br><span class="segmentSeparator"></span>When we have designed midPoint we have not invented a separate mechanism for every midPoint feature.<br><span class="segmentSeparator"></span>We have rather designed few very generic principles that are re-used at many places in midPoint.<br><span class="segmentSeparator"></span>Synchronization is one of these principles.<br><span class="segmentSeparator"></span>There is one code that implements the core of the synchronization logic.<br><span class="segmentSeparator"></span>And that code is used whenever we need to "align" objects that relate to each other.<br><span class="segmentSeparator"></span>The same code is used for user-account reconciliation, ordinary provisioning, role-based provisioning, live synchronization, data consistency …​ almost everywhere.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>MidPoint synchronization is almost a continuous functionality spectrum that can be tweaked and tuned to match specific needs.<br><span class="segmentSeparator"></span>Yet, the synchronization mechanisms can be divided to several broad and slightly overlapping categories:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Live synchronization</strong> is almost real-time synchronization mechanism.<br><span class="segmentSeparator"></span>MidPoint continually scans the resource for changes.<br><span class="segmentSeparator"></span>If changes are detected then those changes are immediately processed by midPoint.<br><span class="segmentSeparator"></span>The actual latencies depend on the capabilities of the resource but usual numbers range from few seconds to few minutes.<br><span class="segmentSeparator"></span>Only recent changes are processed by live synchronization.<br><span class="segmentSeparator"></span>Therefore it is a very efficient mechanism which usually has fast responses even in large-scale deployments.</p>
</li>
<li>
<p><strong>Reconciliation</strong> is a process that compares the data and corrects them.<br><span class="segmentSeparator"></span>When an account is reconciled midPoint computes the attribute values that the account should have.<br><span class="segmentSeparator"></span>The computed values are compared to the real values that the account has.<br><span class="segmentSeparator"></span>Any differences are corrected.<br><span class="segmentSeparator"></span>Reconciliation is quite heavy-weight mechanism, comparing all the accounts one-by-one.<br><span class="segmentSeparator"></span>But it is also a very reliable mechanism.<br><span class="segmentSeparator"></span>It can correct mistakes that were missed by live synchronization, it can correct data after major failures and corruptions and so on.<br><span class="segmentSeparator"></span>Reconciliation is usually executed in regular intervals.<br><span class="segmentSeparator"></span>However due to its nature it is usually executed during off-peak times (nights and weekends).</p>
</li>
<li>
<p><strong>Import</strong> is usually a one-time process to get data from the resource to midPoint.<br><span class="segmentSeparator"></span>Import is used to populate midPoint with initial data or it may be used to connect a new resource to midPoint.<br><span class="segmentSeparator"></span>Import is almost the same as reconciliation with only a few minor differences.<br><span class="segmentSeparator"></span>However its purpose is different and therefore there is usually also a slightly different configuration of import policies (mappings).<br><span class="segmentSeparator"></span>Import is usually not scheduled, it is manually triggered when needed.</p>
</li>
<li>
<p><strong>Opportunistic synchronization</strong> is a very special kind of animal which is quite unique to midPoint.<br><span class="segmentSeparator"></span>Opportunistic synchronization is triggered automatically when midPoint discovers that something is not in order.<br><span class="segmentSeparator"></span>For example if midPoint tries to modify an account, but it discovers that the account is not there.<br><span class="segmentSeparator"></span>Then a synchronization mechanism is triggered just for that single account.<br><span class="segmentSeparator"></span>Which usually means that the account is re-created.<br><span class="segmentSeparator"></span>The opportunistic synchronization is also triggered when midPoint tries to create a new account, but the account is already there.<br><span class="segmentSeparator"></span>This approach makes midPoint a self-healing system.<br><span class="segmentSeparator"></span>If midPoint runs into a problem it can often correct the problem by itself.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Individual mechanisms differ in a way data inconsistency is discovered: livesync will actively look for new changes, reconciliation will compare the data one-by-one and opportunistic synchronization will discover inconsistency by pure chance.<br><span class="segmentSeparator"></span>But all the mechanism react to inconsistency in the same way.<br><span class="segmentSeparator"></span>There is only one policy that specifies how to fix the system.<br><span class="segmentSeparator"></span>Of course, there may be slight deviations in the behavior.<br><span class="segmentSeparator"></span>For example we usually want <em>import</em> to behave in slightly different way than <em>reconciliation</em>.<br><span class="segmentSeparator"></span>And midPoint allows that.<br><span class="segmentSeparator"></span>But overall, there is just one big synchronization mechanism.<br><span class="segmentSeparator"></span>And this has a good reason.<br><span class="segmentSeparator"></span>It does not really matter how the problem was discovered.<br><span class="segmentSeparator"></span>What really matters is that the problem gets fixed.<br><span class="segmentSeparator"></span>We do not want to maintain four separate configurations for that.<br><span class="segmentSeparator"></span>Having one policy is enough.<br><span class="segmentSeparator"></span>MidPoint knows which part of the configuration need to be applied in each specific situation.<br><span class="segmentSeparator"></span>And it does it automatically.<br><span class="segmentSeparator"></span>This unifying approach significantly simplifies the configuration of midPoint synchronization mechanisms.<br><span class="segmentSeparator"></span>And that is also a reason why the boundaries of individual synchronization mechanisms are quite fuzzy.<br><span class="segmentSeparator"></span>In fact this is just a single big mechanism with several facets.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sources_targets_and_other_creatures">Sources, Targets And Other Creatures</h3>
<div class="paragraph">
<p>The tale of idealistic identity management deployment starts with a human resources (HR) system.<br><span class="segmentSeparator"></span>The HR system is supposed to have records for all the identities therefore it is <em>authoritative source</em> resource.<br><span class="segmentSeparator"></span>Identity management system pulls in all the data from HR, recomputes them and creates accounts on <em>target resources</em>.<br><span class="segmentSeparator"></span>And they lived happily ever after.</p>
</div>
<div class="paragraph">
<p>Now, let’s get back to reality.<br><span class="segmentSeparator"></span>The HR resource is indeed an authoritative source of data in many real-world cases.<br><span class="segmentSeparator"></span>But it is a limited source.<br><span class="segmentSeparator"></span>It contains only data about employees.<br><span class="segmentSeparator"></span>And it has only a partial information.<br><span class="segmentSeparator"></span>For example there is no username.<br><span class="segmentSeparator"></span>Username has to be generated by IDM logic.<br><span class="segmentSeparator"></span>There is no initial password.<br><span class="segmentSeparator"></span>Organizational structure assignment is often incomplete, missing or unreliable.<br><span class="segmentSeparator"></span>Therefore it is only a <em>partially-authoritative source</em>.<br><span class="segmentSeparator"></span>There may be additional authoritative sources for contractors, partners, suppliers, support engineers and other identities that need to access our systems.<br><span class="segmentSeparator"></span>These are <em>additional source systems</em>.<br><span class="segmentSeparator"></span>Then there is a directory system which is often Active Directory.<br><span class="segmentSeparator"></span>This should be a <em>target resource</em> in theory.<br><span class="segmentSeparator"></span>But there usually there are pieces of authoritative information in here.<br><span class="segmentSeparator"></span>For example an algorithm to generate a username may be based on the usernames that are already taken in the Active Directory.<br><span class="segmentSeparator"></span>The active directory may also be needed to create an e-mail address.<br><span class="segmentSeparator"></span>Directory systems are also used as a semi-authoritative sources for telephone numbers, office numbers and so on.<br><span class="segmentSeparator"></span>Therefore such resource are both <em>target</em> and <em>source</em> resources.<br><span class="segmentSeparator"></span>And then there are finally target resources.<br><span class="segmentSeparator"></span>These are not authoritative in any way.<br><span class="segmentSeparator"></span>Identity management system will only write to these.<br><span class="segmentSeparator"></span>Or …​ will it?<br><span class="segmentSeparator"></span>What happens when a conflicting account already exists on such resource and therefore we cannot create a new account for a new employee.<br><span class="segmentSeparator"></span>And how do we check if there are no accounts that are not supposed to be there?<br><span class="segmentSeparator"></span>It turns out that even the target systems contain valuable information after all.</p>
</div>
<div class="paragraph">
<p>The reality brings a wild mix of source, target, semi-source, target/source and quasi-target resources that are almost impossible to put into a pre-defined boxes.<br><span class="segmentSeparator"></span>Therefore midPoint does not bother to define a concept of "source" or "target" resource.<br><span class="segmentSeparator"></span>All resources can be both sources and targets and the authoritativeness of each attribute can be controlled on a very fine level.<br><span class="segmentSeparator"></span>Almost every real-world situation can easily fit into this model.</p>
</div>
</div>
<div class="sect2">
<h3 id="_inbound_and_outbound_mappings">Inbound and Outbound Mappings</h3>
<div class="paragraph">
<p>MidPoint is firmly based on the principle of reuse.<br><span class="segmentSeparator"></span>Previous chapter explained that behavior of attributes during provisioning is controlled by <em>mappings</em>.<br><span class="segmentSeparator"></span>Therefor is is perhaps no big surprise that the behavior of attributes during synchronization is also controlled by mappings.<br><span class="segmentSeparator"></span>In fact, provisioning is just a special case of synchronization.<br><span class="segmentSeparator"></span>Following picture explains the combined mechanism.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/05-01-sync-source-target.png" alt="Synchronization">
</div>
</div>
<div class="paragraph">
<p>There are two types of mappings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Inbound mappings</strong> map data <em>into</em> midPoint.<br><span class="segmentSeparator"></span>These mappings take the data from the source resources, transform them and apply the result to the user object.</p>
</li>
<li>
<p><strong>Outbound mappings</strong> map data <em>out of</em> midPoint.<br><span class="segmentSeparator"></span>These mappings take user properties, transform them and apply the result to account attributes in target systems.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The mappings themselves are almost the same regardless whether they are inbound or outbound.<br><span class="segmentSeparator"></span>They have sources, targets, expressions, conditions, etc.<br><span class="segmentSeparator"></span>Just the sources and targets are reversed:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top"></th>
<th class="tableblock halign-left valign-top">Inbound mapping</th>
<th class="tableblock halign-left valign-top">Outbound mapping</th>
</tr>
</thead>
<tbody>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Direction</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource → midPoint</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">midPoint → resource</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Mapping source</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource object (e.g.<br><span class="segmentSeparator"></span>account)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">focal object (e.g.<br><span class="segmentSeparator"></span>user)</p></td>
</tr>
<tr>
<th class="tableblock halign-left valign-top"><p class="tableblock">Mapping target</p></th>
<td class="tableblock halign-left valign-top"><p class="tableblock">focal object (e.g.<br><span class="segmentSeparator"></span>user)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">resource object (e.g.<br><span class="segmentSeparator"></span>account)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>That is it.<br><span class="segmentSeparator"></span>Just think about the same mappings that were used in previous chapter, just flip the direction.<br><span class="segmentSeparator"></span>Now the mapping will take data from the account and the results will be applied to user object.<br><span class="segmentSeparator"></span>Like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;attribute&gt;</span>
    <span class="tag">&lt;ref&gt;</span>ri:lastname<span class="tag">&lt;/ref&gt;</span>
    <span class="tag">&lt;inbound&gt;</span>
        <span class="tag">&lt;target&gt;</span>
            <span class="tag">&lt;path&gt;</span>$focus/familyName<span class="tag">&lt;/path&gt;</span>
        <span class="tag">&lt;/target&gt;</span>
    <span class="tag">&lt;/inbound&gt;</span>
<span class="tag">&lt;/attribute&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This mapping will take the value of <code>lastname</code> attribute from the resource and store the value in <code>familyName</code> property of midPoint user.</p>
</div>
<div class="paragraph">
<p>The rest is the same as outbound mappings.<br><span class="segmentSeparator"></span>All the expressions and evaluators can be used for inbound mappings in the same way as for outbound mappings.<br><span class="segmentSeparator"></span>For example a Groovy expression can be used to sanitize the value before it is stored in midPoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;attribute&gt;</span>
    <span class="tag">&lt;ref&gt;</span>ri:lastname<span class="tag">&lt;/ref&gt;</span>
    <span class="tag">&lt;inbound&gt;</span>
        <span class="tag">&lt;expression&gt;</span>
            <span class="tag">&lt;script&gt;</span>
<span class="inline">                <span class="tag">&lt;code&gt;</span>lastname?.trim()<span class="tag">&lt;/code&gt;</span></span>
            <span class="tag">&lt;/script&gt;</span>
        <span class="tag">&lt;/expression&gt;</span>
        <span class="tag">&lt;target&gt;</span>
            <span class="tag">&lt;path&gt;</span>$focus/familyName<span class="tag">&lt;/path&gt;</span>
        <span class="tag">&lt;/target&gt;</span>
    <span class="tag">&lt;/inbound&gt;</span>
<span class="tag">&lt;/attribute&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The same approach can also be taken for activation and even for password mappings.<br><span class="segmentSeparator"></span>However, there is one difference for password mappings.<br><span class="segmentSeparator"></span>Password are usually write-only value.<br><span class="segmentSeparator"></span>When the password is written it is usually hashed and the original value cannot be retrieved any longer.<br><span class="segmentSeparator"></span>Then there are resource such as HR systems that do not store employee passwords at all because those are not really accounts that we are reading.<br><span class="segmentSeparator"></span>Those are just regular database entries that the connector presents as accounts.<br><span class="segmentSeparator"></span>Inbound password synchronization is almost never easy and it often requires a lot of planning and ingenuity.<br><span class="segmentSeparator"></span>However, there is one method that is used quite often.<br><span class="segmentSeparator"></span>The initial user passwords are usually randomly generated.<br><span class="segmentSeparator"></span>As this is a very common case midPoint can do this easily:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;credentials&gt;</span>
    <span class="tag">&lt;password&gt;</span>
        <span class="tag">&lt;inbound&gt;</span>
            <span class="tag">&lt;strength&gt;</span>weak<span class="tag">&lt;/strength&gt;</span>
            <span class="tag">&lt;expression&gt;</span>
                <span class="tag">&lt;generate</span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/expression&gt;</span>
        <span class="tag">&lt;/inbound&gt;</span>
    <span class="tag">&lt;/password&gt;</span>
<span class="tag">&lt;/credentials&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This mapping generates random password for a user.<br><span class="segmentSeparator"></span>Both the mapping and the <code>generate</code> expression evaluators are quite smart.<br><span class="segmentSeparator"></span>The mapping knows that the target is user password without any need to explicitly specify that.<br><span class="segmentSeparator"></span>In addition to that the generate expression evaluator will take user password policy into consideration.<br><span class="segmentSeparator"></span>It does not make sense to generate any random password.<br><span class="segmentSeparator"></span>If we do not consider password policy then we can generate password that is too short, too long, too weak to pass the policy or to strong to be useful in any way.<br><span class="segmentSeparator"></span>Therefore the <code>generate</code> expression will look for password policy and generate a random password that just matches the specified password policy.</p>
</div>
<div class="paragraph">
<p>There are more important details to see here.<br><span class="segmentSeparator"></span>The inbound password mapping is <em>weak</em>.<br><span class="segmentSeparator"></span>And there is good reason for this.<br><span class="segmentSeparator"></span>We do not want midPoint password to be replaced by randomly generated password.<br><span class="segmentSeparator"></span>We only want to set a random password in case that it is an initial password, the first and only password.<br><span class="segmentSeparator"></span>And that is exactly what a weak mapping does: it sets new value only if the target does not have any existing value.<br><span class="segmentSeparator"></span>Therefore this mapping will not overwrite passwords that are already set.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is no direct account-account synchronization in midPoint.<br><span class="segmentSeparator"></span>As explained before, midPoint follows start topology (a.k.a.<br><span class="segmentSeparator"></span>"hub and spoke").<br><span class="segmentSeparator"></span>Therefore the synchronization is either from account to user (inbound) or from user to account (outbound).<br><span class="segmentSeparator"></span>The effect of account-account synchronization is achieved by combing inbound and outbound synchronization mechanisms.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_correlation">Correlation</h3>
<div class="paragraph">
<p>It is all quite easy to import all HR records into an empty midPoint.<br><span class="segmentSeparator"></span>Set up inbound mappings, start import task, wait a bit and all is done.<br><span class="segmentSeparator"></span>But practical situations are much more complex.<br><span class="segmentSeparator"></span>Synchronization algorithm usually do not run on a green field.<br><span class="segmentSeparator"></span>Live synchronization and reconciliation are supposed to work with pre-existing midPoint users.<br><span class="segmentSeparator"></span>And import is usually not trivial either, for example in cases when we try to import data from an additional data source into a running midPoint deployment.<br><span class="segmentSeparator"></span>Some users in the import set are new, but there may be accounts for existing users.<br><span class="segmentSeparator"></span>We need to tell the difference between brand new account and an account that belongs to an existing user.<br><span class="segmentSeparator"></span>We need to handle those situations in a different way.<br><span class="segmentSeparator"></span>Of course, midPoint has an easy solution for this: correlation mechanism.</p>
</div>
<div class="paragraph">
<p>Correlation expression is a method how to connect newly-discovered accounts and existing users.<br><span class="segmentSeparator"></span>It works like this: whenever midPoint discovers new account it will try to link that account to an existing user.<br><span class="segmentSeparator"></span>Correlation expression is used to do this.<br><span class="segmentSeparator"></span>Correlation expression is in fact a parametric search query.<br><span class="segmentSeparator"></span>Such search query is constructed for every new account and it is used to look for users that the account belongs to.<br><span class="segmentSeparator"></span>The easiest form of the correlation expression is to look by using an identifier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;correlation&gt;</span>
    <span class="tag">&lt;q:equal&gt;</span>
        <span class="tag">&lt;q:path&gt;</span>employeeNumber<span class="tag">&lt;/q:path&gt;</span>
        <span class="tag">&lt;expression&gt;</span>
            <span class="tag">&lt;path&gt;</span>$projection/attributes/empno<span class="tag">&lt;/path&gt;</span>
        <span class="tag">&lt;/expression&gt;</span>
    <span class="tag">&lt;/q:equal&gt;</span>
<span class="tag">&lt;/correlation&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This correlation query takes the value of <code>empno</code> attribute of the account.<br><span class="segmentSeparator"></span>This value is placed into the search query that midPoint computes in memory.<br><span class="segmentSeparator"></span>Given an account with empno attribute set to <code>007</code>, the resulting search filter looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;q:equal&gt;</span>
        <span class="tag">&lt;q:path&gt;</span>employeeNumber<span class="tag">&lt;/q:path&gt;</span>
        <span class="tag">&lt;q:value&gt;</span>007<span class="tag">&lt;/q:value&gt;</span>
    <span class="tag">&lt;/q:equal&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>MidPoint looks for users that match this search filter.<br><span class="segmentSeparator"></span>If there is an user with <code>employeeNumber</code> property set to <code>007</code> then such user is considered to be an owner of the account.</p>
</div>
<div class="paragraph">
<p>MidPoint has its own data representation mechanism and object structure.<br><span class="segmentSeparator"></span>Therefore midPoint also has its own query language that is designed to work with the object structure.<br><span class="segmentSeparator"></span>The query language is not difficult to learn as it follows the structure of other common query languages.<br><span class="segmentSeparator"></span>The language itself is described later in the book and in midPoint documentation.<br><span class="segmentSeparator"></span>But do not worry about this too much now.<br><span class="segmentSeparator"></span>Vast majority of correlation expressions is very simple.<br><span class="segmentSeparator"></span>In fact it is usually just a single <code>equal</code> clause just like that one used in the example above.</p>
</div>
<div class="paragraph">
<p>Using search queries for correlation may seem a little bit too complex.<br><span class="segmentSeparator"></span>But it is necessary.<br><span class="segmentSeparator"></span>The correlation expression must be a search filter because that is the only efficient way how to find single user in a large set of other users.<br><span class="segmentSeparator"></span>We cannot scan the accounts one-by-one.<br><span class="segmentSeparator"></span>We need to utilize the search power of the database for this.</p>
</div>
</div>
<div class="sect2">
<h3 id="_synchronization_situations_and_reactions">Synchronization Situations and Reactions</h3>
<div class="paragraph">
<p>Correlation expression can be used to find an owner for a new account.<br><span class="segmentSeparator"></span>That is a part of the solution but not entire solution.<br><span class="segmentSeparator"></span>If the owner is found then the action is quite obvious: link the account to the user and proceed as usual.<br><span class="segmentSeparator"></span>But what to do if the owner is not found?<br><span class="segmentSeparator"></span>This resource may be an authoritative resource and therefore we want to create a new user based on the account.<br><span class="segmentSeparator"></span>Or this may be a reconciliation with a target resource and in that case this means that we have found an illegal account.<br><span class="segmentSeparator"></span>We probably want to disable such account.<br><span class="segmentSeparator"></span>And what to do if more than one owner is found?<br><span class="segmentSeparator"></span>This can all become quite complicated.<br><span class="segmentSeparator"></span>Therefore midPoint as a concept of <em>synchronization situations</em> to make it understandable and manageable.</p>
</div>
<div class="paragraph">
<p>Whenever midPoint deals with a change on an account the <em>situation</em> of that account is determined.<br><span class="segmentSeparator"></span>The situation reflects whether this account is already linked to the user, whether we know the candidate owner, but it is not linked yet, whether we cannot determine the owner and so on.<br><span class="segmentSeparator"></span>Individual situations are explained in the following table.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Situation</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>linked</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The account is properly linked to the owner.<br><span class="segmentSeparator"></span>This is the normal situation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>unlinked</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The account is not linked to the owner, but we know who the owner is.<br><span class="segmentSeparator"></span>Correlation expression told us who the owner is.<br><span class="segmentSeparator"></span>In this case midPoint thinks that the link should exist, but it is not linked yet.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>unmatched</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The account is not linked and we not even know who the owner is.<br><span class="segmentSeparator"></span>The correlation expression haven’t returned any candidates.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>disputed</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The account is not linked, but there are more potential owners.<br><span class="segmentSeparator"></span>The correlation expression returned more than one candidate.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>collision</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The account is linked to more than one owner.<br><span class="segmentSeparator"></span>This should not happen under normal circumstances.<br><span class="segmentSeparator"></span>This is usually caused by faulty customizations or software bugs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>deleted</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">There was an existing account but it was deleted on the resource.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>After synchronization <em>situation</em> is determined, midPoint continues by figuring out what a proper <em>reaction</em> is.<br><span class="segmentSeparator"></span>The reaction is quite clear for some situations (e.g.<br><span class="segmentSeparator"></span><code>unlinked</code>), but there is a lot of variability for other situations (e.g.<br><span class="segmentSeparator"></span><code>unmatched</code>).<br><span class="segmentSeparator"></span>This variability is a reason that midPoint allows to set a reaction for each situation individually.<br><span class="segmentSeparator"></span>There are several pre-defined reactions:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Action</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Add focus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">New midPoint user will be created and it will linked to the account.<br><span class="segmentSeparator"></span>This is usually a reaction configured for authoritative resources, used in situation when a new account is discovered.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delete focus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MidPoint user that owns the account will be deleted.<br><span class="segmentSeparator"></span>This is usually a reaction configured for authoritative resources, used in situations when midPoint detects that an account was deleted.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inactivate focus</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MidPoint user that owns the account will be disabled.<br><span class="segmentSeparator"></span>This is also used for authoritative resources.<br><span class="segmentSeparator"></span>But this is a milder reaction.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Link</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The user-account link will be created.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unlink</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The user-account link will be removed.<br><span class="segmentSeparator"></span>The account will no longer be linked to the user.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delete shadow</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The account will be deleted.<br><span class="segmentSeparator"></span>This is the usual reaction when illegal account is detected on non-authoritative resource.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Inactivate shadow</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The account will be disabled.<br><span class="segmentSeparator"></span>Usually a milder reaction to an illegal account.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If no reaction is explicitly configured for a situation then midPoint does nothing.<br><span class="segmentSeparator"></span>Just the situation is recorded in midPoint repository.<br><span class="segmentSeparator"></span>This is part of midPoint philosophy not to change the data unless an action was explicitly configured.</p>
</div>
<div class="paragraph">
<p>The reactions can be defined in the synchronization section of resource configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;synchronization&gt;</span>
    <span class="tag">&lt;objectSynchronization&gt;</span>
        <span class="tag">&lt;correlation&gt;</span>...<span class="tag">&lt;/correlation&gt;</span>
        <span class="tag">&lt;reaction&gt;</span>
            <span class="tag">&lt;situation&gt;</span>linked<span class="tag">&lt;/situation&gt;</span>
            <span class="tag">&lt;synchronize&gt;</span>true<span class="tag">&lt;/synchronize&gt;</span>
        <span class="tag">&lt;/reaction&gt;</span>
        <span class="tag">&lt;reaction&gt;</span>
            <span class="tag">&lt;situation&gt;</span>deleted<span class="tag">&lt;/situation&gt;</span>
            <span class="tag">&lt;action&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;handlerUri&gt;</span>http://midpoint.evolveum.com/xml/ns/public/model/action-3#deleteFocus<span class="tag">&lt;/handlerUri&gt;</span>
            <span class="tag">&lt;/action&gt;</span>
        <span class="tag">&lt;/reaction&gt;</span>
        <span class="tag">&lt;reaction&gt;</span>
            <span class="tag">&lt;situation&gt;</span>unlinked<span class="tag">&lt;/situation&gt;</span>
            <span class="tag">&lt;action&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;handlerUri&gt;</span>http://midpoint.evolveum.com/xml/ns/public/model/action-3#link<span class="tag">&lt;/handlerUri&gt;</span>
            <span class="tag">&lt;/action&gt;</span>
        <span class="tag">&lt;/reaction&gt;</span>
        <span class="tag">&lt;reaction&gt;</span>
            <span class="tag">&lt;situation&gt;</span>unmatched<span class="tag">&lt;/situation&gt;</span>
            <span class="tag">&lt;action&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;handlerUri&gt;</span>http://midpoint.evolveum.com/xml/ns/public/model/action-3#addFocus<span class="tag">&lt;/handlerUri&gt;</span>
            <span class="tag">&lt;/action&gt;</span>
        <span class="tag">&lt;/reaction&gt;</span>
    <span class="tag">&lt;/objectSynchronization&gt;</span>
<span class="tag">&lt;/synchronization&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Most of the configuration is perhaps self-explanatory.<br><span class="segmentSeparator"></span>This is a typical authoritative resource.<br><span class="segmentSeparator"></span>If there is a new account on the resource and we do not have an owner (situation: <code>unmatched</code>) then create a new user (action: <code>addFocus</code>).<br><span class="segmentSeparator"></span>If the account is deleted from the resource (situation: <code>deleted</code>) then delete the user as well (action: <code>deleteFocus</code>).<br><span class="segmentSeparator"></span>If we happen to find an account which should be linked but it is not (situation: unlinked) then link it (action: <code>link</code>).<br><span class="segmentSeparator"></span>The only think that deserves an explanation is the reaction to linked situation.<br><span class="segmentSeparator"></span>In this case there is not much to do.<br><span class="segmentSeparator"></span>Everything seems to be in order.<br><span class="segmentSeparator"></span>However there may still be attributes that are not set correctly.<br><span class="segmentSeparator"></span>Remember the inbound mappings?<br><span class="segmentSeparator"></span>The inbound mappings were not even mentioned in this section yet.<br><span class="segmentSeparator"></span>And for a good reason.<br><span class="segmentSeparator"></span>The inbound mappings are not evaluated at this stage.<br><span class="segmentSeparator"></span>Evaluation of inbound mappings happen only after the situations and reactions are evaluated.<br><span class="segmentSeparator"></span>We need this so all the accounts are properly linked (or unlinked) and the inbound mappings have valid sources and targets.<br><span class="segmentSeparator"></span>But the evaluation of inbound and outbound mappings do not happen by themselves.<br><span class="segmentSeparator"></span>MidPoint does not change the data unless it is explicitly configured to.<br><span class="segmentSeparator"></span>There are reactions for <code>unmatched</code>, <code>deleted</code> and <code>unlinked</code> situations.<br><span class="segmentSeparator"></span>Therefore in those cases midPoint assumes that it is expected to fully synchronize everything and therefore all the mappings and policies are evaluated automatically.<br><span class="segmentSeparator"></span>But there is no reaction for <code>linked</code> situation.<br><span class="segmentSeparator"></span>In that case midPoint assumes that it should do nothing as nothing is explicitly configured.<br><span class="segmentSeparator"></span>Hence the <code>synchronize</code> property.<br><span class="segmentSeparator"></span>This property can be used to force midPoint to do full synchronization even if there is no explicit action configured.<br><span class="segmentSeparator"></span>And it can also be used to avoid full synchronization even if explicit action is configured.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/05-02-synchronization-flow.png" alt="Synchronization flow">
</div>
</div>
<div class="paragraph">
<p>The figure above illustrates the usual sequence of events during inbound synchronization:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Account is stored in the resource database.</p>
</li>
<li>
<p>Appropriate identity connector is used to read the account.</p>
</li>
<li>
<p>Account shadow is created in midPoint.</p>
</li>
<li>
<p>Correlation expression is evaluated to determine account ownership (if the account is not already linked to a user).</p>
</li>
<li>
<p>Synchronization situation is determined based on account ownership and state of the account.</p>
</li>
<li>
<p>Appropriate reaction to the situation is determined based on resource configuration.</p>
</li>
<li>
<p>Inbound mappings are evaluated to map account values to the user.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Please note that the description of this process is slightly simplified for clarity.<br><span class="segmentSeparator"></span>There are also obvious deviations from this process.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>inbound mappings are skipped in case that the user is about to be deleted, the mappings are also skipped if the reaction does not include “synchronization” and so on.<br><span class="segmentSeparator"></span>But generally this is what usually happens during inbound synchronization.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
MidPoint is an extensible system.<br><span class="segmentSeparator"></span>There are several prefabricated synchronization reactions described above.<br><span class="segmentSeparator"></span>Those reactions can handle vast majority of situations that happen during synchronization.<br><span class="segmentSeparator"></span>However, there is a possibility to extend the system with completely custom reactions.<br><span class="segmentSeparator"></span>MidPoint was designed for this.<br><span class="segmentSeparator"></span>This is the theory.<br><span class="segmentSeparator"></span>However, currently this part of midPoint is only partially extensible.<br><span class="segmentSeparator"></span>Full extensibility feature was planned, but it was never implemented.<br><span class="segmentSeparator"></span>Therefore extensibility of synchronization reaction is possible, but it might be quite hard to achieve this in practice and it may require significant development effort.<br><span class="segmentSeparator"></span>But there is another way.<br><span class="segmentSeparator"></span>MidPoint development team would absolutely love to finish this extensibility feature as it was originally planned.<br><span class="segmentSeparator"></span>However, existing midPoint customers had so far prioritized other features.<br><span class="segmentSeparator"></span>MidPoint subscribers and sponsors are funding the development therefore midPoint development must follow their priorities.<br><span class="segmentSeparator"></span>Therefore if you are interested in full synchronization reaction extensibility (or any other feature) please consider purchasing midPoint subscription or sponsoring the feature.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_synchronization_tasks">Synchronization Tasks</h3>
<div class="paragraph">
<p>Now we know how the inbound synchronization works: midPoint reads the account, then correlation is applied, situation determined and reaction executed.<br><span class="segmentSeparator"></span>However, we have not yet discussed the details of the very first step: how does midPoint actually read the account?<br><span class="segmentSeparator"></span>Nothing happens without a reason, therefore there must be some active component in midPoint that actually looks for the new, changed and deleted accounts.<br><span class="segmentSeparator"></span>And that component is a <em>synchronization task</em>.</p>
</div>
<div class="paragraph">
<p>MidPoint <em>task</em> is an active process that is running inside midPoint server.<br><span class="segmentSeparator"></span>This is the first time that we encountered the concept of a <em>task</em>, but it is definitely not the last one.<br><span class="segmentSeparator"></span>Tasks are used for many purposes in midPoint.<br><span class="segmentSeparator"></span>They are used to track long-running operations, approvals and actions that work on large sets of objects (bulk actions).<br><span class="segmentSeparator"></span>There are tasks that execute cleanup jobs, compile reports and provide variety of other functions.<br><span class="segmentSeparator"></span>The concept of tasks is a very powerful and flexible one.<br><span class="segmentSeparator"></span>Tasks can be used to track execution of a short one-off operations.<br><span class="segmentSeparator"></span>Tasks can be used to execute scheduled actions in regular intervals.<br><span class="segmentSeparator"></span>Or tasks can be used to track long-running processes.<br><span class="segmentSeparator"></span>We will be using tasks in almost every chapter of this book.</p>
</div>
<div class="paragraph">
<p>Tasks are used as an active component to "run" almost all synchronization mechanisms:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Reconciliation task</strong> is listing all the accounts from a specific resource.<br><span class="segmentSeparator"></span>The task executes reconciliation process for every account that is found.<br><span class="segmentSeparator"></span>This means that midPoint computes how that particular account should look like and then the computed values are compared with real account attributes.<br><span class="segmentSeparator"></span>This task is usually scheduled for regular execution using quite a long execution interval (days or weeks).</p>
</li>
<li>
<p><strong>Live synchronization task</strong> is looking (polling) for changes in a specific resource.<br><span class="segmentSeparator"></span>The task will look for created, modified and deleted accounts.<br><span class="segmentSeparator"></span>The task will get a description of the change and pass that to midPoint synchronization mechanisms.<br><span class="segmentSeparator"></span>This task is almost always scheduled for regular execution and the execution interval is very short (minutes or seconds).</p>
</li>
<li>
<p><strong>Import from resource task</strong> is listing all the accounts from a specific resource.<br><span class="segmentSeparator"></span>The task will pretend that the accounts were just created.<br><span class="segmentSeparator"></span>This usually motivates midPoint to create users based on those accounts or link these accounts to existing users.<br><span class="segmentSeparator"></span>This task is usually not scheduled and it is almost always executed manually.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each type of synchronization task is detecting changes using a different mechanism.<br><span class="segmentSeparator"></span>However, once the task detects the change or reads the account then the processing is the same for all tasks.<br><span class="segmentSeparator"></span>All the tasks lead to the same algorithms based on the same configuration and policies.<br><span class="segmentSeparator"></span>Therefore it does not matter whether it has all started in reconciliation or live synchronization task.<br><span class="segmentSeparator"></span>It will all end up in the same correlation-situation-reaction-mapping process.</p>
</div>
<div class="paragraph">
<p>However, the tasks are necessary to initiate the synchronization.<br><span class="segmentSeparator"></span>They are the active part, the spark that starts the synchronization process.<br><span class="segmentSeparator"></span>Without the tasks the synchronization does not really work.<br><span class="segmentSeparator"></span>There are ways how the synchronization can "happen" even without a task, e.g.<br><span class="segmentSeparator"></span>as a reaction to user interface operation or if a new account is discovered during an unrelated operation.<br><span class="segmentSeparator"></span>But practical deployments need at least one synchronization task to work properly.<br><span class="segmentSeparator"></span>This task takes care of vast majority of synchronization cases.</p>
</div>
<div class="paragraph">
<p>Strictly speaking tasks are quite a strange kind of animal.<br><span class="segmentSeparator"></span>Tasks have their data and configuration as most other midPoint objects.<br><span class="segmentSeparator"></span>But tasks are active.<br><span class="segmentSeparator"></span>Therefore there are CPU threads associated with the tasks when the tasks are running.<br><span class="segmentSeparator"></span>There are mechanisms how to monitor task progress.<br><span class="segmentSeparator"></span>The tasks need to be cluster-aware so they can fail over to a different midPoint node if one node fails.<br><span class="segmentSeparator"></span>The tasks are quite rich and a bit tricky to handle.<br><span class="segmentSeparator"></span>But midPoint is making task handling reasonably simple.<br><span class="segmentSeparator"></span>Tasks are represented as ordinary midPoint objects.<br><span class="segmentSeparator"></span>Therefore they can be imported to midPoint in XML/JSON/YAML form as any other object.<br><span class="segmentSeparator"></span>Tasks can be easily edited in their XML/JSON/YAML form to change the scheduling, modify the parameters and so on.<br><span class="segmentSeparator"></span>Of course, there are some special functions that only the tasks have (such as suspend and resume) that cannot be controlled using the XML/JSON/YAML format.<br><span class="segmentSeparator"></span>But vast majority of task management can be done using the very same methods that are used to control other midPoint objects.</p>
</div>
<div class="paragraph">
<p>Tasks can be created by taking the XML and importing that to midPoint.<br><span class="segmentSeparator"></span>And that’s the way how synchronization tasks are often managed.<br><span class="segmentSeparator"></span>When an XML-formatted resource definition is created then there is often an associated synchronization task.<br><span class="segmentSeparator"></span>Which means that both resource and all the necessary synchronization tasks can be imported together.<br><span class="segmentSeparator"></span>Synchronization tasks can also be created from midPoint user user interface.<br><span class="segmentSeparator"></span>They are usually created by using special-purpose buttons in resource detail pages.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/05-03-synchronization-tasks.png" alt="Synchronization tasks">
</div>
</div>
<div class="paragraph">
<p>Once the synchronization tasks are created they can be managed in the same way as other tasks are managed: in the <em>Server tasks</em> part of the midPoint user interface.</p>
</div>
</div>
<div class="sect2">
<h3 id="_synchronization_example_hr_feed">Synchronization Example: HR Feed</h3>
<div class="paragraph">
<p>This section describes complete working example that feeds HR data into midPoint.<br><span class="segmentSeparator"></span>The ExAmPLE company HR system is an old and complex system.<br><span class="segmentSeparator"></span>Therefore the easiest integration method is to use structured text exports.<br><span class="segmentSeparator"></span>The HR system is set up to export the employee data to a comma-separated text file (CSV) every night.<br><span class="segmentSeparator"></span>MidPoint takes this export file and updates the data about users.</p>
</div>
<div class="paragraph">
<p>This configuration is done in three steps.<br><span class="segmentSeparator"></span>First we will use a simple setup to import the data into midPoint.<br><span class="segmentSeparator"></span>This is an operation that is executed only once.<br><span class="segmentSeparator"></span>Then the configuration will be updated to run scheduled reconciliation task.<br><span class="segmentSeparator"></span>Reconciliation compares all the data records every time and it makes any necessary updates.<br><span class="segmentSeparator"></span>Even though this method would be perfectly acceptable for the company of this size, we still set up a live synchronization task.</p>
</div>
<div class="paragraph">
<p>The core of the configuration is contained in a single resource definition file.<br><span class="segmentSeparator"></span>Following paragraphs explain individual parts of the file.<br><span class="segmentSeparator"></span>There are few additional configuration files for reconciliation and live synchronization tasks.<br><span class="segmentSeparator"></span>Simplified XML notation is used for clarity.<br><span class="segmentSeparator"></span>The complete file in a form that is directly usable in midPoint can be found at the same place as all the other samples in this book
(see <a href="https://docs.evolveum.com/book/practical-identity-management-with-midpoint.html#92-additional-information">Additional Information</a> chapter for details).</p>
</div>
<div class="paragraph">
<p>This HR resource is a data source.<br><span class="segmentSeparator"></span>It will be used to "pull" the data inside midPoint.<br><span class="segmentSeparator"></span>However, as we have described previously, there is no fundamental difference between source and target resources in midPoint.<br><span class="segmentSeparator"></span>Therefore this HR resource starts in entirely ordinary way.<br><span class="segmentSeparator"></span>There is a reference to the CSV connector and the connector configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;resource</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">03c3ceea-78e2-11e6-954d-dfdfa9ace0cf</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>HR System<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;connectorRef&gt;</span>...<span class="tag">&lt;/connectorRef&gt;</span>
    <span class="tag">&lt;connectorConfiguration&gt;</span>
        <span class="tag">&lt;configurationProperties&gt;</span>
            <span class="tag">&lt;filePath&gt;</span>/var/opt/midpoint/resources/hr.csv<span class="tag">&lt;/filePath&gt;</span>
            <span class="tag">&lt;encoding&gt;</span>utf-8<span class="tag">&lt;/encoding&gt;</span>
            <span class="tag">&lt;fieldDelimiter&gt;</span>,<span class="tag">&lt;/fieldDelimiter&gt;</span>
            <span class="tag">&lt;multivalueDelimiter&gt;</span>;<span class="tag">&lt;/multivalueDelimiter&gt;</span>
            <span class="tag">&lt;uniqueAttribute&gt;</span>empno<span class="tag">&lt;/uniqueAttribute&gt;</span>
            <span class="tag">&lt;passwordAttribute&gt;</span>password<span class="tag">&lt;/passwordAttribute&gt;</span>
        <span class="tag">&lt;/configurationProperties&gt;</span>
    <span class="tag">&lt;/connectorConfiguration&gt;</span>
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next section is schema handling configuration.<br><span class="segmentSeparator"></span>That is where is becomes slightly more interesting.<br><span class="segmentSeparator"></span>The schema handling section contains inbound mappings for HR account attributes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;schemaHandling&gt;</span>
        <span class="tag">&lt;objectType&gt;</span>
            <span class="tag">&lt;objectClass&gt;</span>ri:AccountObjectClass<span class="tag">&lt;/objectClass&gt;</span>
            <span class="tag">&lt;attribute&gt;</span>
                <span class="tag">&lt;ref&gt;</span>ri:empno<span class="tag">&lt;/ref&gt;</span>
                <span class="tag">&lt;inbound&gt;</span>
                    <span class="tag">&lt;target&gt;</span>
                        <span class="tag">&lt;path&gt;</span>$focus/name<span class="tag">&lt;/path&gt;</span>
                    <span class="tag">&lt;/target&gt;</span>
                <span class="tag">&lt;/inbound&gt;</span>
                <span class="tag">&lt;inbound&gt;</span>
                    <span class="tag">&lt;target&gt;</span>
                        <span class="tag">&lt;path&gt;</span>$focus/employeeNumber<span class="tag">&lt;/path&gt;</span>
                    <span class="tag">&lt;/target&gt;</span>
                <span class="tag">&lt;/inbound&gt;</span>
            <span class="tag">&lt;/attribute&gt;</span>
            <span class="tag">&lt;attribute&gt;</span>
                <span class="tag">&lt;ref&gt;</span>ri:firstname<span class="tag">&lt;/ref&gt;</span>
                <span class="tag">&lt;inbound&gt;</span>
                    <span class="tag">&lt;target&gt;</span>
                        <span class="tag">&lt;path&gt;</span>$focus/givenName<span class="tag">&lt;/path&gt;</span>
                    <span class="tag">&lt;/target&gt;</span>
                <span class="tag">&lt;/inbound&gt;</span>
            <span class="tag">&lt;/attribute&gt;</span>
            <span class="tag">&lt;attribute&gt;</span>
                <span class="tag">&lt;ref&gt;</span>ri:lastname<span class="tag">&lt;/ref&gt;</span>
                <span class="tag">&lt;inbound&gt;</span>
                    <span class="tag">&lt;target&gt;</span>
                        <span class="tag">&lt;path&gt;</span>$focus/familyName<span class="tag">&lt;/path&gt;</span>
                    <span class="tag">&lt;/target&gt;</span>
                <span class="tag">&lt;/inbound&gt;</span>
            <span class="tag">&lt;/attribute&gt;</span>
            ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The account attribute <code>empno</code> is mapped to midPoint user properties name and <code>employeeNumber</code>.<br><span class="segmentSeparator"></span>Account attributes <code>firstname</code> and <code>lastname</code> are mapped to <code>givenName</code> and <code>familyName</code> properties respectively.<br><span class="segmentSeparator"></span>This is perhaps self-explanatory.</p>
</div>
<div class="paragraph">
<p>The next part of the configuration specifies mappings for activation and credentials:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">            ...<br><span class="segmentSeparator"></span>            <span class="tag">&lt;activation&gt;</span>
                <span class="tag">&lt;administrativeStatus&gt;</span>
                    <span class="tag">&lt;inbound</span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/administrativeStatus&gt;</span>
            <span class="tag">&lt;/activation&gt;</span>

            <span class="tag">&lt;credentials&gt;</span>
                <span class="tag">&lt;password&gt;</span>
                    <span class="tag">&lt;inbound&gt;</span>
                        <span class="tag">&lt;strength&gt;</span>weak<span class="tag">&lt;/strength&gt;</span>
                        <span class="tag">&lt;expression&gt;</span>
                            <span class="tag">&lt;generate</span><span class="tag">/&gt;</span>
                        <span class="tag">&lt;/expression&gt;</span>
                    <span class="tag">&lt;/inbound&gt;</span>
                <span class="tag">&lt;/password&gt;</span>
            <span class="tag">&lt;/credentials&gt;</span>
            ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The activation mapping is very simple.<br><span class="segmentSeparator"></span>Activation is a very specific concept in midPoint.<br><span class="segmentSeparator"></span>MidPoint knows activation attributes and their meaning.<br><span class="segmentSeparator"></span>Therefore there is no need to specify a lot of details.<br><span class="segmentSeparator"></span>The activation mapping simply specifies that the administrative status should be mapped in the inbound direction.<br><span class="segmentSeparator"></span>And that is it.</p>
</div>
<div class="paragraph">
<p>However the mapping for credentials needs a bit of explanation.<br><span class="segmentSeparator"></span>What midPoint sees as HR accounts are not exactly accounts.<br><span class="segmentSeparator"></span>They are usually just records in the HR database.<br><span class="segmentSeparator"></span>Nobody is using these HR records to log into the HR systems.<br><span class="segmentSeparator"></span>Therefore there is no password associated with them.<br><span class="segmentSeparator"></span>But we need a password for the users in midPoint.<br><span class="segmentSeparator"></span>Therefore we are going to generate them.<br><span class="segmentSeparator"></span>And for that we are going to use the weak mapping with generate expression that was explained above.</p>
</div>
<div class="paragraph">
<p>The mappings are undoubtedly important.<br><span class="segmentSeparator"></span>The mappings specify how are the account data reflected to midPoint user.<br><span class="segmentSeparator"></span>But the mappings do not specify whether the accounts should be created or deleted.<br><span class="segmentSeparator"></span>Mappings control the data, but they do not control the <em>lifecycle</em>.<br><span class="segmentSeparator"></span>It is the next configuration section that makes this resource really authoritative:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;synchronization&gt;</span>
        <span class="tag">&lt;objectSynchronization&gt;</span>
            <span class="tag">&lt;enabled&gt;</span>true<span class="tag">&lt;/enabled&gt;</span>
            <span class="tag">&lt;correlation&gt;</span>
                <span class="tag">&lt;q:equal&gt;</span>
                    <span class="tag">&lt;q:path&gt;</span>employeeNumber<span class="tag">&lt;/q:path&gt;</span>
                    <span class="tag">&lt;expression&gt;</span>
                        <span class="tag">&lt;path&gt;</span>$projection/attributes/empno<span class="tag">&lt;/path&gt;</span>
                    <span class="tag">&lt;/expression&gt;</span>
                <span class="tag">&lt;/q:equal&gt;</span>
            <span class="tag">&lt;/correlation&gt;</span>
            <span class="tag">&lt;reaction&gt;</span>
                <span class="tag">&lt;situation&gt;</span>linked<span class="tag">&lt;/situation&gt;</span>
                <span class="tag">&lt;synchronize&gt;</span>true<span class="tag">&lt;/synchronize&gt;</span>
            <span class="tag">&lt;/reaction&gt;</span>
            <span class="tag">&lt;reaction&gt;</span>
                <span class="tag">&lt;situation&gt;</span>deleted<span class="tag">&lt;/situation&gt;</span>
                <span class="tag">&lt;synchronize&gt;</span>true<span class="tag">&lt;/synchronize&gt;</span>
                <span class="tag">&lt;action&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;handlerUri&gt;</span>http://midpoint.evolveum.com/xml/ns/public/model/action-3#deleteFocus<span class="tag">&lt;/handlerUri&gt;</span>
                <span class="tag">&lt;/action&gt;</span>
            <span class="tag">&lt;/reaction&gt;</span>
            <span class="tag">&lt;reaction&gt;</span>
                <span class="tag">&lt;situation&gt;</span>unlinked<span class="tag">&lt;/situation&gt;</span>
                <span class="tag">&lt;synchronize&gt;</span>true<span class="tag">&lt;/synchronize&gt;</span>
                <span class="tag">&lt;action&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;handlerUri&gt;</span>http://midpoint.evolveum.com/xml/ns/public/model/action-3#link<span class="tag">&lt;/handlerUri&gt;</span>
                <span class="tag">&lt;/action&gt;</span>
            <span class="tag">&lt;/reaction&gt;</span>
            <span class="tag">&lt;reaction&gt;</span>
                <span class="tag">&lt;situation&gt;</span>unmatched<span class="tag">&lt;/situation&gt;</span>
                <span class="tag">&lt;synchronize&gt;</span>true<span class="tag">&lt;/synchronize&gt;</span>
                <span class="tag">&lt;action&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;handlerUri&gt;</span>http://midpoint.evolveum.com/xml/ns/public/model/action-3#addFocus<span class="tag">&lt;/handlerUri&gt;</span>
                <span class="tag">&lt;/action&gt;</span>
            <span class="tag">&lt;/reaction&gt;</span>
        <span class="tag">&lt;/objectSynchronization&gt;</span>
    <span class="tag">&lt;/synchronization&gt;</span>
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Given the information in this chapter this configuration should be quite easy to read.<br><span class="segmentSeparator"></span>This is how a typical authoritative resource works.<br><span class="segmentSeparator"></span>If there is a new account on the resource and we do not have an owner (situation: <code>unmatched</code>) then we create a new user (action: <code>addFocus</code>).<br><span class="segmentSeparator"></span>If there is a new account for which we can find existing owner (situation: <code>unlinked</code>) then simply link it (reaction: <code>link</code>).<br><span class="segmentSeparator"></span>If the account is linked already (situation: <code>linked</code>) then we just synchronize the data.<br><span class="segmentSeparator"></span>In fact, we will synchronize data for all the other situations as well.<br><span class="segmentSeparator"></span>Except the last one.<br><span class="segmentSeparator"></span>If the account is deleted in the HR system (situation: <code>deleted</code>) then we want to delete midPoint user as well (reaction: <code>deleteFocus</code>).<br><span class="segmentSeparator"></span>As the user gets deleted there is no point in synchronizing the data.<br><span class="segmentSeparator"></span>MidPoint knows that and skips application of mappings.</p>
</div>
<div class="paragraph">
<p>The ownership of the accounts that are not already linked is determined by the correlation expression.<br><span class="segmentSeparator"></span>In this case the expression will be comparing account attribute <code>empno</code> with user property <code>employeeNumber</code>.<br><span class="segmentSeparator"></span>If the values match then the user is considered to be an owner of the account.</p>
</div>
<div class="paragraph">
<p>There is one more detail in this resource that we have skipped:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;projection&gt;</span>
        <span class="tag">&lt;assignmentPolicyEnforcement&gt;</span>none<span class="tag">&lt;/assignmentPolicyEnforcement&gt;</span>
    <span class="tag">&lt;/projection&gt;</span>
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a setting that adjusts the behavior of midPoint <em>assignments</em>.<br><span class="segmentSeparator"></span>As was already mentioned all resources in midPoint are created equal.<br><span class="segmentSeparator"></span>The source resources must follow the same rules as target resources.<br><span class="segmentSeparator"></span>And one of the fundamental rules of midPoint is that there should not be any account without a specific reason to exist.<br><span class="segmentSeparator"></span>In midPoint terminology every account exists because there is an <em>assignment</em> that justifies its existence.<br><span class="segmentSeparator"></span>While this approach is exactly what we want for vast majority of (well behaving) resources, it is not exactly ideal for source resources.<br><span class="segmentSeparator"></span>Those resources work the other way around.<br><span class="segmentSeparator"></span>The HR account is in fact a cause for midPoint user existence, not its effect.<br><span class="segmentSeparator"></span>Therefore there is really useful <code>assignmentPolicyEnforcement</code> setting that controls the behavior of assignments.<br><span class="segmentSeparator"></span>This setting is used in a variety of scenarios, mostly for data migration and to tame resources that just won’t behave in a civilized manner.<br><span class="segmentSeparator"></span>But in this case the setting is used to turn off the assignment enforcement for this resource entirely.<br><span class="segmentSeparator"></span>As this resource is an authoritative source the assignment enforcement does not make much sense.<br><span class="segmentSeparator"></span>Behavior of this resource is defined by the <code>synchronization</code> section of resource configuration.</p>
</div>
<div class="paragraph">
<p>Resource configuration is complete now.<br><span class="segmentSeparator"></span>This configuration sets up the connector, mappings and synchronization policies.<br><span class="segmentSeparator"></span>This configuration is the same for all the synchronization flavors: import, reconciliation and live sync - they will all use the same settings.<br><span class="segmentSeparator"></span>When it comes to configuration, the only difference between those synchronization flavors is the way how the synchronization tasks are set up.<br><span class="segmentSeparator"></span>If an import task is set up then import of resource accounts will be executed.<br><span class="segmentSeparator"></span>If reconciliation task is set up the reconciliation will be executed.<br><span class="segmentSeparator"></span>It is all in the tasks.<br><span class="segmentSeparator"></span>And synchronization tasks can be easily set up using those convenient buttons in the user interface.<br><span class="segmentSeparator"></span>But we like to make our lives a bit painful in our part of the world.<br><span class="segmentSeparator"></span>Therefore we are going to go hardcore and we import the tasks in the XML form.</p>
</div>
<div class="paragraph">
<p>First task is an import task.<br><span class="segmentSeparator"></span>This task lists all the accounts in the HR CSV file.<br><span class="segmentSeparator"></span>The task pretends that each of the accounts was just created.<br><span class="segmentSeparator"></span>If the task is executed for the first time then resulting situation of the accounts is going to be either <code>unmatched</code> or <code>unlinked</code>.<br><span class="segmentSeparator"></span>Therefore the task creates new midPoint users or links the accounts to existing users.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;task</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">7c57adc2-a857-11e7-83ac-0f212d965f5b</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>HR Import<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;taskIdentifier&gt;</span>7c57adc2-a857-11e7-83ac-0f212d965f5b<span class="tag">&lt;/taskIdentifier&gt;</span>
    <span class="tag">&lt;ownerRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">00000000-0000-0000-0000-000000000002</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;executionStatus&gt;</span>runnable<span class="tag">&lt;/executionStatus&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;handlerUri&gt;</span>http://midpoint.evolveum.com/xml/ns/public/model/synchronization/task/import/handler-3<span class="tag">&lt;/handlerUri&gt;</span>
    <span class="tag">&lt;objectRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">03c3ceea-78e2-11e6-954d-dfdfa9ace0cf</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">c:ResourceType</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;recurrence&gt;</span>single<span class="tag">&lt;/recurrence&gt;</span>
<span class="tag">&lt;/task&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a very basic structure of the task.<br><span class="segmentSeparator"></span>Similarly to all midPoint objects a task has a name.<br><span class="segmentSeparator"></span>Then there is a task identifier which is used for internal task management purposes.<br><span class="segmentSeparator"></span>This is usually the same as task object OID.<br><span class="segmentSeparator"></span>Task needs definition of an owner.<br><span class="segmentSeparator"></span>The owner is a user that is executing the task.<br><span class="segmentSeparator"></span>This is important, because authorizations of task owner determine what the task is allowed to do.<br><span class="segmentSeparator"></span>This is also the identity that will be recorded in the audit log.<br><span class="segmentSeparator"></span>In this case <code>administrator</code> is owner of this task.<br><span class="segmentSeparator"></span>Task execution status tells whether the task is running, it is suspended or finished.<br><span class="segmentSeparator"></span>Then there is a handler URI.<br><span class="segmentSeparator"></span>The handler URI specifies what the task really does.<br><span class="segmentSeparator"></span>It (indirectly) refers to the code that the server executes.<br><span class="segmentSeparator"></span>In this case the task URI specifies that this is a synchronization task that imports accounts from the resource.<br><span class="segmentSeparator"></span>And the resource is specified by the objectRef reference.<br><span class="segmentSeparator"></span>This points to our HR resource.<br><span class="segmentSeparator"></span>The last item is recurrence.<br><span class="segmentSeparator"></span>Recurrence specifies whether the task runs only once (single) or whether the execution should be repeated (recurring).</p>
</div>
<div class="paragraph">
<p>When this XML definition is imported to midPoint, the server tries to execute the task.<br><span class="segmentSeparator"></span>That means that import of accounts from the HR resource starts immediately.<br><span class="segmentSeparator"></span>Progress of the task can be monitored in the Server tasks section of midPoint user interface.<br><span class="segmentSeparator"></span>The import task is not a recurring task.<br><span class="segmentSeparator"></span>Therefore it will run only once.<br><span class="segmentSeparator"></span>If you need to re-run the task you can do that from midPoint user interface.<br><span class="segmentSeparator"></span>But the task will not be executed unless you explicitly tell midPoint to do so.<br><span class="segmentSeparator"></span>This is how typical import tasks work.<br><span class="segmentSeparator"></span>They are usually executed when a new resource is connected to the system.<br><span class="segmentSeparator"></span>And once everything is set up, correlated and linked then the import task is not needed any more.</p>
</div>
<div class="paragraph">
<p>A clever reader may ask what happens when the import task is executed more than once.<br><span class="segmentSeparator"></span>The answer is simple: not much.<br><span class="segmentSeparator"></span>Even if the task pretends that the accounts were just created, midPoint is not fooled easily.<br><span class="segmentSeparator"></span>In fact it is hard to believe that the account was just created if midPoint already has shadow for that account and it is linked to a user, isn’t it?<br><span class="segmentSeparator"></span>Therefore midPoint is going to stay calm and carry on.<br><span class="segmentSeparator"></span>If there is any change in the account attribute than the change will be reflected to the user.<br><span class="segmentSeparator"></span>But that is it.<br><span class="segmentSeparator"></span>No big drama here.</p>
</div>
<div class="paragraph">
<p>Import task will get the data from the resource into midPoint.<br><span class="segmentSeparator"></span>But as import is not a recurring task it will not keep the data synchronized.<br><span class="segmentSeparator"></span>Import tasks are not designed to do so.<br><span class="segmentSeparator"></span>But there are other tasks that are designed for continuous synchronization.<br><span class="segmentSeparator"></span>Reconciliation task is one of these.<br><span class="segmentSeparator"></span>Reconciliation task lists all the accounts on a resource and compares that with data in midPoint.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;task</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">bbe4ceac-a85c-11e7-a49f-0f5777d22906</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>HR Reconciliation<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;taskIdentifier&gt;</span>bbe4ceac-a85c-11e7-a49f-0f5777d22906<span class="tag">&lt;/taskIdentifier&gt;</span>
    <span class="tag">&lt;ownerRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">00000000-0000-0000-0000-000000000002</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;executionStatus&gt;</span>runnable<span class="tag">&lt;/executionStatus&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;handlerUri&gt;</span>http://midpoint.evolveum.com/xml/ns/public/model/synchronization/task/reconciliation/handler-3<span class="tag">&lt;/handlerUri&gt;</span>
    <span class="tag">&lt;objectRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">03c3ceea-78e2-11e6-954d-dfdfa9ace0cf</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">c:ResourceType</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;recurrence&gt;</span>recurring<span class="tag">&lt;/recurrence&gt;</span>
    <span class="tag">&lt;schedule&gt;</span>
        <span class="tag">&lt;cronLikePattern&gt;</span>0 0 1 ?<br><span class="segmentSeparator"></span>* SAT<span class="tag">&lt;/cronLikePattern&gt;</span>
        <span class="tag">&lt;misfireAction&gt;</span>executeImmediately<span class="tag">&lt;/misfireAction&gt;</span>
   <span class="tag">&lt;/schedule&gt;</span>
<span class="tag">&lt;/task&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Definition of a reconciliation task is almost the same as the definition of import task.<br><span class="segmentSeparator"></span>But there are crucial differences.<br><span class="segmentSeparator"></span>First of all there is different handler URI.<br><span class="segmentSeparator"></span>This is what makes this task a reconciliation task.<br><span class="segmentSeparator"></span>Then the task is recurring.<br><span class="segmentSeparator"></span>This means that midPoint will repeat execution of the task.<br><span class="segmentSeparator"></span>Therefore there is also execution schedule so the server knows when to execute the task.<br><span class="segmentSeparator"></span>Reconciliation tasks are usually resource-intensive therefore we usually want to execute them at a very specific off-peak times.<br><span class="segmentSeparator"></span>For that reason the execution schedule is defined using a cron-like pattern.<br><span class="segmentSeparator"></span>UNIX-friendly readers will be surely familiar with this.<br><span class="segmentSeparator"></span>The format is:</p>
</div>
<div class="paragraph">
<p><code><em>seconds</em> <em>minutes</em> <em>hours</em> <em>day-of-month</em> <em>month</em> <em>day-of-week</em> <em>year</em></code></p>
</div>
<div class="paragraph">
<p>Therefore this task will be executed every Saturday at 01:00:00am.<br><span class="segmentSeparator"></span>There is also definition of misfire action.<br><span class="segmentSeparator"></span>Misfire is a situation when the server is down at the time when the task is supposed to run.<br><span class="segmentSeparator"></span>Therefore if the server is down in the early hours of Saturday this task will be executed as soon as the server starts up.</p>
</div>
<div class="paragraph">
<p>Reconciliation task is a real workhorse of identity management.<br><span class="segmentSeparator"></span>It can be used in almost any resource.<br><span class="segmentSeparator"></span>It is very reliable.<br><span class="segmentSeparator"></span>It is often used to fix many problems, apply new policies, look for missing accounts, illegal accounts and so on.<br><span class="segmentSeparator"></span>It is indeed a really useful tool.<br><span class="segmentSeparator"></span>But it has its downside.<br><span class="segmentSeparator"></span>Reconciliation iterates through all the accounts, it recomputes all the applicable policies for every account, one-by-one.<br><span class="segmentSeparator"></span>Therefore it may be quite resource-intensive.<br><span class="segmentSeparator"></span>It m may be even quite brutal if the policies are complex, user population is high and the resources are slow.<br><span class="segmentSeparator"></span>This can take hours or even days in extreme cases.<br><span class="segmentSeparator"></span>But even for smaller deployments reconciliation is not entirely easy.<br><span class="segmentSeparator"></span>The problem is not in midPoint.<br><span class="segmentSeparator"></span>MidPoint can be usually scaled up to handle the load.<br><span class="segmentSeparator"></span>But listing all the accounts often may put unacceptable load on the resources.<br><span class="segmentSeparator"></span>Therefore reconciliation is not executed often.<br><span class="segmentSeparator"></span>Daily, weekly or even monthly reconciliation seems to be a common approach.<br><span class="segmentSeparator"></span>Reconciliation is reliable, but it is not entirely what we would call "real-time".<br><span class="segmentSeparator"></span>But of course, midPoint has a faster alternative.</p>
</div>
<div class="paragraph">
<p><em>Live synchronization</em> is the way to go for real-time synchronization.<br><span class="segmentSeparator"></span>Or rather almost real-time synchronization.<br><span class="segmentSeparator"></span>Practical latencies for live synchronization are in the range of seconds or minutes, which is fast enough for most practical cases.<br><span class="segmentSeparator"></span>Live synchronization is also quite resource-efficient.<br><span class="segmentSeparator"></span>Overall it is much faster and much lighter than reconciliation.<br><span class="segmentSeparator"></span>But live synchronization is not available for all resources.<br><span class="segmentSeparator"></span>Live synchronization depends on the ability to get recent changes from the resource in a very efficient way.<br><span class="segmentSeparator"></span>Therefore it is only available for resources that record the changes.<br><span class="segmentSeparator"></span>The specific mechanism to record the changes may vary from resource to resource.<br><span class="segmentSeparator"></span>It may be as basic as a simple modification timestamp or it may be a complex change log.<br><span class="segmentSeparator"></span>But it has to be good enough for the connector to discover recent changes and it must be efficient enough for the connector to do that every couple of seconds.<br><span class="segmentSeparator"></span>If such mechanism is available and the connector knows how to use it then setting up live synchronization is easy.<br><span class="segmentSeparator"></span>All that is needed is synchronization task.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;task</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">7c57adc2-a857-11e7-83ac-0f212d965f5b</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>HR Live Synchronization<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;extension&gt;</span>
        <span class="tag">&lt;mext:kind&gt;</span>account<span class="tag">&lt;/mext:kind&gt;</span>
    <span class="tag">&lt;/extension&gt;</span>
    <span class="tag">&lt;taskIdentifier&gt;</span>7c57adc2-a857-11e7-83ac-0f212d965f5b<span class="tag">&lt;/taskIdentifier&gt;</span>
    <span class="tag">&lt;ownerRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">00000000-0000-0000-0000-000000000002</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;executionStatus&gt;</span>runnable<span class="tag">&lt;/executionStatus&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;handlerUri&gt;</span>http://midpoint.evolveum.com/xml/ns/public/model/synchronization/task/live-sync/handler-3<span class="tag">&lt;/handlerUri&gt;</span>
    <span class="tag">&lt;objectRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">03c3ceea-78e2-11e6-954d-dfdfa9ace0cf</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">c:ResourceType</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;recurrence&gt;</span>recurring<span class="tag">&lt;/recurrence&gt;</span>
    <span class="tag">&lt;schedule&gt;</span>
        <span class="tag">&lt;interval&gt;</span>10<span class="tag">&lt;/interval&gt;</span>
    <span class="tag">&lt;/schedule&gt;</span>
<span class="tag">&lt;/task&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This task definition should be easy to understand now.<br><span class="segmentSeparator"></span>There is a different handler URI that makes this a live synchronization task.<br><span class="segmentSeparator"></span>There is also a different type of scheduling.<br><span class="segmentSeparator"></span>We do not want to execute this task at a specific time.<br><span class="segmentSeparator"></span>We rather want to execute it all the time at regular intervals.<br><span class="segmentSeparator"></span>In this case the interval is set to 10 seconds.<br><span class="segmentSeparator"></span>And that is all that is needed to have live synchronization running.<br><span class="segmentSeparator"></span>If the HR CSV file is changed now, the changes will get automatically processed by midPoint.</p>
</div>
<div class="paragraph">
<p>Setting up configuration flavors is just a matter of setting up the tasks.<br><span class="segmentSeparator"></span>The rest of the configuration is the same for all flavors.<br><span class="segmentSeparator"></span>Therefore it is very easy to run both live synchronization and reconciliation for the same resource.<br><span class="segmentSeparator"></span>Just create two tasks.<br><span class="segmentSeparator"></span>And it fact this is quite a common setup.<br><span class="segmentSeparator"></span>Live synchronization is used to get the changes quickly and efficiently.<br><span class="segmentSeparator"></span>And reconciliation is used to make sure all the changes were processed and that the policies are applied consistently.</p>
</div>
<div class="paragraph">
<p>That is all.<br><span class="segmentSeparator"></span>Now we have the HR feed up and running.<br><span class="segmentSeparator"></span>However, there are still few issues.<br><span class="segmentSeparator"></span>A clever reader would surely notice that this is not a very good HR resource.<br><span class="segmentSeparator"></span>MidPoint users created from this HR feed have given name and family name, but the full name field is empty.<br><span class="segmentSeparator"></span>But do not worry.<br><span class="segmentSeparator"></span>We will sort that out in later chapters with the help of <em>object template</em>.<br><span class="segmentSeparator"></span>Also the users have employee number as their username.<br><span class="segmentSeparator"></span>This may be in fact a very good approach for some deployments as it avoids the need to rename accounts.<br><span class="segmentSeparator"></span>However, it is not a very user-friendly approach.<br><span class="segmentSeparator"></span>Therefore most deployments need to generate more convenient usernames.<br><span class="segmentSeparator"></span>This is easy to do with midPoint and we will also address that later.<br><span class="segmentSeparator"></span>There is still a lot of things to learn before we get to a complete synchronization set up.</p>
</div>
</div>
<div class="sect2">
<h3 id="_hr_feed_recommendations">HR Feed Recommendations</h3>
<div class="paragraph">
<p>All resources are created equal in midPoint.<br><span class="segmentSeparator"></span>However, source resources almost always have slightly special standing.<br><span class="segmentSeparator"></span>Even though midPoint mechanisms are the same for all resources, the data coming from the sources often have significant impact on the entire solution.<br><span class="segmentSeparator"></span>There is this traditional computer engineering wisdom: <em>garbage in, garbage out</em>.<br><span class="segmentSeparator"></span>An error in data feed may cause a lot of problems everywhere.<br><span class="segmentSeparator"></span>Therefore it is important to get the data sources right.<br><span class="segmentSeparator"></span>And this is usually one of the first steps in an IDM project.</p>
</div>
<div class="paragraph">
<p>Unfortunately, source data feed is usually quite difficult to set up correctly.<br><span class="segmentSeparator"></span>And it is almost impossible to get it right at the first try.<br><span class="segmentSeparator"></span>Therefore setup of a data source is usually an iterative process.<br><span class="segmentSeparator"></span>And there may be many iterations - especially if the quality of the source data is unknown.<br><span class="segmentSeparator"></span>The process usually goes like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Set up initial source resource definition based on the information you have.<br><span class="segmentSeparator"></span>Set up connector and test connection.<br><span class="segmentSeparator"></span>Check that you can see the accounts.<br><span class="segmentSeparator"></span>Set up mappings and synchronization policy.</p>
</li>
<li>
<p>Test the import process on a couple of individual accounts.<br><span class="segmentSeparator"></span>Navigate to the resource details pages, click on Accounts tab to list accounts, choose an account an click on the small <em>Import</em> button at the left-hand side of the table row.<br><span class="segmentSeparator"></span>Import of that individual account will start.<br><span class="segmentSeparator"></span>Just that one account.<br><span class="segmentSeparator"></span>It is easier to see the errors (see step 6) by using this method.</p>
</li>
<li>
<p>Fix any errors that you see and repeat step 2.</p>
</li>
<li>
<p>Create an import task and run import of all accounts.</p>
</li>
<li>
<p>Examine task errors.<br><span class="segmentSeparator"></span>You can use task details page to get the summary.</p>
</li>
<li>
<p>If there are no errors the examine the users.<br><span class="segmentSeparator"></span>If everything is OK then congratulations.<br><span class="segmentSeparator"></span>You have a good import.<br><span class="segmentSeparator"></span>However, this is unlikely to happen of first few couple of attempts.</p>
</li>
<li>
<p>You will probably need to have a look into system logs to learn the details of individual import failures.<br><span class="segmentSeparator"></span>MidPoint heavily relies on logs for detailed error analysis.<br><span class="segmentSeparator"></span>See the <a href="https://docs.evolveum.com/book/practical-identity-management-with-midpoint.html#90-troubleshooting">Troubleshooting</a> chapter of this book to learn how to adjust log levels and how to get understand the log messages.</p>
</li>
<li>
<p>Some errors are likely to be caused by the errors in your mappings and policies.<br><span class="segmentSeparator"></span>Those are usually easy to fix.<br><span class="segmentSeparator"></span>But there are usually worse errors as well – errors caused by wrong or unexpected input data.<br><span class="segmentSeparator"></span>The right way would be to fix the data.<br><span class="segmentSeparator"></span>But that is not always possible (in fact it is almost never a feasible option).<br><span class="segmentSeparator"></span>Fortunately, most of the input data errors can be fixed (read: "worked around") in midPoint with a bit of ingenuity.<br><span class="segmentSeparator"></span>Just use the power of the mappings.</p>
</li>
<li>
<p>Rinse and repeat.<br><span class="segmentSeparator"></span>If the errors you get are not severe then you may simply re-run the import task.<br><span class="segmentSeparator"></span>This often works just fine.<br><span class="segmentSeparator"></span>But if the problem was in a mapping that completely ruined all the data then it is perhaps best to start with a blank slate.<br><span class="segmentSeparator"></span>We are all just human and this situation happens quite often, especially in the beginning while you are still learning.<br><span class="segmentSeparator"></span>Therefore there is a special feature to help you out.<br><span class="segmentSeparator"></span>Navigate to <em>Configuration &gt; Repository Objects</em>.<br><span class="segmentSeparator"></span>There is a small unassuming expand button in the top-right part of the screen.<br><span class="segmentSeparator"></span>That button opens a context menu.<br><span class="segmentSeparator"></span>Select “Delete all identities” item.<br><span class="segmentSeparator"></span>That is what we lovingly call “laxative button”.<br><span class="segmentSeparator"></span>A brief dialog will pop up asking you to specify which identities exactly are to be deleted (users, shadows, …).<br><span class="segmentSeparator"></span>This is a very convenient way how to get back to a black slate, but keep all the configuration (resources, templates, tasks).</p>
</li>
<li>
<p>Goto step 2.<br><span class="segmentSeparator"></span>Repeat until done.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If the initial IDM deployment step includes an HR feed we strongly recommend to start with that HR feed.<br><span class="segmentSeparator"></span>It is significant benefit to have authoritative HR data in the midPoint to start with.<br><span class="segmentSeparator"></span>It is usually easier to correlate other resources to midPoint users later on, if the users were created from a reasonably-reliable HR data.<br><span class="segmentSeparator"></span>Also, it will usually take some tweaking to get the HR import right.<br><span class="segmentSeparator"></span>The possibility to easily clean up midPoint and get to a clean slate is extremely useful.<br><span class="segmentSeparator"></span>But that is possible only if the HR feed is the first resource that is connected to midPoint.</p>
</div>
<div class="paragraph">
<p>A clever reader would notice, that we assumed that the source feed will be taken from a CSV file.<br><span class="segmentSeparator"></span>And this is indeed the case in majority of cases.<br><span class="segmentSeparator"></span>If a new employee or contractor is about to join the company there is usually no hurry.<br><span class="segmentSeparator"></span>This information is entered into the HR system at least few days in advance therefore daily CVS export is perfectly acceptable.<br><span class="segmentSeparator"></span>However, there may be cases when we want a faster response.<br><span class="segmentSeparator"></span>Or maybe we do not want additional burden of dealing with CSV exports.<br><span class="segmentSeparator"></span>Of course, there is solution.<br><span class="segmentSeparator"></span>In theory any connector can be used for source resource.<br><span class="segmentSeparator"></span>And in fact there are specialized connectors that are taking data directly from the HR system.<br><span class="segmentSeparator"></span>For example there is a connector for Oracle HCM system.<br><span class="segmentSeparator"></span>Unfortunately, there is no connector that can take data from SAP HR system yet.</p>
</div>
</div>
<div class="sect2">
<h3 id="_synchronization_and_provisioning">Synchronization and Provisioning</h3>
<div class="paragraph">
<p>Synchronization and provisioning are intimately connected.<br><span class="segmentSeparator"></span>Everything that we have explained about provisioning in the previous chapter also applies to synchronization.<br><span class="segmentSeparator"></span>In fact provisioning and synchronization are just applications of the same basic mechanisms.<br><span class="segmentSeparator"></span>Provisioning starts with modification of a user.<br><span class="segmentSeparator"></span>Synchronization starts a bit earlier: inbound mappings are used to map values from source system to the user.<br><span class="segmentSeparator"></span>The result of inbound mapping evaluation is that the user object is modified.<br><span class="segmentSeparator"></span>According to midPoint principles it does not matter how the user was modified.<br><span class="segmentSeparator"></span>The reaction is the same: accounts are provisioned, modified or deleted as needed.</p>
</div>
<div class="paragraph">
<p>The synchronization (<em>inbound</em> processing) and provisioning (<em>outbound</em> processing) usually happen in the same seamless operation.<br><span class="segmentSeparator"></span>For example the HR connector detects update in the last name of an employee.<br><span class="segmentSeparator"></span>That modification is applied to midPoint user, therefore the family name of midPoint user is updated.<br><span class="segmentSeparator"></span>The operation continues by evaluating all templates, roles and outbound mappings.<br><span class="segmentSeparator"></span>The outbound mappings usually map the family name change to the resource attributes.<br><span class="segmentSeparator"></span>Therefore the resource accounts liked to the user are immediately updated.<br><span class="segmentSeparator"></span>All of that happens in a single operation.<br><span class="segmentSeparator"></span>That is how midPoint works.<br><span class="segmentSeparator"></span>MidPoint is not a human.<br><span class="segmentSeparator"></span>It will never procrastinate (unless explicitly instructed do to so).<br><span class="segmentSeparator"></span>MidPoint will not postpone the operation for later if the operation can be executed immediately.<br><span class="segmentSeparator"></span>MidPoint tries to get the data right on a first try.<br><span class="segmentSeparator"></span>Therefore there no specialized propagation or provisioning tasks that you might know from older IDM systems.<br><span class="segmentSeparator"></span>MidPoint does not need them.</p>
</div>
<div class="paragraph">
<p>There other advantages in doing everything in one operation.<br><span class="segmentSeparator"></span>It is all one operation therefore midPoint knows all the details: what was the cause, what is the effect, what exactly has been changed.<br><span class="segmentSeparator"></span>This is important for troubleshooting.<br><span class="segmentSeparator"></span>Some IDM systems decouple the cause and the effect.<br><span class="segmentSeparator"></span>Such a divided approach may have its advantages, but it is an absolute nightmare when an engineer needs to figure out why a certain effect happened.<br><span class="segmentSeparator"></span>But midPoint has both the cause and the effects correlated together in a single operation.<br><span class="segmentSeparator"></span>Therefore it is much easier to figure out what is going on.<br><span class="segmentSeparator"></span>And it can also be neatly recorded in the audit trail.<br><span class="segmentSeparator"></span>And there is another huge advantage: midPoint knows exactly what has been changed.<br><span class="segmentSeparator"></span>This means that midPoint does not only knows the new value of a property.<br><span class="segmentSeparator"></span>MidPoint knows also the old value and values that were added or removed.<br><span class="segmentSeparator"></span>This is a complete description of the change that we call <em>delta</em>.<br><span class="segmentSeparator"></span>This is recorded at the beginning of the operation and propagated all the way until the operation is done.<br><span class="segmentSeparator"></span>Therefore the mappings may be smart.<br><span class="segmentSeparator"></span>This approach enables a lot of interesting behavioral patterns.<br><span class="segmentSeparator"></span>For example it is quite easy for midPoint to implement the "last change wins" policy.<br><span class="segmentSeparator"></span>In this case midPoint will simply overwrite only those attributes that are really changed in operation.<br><span class="segmentSeparator"></span>MidPoint can leave other values untouched.<br><span class="segmentSeparator"></span>In fact, this is the default behavior of midPoint.<br><span class="segmentSeparator"></span>And it is a very useful behavior during deployment of a new IDM system.</p>
</div>
<div class="paragraph">
<p>Careful processing of the operations allows configurations that are not feasible with older IDM systems, e.g.<br><span class="segmentSeparator"></span>a resource that is both a source and a target.<br><span class="segmentSeparator"></span>In fact a lot of IDM systems can have resource that is both a source and a target - as long as it is a source for one attribute and a target for another attribute.<br><span class="segmentSeparator"></span>But midPoint can live with a resource where the same attribute is both a source and a target.<br><span class="segmentSeparator"></span>And in fact there may be may sources and many targets for the same property at the same time.<br><span class="segmentSeparator"></span>And this is indeed very useful configuration.<br><span class="segmentSeparator"></span>Just think about telephone number property.<br><span class="segmentSeparator"></span>This is usually something that the user sets up himself.<br><span class="segmentSeparator"></span>This may be set up by some kind of specialized self-service, it may be updated by a call center call, the user may update that in his Active Directory profile …​ there are many ways how this information is changed.<br><span class="segmentSeparator"></span>But we want this property to be consistent.<br><span class="segmentSeparator"></span>We want telephone number to be the same everywhere.<br><span class="segmentSeparator"></span>And we do not care where it was changed.<br><span class="segmentSeparator"></span>We just want to propagate the last change from anywhere to all the other systems.<br><span class="segmentSeparator"></span>MidPoint can easily do this.<br><span class="segmentSeparator"></span>Just specify both inbound and outbound mappings for the same attribute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;attribute&gt;</span>
    <span class="tag">&lt;ref&gt;</span>ri:mobile<span class="tag">&lt;/ref&gt;</span>
    <span class="tag">&lt;outbound&gt;</span>
        <span class="tag">&lt;source&gt;</span>
             <span class="tag">&lt;path&gt;</span>$focus/telephoneNumber<span class="tag">&lt;/path&gt;</span>
        <span class="tag">&lt;/source&gt;</span>
    <span class="tag">&lt;/outbound&gt;</span>
    <span class="tag">&lt;inbound&gt;</span>
        <span class="tag">&lt;target&gt;</span>
             <span class="tag">&lt;path&gt;</span>$focus/telephoneNumber<span class="tag">&lt;/path&gt;</span>
        <span class="tag">&lt;/target&gt;</span>
    <span class="tag">&lt;/inbound&gt;</span>
<span class="tag">&lt;/attribute&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case the change in user property <code>telephoneNumber</code> will be propagated to the account attribute <code>mobile</code> (outbound change).<br><span class="segmentSeparator"></span>But also a change in the account attribute <code>mobile</code> will be propagated back to user property <code>telephoneNumber</code> (inbound change).<br><span class="segmentSeparator"></span>Last change wins.<br><span class="segmentSeparator"></span>A clever reader certainly grumbles something about infinite loops now.<br><span class="segmentSeparator"></span>But do not worry.<br><span class="segmentSeparator"></span>MidPoint can see complete operation context, both inbound and outbound sides.<br><span class="segmentSeparator"></span>Therefore midPoint knows when to stop processing the operation.<br><span class="segmentSeparator"></span>There are even mechanism how to avoid loops caused by connectors detecting changes caused by the connector itself.<br><span class="segmentSeparator"></span>MidPoint will break those loops automatically.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Synchronization and provisioning are in fact almost the same mechanism applied in a different direction.<br><span class="segmentSeparator"></span>Then why there two sections in the resource configuration?<br><span class="segmentSeparator"></span>Why there is <code>schemaHandling</code> and <code>synchronization</code>?<br><span class="segmentSeparator"></span>Why not just one?<br><span class="segmentSeparator"></span>The answer is simple: history.<br><span class="segmentSeparator"></span>No software is created perfect on day one.<br><span class="segmentSeparator"></span>Similarly to other software systems, midPoint went through an evolutionary process of continuous improvement.<br><span class="segmentSeparator"></span>MidPoint had a very good design at the beginning.<br><span class="segmentSeparator"></span>Looking back at the initial design, now it is quite clear that almost all of midPoint developments were correctly foreseen and accounted for in the design.<br><span class="segmentSeparator"></span>However, there are occasional mistakes.<br><span class="segmentSeparator"></span>The initial midPoint data model design expected that there will be major differences between synchronization and provisioning mechanisms.<br><span class="segmentSeparator"></span>Therefore there were two sections, one for each mechanism.<br><span class="segmentSeparator"></span>But midPoint evolution improved the initial design and we have found a way how to unify synchronization and provisioning mechanisms into one.<br><span class="segmentSeparator"></span>However, we have not modified the initial data model because we wanted to keep compatibility.<br><span class="segmentSeparator"></span>Having two sections instead of one is only a cosmetic imperfection.<br><span class="segmentSeparator"></span>It does not cause any major trouble.<br><span class="segmentSeparator"></span>But incompatible change would certainly affect continuity of midPoint deployments.<br><span class="segmentSeparator"></span>And we highly value midPoint continuity and upgradeability.<br><span class="segmentSeparator"></span>Therefore the two sections remained to this day.<br><span class="segmentSeparator"></span>However, they will not remain there forever.<br><span class="segmentSeparator"></span>We are not going to dwell on old mistakes for too long.<br><span class="segmentSeparator"></span>These two section will be reunited once there is a proper time to make incompatible changes.<br><span class="segmentSeparator"></span>Which will probably happen in the future when the time comes to release midPoint 5.0.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_mapping_and_expression_tips_and_tricks">Mapping and Expression Tips and Tricks</h3>
<div class="paragraph">
<p>Mappings and expressions form a very powerful mechanism.<br><span class="segmentSeparator"></span>In fact most of midPoint configuration is about setting up correct mappings.<br><span class="segmentSeparator"></span>But with great power comes great responsibility and mappings may look a bit intimidating at a first sight.<br><span class="segmentSeparator"></span>Fortunately, there are few tip and tricks that may life with mappings and expressions a bit easier.</p>
</div>
<div class="paragraph">
<p>Most mappings are aware of the context in which they are used.<br><span class="segmentSeparator"></span>Therefore paths of mapping sources and targets can be shortened - or even left out entirely.<br><span class="segmentSeparator"></span>Activation and credential mappings used in the HR feed example are the obvious cases.<br><span class="segmentSeparator"></span>But even paths in ordinary mapping may be shortened.<br><span class="segmentSeparator"></span>For example take the outbound mapping source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;outbound&gt;</span>
        <span class="tag">&lt;source&gt;</span>
             <span class="tag">&lt;path&gt;</span>$focus/telephoneNumber<span class="tag">&lt;/path&gt;</span>
        <span class="tag">&lt;/source&gt;</span>
    <span class="tag">&lt;/outbound&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As the mapping knows that its source is a focus (user) the definition may be shortened:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;outbound&gt;</span>
        <span class="tag">&lt;source&gt;</span>
             <span class="tag">&lt;path&gt;</span>telephoneNumber<span class="tag">&lt;/path&gt;</span>
        <span class="tag">&lt;/source&gt;</span>
    <span class="tag">&lt;/outbound&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Typical midPoint deployment has tens or hundreds or mappings.<br><span class="segmentSeparator"></span>Deployments with thousands of mappings are definitely feasible.<br><span class="segmentSeparator"></span>Therefore it may not be entirely easy to maintain the mappings.<br><span class="segmentSeparator"></span>Therefore there are two things that can make this easier.<br><span class="segmentSeparator"></span>There is an ability to optionally specify mapping name.<br><span class="segmentSeparator"></span>Mapping name will appear in the log files and some error messages.<br><span class="segmentSeparator"></span>Therefore it may be easier to identify which mapping is causing problems or it may help locate the trace of mapping execution in the log file.<br><span class="segmentSeparator"></span>Mapping can also have a description.<br><span class="segmentSeparator"></span>The description can be used as a general-purpose comment or a documentation of the mapping.<br><span class="segmentSeparator"></span>The description can be used to explain what the mapping does.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;attribute&gt;</span>
    <span class="tag">&lt;ref&gt;</span>ri:mobile<span class="tag">&lt;/ref&gt;</span>
    <span class="tag">&lt;outbound&gt;</span>
        <span class="tag">&lt;name&gt;</span>ldap-mobile<span class="tag">&lt;/name&gt;</span>
        <span class="tag">&lt;description&gt;</span>
            Mapping that sets value for LDAP mobile attribute based on
            user’s telephone number.<br><span class="segmentSeparator"></span>        <span class="tag">&lt;/description&gt;</span>
        <span class="tag">&lt;source&gt;</span>
             <span class="tag">&lt;path&gt;</span>$focus/telephoneNumber<span class="tag">&lt;/path&gt;</span>
        <span class="tag">&lt;/source&gt;</span>
    <span class="tag">&lt;/outbound&gt;</span>
<span class="tag">&lt;/attribute&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Mappings can become quite complex.<br><span class="segmentSeparator"></span>There may be multi-line scripting expression in the mapping and it may not entirely obvious what is the input and output.<br><span class="segmentSeparator"></span>Therefore each mapping and each expression have an ability to enable tracing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;attribute&gt;</span>
    <span class="tag">&lt;ref&gt;</span>ri:mobile<span class="tag">&lt;/ref&gt;</span>
    <span class="tag">&lt;outbound&gt;</span>
        <span class="tag">&lt;trace&gt;</span>true<span class="tag">&lt;/trace&gt;</span>
        <span class="tag">&lt;source&gt;</span>
             <span class="tag">&lt;path&gt;</span>$focus/telephoneNumber<span class="tag">&lt;/path&gt;</span>
        <span class="tag">&lt;/source&gt;</span>
        <span class="tag">&lt;expression&gt;</span>
            <span class="tag">&lt;trace&gt;</span>true<span class="tag">&lt;/trace&gt;</span>
            <span class="tag">&lt;script&gt;</span>
<span class="inline">                <span class="tag">&lt;code&gt;</span>...<span class="tag">&lt;/code&gt;</span></span>
            <span class="tag">&lt;/script&gt;</span>
        <span class="tag">&lt;/expression&gt;</span>
    <span class="tag">&lt;/outbound&gt;</span>
<span class="tag">&lt;/attribute&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If tracing is enabled then the mapping or expression execution will be recorded in the log files.<br><span class="segmentSeparator"></span>Tracing can be enabled at both mapping level and expression level.<br><span class="segmentSeparator"></span>Mapping tracing is shorter.<br><span class="segmentSeparator"></span>It provides overview of the mapping inputs and outputs.<br><span class="segmentSeparator"></span>Expression-level tracing is much more detailed.</p>
</div>
<div class="paragraph">
<p>However, even this level of tracing may not be enough to debug expression code.<br><span class="segmentSeparator"></span>Therefore there is a special expression function for logging.<br><span class="segmentSeparator"></span>Arbitrary messages may be logged by script expression code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;expression&gt;</span>
        <span class="tag">&lt;script&gt;</span>
<span class="inline">            <span class="tag">&lt;code&gt;</span>
                ...<br><span class="segmentSeparator"></span>                log.info("Value of foo is {}", foo)
                ...<br><span class="segmentSeparator"></span>            <span class="tag">&lt;/code&gt;</span></span>
        <span class="tag">&lt;/script&gt;</span>
    <span class="tag">&lt;/expression&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Generally speaking, troubleshooting of mappings may be quite difficult as it is often intertwined with midPoint internal algorithms.<br><span class="segmentSeparator"></span>But there are ways how to do it.<br><span class="segmentSeparator"></span>The <a href="https://docs.evolveum.com/book/practical-identity-management-with-midpoint.html#90-troubleshooting">Troubleshooting</a> chapter provides much more details on this.</p>
</div>
</div>
<div class="sect2">
<h3 id="_expression_functions">Expression Functions</h3>
<div class="paragraph">
<p>Expressions in general and scripting expressions in particular are the place where most midPoint customization takes place.<br><span class="segmentSeparator"></span>Scripting expressions are able to execute any code in a general-purpose programming language.<br><span class="segmentSeparator"></span>Therefore the script can transform the data in any way or it can execute any function.<br><span class="segmentSeparator"></span>Quite naturally there are functions that are frequently used in the scripts.<br><span class="segmentSeparator"></span>Therefore midPoint provides convenient scripting libraries full of useful methods ready to be used in scripting expressions.</p>
</div>
<div class="paragraph">
<p>There are two scripting libraries that are used very often:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Basic script library</strong> provides very basic functions for string operations, object property retrieval, etc.<br><span class="segmentSeparator"></span>These are simple, efficient stand-alone functions.<br><span class="segmentSeparator"></span>These functions can be used in every expression.</p>
</li>
<li>
<p><strong>MidPoint script library</strong> provides access to higher-level midPoint functions contain IDM-specific and midPoint-specific logic.<br><span class="segmentSeparator"></span>This library can be used to access almost all midPoint functionality.<br><span class="segmentSeparator"></span>But there are few places where this library may not work reliably (e.g.<br><span class="segmentSeparator"></span>correlation expression).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The libraries are designed to be very easy to use from the scripting code.<br><span class="segmentSeparator"></span>While the specific details how to invoke the library depend on the scripting language, the libraries are usually accessible by the use of <code>basic</code> and <code>midpoint</code> symbols.<br><span class="segmentSeparator"></span>Function <code>norm()</code> from the basic library can be invoked in a Groovy script like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;expression&gt;</span>
        <span class="tag">&lt;script&gt;</span>
<span class="inline">            <span class="tag">&lt;code&gt;</span>
                ...<br><span class="segmentSeparator"></span>                basic.norm('Guľôčka v jamôčke!')
                ...<br><span class="segmentSeparator"></span>            <span class="tag">&lt;/code&gt;</span></span>
        <span class="tag">&lt;/script&gt;</span>
    <span class="tag">&lt;/expression&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Invocation of the libraries from JavaScript and Python is almost the same and we are sure that a clever reader will have no trouble figuring that out.<br><span class="segmentSeparator"></span>What is more difficult to figure out is which functions the libraries provide.<br><span class="segmentSeparator"></span>For that purpose there is a page in midPoint wiki that lists all the libraries and this page also has a link to library function documentation.<br><span class="segmentSeparator"></span>Look for <a href="https://wiki.evolveum.com/display/midPoint/Script+Expression+Functions">Script Expression Functions</a> page in midPoint wiki.</p>
</div>
<div class="paragraph">
<p>Only two libraries were mentioned in this section so far.<br><span class="segmentSeparator"></span>However, this is not a whole story.<br><span class="segmentSeparator"></span>A clever reader has certainly figured out that the logging function described in previous section is also a scripting library.<br><span class="segmentSeparator"></span>And there may be more libraries in the future.</p>
</div>
<div class="sect3">
<h4 id="_resource_capabilities">Resource Capabilities</h4>
<div class="paragraph">
<p>The systems that midPoint connects to are not created equal.<br><span class="segmentSeparator"></span>In fact, those system significantly differ in their capabilities.<br><span class="segmentSeparator"></span>Most systems can create accounts.<br><span class="segmentSeparator"></span>But not all of them can delete accounts.<br><span class="segmentSeparator"></span>There are systems that keep the accounts forever, the accounts can be just permanently disabled.<br><span class="segmentSeparator"></span>And yet another systems cannot enable or disable accounts.<br><span class="segmentSeparator"></span>While most systems support password authentication, other system do not.<br><span class="segmentSeparator"></span>There is a lot of natural diversity in the provisioning wilderness.<br><span class="segmentSeparator"></span>And even the connector may introduce limitations.<br><span class="segmentSeparator"></span>Even if target system supports a particular feature, connector may not have appropriate code to use it.<br><span class="segmentSeparator"></span>MidPoint needs to take all these differences into consideration when executing synchronization and provisioning operations.</p>
</div>
<div class="paragraph">
<p>MidPoint refers to these features of the systems and connectors as <em>resource capabilities</em>.<br><span class="segmentSeparator"></span>Although capabilities may in fact be quite complex, they are essentially just a list of things that a connector and resource can do.<br><span class="segmentSeparator"></span>MidPoint is aware of the resource capabilities.<br><span class="segmentSeparator"></span>Therefore midPoint can work with resource data correctly.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>midPoint will not try to modify account on a read-only resource.</p>
</div>
<div class="paragraph">
<p>Capabilities are usually automatically discovered by midPoint and everything just works out of the box.<br><span class="segmentSeparator"></span>There is usually no extra work to maintain the capabilities.<br><span class="segmentSeparator"></span>But sometimes there is a need to tweak the capabilities a bit.<br><span class="segmentSeparator"></span>Maybe the connector cannot detect resource capabilities well enough.<br><span class="segmentSeparator"></span>Maybe there is a read-only resource, but the connector has no way of knowing this.<br><span class="segmentSeparator"></span>Therefore the write capabilities have to be manually disabled in midPoint.<br><span class="segmentSeparator"></span>For that reason there are two sets of capabilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Native capabilities</strong> are capabilities detected by the connector.<br><span class="segmentSeparator"></span>Those are always automatically generated by midPoint.<br><span class="segmentSeparator"></span>Those capabilities should not be modified by administrator.</p>
</li>
<li>
<p><strong>Configured capabilities</strong> are the capabilities modified by the administrator.<br><span class="segmentSeparator"></span>Configured capabilities are used to override native capabilities.<br><span class="segmentSeparator"></span>Configured capabilities are usually empty, which means that only native capabilities are used.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are many ways how the capabilities can be tweaked by the administrator.<br><span class="segmentSeparator"></span>But there is one case that is particularly interesting for synchronization and provisioning: simulated activation capability.</p>
</div>
<div class="paragraph">
<p>MidPoint connectors can be tailored specifically for a particular system.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>there are often connectors that are developed specifically for one custom enterprise application.<br><span class="segmentSeparator"></span>At the other side of the spectrum are generic connectors that can fit a wide variety of systems and applications.<br><span class="segmentSeparator"></span>LDAP, CSV and database table connectors are examples of such generic connectors.<br><span class="segmentSeparator"></span>Such connectors are very useful and they are used in almost every midPoint deployment.<br><span class="segmentSeparator"></span>However, there is no standardized way how to disable an account in database table or a CSV file.<br><span class="segmentSeparator"></span>Various columns and various values are used to represent account activation status.<br><span class="segmentSeparator"></span>Quite surprisingly, there is no standardized way how to disable an account in LDAP directory either.<br><span class="segmentSeparator"></span>But that is a bad news for midPoint.<br><span class="segmentSeparator"></span>MidPoint takes a significant advantage from knowing whether account is disabled or enabled.<br><span class="segmentSeparator"></span>We had to do something about it.<br><span class="segmentSeparator"></span>And we did.<br><span class="segmentSeparator"></span>There is way how to tell midPoint which attribute and what values are used to represent account activation status.<br><span class="segmentSeparator"></span>Configured activation capability is used for that purpose:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;capabilities&gt;</span>
        <span class="tag">&lt;configured&gt;</span>
            <span class="tag">&lt;cap:activation&gt;</span>
                <span class="tag">&lt;cap:status&gt;</span>
                    <span class="tag">&lt;cap:attribute&gt;</span>ri:active<span class="tag">&lt;/cap:attribute&gt;</span>
                    <span class="tag">&lt;cap:enableValue&gt;</span>true<span class="tag">&lt;/cap:enableValue&gt;</span>
                    <span class="tag">&lt;cap:disableValue&gt;</span>false<span class="tag">&lt;/cap:disableValue&gt;</span>
                <span class="tag">&lt;/cap:status&gt;</span>
            <span class="tag">&lt;/cap:activation&gt;</span>
        <span class="tag">&lt;/configured&gt;</span>
    <span class="tag">&lt;/capabilities&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Configured capability above specifies resource attribute <code>active</code> as the attribute that controls account activation status.<br><span class="segmentSeparator"></span>If this attribute is set to value <code>true</code> then the account is enabled.<br><span class="segmentSeparator"></span>If the attribute is set to value <code>false</code> then the account is disabled.<br><span class="segmentSeparator"></span>That is it.<br><span class="segmentSeparator"></span>Once this configured capability is part of resource definition then midPoint will pretend that the resource can enable and disable accounts.<br><span class="segmentSeparator"></span>Attempt to disable account will be transparently translated to modification of attribute active.<br><span class="segmentSeparator"></span>But it also works the other way around.<br><span class="segmentSeparator"></span>If an account has attribute <code>active</code> set to <code>false</code> value midPoint will display that account as disabled.<br><span class="segmentSeparator"></span>No extra logic or mapping is needed to achieve that.<br><span class="segmentSeparator"></span>The capability does it all.</p>
</div>
</div>
<div class="sect3">
<h4 id="_synchronization_example_ldap_account_correlation">Synchronization Example: LDAP Account Correlation</h4>
<div class="paragraph">
<p>Previous example demonstrated the use of synchronization for HR feed.<br><span class="segmentSeparator"></span>That is the most obvious use of synchronization mechanisms.<br><span class="segmentSeparator"></span>However, midPoint synchronization is much more flexible than just feeding data to midPoint.<br><span class="segmentSeparator"></span>Synchronization can be used even for target resources.<br><span class="segmentSeparator"></span>In that case the synchronization is usually used for several purposes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Initial migration:</strong> This is a process of connecting new resource to midPoint.<br><span class="segmentSeparator"></span>There are usually accounts that already exist in the resource at the time when a resource is connected to midPoint.<br><span class="segmentSeparator"></span>It is likely that at least some of the accounts correspond to the users that are present in midPoint (e.g.<br><span class="segmentSeparator"></span>users created from the HR feed).<br><span class="segmentSeparator"></span>Therefore the accounts from the resource need to be correlated to the users that already exist in midPoint.<br><span class="segmentSeparator"></span>Synchronization is the right mechanism for this.</p>
</li>
<li>
<p><strong>Detection of illegal accounts:</strong> Security policies are usually set up in such a way that only those people that need an account on a particular resource should have that account.<br><span class="segmentSeparator"></span>This is known as the <em>principle of least privilege</em>.<br><span class="segmentSeparator"></span>However, in typical IDM deployment there is nothing that would prohibit system administrator to create any accounts at will.<br><span class="segmentSeparator"></span>And this is often desirable because there are emergency situations where full control over the system is crucial.<br><span class="segmentSeparator"></span>But even for emergency cases, we want to make sure that the situation is aligned with policies when the emergency is over.<br><span class="segmentSeparator"></span>MidPoint can easily do that by scanning the target systems in regular intervals.<br><span class="segmentSeparator"></span>Synchronization mechanisms can be used to detect accounts that do not have any legal basis and delete or disable such accounts.<br><span class="segmentSeparator"></span>Again, synchronization mechanism can do that easily.</p>
</li>
<li>
<p><strong>Attribute value synchronization:</strong> Accounts in target resources are usually created as a result of midPoint provisioning action.<br><span class="segmentSeparator"></span>However, account attribute values are in fact copies of the data in midPoint.<br><span class="segmentSeparator"></span>Attribute values can easily be changed by system administrator, may be set to old values during data recovery procedure or they can get out of sync by a variety of other means.<br><span class="segmentSeparator"></span>MidPoint can make sure that the attributes are synchronized and that they stay synchronized for a long time.<br><span class="segmentSeparator"></span>Synchronization mechanisms are ideal for this purpose.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Older IDM systems used synchronization mostly to get data from the source resources to IDM system.<br><span class="segmentSeparator"></span>But synchronization in midPoint is much more powerful.<br><span class="segmentSeparator"></span>It can be applied to source systems and target systems, it can pull data, push data, detect inconsistencies and fix them.<br><span class="segmentSeparator"></span>Synchronization is a general purpose mechanism.<br><span class="segmentSeparator"></span>This is the principle of reuse again.<br><span class="segmentSeparator"></span>Synchronization mechanism can be reused for variety of purposes.</p>
</div>
<div class="paragraph">
<p>In this example we will be using synchronization to connect existing LDAP server to midPoint.<br><span class="segmentSeparator"></span>We assume that our midPoint is already connected to the HR system.<br><span class="segmentSeparator"></span>We have imported the HR data.<br><span class="segmentSeparator"></span>Now we have midPoint users created for all our employees.<br><span class="segmentSeparator"></span>And then there is this LDAP server.<br><span class="segmentSeparator"></span>It is really important LDAP server.<br><span class="segmentSeparator"></span>This server is used by company intranet portal and also by a variety of smaller web applications.<br><span class="segmentSeparator"></span>Those applications are using the LDAP server for user authentication and access authorization.<br><span class="segmentSeparator"></span>The LDAP server was deployed few years ago.<br><span class="segmentSeparator"></span>Initially it was populated by the HR data.<br><span class="segmentSeparator"></span>But the LDAP server was managed manually by a system administrator during all these years.<br><span class="segmentSeparator"></span>Therefore it is expected that there will be some accounts that belong to former employees.<br><span class="segmentSeparator"></span>Also, it might have happened that some accounts are missing.<br><span class="segmentSeparator"></span>And it is quite likely that a lot of the accounts have wrong data.</p>
</div>
<div class="paragraph">
<p>First task is to set up the connector for this resource.<br><span class="segmentSeparator"></span>As LDAP servers are used for identity management purpose all the time, MidPoint comes with a really good LDAP connector.<br><span class="segmentSeparator"></span>All we need is to set up the resource to use that connector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;resource</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">8a83b1a4-be18-11e6-ae84-7301fdab1d7c</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>OpenLDAP<span class="tag">&lt;/name&gt;</span>

    <span class="tag">&lt;connectorRef</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">ConnectorType</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;filter&gt;</span>
            <span class="tag">&lt;q:equal&gt;</span>
                <span class="tag">&lt;q:path&gt;</span>connectorType<span class="tag">&lt;/q:path&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;q:value&gt;</span>com.evolveum.polygon.connector.ldap.LdapConnector<span class="tag">&lt;/q:value&gt;</span>
            <span class="tag">&lt;/q:equal&gt;</span>
        <span class="tag">&lt;/filter&gt;</span>
    <span class="tag">&lt;/connectorRef&gt;</span>
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>What we can see here is a slightly more sophisticated method to reference the connector.<br><span class="segmentSeparator"></span>So far we have seen only a direct reference by OID.<br><span class="segmentSeparator"></span>This works well for almost all the references in midPoint because OID never changes.<br><span class="segmentSeparator"></span>But connectors are a bit tricky.<br><span class="segmentSeparator"></span>Objects that represent connectors are dynamically created by midPoint when a connector is discovered.<br><span class="segmentSeparator"></span>Therefore the OID is generated at random when midPoint starts.<br><span class="segmentSeparator"></span>There is no practical way how a system administrator can predict that OID.<br><span class="segmentSeparator"></span>But we still want our resource definitions to refer to a particular connector when we import the definition.<br><span class="segmentSeparator"></span>Therefore there is an alternative way how to specify object references.<br><span class="segmentSeparator"></span>This method is using a search filter instead of direct OID reference.<br><span class="segmentSeparator"></span>When this resource definition is imported to midPoint then midPoint will use that filter and look for LDAP connector.<br><span class="segmentSeparator"></span>If that connector is found then the OID of that connector is placed in the reference (<code>connectorRef</code>).<br><span class="segmentSeparator"></span>Therefore the next time midPoint will be using this resource it can follow the OID directly.<br><span class="segmentSeparator"></span>This is a very convenient method.<br><span class="segmentSeparator"></span>But there are few limitations.<br><span class="segmentSeparator"></span>Firstly, the filter is resolved only during import.<br><span class="segmentSeparator"></span>That means it is resolved only once.<br><span class="segmentSeparator"></span>If the connector is not present at import time then the reference needs to be corrected manually.<br><span class="segmentSeparator"></span>Secondly, this approach works if there is only one LDAP connector deployed to midPoint.<br><span class="segmentSeparator"></span>This is usually the case.<br><span class="segmentSeparator"></span>But the connector framework can contain several connectors of the same type in different versions.<br><span class="segmentSeparator"></span>This is a very useful feature for gradual connector upgrades, testing of new connector versions and so on.<br><span class="segmentSeparator"></span>But in case that the filter matches more than one object the import will fail.<br><span class="segmentSeparator"></span>In that case the connector reference has to be set up manually.</p>
</div>
<div class="paragraph">
<p>Once we have proper reference to LDAP connector we need to configure the connection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;connectorConfiguration&gt;</span>
        <span class="tag">&lt;icfc:configurationProperties&gt;</span>
            <span class="tag">&lt;cc:port&gt;</span>389<span class="tag">&lt;/cc:port&gt;</span>
            <span class="tag">&lt;cc:host&gt;</span>localhost<span class="tag">&lt;/cc:host&gt;</span>
            <span class="tag">&lt;cc:baseContext&gt;</span>dc=example,dc=com<span class="tag">&lt;/cc:baseContext&gt;</span>
            <span class="tag">&lt;cc:bindDn&gt;</span>cn=idm,ou=Administrators,dc=example,dc=com<span class="tag">&lt;/cc:bindDn&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;cc:bindPassword&gt;</span><span class="tag">&lt;t:clearValue&gt;</span>secret<span class="tag">&lt;/t:clearValue&gt;</span><span class="tag">&lt;/cc:bindPassword&gt;</span>
            ...<br><span class="segmentSeparator"></span>        <span class="tag">&lt;/icfc:configurationProperties&gt;</span>
        <span class="tag">&lt;icfc:resultsHandlerConfiguration&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;icfc:enableNormalizingResultsHandler&gt;</span>false<span class="tag">&lt;/icfc:enableNormalizingResultsHandler&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;icfc:enableFilteredResultsHandler&gt;</span>false<span class="tag">&lt;/icfc:enableFilteredResultsHandler&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;icfc:enableAttributesToGetSearchResultsHandler&gt;</span>false<span class="tag">&lt;/icfc:enableAttributesToGetSearchResultsHandler&gt;</span>
        <span class="tag">&lt;/icfc:resultsHandlerConfiguration&gt;</span>
    <span class="tag">&lt;/connectorConfiguration&gt;</span>
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is all very similar to the configuration of the other resource that were already presented in this book.<br><span class="segmentSeparator"></span>It should be quite self-explanatory – except perhaps for the configuration of result handlers.<br><span class="segmentSeparator"></span><em>Result handlers</em> are little helpers that come with the ConnId connector framework.<br><span class="segmentSeparator"></span>The purpose of the result handlers is to assist simpler connectors in filtering and post-processing search results.<br><span class="segmentSeparator"></span>But LDAP connector is no ordinary simple connector.<br><span class="segmentSeparator"></span>LDAP connector is mature and full-featured connector that can do everything without any help from such annoying little creatures as those result handlers.<br><span class="segmentSeparator"></span>ConnId result handlers do not add any value here.<br><span class="segmentSeparator"></span>In fact they may even be harmful.<br><span class="segmentSeparator"></span>LDAP protocol has a lot of peculiarities such as case-insensitivity that applies to almost all the aspects of LDAP data – except for some notable exceptions.<br><span class="segmentSeparator"></span>The connector is aware of those peculiarities but the handlers are not.<br><span class="segmentSeparator"></span>Therefore if the handlers are turned on (which is the default) they may get in the way and ruin the data.<br><span class="segmentSeparator"></span>Therefore it is always strongly recommended to explicitly turn off the handler when a full-featured connector is used.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The XML example above, as all other examples in this book, is simplified and shortened for clarity.<br><span class="segmentSeparator"></span>You will not be able to import the example in this form into midPoint.<br><span class="segmentSeparator"></span>For a full importable examples see the files that are supposed to accompany this book.<br><span class="segmentSeparator"></span>Please see <a href="https://docs.evolveum.com/book/practical-identity-management-with-midpoint.html#92-additional-information">Additional Information</a> chapter.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>The basic resource configuration above is sufficient to connect to the resource.<br><span class="segmentSeparator"></span>Therefore the test connection operation on resource details page should be successful.<br><span class="segmentSeparator"></span>This configuration may also be used to list the accounts.<br><span class="segmentSeparator"></span>However, LDAP servers support many object classes and midPoint does not yet know which object class represents account.<br><span class="segmentSeparator"></span>Therefore we need to add schema handling section to our resource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    ...<br><span class="segmentSeparator"></span>     <span class="tag">&lt;schemaHandling&gt;</span>
        <span class="tag">&lt;objectType&gt;</span>
            <span class="tag">&lt;kind&gt;</span>account<span class="tag">&lt;/kind&gt;</span>
            <span class="tag">&lt;displayName&gt;</span>Normal Account<span class="tag">&lt;/displayName&gt;</span>
            <span class="tag">&lt;default&gt;</span>true<span class="tag">&lt;/default&gt;</span>
            <span class="tag">&lt;objectClass&gt;</span>ri:inetOrgPerson<span class="tag">&lt;/objectClass&gt;</span>
            <span class="tag">&lt;attribute&gt;</span>
                <span class="tag">&lt;ref&gt;</span>ri:dn<span class="tag">&lt;/ref&gt;</span>
                <span class="tag">&lt;displayName&gt;</span>Distinguished Name<span class="tag">&lt;/displayName&gt;</span>
                <span class="tag">&lt;limitations&gt;</span>
                    <span class="tag">&lt;minOccurs&gt;</span>0<span class="tag">&lt;/minOccurs&gt;</span>
                <span class="tag">&lt;/limitations&gt;</span>
                <span class="tag">&lt;outbound&gt;</span>
                    <span class="tag">&lt;source&gt;</span>
                        <span class="tag">&lt;path&gt;</span>$focus/name<span class="tag">&lt;/path&gt;</span>
                    <span class="tag">&lt;/source&gt;</span>
                    <span class="tag">&lt;expression&gt;</span>
                        <span class="tag">&lt;script&gt;</span>
<span class="inline">                            <span class="tag">&lt;code&gt;</span>
                                basic.composeDnWithSuffix('uid', name,
                                                  'ou=people,dc=example,dc=com')
                            <span class="tag">&lt;/code&gt;</span></span>
                        <span class="tag">&lt;/script&gt;</span>
                    <span class="tag">&lt;/expression&gt;</span>
                <span class="tag">&lt;/outbound&gt;</span>
            <span class="tag">&lt;/attribute&gt;</span>
            ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>There should be outbound mapping for each mandatory LDAP attribute for the <code>inetOrgPerson</code> object class.<br><span class="segmentSeparator"></span>Those mapping are very typical for a target resource definition.</p>
</div>
<div class="paragraph">
<p>Once we set up the schema handling we should be able to conveniently list LDAP accounts in midPoint.<br><span class="segmentSeparator"></span>However, we need to switch to the <em>Resource</em> view instead of <em>Repository</em> view.<br><span class="segmentSeparator"></span>The accounts are stored in the LDAP server and midPoint can access them.<br><span class="segmentSeparator"></span>Therefore the accounts are listed in the <em>Resource</em> view.<br><span class="segmentSeparator"></span>But midPoint have not processed the accounts yet.<br><span class="segmentSeparator"></span>Therefore there are no account shadows in midPoint repository.<br><span class="segmentSeparator"></span>And that is the reason that the <em>Repository</em> view is empty.<br><span class="segmentSeparator"></span>But now we are going to do something about it.</p>
</div>
<div class="paragraph">
<p>We are going to import (or reconcile) the resource accounts.<br><span class="segmentSeparator"></span>But if we try to do this now nothing would really happen.<br><span class="segmentSeparator"></span>The accounts are not linked to users therefore midPoint will not synchronize the attributes.<br><span class="segmentSeparator"></span>And midPoint was not told to do anything with the accounts.<br><span class="segmentSeparator"></span>Therefore midPoint will do nothing.<br><span class="segmentSeparator"></span>That is one of midPoint principles: midPoint will not change the accounts in any way unless it is explicitly told to do so.<br><span class="segmentSeparator"></span>Default midPoint configuration is to do nothing.<br><span class="segmentSeparator"></span>We would rather do nothing than to destroy the data.</p>
</div>
<div class="paragraph">
<p>Before we can import the accounts we need to set up the synchronization configuration for this resource.<br><span class="segmentSeparator"></span>There are accounts in the LDAP server that should belong to users that already exist in midPoint.<br><span class="segmentSeparator"></span>We want to link them.<br><span class="segmentSeparator"></span>But we do not want to do the linking manually.<br><span class="segmentSeparator"></span>We would rather set up a correlation expression that does this automatically:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    ...<br><span class="segmentSeparator"></span>     <span class="tag">&lt;synchronization&gt;</span>
        <span class="tag">&lt;objectSynchronization&gt;</span>
            <span class="tag">&lt;objectClass&gt;</span>ri:inetOrgPerson<span class="tag">&lt;/objectClass&gt;</span>
            <span class="tag">&lt;kind&gt;</span>account<span class="tag">&lt;/kind&gt;</span>
            <span class="tag">&lt;intent&gt;</span>default<span class="tag">&lt;/intent&gt;</span>
            <span class="tag">&lt;focusType&gt;</span>UserType<span class="tag">&lt;/focusType&gt;</span>
            <span class="tag">&lt;enabled&gt;</span>true<span class="tag">&lt;/enabled&gt;</span>
            <span class="tag">&lt;correlation&gt;</span>
                <span class="tag">&lt;q:equal&gt;</span>
                    <span class="tag">&lt;q:path&gt;</span>employeeNumber<span class="tag">&lt;/q:path&gt;</span>
                    <span class="tag">&lt;expression&gt;</span>
                        <span class="tag">&lt;path&gt;</span>$projection/attributes/employeeNumber<span class="tag">&lt;/path&gt;</span>
                    <span class="tag">&lt;/expression&gt;</span>
                <span class="tag">&lt;/q:equal&gt;</span>
            <span class="tag">&lt;/correlation&gt;</span>
            ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This correlation expression is going to match account attribute <code>employeeNumber</code> and user property that is also named <code>employeeNumber</code>.<br><span class="segmentSeparator"></span>Simply speaking: if account and user employee numbers match then we assume that they should be linked.<br><span class="segmentSeparator"></span>In that case midPoint decides that synchronization situation is unlinked (they should be linked, but they are not yet linked).<br><span class="segmentSeparator"></span>We want midPoint to link the account in this case, therefore we define appropriate reaction:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">            ...<br><span class="segmentSeparator"></span>            <span class="tag">&lt;reaction&gt;</span>
                <span class="tag">&lt;situation&gt;</span>unlinked<span class="tag">&lt;/situation&gt;</span>
                <span class="tag">&lt;synchronize&gt;</span>true<span class="tag">&lt;/synchronize&gt;</span>
                <span class="tag">&lt;action&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;handlerUri&gt;</span>http://midpoint.evolveum.com/xml/ns/public/model/action-3#link<span class="tag">&lt;/handlerUri&gt;</span>
                <span class="tag">&lt;/action&gt;</span>
            <span class="tag">&lt;/reaction&gt;</span>
            ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will take care of accounts for whose we can find an owner.<br><span class="segmentSeparator"></span>But what to do with other accounts?<br><span class="segmentSeparator"></span>We will do nothing about that yet.<br><span class="segmentSeparator"></span>Therefore we do not need to define any other reactions.<br><span class="segmentSeparator"></span>This may be somehow surprising.<br><span class="segmentSeparator"></span>We do not want illegal accounts, do we?<br><span class="segmentSeparator"></span>Then perhaps we would like to see a reaction to delete unmatched accounts, right?<br><span class="segmentSeparator"></span>That would be a good approach, but it is just too early for this.<br><span class="segmentSeparator"></span>We do not want to delete unmatched account just now.<br><span class="segmentSeparator"></span>There may be accounts that are perfectly legal, just the employeeNumber attribute is missing or mistyped.<br><span class="segmentSeparator"></span>Data errors like those happen all the time, especially when the data were managed manually.<br><span class="segmentSeparator"></span>We do not want to over-react and start deleting accounts too early.<br><span class="segmentSeparator"></span>Therefore we will go just with this one synchronization reaction for now.</p>
</div>
<div class="paragraph">
<p>Now it is the right time to start import or reconciliation task.<br><span class="segmentSeparator"></span>After the task is finished the situation may look like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/05-04-reconciliation-ldap-unmatched.png" alt="OpenLDAP accounts">
</div>
</div>
<div class="paragraph">
<p>It looks like we had quite a good data in the LDAP server.<br><span class="segmentSeparator"></span>Most of the accounts were successfully correlated and linked to their owners.<br><span class="segmentSeparator"></span>But there are few accounts that were not correlated.<br><span class="segmentSeparator"></span>Those accounts ended up in unmatched situation.<br><span class="segmentSeparator"></span>You can resolve this situation by manually linking the unmatched accounts to their users.<br><span class="segmentSeparator"></span>Simply click on the small triangle button next to the unmatched entry and select <em>Change owner</em> from the context menu.<br><span class="segmentSeparator"></span>Then select the right user (Isabella Irvine) in the dialog that appears.<br><span class="segmentSeparator"></span>After that the account is linked to the user.<br><span class="segmentSeparator"></span>Repeat this process to link all unmatched accounts.</p>
</div>
<div class="paragraph">
<p>There is one interesting thing in the screenshot above.<br><span class="segmentSeparator"></span>Have a look at the LDAP account identified by <code>uid=carol</code>.<br><span class="segmentSeparator"></span>While most other accounts have their uid value taken from the surname of the user, this account is an exception.<br><span class="segmentSeparator"></span>Even though the uid is obviously wrong, midPoint have linked the account correctly to the user (Carol Cooper).<br><span class="segmentSeparator"></span>The reason is that we have set up midPoint to use employeeNumber for correlation.<br><span class="segmentSeparator"></span>The result is that even accounts whose usernames violate the convention can be automatically linked to their owners - as long as there is any reliable piece of information that can be used for correlation.</p>
</div>
<div class="paragraph">
<p>When all the accounts are all linked to their owners it is the right time to complete the synchronization policy.<br><span class="segmentSeparator"></span>Now we can tell midPoint to delete any unmatched account.<br><span class="segmentSeparator"></span>That is the case when an illegal account is created in LDAP server.<br><span class="segmentSeparator"></span>We can also tell midPoint to unlink any account that was deleted in LDAP server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">            ...<br><span class="segmentSeparator"></span>            <span class="tag">&lt;reaction&gt;</span>
                <span class="tag">&lt;situation&gt;</span>unmatched<span class="tag">&lt;/situation&gt;</span>
                <span class="tag">&lt;action&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;handlerUri&gt;</span>http://midpoint.evolveum.com/xml/ns/public/model/action-3#deleteShadow<span class="tag">&lt;/handlerUri&gt;</span>
                <span class="tag">&lt;/action&gt;</span>
            <span class="tag">&lt;/reaction&gt;</span>
            <span class="tag">&lt;reaction&gt;</span>
                <span class="tag">&lt;situation&gt;</span>deleted<span class="tag">&lt;/situation&gt;</span>
                <span class="tag">&lt;action&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;handlerUri&gt;</span>http://midpoint.evolveum.com/xml/ns/public/model/action-3#unlink<span class="tag">&lt;/handlerUri&gt;</span>
                <span class="tag">&lt;/action&gt;</span>
            <span class="tag">&lt;/reaction&gt;</span>
            ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>There may be some accounts in the LDAP server that have wrong attribute values.<br><span class="segmentSeparator"></span>By "wrong" we mean that the attributes have different values than the values that are computed by the outbound mappings.<br><span class="segmentSeparator"></span>But midPoint will not correct those values just yet.<br><span class="segmentSeparator"></span>Remember the midPoint principle that it will not change the account unless we have explicitly told to do so?<br><span class="segmentSeparator"></span>Those accounts are in the <code>linked</code> situation.<br><span class="segmentSeparator"></span>And we have not configured any reaction for this situation.<br><span class="segmentSeparator"></span>Therefore now we need to tell midPoint to synchronize the values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">            ...<br><span class="segmentSeparator"></span>            <span class="tag">&lt;reaction&gt;</span>
                <span class="tag">&lt;situation&gt;</span>linked<span class="tag">&lt;/situation&gt;</span>
                <span class="tag">&lt;synchronize&gt;</span>true<span class="tag">&lt;/synchronize&gt;</span>
            <span class="tag">&lt;/reaction&gt;</span>
            ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>A clever readers is now surely wondering whether we have forgotten something.<br><span class="segmentSeparator"></span>And indeed we have.<br><span class="segmentSeparator"></span>Attribute values are synchronized by running reconciliation process.<br><span class="segmentSeparator"></span>But our outbound mappings will not work in reconciliation.<br><span class="segmentSeparator"></span>They do not have any explicit definition of strength, therefore midPoint assumes <code>normal</code> strength.<br><span class="segmentSeparator"></span>Those mappings are supposed to implement the <em>last change wins</em> strategy.<br><span class="segmentSeparator"></span>Therefore reconciliation cannot overwrite the account data as midPoint does not know whether it was account attribute or user property that was the last to change.<br><span class="segmentSeparator"></span>If midPoint is not sure about something then it will do nothing.<br><span class="segmentSeparator"></span>We do not want to destroy the data.<br><span class="segmentSeparator"></span>Therefore what we need to do now it so let midPoint know that we really mean it, that the mappings are really <code>strong</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">            ...<br><span class="segmentSeparator"></span>            <span class="tag">&lt;attribute&gt;</span>
                <span class="tag">&lt;ref&gt;</span>ri:cn<span class="tag">&lt;/ref&gt;</span>
                <span class="tag">&lt;displayName&gt;</span>Common Name<span class="tag">&lt;/displayName&gt;</span>
                <span class="tag">&lt;limitations&gt;</span>
                    <span class="tag">&lt;minOccurs&gt;</span>0<span class="tag">&lt;/minOccurs&gt;</span>
                    <span class="tag">&lt;maxOccurs&gt;</span>1<span class="tag">&lt;/maxOccurs&gt;</span>
                <span class="tag">&lt;/limitations&gt;</span>
                <span class="tag">&lt;outbound&gt;</span>
                    <span class="tag">&lt;strength&gt;</span>strong<span class="tag">&lt;/strength&gt;</span>
                    <span class="tag">&lt;source&gt;</span>
                        <span class="tag">&lt;path&gt;</span>$focus/fullName<span class="tag">&lt;/path&gt;</span>
                    <span class="tag">&lt;/source&gt;</span>
                <span class="tag">&lt;/outbound&gt;</span>
            <span class="tag">&lt;/attribute&gt;</span>
            ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Clever reader is uneasy once again.<br><span class="segmentSeparator"></span>What is this <code>limitations</code> thing here?<br><span class="segmentSeparator"></span>Simply speaking, the limitations specify that the attribute is optional (<code>minOccurs=0</code>) and that it is single-valued (<code>maxOccurs=1</code>).<br><span class="segmentSeparator"></span>But, isn’t midPoint supposed to be completely schema-aware and figure that all by itself?<br><span class="segmentSeparator"></span>Yes, it is.<br><span class="segmentSeparator"></span>And in fact, that is the reason why we need to override the information from the schema using this <code>limitations</code> element here.<br><span class="segmentSeparator"></span>The <code>cn</code> attribute is specified in LDAP schema as a mandatory attribute.<br><span class="segmentSeparator"></span>However, we have just specified outbound mapping for that attribute.<br><span class="segmentSeparator"></span>Therefore even if midPoint user does not provide any value for attribute <code>cn</code>, we can still determine that value by using the expression.<br><span class="segmentSeparator"></span>Therefore even though LDAP schema specifies attribute <code>cn</code> as mandatory, we want to present that attribute as optional in midPoint.<br><span class="segmentSeparator"></span>Hence the <code>minOccurs</code> limitation.<br><span class="segmentSeparator"></span>And the <code>maxOccurs</code> limitation is immediately obvious to anyone who is intimately familiar with LDAP peculiarities.<br><span class="segmentSeparator"></span>In the LDAP world, almost everything is multi-valued by default.<br><span class="segmentSeparator"></span>Therefore even commonly used attributes for account identifiers and names are multi-valued.<br><span class="segmentSeparator"></span>Nobody is really using them as multi-valued attributes because vast majority of applications will probably explode if they ever encounter two values in the <code>cn</code> attribute.<br><span class="segmentSeparator"></span>But those attributes are formally defined as multi-valued in LDAP schema and that is what midPoint gets from LDAP connector.<br><span class="segmentSeparator"></span>The <code>maxOccurs</code> limitation is overriding the schema and forcing midPoint to handle this attribute as if it was single-value attribute.</p>
</div>
<div class="paragraph">
<p>That is all.<br><span class="segmentSeparator"></span>Now you can schedule reconciliation tasks to keep an eye on the LDAP server.<br><span class="segmentSeparator"></span>The task will correct any attribute values that step out of line and delete any illegal accounts.<br><span class="segmentSeparator"></span>This is how synchronization tasks can be useful even in case of pure target resources.</p>
</div>
<div class="paragraph">
<p>However, there is one last word of warning.<br><span class="segmentSeparator"></span>Those accounts were synchronized and linked to existing midPoint users.<br><span class="segmentSeparator"></span>The accounts were not created by midPoint.<br><span class="segmentSeparator"></span>Therefore there is nothing in midPoint that would say that those accounts should exits.<br><span class="segmentSeparator"></span>In midPoint parlance there are no <em>assignments</em> for those accounts.<br><span class="segmentSeparator"></span>MidPoint makes clear distinction between policy and reality.<br><span class="segmentSeparator"></span>Therefore midPoint is aware that those accounts exist, but there is no policy statement that would justify their existence.<br><span class="segmentSeparator"></span>By default midPoint does nothing and it will let the accounts live.<br><span class="segmentSeparator"></span>The accounts will be created or deleted only if there is an explicit change in the assignments.<br><span class="segmentSeparator"></span>There is no such change now, therefore the accounts are not deleted.<br><span class="segmentSeparator"></span>But this is a fragile situation.<br><span class="segmentSeparator"></span>Accounts that are linked but not assigned can easily get deleted if midPoint administrator is not careful.<br><span class="segmentSeparator"></span>Of course, there are methods to handle such situations.<br><span class="segmentSeparator"></span>One way would be to create the assignments together with the links.<br><span class="segmentSeparator"></span>Those that are interested in this method should look up keyword "legalize" in midPoint wiki.<br><span class="segmentSeparator"></span>But there are much better methods how to handle this.<br><span class="segmentSeparator"></span>Perhaps the best approach would be to utilize the roles (RBAC).<br><span class="segmentSeparator"></span>Which is the topic of the <a href="https://docs.evolveum.com/book/practical-identity-management-with-midpoint.html#07-rbac">Role-Based Access Control</a> chapter below.<br><span class="segmentSeparator"></span>But there are still more things to learn about synchronization until we get there.</p>
</div>
</div>
<div class="sect3">
<h4 id="_reconciliation">Reconciliation</h4>
<div class="paragraph">
<p>Reconciliation is a process of comparing current state of an account (reality) to a desired state of the account (policy).<br><span class="segmentSeparator"></span>Reconciliation does not only compare the accounts, it is fixing the inconsistencies.<br><span class="segmentSeparator"></span>Therefore reconciliation can correct wrong data on resources.<br><span class="segmentSeparator"></span>But it also works the other way.<br><span class="segmentSeparator"></span>It can correct the data in midPoint.<br><span class="segmentSeparator"></span>Therefore reconciliation is one the most useful tools in the identity management toolbox.</p>
</div>
<div class="paragraph">
<p>Reconciliation can be used in a variety of ways.<br><span class="segmentSeparator"></span>Reconciliation can be initiated for one specific user by using midPoint user interface.<br><span class="segmentSeparator"></span>In that case midPoint compares the values of all user’s accounts to the values that were computed using the mappings.<br><span class="segmentSeparator"></span>If there is difference midPoint corrects account values.<br><span class="segmentSeparator"></span>This approach is perfect for testing reconciliation setting on just a single user.<br><span class="segmentSeparator"></span>This feature is also useful for fixing values of one specific user.</p>
</div>
<div class="paragraph">
<p>Reconciliation of a specific user may be useful, but it is an ad-hoc approach.<br><span class="segmentSeparator"></span>We usually favor systemic approaches in identity management.<br><span class="segmentSeparator"></span>Therefore reconciliation can be used in a form of a reconciliation task.<br><span class="segmentSeparator"></span>Reconciliation task lists all the accounts on the resource and then it reconciles each account, one by one.<br><span class="segmentSeparator"></span>This is a way how to keep all resource accounts continuously synchronized.</p>
</div>
<div class="paragraph">
<p>There is a couple of things about reconciliation that can be somehow surprising.<br><span class="segmentSeparator"></span>Firstly, reconciliation of an account may cause modification of a user.<br><span class="segmentSeparator"></span>This happens if there are inbound mappings for that account.<br><span class="segmentSeparator"></span>This is perhaps quite expected.<br><span class="segmentSeparator"></span>But if user is changed then such change may propagate to other accounts on other resources, usually by the means of outbound mapping.<br><span class="segmentSeparator"></span>MidPoint does not like procrastination and therefore it will try to execute those changes immediately.<br><span class="segmentSeparator"></span>But it means that reconciliation of one account may cause changes to other accounts.<br><span class="segmentSeparator"></span>Which makes a lot of sense, yet it may be quite surprising.<br><span class="segmentSeparator"></span>Secondly, reconciliation will skip any normal-strength mappings.<br><span class="segmentSeparator"></span>We have already explained the reasons for that, but this is something that can surprise even an experienced midPoint engineer from time to time.<br><span class="segmentSeparator"></span>If we are sure that we want the mapped value to be present in the account all the time then strong mappings are the way to go.</p>
</div>
<div class="paragraph">
<p>A curious reader that has already explored midPoint user interface has surely noticed <em>recompute</em> function.<br><span class="segmentSeparator"></span>What recompute does looks almost exactly the same as reconciliation.<br><span class="segmentSeparator"></span>But there are subtle differences.<br><span class="segmentSeparator"></span>Recompute will not force the fetch of account data.<br><span class="segmentSeparator"></span>In this case the account attributes will be fetched from the resource only if midPoint inevitably needs them for the computation.<br><span class="segmentSeparator"></span>This usually happens if <code>weak</code> or <code>strong</code> mappings are used.<br><span class="segmentSeparator"></span>But if there are <code>normal</code> mappings only then recompute may not read account data.<br><span class="segmentSeparator"></span>MidPoint will compare and correct account attribute values only for those accounts that are fetched from resource during this process.<br><span class="segmentSeparator"></span>That is how recompute works.<br><span class="segmentSeparator"></span>The purpose of a recompute is to correct data of midPoint users, which means evaluation of object templates and other policies.<br><span class="segmentSeparator"></span>Correcting account data is more or less just a side effect of a recompute.<br><span class="segmentSeparator"></span>On the other hand, reconciliation always tries to read all the accounts regardless whether they are needed for computation or not.<br><span class="segmentSeparator"></span>Therefore all the attributes on all the accounts are fixed.<br><span class="segmentSeparator"></span>That is the purpose of reconciliation: correct the account data.</p>
</div>
<div class="paragraph">
<p>There is yet another difference between recompute and reconcile <em>tasks</em>.<br><span class="segmentSeparator"></span>The purpose of a recompute task is to correct user data.<br><span class="segmentSeparator"></span>Therefore recompute task will iterate over midPoint users.<br><span class="segmentSeparator"></span>Recompute task will not detect new accounts on the resource and it may even overlook if an account is deleted.<br><span class="segmentSeparator"></span>But reconciliation task is different.<br><span class="segmentSeparator"></span>In fact reconciliation task has several stages.<br><span class="segmentSeparator"></span>Main reconciliation stage lists all resource accounts.<br><span class="segmentSeparator"></span>It determines owner of each account, compare the attributes and correct them.<br><span class="segmentSeparator"></span>But as this process iterates over real accounts on a resource, it can also detect new accounts.<br><span class="segmentSeparator"></span>When the main stage is completed then the next phase is looks at account shadows stored in midPoint.<br><span class="segmentSeparator"></span>The task looks for shadows that have not been processed in the main phase.<br><span class="segmentSeparator"></span>Those are accounts that used to be on the resource some time ago but that have disappeared.<br><span class="segmentSeparator"></span>That is how reconciliation detects deleted accounts.</p>
</div>
</div>
<div class="sect3">
<h4 id="_deltas">Deltas</h4>
<div class="paragraph">
<p>Reconciliation is really useful mechanism.<br><span class="segmentSeparator"></span>It is reliable and thorough, but it is also quite slow and it consumes o lot of computational and network resources.<br><span class="segmentSeparator"></span>And there are reasons why reconciliation is such a heavyweight beast.<br><span class="segmentSeparator"></span>Reconciliation works with <em>absolute</em> state of accounts.<br><span class="segmentSeparator"></span>It means that reconciliation is reading all the accounts with all the values of all the attributes.<br><span class="segmentSeparator"></span>Then it recomputes everything.<br><span class="segmentSeparator"></span>Even those attributes and values that were not changed are recomputed.<br><span class="segmentSeparator"></span>This is a very traditional and reliable way of computation and that is also the way how most older identity management systems work.</p>
</div>
<div class="paragraph">
<p>But there is also a better way.<br><span class="segmentSeparator"></span>If we know that just one attribute was changed we can recompute that single attribute only.<br><span class="segmentSeparator"></span>We do not need to care about other attributes.<br><span class="segmentSeparator"></span>And if we know that attribute foo has changed in such a way, that there is a new value bar then it gets even better.<br><span class="segmentSeparator"></span>We just need to recompute the value bar and do not care about any other values.<br><span class="segmentSeparator"></span>This is what we like to call a <em>relative change</em>.<br><span class="segmentSeparator"></span>We just care about the values that were changed.<br><span class="segmentSeparator"></span>That is how midPoint works internally.<br><span class="segmentSeparator"></span>We could say that MidPoint is <em>relativistic</em>.</p>
</div>
<div class="paragraph">
<p>This is where <em>delta</em> comes in.<br><span class="segmentSeparator"></span>Delta is a data structure that describes the change of a single midPoint object.<br><span class="segmentSeparator"></span><em>Add</em> delta describes a new midPoint object that is about to be created.<br><span class="segmentSeparator"></span><em>Modify</em> delta describes existing midPoint object where some properties have changed.<br><span class="segmentSeparator"></span><em>Delete</em> delta describes an object that is going to be deleted.<br><span class="segmentSeparator"></span>This is a very powerful mechanism.<br><span class="segmentSeparator"></span>Just remember that everything in midPoint can be represented as an object: user, account, resource, role, security policy … everything.<br><span class="segmentSeparator"></span>Therefore delta can represent any change.<br><span class="segmentSeparator"></span>It may be a change of user password, deletion of an account, change of connector configuration or introduction of a new password policy.<br><span class="segmentSeparator"></span>If all the changes can be represent in a uniform way then they can also be handled in a uniform way.<br><span class="segmentSeparator"></span>Therefore it is easy for midPoint to record all the changes in an audit trail – including configuration changes.<br><span class="segmentSeparator"></span>It is easy to route any change through an approval process.<br><span class="segmentSeparator"></span>And so on.<br><span class="segmentSeparator"></span>MidPoint can create a relatively simple mechanisms to handle changes and then those mechanisms can be applied to changes of (almost) any object.</p>
</div>
<div class="paragraph">
<p>Let’s have a closer look at an anatomy of a delta.<br><span class="segmentSeparator"></span>There three types of delta: <em>add</em>, <em>modify</em> and <em>delete</em>.<br><span class="segmentSeparator"></span><em>Add delta</em> is quite simple.<br><span class="segmentSeparator"></span>It contains a new object to be created.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/05-05-delta-add.png" alt="Add delta">
</div>
</div>
<div class="paragraph">
<p><em>Delete delta</em> is even simpler.<br><span class="segmentSeparator"></span>It contains just object identifier (OID) of an object to be deleted.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/05-06-delta-delete.png" alt="Delete delta">
</div>
</div>
<div class="paragraph">
<p>Last one is <em>modify delta</em>.<br><span class="segmentSeparator"></span>This delta contains a description of modified properties of an existing object.<br><span class="segmentSeparator"></span>But as the object can change in a variety of ways the modify delta is the most complex of the tree.<br><span class="segmentSeparator"></span>Modify delta contains a list of <em>item deltas</em>.<br><span class="segmentSeparator"></span>Each item delta describes how a particular part of an object changes.<br><span class="segmentSeparator"></span>For example following delta describes that a new value <code>pirate</code> is added to a user property <code>employeeType</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/05-07-delta-modify-add.png" alt="Modify delta: add">
</div>
</div>
<div class="paragraph">
<p>The item delta may have three modification types: <em>add</em>, <em>delete</em> and <em>replace</em>.<br><span class="segmentSeparator"></span><em>Add modification</em> means that new value or values are added to an item.<br><span class="segmentSeparator"></span><em>Delete modification</em> means that value or values are removed from an item.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/05-08-delta-modify-delete.png" alt="Modify delta: delete">
</div>
</div>
<div class="paragraph">
<p>In both <em>add</em> and <em>delete</em> cases the values that are not mentioned in the delta are not affected.<br><span class="segmentSeparator"></span>However, <em>replace</em> modification is different.<br><span class="segmentSeparator"></span>This means that all existing values of the item are going to be discarded and they are replaced with the value or values from the delta.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/05-09-delta-modify-replace.png" alt="Modify delta: replace">
</div>
</div>
<div class="paragraph">
<p>The deltas are designed to work with both single-valued and multi-valued items.<br><span class="segmentSeparator"></span>In fact <em>add modification</em> and <em>delete modification</em> deltas are specifically designed with multi-value items in mind.<br><span class="segmentSeparator"></span>Those deltas can work efficiently even in cases that there is a multi-valued attribute that has a very large number of values.<br><span class="segmentSeparator"></span>And there is a good reason for this.<br><span class="segmentSeparator"></span>Multi-valued properties are quite common in the identity management field.<br><span class="segmentSeparator"></span>Just think about how roles, groups, privileges and access control lists are usually implemented.<br><span class="segmentSeparator"></span>Everybody that ever managed a large group in LDAP server will surely remember that experience in vivid colors.<br><span class="segmentSeparator"></span>But midPoint is designed to handle situations like those.</p>
</div>
<div class="paragraph">
<p>Everything in midPoint is designed to work with deltas: user interface, mappings, authorizations, auditing … all the way down to the data storage components.<br><span class="segmentSeparator"></span>Mappings are designed in a relativistic ways.<br><span class="segmentSeparator"></span>That is the reason why we need to explicitly specify sources of the mapping.<br><span class="segmentSeparator"></span>Mapping source definitions are matched with items in the delta to control execution of the mapping.<br><span class="segmentSeparator"></span>Deltas permeate entire midPoint computation.<br><span class="segmentSeparator"></span>Deltas are input to the mappings, but mapping produce other deltas as output.<br><span class="segmentSeparator"></span>Therefore we can have a complete chain: deltas that are result of inbound mappings is applied to the user object, but those deltas are also input to outbound mappings.<br><span class="segmentSeparator"></span>Everything is <em>relativistic</em> in midPoint.</p>
</div>
<div class="paragraph">
<p>This might seem to be a bit over-complicated at the beginning.<br><span class="segmentSeparator"></span>But do not worry.<br><span class="segmentSeparator"></span>You will get used to it.<br><span class="segmentSeparator"></span>And clearly, this approach has major advantages.<br><span class="segmentSeparator"></span>But a clever reader does not seems to be impressed.<br><span class="segmentSeparator"></span>How can this relativistic approach conserve any significant portion of computational resources?<br><span class="segmentSeparator"></span>We usually fetch the entire account from the resource anyway.<br><span class="segmentSeparator"></span>Therefore there is no harm to recompute all the attributes.<br><span class="segmentSeparator"></span>The computation itself is fast, it is the fetch operation that is slow.<br><span class="segmentSeparator"></span>Isn’t it?<br><span class="segmentSeparator"></span>The clever reader is, of course, right.<br><span class="segmentSeparator"></span>Or partially right at the very least.<br><span class="segmentSeparator"></span>Most resources really fetch all the account attributes in a single efficient operation.<br><span class="segmentSeparator"></span>And for those cases there is no big increase in efficiency if we go with the relativistic methods.<br><span class="segmentSeparator"></span>But there are exceptions.<br><span class="segmentSeparator"></span>For example some resources will not return all the values of big attributes, e.g.<br><span class="segmentSeparator"></span>all the members of a large group.<br><span class="segmentSeparator"></span>Additional requests are needed to fetch all the values – and there may be a lot of requests if the group is really large.<br><span class="segmentSeparator"></span>Relativistic approach has significant benefit in those cases.<br><span class="segmentSeparator"></span>And the benefits will be even more obvious when we get to the live synchronization in the next section.<br><span class="segmentSeparator"></span>But performance is not the primary motivation for the relativistic approach.<br><span class="segmentSeparator"></span>There is one extremely strong reason to go relativistic: data consistency.<br><span class="segmentSeparator"></span>Consistency is something that brings ugly nightmares to many engineers that try to design distributed system.<br><span class="segmentSeparator"></span>And identity management solution is in fact a distributed system.<br><span class="segmentSeparator"></span>But it is a very loosely-coupled distributed system.<br><span class="segmentSeparator"></span>There is no support for locking or transactions in the connector.<br><span class="segmentSeparator"></span>And even if there was some support, vast majority of resource cannot provide those consistency mechanisms on their identity management APIs.<br><span class="segmentSeparator"></span>This means that midPoint cannot rely on traditional consistency mechanisms.<br><span class="segmentSeparator"></span>And that is why relativistic approach is so useful.<br><span class="segmentSeparator"></span>Relativistic computation has a very high probability of achieving correct result even without locking or transactions.<br><span class="segmentSeparator"></span>This is more than acceptable for typical identity management deployments.<br><span class="segmentSeparator"></span>And for those rare cases where relativistic computation can fluctuate there is always reconciliation as a last resort.<br><span class="segmentSeparator"></span>But thank to the relativistic nature of midPoint the need for reconciliation is significantly reduced.</p>
</div>
<div class="paragraph">
<p>That was a lot of long words, but clever reader seems to be satisfied now.<br><span class="segmentSeparator"></span>At least for a while.<br><span class="segmentSeparator"></span>But there is quite a simple summary: relativistic approach of midPoint can do miracles.<br><span class="segmentSeparator"></span>For example, midPoint resource can be both sources and targets, even a single attribute can be both source and target of information.<br><span class="segmentSeparator"></span>It is the relativistic approach that allows features like this.<br><span class="segmentSeparator"></span>The principle or relativity is relatively simple.<br><span class="segmentSeparator"></span>But its effect in midPoint is nothing short of being revolutionary.</p>
</div>
</div>
<div class="sect3">
<h4 id="_live_synchronization">Live Synchronization</h4>
<div class="paragraph">
<p>MidPoint has a range of synchronization mechanisms.<br><span class="segmentSeparator"></span>Slow, brutal but reliable reconciliation is at one end.<br><span class="segmentSeparator"></span>Live synchronization is on the other.<br><span class="segmentSeparator"></span>Live synchronization is a lightweight mechanism that can provide almost-real-time synchronization capabilities.<br><span class="segmentSeparator"></span>Live synchronization is specifically looking for recent changes on a resource.<br><span class="segmentSeparator"></span>When such changes are detected, live synchronization mechanisms process those changes immediately.<br><span class="segmentSeparator"></span>The synchronization delay is usually in order of seconds or minutes if live synchronization is used properly.</p>
</div>
<div class="paragraph">
<p>Unlike reconciliation, live synchronization is not triggered manually.<br><span class="segmentSeparator"></span>That would make very little sense.<br><span class="segmentSeparator"></span>Live synchronization works in a long-running task repeatedly looking for fresh changes in short time intervals.<br><span class="segmentSeparator"></span>If a resource is configured for synchronization then all that is needed to run live synchronization is to set up a live synchronization task.<br><span class="segmentSeparator"></span>MidPoint user interface can be used to do that easily.<br><span class="segmentSeparator"></span>And an example of live synchronization task was provided in the HR feed section above.</p>
</div>
<div class="paragraph">
<p>Live synchronization task wakes up at regular intervals.<br><span class="segmentSeparator"></span>Each time the task waves up it invokes the connector.<br><span class="segmentSeparator"></span>Connectors that are capable of live synchronization have special operation that is used to get fresh changes from the resource.<br><span class="segmentSeparator"></span>The connector can support any reasonable change detection mechanism – in theory.<br><span class="segmentSeparator"></span>But two mechanisms are commonly used in practice:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Timestamp-based synchronization:</strong> Resource keeps track of last modification timestamp for each account.<br><span class="segmentSeparator"></span>The connector looks for all accounts that have been modified since last scan.<br><span class="segmentSeparator"></span>This is very simple and relatively efficient method.<br><span class="segmentSeparator"></span>But it has one major limitation: it cannot detect deleted accounts.<br><span class="segmentSeparator"></span>If an account is deleted then there is no timestamp for that account and therefore the connector will not find it in the live synchronization scan.</p>
</li>
<li>
<p><strong>Changelog-based synchronization:</strong> Resource keeps a “log” of recent changes.<br><span class="segmentSeparator"></span>The connector is looking at the log and it is processing all the changes that were added to the log since the last scan.<br><span class="segmentSeparator"></span>This is a very efficient and flexible method.<br><span class="segmentSeparator"></span>But it is not simple.<br><span class="segmentSeparator"></span>And not mamy systems support it.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All live synchronization methods need to keep the track of what changes are "recent", i.e.<br><span class="segmentSeparator"></span>which changes were already processed by midPoint and which were not processed yet.<br><span class="segmentSeparator"></span>There is usually some value that needs to be remembered by midPoint: timestamp of last scan, last sequence number in the change log, serial number of last processed change and so on.<br><span class="segmentSeparator"></span>Each connector has a different value with a connector-specific meaning.<br><span class="segmentSeparator"></span>MidPoint refers to those values as "tokens".<br><span class="segmentSeparator"></span>The most recent token is stored in the live synchronization task.<br><span class="segmentSeparator"></span>That is how midPoint keeps track of processed changes.<br><span class="segmentSeparator"></span>There are (hopeful quite rare) cases when resource and midPoint token get out of alignment.<br><span class="segmentSeparator"></span>This may happen in cases such as the resource database is restored from a backup, if network time gets out of synchronization and so on.<br><span class="segmentSeparator"></span>If that happen then deleting the token from the live synchronization task is usually all it takes to get the synchronization running again.</p>
</div>
<div class="paragraph">
<p>Live synchronization is fast and very efficient.<br><span class="segmentSeparator"></span>But it is not entirely reliable.<br><span class="segmentSeparator"></span>MidPoint may miss some changes.<br><span class="segmentSeparator"></span>This is quite a rare situation, but it may happen.<br><span class="segmentSeparator"></span>Reconciliation will surely remedy the situation in such a case.<br><span class="segmentSeparator"></span>Just remember, all the synchronization mechanism share the same configuration.<br><span class="segmentSeparator"></span>And it is perfectly acceptable to run live synchronization and reconciliation on the same resource at the same time.<br><span class="segmentSeparator"></span>But of course, it would be a good idea to run reconciliation less frequently than live synchronization.</p>
</div>
</div>
<div class="sect3">
<h4 id="_conclusion">Conclusion</h4>
<div class="paragraph">
<p>Synchronization is one of the most important mechanisms in the entire identity management field.<br><span class="segmentSeparator"></span>Primary purpose of synchronization is to get the data into midPoint.<br><span class="segmentSeparator"></span>And that is really good approach when an identity management deployment begins: get your data into midPoint first.<br><span class="segmentSeparator"></span>Get the data from the HR system.<br><span class="segmentSeparator"></span>Correlate that with Active Directory.<br><span class="segmentSeparator"></span>Connect all the major resources to midPoint and correlate the data.<br><span class="segmentSeparator"></span>MidPoint does not need to make any changes at this stage.<br><span class="segmentSeparator"></span>In fact it is perfectly good approach to make all the resource read-only at this stage.<br><span class="segmentSeparator"></span>The point is to let midPoint see the data.<br><span class="segmentSeparator"></span>But why do we need that?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>We will see what is the real quality of the data.<br><span class="segmentSeparator"></span>Most system owners have at least some idea what data sets are there.<br><span class="segmentSeparator"></span>But it is almost impossible to estimate data quality until the data are processed and verified.<br><span class="segmentSeparator"></span>That is exactly what midPoint can do at this stage.<br><span class="segmentSeparator"></span>This is essential information to plan data cleanup and sanitation.</p>
</li>
<li>
<p>We will learn how many accounts and account types are there.<br><span class="segmentSeparator"></span>It is perhaps quite obvious that there are employee accounts.<br><span class="segmentSeparator"></span>But are there accounts for contractors, suppliers, support engineers?<br><span class="segmentSeparator"></span>Are those accounts active?<br><span class="segmentSeparator"></span>What is the naming convention?<br><span class="segmentSeparator"></span>Do system administrators use employee accounts for administration.<br><span class="segmentSeparator"></span>Or are they using dedicated high-privilege accounts?<br><span class="segmentSeparator"></span>This information is crucial to set up provisioning policies.</p>
</li>
<li>
<p>We will learn distribution of accounts and their entitlements.<br><span class="segmentSeparator"></span>Do all employees have accounts in Active Directory?<br><span class="segmentSeparator"></span>Are there any frequently-used groups?<br><span class="segmentSeparator"></span>How does organizational structure influence the accounts?<br><span class="segmentSeparator"></span>This information is very useful to design a role-based access control structures and other policies.</p>
</li>
<li>
<p>We will surely learn some security vulnerabilities.<br><span class="segmentSeparator"></span>Are there orphaned accounts that should have been deleted long time ago?<br><span class="segmentSeparator"></span>Are there testing accounts that were left unattended after the last night-time emergency?<br><span class="segmentSeparator"></span>Indeed, there is no security without identity management.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is a good start.<br><span class="segmentSeparator"></span>But even if this is all that you do in the first step of the deployment it is still a major benefit.<br><span class="segmentSeparator"></span>You will get better visibility and with that comes better security.<br><span class="segmentSeparator"></span>And you have the data to analyze your environment and plan next step of the identity management deployment.<br><span class="segmentSeparator"></span>You won’t be blind any longer.<br><span class="segmentSeparator"></span>And that is really important.<br><span class="segmentSeparator"></span>It is indeed a capital mistake to theorize before one has data.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="06-schema">6.<br><span class="segmentSeparator"></span>Schema</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
If you have built castles in the air, your work need not be lost, that is where they should be.<br><span class="segmentSeparator"></span>Now put the foundations under them.<br><span class="segmentSeparator"></span></blockquote>
<div class="attribution">
— Henry David Thoreau
</div>
</div>
<div class="paragraph">
<p>So far we have been discussing the things that influence how midPoint interacts with the outside.<br><span class="segmentSeparator"></span>Resource definitions, outbound and inbound mappings, even the roles - the primary purpose of those things is to control how data get into midPoint and out of midPoint.<br><span class="segmentSeparator"></span>But now it is time to discuss how midPoint works <em>internally</em>.</p>
</div>
<div class="paragraph">
<p>Early IDM systems were little more than smart data transformers.<br><span class="segmentSeparator"></span>They took data from data sources, modified them in some way, maybe applied a model such as RBAC and then pushed the data out.<br><span class="segmentSeparator"></span>There was very little crucial information that was stored inside the IDM system itself.<br><span class="segmentSeparator"></span>But that was a long time ago and the world is a different place now.<br><span class="segmentSeparator"></span>The focus of IDM field has shifted towards identity governance.<br><span class="segmentSeparator"></span>It is not enough to transform the data.<br><span class="segmentSeparator"></span>Policies need to be applied.<br><span class="segmentSeparator"></span>Compliance needs to be evaluated.<br><span class="segmentSeparator"></span>There are processes to follow, paperwork to do, reports to compile, notifications, reviews and daily status reports.<br><span class="segmentSeparator"></span>It is perhaps no big surprise that there is a good deal of <em>management</em> in Identity Management.</p>
</div>
<div class="paragraph">
<p>Many of the chapters that follow will deal with these management concepts.<br><span class="segmentSeparator"></span>But we have to start from the basics.<br><span class="segmentSeparator"></span>And the goal of this chapter is an explanation of the very foundation of midPoint: schema.<br><span class="segmentSeparator"></span>The goal of midPoint is not just a mere data transformation.<br><span class="segmentSeparator"></span>The goal is to <em>unify</em> the data.<br><span class="segmentSeparator"></span>And midPoint schema plays a crucial part in that ambition.</p>
</div>
<div class="sect2">
<h3 id="_midpoint_schema">MidPoint Schema</h3>
<div class="paragraph">
<p>MidPoint is designed as a schema-aware system.<br><span class="segmentSeparator"></span>For every bit of data that passes through midPoint we have a complete <em>definition</em>.<br><span class="segmentSeparator"></span>We know whether this is string, integer or timestamp.<br><span class="segmentSeparator"></span>We know whether it is single-valued or multi-valued.<br><span class="segmentSeparator"></span>We know whether it is optional or mandatory.<br><span class="segmentSeparator"></span>We know whether this is a sensitive piece of data that requires extra protection.<br><span class="segmentSeparator"></span>We know whether it is part of technical meta-data that we usually do not want to show by default.<br><span class="segmentSeparator"></span>And often we also know what label we should use when we are presenting the data and how that label translates to other languages.<br><span class="segmentSeparator"></span>We know quite a lot about the data that we work with.<br><span class="segmentSeparator"></span>All the objects that midPoint works with are completely defined by the schema.<br><span class="segmentSeparator"></span>There is a schema for user, role, org, resource, system configuration and everything else.</p>
</div>
<div class="paragraph">
<p>Such awareness of the schema brings significant advantages to midPoint.<br><span class="segmentSeparator"></span>The most obvious advantage is in data presentation.<br><span class="segmentSeparator"></span>We know that we need to render a calendar selector because that particular data property is timestamp.<br><span class="segmentSeparator"></span>We know that we need to render a text field with a plus button to add values because that particular property is a multi-valued string.<br><span class="segmentSeparator"></span>And we know that some fields should be disabled because those properties are read-only.<br><span class="segmentSeparator"></span>This behavior is not hard-coded.<br><span class="segmentSeparator"></span>Vast majority of midPoint user interface is rendered by interpreting midPoint schema.</p>
</div>
<div class="paragraph">
<p>This approach is absolutely crucial for any serious IDM system.<br><span class="segmentSeparator"></span>One of the reasons is that the IDM system works with data that are retrieved from other systems (resources).<br><span class="segmentSeparator"></span>It is just not possible to hard-code midPoint user interface for all the various attributes that all the possible resources could have.<br><span class="segmentSeparator"></span>A different strategy is needed here, a strategy that is much more dynamic.</p>
</div>
<div class="paragraph">
<p>When midPoint connects to a new resource for the first time it attempts to retrieve <em>resource schema</em>.<br><span class="segmentSeparator"></span>The schema specifies what object classes the resource supports, which attributes the object classes have, what types are those and so on.<br><span class="segmentSeparator"></span>MidPoint transforms this schema to its own native format and stores that in the resource definition.<br><span class="segmentSeparator"></span>This means that midPoint has the schema available anytime it is needed for dynamic interpretation.<br><span class="segmentSeparator"></span>That schema is used to display resource data in the most natural and user-friendly way.<br><span class="segmentSeparator"></span>It is also used by automatic data type conversions, which makes mapping configuration easier.</p>
</div>
</div>
<div class="sect2">
<h3 id="_data_unification">Data Unification</h3>
<div class="paragraph">
<p>MidPoint schema is not just a nice way how to create user, role or organizational structure.<br><span class="segmentSeparator"></span>It has a much deeper meaning.<br><span class="segmentSeparator"></span>The primary purpose of a schema is integration, data translation and unification.<br><span class="segmentSeparator"></span>A clever reader would certainly remember that we have already talked about <em>star topology</em> or <em>hub-and-spoke</em> integration pattern.<br><span class="segmentSeparator"></span>MidPoint is like a hub of the wheel and all the resources connect to midPoint as spokes.<br><span class="segmentSeparator"></span>MidPoint is actively discouraging direct resource-to-resource communication.<br><span class="segmentSeparator"></span>Everything in midPoint is built for resource-to-midPoint and midPoint-to-resource communication.<br><span class="segmentSeparator"></span>MidPoint is always the center – and for a good reason.<br><span class="segmentSeparator"></span>All resource data need to be translated to and from a midPoint “data language”.<br><span class="segmentSeparator"></span>Thus midPoint creates a common language that everybody can understand.<br><span class="segmentSeparator"></span>And this is exactly the purpose of midPoint schema.<br><span class="segmentSeparator"></span>The schema of user, role, org and service is designed to contain properties that are often used in identity-related integration scenarios.<br><span class="segmentSeparator"></span>Therefore, an engineer who is designing a mapping is quite likely to find a suitable property in midPoint schema that is prepared to be used.</p>
</div>
<div class="paragraph">
<p>MidPoint schema forms a <em>lingua franca</em>, a common language that can be translating to various data dialects used by the resources.<br><span class="segmentSeparator"></span>But it also provides a basic framework that can be reused for many midPoint deployments.<br><span class="segmentSeparator"></span>Therefore, an engineer starting a new deployment does not need to start on a completely green field.<br><span class="segmentSeparator"></span>The basic schema will always be there to provide a starting point.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Ever wondered why midPoint is called midPoint?<br><span class="segmentSeparator"></span>Clever reader would have figured that out already.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_basic_user_schema">Basic User Schema</h3>
<div class="paragraph">
<p>When it comes to identity management field, there is one concept that is at the center of everything: a concept of <em>user</em>.<br><span class="segmentSeparator"></span>MidPoint is no exception.<br><span class="segmentSeparator"></span>User is undoubtedly the most important object in the entire midPoint schema.<br><span class="segmentSeparator"></span>Therefore it is worth to have a closer look at how this object looks like.<br><span class="segmentSeparator"></span>This is going to be a really educative lesson, as it will explain several fundamental principles of midPoint.</p>
</div>
<div class="paragraph">
<p>User is represented by schema datatype identified as <code>UserType</code>.<br><span class="segmentSeparator"></span>Adding the Type suffix to datatypes is a common convention in midPoint.<br><span class="segmentSeparator"></span>There is <code>UserType</code>, <code>RoleType</code>, <code>OrgType</code>, <code>ResourceType</code> and so on.<br><span class="segmentSeparator"></span>This convention is partially historic, partially given by XML Schema conventions, partially a convenience to developers.<br><span class="segmentSeparator"></span>Regardless of the origins, this convention is used for all the data types in midPoint schemas.<br><span class="segmentSeparator"></span>You will get used to it eventually.</p>
</div>
<div class="paragraph">
<p><code>UserType</code> is what we call an <em>object definition</em> in midPoint parlance.<br><span class="segmentSeparator"></span>This means that <code>UserType</code> data structure specifies a complete midPoint object with all the things that any self-respecting object needs.<br><span class="segmentSeparator"></span>There is object identifier (OID), name that can be presented in different forms and languages, free-form description and so on.<br><span class="segmentSeparator"></span>All midPoint objects have those things.</p>
</div>
<div class="paragraph">
<p>The <code>UserType</code> data structure has many additional <em>properties</em>, <em>containers</em> and <em>references</em>.<br><span class="segmentSeparator"></span>Property is a primitive data item such as string, integer or a timestamp.<br><span class="segmentSeparator"></span>Container is a complex data structure that contains a bunch of properties or other containers.<br><span class="segmentSeparator"></span>Reference is a pointer to another midPoint object.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Properties are primitive.<br><span class="segmentSeparator"></span>However, there may be properties that have internal structure, even quite a complex internal structure.<br><span class="segmentSeparator"></span>This is sometimes given by historic reasons.<br><span class="segmentSeparator"></span>But there are also properties that need to be complex, e.g.<br><span class="segmentSeparator"></span>properties that require localizable presentation or properties that provide protection of data.<br><span class="segmentSeparator"></span>Yes, this may be confusing.<br><span class="segmentSeparator"></span>And even a clever reader is officially puzzled now.<br><span class="segmentSeparator"></span>However, this distinction is not a big issue for now.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Definition of <code>UserType</code> is summarized in the following table:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Human-readable, mutable name of the object.<br><span class="segmentSeparator"></span>It is typically a username or some kind of application-level identifier.<br><span class="segmentSeparator"></span>The value must be unique among all the users.<br>
Example: <code>jrandom</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>description</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Free-form textual description of the object.<br><span class="segmentSeparator"></span>This is meant to be displayed in the user interface.<br>
Example: <code>Random account for testing</code>.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>extension</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">container</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A container for custom schema extensions.<br><span class="segmentSeparator"></span>We will discuss that later.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>metadata</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">container</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Meta-data about object creation, modification, etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lifecycleState</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lifecycle state of the object.<br><span class="segmentSeparator"></span>This property defines whether the object represents a draft, proposed definition, whether it is active, deprecated, and so on.<br>
Example: <code>active</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>assignment</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">container</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set of object’s assignments.<br><span class="segmentSeparator"></span>Assignments define the privileges and "features" that this object should have, that this object is entitled to.<br><span class="segmentSeparator"></span>Typical assignment will point to a role or define a construction of an account.<br>
Assignments represent what the object should have.<br><span class="segmentSeparator"></span>The assignments represent a policy, a desired state of things.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>linkRef</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">referrence</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Set of shadows (projections) linked to this focal object.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>a set of accounts linked to a user.<br><span class="segmentSeparator"></span>This is the set of shadows that belongs to the focal object in a sense that these shadows represents the focal object on the resource.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>The set of accounts that represent the same midPoint user (the same physical person, they are "analogous").<br>
Links define what the object has.<br><span class="segmentSeparator"></span>The links reflect real state of things.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>activation</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">container</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type that defines activation properties.<br><span class="segmentSeparator"></span>Determines whether something is active (and working) or inactive (e.g.<br><span class="segmentSeparator"></span>disabled).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>jpegPhoto</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Photo of a user (in a binary form).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>costCenter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name, identifier or code of the cost center to which the user belongs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>locality</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Primary locality of the user, the place where the user usually works, the country, city or building that he belongs to.<br><span class="segmentSeparator"></span>The specific meaning and form of this property is deployment-specific.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>preferredLanguage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Indicates user’s preferred language, usually for the purpose of localizing user interfaces.<br><span class="segmentSeparator"></span>The format is IETF language tag defined in BCP 47, where underscore is used as a subtag separator.<br><span class="segmentSeparator"></span>This is usually a ISO 639-1 two-letter language code optionally followed by ISO 3166-1 two letter country code separated by underscore.<br>
Example: <code>en_US</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>locale</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Defines user’s preference in displaying currency, dates and other items related to location and culture.<br><span class="segmentSeparator"></span>It has the same format as <code>preferredLanguage</code>.<br>
Example: <code>en_US</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>timezone</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User’s preferred timezone.<br><span class="segmentSeparator"></span>It is specified in the "tz database" (a.k.a "Olson") format.<br>
Example: <code>Europe/Bratislava</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>emailAddress</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">E-Mail address of the user, org.<br><span class="segmentSeparator"></span>unit, etc.<br><span class="segmentSeparator"></span>This is the address supposed to be used for communication with the user.<br>
Example: <code>random@example.com</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>telephoneNumber</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Primary telephone number of the user.<br>
Example: <code>+421 123 456 789</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fullName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Full name of the user with all the decorations, middle name initials, honorific title and any other structure that is usual in the cultural environment that the system operates in.<br><span class="segmentSeparator"></span>This element is intended to be displayed to a common user of the system.<br><span class="segmentSeparator"></span>Example: <code>James W.<br><span class="segmentSeparator"></span>Random, PhD.</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>givenName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Given name of the user.<br><span class="segmentSeparator"></span>It is usually the first name of the user, but the order of names may differ in various cultural environments.<br><span class="segmentSeparator"></span>This element will always contain the name that was given to the user at birth or was chosen by the user.<br>
Example: <code>James</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>familyName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Family name of the user.<br><span class="segmentSeparator"></span>It is usually the last name of the user, but the order of names may differ in various cultural environments.<br><span class="segmentSeparator"></span>This element will always contain the name that was inherited from the family or was assigned to a user by some other means.<br><span class="segmentSeparator"></span>Example: <code>Random</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>additionalName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Middle name, patronymic, matronymic or any other name of a person.<br><span class="segmentSeparator"></span>It is usually the middle component of the name, however that may be culture-dependent.<br><span class="segmentSeparator"></span>Example: <code>Walker</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>nickName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Familiar or otherwise informal way to address a person.<br><span class="segmentSeparator"></span>Example: <code>Randy</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>honorificPrefix</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Honorific titles that go before the name.<br><span class="segmentSeparator"></span>Example: <code>Sir</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>honorificSuffix</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Honorific titles that go after the name.<br><span class="segmentSeparator"></span>Example: <code>PhD.</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>title</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User’s title defining a work position or a primary role in the organization.<br><span class="segmentSeparator"></span>Example: <code>CEO</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>employeeNumber</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unique, business-oriented identifier of the employee.<br><span class="segmentSeparator"></span>Typically used as correlation identifier and for auditing purposes.<br><span class="segmentSeparator"></span>Should be immutable, but the specific properties and usage are deployment-specific.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>organization</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name or (preferably) immutable identifier of organization that the user belongs to.<br><span class="segmentSeparator"></span>The format is deployment-specific.<br><span class="segmentSeparator"></span>This property together with organizationalUnit may be used to provide easy-to-use data about organizational membership of the user.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>organizationalUnit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">property</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name or (preferably) immutable identifier of organizational unit that the user belongs to.<br><span class="segmentSeparator"></span>The format is deployment-specific.<br><span class="segmentSeparator"></span>This property together with organization may be used to provide easy-to-use data about organizational membership of the user.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>credentials</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">container</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The set of user’s credentials (such as passwords).</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This is a basic outline of the schema for <code>UserType</code>.<br><span class="segmentSeparator"></span>This description is slightly simplified.<br><span class="segmentSeparator"></span>Not all the items that are defined for <code>UserType</code> are shown in the table above.<br><span class="segmentSeparator"></span>Deprecated items are not shown at all.<br><span class="segmentSeparator"></span>Only some operational properties are shown.<br><span class="segmentSeparator"></span>Some items are simplified or entirely omitted for clarity.</p>
</div>
<div class="paragraph">
<p>Following example illustrates the use of midPoint <code>UserType</code> schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;user&gt;</span>
    <span class="tag">&lt;name&gt;</span>alice<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;activation&gt;</span>
        <span class="tag">&lt;administrativeStatus&gt;</span>enabled<span class="tag">&lt;/administrativeStatus&gt;</span>
    <span class="tag">&lt;/activation&gt;</span>
    <span class="tag">&lt;preferredLanguage&gt;</span>en_US<span class="tag">&lt;/preferredLanguage&gt;</span>
    <span class="tag">&lt;assignment&gt;</span>
        <span class="tag">&lt;targetRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">aaa6cde4-0471-11e9-9b50-c743da469067</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">RoleType</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/assignment&gt;</span>
    <span class="tag">&lt;assignment&gt;</span>
        <span class="tag">&lt;targetRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">4e73ed62-aef9-11e9-a7a8-57334ef1f991</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">RoleType</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/assignment&gt;</span>
    <span class="tag">&lt;emailAddress&gt;</span>alice.anderson@example.com<span class="tag">&lt;/emailAddress&gt;</span>
    <span class="tag">&lt;fullName&gt;</span>Alice Anderson, PhD.<span class="tag">&lt;/fullName&gt;</span>
    <span class="tag">&lt;givenName&gt;</span>Alice<span class="tag">&lt;/givenName&gt;</span>
    <span class="tag">&lt;familyName&gt;</span>Anderson<span class="tag">&lt;/familyName&gt;</span>
    <span class="tag">&lt;honorificSuffix&gt;</span>PhD.<span class="tag">&lt;/honorificSuffix&gt;</span>
    <span class="tag">&lt;title&gt;</span>Business Analyst<span class="tag">&lt;/title&gt;</span>
    <span class="tag">&lt;employeeNumber&gt;</span>001<span class="tag">&lt;/employeeNumber&gt;</span>
    <span class="tag">&lt;organizationalUnit&gt;</span>10010<span class="tag">&lt;/organizationalUnit&gt;</span>
<span class="tag">&lt;/user&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_operational_experimental_and_deprecated_items">Operational, Experimental and Deprecated Items</h3>
<div class="paragraph">
<p>Most of the items in midPoint schema are quite ordinary and they behave as expected.<br><span class="segmentSeparator"></span>Such as the fullName property.<br><span class="segmentSeparator"></span>The property can be set and changed by using midPoint user interface.<br><span class="segmentSeparator"></span>But then there are some extraordinary items.<br><span class="segmentSeparator"></span>Those are automatically determined and controlled by midPoint core.<br><span class="segmentSeparator"></span>Those items are essential for correct operation of midPoint.<br><span class="segmentSeparator"></span>Therefore they are called <em>operational</em> items.<br><span class="segmentSeparator"></span>Operational items are usually not directly displayed in the user interface.<br><span class="segmentSeparator"></span>They are either completely hidden, displayed indirectly or displayed only when user chooses to displays them.</p>
</div>
<div class="paragraph">
<p>MidPoint schema has grown and evolved over time.<br><span class="segmentSeparator"></span>And it is still evolving.<br><span class="segmentSeparator"></span>Therefore, it is quite expected that the schema will slightly change over time.<br><span class="segmentSeparator"></span>However, we do not affect midPoint deployments by incompatible schema changes.<br><span class="segmentSeparator"></span>Therefore items are usually not removed from midPoint schema without a warning.<br><span class="segmentSeparator"></span>An item that we do not want is marked as <em>deprecated</em> first.<br><span class="segmentSeparator"></span>At that point such item is still working as before.<br><span class="segmentSeparator"></span>However, it is not displayed in the user interface to discourage use of that item.<br><span class="segmentSeparator"></span>Deprecated items are removed in one of the subsequent midPoint releases.<br><span class="segmentSeparator"></span>This gives enough time for midPoint users to adapt to schema changes.</p>
</div>
<div class="paragraph">
<p>There is also another kind of schema evolution.<br><span class="segmentSeparator"></span>Development of most midPoint features is quick and straightforward.<br><span class="segmentSeparator"></span>But then there are features that are quite complex or features that involve some degree of exploration do implement.<br><span class="segmentSeparator"></span>Those features cannot be implement in a single midPoint release.<br><span class="segmentSeparator"></span>There are also features that are provided to the midPoint community as a "preview" to gather feedback for further development.<br><span class="segmentSeparator"></span>All such features are marked as <em>experimental</em>.<br><span class="segmentSeparator"></span>Those features are not officially supported, but you are free to use them at your own risk.<br><span class="segmentSeparator"></span>Most new features require extensions of midPoint schema.<br><span class="segmentSeparator"></span>This is also true for those experimental features.<br><span class="segmentSeparator"></span>But when going experimental, there is a fair chance that something will change in the future.<br><span class="segmentSeparator"></span>Therefore, we are explicitly marking parts of the schema as <em>experimental</em>.<br><span class="segmentSeparator"></span>This is a warning that those parts are likely to change.<br><span class="segmentSeparator"></span>We are not promising any kind of compatibility for experimental parts of midPoint schema.<br><span class="segmentSeparator"></span>They may change any time, they may even completely disappear.<br><span class="segmentSeparator"></span>And there will be no deprecation or any other warning.<br><span class="segmentSeparator"></span>Simply speaking: if you are dealing with experimental features, you are completely on your own.<br><span class="segmentSeparator"></span>Do not come crying when those things stop working.<br><span class="segmentSeparator"></span>You have been warned.</p>
</div>
</div>
<div class="sect2">
<h3 id="_activation_2">Activation</h3>
<div class="paragraph">
<p>Time is cruel and everything that we do is in some way temporary.<br><span class="segmentSeparator"></span>Except perhaps for stupidity, which seems to be utterly endless.<br><span class="segmentSeparator"></span>But all other things have a beginning and an end.<br><span class="segmentSeparator"></span>Employees have hiring date, contracts have end dates, users can be disabled, roles may get replaced and so on.<br><span class="segmentSeparator"></span>We use the term activation to encompass all those things that deal with the questions of digital life and death of the objects.</p>
</div>
<div class="paragraph">
<p>The activation in itself is multi-dimensional and quite complex.<br><span class="segmentSeparator"></span>It is composed from several properties that may change in somehow independent and somehow inter-dependent way.<br><span class="segmentSeparator"></span>Following list provides a quick summary of activation properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Activation status</strong> defines administrative state of the object, often manually set by system administrator.</p>
</li>
<li>
<p><strong>Validity</strong> properties specify when the object should be active.<br><span class="segmentSeparator"></span>There is activation date and deactivation date.</p>
</li>
<li>
<p><strong>Effective status</strong> is a computed operational property that show the current effective status of the user.<br><span class="segmentSeparator"></span>It is computed from other activation properties.</p>
</li>
<li>
<p><strong>Lockout status</strong> is used for temporary inactivation of user, e.g.<br><span class="segmentSeparator"></span>in case of numerous failed authentication attempts.</p>
</li>
<li>
<p><strong>Additional operational properties</strong> provide (meta) data about the past changes of administrative status.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The best way to explain how activation work is to describe the meaning and behavior of individual properties.</p>
</div>
<div class="paragraph">
<p><em>Administrative status</em> defines the "administrative state" of the object (user).<br><span class="segmentSeparator"></span>I.e.<br><span class="segmentSeparator"></span>the explicit decision of the administrator.<br><span class="segmentSeparator"></span>If administrative status is set, this property overrides any other constraints in the activation type.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>if this is set to <code>enabled</code> and the user is not yet valid (according to <em>validity</em> below), the user should be considered active.<br><span class="segmentSeparator"></span>If set to <code>disabled</code> the user is considered inactive regardless of other settings.<br><span class="segmentSeparator"></span>Therefore this property does <strong>not</strong> necessarily define an actual state of the object.<br><span class="segmentSeparator"></span>It is a kind of "manual override".<br><span class="segmentSeparator"></span>In fact, the most common setting for this property is to leave it unset and let other properties determine the state.<br><span class="segmentSeparator"></span>If this property is not present then the other constraints in the activation type should be considered (namely validity properties, see below).</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Administrative Status Value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>no value</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No explicit override.<br><span class="segmentSeparator"></span>Other activation properties determine the resulting status.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The entity is active.<br><span class="segmentSeparator"></span>It is enabled and fully operational.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>disabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The entity is inactive.<br><span class="segmentSeparator"></span>It has been disabled by an administrative action.</p>
<p class="tableblock">This indicates <strong>temporary</strong> inactivation and there is an intent to enabled the entity later.<br><span class="segmentSeparator"></span>It is usually used for an employee on parental leave, sabbatical, temporarily disable account for security reasons, etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>archived</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The entity is inactive.<br><span class="segmentSeparator"></span>It has been disabled by an administrative action.</p>
<p class="tableblock">This indicates <strong>permanent</strong> inactivation and there is no intent to enabled the entity later.</p>
<p class="tableblock">This state is used to keep the user record or account around for archival purposes.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>some systems require that the account exists to maintain referential consistency of historical data, audit records, etc.<br><span class="segmentSeparator"></span>It may also be used to "blocks" the user or account identifier to avoid their reuse.<br><span class="segmentSeparator"></span>It is usually used for retired employees and similar cases.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If the administrative status is not present and there are no other constraints in the activation type or if there is no activation type at all, then the object is assumed to be "enabled", i.e.<br><span class="segmentSeparator"></span>that the user is active.</p>
</div>
<div class="paragraph">
<p><em>Validity</em> refers to state when the object is considered legal or otherwise usable.<br><span class="segmentSeparator"></span>In midPoint the validity is currently defined by two dates: the date from which the object is valid (<code>validFrom</code>) and the date to which an object is valid (<code>validTo</code>).<br><span class="segmentSeparator"></span>When talking about users these dates usually represent the date when the contract with the user started (hiring date) and the date when the contract ends.<br><span class="segmentSeparator"></span>The user is considered <em>valid</em> (active) between these two dates.<br><span class="segmentSeparator"></span>The user is considered inactive before the <code>validFrom</code> date or after the <code>validTo</code> date.</p>
</div>
<div class="paragraph">
<p>It is perfectly OK to set just one of the dates or no date at all.<br><span class="segmentSeparator"></span>If any date is not set then it is assumed to extend to infinity.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>if <code>validFrom</code> date is not set the user is considered active from the beginning of the universe to the moment specified by the <code>validTo</code> date.</p>
</div>
<div class="paragraph">
<p>The validity is overridden by the administrative status.<br><span class="segmentSeparator"></span>Therefore, if administrative status is set to any non-empty value then the validity dates are not considered at all.</p>
</div>
<div class="paragraph">
<p>Activation is also influenced by <em>object lifecycle</em>.<br><span class="segmentSeparator"></span>Object lifecycle specifies phases of object’s life, such as <code>draft</code>, <code>proposed</code>, <code>active</code> and <code>deprecated</code>.<br><span class="segmentSeparator"></span>There are some lifecycle states in which the object is considered to be active.<br><span class="segmentSeparator"></span>And there are other states when the object is considered to be inactive.<br><span class="segmentSeparator"></span>The later states are important, because object lifecycle can completely override activation.<br><span class="segmentSeparator"></span>This makes perfect sense.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>when an object is in <code>draft</code> state, it is just being prepared for use.<br><span class="segmentSeparator"></span>Such object may have validity dates or administrative status that would normally activate it.<br><span class="segmentSeparator"></span>But we do not want draft objects to be active yet.<br><span class="segmentSeparator"></span>Such object may need a review and approval to transition to <code>active</code> lifecycle state.<br><span class="segmentSeparator"></span>Only then it will really become active.<br><span class="segmentSeparator"></span>This is just a rough overview of the lifecycle functionality that only scratches the surface.<br><span class="segmentSeparator"></span>We will deal with object lifecycle details later in this book.</p>
</div>
<div class="paragraph">
<p>Activation is quite a complex matter that is spread out in several dimensions.<br><span class="segmentSeparator"></span>Therefore it may not be entirely obvious which objects are active and which are not.<br><span class="segmentSeparator"></span>For that reason midPoint provides an operational property <code>effectiveStatus</code> which shows the computed "effective state" of the object.<br><span class="segmentSeparator"></span>Simply speaking it is a read-only property that tells whether the user should be considered active or inactive.<br><span class="segmentSeparator"></span>The effective status is the result of combining several activation settings (administrative status, validity dates, etc.).</p>
</div>
<div class="paragraph">
<p>The effective status holds the result of a computation, therefore it is an <em>operational</em> property that is recomputed every time the status changes.<br><span class="segmentSeparator"></span>The effective status should not be set directly.<br><span class="segmentSeparator"></span>The effective status can be changed only indirectly by changing other activation properties.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Effective Status Value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>no value</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Not yet computed.<br><span class="segmentSeparator"></span>This should not happen under normal circumstances.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>enabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The entity is active.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>disabled</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The entity is inactive (<strong>temporary</strong> inactivation).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>archived</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The entity is inactive (<strong>permanent</strong> inactivation).</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The effective status is the property that is used by majority of midPoint code when determining whether a particular object is active or inactive.<br><span class="segmentSeparator"></span>This property should always have a value in a normal case.<br><span class="segmentSeparator"></span>If this property is not present then the computation haven’t taken place yet.</p>
</div>
<div class="paragraph">
<p>Similarly to effective status, there is yet another operational property <code>validityStatus</code>.<br><span class="segmentSeparator"></span>This property reflects the state of validity constraints with respect to current time.<br><span class="segmentSeparator"></span>The values are <code>before</code>, <code>in</code> and <code>after</code>, meaning the states before the validity intervals started, inside the validity interval and after the validity interval ended respectively.</p>
</div>
<div class="paragraph">
<p><em>Lockout status</em> defines the state of user or account lock-out.<br><span class="segmentSeparator"></span>Lock-out means that the account was temporarily disabled due to failed login attempts or a similar abuse attempt.<br><span class="segmentSeparator"></span>This mechanism is usually used to avoid brute-force or dictionary password attacks and the lock will usually expire by itself in a matter of minutes.</p>
</div>
<div class="paragraph">
<p>This value is usually set by the resource or by midpoint internal authentication code.<br><span class="segmentSeparator"></span>This value is mostly used to read the lockout status of a user or an account.<br><span class="segmentSeparator"></span>This value is semi-writable.<br><span class="segmentSeparator"></span>If the object is locked then it can be used to set it to the unlocked state.<br><span class="segmentSeparator"></span>But not the other way around.<br><span class="segmentSeparator"></span>It cannot be used to lock the account.<br><span class="segmentSeparator"></span>Locking is always done by the authentication code.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Lockout Status Value</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>no value</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No information (generally means unlocked user or account)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>normal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Unlocked and operational user or account.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>locked</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The user or account has been locked.<br><span class="segmentSeparator"></span>Log-in to the account is temporarily disabled.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Please note that even if user of account are in the <code>normal</code> (unlocked) state they still be disabled by administrative status or validity which will make them efficiently inactive.</p>
</div>
<div class="paragraph">
<p>There is also an informational property <code>lockoutExpirationTimestamp</code> that provides information about the expiration of the lock.<br><span class="segmentSeparator"></span>However, not all resources may be able to provide such information.</p>
</div>
<div class="paragraph">
<p>There are several <em>operational properties</em> in the activation data structure that provide operational data about user activation:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>disableReason</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">URI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">URL that identifies a reason for disable.<br><span class="segmentSeparator"></span>This may be indication that that identity was disabled explicitly, that the disable status was computed or other source of the disabled event.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>disableTimestamp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dateTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timestamp of last modification of the activation status to the disabled state.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>enableTimestamp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dateTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timestamp of last modification of the activation status to the enabled state.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>archiveTimestamp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dateTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timestamp of last modification of the activation status to the archived state.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>validityChangeTimestamp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dateTime</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timestamp of last modification of the effective validity state, i.e.<br><span class="segmentSeparator"></span>last time the validity state was recomputed with result that was different than the previous recomputation.<br><span class="segmentSeparator"></span>It is used to avoid repeated validity change deltas.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Those properties are <em>operational</em>, therefore from the user point of view they are read-only.<br><span class="segmentSeparator"></span>The values are automatically computed by midPoint and stored in the database.</p>
</div>
<div class="paragraph">
<p>Let’s see how that works on some examples.<br><span class="segmentSeparator"></span>The simplest example is perhaps not even worth mentioning.<br><span class="segmentSeparator"></span>A user without any activation data structure is considered to be active (enabled).<br><span class="segmentSeparator"></span>When such user is stored in midPoint repository, midPoint will automatically compute effective status:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;user&gt;</span>
    <span class="tag">&lt;name&gt;</span>alice<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;activation&gt;</span>
        <span class="tag">&lt;effectiveStatus&gt;</span>enabled<span class="tag">&lt;/effectiveStatus&gt;</span>
    <span class="tag">&lt;/activation&gt;</span>
<span class="tag">&lt;/user&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Administrator can disable such user by using administrative status property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;user&gt;</span>
    <span class="tag">&lt;name&gt;</span>alice<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;activation&gt;</span>
        <span class="tag">&lt;administrativeStatus&gt;</span>disabled<span class="tag">&lt;/administrativeStatus&gt;</span>
    <span class="tag">&lt;/activation&gt;</span>
<span class="tag">&lt;/user&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once again, when such user object is stored after the modification, midPoint computes the value of effective status:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;user&gt;</span>
    <span class="tag">&lt;name&gt;</span>alice<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;activation&gt;</span>
        <span class="tag">&lt;administrativeStatus&gt;</span>disabled<span class="tag">&lt;/administrativeStatus&gt;</span>
        <span class="tag">&lt;effectiveStatus&gt;</span>disabled<span class="tag">&lt;/effectiveStatus&gt;</span>
    <span class="tag">&lt;/activation&gt;</span>
<span class="tag">&lt;/user&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The use of administrative status is usually quite harsh.<br><span class="segmentSeparator"></span>MidPoint deployments are often using validity constraints instead.<br><span class="segmentSeparator"></span>For example, an employee that has employment contract for a year would look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;user&gt;</span>
    <span class="tag">&lt;name&gt;</span>bob<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;activation&gt;</span>
        <span class="tag">&lt;validFrom&gt;</span>2019-01-01T00:00:00Z<span class="tag">&lt;/validFrom&gt;</span>
        <span class="tag">&lt;validTo&gt;</span>2019-12-31T23:59:59Z<span class="tag">&lt;/validTo&gt;</span>
        <span class="tag">&lt;validityStatus&gt;</span>in<span class="tag">&lt;/validityStatus&gt;</span>
        <span class="tag">&lt;effectiveStatus&gt;</span>enabled<span class="tag">&lt;/effectiveStatus&gt;</span>
    <span class="tag">&lt;/activation&gt;</span>
<span class="tag">&lt;/user&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Given that this chapter was written in 2019, such user will be active.<br><span class="segmentSeparator"></span>It will automatically switched to inactive state after the last day of 2019.<br><span class="segmentSeparator"></span>However, if there is ever a need to explicitly disable the user, administrative status can still be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;user&gt;</span>
    <span class="tag">&lt;name&gt;</span>bob<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;activation&gt;</span>
        <span class="tag">&lt;administrativeStatus&gt;</span>disabled<span class="tag">&lt;/administrativeStatus&gt;</span>
        <span class="tag">&lt;validFrom&gt;</span>2019-01-01T00:00:00Z<span class="tag">&lt;/validFrom&gt;</span>
        <span class="tag">&lt;validTo&gt;</span>2019-12-31T23:59:59Z<span class="tag">&lt;/validTo&gt;</span>
        <span class="tag">&lt;validityStatus&gt;</span>in<span class="tag">&lt;/validityStatus&gt;</span>
        <span class="tag">&lt;effectiveStatus&gt;</span>disabled<span class="tag">&lt;/effectiveStatus&gt;</span>
    <span class="tag">&lt;/activation&gt;</span>
<span class="tag">&lt;/user&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case the user is still in its validity interval.<br><span class="segmentSeparator"></span>Hence the in value of <code>validityStatus</code>.<br><span class="segmentSeparator"></span>But the administrative status is explicitly set to <code>disabled</code>.<br><span class="segmentSeparator"></span>Therefore the resulting effective status is also <code>disabled</code>.</p>
</div>
<div class="paragraph">
<p>The concept of activation is not limited to users.<br><span class="segmentSeparator"></span>Many midPoint objects have activation.<br><span class="segmentSeparator"></span>Roles can expire, organizational units can be disabled and so on.<br><span class="segmentSeparator"></span>Activation is a concept that has a very broad application in midPoint.<br><span class="segmentSeparator"></span>Even assignments have activation.<br><span class="segmentSeparator"></span>Which is a crucial element in some configuration (e.g.<br><span class="segmentSeparator"></span>multi-affiliation).<br><span class="segmentSeparator"></span>Assignments are often used to model employment contracts, student affiliations, service contracts and similar concepts that have time boundaries.<br><span class="segmentSeparator"></span>This is usually achieved by a clever use of assignment activation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_schema_definition">Schema Definition</h3>
<div class="paragraph">
<p>So far we have talked mostly about the use schema (<code>UserType</code> data type).<br><span class="segmentSeparator"></span>However, the entire midPoint schema is quite complex.<br><span class="segmentSeparator"></span>There are many types of objects and there are thousands of data types overall.<br><span class="segmentSeparator"></span>It would be almost impossible to manage such a big schema directly in midPoint code.<br><span class="segmentSeparator"></span>Therefore the schema is defined in special definition files that are used by midPoint in several ways.<br><span class="segmentSeparator"></span>It is used by the user interface to automatically render form fields.<br><span class="segmentSeparator"></span>It is used by midPoint expression engine to automatically convert data types.<br><span class="segmentSeparator"></span>It is even used by midPoint build process (compilation) to make sure that the schema is properly used in midPoint code.<br><span class="segmentSeparator"></span>MidPoint is completely schema-aware system from top to bottom.</p>
</div>
<div class="paragraph">
<p>Schema obviously plays a crucial role in everything that midPoint does.<br><span class="segmentSeparator"></span>Therefore it may be interesting to have a look at schema definition.<br><span class="segmentSeparator"></span>This can be particularly useful for engineers that are deploying midPoint professionally and that often needs to extend and customize the schema.</p>
</div>
<div class="paragraph">
<p>MidPoint schema is specified in XML Schema Definition (XSD) format.<br><span class="segmentSeparator"></span>MidPoint schema is defined in several parts, but the most important is the "core" schema definition.<br><span class="segmentSeparator"></span>The schema files reside in midPoint source code in schema component in the <code>infra</code> subsystem.<br><span class="segmentSeparator"></span>Therefore schema files can be found in the <code>resources</code> part under the <code>infra/schema</code> subdirectory of midPoint source code.<br><span class="segmentSeparator"></span>Schema files are are also included in midPoint distribution package for convenience.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Why XSD?<br><span class="segmentSeparator"></span>Why did we chose to use the XML Schema Definition format for midPoint schema?<br><span class="segmentSeparator"></span>There are historic reasons and there are pragmatic reasons.<br><span class="segmentSeparator"></span>Back in early 2010s when midPoint was born XML was perhaps the only sensible choice to build a complex system.<br><span class="segmentSeparator"></span>Alternatives such as JSON were young and their schema languages ranged from "very limited" through "useless" to "non-existent".<br><span class="segmentSeparator"></span>Therefore XML and XSD were a natural choice.<br><span class="segmentSeparator"></span>However, quite early in midPoint development we have discovered limitations of XSD and especially limitations of Java libraries that work with XML and XSD.<br><span class="segmentSeparator"></span>We had to extend XSD with custom features.<br><span class="segmentSeparator"></span>But fortunately, XSD allowed that.<br><span class="segmentSeparator"></span>We also had to rewrite parts of the XML/XSD-processing code.<br><span class="segmentSeparator"></span>We have also invented a way how to use XSD to describe generic data structures (a.k.a.<br><span class="segmentSeparator"></span>"Prism objects") that can be represented in XML, JSON and YAML.<br><span class="segmentSeparator"></span>Therefore XSD does not really holds us back that much.<br><span class="segmentSeparator"></span>And despite all the limitations, XSD worked for us quite well during all those years.<br><span class="segmentSeparator"></span>We expect that we will replace XSD with something better in the future.<br><span class="segmentSeparator"></span>The problem is that right now there is nothing that is significantly better.<br><span class="segmentSeparator"></span>And it does not makes any sense for us to switch one buzzword for another only to remain cool.<br><span class="segmentSeparator"></span>Therefore we will stick to XSD as long as it works for us.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Every deployment engineer that takes midPoint deployments seriously should be aware of the schema.<br><span class="segmentSeparator"></span>Hardcore engineer will surely open the XSD files in their favorite text editor in the terminal and analyze the definitions line-by-line.<br><span class="segmentSeparator"></span>Developers could open the XSD files in their IDEs and have a nice organized look at the schema.<br><span class="segmentSeparator"></span>But even an ordinary engineer could benefit from learning the basics of XSD and having a look at a few important data types in midPoint schema.</p>
</div>
<div class="paragraph">
<p>Schema definition is not just about the properties, containers and data types.<br><span class="segmentSeparator"></span>Crucial part of the schema definition is in-line documentation.<br><span class="segmentSeparator"></span>Most of the data types and items are documented by using XSD in-line documentation mechanism.<br><span class="segmentSeparator"></span>Therefore a huge amount of details about midPoint can be learned by exploring the schema.<br><span class="segmentSeparator"></span>We have tried to make that process easier by developing <em>schemadoc</em> mechanism.<br><span class="segmentSeparator"></span>Schemadoc is a process that takes raw midPoint schema and generates HTML documentation out of that.<br><span class="segmentSeparator"></span>This task is part of midPoint build process and generated documentation is a result of midPoint build.<br><span class="segmentSeparator"></span>Schemadoc is also available online.<br><span class="segmentSeparator"></span>Just search for "schemadoc" in midPoint wiki.</p>
</div>
<div class="paragraph">
<p>Schema is not just a description how midPoint works.<br><span class="segmentSeparator"></span>MidPoint schema is part of midPoint itself.<br><span class="segmentSeparator"></span>It is used when midPoint is compiled.<br><span class="segmentSeparator"></span>It is parsed when midPoint starts.<br><span class="segmentSeparator"></span>It is used by midPoint core and user interface.<br><span class="segmentSeparator"></span>MidPoint is complex and even the experts can be sometimes wrong.<br><span class="segmentSeparator"></span>MidPoint documentation is quite extensive, therefore it may be misleading or out of date at places.<br><span class="segmentSeparator"></span>But not the schema.<br><span class="segmentSeparator"></span>Schema is always right.<br><span class="segmentSeparator"></span>Otherwise midPoint won’t work.<br><span class="segmentSeparator"></span>Schema is the law.</p>
</div>
</div>
<div class="sect2">
<h3 id="_schema_extensibility">Schema Extensibility</h3>
<div class="paragraph">
<p>MidPoint schema is quite rich.<br><span class="segmentSeparator"></span>Many of the properties that are frequently used in IDM deployments are already part of midPoint schema.<br><span class="segmentSeparator"></span>But reality has always a way to bring unexpected things.<br><span class="segmentSeparator"></span>Therefore, midPoint deployments won’t get far if midPoint schema cannot be extended.</p>
</div>
<div class="paragraph">
<p>Vast majority of midPoint schema is available at <em>compile-time</em>.<br><span class="segmentSeparator"></span>This means that such schema is used during compilation (build) of midPoint.<br><span class="segmentSeparator"></span>That "static" part of schema is somehow hardcoded into midPoint itself and it would very difficult to change.<br><span class="segmentSeparator"></span>Therefore we have developed a mechanism to extend the schema at <em>deployment-time</em>.<br><span class="segmentSeparator"></span>Small parts of the XSD definition can be provided when midPoint is deployed.<br><span class="segmentSeparator"></span>MidPoint will read those definitions when it starts up.<br><span class="segmentSeparator"></span>The static part of the schema is extended with those definitions.<br><span class="segmentSeparator"></span>From that point on the extensions are part of midPoint schema.<br><span class="segmentSeparator"></span>The extensions will be used by midPoint user interface, expression-processing code and all other parts of midPoint.</p>
</div>
<div class="paragraph">
<p>Our ExAmPLE company was quite happy with the progress of IDM deployment so far.<br><span class="segmentSeparator"></span>Mappings were used to synchronize values of user names and all other common attributes.<br><span class="segmentSeparator"></span>There is plenty of suitable properties for that in midPoint schema such as <code>givenName</code> and <code>fullName</code>.<br><span class="segmentSeparator"></span>Even <code>employeeNumber</code> came very handy.<br><span class="segmentSeparator"></span>But now they need to customize midPoint schema to better suit their very specific needs.<br><span class="segmentSeparator"></span>The company management decided that the people look really cool in fancy hats.<br><span class="segmentSeparator"></span>Therefore they will provide a hat for every employee.<br><span class="segmentSeparator"></span>Which means that the IDM system needs to track hat size for all users.<br><span class="segmentSeparator"></span>Hat size is not used in the IDM deployments very often, therefore it is not a part of standard midPoint schema.<br><span class="segmentSeparator"></span>But fortunately, it is easy to extend the schema.</p>
</div>
<div class="paragraph">
<p>First step to extend midPoint schema is to prepare a small XSD file:</p>
</div>
<div class="listingblock">
<div class="title">example.xsd</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;xsd:schema</span> <span class="attribute-name">targetNamespace</span>=<span class="string"><span class="delimiter">"</span><span class="content">http://example.com/xml/ns/midpoint/schema</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;xsd:complexType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">UserTypeExtensionType</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;xsd:annotation&gt;</span>
            <span class="tag">&lt;xsd:appinfo&gt;</span>
                <span class="tag">&lt;a:extension</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">"</span><span class="content">c:UserType</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/xsd:appinfo&gt;</span>
        <span class="tag">&lt;/xsd:annotation&gt;</span>
        <span class="tag">&lt;xsd:sequence&gt;</span>
            <span class="tag">&lt;xsd:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">hatSize</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">xsd:string</span><span class="delimiter">"</span></span>
                         <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">"</span><span class="content">0</span><span class="delimiter">"</span></span> <span class="attribute-name">maxOccurs</span>=<span class="string"><span class="delimiter">"</span><span class="content">1</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/xsd:sequence&gt;</span>
    <span class="tag">&lt;/xsd:complexType&gt;</span>
<span class="tag">&lt;/xsd:schema&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This file defines a new data structure <code>UserTypeExtensionType</code>.<br><span class="segmentSeparator"></span>The name of this data structure does not really matter.<br><span class="segmentSeparator"></span>What matters is that it is bound to an extension of <code>UserType</code> in the annotation part of the type definition.<br><span class="segmentSeparator"></span>When midPoint reads this file, it will extend the definition of <code>UserType</code> with this data type.</p>
</div>
<div class="paragraph">
<p>The extension data type specifies just a single property: <code>hatSize</code>.<br><span class="segmentSeparator"></span>This is an optional single-valued string property.<br><span class="segmentSeparator"></span>Every user in midPoint will have this property.<br><span class="segmentSeparator"></span>User interface will automatically display text input field for this property.</p>
</div>
<div class="paragraph">
<p>MidPoint administrator puts this XSD content into <code>example.xsd</code> file.<br><span class="segmentSeparator"></span>Name of the file can be chosen arbitrarily as long as it has <code>.xsd</code> file extension.<br><span class="segmentSeparator"></span>Administrator copies that file to <code>schema</code> subdirectory of midPoint home directory and restarts midPoint.<br><span class="segmentSeparator"></span>From that point on the schema extension is active.</p>
</div>
<div class="paragraph">
<p>The users can now be extended with custom property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;user</span> <span class="attribute-name">xmlns:exmpl</span>=<span class="string"><span class="delimiter">"</span><span class="content">http://example.com/xml/ns/midpoint/schema</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>alice<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;extension&gt;</span>
        <span class="tag">&lt;exmpl:hatSize&gt;</span>M<span class="tag">&lt;/exmpl:hatSize&gt;</span>
    <span class="tag">&lt;/extension&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/user&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>There is a couple of important remarks to be made here.<br><span class="segmentSeparator"></span>Firstly, all the extension properties are always placed in a special <code>extension</code> container in the objects.<br><span class="segmentSeparator"></span>Even though the properties are placed inside a container, the user interface will present them in the same way as the static (native) midPoint properties.</p>
</div>
<div class="paragraph">
<p>Secondly, a clever reader surely noticed that we have used XML namespace here.<br><span class="segmentSeparator"></span>We have omitted XML namespaces from majority of other examples as they are not that important when working with midPoint objects.<br><span class="segmentSeparator"></span>But schema is different.<br><span class="segmentSeparator"></span>Namespaces are handled quite a strict way when working with the schema.<br><span class="segmentSeparator"></span>Namespaces must be declared and namespace prefixes must be properly used in all XSD definitions.<br><span class="segmentSeparator"></span>The most important namespace in this case is the <em>target namespace</em> of the extended schema.<br><span class="segmentSeparator"></span>The URI for this namespace should be chosen in such a way that it is globally unique.<br><span class="segmentSeparator"></span>The use of your DNS domain is the recommended technique.</p>
</div>
<div class="paragraph">
<p>Namespaces also <em>should</em> be used when working with <code>extension</code> container in users and other midPoint objects.<br><span class="segmentSeparator"></span>This requirement is not that strict as midPoint can usually figure out the namespace.<br><span class="segmentSeparator"></span>However, this may be a problem in case that several schema extensions are combined.<br><span class="segmentSeparator"></span>Such combinations are possible in midPoint.<br><span class="segmentSeparator"></span>MidPoint will simply parse all the XSD files in the schema directory and apply all of them as extensions.<br><span class="segmentSeparator"></span>The namespace is used to differentiate between them.<br><span class="segmentSeparator"></span>Therefore, if there is an expectations that several schema extensions will be used in the same deployment then the use of namespaces in object extension is more than recommended.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Why is there an <code>extension</code> container?<br><span class="segmentSeparator"></span>Why are not the properties simply mixed among other static properties?<br><span class="segmentSeparator"></span>This is related to the intricacies of XML and XML schema.<br><span class="segmentSeparator"></span>Theoretically, XML is completely extensible.<br><span class="segmentSeparator"></span>However, when XML Schema is applied to XML, some extensibility scenarios do not work very well.<br><span class="segmentSeparator"></span>And that is also the case for mixing of static XML elements and dynamic XML elements.<br><span class="segmentSeparator"></span>We are hitting what is called “Unique Particle Resolution” limitation of XML schema.<br><span class="segmentSeparator"></span>This was further amplified by limitations of Java XML libraries.<br><span class="segmentSeparator"></span>The easiest and perhaps even most correct way to resolve this limitation was to create a dedicated XML element for schema extensions.<br><span class="segmentSeparator"></span>That is what we have done in early midPoint versions.<br><span class="segmentSeparator"></span>The schema processing code in midPoint has significantly improved since and now we are almost at the point where we could remove the <code>extension</code> element.<br><span class="segmentSeparator"></span>But we are not yet there.<br><span class="segmentSeparator"></span>And there is still an aspect of compatibility to consider.<br><span class="segmentSeparator"></span>Therefore the <code>extension</code> element stays for now.<br><span class="segmentSeparator"></span>But we are trying hard to hide its existence from the end user.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>MidPoint schema does not just specify the "core" data model.<br><span class="segmentSeparator"></span>MidPoint schema goes a bit further and it can also specify the details of data <em>presentation</em>.<br><span class="segmentSeparator"></span>This means that the schema can specify a label that should be used for particular data item, help text and so on.<br><span class="segmentSeparator"></span>The XML Schema (XSD) cannot do this.<br><span class="segmentSeparator"></span>But fortunately, XSD schema can be extended by <em>annotations</em>.<br><span class="segmentSeparator"></span>Those annotations can be used to define the presentation properties of the items:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;xsd:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">hatSize</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">xsd:string</span><span class="delimiter">"</span></span>
                 <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">"</span><span class="content">0</span><span class="delimiter">"</span></span> <span class="attribute-name">maxOccurs</span>=<span class="string"><span class="delimiter">"</span><span class="content">1</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;xsd:annotation&gt;</span>
            <span class="tag">&lt;xsd:appinfo&gt;</span>
                <span class="tag">&lt;a:displayName&gt;</span>Hat size<span class="tag">&lt;/a:displayName&gt;</span>
                <span class="tag">&lt;a:help&gt;</span>
                    Your hat size in whatever mysterious units the hatters
                    are using for measuring hats.<br><span class="segmentSeparator"></span>                <span class="tag">&lt;/a:help&gt;</span>
            <span class="tag">&lt;/xsd:appinfo&gt;</span>
        <span class="tag">&lt;/xsd:annotation&gt;</span>
    <span class="tag">&lt;/xsd:element&gt;</span>
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This works fine if your system works for just a single localization environment.<br><span class="segmentSeparator"></span>But this is not enough in case that you need more than one language.<br><span class="segmentSeparator"></span>MidPoint was born in Europe and we know quite well all the pain that comes with multi-language environments.<br><span class="segmentSeparator"></span>MidPoint is designed to be localizable.<br><span class="segmentSeparator"></span>Therefore you can simply use localization keys instead of actual text:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;xsd:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">hatSize</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">xsd:string</span><span class="delimiter">"</span></span>
                 <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">"</span><span class="content">0</span><span class="delimiter">"</span></span> <span class="attribute-name">maxOccurs</span>=<span class="string"><span class="delimiter">"</span><span class="content">1</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;xsd:annotation&gt;</span>
            <span class="tag">&lt;xsd:appinfo&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;a:displayName&gt;</span>UserTypeExtensionType.hatSize.displayName<span class="tag">&lt;/a:displayName&gt;</span>
                <span class="tag">&lt;a:help&gt;</span>UserTypeExtensionType.hatSize.help<span class="tag">&lt;/a:help&gt;</span>
            <span class="tag">&lt;/xsd:appinfo&gt;</span>
        <span class="tag">&lt;/xsd:annotation&gt;</span>
    <span class="tag">&lt;/xsd:element&gt;</span>
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The actual text to be used for label an help text is looked up in the localization catalog.<br><span class="segmentSeparator"></span>However, using localization catalogs is a matter of its own.<br><span class="segmentSeparator"></span>It will be covered by later chapters.</p>
</div>
</div>
<div class="sect2">
<h3 id="_polystring_and_protected_string">PolyString and Protected String</h3>
<div class="paragraph">
<p>Majority of midPoint schema is pretty standard stuff.<br><span class="segmentSeparator"></span>When you walk through the jungle of midPoint schema definition you can see all the usual wildlife: strings, integers, booleans, timestamps and binary values.<br><span class="segmentSeparator"></span>But there are few species that are quite strange.<br><span class="segmentSeparator"></span>However strange they might look, they are immensely useful.<br><span class="segmentSeparator"></span>Their names are <em>PolyString</em> and <em>Protected String</em>.</p>
</div>
<div class="paragraph">
<p><em>PolyString</em> is the stranger one of those two.<br><span class="segmentSeparator"></span>Its name came from <em>polymorphic string</em>, which means a string that can take a variety of forms.<br><span class="segmentSeparator"></span>In its simplest form PolyString is just a simple string that can be <em>normalized</em>.<br><span class="segmentSeparator"></span>Normalization means that we convert the original string into some standard form, e.g.<br><span class="segmentSeparator"></span>we are removing leading and trailing whitespace (trimming), we are converting all letters to lower case, simplifying national characters and so on.</p>
</div>
<div class="paragraph">
<p>Many ordinary midPoint properties are PolyStrings.<br><span class="segmentSeparator"></span>Object <code>name</code> and user’s <code>givenName</code>, <code>familyName</code> and <code>fullName</code> and all PolyStrings.<br><span class="segmentSeparator"></span>And yet not even a clever reader haven’t noticed anything suspicious about them so far.<br><span class="segmentSeparator"></span>The reason for this is that normalization is almost transparent in midPoint PolyStrings.<br><span class="segmentSeparator"></span>But now it is a time to have a peek inside.<br><span class="segmentSeparator"></span>Let’s import a user that looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;user&gt;</span>
    <span class="tag">&lt;name&gt;</span>semančík<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;fullName&gt;</span>Radovan Semančík,  PhD.<br><span class="segmentSeparator"></span><span class="tag">&lt;/fullName&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/user&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>What is really stored in midPoint repository is this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;user&gt;</span>
    <span class="tag">&lt;name&gt;</span>
        <span class="tag">&lt;orig&gt;</span>semančík<span class="tag">&lt;/orig&gt;</span>
        <span class="tag">&lt;norm&gt;</span>semancik<span class="tag">&lt;/norm&gt;</span>
    <span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;fullName&gt;</span>
        <span class="tag">&lt;orig&gt;</span>Radovan Semančík,  PhD.<br><span class="segmentSeparator"></span><span class="tag">&lt;/orig&gt;</span>
        <span class="tag">&lt;norm&gt;</span>radovan semancik phd<span class="tag">&lt;/norm&gt;</span>
    <span class="tag">&lt;/fullName&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/user&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This all happens in a transparent way.<br><span class="segmentSeparator"></span>PolyStrings are displayed as strings in the user interface.<br><span class="segmentSeparator"></span>They are handled (almost completely) as strings in the mappings.<br><span class="segmentSeparator"></span>Ordinary midPoint user has no idea that the normalization happens at all.<br><span class="segmentSeparator"></span>But why we bother to normalize strings at all?<br><span class="segmentSeparator"></span>PolyString normalization has many practical uses.<br><span class="segmentSeparator"></span>However, two of them are embedded quite deep in the way how midPoint works.</p>
</div>
<div class="paragraph">
<p>Firstly, normalization is used to provide reliable uniqueness mechanism.<br><span class="segmentSeparator"></span>Usually we do not want a user with username <code>semancik</code> and another user with username <code>Semancik</code> or even <code>Semančík</code>.<br><span class="segmentSeparator"></span>This may lead to confusion.<br><span class="segmentSeparator"></span>As midPoint has uniqueness constraints on both the <code>orig</code> and <code>norm</code> parts of the name then such situation is completely avoided.<br><span class="segmentSeparator"></span>All those usernames have the same normalized form, therefore the uniqueness constraint on <code>norm</code> part of the name will prohibit the use of all those forms at the same time.</p>
</div>
<div class="paragraph">
<p>Secondly, normalization is simple and elegant way how to conveniently search for objects.<br><span class="segmentSeparator"></span>When PolyStrings are searched, the value from the query is normalized.<br><span class="segmentSeparator"></span>Then the norm part of the PolyString is searched.<br><span class="segmentSeparator"></span>Therefore, whether the query contains <code>semancik</code>, <code>Semancik</code> or <code>semančík</code>, it will always find the user entry above.</p>
</div>
<div class="paragraph">
<p>Default normalization algorithm in midPoint should be a good fit for most environments.<br><span class="segmentSeparator"></span>But there are always deployments that are different.<br><span class="segmentSeparator"></span>For example, characters such as hyphens (<code>-</code>) are usually not considered to be significant.<br><span class="segmentSeparator"></span>But some deployments will consider <code>aliceanderson</code> and <code>alice-anderson</code> to be two different usernames.<br><span class="segmentSeparator"></span>The default midPoint normalization mechanism will remove hyphens, therefore attempt to have two such users will end up with an error.<br><span class="segmentSeparator"></span>But fortunately the normalization algorithm is customizable.<br><span class="segmentSeparator"></span>There are several algorithms to choose from and they can even be parameterized.<br><span class="segmentSeparator"></span>In the extreme case there is a way to develop a completely custom algorithm.<br><span class="segmentSeparator"></span>Therefore the PolyString normalization should fit pretty much every deployment scenario.</p>
</div>
<div class="paragraph">
<p>But PolyString still has more tricks to do.<br><span class="segmentSeparator"></span>The normalization is not much of a polymorphism yet.<br><span class="segmentSeparator"></span>PolyString becomes a real shape-shifter in fully localized environments.<br><span class="segmentSeparator"></span>PolyString is designed to store values that can have individualized representations in national environments.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>in multi-national deployments we may want to provide localized role names.<br><span class="segmentSeparator"></span>Like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role&gt;</span>
    <span class="tag">&lt;name&gt;</span>
        <span class="tag">&lt;orig&gt;</span>System administrator<span class="tag">&lt;/orig&gt;</span>
        <span class="tag">&lt;lang&gt;</span>
            <span class="tag">&lt;en&gt;</span>System administrator<span class="tag">&lt;/en&gt;</span>
            <span class="tag">&lt;sk&gt;</span>Systémový správca<span class="tag">&lt;/sk&gt;</span>
            <span class="tag">&lt;cz&gt;</span>Správce systémú<span class="tag">&lt;/cz&gt;</span>
        <span class="tag">&lt;/lang&gt;</span>
    <span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/role&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a mechanism to display midPoint to end users in their own language, complete with localized <em>content</em> of midPoint.<br><span class="segmentSeparator"></span>This functionality is only partially implemented in midPoint 4.0 and it is considered to be experimental (i.e.<br><span class="segmentSeparator"></span>unsupported).<br><span class="segmentSeparator"></span>But this is a glimpse of how the future of midPoint schema may look like.</p>
</div>
<div class="paragraph">
<p>The other strange animal in the midPoint jungle is <em>protected string</em> (<code>ProtectedStringType</code>).<br><span class="segmentSeparator"></span>Identity management systems often work with sensitive data such as user passwords.<br><span class="segmentSeparator"></span>All the identity-related data usually need protection, but those sensitive data items need even better safeguards.<br><span class="segmentSeparator"></span>This usually means that some kind of cryptographic technique needs to be employed.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>we do not want to store passwords in the cleartext form.<br><span class="segmentSeparator"></span>Want them to be either hashed or encrypted.<br><span class="segmentSeparator"></span>And that is what protected string is for.<br><span class="segmentSeparator"></span>Protected string is basically just a simple string, but it has extra cryptographic protection.</p>
</div>
<div class="paragraph">
<p>If you have ever had something to deal with cryptography you will probably know that cryptography is not simple.<br><span class="segmentSeparator"></span>Even such a seemingly simple thing as password hash is quite complex when it comes to all the details.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>we do not want simple hash as that would not provide sufficient protection.<br><span class="segmentSeparator"></span>We want <em>salted</em> hash.<br><span class="segmentSeparator"></span>Which means that the salt value needs to be stored together with the string.<br><span class="segmentSeparator"></span>Many algorithms are parametric and the parameters used during the hashing also need to be stored.<br><span class="segmentSeparator"></span>And most importantly, we do not want to hard-wire midPoint to any specific algorithm.<br><span class="segmentSeparator"></span>Cryptographic algorithms often do not age well and they need to be replaced.<br><span class="segmentSeparator"></span>Therefore we also need to store algorithm identifiers with the value.<br><span class="segmentSeparator"></span>If the value is encrypted, we also need to store key identifier, as several keys may be active at the same time.<br><span class="segmentSeparator"></span>And so on.<br><span class="segmentSeparator"></span>The cryptographic devil is in the tiny and often counter-intuitive details.</p>
</div>
<div class="paragraph">
<p>Protected string is a data structure that is designed to handle all those pesky cryptographic details and still pretend that the content of the data structure is just a string.<br><span class="segmentSeparator"></span>Similarly to PolyString, the basic usage is quite simple.<br><span class="segmentSeparator"></span>Data can be imported into midPoint by using <code>clearValue</code> element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;user&gt;</span>
    <span class="tag">&lt;name&gt;</span>alice<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;credentials&gt;</span>
        <span class="tag">&lt;password&gt;</span>
            <span class="tag">&lt;value&gt;</span>
                  <span class="tag">&lt;clearValue&gt;</span>sup3rSECRET<span class="tag">&lt;/clearValue&gt;</span>
            <span class="tag">&lt;/value&gt;</span>
        <span class="tag">&lt;/password&gt;</span>
    <span class="tag">&lt;/credentials&gt;</span>
<span class="tag">&lt;/user&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The data are automatically protected when the object is imported into midPoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;user&gt;</span>
    <span class="tag">&lt;name&gt;</span>alice<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;credentials&gt;</span>
        <span class="tag">&lt;password&gt;</span>
            <span class="tag">&lt;value&gt;</span>
                <span class="tag">&lt;t:encryptedData&gt;</span>
                    <span class="tag">&lt;t:encryptionMethod&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;t:algorithm&gt;</span>http://www.w3.org/2001/04/xmlenc#aes128-cbc<span class="tag">&lt;/t:algorithm&gt;</span>
                    <span class="tag">&lt;/t:encryptionMethod&gt;</span>
                    <span class="tag">&lt;t:keyInfo&gt;</span>
                        <span class="tag">&lt;t:keyName&gt;</span>1z0N17tv6hNQh5CAJ+jWHWDXeBM=<span class="tag">&lt;/t:keyName&gt;</span>
                    <span class="tag">&lt;/t:keyInfo&gt;</span>
                    <span class="tag">&lt;t:cipherData&gt;</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="tag">&lt;t:cipherValue&gt;</span>g6Neg3ZEXY/ga00SpEa9w5MlJ9/IR+M1vEjdceni6bM=<span class="tag">&lt;/t:cipherValue&gt;</span>
                    <span class="tag">&lt;/t:cipherData&gt;</span>
                <span class="tag">&lt;/t:encryptedData&gt;</span>
            <span class="tag">&lt;/value&gt;</span>
        <span class="tag">&lt;/password&gt;</span>
    <span class="tag">&lt;/credentials&gt;</span>
<span class="tag">&lt;/user&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Protected string data type supports cleartext representation, encryption using a symmetric algorithm and hashing.<br><span class="segmentSeparator"></span>However, the data type itself is just a mechanism for storing the data.<br><span class="segmentSeparator"></span>Whether specific protected string in the schema gets encrypted or hashed and at which point that happens is not controlled by the protected string itself.<br><span class="segmentSeparator"></span>It is controlled by midPoint configuration and policies.<br><span class="segmentSeparator"></span>For example, whether user password is encrypted or hashed is determined by midPoint security policy.</p>
</div>
</div>
<div class="sect2">
<h3 id="_advanced_schema_concepts">Advanced Schema Concepts</h3>
<div class="paragraph">
<p>This section describes schema concepts that goes deeper into midPoint mechanisms and implementation.<br><span class="segmentSeparator"></span>Awareness of those concepts will provide insight into how midPoint works.<br><span class="segmentSeparator"></span>However, we have already talked about the schema quite a lot.<br><span class="segmentSeparator"></span>And this chapter was quite low on practical examples.<br><span class="segmentSeparator"></span>Feel free to skip the rest of this chapter if you want to get your hands dirty as soon as possible.<br><span class="segmentSeparator"></span>But please make sure to come back later.<br><span class="segmentSeparator"></span>You will have to learn those schema concepts eventually to get the best of midPoint functionality.</p>
</div>
</div>
<div class="sect2">
<h3 id="_type_hierarchy">Type Hierarchy</h3>
<div class="paragraph">
<p>So far we have presented midPoint schema as a simple set of data types.<br><span class="segmentSeparator"></span>There is <code>UserType</code> for users, <code>RoleType</code> for roles and so on.<br><span class="segmentSeparator"></span>However, all the midPoint objects have something in common.<br><span class="segmentSeparator"></span>For example, all of them have object identifier (OID), name, description and so on.<br><span class="segmentSeparator"></span>We could simply copy definitions of those properties to all the data types.<br><span class="segmentSeparator"></span>But that is not the best way how to do data modeling.<br><span class="segmentSeparator"></span>The proper way is to create a type hierarchy.<br><span class="segmentSeparator"></span>Therefore, there is an <code>ObjectType</code> data type that specifies all the items that all the object types share.<br><span class="segmentSeparator"></span>However, midPoint schema is substantial and one common ancestor won’t be enough.<br><span class="segmentSeparator"></span>MidPoint type hierarchy was evolving during midPoint development and now it forms quite a rich structure.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/6-1-type-hierarchy.png" alt="Type hierarchy">
</div>
</div>
<div class="paragraph">
<p>Following table is summarizing midPoint data types and their purpose.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Data type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ObjectType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Common (abstract) data type for all midPoint objects.<br><span class="segmentSeparator"></span>Specifies basic items that all midPoint objects have: name, description, metadata and so on.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AssignmentHolderType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Abstract supertype for all object types that can have assignments.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FocusType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Abstract supertype for all object types that can be focus of full midPoint computation.<br><span class="segmentSeparator"></span>This basically means objects that have projections.<br><span class="segmentSeparator"></span>But focal objects also have activation, they may have personas, etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UserType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User object represents a physical user of the system.<br><span class="segmentSeparator"></span>Properties of User object typically describe the user as a physical person.<br><span class="segmentSeparator"></span>Therefore, the user object defines handful of properties that are commonly used to describe users in the IDM solutions (employees, customers, partners, etc.)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AbstractRoleType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Abstract data type that contains the "essence" of a role.<br><span class="segmentSeparator"></span>Roles and other objects that behave like roles are derived from this data type.<br><span class="segmentSeparator"></span>All abstract roles may "grant" accounts on resources, attributes and entitlements for such accounts.<br><span class="segmentSeparator"></span>The role can also imply (induce) organizational units, other roles or various IDM objects that can be assigned directly to user.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>RoleType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A role in the Role-Based Access Control (RBAC) sense.<br><span class="segmentSeparator"></span>The roles specify privileges that the user (or other object) should have.</p>
<p class="tableblock">Roles are intended to give privileges to users and other objects.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OrgType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Organizational unit, division, section, object group, team, project or any other form of organizing things and/or people.<br><span class="segmentSeparator"></span>The OrgType objects are designed to form a hierarchical organizational structure (or rather several parallel organizational structures).</p>
<p class="tableblock">Orgs are intended to group objects.<br><span class="segmentSeparator"></span>But as orgs are abstract roles, they can also behave as roles.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ServiceType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This object type represents any kind of abstract or concrete services or devices such as servers, virtual machines, printers, mobile devices, network nodes, application servers, applications or anything similar.<br><span class="segmentSeparator"></span>The "service" is a very abstract concept.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ArchetypeType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Archetype definition.<br><span class="segmentSeparator"></span>Archetype defines custom object (sub)type.<br><span class="segmentSeparator"></span>I.e.<br><span class="segmentSeparator"></span>it defines specific behavior, look and feel of objects of a particular type, such as "employee", "project", "application", "business role" and so on.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ResourceType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Resource represents a system or component external to midPoint system which is managed by midPoint.<br><span class="segmentSeparator"></span>It is sometimes called IT resource, target system, source system, provisioning target or by variety of ther names.<br><span class="segmentSeparator"></span>MidPoint connects to the resource to create accounts, assign accounts to groups, etc.<br><span class="segmentSeparator"></span>But it also may be an authoritative source of data, database that contains organizational structure and so on.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ConnectorType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description of a generic connector.<br><span class="segmentSeparator"></span>Connector in midPoint is any method of connection to the resource.<br><span class="segmentSeparator"></span>This usually describes a ConnId connector.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ConnectorHostType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Host definition for remote connector, remote connector framework or a remote "gateway".<br><span class="segmentSeparator"></span>This usually specifies the detail of a ConnId remote connector server.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SystemConfigurationType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">System configuration object.<br><span class="segmentSeparator"></span>Holds global system configuration setting.<br><span class="segmentSeparator"></span>There is just one object of this type in the system.<br><span class="segmentSeparator"></span>It has a fixed OID.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TaskType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Object that contains information about a task.<br><span class="segmentSeparator"></span>This can represent active running task.<br><span class="segmentSeparator"></span>It may be a scheduled task waiting for execution.<br><span class="segmentSeparator"></span>Or the object may contain a results of a finished task.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ObjectTemplateType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An object that contains mappings and other configuration intended to apply to other object types.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>it may be used as “user template” to set up basic properties of new user objects.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LookupTableType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">An object that represents lookup table.<br><span class="segmentSeparator"></span>The lookup table can be used for two purposes: value enumerations (e.g.<br><span class="segmentSeparator"></span>for GUI or validation) and value mapping (translation).<br><span class="segmentSeparator"></span>Simply speaking it is a set of key-value pairs that can be efficiently stored and used in midPoint user interface, mappings and so on.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SecurityPolicyType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">System that contains definitions of overall security policy.<br><span class="segmentSeparator"></span>It contains configuration of authentication mechanisms, credentials management (such as password resets) and so on.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ValuePolicyType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Policy for values of properties.<br><span class="segmentSeparator"></span>This is almost always used to store password policies.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FunctionLibraryType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Object that contains a set of reusable functions.<br><span class="segmentSeparator"></span>Those functions can be used in mappings and expressions in all parts of midPoint.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ObjectCollectionType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Object that specifies a collection of other objects.<br><span class="segmentSeparator"></span>It is mostly just a named search filter that can be reused in other parts of midPoint.<br><span class="segmentSeparator"></span>But there are also some advanced functions that can be used in dashboards, for compliance purposes and so on.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ReportType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specification of midPoint report.<br><span class="segmentSeparator"></span>This specification defines what the report should contain, how it should look like, output format and so on.</p>
<p class="tableblock">This is a report definition.<br><span class="segmentSeparator"></span>It is a report “template” that can be executed and it produces data.<br><span class="segmentSeparator"></span>The output data are referred to by report output objects.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ReportOutputType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Object that refers to specific output of the report.<br><span class="segmentSeparator"></span>It also contains metadata, e.g.<br><span class="segmentSeparator"></span>when the report was created, what definition was used, etc.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SequenceType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definition of a sequence object that produces unique values.<br><span class="segmentSeparator"></span>The sequence state is persistently stored in the repository, therefore it can efficiently produce unique identifiers in a controlled and predictable manner.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FormType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Form definition.<br><span class="segmentSeparator"></span>Forms define how a certain user interface form or dialog is presented in the user interface.<br><span class="segmentSeparator"></span>It is used for user interface customization.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DashboardType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Object that specifies a look and a behavior of a dashboard.<br><span class="segmentSeparator"></span>This is used for user interface customization.<br><span class="segmentSeparator"></span>But it can also specify some aspects of midPoint reports.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>GenericObjectType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generic type for any other object type that do not fit into any other category.<br><span class="segmentSeparator"></span>However, support for this data type is extremely limited.<br><span class="segmentSeparator"></span>We generally do not recommend to use it at all.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ShadowType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Shadow of a resource object.<br><span class="segmentSeparator"></span>Local copy of any object on the provisioning resource that is related to provisioning.<br><span class="segmentSeparator"></span>It may be account, group, role (on the target system), privilege, security label, organizational unit or anything else that is worth managing in identity management.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NodeType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Node describes a single installation of midPoint.<br><span class="segmentSeparator"></span>MidPoint installations can work in cluster.<br><span class="segmentSeparator"></span>The Node objects are the way how the nodes in cluster know about each other.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Type hierarchy is a principle that is used in many software systems.<br><span class="segmentSeparator"></span>This principle will be quite obvious to all software developers, but it may need some time to get used to for other engineers.<br><span class="segmentSeparator"></span>However, the basic idea is quite simple.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span><code>AbstractRoleType</code> has all the items that are needed for an object to behave like a role.<br><span class="segmentSeparator"></span><code>RoleType</code>, <code>OrgType</code>, <code>ServiceType</code> and <code>ArchetypeType</code> are subtypes of <code>AbstractRoleType</code>.<br><span class="segmentSeparator"></span>Therefore <code>RoleType</code>, <code>OrgType</code>, <code>ServiceType</code> and <code>ArchetypeType</code> can all behave like a role.</p>
</div>
<div class="paragraph">
<p>This may sound quite strange, why would we want an organizational unit to behave like a role.<br><span class="segmentSeparator"></span>But the answer is quite obvious.<br><span class="segmentSeparator"></span>Membership in an organizational unit may imply some privileges.<br><span class="segmentSeparator"></span>Other IDM systems need complex rules in a form "if user belongs to organizational unit A then he will also have role X".<br><span class="segmentSeparator"></span>But that is not needed in midPoint.<br><span class="segmentSeparator"></span>Organizational unit is a role, therefore it can simply include all the roles that are needed.<br><span class="segmentSeparator"></span>This means that the Role-Based Access Control (RBAC) principles can be applied to several object types.<br><span class="segmentSeparator"></span>And this is a very typical trait of a midPoint philosophy: reuse of generic principles.<br><span class="segmentSeparator"></span>We reuse existing principles instead of complicating the system by inventing a new single-purpose mechanism.<br><span class="segmentSeparator"></span>As you will see later, this makes midPoint both elegant and powerful.</p>
</div>
</div>
<div class="sect2">
<h3 id="_item_path">Item Path</h3>
<div class="paragraph">
<p>MidPoint configuration often needs to reference a particular item in a particular object.<br><span class="segmentSeparator"></span>For example, mapping sources and target are references to properties and containers.<br><span class="segmentSeparator"></span>However, midPoint data structures can be quite complex.<br><span class="segmentSeparator"></span>For example, password is stored in property value that is located in container password which is in container <code>credentials</code> defined in <code>UserType</code> data type.<br><span class="segmentSeparator"></span>It may be difficult to find a way in this little maze.<br><span class="segmentSeparator"></span>And there may be even some unambiguous situations.<br><span class="segmentSeparator"></span>For example, user status is controlled by property <code>administrativeStatus</code> that is in the <code>activation</code> container.<br><span class="segmentSeparator"></span>But assignment also has an <code>activation</code> container and there is an assignment <code>administrativeStatus</code>.<br><span class="segmentSeparator"></span>Therefore referencing an item by a simple name would not be enough.<br><span class="segmentSeparator"></span>We need something more sophisticated here.</p>
</div>
<div class="paragraph">
<p>MidPoint is using the concept of <em>item path</em> to reference items in the schema.<br><span class="segmentSeparator"></span>In its simplest form, item path is just a sequence of item names concatenated by slash characters.<br><span class="segmentSeparator"></span>For example the path of user administrative status is</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>activation/administrativeStatus</code></pre>
</div>
</div>
<div class="paragraph">
<p>whereas the path of assignment activation status is</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>assignment/activation/administrativeStatus</code></pre>
</div>
</div>
<div class="paragraph">
<p>Item path provides an unambiguous reference to a specific item in midPoint schema.<br><span class="segmentSeparator"></span>The path can be used in all the places where there is a need to reference a particular item.<br><span class="segmentSeparator"></span>It is often used in mappings to specify sources and target.<br><span class="segmentSeparator"></span>But it is also used in other places that we will mention in later chapters.<br><span class="segmentSeparator"></span>The concept of path is deeply embedded in all midPoint operations.<br><span class="segmentSeparator"></span>For example, modification deltas are using item path to precisely pinpoint the places in the object that are modified.</p>
</div>
<div class="paragraph">
<p>The path is used to locate a particular item in midPoint schema.<br><span class="segmentSeparator"></span>But it is also used to reference a specific value in midPoint objects.<br><span class="segmentSeparator"></span>In that case the path often looks exactly the same.<br><span class="segmentSeparator"></span>As long as we are dealing only with single-value containers, the path can unambiguously point to a specific item.<br><span class="segmentSeparator"></span>But we may get into trouble in case that multi-valued containers are used.<br><span class="segmentSeparator"></span>And those are used in midPoint quite often.<br><span class="segmentSeparator"></span>Assignment is one of those multi-valued container.<br><span class="segmentSeparator"></span>User can have many assignments.<br><span class="segmentSeparator"></span>If we want to disable one particular assignment, how do we do it?<br><span class="segmentSeparator"></span>If we would use the path above then it is not clear which assignment should be disabled.<br><span class="segmentSeparator"></span>Therefore, in case of multi-valued containers the path is extended with a container identifier in square brackets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>assignment[123]/activation/administrativeStatus</code></pre>
</div>
</div>
<div class="paragraph">
<p>This path is unambiguously referencing <code>administrativeStatus</code> property in an <code>activation</code> container in a very specific assignment - an <code>assignment</code> container with identifier <code>123</code>.<br><span class="segmentSeparator"></span>This form of the path is used mostly in the deltas and user should not need to ever enter those paths manually.<br><span class="segmentSeparator"></span>However, this form is often recorded in midPoint log files and other diagnostic output.<br><span class="segmentSeparator"></span>Therefore it is very useful to be familiar with it.</p>
</div>
<div class="paragraph">
<p>You might wonder why there is an identifier for <code>assignment</code> but there is no identifier for <code>activation</code>.<br><span class="segmentSeparator"></span>Both are containers, aren’t they?<br><span class="segmentSeparator"></span>However, the clever reader already knows the answer.<br><span class="segmentSeparator"></span><code>assignment</code> is a multi-valued container.<br><span class="segmentSeparator"></span>Therefore, identifier is needed to pinpoint a specific value of that container.<br><span class="segmentSeparator"></span>But <code>activation</code> is a single-valued container.<br><span class="segmentSeparator"></span>There is no danger of ambiguity.<br><span class="segmentSeparator"></span>Therefore the identifier is not needed in this case.</p>
</div>
<div class="paragraph">
<p>This form of item path works fine if need to identity an item in a particular object.<br><span class="segmentSeparator"></span>But sometimes we have a lot of objects and other data structures to choose from.<br><span class="segmentSeparator"></span>For example a mapping can have several sources.<br><span class="segmentSeparator"></span>And then there are expression variables.<br><span class="segmentSeparator"></span>Therefore using simple paths would be ambiguous.<br><span class="segmentSeparator"></span>In such case the path can start with an optional variable identifier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$focus/activation/administrativeStatus</code></pre>
</div>
</div>
<div class="paragraph">
<p>The path above explicitly states that is should be applied to the content of variable <code>focus</code>.<br><span class="segmentSeparator"></span>Therefore there is no danger that this path could be applied to a shadow object which also has the <code>activation</code> container.<br><span class="segmentSeparator"></span>This form of item path is often used in path expression evaluators.</p>
</div>
<div class="paragraph">
<p>Clever reader is surely wondering about QNames now.<br><span class="segmentSeparator"></span>The XML schema defines the elements in a form of QNames, which basically means "names in a namespace".<br><span class="segmentSeparator"></span>Therefore element names and QNames.<br><span class="segmentSeparator"></span>And path should use QNames as well.<br><span class="segmentSeparator"></span>But so far all the names in the path looks like simple strings.<br><span class="segmentSeparator"></span>Yes, they are simple strings.<br><span class="segmentSeparator"></span>But they point to elements in the schema.<br><span class="segmentSeparator"></span>While the path is correct and unambiguous, midPoint does not need the namespaces.<br><span class="segmentSeparator"></span>Simple string (known as <em>local part</em> of QNames) are enough to navigate through the schema and automatically determine the namespaces.<br><span class="segmentSeparator"></span>This is the same principle used for parsing XML, JSON or YAML document without namespace definitions.<br><span class="segmentSeparator"></span>However, there may be ambiguities in case that several custom schema extensions are used.<br><span class="segmentSeparator"></span>Those extensions may have elements with conflicting local parts.<br><span class="segmentSeparator"></span>In that case an alternative form of item path can be used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>declare namespace exmpl="http://example.com/xml/ns/midpoint/schema"; extension/exmpl:foo</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This alternative form is based on XPath specification, that was used in early midPoint versions and it was an inspiration for the concept of item path.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Clever reader may have also noticed that there are two types of namespaces that are often used in midPoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>http://prism.evolveum.com/xml/ns/public/...</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>http://midpoint.evolveum.com/xml/ns/public/...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Indeed, the schema is divided into two big parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Prism schema</strong> is used to express basic concepts that deal with objects, deltas, item paths, queries and similar mechanisms.<br><span class="segmentSeparator"></span>Those are concepts of our data representation library that we dubbed Prism.<br><span class="segmentSeparator"></span>Prism concepts are very generic mechanisms that have nothing to do with identity management.<br><span class="segmentSeparator"></span>While currently Prism is an integral part of midPoint, it is supposed to be a general-purpose data representation library that can be reused to build other applications.<br><span class="segmentSeparator"></span>The plan is to separate Prism form midPoint at some point in the future.</p>
</li>
<li>
<p><strong>MidPoint schema</strong> is used to express all the objects and data types that midPoint works with.<br><span class="segmentSeparator"></span>All the concepts specific to identity management are there: user, role, org, assignment and many, many others.<br><span class="segmentSeparator"></span>This is the data model of identity management as it is implemented in midPoint.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion_2">Conclusion</h3>
<div class="paragraph">
<p>This is all about midPoint schema that you need to know right now.<br><span class="segmentSeparator"></span>There is still much more to learn, as the entire midPoint schema is big and complex.<br><span class="segmentSeparator"></span>And understanding of midPoint schema is absolutely crucial, as the schema is a foundation of everything that midPoint does.<br><span class="segmentSeparator"></span>But the best way to do the learning is to do it on the go.<br><span class="segmentSeparator"></span>You will learn more about midPoint schema as you will explore midPoint functionality.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="07-rbac">7.<br><span class="segmentSeparator"></span>Role-Based Access Control</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
Simplicity is the most complex of all concepts.<br><span class="segmentSeparator"></span></blockquote>
<div class="attribution">
— Mentat conundrum<br>
<cite>Dune: House Corrino by Brian Herbert</cite>
</div>
</div>
<div class="paragraph">
<p>Basic idea of Role-based access control (RBAC) is very simple: instead of assigning the same privileges to users over and over again, let’s group such privileges into roles.<br><span class="segmentSeparator"></span>Then assign roles to users.<br><span class="segmentSeparator"></span>This often aligns with organizational roles such as <em>manager</em>, <em>assistant</em> or <em>analyst</em>.<br><span class="segmentSeparator"></span>Therefore, roles are quite easy to understand even on an intuitive level.<br><span class="segmentSeparator"></span>And RBAC should make your life easier - at least in theory.</p>
</div>
<div class="paragraph">
<p>Role-based access control principles are present in almost all identity management systems.<br><span class="segmentSeparator"></span>Therefore it is no surprise that RBAC is one of the basic midPoint mechanisms to organize privileges in midPoint.<br><span class="segmentSeparator"></span>MidPoint supports all the usual RBAC features such as role hierarchies, an automatic assignment of roles, entitlement definition etc.<br><span class="segmentSeparator"></span>But midPoint goes beyond traditional RBAC.<br><span class="segmentSeparator"></span>MidPoint roles can be smart.<br><span class="segmentSeparator"></span>There may be dynamic expression inside midPoint roles, such as attribute mappings.<br><span class="segmentSeparator"></span>The roles may be conditional, so one role is included in another role, but only in case that a specific condition is satisfied.<br><span class="segmentSeparator"></span>The roles may be parametric, so the role can determine the specific set of entitlements based on the user data or a parameter of a role assignment.</p>
</div>
<div class="paragraph">
<p>But midPoint role dynamics goes even one step further.<br><span class="segmentSeparator"></span>The RBAC system can be applied to the roles themselves, thus creating <em>meta-roles</em>.<br><span class="segmentSeparator"></span>It is quite common that the roles are divided into several types: application roles, business roles, technical roles and so on.<br><span class="segmentSeparator"></span>However, all the business roles have common characteristics such as common approval processes, common life-cycle policies etc.<br><span class="segmentSeparator"></span>Instead of copying the common parts into each and every business role, the business roles may be assigned a common meta-role.<br><span class="segmentSeparator"></span>The meta-role defines all the common characteristics of all business roles, therefore the RBAC system is much easier to maintain.<br><span class="segmentSeparator"></span>And this concept is extended even further with <em>archetypes</em>.<br><span class="segmentSeparator"></span>But more on that later.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Terminology.</div>
The term <em>RBAC</em> is many things to many people.<br><span class="segmentSeparator"></span>We use the term <em>RBAC</em> in quite a broad sense.<br><span class="segmentSeparator"></span>We do not strictly mean NIST RBAC model.<br><span class="segmentSeparator"></span>What me mean by <em>RBAC</em> is a generic mechanism that is based on the concept of roles.<br><span class="segmentSeparator"></span>Although the basic principles of midPoint RBAC are very similar to NIST RBAC model, we take the liberty to deviate from NIST model when needed.<br><span class="segmentSeparator"></span>And as you will see later, such deviation is really necessary.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
<div class="sect2">
<h3 id="_reality_policy_and_assignments">Reality, Policy and Assignments</h3>
<div class="paragraph">
<p>Previous chapters were focused on account provisioning and synchronization.<br><span class="segmentSeparator"></span>Which means that the primary focus was an <em>account</em> (or a similar resource object).<br><span class="segmentSeparator"></span>This is what we call <em>reality</em> in midPoint way of thinking.<br><span class="segmentSeparator"></span>Accounts are objects that exist in the databases and files on the resources.<br><span class="segmentSeparator"></span>In that aspect they are almost tangible things.<br><span class="segmentSeparator"></span>Existence of an account allows user to access a particular system, to execute operations and so on.<br><span class="segmentSeparator"></span>Therefore we consider an account to be something <em>real</em>.</p>
</div>
<div class="paragraph">
<p>But how do we know whether an account should exist or it should not exist?<br><span class="segmentSeparator"></span>The situation would be quite clear if midPoint is the only source of truth.<br><span class="segmentSeparator"></span>In that case if there is a linked shadow then account should exist.<br><span class="segmentSeparator"></span>If there is no shadow, then account is illegal.<br><span class="segmentSeparator"></span>But reality is almost never that simple.<br><span class="segmentSeparator"></span>In real deployments MidPoint is not the only source of truth.<br><span class="segmentSeparator"></span>It is usually human resource (HR) system that is the source of the truth – but only for some types of users, usually employees.<br><span class="segmentSeparator"></span>Then there are external users, temporary workers, special personas for user administrators and so on.<br><span class="segmentSeparator"></span>Some of them may have their own source systems similar to HR database.<br><span class="segmentSeparator"></span>But for some users it may still be midPoint which is the ultimate source of truth.<br><span class="segmentSeparator"></span>And that "truth" may be in fact only partial or compiled from several sources.<br><span class="segmentSeparator"></span>To keep long story short: reality is messy and complicated.<br><span class="segmentSeparator"></span>And it is often quite difficult to figure out which accounts particular user should have and which he should not have.<br><span class="segmentSeparator"></span>Yet, for an IDM system this distinction is absolutely crucial.<br><span class="segmentSeparator"></span>Various IDM systems came with broad range of mechanisms to handle this problem, and sadly, those mechanisms are often not very good.<br><span class="segmentSeparator"></span>Fortunately, midPoint was designed from the beginning with a full awareness of this problem.<br><span class="segmentSeparator"></span>Therefore there is a clean distinction between <em>reality</em> and <em>policy</em> in midPoint.</p>
</div>
<div class="paragraph">
<p>Accounts, shadows and links are what we refer to as <em>reality</em>.<br><span class="segmentSeparator"></span>Those describe what <em>exists</em>, what <em>is</em>.<br><span class="segmentSeparator"></span>And there is a separate mechanism to describe policy.<br><span class="segmentSeparator"></span>Policy, in midPoint parlance, means definition of what <em>should be</em>.<br><span class="segmentSeparator"></span>In the ideal world <em>reality</em> and <em>policy</em> should be in accord.<br><span class="segmentSeparator"></span>They should describe the same state of things.<br><span class="segmentSeparator"></span>But we do not live in ideal world.<br><span class="segmentSeparator"></span>Perfectly good accounts may be deleted by mistake, illegal accounts may be created, entitlements may get mixed up, attribute values destroyed – there are many dangers in the big wild world out there.<br><span class="segmentSeparator"></span>And then there are scenarios when we actually want reality to be different than policy for some period of time.<br><span class="segmentSeparator"></span>Those may be migration scenarios when a new system is being connected to midPoint and the data needs to be cleaned up.<br><span class="segmentSeparator"></span><em>Reality</em> and <em>policy</em> do not match exactly in practice.<br><span class="segmentSeparator"></span>We all know that only too well.<br><span class="segmentSeparator"></span>Therefore, midPoint is designed in such a way that it can graciously handle the differences between <em>reality</em> and <em>policy</em>.</p>
</div>
<div class="paragraph">
<p>When it comes to policy, the most important concept is an <em>assignment</em>.<br><span class="segmentSeparator"></span>Simply speaking, assignment is a data structure which specifies that a particular user should have something.<br><span class="segmentSeparator"></span>The simplest case is <em>account assignment</em>.<br><span class="segmentSeparator"></span>This type of assignment states that the user should have an account on a particular resource.<br><span class="segmentSeparator"></span>When such assignment is added to a user, there is suddenly a discrepancy between reality and policy.<br><span class="segmentSeparator"></span>The assignment states that a user <em>should have</em> an account.<br><span class="segmentSeparator"></span>But there is no such account yet.<br><span class="segmentSeparator"></span>It is a nature of midPoint to align policy and reality as much as possible (unless it is told otherwise).<br><span class="segmentSeparator"></span>Therefore midPoint will try to create missing account.<br><span class="segmentSeparator"></span>Once that account is created <em>reality</em> and <em>policy</em> are aligned once again.</p>
</div>
<div class="paragraph">
<p>The mechanism that midPoint uses to define that a particular user needs an account, entitlement or other resource object is called <em>construction</em>.<br><span class="segmentSeparator"></span>The simplest case is a <em>construction</em> that specifies to create an account (a.k.a <em>account construction</em>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;user&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;assignment&gt;</span>
        <span class="tag">&lt;construction&gt;</span>
             <span class="tag">&lt;resourceRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">8a83b1a4-be18-11e6-ae84-7301fdab1d7c</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;kind&gt;</span>account<span class="tag">&lt;/kind&gt;</span>
        <span class="tag">&lt;/construction&gt;</span>
    <span class="tag">&lt;/assignment&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/user&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The term <em>construction</em> means that object on that particular resource should be constructed.<br><span class="segmentSeparator"></span>In this case the object on OpenLDAP resource should be constructed for this particular user.<br><span class="segmentSeparator"></span>If no construction parameters are specified then a <em>default account</em> will be constructed.<br><span class="segmentSeparator"></span>Which means that outbound mappings in the OpenLDAP resource definition will be used to set up the account.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/07-01-user-assignment-resource-simple.png" alt="Simple account assignment">
</div>
</div>
<div class="paragraph">
<p>Construction can be quite a complex data structure describing object types, object classes, attributes and so on.<br><span class="segmentSeparator"></span>However,it is unlikely that they will be placed directly in assignment like this.<br><span class="segmentSeparator"></span>But more on that later.<br><span class="segmentSeparator"></span>What is important for now is that assignments specify <em>policy</em>.</p>
</div>
<div class="paragraph">
<p>After the assignment is added to a user and all the processing and provisioning takes place the situation looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/07-02-user-assignment-resource-account.png" alt="Simple account assignment and account link">
</div>
</div>
<div class="paragraph">
<p>Assignment is a definition of policy which states that an OpenLDAP account should exist for Alice.<br><span class="segmentSeparator"></span>But there is no such account.<br><span class="segmentSeparator"></span>Therefore MidPoint aligns reality and policy by creating that account.<br><span class="segmentSeparator"></span>As for any other account there is a shadow and a link to track account ownership.</p>
</div>
<div class="paragraph">
<p>This may look like a very complicated method to do something simple.<br><span class="segmentSeparator"></span>But this kind of thinking is really necessary to handle complex cases.<br><span class="segmentSeparator"></span>There may be several assignments that mandate the same account.<br><span class="segmentSeparator"></span>There may be assignments for the same accounts, but each assignment mandates different attributes or values.<br><span class="segmentSeparator"></span>The account that the assignments mandate may exist already, e.g.<br><span class="segmentSeparator"></span>it may be linked by previous reconciliation with the resource.<br><span class="segmentSeparator"></span>There may be several accounts for the same user on the same resource (e.g.<br><span class="segmentSeparator"></span>“ordinary” account and “testing” account).<br><span class="segmentSeparator"></span>And so on.<br><span class="segmentSeparator"></span>We will deal with various cases in this book.<br><span class="segmentSeparator"></span>But the basic principle is the same: assignments are policy and midPoint is trying to align reality to match the policy.</p>
</div>
</div>
<div class="sect2">
<h3 id="_roles_2">Roles</h3>
<div class="paragraph">
<p>There is much more in the concept of an assignment than just the very simple account assignment that was introduced above.<br><span class="segmentSeparator"></span>Assignment is a generic mechanism that is used in midPoint for wide variety of cases, from simple account provisioning to really complex identity governance policies.<br><span class="segmentSeparator"></span>But one specific assignment type is particularly interesting with respect to the topic of this chapter: role assignment.</p>
</div>
<div class="paragraph">
<p>The basic idea of Role-Based Access Control (RBAC) is simple:
Instead of assigning account to users directly, let us group all accounts that a particular group of users need into a <em>role</em>.<br><span class="segmentSeparator"></span>Then assign the role to users.<br><span class="segmentSeparator"></span>Later on you may add new application to your system and you want all the users to have account there.<br><span class="segmentSeparator"></span>In that case all that is needed is to add that account to a role and recompute the users.<br><span class="segmentSeparator"></span>All the users that should have the account will get the account.<br><span class="segmentSeparator"></span>This principle is reused for may purposes in midPoint: accounts, privileges, authorizations, policies …​</p>
</div>
<div class="paragraph">
<p>Role is a special type of object in midPoint.<br><span class="segmentSeparator"></span>But as all midPoint objects it has a very familiar structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">aaa6cde4-0471-11e9-9b50-c743da469067</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Business Analyst<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/user&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Role object has its OID and name.<br><span class="segmentSeparator"></span>The rest of the role usually specifies the privileges that the role gives to the users.<br><span class="segmentSeparator"></span>But how do we give this roles to users?<br><span class="segmentSeparator"></span>That is what role assignment is good for:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;user&gt;</span>
    <span class="tag">&lt;name&gt;</span>alice<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;assignment&gt;</span>
        <span class="tag">&lt;targetRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">aaa6cde4-0471-11e9-9b50-c743da469067</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">RoleType</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/assignment&gt;</span>
<span class="tag">&lt;/user&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>User <code>alice</code> has role <code>Business Analyst</code> assigned.<br><span class="segmentSeparator"></span>The assignment is using the familiar style of object references in midPoint, referring to the role by its OID.<br><span class="segmentSeparator"></span>This is very useful, as the assignment stays the same in case that the role or the user are renamed - and both of those events are much more frequent that one would think.</p>
</div>
</div>
<div class="sect2">
<h3 id="_provisioning_roles">Provisioning Roles</h3>
<div class="paragraph">
<p>Provisioning is the bread and butter of identity management.<br><span class="segmentSeparator"></span>Therefore it is quite understandable that the most natural usage of roles in midPoint is to automate provisioning.<br><span class="segmentSeparator"></span>Provisioning roles are usually combining several <em>construction</em> statements.<br><span class="segmentSeparator"></span>The idea is that a provisioning role should specify all the privileges that users of that role need.<br><span class="segmentSeparator"></span>Therefore a <code>Business Analyst</code> role may look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">aaa6cde4-0471-11e9-9b50-c743da469067</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Business Analyst<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;inducement&gt;</span>
        <span class="tag">&lt;construction&gt;</span>
             <span class="comment">&lt;!-- OpenLDAP resource --&gt;</span>
             <span class="tag">&lt;resourceRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">8a83b1a4-be18-11e6-ae84-7301fdab1d7c</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;kind&gt;</span>account<span class="tag">&lt;/kind&gt;</span>
        <span class="tag">&lt;/construction&gt;</span>
    <span class="tag">&lt;/inducement&gt;</span>
    <span class="tag">&lt;inducement&gt;</span>
        <span class="tag">&lt;construction&gt;</span>
             <span class="comment">&lt;!-- CRM resource --&gt;</span>
             <span class="tag">&lt;resourceRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">04afeda6-394b-11e6-8cbe-abf7ff430056</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;kind&gt;</span>account<span class="tag">&lt;/kind&gt;</span>
        <span class="tag">&lt;/construction&gt;</span>
    <span class="tag">&lt;/inducement&gt;</span>
<span class="tag">&lt;/user&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The usual case is that every employee need to have basic access to company functionality.<br><span class="segmentSeparator"></span>In our case that access is granted by an account in central OpenLDAP directory.<br><span class="segmentSeparator"></span>In addition to the basic LDAP account, business analysts need access to the CRM system.<br><span class="segmentSeparator"></span>The role combines all the accounts that a business analyst needs.<br><span class="segmentSeparator"></span>Assign that one role and the user has all that is needed to do the job.</p>
</div>
<div class="paragraph">
<p>But, what is that mysterious <em>inducement</em> thing?<br><span class="segmentSeparator"></span>Think of inducement as indirect assignment.<br><span class="segmentSeparator"></span>Assignments give privileges directly to the object in which they are placed.<br><span class="segmentSeparator"></span>The assignment in the previous section gave account to the user because it was placed in the user object.<br><span class="segmentSeparator"></span>However, here we do not want the accounts to be created for a role.<br><span class="segmentSeparator"></span>We want accounts to be created for all the users that have the role.<br><span class="segmentSeparator"></span>That is one <em>order of indirection</em> down the line.<br><span class="segmentSeparator"></span>Therefore we (usually) do not want to use assignments in roles.<br><span class="segmentSeparator"></span>We want to use something that reflects this indirect relation.<br><span class="segmentSeparator"></span>And that is exactly what inducement is.<br><span class="segmentSeparator"></span>Inducement is very similar to assignment - in fact it has exactly the same structure.<br><span class="segmentSeparator"></span>But while assignment is direct, inducement is indirect.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/07-03-user-assignment-role.png" alt="User, role and resource">
</div>
</div>
<div class="paragraph">
<p>MidPoint user interface can show a nice summary of the inducements:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/07-04-gui-role-inducements.png" alt="Role inducements in user interface">
</div>
</div>
<div class="paragraph">
<p>It is perhaps worth explaining what happens if this <code>Business Analyst</code> role is assigned to a user.<br><span class="segmentSeparator"></span>When that role is assigned to a user, midPoint will process all the parts of role definition.<br><span class="segmentSeparator"></span>MidPoint will take the inducements from the role and apply them to the user.<br><span class="segmentSeparator"></span>In fact, midPoint will behave in almost the same way as if those construction statements were specified directly in user’s assignment.<br><span class="segmentSeparator"></span>And then we have the familiar principle: policy mandates that two accounts should exit, but in reality there are no such accounts.<br><span class="segmentSeparator"></span>Therefore midPoint creates the accounts.<br><span class="segmentSeparator"></span>MidPoint also creates appropriate shadow objects and links them to the user.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/07-05-user-assignment-role-accounts.png" alt="User, role assignment, shadows and accounts">
</div>
</div>
<div class="paragraph">
<p>Many applications implement at least some aspects of RBAC, as RBAC is a very useful way how to organize the privileges.<br><span class="segmentSeparator"></span>However, almost all the applications limit the applicability of RBAC to the application itself.<br><span class="segmentSeparator"></span>I.e.<br><span class="segmentSeparator"></span>roles in an application can contain only those privileges that apply to that particular application.<br><span class="segmentSeparator"></span>The roles cannot have privileges from other application.<br><span class="segmentSeparator"></span>But IDM systems are different.<br><span class="segmentSeparator"></span>IDM systems such as midPoint are reaching out to many applications (resources).<br><span class="segmentSeparator"></span>Therefore, a single midPoint role can give access to many applications at once.<br><span class="segmentSeparator"></span>No other application can do that.</p>
</div>
</div>
<div class="sect2">
<h3 id="_roles_accounts_and_attributes">Roles, Accounts and Attributes</h3>
<div class="paragraph">
<p>We have already seen how outbound mappings can be used to set up account attributes.<br><span class="segmentSeparator"></span>Roles can also contain outbound mappings, therefore they can be used for a similar purpose:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">aaa6cde4-0471-11e9-9b50-c743da469067</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Business Analyst<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;inducement&gt;</span>
        <span class="tag">&lt;construction&gt;</span>
             <span class="comment">&lt;!-- OpenLDAP resource --&gt;</span>
             <span class="tag">&lt;resourceRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">8a83b1a4-be18-11e6-ae84-7301fdab1d7c</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;kind&gt;</span>account<span class="tag">&lt;/kind&gt;</span>
             <span class="tag">&lt;attribute&gt;</span>
                 <span class="tag">&lt;ref&gt;</span>ri:title<span class="tag">&lt;/ref&gt;</span>
                 <span class="tag">&lt;outbound&gt;</span>
                     <span class="tag">&lt;expression&gt;</span>
                         <span class="tag">&lt;value&gt;</span>Business Analyst<span class="tag">&lt;/value&gt;</span>
                     <span class="tag">&lt;/expression&gt;</span>
                 <span class="tag">&lt;/outbound&gt;</span>
             <span class="tag">&lt;/attribute&gt;</span>
        <span class="tag">&lt;/construction&gt;</span>
    <span class="tag">&lt;/inducement&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/role&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the above role is assigned to a user, an account on OpenLDAP server will be created.<br><span class="segmentSeparator"></span>The account will be provisioned in a usual way.<br><span class="segmentSeparator"></span>All the outbound mappings from resource definition will be applied to set up the account.<br><span class="segmentSeparator"></span>But there is one difference.<br><span class="segmentSeparator"></span>The role specifies one additional outbound mapping for the account.<br><span class="segmentSeparator"></span>This mapping will be included in the set of usual account mappings when the account will be provisioned.<br><span class="segmentSeparator"></span>Therefore the account will have attribute <code>title</code> set to <code>Business Analyst</code>.</p>
</div>
<div class="paragraph">
<p>This is a very typical way how midPoint deployments are set up:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Common and usual attribute values are specified by outbound mappings in the resource definition (in <code>schemaHandling</code>).<br><span class="segmentSeparator"></span>Those are usual mappings that take user properties as their source.<br><span class="segmentSeparator"></span>Many of those mappings do not even modify the value at all (<code>asIs</code> mappings).</p>
</li>
<li>
<p>Attributes that are specific to roles are defined in the roles themselves.<br><span class="segmentSeparator"></span>Those mappings often do not have any source at all.<br><span class="segmentSeparator"></span>They just set a static value (literal <code>value</code> mappings).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>At the time when midPoint is about to provision an account, all the mappings are merged and processed together.<br><span class="segmentSeparator"></span>It is quite common than more than one role has a construction for the same account.<br><span class="segmentSeparator"></span>All those constructions from all such roles are merged together and they are added to the mappings specified in resource definition.<br><span class="segmentSeparator"></span>All those mappings are used to compute final values of account attributes.</p>
</div>
<div class="paragraph">
<p>Most account attributes are single-valued.<br><span class="segmentSeparator"></span>Attempt to set more than one value for such an attribute will end up with an error.<br><span class="segmentSeparator"></span>Therefore it does not make sense to specify more than one mapping for such an attribute.<br><span class="segmentSeparator"></span>The mapping can be specified in a resource or in the role, but only one of those should be active at the time.<br><span class="segmentSeparator"></span>Mapping conditions and strength can be used to selectively deactivate some mappings in more complicated cases.<br><span class="segmentSeparator"></span>But it still means that only one mapping is active at a time.</p>
</div>
<div class="paragraph">
<p>However, some attributes are multi-value.<br><span class="segmentSeparator"></span>In that case midPoint will merge the values from all the mappings.<br><span class="segmentSeparator"></span>In that case several roles may contribute to the final set of attribute values, as can the mapping in resource definition.<br><span class="segmentSeparator"></span>This is the usual case of attributes that specify privileges, such as permissions, authorization codes, access control list (ACL) entries and so on.</p>
</div>
<div class="paragraph">
<p>Merging of multi-value attributes is an easy way how to manage simple privileges in resources.<br><span class="segmentSeparator"></span>However, midPoint contains a whole sophisticated mechanism for managing <em>entitlements</em> such as groups.<br><span class="segmentSeparator"></span>There is an entire chapter in this book dedicated to entitlement management.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Additive principle.</div>
MidPoint is built on a principle of merging.<br><span class="segmentSeparator"></span>Assigned roles are merged together, that is merged with outbound mappings, entitlements are merged and so on.<br><span class="segmentSeparator"></span>MidPoint always adds, it never subtracts.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>there is no simple way how one role can "eliminate" a value given by another role.<br><span class="segmentSeparator"></span>If a role specifies that an account should have value A, that account will have value A.<br><span class="segmentSeparator"></span>And that’s it.<br><span class="segmentSeparator"></span>It can also have values B and C given by other roles.<br><span class="segmentSeparator"></span>But A will always be there, no matter what other roles do (unless those roles are involved in some really dark magic).<br><span class="segmentSeparator"></span>This may seem quite limiting.<br><span class="segmentSeparator"></span>But it is sufficient for vast majority of cases.<br><span class="segmentSeparator"></span>It only needs a change in your way of thinking about privileges.<br><span class="segmentSeparator"></span>Do not think about removing a privilege.<br><span class="segmentSeparator"></span>Think about <em>not adding</em> a privilege.<br><span class="segmentSeparator"></span>There are many ways how that can be achieved.<br><span class="segmentSeparator"></span>There is a role hierarchy, mappings can be conditional and whole assignments and inducements can be conditional too.<br><span class="segmentSeparator"></span>We are trying really hard to avoid concept of "removing" privileges, because that requires ordered processing.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>if role X adds something and role Y removes it, the final result depends on the order in which such roles are processed.<br><span class="segmentSeparator"></span>This creates ambiguities, it limits parallelism and overall it is a huge complication.<br><span class="segmentSeparator"></span>Therefore we try to avoid it.<br><span class="segmentSeparator"></span>And so far we have been successful.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_role_hierarchy">Role Hierarchy</h3>
<div class="paragraph">
<p>Ability to group privileges into roles is quite useful.<br><span class="segmentSeparator"></span>But it is still not good enough unless your access control policy is extremely simple.<br><span class="segmentSeparator"></span>Most practical policies require to place roles into roles, thus creating role hierarchy.</p>
</div>
<div class="paragraph">
<p>Let’s consider two work positions: clerk and supervisor.<br><span class="segmentSeparator"></span>Clerk has some basic set of privileges.<br><span class="segmentSeparator"></span>Supervisor can do everything that a clerk can do, but supervisor has some additional privileges.<br><span class="segmentSeparator"></span>A naive way would be to simply copy all the clerk’s privileges in supervisor’s role.<br><span class="segmentSeparator"></span>However, privileges are seldom static.<br><span class="segmentSeparator"></span>Access control policies tend to change and evolve as much as the environment changes.<br><span class="segmentSeparator"></span>It is likely that a clerk’s privileges will change.<br><span class="segmentSeparator"></span>In that case we will need to update the supervisor’s role as well.<br><span class="segmentSeparator"></span>This would be a maintenance burden.<br><span class="segmentSeparator"></span>Now imagine hundreds or thousands of related roles that need constant maintenance.<br><span class="segmentSeparator"></span>Any person maintaining such a structure will need superhuman precision and patience to do that.</p>
</div>
<div class="paragraph">
<p>A more natural idea would be to include clerk’s role into a supervisor’s role.<br><span class="segmentSeparator"></span>If clerk’s privileges change, then also supervisor’s privileges are automatically updated.<br><span class="segmentSeparator"></span>Maintenance is much easier.<br><span class="segmentSeparator"></span>And that is the basic idea of role hierarchy.<br><span class="segmentSeparator"></span>Basic privileges are placed into low-level roles.<br><span class="segmentSeparator"></span>Low-level roles are combined to create a higher-level roles.<br><span class="segmentSeparator"></span>Then those roles are combined as well.<br><span class="segmentSeparator"></span>The process is repeated until there are all the roles that are needed for assignment to users.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/07-06-role-hierarchy.png" alt="Role hierarchy">
</div>
</div>
<div class="paragraph">
<p>Creating role hierarchies in midPoint is quite easy.<br><span class="segmentSeparator"></span>A clever reader would already expect that this has something to do with inducements.<br><span class="segmentSeparator"></span>And clever reader would be absolutely right.<br><span class="segmentSeparator"></span>Role hierarchy is nothing more than a set of inducements between roles:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">48d4ef98-20e3-46ab-cd78-548d38364a6b3</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Clerk<span class="tag">&lt;/name&gt;</span>
    <span class="comment">&lt;!-- Privileges needed to do clerk’s work will be here.<br><span class="segmentSeparator"></span>--&gt;</span>
<span class="tag">&lt;/role&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">86e58643-d5e7-36a8-04f6-38dc3754f04e</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Supervisor<span class="tag">&lt;/name&gt;</span>
    <span class="comment">&lt;!-- Privileges that are unique to supervisor’s work will be here.<br><span class="segmentSeparator"></span>--&gt;</span>
    <span class="tag">&lt;inducement&gt;</span>
        <span class="comment">&lt;!-- This "includes" all the clerk’s privileges in this role --&gt;</span>
        <span class="tag">&lt;targetRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">48d4ef98-20e3-46ab-cd78-548d38364a6b3</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">RoleType</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/inducement&gt;</span>
<span class="tag">&lt;/role&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The inducement includes <code>Clerk</code> role in <code>Supervisor</code> role.<br><span class="segmentSeparator"></span>When midPoint evaluates the <code>Supervisor</code> role, it will get all the inducements from both the <code>Supervisor</code> and <code>Clerk</code> roles.<br><span class="segmentSeparator"></span>This process is almost transparent, it works almost as if the clerk’s privileges were copied in the supervisor’s role.<br><span class="segmentSeparator"></span>All the constructions in all the inducements in both roles are processed.<br><span class="segmentSeparator"></span>Therefore, supervisor will get all the accounts that a clerk would get, plus few extra privileges.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/07-07-supervisor-clerk-inducement.png" alt="Supervisor-clerk inducement">
</div>
</div>
<div class="paragraph">
<p>Both <code>Clerk</code> and <code>Supervisor</code> roles are likely to have construction for the same account.<br><span class="segmentSeparator"></span>This is quite natural, as both clerk and supervisor would probably work with the same applications.<br><span class="segmentSeparator"></span>However, their privileges will be different.<br><span class="segmentSeparator"></span>This is where the merging mechanism becomes very useful.<br><span class="segmentSeparator"></span>When a supervisor role is processed then privileges of clerk are merged with privileges of supervisor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">48d4ef98-20e3-46ab-cd78-548d38364a6b3</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Clerk<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;inducement&gt;</span>
        <span class="tag">&lt;construction&gt;</span>
             <span class="comment">&lt;!-- Record management system --&gt;</span>
             <span class="tag">&lt;resourceRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">84de003e-014f-2040-efbc-482e009ed2bcf</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;kind&gt;</span>account<span class="tag">&lt;/kind&gt;</span>
             <span class="tag">&lt;attribute&gt;</span>
                 <span class="tag">&lt;ref&gt;</span>ri:priv<span class="tag">&lt;/ref&gt;</span>
                 <span class="tag">&lt;outbound&gt;</span>
                     <span class="tag">&lt;expression&gt;</span>
                         <span class="tag">&lt;value&gt;</span>read<span class="tag">&lt;/value&gt;</span>
                         <span class="tag">&lt;value&gt;</span>create<span class="tag">&lt;/value&gt;</span>
                     <span class="tag">&lt;/expression&gt;</span>
                 <span class="tag">&lt;/outbound&gt;</span>
             <span class="tag">&lt;/attribute&gt;</span>
        <span class="tag">&lt;/construction&gt;</span>
    <span class="tag">&lt;/inducement&gt;</span>
<span class="tag">&lt;/role&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">86e58643-d5e7-36a8-04f6-38dc3754f04e</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Supervisor<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;inducement&gt;</span>
        <span class="tag">&lt;construction&gt;</span>
             <span class="comment">&lt;!-- Record management system --&gt;</span>
             <span class="tag">&lt;resourceRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">84de003e-014f-2040-efbc-482e009ed2bcf</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;kind&gt;</span>account<span class="tag">&lt;/kind&gt;</span>
             <span class="tag">&lt;attribute&gt;</span>
                 <span class="tag">&lt;ref&gt;</span>ri:priv<span class="tag">&lt;/ref&gt;</span>
                 <span class="tag">&lt;outbound&gt;</span>
                     <span class="tag">&lt;expression&gt;</span>
                         <span class="tag">&lt;value&gt;</span>approve<span class="tag">&lt;/value&gt;</span>
                         <span class="tag">&lt;value&gt;</span>modify<span class="tag">&lt;/value&gt;</span>
                         <span class="tag">&lt;value&gt;</span>delete<span class="tag">&lt;/value&gt;</span>
                     <span class="tag">&lt;/expression&gt;</span>
                 <span class="tag">&lt;/outbound&gt;</span>
             <span class="tag">&lt;/attribute&gt;</span>
        <span class="tag">&lt;/construction&gt;</span>
    <span class="tag">&lt;/inducement&gt;</span>
    <span class="tag">&lt;inducement&gt;</span>
        <span class="tag">&lt;targetRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">48d4ef98-20e3-46ab-cd78-548d38364a6b3</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">RoleType</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/inducement&gt;</span>
<span class="tag">&lt;/role&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When supervisor’s role is processed, midPoint figures out that those two <code>construction</code> statements are referring to the same account.<br><span class="segmentSeparator"></span>Therefore they will be merged together.<br><span class="segmentSeparator"></span>Supervisor will get an account that will have <code>priv</code> attribute set to values <code>read</code>, <code>create</code>, <code>approve</code>, <code>modify</code> and <code>delete</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/07-08-supervisor-clerk-inducement-constructions.png" alt="Supervisor-clerk inducement with constructions">
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Assignments in roles.</div>
So far we have seen only inducement in the roles.<br><span class="segmentSeparator"></span>But what about assignment?<br><span class="segmentSeparator"></span>Assignment is indeed used in the roles, but it has different meaning.<br><span class="segmentSeparator"></span>Inducement means that role A has to be included in role B.<br><span class="segmentSeparator"></span>But assignment means that role A has to be applied to role B.<br><span class="segmentSeparator"></span>In that case role A is in fact a meta-role.<br><span class="segmentSeparator"></span>But more on that later.<br><span class="segmentSeparator"></span>For now it is good to remember a rule of the thumb: role hierarchy is always created by inducements.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_role_universality">Role Universality</h3>
<div class="paragraph">
<p>MidPoint roles are very useful kind of an animal, because they are used for almost everything in midPoint.<br><span class="segmentSeparator"></span>MidPoint role be used as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Provisioning role:</strong> The role can include constructions that control provisioning and deprovisioning of accounts.</p>
</li>
<li>
<p><strong>Entitlement management:</strong> The constructions can include specification of groups, resource-side roles, privileges and so on.</p>
</li>
<li>
<p><strong>Internal authorization:</strong> The roles give access to data in midPoint itself.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>a role can allow reading some user properties.<br><span class="segmentSeparator"></span>Authorizations in a role can also allow access to particular parts of midPoint user interface, remote network services and so on.</p>
</li>
<li>
<p><strong>Policy specifications:</strong> Roles (and especially meta-roles) are the places where important parts of policy management is specified.<br><span class="segmentSeparator"></span>Roles include policy rules that can apply segregation of duties (SoD) policies, ownership and approval policies and so on.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All those aspects can be combined together into a single role.<br><span class="segmentSeparator"></span>Therefore, such role can specify everything that is needed for the role holder to live a complete digital life: access to systems (accounts), entitlements, access to midPoint itself (e.g.<br><span class="segmentSeparator"></span>for self-service), apply policy constraints and so on.<br><span class="segmentSeparator"></span>Everything in one place.</p>
</div>
<div class="paragraph">
<p>Role universality may seem mundane and completely natural, but in fact it is quite unique and incredibly powerful idea.<br><span class="segmentSeparator"></span>As you will see later, roles can be driven through approval process, lifecycle management can be applied to role, roles can be subject to policies, role compliance can be evaluated and so on.<br><span class="segmentSeparator"></span>All of this applies to provisioning roles.<br><span class="segmentSeparator"></span>But the same mechanism can be applied also to roles that govern the administration of midPoint itself.<br><span class="segmentSeparator"></span>And even to meta-roles that specify high-level policies.<br><span class="segmentSeparator"></span>Which means that in a strange post-modern way midPoint can be applied to itself.<br><span class="segmentSeparator"></span>MidPoint can be its own manager.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Surprisingly, role universality is quite a unique concept in the IDM field.<br><span class="segmentSeparator"></span>The common approach of older IDM systems is to separate provisioning roles, authorization roles, governance roles and so on.<br><span class="segmentSeparator"></span>Each of them was different and it was managed in a different way.<br><span class="segmentSeparator"></span>It was quite difficult to create a unified and consistent policy.<br><span class="segmentSeparator"></span>This is one of many aspects where midPoint provides a seemingly simple mechanism, but that mechanisms simplifies a lot of things and provides an elegant solution to a difficult problem.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_role_hierarchy_structure">Role Hierarchy Structure</h3>
<div class="paragraph">
<p>There are many ways how a role hierarchy can be structured.<br><span class="segmentSeparator"></span>One way is to create all roles as "end user" roles that are supposed to be directly assigned to user.<br><span class="segmentSeparator"></span>The clerk-supervisor example above is that case.<br><span class="segmentSeparator"></span>But there are also other approaches that are often used.<br><span class="segmentSeparator"></span>For example, the low level roles are often modeled as <em>application roles</em>.<br><span class="segmentSeparator"></span>Those roles deal with access to a single application, but they are not meant to be assigned directly to users.<br><span class="segmentSeparator"></span>They are supposed to be abstract, to be the base "material" used to create other roles.<br><span class="segmentSeparator"></span>Those higher-level roles are often called <em>business roles</em>, as they reflect the needs of the business, such as specific job or responsibility in a business process.<br><span class="segmentSeparator"></span>Those roles are assigned to users.<br><span class="segmentSeparator"></span>However, those are just two of many conventions and recommendations on designing a role structure.<br><span class="segmentSeparator"></span>We will not dive deep into role modeling topics in this book.<br><span class="segmentSeparator"></span>There is a plenty of literature on that topic already.<br><span class="segmentSeparator"></span>We will rather focus on a technical implementation of role hierarchy in midPoint.</p>
</div>
<div class="paragraph">
<p>However, there are few cases that are frequent pain points in RBAC deployments.<br><span class="segmentSeparator"></span>The philosophy of midPoint is to make IDM deployment easier, therefore it is quite natural that midPoint tries to address those particular issues.</p>
</div>
<div class="paragraph">
<p>One of the big troubles are application roles.<br><span class="segmentSeparator"></span>There is usually a huge number of them and they need to be maintained manually.<br><span class="segmentSeparator"></span>It is usual practice that there is one application role for every privilege in the target system (resource), for every group for every organizational unit and so on.<br><span class="segmentSeparator"></span>Application roles duplicate the information that is already present on the resource side.<br><span class="segmentSeparator"></span>And as application roles are maintained manually, it is almost certain that this information will become inconsistent.<br><span class="segmentSeparator"></span>This approach is sometime even recommended as a best practice.<br><span class="segmentSeparator"></span>But the reality it is a maintenance nightmare.</p>
</div>
<div class="paragraph">
<p>This behavior is motivated by several factors.<br><span class="segmentSeparator"></span>But perhaps the strongest factor is that it was very difficult to set up the privileges in older (first generation) IDM systems.<br><span class="segmentSeparator"></span>Setup of an application role often required intimate knowledge of the entire IDM configuration as various tricks were used to implement entitlement management.<br><span class="segmentSeparator"></span>Heavy connector support and customization were often necessary to provide even the very basic entitlement management.<br><span class="segmentSeparator"></span>However, midPoint is different.<br><span class="segmentSeparator"></span>There is a clean concept of <em>construction</em>, which is designed in such a way that a system (resource) administrator can understand.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>the construction refers to the native (non-mapped) names of resource attributes, it is referring to native object classes that are used on the resource, native identifiers and so on.<br><span class="segmentSeparator"></span>The construction is built to use the language of the target system (resource), not the language of midPoint.<br><span class="segmentSeparator"></span>Therefore, there is a good chance that system administrators can set up constructions easily.<br><span class="segmentSeparator"></span>In addition to that, midPoint has a native support for entitlements such as groups and resource-side roles.<br><span class="segmentSeparator"></span>Those are designed to be easy to use in constructions.<br><span class="segmentSeparator"></span>Therefore there is very little need for application roles in midPoint.<br><span class="segmentSeparator"></span>Higher-level roles can contain the constructions directly.<br><span class="segmentSeparator"></span>Therefore the need for application roles in midPoint is significantly reduced.</p>
</div>
<div class="paragraph">
<p>However, application roles may still be needed and in some cases they may even be useful.<br><span class="segmentSeparator"></span>For example, there may be a common combination of privileges that is always assigned together.<br><span class="segmentSeparator"></span>In that case it makes a lot of sense to create an application role.<br><span class="segmentSeparator"></span>There may still be a need for application roles if strong role lifecycle management is required.<br><span class="segmentSeparator"></span>Or application roles might be a legacy from a previous IDM system.<br><span class="segmentSeparator"></span>As always, the best recommendation would be to analyze the RBAC policies and to use pragmatic thinking.<br><span class="segmentSeparator"></span>Be careful about generic RBAC recommendations and be even more careful about recommendations that are meant for older IDM systems.<br><span class="segmentSeparator"></span>MidPoint is different.<br><span class="segmentSeparator"></span>Of course, midPoint can implement all those old fashioned RBAC models.<br><span class="segmentSeparator"></span>But it will be a pain to maintain.<br><span class="segmentSeparator"></span>MidPoint can do better.<br><span class="segmentSeparator"></span>Try to understand how midPoint works with the roles first.<br><span class="segmentSeparator"></span>And they apply those mechanisms to your RBAC policies.<br><span class="segmentSeparator"></span>You might be surprised how midPoint can simplify the implementation of the policies.</p>
</div>
<div class="paragraph">
<p>In case that application roles are still needed, you can consider to automate the management of those roles.<br><span class="segmentSeparator"></span>MidPoint synchronization mechanism is really powerful.<br><span class="segmentSeparator"></span>It can synchronize users and accounts, but it is designed to synchronize almost anything with anything.<br><span class="segmentSeparator"></span>Therefore, it can be used to automatically create application roles from all the LDAP groups.<br><span class="segmentSeparator"></span>While this approach still have some drawbacks, it automates the most painful parts of application role’s maintenance.</p>
</div>
<div class="paragraph">
<p>There is yet another practice that is quite common, but mostly wrong.<br><span class="segmentSeparator"></span>Many IDM deployments create "login roles" or "default roles" for each application (resource).<br><span class="segmentSeparator"></span>Those roles are supposed to define basic properties of the account.<br><span class="segmentSeparator"></span>And in some cases they are supposed to keep account in existence when such account is unassigned.<br><span class="segmentSeparator"></span>While this practice is very common, it is complicated, messy and very difficult to maintain.<br><span class="segmentSeparator"></span>MidPoint was specifically designed tn such a way that this practice is not necessary in midPoint deployments.<br><span class="segmentSeparator"></span>Default account attributes are easy to set up by using resource definition.<br><span class="segmentSeparator"></span>And even the ability to keep unassigned account is directly supported in midPoint by using existence mapping, which will be described later.<br><span class="segmentSeparator"></span>Therefore, such “login roles” are not needed at all in midPoint deployments and they are generally considered to be a bad practice.</p>
</div>
</div>
<div class="sect2">
<h3 id="_assignment_gets_complicated">Assignment Gets Complicated</h3>
<div class="paragraph">
<p>At the first sight, the concept of assignment may seem quite mundane, maybe even over-complicated.<br><span class="segmentSeparator"></span>But in fact it is a very powerful concept and it has been a crucial part of midPoint design from the very beginning.<br><span class="segmentSeparator"></span>Assignment is so much more that just a simple user-role connection:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Assignments can have <strong>validity period</strong>.<br><span class="segmentSeparator"></span>This can be used to assign roles for a temporary period of time.<br><span class="segmentSeparator"></span>It can also be used to assign roles that will be activated in the future.</p>
</li>
<li>
<p>Assignment have <strong>administrative status</strong> that can be used to manually disable or enable a particular assignment.<br><span class="segmentSeparator"></span>This can be used to manage exceptions from the policies or it can be very useful in emergency situations.</p>
</li>
<li>
<p>Assignments can contain <strong>parameters</strong> that are used to support parametric roles (see above).</p>
</li>
<li>
<p>Assignments are subject to policies, governance and compliance mechanisms.<br><span class="segmentSeparator"></span>Assignments have their lifecycle, they are subject to re-certification campaigns, there can be policy exception recorded for an assignment and so on.<br><span class="segmentSeparator"></span>But more on that in later chapters of this book.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, assignment validity period can be used to assign a role only for a temporary period:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;user&gt;</span>
    <span class="tag">&lt;name&gt;</span>bob<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;assignment&gt;</span>
        <span class="comment">&lt;!-- Deputy Cheerleader role --&gt;</span>
        <span class="tag">&lt;targetRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">0c87d8f8-c9a4-11e9-81b8-e7d43e9f9a2b</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">RoleType</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;activation&gt;</span>
            <span class="tag">&lt;validTo&gt;</span>2019-12-31T23:59:59Z<span class="tag">&lt;/validTo&gt;</span>
        <span class="tag">&lt;/activation&gt;</span>
    <span class="tag">&lt;/assignment&gt;</span>
<span class="tag">&lt;/user&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As assignment and inducement are in fact the same data structure, similar approach can be used to disable parts of role hierarchy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role&gt;</span>
    <span class="tag">&lt;name&gt;</span>Marketing Research Undersecretary<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;indudement&gt;</span>...<span class="tag">&lt;/indudement&gt;</span>
    <span class="tag">&lt;indudement&gt;</span>...<span class="tag">&lt;/indudement&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;indudement&gt;</span>
        <span class="tag">&lt;description&gt;</span>
            Employee access to the lab is disabled because the lab burned down
            during an ugly accident.<br><span class="segmentSeparator"></span>Will be re-enabled when the lab is rebuilt.<br><span class="segmentSeparator"></span>        <span class="tag">&lt;/description&gt;</span>
        <span class="comment">&lt;!-- Experimental Research Lab Access role --&gt;</span>
        <span class="tag">&lt;targetRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">e8ef819c-c9a4-11e9-80a8-1bddb446391e</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">RoleType</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;activation&gt;</span>
            <span class="tag">&lt;administrativeStatus&gt;</span>disabled<span class="tag">&lt;/administrativeStatus&gt;</span>
        <span class="tag">&lt;/activation&gt;</span>
    <span class="tag">&lt;/inducement&gt;</span>
<span class="tag">&lt;/user&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Many types and variants of assignments can be combined in a single user.<br><span class="segmentSeparator"></span>Assignment validity periods may overlap, there may be disabled assignments and enabled assignments for the same role at the same time, there may be several assignments to the same role with various parameters and so on.<br><span class="segmentSeparator"></span>All reasonable combinations are supported, which allows to model very complicated schemes such as multi-affiliation, multiple employment contracts and so on.<br><span class="segmentSeparator"></span>Assignment is a crucial data structure and we will be dealing with it in almost every chapter in the book.</p>
</div>
</div>
<div class="sect2">
<h3 id="_dynamic_roles">Dynamic Roles</h3>
<div class="paragraph">
<p>RBAC is a nice and elegant way how to create and maintain access control policies.<br><span class="segmentSeparator"></span>However, there is a serious danger: roles can be quite explosive.<br><span class="segmentSeparator"></span>The role structure can easily get out of control and the roles may start to multiply.<br><span class="segmentSeparator"></span>This is known as <em>role explosion</em> and it is one of the nastiest drawbacks of access control system based on static roles.<br><span class="segmentSeparator"></span>It is not uncommon for an organization to have much more roles than it has users.<br><span class="segmentSeparator"></span>This creates a recurring maintenance nightmare.<br><span class="segmentSeparator"></span>Fortunately, midPoint has a very powerful support for dynamic roles that can significantly reduce or even completely eliminate the impact of role explosion.</p>
</div>
<div class="paragraph">
<p>To understand dynamic roles, we first need to understand what is wrong with static roles.<br><span class="segmentSeparator"></span>Many organizations have jobs that are very similar, they just differ is some small detail.<br><span class="segmentSeparator"></span>For example, all bank tellers are similar, the difference is just their branch office.<br><span class="segmentSeparator"></span>Similarly, all the assistant jobs are pretty much the same.<br><span class="segmentSeparator"></span>The difference is the department or section that they work for.<br><span class="segmentSeparator"></span>Therefore, there is <code>Sales Assistant</code>, <code>Engineering Assistant</code>, <code>Logistics Assistant</code> - and a hundred or so similar roles.<br><span class="segmentSeparator"></span>Almost all the privileges in those roles are the same.<br><span class="segmentSeparator"></span>Of course, we can create an (abstract) role <code>Assistant</code> that will have all the common privileges.<br><span class="segmentSeparator"></span>But we still need those hundreds of specific assistant roles.<br><span class="segmentSeparator"></span>And then it gets even worse, because there may be <code>Senior Sales Assistant</code>, <code>Trainee Sales Assistant</code>, <code>Senior Engineering Assistant</code>, …​</p>
</div>
<div class="paragraph">
<p>The key to the role explosion is a realization that those "exploded" roles are created in an algorithmic way.<br><span class="segmentSeparator"></span>Maybe we do not need <code>Sales Assistant</code>, <code>Engineering Assistant</code> and <code>Logistics Assistant</code> roles at all.<br><span class="segmentSeparator"></span>Maybe we need just one <code>Assistant</code> role.<br><span class="segmentSeparator"></span>The organizational unit (sales, engineering or logistics) is just a parameter to that role.<br><span class="segmentSeparator"></span>Then the number of roles can be significantly reduced.<br><span class="segmentSeparator"></span>This is what we call <em>parametric roles</em>.</p>
</div>
<div class="paragraph">
<p>Parametric roles are not your ordinary garden-variety static roles that just contain a set of privileges.<br><span class="segmentSeparator"></span>Parametric roles need to be much smarter.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>the Assistant role need an algorithm, that takes the organization unit as an input and it outputs a privileges that are appropriate for that organizational unit.<br><span class="segmentSeparator"></span>This may be a simple expression that determines correct group name based on organizational unit name.<br><span class="segmentSeparator"></span>But it may also be quite a complex code that determines most efficient location of home directories and other resources based on office location.<br><span class="segmentSeparator"></span>There is no free lunch.<br><span class="segmentSeparator"></span>The algorithm that was used to generate the number of "exploded" roles will not magically disappear.<br><span class="segmentSeparator"></span>In case of parametric roles that algorithm needs to be placed in the role itself.<br><span class="segmentSeparator"></span>But it still may be much easier to maintain a couple of expression than to maintain thousands upon thousands of roles.</p>
</div>
<div class="paragraph">
<p>The usual problem with parametric roles is, quite obviously, the presence of the parameters.<br><span class="segmentSeparator"></span>The parameters cannot be stored with the role, as they are different for each assignment of the role.<br><span class="segmentSeparator"></span>The parameters also cannot be stored directly with the user, as the user may have the same role assigned with a different set of parameters.<br><span class="segmentSeparator"></span>Fortunately, midPoint was designed with this problem in mind and this was one of the big motivations to create a concept of <em>assignment</em>.<br><span class="segmentSeparator"></span>Assignment is the right place to store the parameters, as it is the data structure that associates user with a specific role.</p>
</div>
<div class="paragraph">
<p>ExAmPLE is a very progressive company.<br><span class="segmentSeparator"></span>Similarly to other corporations they have functional organizational structure.<br><span class="segmentSeparator"></span>But their employees are also organized in teams.<br><span class="segmentSeparator"></span>Each team can have a manager and ordinary members.<br><span class="segmentSeparator"></span>The team membership is represented by custom attributes in LDAP server.<br><span class="segmentSeparator"></span>Each user has two custom multi-value attributes: <code>exampleTeamMember</code> and <code>exampleTeamManager</code>.<br><span class="segmentSeparator"></span>Both attributes expect team name as their value.</p>
</div>
<div class="paragraph">
<p>The naïve way to handle this would be to create two roles for each team.<br><span class="segmentSeparator"></span>But there are hundreds of team and that would be a maintenance nightmare.<br><span class="segmentSeparator"></span>A smarter solution is to use parametric roles.<br><span class="segmentSeparator"></span>There will be two roles only: <code>Team Member</code> and <code>Team Manager</code>.<br><span class="segmentSeparator"></span>Those roles will take custom property <code>teamName</code> as parameter.<br><span class="segmentSeparator"></span>But where does this property comes from?<br><span class="segmentSeparator"></span>It comes from assignment extension.<br><span class="segmentSeparator"></span>Each time the team role is assigned there needs to be a parameter in the assignment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;user&gt;</span>
    <span class="tag">&lt;name&gt;</span>alice<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;assignment&gt;</span>
        <span class="tag">&lt;extension&gt;</span>
            <span class="tag">&lt;exmpl:teamName&gt;</span>x-force<span class="tag">&lt;/exmpl:teamName&gt;</span>
        <span class="tag">&lt;/extension&gt;</span>
        <span class="comment">&lt;!-- Team Manager role --&gt;</span>
        <span class="tag">&lt;targetRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">aaa6cde4-0471-11e9-9b50-c743da469067</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">RoleType</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/assignment&gt;</span>
<span class="tag">&lt;/user&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the first part of the solution.<br><span class="segmentSeparator"></span>The second part are the roles.<br><span class="segmentSeparator"></span>The roles needs to be a bit smarter to use the <code>teamName</code> parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">aaa6cde4-0471-11e9-9b50-c743da469067</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Team Manager<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;inducement&gt;</span>
        <span class="tag">&lt;construction&gt;</span>
             <span class="comment">&lt;!-- OpenLDAP resource --&gt;</span>
             <span class="tag">&lt;resourceRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">8a83b1a4-be18-11e6-ae84-7301fdab1d7c</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;kind&gt;</span>account<span class="tag">&lt;/kind&gt;</span>
             <span class="tag">&lt;attribute&gt;</span>
                 <span class="tag">&lt;ref&gt;</span>ri:exampleTeamManager<span class="tag">&lt;/ref&gt;</span>
                 <span class="tag">&lt;outbound&gt;</span>
                     <span class="tag">&lt;expression&gt;</span>
                         <span class="tag">&lt;path&gt;</span>$assignment/extension/teamName<span class="tag">&lt;/path&gt;</span>
                     <span class="tag">&lt;/expression&gt;</span>
                 <span class="tag">&lt;/outbound&gt;</span>
             <span class="tag">&lt;/attribute&gt;</span>
        <span class="tag">&lt;/construction&gt;</span>
    <span class="tag">&lt;/inducement&gt;</span>
<span class="tag">&lt;/user&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Resulting LDAP account looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>dn: uid=alice,ou=people,dc=example,dc=com
objectclass: inetOrgPerson
...<br><span class="segmentSeparator"></span>exampleTeamManager: x-force
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This setup is illustrated in the following diagram:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/07-09-user-parametric-role.png" alt="Parametric role assignment">
</div>
</div>
<div class="paragraph">
<p>This is the basic mechanism of parametric roles.<br><span class="segmentSeparator"></span>It is incredibly powerful mechanism.<br><span class="segmentSeparator"></span>Unfortunately, current implementation of parametric roles in midPoint is quite limited.<br><span class="segmentSeparator"></span>While midPoint was designed with parametric roles in mind, the implementation is not yet finished.<br><span class="segmentSeparator"></span>Therefore support for parametric roles is quite limited.<br><span class="segmentSeparator"></span>MidPoint core supports parametric roles quite well.<br><span class="segmentSeparator"></span>Assignment parameters and mappings should work perfectly.<br><span class="segmentSeparator"></span>However, the support for assignment parameters in midPoint user interface is very limited.<br><span class="segmentSeparator"></span>In fact, the production-quality support is limited only to the couple of hardcoded parameters (<code>orgRef</code> and <code>tenantRef</code>) and even that leaves a lot to be desired.<br><span class="segmentSeparator"></span>While we would like to improve support for parametric roles in midPoint, we have to listen to what midPoint subscribers are saying.<br><span class="segmentSeparator"></span>Our development priorities are influenced by midPoint platform subscribers.<br><span class="segmentSeparator"></span>So far platform subscribers prioritized other features and therefore there was not sufficient funding to completely finish user interface support for parametric roles.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Roles may also explode due to other reasons.<br><span class="segmentSeparator"></span>Application roles that were mentioned above may significantly contribute to role explosion.<br><span class="segmentSeparator"></span>Also attempts to "atomize" the low-level roles as an attempt to create enough "material" to compose higher-level roles may lead to explosion.<br><span class="segmentSeparator"></span>MidPoint has some mechanism that limit those effects.<br><span class="segmentSeparator"></span>But perhaps the best approach for those cases could be summarized as "do not overdo it".<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_metaroles">Metaroles</h3>
<div class="paragraph">
<p>MidPoint roles are usually applied to users.<br><span class="segmentSeparator"></span>But midPoint roles are universal.<br><span class="segmentSeparator"></span>The roles can be applied to almost any midPoint object.<br><span class="segmentSeparator"></span>Roles can be applied to users, organizations, services and even to roles themselves.</p>
</div>
<div class="paragraph">
<p>Simply speaking, meta-roles are roles applied to other roles.<br><span class="segmentSeparator"></span>Ordinary role applies its characteristics to a user.<br><span class="segmentSeparator"></span>Meta-role applies its characteristics to another role.<br><span class="segmentSeparator"></span>This is perfectly possible in midPoint, as role can be applied to almost any midPoint object.<br><span class="segmentSeparator"></span>Then why not apply a role to another role?<br><span class="segmentSeparator"></span>This may seem like a pretty useless exercise, but the truth is that meta-roles are tremendously useful.</p>
</div>
<div class="paragraph">
<p>History is repeating, they say.<br><span class="segmentSeparator"></span>And the fact is that repetition is a daily bread in almost all IDM deployments.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>many business roles have something in common.<br><span class="segmentSeparator"></span>For example, the business roles have similar approval process.<br><span class="segmentSeparator"></span>There may be role classes that have similar exclusion policies that are part of global segregation of duties (SoD) policy.<br><span class="segmentSeparator"></span>There are roles that are tied to entitlements in a systematic way and so on.<br><span class="segmentSeparator"></span>Roles, organizational units, services and other role-like objects tend to be quite similar.<br><span class="segmentSeparator"></span>Therefore applying meta-roles to them can be very useful.</p>
</div>
<div class="paragraph">
<p>So far all the roles that we have seen were composed exclusively from inducements.<br><span class="segmentSeparator"></span>And that made perfect sense, as all those things that were in the inducement did not apply to the role itself.<br><span class="segmentSeparator"></span>Those things applied to users that the role was assigned to.<br><span class="segmentSeparator"></span>But in this case we want to apply meta-role to a role.<br><span class="segmentSeparator"></span>The effects of a meta-role should apply to the role, not to the user.<br><span class="segmentSeparator"></span>Therefore assignment is used instead of inducement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">6924fb9c-a184-11e9-840e-2feb476335f4</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Account Manager<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;description&gt;</span>
        This is business role that corresponds to account manager job.<br><span class="segmentSeparator"></span>    <span class="tag">&lt;/description&gt;</span>
    <span class="tag">&lt;assignment&gt;</span>
        <span class="comment">&lt;!-- Metarole assignment --&gt;</span>
        <span class="tag">&lt;targetRef</span> <span class="attribute-name">oid</span>=<span class="error">”</span><span class="attribute-value">a3065910-a183-11e9-835c-0b6edc3d44c3</span><span class="error">”</span> <span class="attribute-name">type</span>=<span class="error">”</span><span class="attribute-value">RoleType</span><span class="error">”</span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/assignment&gt;</span>
    <span class="tag">&lt;inducement&gt;</span>
        <span class="comment">&lt;!--
             Privileges specific to account manager.<br><span class="segmentSeparator"></span>        --&gt;</span>
    <span class="tag">&lt;/inducement&gt;</span>
<span class="tag">&lt;/role&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">a3065910-a183-11e9-835c-0b6edc3d44c3</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Business metarole<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;inducement&gt;</span>
        <span class="comment">&lt;!--
            Policies and constructions that should be applied to all
            business roles.<br><span class="segmentSeparator"></span>        --&gt;</span>
    <span class="tag">&lt;/inducement&gt;</span>
<span class="tag">&lt;/role&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This may seem similar to a role hierarchy.<br><span class="segmentSeparator"></span>But it is a completely different animal.<br><span class="segmentSeparator"></span>The crucial difference is that the meta-role is applied to the role and not to the user.<br><span class="segmentSeparator"></span>The inducements in the meta-role often contain policies such as approval policy.<br><span class="segmentSeparator"></span>Or construction clauses that create groups or organizational units.<br><span class="segmentSeparator"></span>We usually do not want to create a group for each user.<br><span class="segmentSeparator"></span>But we often want to create a group for a role.<br><span class="segmentSeparator"></span>That’s what meta-role can do.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Meta-roles are one of the stranger concepts of midPoint, but it goes well with midPoint philosophy.<br><span class="segmentSeparator"></span>Meta-roles are roles that are applied to themselves.<br><span class="segmentSeparator"></span>This is a reuse of an existing mechanism to create something new.<br><span class="segmentSeparator"></span>This is very typical for midPoint.<br><span class="segmentSeparator"></span>We always try to reuse an existing mechanism instead of reinventing a new one.<br><span class="segmentSeparator"></span>And sometimes the result is quite unexpected and surprising.<br><span class="segmentSeparator"></span>When we have designed the RBAC system for midPoint, we haven’t thought about meta-roles at all.<br><span class="segmentSeparator"></span>The meta-roles just appeared as a consequence of the design, a consequence that was absolutely unexpected.<br><span class="segmentSeparator"></span>But we have quickly realized the potential that meta-roles have and we have put them to a full use.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>A clever reader would probably notice that meta-roles can be used to set up different types of roles.<br><span class="segmentSeparator"></span>We could have meta-role for application role, business role and so on.<br><span class="segmentSeparator"></span>And clever reader, as always, would be right.<br><span class="segmentSeparator"></span>However, there are few bits still missing here to create a full-featured type system.<br><span class="segmentSeparator"></span>And those missing bits are implemented in a form of <em>archetypes</em>.<br><span class="segmentSeparator"></span>Simply speaking, archetypes are meta-roles with some optimizations and improved user experience.<br><span class="segmentSeparator"></span>But more on that later.</p>
</div>
<div class="paragraph">
<p>It may be difficult to understand the concept of meta-roles from such a short and very abstract description.<br><span class="segmentSeparator"></span>But do not worry.<br><span class="segmentSeparator"></span>As meta-roles are often used in midPoint, we will get back to the meta-roles on several occasions.<br><span class="segmentSeparator"></span>Meta-roles often allow to simplify complex problems by creating a very elegant solutions.<br><span class="segmentSeparator"></span>But for now it is enough to remember that roles can be applied to almost anything in midPoint, including themselves.</p>
</div>
</div>
<div class="sect2">
<h3 id="_rbac_abac_and_the_wildlife">RBAC, ABAC And The Wildlife</h3>
<div class="paragraph">
<p>This section is where we will get all thoughtful and philosophical.<br><span class="segmentSeparator"></span>The people that are bored with philosophical questions should skip the rest of this chapter.<br><span class="segmentSeparator"></span>We will also throw some dirt on almost every access control model in existence.<br><span class="segmentSeparator"></span>Therefore the people that maintain dogmatic beliefs about IAM mechanisms should skip this section as well.<br><span class="segmentSeparator"></span>On the other hand, open-minded people are quite likely to enjoy it.</p>
</div>
<div class="paragraph">
<p>Role-based Access Control (RBAC) is just one of many access control models.<br><span class="segmentSeparator"></span>There many variants of RBAC and there are also other access control models that are based on a completely different paradigm.<br><span class="segmentSeparator"></span>One such popular model is Attribute-Based Access Control (ABAC).<br><span class="segmentSeparator"></span>ABAC is based on an idea that access to the systems can be determined dynamically just based on "attributes".<br><span class="segmentSeparator"></span>Simply speaking, we can imagine ABAC as a one big algorithm that takes "attributes" as an input and decides whether access should be allowed or denied.</p>
</div>
<div class="paragraph">
<p>ABAC is very popular in the access management (AM) community because of its simplicity.<br><span class="segmentSeparator"></span>And it all makes much sense as it is much simpler and faster to evaluate one expression than to sift through a mountain of roles.<br><span class="segmentSeparator"></span>The problem with ABAC is manageability.<br><span class="segmentSeparator"></span>ABAC assumes that all access control decisions could be based on algorithms and that they can be made anytime a decision is needed.<br><span class="segmentSeparator"></span>However, that is almost never the case in larger practical deployments.</p>
</div>
<div class="paragraph">
<p>Many professionals responsible for identity management dream about complete automation of access control.<br><span class="segmentSeparator"></span>It would be a marvel if an IDM system could automatically determine the privileges of every person simply based on the organizational unit and work responsibilities of that person.<br><span class="segmentSeparator"></span>It would be perfect to get that information from an HR system, process it through a set of algorithms and automatically provision correct privileges to everybody.<br><span class="segmentSeparator"></span>That is a very nice dream.<br><span class="segmentSeparator"></span>But reality has a different idea.<br><span class="segmentSeparator"></span>Such automated approach never really works in practice.</p>
</div>
<div class="paragraph">
<p>First problem is at the very start: HR data are almost never correct.<br><span class="segmentSeparator"></span>There is very little motivation for the HR data to be completely correct.<br><span class="segmentSeparator"></span>It is not a big issues if someone has a wrong job code or organizational unit code in the HR system.<br><span class="segmentSeparator"></span>The business goes on, the salary is paid, everybody is happy.<br><span class="segmentSeparator"></span>There is no really efficient feedback loop that would force corrections in HR data.<br><span class="segmentSeparator"></span>Until the IDM system is deployed, that is.<br><span class="segmentSeparator"></span>But it takes years or decades for a typical company to get to deployment of IDM system.<br><span class="segmentSeparator"></span>At that point the HR data are beyond repair.<br><span class="segmentSeparator"></span>The corrections that need to be done in the HR system are substantial.<br><span class="segmentSeparator"></span>Even in small organizations it is very difficult to correct HR data manually.<br><span class="segmentSeparator"></span>Bigger deployments absolutely require proper tooling to do that job.<br><span class="segmentSeparator"></span>But even with good tooling it can take a lot of time.<br><span class="segmentSeparator"></span>Many IDM deployments were significantly delayed or even canceled because of data quality problems.<br><span class="segmentSeparator"></span>This method does not work very well.</p>
</div>
<div class="paragraph">
<p>The fundamental problem here is in the overall approach.<br><span class="segmentSeparator"></span>IDM system should not fail when the input data are wrong.<br><span class="segmentSeparator"></span>There should be procedures how to correct those data.<br><span class="segmentSeparator"></span>And the IDM deployment should not be delayed because of wrong input data.<br><span class="segmentSeparator"></span>That would be like refusing to use your reading glasses because the text you are reading is wrong.<br><span class="segmentSeparator"></span>IDM systems are essential tools that help you to clean up the data.<br><span class="segmentSeparator"></span>The IDM system should be deployed and it should be used to manage data quality on day-to-day basis.<br><span class="segmentSeparator"></span>It is naive to think that once the data are cleaned up they will stay clean.<br><span class="segmentSeparator"></span>The processes that lead to data errors will continue, therefore data errors will appear all the time.<br><span class="segmentSeparator"></span>The crucial insight is to accept that there will be data errors and to design the mechanisms to detect and correct them.</p>
</div>
<div class="paragraph">
<p>There are many manual and ad-hoc decisions that need to be made in practical IDM deployments.<br><span class="segmentSeparator"></span>And not just during the deployment.<br><span class="segmentSeparator"></span>Many ad-hoc decisions must be made during routine operation.<br><span class="segmentSeparator"></span>Privileges need to be assigned manually to compensate for missing input data.<br><span class="segmentSeparator"></span>Privileges need to be corrected, input data need to be temporarily overridden, policy exceptions has to be made.<br><span class="segmentSeparator"></span>There are many things that need to do manually.<br><span class="segmentSeparator"></span>Such decisions are made almost on day-to-day basis.<br><span class="segmentSeparator"></span>For ABAC and similar systems this would mean that a policy needs to be updated on a day-to-day basis.<br><span class="segmentSeparator"></span>And ABAC is not designed for that.</p>
</div>
<div class="paragraph">
<p>This leads to another big problem of ABAC and similar "flexible" access control models.<br><span class="segmentSeparator"></span>Even if HR are data are correct, the data usually do not provide all the information needed to completely provision the user with privileges.<br><span class="segmentSeparator"></span>The HR data are often limited to organizational unit and formal code of the work position.<br><span class="segmentSeparator"></span>However, this is often miles away from the job that user really does.<br><span class="segmentSeparator"></span>The usual solution to this problem is that the user requests the privileges that are needed to to a job.<br><span class="segmentSeparator"></span>Such request is then routed through appropriate approval process.<br><span class="segmentSeparator"></span>And that <em>request</em> is a big problem for ABAC.<br><span class="segmentSeparator"></span>What should the user request to get the privileges?<br><span class="segmentSeparator"></span>Should the user request a change in ABAC policy?<br><span class="segmentSeparator"></span>That would not be practical.<br><span class="segmentSeparator"></span>Should the user request a new value for an attribute?<br><span class="segmentSeparator"></span>Which attribute?<br><span class="segmentSeparator"></span>And what value that should be?<br><span class="segmentSeparator"></span>Can be somehow create a catalog of the things that a user can request?<br><span class="segmentSeparator"></span>Once again, ABAC is not designed for this.<br><span class="segmentSeparator"></span>But all those problems are very easy to solve in RBAC.<br><span class="segmentSeparator"></span>User is expected to request a role.<br><span class="segmentSeparator"></span>And it is quite easy to create a role catalog.<br><span class="segmentSeparator"></span>But as ABAC does not have roles, there is nothing that a user can get a grip on.<br><span class="segmentSeparator"></span>There is no "handle" that would allow the user to make sense from the ABAC policies.</p>
</div>
<div class="paragraph">
<p>This is all a consequence of yet another ABAC problem.<br><span class="segmentSeparator"></span>While ABAC policy may be easy to set up, it is quite difficult to analyze and maintain.<br><span class="segmentSeparator"></span>Which users are affected by this particular policy statement?<br><span class="segmentSeparator"></span>How many users will be affected if I make this change to ABAC policy?<br><span class="segmentSeparator"></span>ABAC systems would need a complex simulation algorithms to answer those questions.<br><span class="segmentSeparator"></span>However, it is all quite trivial in RBAC.<br><span class="segmentSeparator"></span>Policies are encapsulated into roles.<br><span class="segmentSeparator"></span>Therefore only the users that have those roles are affected.<br><span class="segmentSeparator"></span>The roles also divide the policy to a smaller, manageable pieces.<br><span class="segmentSeparator"></span>Each of the roles can have its own state and lifecycle.<br><span class="segmentSeparator"></span>Therefore it is not that difficult to work with two versions of the same role at the same time.<br><span class="segmentSeparator"></span>Old version is still assigned to some users, but we are deprecating that and slowly migrating to a new version.<br><span class="segmentSeparator"></span>Such continuous processes are difficult to do in ABAC.</p>
</div>
<div class="paragraph">
<p>And there is still one crucial problem when ABAC is used in provisioning scenarios.<br><span class="segmentSeparator"></span>ABAC policies often benefit from the fact that complete data about the user accessing the system are available when the access control decision is made.<br><span class="segmentSeparator"></span>The crucial part of that data is called <em>context</em>.<br><span class="segmentSeparator"></span>This includes data such as time of day, network location of the user, recent events related to the user, real-time estimate of the risk and so on.<br><span class="segmentSeparator"></span>However, such data are simply not available in provisioning scenarios.<br><span class="segmentSeparator"></span>Accounts are usually provisioned long before the first access to the account is made.<br><span class="segmentSeparator"></span>Therefore, many of the advantages of ABAC are useless in identity management scenarios that rely on provisioning.</p>
</div>
<div class="paragraph">
<p>However, ABAC is not a complete failure.<br><span class="segmentSeparator"></span>ABAC is very useful in customer-oriented identity and access management (CIAM).<br><span class="segmentSeparator"></span>Customer identities are usually "lightweight" and the policies are simple.<br><span class="segmentSeparator"></span>But when there is a need to manage employees, teachers, contractors and similar "heavyweight" identities then ABAC almost always fails.</p>
</div>
<div class="paragraph">
<p>The fact that ABAC fails in complex practical IDM deployments does not mean that RBAC is ideal.<br><span class="segmentSeparator"></span>Quite the contrary.<br><span class="segmentSeparator"></span>RBAC has problems of its own and the applicability of pure RBAC in practical IDM deployments is very limited.<br><span class="segmentSeparator"></span>Many of the problems of RBAC model motivated engineers to develop ABAC and similar models.<br><span class="segmentSeparator"></span>In fact, the "algorithmic" idea of ABAC is not entirely bad.<br><span class="segmentSeparator"></span>Only if we had a way how to combine ABAC and RBAC …​ Oh, but there is a way!
We did it already.</p>
</div>
<div class="paragraph">
<p>MidPoint combines RBAC and ABAC by putting expressions into roles.<br><span class="segmentSeparator"></span>We have seen that already.<br><span class="segmentSeparator"></span>When role is assigned, the expressions in the role gets evaluated.<br><span class="segmentSeparator"></span>And there can be any complex algorithm in the expression, even a complete ABAC policy.<br><span class="segmentSeparator"></span>At least in theory.<br><span class="segmentSeparator"></span>MidPoint expressions do not make access control decisions, because it is not the job of an IDM system to make such decisions.<br><span class="segmentSeparator"></span>IDM system should set up the account.<br><span class="segmentSeparator"></span>It provides the "material" for an authorization system to make a correct decisions.<br><span class="segmentSeparator"></span>Therefore, midPoint goes as close to ABAC as a provisioning system can go.<br><span class="segmentSeparator"></span>In an extreme case the entire ABAC policy can be implemented in outbound expressions in resource definition.<br><span class="segmentSeparator"></span>But there is a good reason nobody does that.</p>
</div>
<div class="paragraph">
<p>Dividing the policy into smaller parts brings substantial advantage.<br><span class="segmentSeparator"></span>Therefore many midPoint deployments are very RBAC-like.<br><span class="segmentSeparator"></span>There are many roles and rich role hierarchies.<br><span class="segmentSeparator"></span>Role expressions are used in moderation.<br><span class="segmentSeparator"></span>But there are also deployments that are using parametric roles and role expressions extensively.<br><span class="segmentSeparator"></span>In such cases there is a smaller number of roles, almost no role hierarchy, but the roles are smarter.<br><span class="segmentSeparator"></span>Those are more ABAC-like deployments.<br><span class="segmentSeparator"></span>But roles are still there.<br><span class="segmentSeparator"></span>The roles act as "handles" for users to understand the policies, to give names to relevant parts of the policy.<br><span class="segmentSeparator"></span>This combined approach works surprisingly well.</p>
</div>
<div class="paragraph">
<p>Of course, this idea is not new.<br><span class="segmentSeparator"></span>Many RBAC-like systems use some kind of "smart" behavior inside the roles.<br><span class="segmentSeparator"></span>However, so far we haven’t seen anything as comprehensive as midPoint role-based access control model.<br><span class="segmentSeparator"></span>Therefore we had to invent an impressive marketing name for our creation.<br><span class="segmentSeparator"></span>Due to a momentary lapse of imagination we dubbed it Advanced Hybrid RBAC.<br><span class="segmentSeparator"></span>But whatever you choose to call it, the fact is that this approach is very useful in practice.<br><span class="segmentSeparator"></span>It can transform apparent chaos into something that can be efficiently managed.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="08-obhject-templates">8.<br><span class="segmentSeparator"></span>Object Templates</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
Scientists study the world as it is; engineers create the world that has never been.<br><span class="segmentSeparator"></span></blockquote>
<div class="attribution">
— Theodore von Kármán
</div>
</div>
<div class="paragraph">
<p>Identity management systems are often seen as integration engines that move data from one system to another system.<br><span class="segmentSeparator"></span>This is indeed a very important part of the identity management functionality.<br><span class="segmentSeparator"></span>But the things identity management systems do <em>internally</em> are crucial to all identity management deployments - especially those that deal with identity governance and compliance.</p>
</div>
<div class="paragraph">
<p>MidPoint does quite a lot of things that may not be entirely obvious on the outside.<br><span class="segmentSeparator"></span>There are rules to apply, processes to drive, policies to enforce and so on.<br><span class="segmentSeparator"></span>Those things are gaining utter importance at that strange boundary where identity management becomes identity governance.<br><span class="segmentSeparator"></span>There are complex and very powerful mechanisms allowing midPoint to implement identity governance.<br><span class="segmentSeparator"></span>But more on that later.<br><span class="segmentSeparator"></span>We need to start with simple things.<br><span class="segmentSeparator"></span>And the simplest of those internal mechanisms is the functionality of <em>object template</em>.</p>
</div>
<div class="sect2">
<h3 id="_object_templates">Object Templates</h3>
<div class="paragraph">
<p>Data that come to midPoint are seldom complete and clean.<br><span class="segmentSeparator"></span>Quite the contrary.<br><span class="segmentSeparator"></span>The data that come from the "feeds" are often incomplete, they are not very precise and sometimes several sources may not even agree on a value for a particular data item.<br><span class="segmentSeparator"></span>Inbound mappings can be used to sort out some of these problems.<br><span class="segmentSeparator"></span>However, inbound mappings are designed to work in isolation.<br><span class="segmentSeparator"></span>They work only for one particular resource.<br><span class="segmentSeparator"></span>But it is often needed to gather data from several resources and then look at all of them at once.<br><span class="segmentSeparator"></span>Inbound mappings cannot do that as they are tied to a particular resource.<br><span class="segmentSeparator"></span>However, they can be used to gather all the relevant data in the user object.<br><span class="segmentSeparator"></span>And then we can use some kind of a mechanism to have a look at user object when those data are gathered together.<br><span class="segmentSeparator"></span>That is what object templates do.</p>
</div>
<div class="paragraph">
<p>Simply speaking, <em>object template</em> is a set of mappings that is applied to a particular midPoint object.<br><span class="segmentSeparator"></span>For example, user template is applied to all user objects.<br><span class="segmentSeparator"></span>The mappings in the object template can produce new values for the object.<br><span class="segmentSeparator"></span>For instance, a very typical use of object template is computation of user’s full name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">22f83022-b76d-11e9-8a30-6ffc11b23016</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>User Template<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;item&gt;</span>
        <span class="tag">&lt;ref&gt;</span>fullName<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;mapping&gt;</span>
            <span class="tag">&lt;strength&gt;</span>weak<span class="tag">&lt;/strength&gt;</span>
            <span class="tag">&lt;source&gt;</span>
                <span class="tag">&lt;path&gt;</span>givenName<span class="tag">&lt;/path&gt;</span>
            <span class="tag">&lt;/source&gt;</span>
            <span class="tag">&lt;source&gt;</span>
                <span class="tag">&lt;path&gt;</span>familyName<span class="tag">&lt;/path&gt;</span>
            <span class="tag">&lt;/source&gt;</span>
            <span class="tag">&lt;expression&gt;</span>
                <span class="tag">&lt;script&gt;</span>
<span class="inline">                    <span class="tag">&lt;code&gt;</span>
                        givenName + ' ' + familyName
                    <span class="tag">&lt;/code&gt;</span></span>
                <span class="tag">&lt;/script&gt;</span>
            <span class="tag">&lt;/expression&gt;</span>
        <span class="tag">&lt;/mapping&gt;</span>
    <span class="tag">&lt;/item&gt;</span>
<span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The mapping above will compute the value of user’s <code>fullName</code> property from <code>givenName</code> and <code>familyName</code> by using a simple Groovy expression.<br><span class="segmentSeparator"></span>It is a weak mapping, therefore it will compute the full name only in case that it is not present already.</p>
</div>
<div class="paragraph">
<p>Object template can be used to do variety of things to all kinds of midPoint objects.<br><span class="segmentSeparator"></span>This chapter will cover the most important functionality of object templates.</p>
</div>
<div class="paragraph">
<p>Importing an object template definition into midPoint will not do much.<br><span class="segmentSeparator"></span>The template will not be used just by being imported.<br><span class="segmentSeparator"></span>There can be several object templates for different types of objects, archetypes and even organizations.<br><span class="segmentSeparator"></span>MidPoint will not know how to use the template.<br><span class="segmentSeparator"></span>Therefore, the use of the template needs to be specified in a configuration.<br><span class="segmentSeparator"></span>The simplest and most common way to use an object template is to configure its use in the system configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;systemConfiguration&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;defaultObjectPolicyConfiguration&gt;</span>
        <span class="tag">&lt;type&gt;</span>UserType<span class="tag">&lt;/type&gt;</span>
              <span class="tag">&lt;objectTemplateRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">22f83022-b76d-11e9-8a30-6ffc11b23016</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/defaultObjectPolicyConfiguration&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/systemConfiguration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This configuration activates the object template for use by all object of <code>UserType</code> type.<br><span class="segmentSeparator"></span>Therefore this template will be applied to all midPoint users.</p>
</div>
<div class="paragraph">
<p>User template is applied every time an object is changed or explicitly recomputed (e.g.<br><span class="segmentSeparator"></span>on reconciliation).<br><span class="segmentSeparator"></span>User template is applied after all the inbound mappings are processed.<br><span class="segmentSeparator"></span>Inbound mappings often copy important data to the focal objects (e.g.<br><span class="segmentSeparator"></span>user objects).<br><span class="segmentSeparator"></span>Therefore, the template can work on a data that are summarized from all the resources.</p>
</div>
</div>
<div class="sect2">
<h3 id="_item_definitions_in_object_template">Item Definitions In Object Template</h3>
<div class="paragraph">
<p>We have already seen how object template can be used to apply mappings on particular items of midPoint objects.<br><span class="segmentSeparator"></span>But object template can also do other tricks.<br><span class="segmentSeparator"></span>We will have a look at some of them here.</p>
</div>
<div class="paragraph">
<p>The processing of an object template is almost always focused on particular items of an object.<br><span class="segmentSeparator"></span>Therefore, almost all of the object template functionality is located in item element that references a particular item by its path:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">22f83022-b76d-11e9-8a30-6ffc11b23016</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>User Template<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;item&gt;</span>
        <span class="tag">&lt;ref&gt;</span>fullName<span class="tag">&lt;/ref&gt;</span>
        ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;/item&gt;</span>
    <span class="tag">&lt;item&gt;</span>
        <span class="tag">&lt;ref&gt;</span>assignment<span class="tag">&lt;/ref&gt;</span>
        ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;/item&gt;</span>
<span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The most common use of object template is to run mappings on items, such as the mapping to determine user’s full name above.<br><span class="segmentSeparator"></span>Target of the mapping is automatically set to the item for which it is specified.<br><span class="segmentSeparator"></span>Sources of the mapping need to be defined explicitly.<br><span class="segmentSeparator"></span>But the basic idea is, that the user template should take properties of user as inputs.<br><span class="segmentSeparator"></span>In other words, user template works on the same user object both as input and output.</p>
</div>
<div class="paragraph">
<p>Object template mappings often use static (literal) values or a very simple expressions, but mapping conditions are used to control application of the value.<br><span class="segmentSeparator"></span>The easiest way to explain this is to use a simple example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;item&gt;</span>
        <span class="tag">&lt;ref&gt;</span>description<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;mapping&gt;</span>
            <span class="tag">&lt;source&gt;</span>
                <span class="tag">&lt;path&gt;</span>extension/hatSize<span class="tag">&lt;/path&gt;</span>
            <span class="tag">&lt;/source&gt;</span>
            <span class="tag">&lt;expression&gt;</span>
                <span class="tag">&lt;value&gt;</span>WARNING: Big brain!<span class="tag">&lt;/value&gt;</span>
            <span class="tag">&lt;/expression&gt;</span>
            <span class="tag">&lt;condition&gt;</span>
                <span class="tag">&lt;script&gt;</span>
<span class="inline">                    <span class="tag">&lt;code&gt;</span>hatSize <span class="entity">&amp;gt;</span> 60<span class="tag">&lt;/code&gt;</span></span>
                <span class="tag">&lt;/script&gt;</span>
            <span class="tag">&lt;/condition&gt;</span>
        <span class="tag">&lt;/mapping&gt;</span>
    <span class="tag">&lt;/item&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This mapping works for <code>description</code> property of the user.<br><span class="segmentSeparator"></span>The mapping sets a fixed warning text specified as text literal in the mapping by using value expression evaluator.<br><span class="segmentSeparator"></span>However, the mapping is not setting that value for all the objects.<br><span class="segmentSeparator"></span>The mapping is applied only for objects that satisfy the condition.<br><span class="segmentSeparator"></span>The condition is set to trigger for all the users that have hat size larger than 60.</p>
</div>
<div class="paragraph">
<p>However, mappings are made to be relativistic.<br><span class="segmentSeparator"></span>This means that mappings react to changes.<br><span class="segmentSeparator"></span>The same principle applies to mapping conditions.<br><span class="segmentSeparator"></span>They are also relativistic.<br><span class="segmentSeparator"></span>Therefore the mapping reacts to changes in the condition state.<br><span class="segmentSeparator"></span>When user’s head grows and the hat size changes to a value over 60, then the mapping will add the warning.<br><span class="segmentSeparator"></span>When the user’s head shrinks, then the warning disappears.</p>
</div>
<div class="paragraph">
<p>It may look that this mechanism is too complicated, if you look at single-valued properties only.<br><span class="segmentSeparator"></span>But it all starts to make sense in case of multi-value items.<br><span class="segmentSeparator"></span>Such as the assignments.<br><span class="segmentSeparator"></span>But more on that in the next section.</p>
</div>
<div class="paragraph">
<p>While mappings are the things that object template does almost all the time, the template can also do other interesting things.<br><span class="segmentSeparator"></span>First of all, object template can tweak the schema.<br><span class="segmentSeparator"></span>MidPoint comes with a rich schema that is prepared to be used.<br><span class="segmentSeparator"></span>However, the schema is not a perfect fit for all the deployments.<br><span class="segmentSeparator"></span>Previous chapter described a method to extend the schema.<br><span class="segmentSeparator"></span>But what we should do if we want to change the built-in schema of midPoint?<br><span class="segmentSeparator"></span>Yes, object template is the right answer.<br><span class="segmentSeparator"></span>The <code>item</code> specification can be used to modify the way how midPoint applies the schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;item&gt;</span>
        <span class="tag">&lt;ref&gt;</span>givenName<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;displayName&gt;</span>First Name<span class="tag">&lt;/displayName&gt;</span>
    <span class="tag">&lt;/item&gt;</span>
    <span class="tag">&lt;item&gt;</span>
        <span class="tag">&lt;ref&gt;</span>additionalName<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;displayName&gt;</span>Middle Name<span class="tag">&lt;/displayName&gt;</span>
    <span class="tag">&lt;/item&gt;</span>
    <span class="tag">&lt;item&gt;</span>
        <span class="tag">&lt;ref&gt;</span>familyName<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;displayName&gt;</span>Last Name<span class="tag">&lt;/displayName&gt;</span>
    <span class="tag">&lt;/item&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The "additional name" is a nice and generic term that can fit many cultural environment.<br><span class="segmentSeparator"></span>But it is not very usual or intuitive in cultures that are not used to it (which means all the cultures).<br><span class="segmentSeparator"></span>Therefore, almost all midPoint deployments that chose to use this property would like to rename it to something that feels more natural.<br><span class="segmentSeparator"></span>Similarly for "given name" and "family name".<br><span class="segmentSeparator"></span>We have expected that and object template can be used to modify some aspects of built-in schema.</p>
</div>
<div class="paragraph">
<p>Object template can also be used to override object multiplicity, especially to change mandatory item into optional.<br><span class="segmentSeparator"></span>MidPoint insists on having name set for all the users.<br><span class="segmentSeparator"></span>But we may be able to compute a name from other properties, such as other user names, employee number or other identifiers, if we don’t want to present name item as mandatory in the user interface.<br><span class="segmentSeparator"></span>We can compute the value of user’s full name from given name and family name.<br><span class="segmentSeparator"></span>Therefore user may leave full name blank in the user interface.<br><span class="segmentSeparator"></span>But user interface is driven by the schema.<br><span class="segmentSeparator"></span>As name is mandatory in the schema, also the user interface will insist that the name field should be filled in.<br><span class="segmentSeparator"></span>But this can be changed in the object template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;item&gt;</span>
        <span class="tag">&lt;ref&gt;</span>name<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;limitations&gt;</span>
            <span class="tag">&lt;layer&gt;</span>presentation<span class="tag">&lt;/layer&gt;</span>
            <span class="tag">&lt;minOccurs&gt;</span>0<span class="tag">&lt;/minOccurs&gt;</span>
        <span class="tag">&lt;/limitations&gt;</span>
        <span class="tag">&lt;mapping&gt;</span>
            ...<br><span class="segmentSeparator"></span>        <span class="tag">&lt;/mapping&gt;</span>
    <span class="tag">&lt;/item&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This configuration will make the name optional for the <em>presentation</em> purposes.<br><span class="segmentSeparator"></span>This means that the user interface will treat <code>name</code> as optional.<br><span class="segmentSeparator"></span>But core midPoint engine will still require the <code>name</code> to have a value.<br><span class="segmentSeparator"></span>This gives object template a chance to generate the value for <code>name</code>.<br><span class="segmentSeparator"></span>However, this means that <code>name</code> will still be present as read-write item in the user interface.<br><span class="segmentSeparator"></span>We do not want that as <code>name</code> is supposed to be immutable identifier.<br><span class="segmentSeparator"></span>We want to present <code>name</code> as read-only item.<br><span class="segmentSeparator"></span>This can also be achieved by object template by using access configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;item&gt;</span>
        <span class="tag">&lt;ref&gt;</span>name<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;limitations&gt;</span>
            <span class="tag">&lt;layer&gt;</span>presentation<span class="tag">&lt;/layer&gt;</span>
            <span class="tag">&lt;minOccurs&gt;</span>0<span class="tag">&lt;/minOccurs&gt;</span>
            <span class="tag">&lt;access&gt;</span>
                <span class="tag">&lt;read&gt;</span>true<span class="tag">&lt;/read&gt;</span>
                <span class="tag">&lt;add&gt;</span>false<span class="tag">&lt;/add&gt;</span>
                <span class="tag">&lt;modify&gt;</span>false<span class="tag">&lt;/modify&gt;</span>
            <span class="tag">&lt;/access&gt;</span>
        <span class="tag">&lt;/limitations&gt;</span>
        <span class="tag">&lt;mapping&gt;</span>
            ...<br><span class="segmentSeparator"></span>        <span class="tag">&lt;/mapping&gt;</span>
    <span class="tag">&lt;/item&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Even immutable identifiers may need to change occasionally.<br><span class="segmentSeparator"></span>There may be a bug in the identifier generator.<br><span class="segmentSeparator"></span>Or some identifier has to change manually to adjust to the reality.<br><span class="segmentSeparator"></span>Theoretically, every piece of the solution should play by the rules.<br><span class="segmentSeparator"></span>But we know that rules have exceptions in the practice.<br><span class="segmentSeparator"></span>Therefore, privileged users such as system administrator should be able to change the identifiers if really needed.<br><span class="segmentSeparator"></span>The proper way how to do this would be to use authorizations and not object template.<br><span class="segmentSeparator"></span>But we do not know how to use authorizations yet.<br><span class="segmentSeparator"></span>Therefore this solution will have to do for now.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Object template can be used to adjust how midPoint user interface interprets the schema.<br><span class="segmentSeparator"></span>But perhaps the most extreme measure is to eliminate certain item entirely.<br><span class="segmentSeparator"></span>In fact, this happens quite often.<br><span class="segmentSeparator"></span>MidPoint schema is rich and many deployments do not use all the items in midPoint schema.<br><span class="segmentSeparator"></span>It makes little sense to present the items that are not used, therefore there is a way to tell midPoint that we want to completely ignore an item:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;item&gt;</span>
        <span class="tag">&lt;ref&gt;</span>employeeNumber<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;limitations&gt;</span>
            <span class="tag">&lt;layer&gt;</span>presentation<span class="tag">&lt;/layer&gt;</span>
            <span class="tag">&lt;processing&gt;</span>ignore<span class="tag">&lt;/processing&gt;</span>
        <span class="tag">&lt;/limitations&gt;</span>
    <span class="tag">&lt;/item&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Object template can be used to do further tricks.<br><span class="segmentSeparator"></span>It can be used to associate value enumeration with an item, e.g.<br><span class="segmentSeparator"></span>to apply lookup table to a particular item.<br><span class="segmentSeparator"></span>Object templates can be used to set up a validation expression for items.<br><span class="segmentSeparator"></span>And a couple of other things.<br><span class="segmentSeparator"></span>But more on that later.</p>
</div>
</div>
<div class="sect2">
<h3 id="_automatic_role_assignment_in_object_template">Automatic Role Assignment in Object Template</h3>
<div class="paragraph">
<p>Object templates are very flexible and they can be used for a lot of different things.<br><span class="segmentSeparator"></span>But there is one particular usage of object template that appears in almost every deployment.<br><span class="segmentSeparator"></span>It is an ability to automatically assign roles.</p>
</div>
<div class="paragraph">
<p>The basic idea is quite simple.<br><span class="segmentSeparator"></span>An assignment is just an ordinary item.<br><span class="segmentSeparator"></span>If we use object template mapping to populate that item with appropriate value, we will get automatic assignment of roles.<br><span class="segmentSeparator"></span>Like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;item&gt;</span>
        <span class="tag">&lt;ref&gt;</span>assignment<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;mapping&gt;</span>
            ...<br><span class="segmentSeparator"></span>        <span class="tag">&lt;/mapping&gt;</span>
    <span class="tag">&lt;/item&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The trick here is to set up the mapping correctly.<br><span class="segmentSeparator"></span>The simplest case is an conditional assignment of a role.<br><span class="segmentSeparator"></span>Let’s suppose that we want to assign a Hatter role to everybody that has provided a hat size in user profile.<br><span class="segmentSeparator"></span>We already know what to do, don’t we?<br><span class="segmentSeparator"></span>Let’s use mapping condition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">c38a5e6e-b783-11e9-b82f-ebb94fb5b6ec</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Hatter<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/role&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;item&gt;</span>
        <span class="tag">&lt;ref&gt;</span>assignment<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;mapping&gt;</span>
            <span class="tag">&lt;source&gt;</span>
                <span class="tag">&lt;path&gt;</span>extension/hatSize<span class="tag">&lt;/path&gt;</span>
            <span class="tag">&lt;/source&gt;</span>
            <span class="tag">&lt;expression&gt;</span>
                <span class="tag">&lt;value&gt;</span>
                    <span class="tag">&lt;targetRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">c38a5e6e-b783-11e9-b82f-ebb94fb5b6ec</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">RoleType</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;/value&gt;</span>
            <span class="tag">&lt;/expression&gt;</span>
            <span class="tag">&lt;condition&gt;</span>
                <span class="tag">&lt;script&gt;</span>
<span class="inline">                    <span class="tag">&lt;code&gt;</span>hatSize as Boolean<span class="tag">&lt;/code&gt;</span></span>
                <span class="tag">&lt;/script&gt;</span>
            <span class="tag">&lt;/condition&gt;</span>
        <span class="tag">&lt;/mapping&gt;</span>
    <span class="tag">&lt;/item&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Simple, isn’t it?<br><span class="segmentSeparator"></span>The <code>value</code> part in the expression is an inside of a new assignment to create.<br><span class="segmentSeparator"></span>And the assignment will be created on a condition that <code>hatSize</code> has a non-null, non-empty and non-zero value (that is a built-in evaluation of booleans in Groovy).<br><span class="segmentSeparator"></span>The real trick here is the relativity of mapping conditions.<br><span class="segmentSeparator"></span>Assignments are multi-valued.<br><span class="segmentSeparator"></span>Therefore it is important to know when to add a value and when to remove one.<br><span class="segmentSeparator"></span>MidPoint evaluates the condition twice.<br><span class="segmentSeparator"></span>The condition is evaluated for an object before a change is applied (old object) first.<br><span class="segmentSeparator"></span>The the condition is evaluated for an object after the change is applied (new object) once again.<br><span class="segmentSeparator"></span>When the condition changes from <code>false</code> to <code>true</code>, <code>Hatter</code> role is assigned.<br><span class="segmentSeparator"></span>When the condition changes from <code>true</code> to <code>false</code>, <code>Hatter</code> role is unassigned.<br><span class="segmentSeparator"></span>Other assignments values are not changed by this mapping.<br><span class="segmentSeparator"></span>Therefore many assignment mappings can happily coexist.</p>
</div>
<div class="paragraph">
<p>However, this is a very simple case.<br><span class="segmentSeparator"></span>Typical midPoint deployments will have many roles.<br><span class="segmentSeparator"></span>It is theoretically possible to create mappings like this for each and every role that has to be assigned automatically.<br><span class="segmentSeparator"></span>But that would be a lot of repetitive work.<br><span class="segmentSeparator"></span>And even worse, it is likely to become a major maintenance nightmare in the future.<br><span class="segmentSeparator"></span>We are creative people and we do not really like repetitive work.<br><span class="segmentSeparator"></span>And we really hate maintenance nightmares.<br><span class="segmentSeparator"></span>Therefore it is perhaps no big surprise that there is a better way to do this.</p>
</div>
<div class="paragraph">
<p>The most common use case for automatic role assignment is to look up the role using some of its properties.<br><span class="segmentSeparator"></span>For example, let’s have suppose that our HR system provides job codes for our employees.<br><span class="segmentSeparator"></span>Therefore we have extended midPoint schema with a custom property <code>jobCode</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;xsd:schema</span> <span class="attribute-name">targetNamespace</span>=<span class="string"><span class="delimiter">"</span><span class="content">http://example.com/xml/ns/midpoint/schema</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;xsd:complexType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">UserTypeExtensionType</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;xsd:annotation&gt;</span>
            <span class="tag">&lt;xsd:appinfo&gt;</span>
                <span class="tag">&lt;a:extension</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">"</span><span class="content">c:UserType</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/xsd:appinfo&gt;</span>
        <span class="tag">&lt;/xsd:annotation&gt;</span>
        <span class="tag">&lt;xsd:sequence&gt;</span>
            ...<br><span class="segmentSeparator"></span>            <span class="tag">&lt;xsd:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">jobCode</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">xsd:string</span><span class="delimiter">"</span></span>
                         <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">"</span><span class="content">0</span><span class="delimiter">"</span></span> <span class="attribute-name">maxOccurs</span>=<span class="string"><span class="delimiter">"</span><span class="content">1</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>

            ...<br><span class="segmentSeparator"></span>        <span class="tag">&lt;/xsd:sequence&gt;</span>
    <span class="tag">&lt;/xsd:complexType&gt;</span>
<span class="tag">&lt;/xsd:schema&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A user object that is created from an HR record looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;user&gt;</span>
    <span class="tag">&lt;name&gt;</span>bob<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;extension&gt;</span>
        <span class="tag">&lt;exmpl:jobCode&gt;</span>S007<span class="tag">&lt;/exmpl:jobCode&gt;</span>
    <span class="tag">&lt;/extension&gt;</span>
    <span class="tag">&lt;fullName&gt;</span>Bob Brown<span class="tag">&lt;/fullName&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/user&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The we do similar extension for roles.<br><span class="segmentSeparator"></span>We extend role schema with custom <code>autoassignJobCode</code> property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;xsd:schema</span> <span class="attribute-name">targetNamespace</span>=<span class="string"><span class="delimiter">"</span><span class="content">http://example.com/xml/ns/midpoint/schema</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;xsd:complexType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">RoleTypeExtensionType</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;xsd:annotation&gt;</span>
            <span class="tag">&lt;xsd:appinfo&gt;</span>
                <span class="tag">&lt;a:extension</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">"</span><span class="content">c:RoleType</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/xsd:appinfo&gt;</span>
        <span class="tag">&lt;/xsd:annotation&gt;</span>
        <span class="tag">&lt;xsd:sequence&gt;</span>
            ...<br><span class="segmentSeparator"></span>            <span class="tag">&lt;xsd:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">autoassignJobCode</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">xsd:string</span><span class="delimiter">"</span></span>
                         <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">"</span><span class="content">0</span><span class="delimiter">"</span></span> <span class="attribute-name">maxOccurs</span>=<span class="string"><span class="delimiter">"</span><span class="content">1</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>

            ...<br><span class="segmentSeparator"></span>        <span class="tag">&lt;/xsd:sequence&gt;</span>
    <span class="tag">&lt;/xsd:complexType&gt;</span>
<span class="tag">&lt;/xsd:schema&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And then we set up the roles:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">a1572de4-b9b9-11e9-af3e-5f68b3207f97</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Sales Manager<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;extension&gt;</span>
        <span class="tag">&lt;exmpl:autoassignJobCode&gt;</span>S006<span class="tag">&lt;/exmpl:autoassignJobCode&gt;</span>
    <span class="tag">&lt;/extension&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/role&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">b93af850-b9b9-11e9-8c2c-dfb9a89635a0</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Sales Agent<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;extension&gt;</span>
        <span class="tag">&lt;exmpl:autoassignJobCode&gt;</span>S007<span class="tag">&lt;/exmpl:autoassignJobCode&gt;</span>
    <span class="tag">&lt;/extension&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/role&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">b9d2b604-b9b9-11e9-bbc4-17d8e85623b4</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Sales Assistant<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;extension&gt;</span>
        <span class="tag">&lt;exmpl:autoassignJobCode&gt;</span>S008<span class="tag">&lt;/exmpl:autoassignJobCode&gt;</span>
    <span class="tag">&lt;/extension&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/role&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We are almost there.<br><span class="segmentSeparator"></span>The final part of this puzzle is an object template mapping that automatically assigns the roles according to job code.<br><span class="segmentSeparator"></span>Naive solution would be to create one mapping for each job code.<br><span class="segmentSeparator"></span>But we do not want that.<br><span class="segmentSeparator"></span>We want something smarter.<br><span class="segmentSeparator"></span>We want a single mapping that can work for all these roles.<br><span class="segmentSeparator"></span>Such mapping needs to dynamically look up the role when it is evaluated.<br><span class="segmentSeparator"></span>It is certainly possible to create such mapping in Groovy script.<br><span class="segmentSeparator"></span>But that is not entirely straightforward.<br><span class="segmentSeparator"></span>And in fact, this use case is a very common one.<br><span class="segmentSeparator"></span>Role autoassignment is a part of almost every IDM solution in one form or another.<br><span class="segmentSeparator"></span>Therefore we have created a special expression evaluator to make this job easy.<br><span class="segmentSeparator"></span>Enter <code>assignmentTargetSearch</code> expression evaluator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;item&gt;</span>
        <span class="tag">&lt;ref&gt;</span>assignment<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;mapping&gt;</span>
            <span class="tag">&lt;source&gt;</span>
                <span class="tag">&lt;path&gt;</span>extension/jobCode<span class="tag">&lt;/path&gt;</span>
            <span class="tag">&lt;/source&gt;</span>
            <span class="tag">&lt;expression&gt;</span>
                <span class="tag">&lt;assignmentTargetSearch&gt;</span>
                    <span class="tag">&lt;targetType&gt;</span>RoleType<span class="tag">&lt;/targetType&gt;</span>
                    <span class="tag">&lt;filter&gt;</span>
                        <span class="tag">&lt;q:equal&gt;</span>
                            <span class="tag">&lt;q:path&gt;</span>extension/autoassignJobCode<span class="tag">&lt;/q:path&gt;</span>
                            <span class="tag">&lt;expression&gt;</span>
                                <span class="tag">&lt;path&gt;</span>$jobCode<span class="tag">&lt;/path&gt;</span>
                            <span class="tag">&lt;/expression&gt;</span>
                        <span class="tag">&lt;/q:equal&gt;</span>
                    <span class="tag">&lt;/filter&gt;</span>
                <span class="tag">&lt;/assignmentTargetSearch&gt;</span>
            <span class="tag">&lt;/expression&gt;</span>
        <span class="tag">&lt;/mapping&gt;</span>
    <span class="tag">&lt;/item&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, is this how "easy job" looks in midPoint?<br><span class="segmentSeparator"></span>Yes, in fact, it is.<br><span class="segmentSeparator"></span>But do not panic.<br><span class="segmentSeparator"></span>Not yet.<br><span class="segmentSeparator"></span>It all makes perfect sense once it is explained.<br><span class="segmentSeparator"></span>The code above is a part of user template.<br><span class="segmentSeparator"></span>It is a mapping that is producing assignments.<br><span class="segmentSeparator"></span>This mapping has an ordinary source which is user’s <code>jobCode</code>.<br><span class="segmentSeparator"></span>This mapping also has an expression.<br><span class="segmentSeparator"></span>But that expression is somehow extraordinary.<br><span class="segmentSeparator"></span>It is not the usual <code>script</code>, <code>path</code> or <code>value</code>.<br><span class="segmentSeparator"></span>The expression evaluator is <code>assignmentTargetSearch</code>.<br><span class="segmentSeparator"></span>This is a special evaluator that looks for assignment target, creates a complete assignment from that target and provides that assignment as an output.<br><span class="segmentSeparator"></span>The interesting part here is the way how <code>assignmentTargetSearch</code> looks for assignment target.<br><span class="segmentSeparator"></span>First of all, there is a <code>targetType</code> clause, which tells the expression to look for roles as assignment target.<br><span class="segmentSeparator"></span>And then there is a search filter.<br><span class="segmentSeparator"></span>We have already seen midPoint search filters a couple of times, for example in a form of correlation expression.<br><span class="segmentSeparator"></span>This is yet another use for search filters.<br><span class="segmentSeparator"></span>In this case, the filter is used to look up appropriate role in midPoint repository.<br><span class="segmentSeparator"></span>The filter looks up the roles by the <code>autoassignJobCode</code> value.<br><span class="segmentSeparator"></span>But what value do we require here?<br><span class="segmentSeparator"></span>Static value such as <code>S007</code> will not really help as that means that we will need one mapping for each role.<br><span class="segmentSeparator"></span>We need to make this query dynamic and smarter.<br><span class="segmentSeparator"></span>You probably know the answer already as the same approach was used in correlation expressions.<br><span class="segmentSeparator"></span>We simply use an expression instead of static value.<br><span class="segmentSeparator"></span>In this case, we use path expression that point to <code>jobCode</code> variable.<br><span class="segmentSeparator"></span>Job code is a source for this mapping, therefore it will be present as a variable in all the expressions of the mapping.<br><span class="segmentSeparator"></span>So when the expression is processed for Bob then the final filter looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;filter&gt;</span>
    <span class="tag">&lt;q:equal&gt;</span>
        <span class="tag">&lt;q:path&gt;</span>extension/autoassignJobCode<span class="tag">&lt;/q:path&gt;</span>
        <span class="tag">&lt;q:value&gt;</span>S007<span class="tag">&lt;/q:value&gt;</span>
    <span class="tag">&lt;/q:equal&gt;</span>
<span class="tag">&lt;/filter&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That filter is used to look for a role.<br><span class="segmentSeparator"></span>The <code>Sales Agent</code> role is found.<br><span class="segmentSeparator"></span>And this roles is used to construct an assignment with the role as a target:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;assignment&gt;</span>
    <span class="tag">&lt;targetRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">b93af850-b9b9-11e9-8c2c-dfb9a89635a0</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">RoleType</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/assignment&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And that is it!
That assignment is added to the user object.<br><span class="segmentSeparator"></span>Which means that Bob has that role assigned now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;user&gt;</span>
    <span class="tag">&lt;name&gt;</span>bob<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;extension&gt;</span>
        <span class="tag">&lt;exmpl:jobCode&gt;</span>S007<span class="tag">&lt;/exmpl:jobCode&gt;</span>
    <span class="tag">&lt;/extension&gt;</span>
    <span class="tag">&lt;assignment&gt;</span>
        <span class="tag">&lt;targetRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">b93af850-b9b9-11e9-8c2c-dfb9a89635a0</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">RoleType</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/assignment&gt;</span>
    <span class="tag">&lt;fullName&gt;</span>Bob Brown<span class="tag">&lt;/fullName&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/user&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This single mapping will work for all the cases of all the current job codes and future job codes.<br><span class="segmentSeparator"></span>That is how we like it.</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Clever reader is surely amused at this point.<br><span class="segmentSeparator"></span>As you can see, we have put an expression into an expression, so now midPoint can evaluate while it evaluates.<br><span class="segmentSeparator"></span>There is an <code>assignmentTargetSearch</code> expression, inside that is a search filter and inside the search filter there is a path expression.<br><span class="segmentSeparator"></span>This is one of the basic tenets of midPoint philosophy: we reuse and combine the mechanisms that we already have.<br><span class="segmentSeparator"></span>The second expression could be any midPoint expression that makes sense here, e.g.<br><span class="segmentSeparator"></span>it could be a script.<br><span class="segmentSeparator"></span>The filter can be much more complex and it can have several expressions.<br><span class="segmentSeparator"></span>Full power of midPoint is at your disposal here.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Of course, this could all have been done with one smart groovy script instead of <code>assignmentTargetSearch</code> expression.<br><span class="segmentSeparator"></span>And if you prefer it that way, you are free to do it.<br><span class="segmentSeparator"></span>It will work.<br><span class="segmentSeparator"></span>But assignment is a complex data structure and <code>assignmentTargetSearch</code> makes work with that structure easier.<br><span class="segmentSeparator"></span>It can set up validity constraints, relation and other assignment details.<br><span class="segmentSeparator"></span>It can also create the target on demand in case the target is not found.<br><span class="segmentSeparator"></span>It is quite powerful.<br><span class="segmentSeparator"></span>But perhaps the most important detail is that <code>assignmentTargetSearch</code> expression implements the use cases that are common in almost every IDM deployment.<br><span class="segmentSeparator"></span>And that functionality is maintained and tested as a native part of midPoint.<br><span class="segmentSeparator"></span>Therefore, you can simply reuse it in every midPoint deployment instead of copying, adapting, testing and bugfixing one big groovy script over and over again.</p>
</div>
</div>
<div class="sect2">
<h3 id="_autoassignment_in_roles">Autoassignment in Roles</h3>
<div class="paragraph">
<p>Automatic assignment of roles in the object template is not the only option.<br><span class="segmentSeparator"></span>This is midPoint, therefore there are usually several ways to do the same thing.<br><span class="segmentSeparator"></span>For example, a mapping similar to that <code>assignmentTargetSearch</code> mapping used above can be used as an inbound mapping.<br><span class="segmentSeparator"></span>And there is yet another way.<br><span class="segmentSeparator"></span>Strictly speaking, this method has almost nothing to do with object template.<br><span class="segmentSeparator"></span>But as we are talking about role autoassignment, this is a good opportunity to cover all the options here.</p>
</div>
<div class="paragraph">
<p>The statements that control automatic assignment of roles can be placed in the roles themselves:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">9f6add7c-b9bf-11e9-abf6-2348fcd328f1</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Cook<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;autoassign&gt;</span>
        <span class="tag">&lt;enabled&gt;</span>true<span class="tag">&lt;/enabled&gt;</span>
        <span class="tag">&lt;focus&gt;</span>
            <span class="tag">&lt;mapping&gt;</span>
                <span class="tag">&lt;source&gt;</span>
                    <span class="tag">&lt;path&gt;</span>organizationalUnit<span class="tag">&lt;/path&gt;</span>
                <span class="tag">&lt;/source&gt;</span>
                <span class="tag">&lt;condition&gt;</span>
                    <span class="tag">&lt;script&gt;</span>
<span class="inline">                        <span class="tag">&lt;code&gt;</span>
                            organizationalUnit?.norm == 'kitchen'
                        <span class="tag">&lt;/code&gt;</span></span>
                    <span class="tag">&lt;/script&gt;</span>
                <span class="tag">&lt;/condition&gt;</span>
            <span class="tag">&lt;/mapping&gt;</span>
        <span class="tag">&lt;/focus&gt;</span>
    <span class="tag">&lt;/autoassign&gt;</span>
<span class="tag">&lt;/role&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The mapping in the <code>autoassign</code> part of the role will be evaluated approximately at the same time as other object template mappings.<br><span class="segmentSeparator"></span>The mapping has no expression.<br><span class="segmentSeparator"></span>There is no need to.<br><span class="segmentSeparator"></span>MidPoint will prepare complete assignment data structure.<br><span class="segmentSeparator"></span>The mapping just has to decide when to apply that assignment to the user and when not to apply it.<br><span class="segmentSeparator"></span>That is what the condition is for.<br><span class="segmentSeparator"></span>The expression in this mapping is optional.<br><span class="segmentSeparator"></span>If an expression is specified, then such expression can be used to further set up the assignment.<br><span class="segmentSeparator"></span>For example, it can set assignment activation, relation, parameters and so on.</p>
</div>
<div class="paragraph">
<p>But wait, why is there this strange <code>norm</code> thing in the condition?<br><span class="segmentSeparator"></span>Remember about Polystrings?<br><span class="segmentSeparator"></span>The <code>organizationalUnit</code> property is a polystring.<br><span class="segmentSeparator"></span>Therefore it has <code>orig</code> part and <code>norm</code> part.<br><span class="segmentSeparator"></span>In this case we want to compare the <code>norm</code> part, as the organizational unit name may spelled as <code>Kitchen</code> or <code>KITCHEN</code>.<br><span class="segmentSeparator"></span>But in all those cases the <code>norm</code> part will be <code>kitchen</code>.</p>
</div>
<div class="paragraph">
<p>If fact, there is little trap for the unwary here.<br><span class="segmentSeparator"></span>The obvious way to specify the expression would be like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">organizationalUnit == <span class="string"><span class="delimiter">'</span><span class="content">kitchen</span><span class="delimiter">'</span></span>       <span class="comment">// This is wrong!</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>However, such expression will always return <code>false</code>.<br><span class="segmentSeparator"></span>The reason is that different data types are being compared.<br><span class="segmentSeparator"></span>The <code>organizationalUnit</code> property is polystring, while <code>‘kitchen’</code> is a string literal.<br><span class="segmentSeparator"></span>Polystring and string will never be equal regardless for their content.<br><span class="segmentSeparator"></span>Therefore this form of the expression is wrong.<br><span class="segmentSeparator"></span>Following forms may be used instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">organizationalUnit?.orig == <span class="string"><span class="delimiter">'</span><span class="content">Kitchen</span><span class="delimiter">'</span></span>
organizationalUnit?.norm == <span class="string"><span class="delimiter">'</span><span class="content">kitchen</span><span class="delimiter">'</span></span>
basic.stringify(organizationalUnit) == <span class="string"><span class="delimiter">'</span><span class="content">Kitchen</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The later form is using <code>stringify()</code> method from basic midPoint function library.<br><span class="segmentSeparator"></span>This method converts everything to string.<br><span class="segmentSeparator"></span>Whatever data type is passed to this method the result is always a string that can be safely compared.</p>
</div>
<div class="paragraph">
<p>But let’s get back to role autoassignment.<br><span class="segmentSeparator"></span>When autoassign mappings are specified in the roles, midPoint will process in a way that is very similar to object template mappings.<br><span class="segmentSeparator"></span>This has benefits, but there are also drawbacks.</p>
</div>
<div class="paragraph">
<p>The benefit of role autoassignment is manageability.<br><span class="segmentSeparator"></span>The conditions are stored in roles themselves.<br><span class="segmentSeparator"></span>Therefore they are bound to the object that they assign.<br><span class="segmentSeparator"></span>It is there, right in front of administrator’s eyes.<br><span class="segmentSeparator"></span>It may also be a benefit if delegated administration is used.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>a role owner may manage role definition and the autoassignment condition in the same object.<br><span class="segmentSeparator"></span>However, in that case beware of the expressions.<br><span class="segmentSeparator"></span>MidPoint expressions are very powerful.<br><span class="segmentSeparator"></span>In fact, they are way too powerful for secure delegated administration.<br><span class="segmentSeparator"></span>Unconstrained midPoint expression can do pretty much anything.<br><span class="segmentSeparator"></span>It can bring down the system, read memory, modify data, it can do whatever it likes to do.<br><span class="segmentSeparator"></span>There are some safeguards that prohibit against accidental abuse, but a malevolent expression can easily circumvent them.<br><span class="segmentSeparator"></span>If you allow a user to specify an expression, you are pretty much giving away keys to the kingdom.<br><span class="segmentSeparator"></span>Therefore do not do it.<br><span class="segmentSeparator"></span>At least not now.<br><span class="segmentSeparator"></span>There is a code in midPoint that implements expression profiles.<br><span class="segmentSeparator"></span>The goal of the profiles is to constraint expression to only allow safe operations.<br><span class="segmentSeparator"></span>However, that functionality is not finished yet.<br><span class="segmentSeparator"></span>If you are interested in this functionality, then midPoint platform subscription is the way to get it fully implemented.</p>
</div>
<div class="paragraph">
<p>Role autoassignment has another drawback and that is performance.<br><span class="segmentSeparator"></span>All the autoassignment mappings need to be evaluated every time that user is recomputed.<br><span class="segmentSeparator"></span>This means that all the roles that contain the mappings need to be retrieved from midPoint repository.<br><span class="segmentSeparator"></span>This may not be a big deal for a small deployment with thousands of users and hundreds of roles.<br><span class="segmentSeparator"></span>But the performance hit is likely to be significant as the number of users and roles grows.<br><span class="segmentSeparator"></span>Therefore, roles autoassignment is not enabled by default.<br><span class="segmentSeparator"></span>It has to be explicitly enabled in system configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;systemConfiguration&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;roleManagement&gt;</span>
        <span class="tag">&lt;autoassignEnabled&gt;</span>true<span class="tag">&lt;/autoassignEnabled&gt;</span>
    <span class="tag">&lt;/roleManagement&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/systemConfiguration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>But perhaps the most significant drawback of role autoassingment is that the mapping needs to be in every role.<br><span class="segmentSeparator"></span>There is no way how to use this mechanism to handle autoassignment of many roles with just one mapping.<br><span class="segmentSeparator"></span>But object template mappings can do that easily.<br><span class="segmentSeparator"></span>Therefore, many deployments chose to implement automatic assignment of roles by the means of object template or inbound mappings.</p>
</div>
</div>
<div class="sect2">
<h3 id="_iteration">Iteration</h3>
<div class="paragraph">
<p>There are some use cases that pop out in IDM solutions all the time.<br><span class="segmentSeparator"></span>One such case is the problem of finding a unique identifier.<br><span class="segmentSeparator"></span>This is a concern for almost any identifier, but it is particularly painful when it comes to usernames.<br><span class="segmentSeparator"></span>In midPoint world this means finding a value for name property.<br><span class="segmentSeparator"></span>This property much be unique for almost all the data types that midPoint supports.</p>
</div>
<div class="paragraph">
<p>The rational way would be to base usernames on something that is already unique and immutable such as employee numbers or student identifiers.<br><span class="segmentSeparator"></span>But those tend to be long numbers and people often hate them.<br><span class="segmentSeparator"></span>Therefore, many deployments chose to base usernames on real names of the user.<br><span class="segmentSeparator"></span>We can easily generate username for Alice Anderson.<br><span class="segmentSeparator"></span>Maybe <code>aanderson</code> would be a good fit?<br><span class="segmentSeparator"></span>And this can indeed work quite well.<br><span class="segmentSeparator"></span>Until Albert Anderson is hired.<br><span class="segmentSeparator"></span>Then we need to get creative.<br><span class="segmentSeparator"></span>Obviously, <code>alanderson</code> will not work here.<br><span class="segmentSeparator"></span>What about <code>alianderson</code> and <code>albanderson</code>?<br><span class="segmentSeparator"></span>Oh no, we have this ancient system that allows only ten characters in the username.<br><span class="segmentSeparator"></span>And <code>alianderson</code> is too long.<br><span class="segmentSeparator"></span>What is even worse is that we would need to change Alice’s username.<br><span class="segmentSeparator"></span>She will get really mad about it.<br><span class="segmentSeparator"></span>Not to mention changing usernames for pretty much everybody.<br><span class="segmentSeparator"></span>That won’t do.<br><span class="segmentSeparator"></span>Let’s go the usual way.<br><span class="segmentSeparator"></span>Let’s have <code>aanderson</code> and <code>aanderson1</code>.<br><span class="segmentSeparator"></span>It is not elegant.<br><span class="segmentSeparator"></span>But it will do the job.<br><span class="segmentSeparator"></span>And Alice will not get mad.<br><span class="segmentSeparator"></span>You know, she is really scary when she gets mad.</p>
</div>
<div class="paragraph">
<p>This use case is so common that even very early midPoint versions supported it.<br><span class="segmentSeparator"></span>This feature is called <em>iteration</em> in midPoint terminology.<br><span class="segmentSeparator"></span>The name suggests how the mechanism works.<br><span class="segmentSeparator"></span>First step is an attempt to create a user object in a perfectly normal way.<br><span class="segmentSeparator"></span>This means that username <code>aanderson</code> is created for Albert Anderson.<br><span class="segmentSeparator"></span>The midPoint checks if that username is unique.<br><span class="segmentSeparator"></span>In this case the username is not unique as it is already taken by Alice.<br><span class="segmentSeparator"></span>That is the point when midPoint starts iterating.<br><span class="segmentSeparator"></span>MidPoint creates <em>iteration token</em>.<br><span class="segmentSeparator"></span>Iteration token is a short string that changes in every iteration.<br><span class="segmentSeparator"></span>In our case, the iteration token will be set to <code>1</code>.<br><span class="segmentSeparator"></span>Then midPoint re-evaluates all the object template mappings.<br><span class="segmentSeparator"></span>Mappings that are supposed to create a unique values need to use that token.<br><span class="segmentSeparator"></span>They should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;item&gt;</span>
        <span class="tag">&lt;ref&gt;</span>name<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;mapping&gt;</span>
            <span class="tag">&lt;source&gt;</span>
                <span class="tag">&lt;path&gt;</span>givenName<span class="tag">&lt;/path&gt;</span>
            <span class="tag">&lt;/source&gt;</span>
            <span class="tag">&lt;source&gt;</span>
                <span class="tag">&lt;path&gt;</span>familyName<span class="tag">&lt;/path&gt;</span>
            <span class="tag">&lt;/source&gt;</span>
            <span class="tag">&lt;expression&gt;</span>
                <span class="tag">&lt;script&gt;</span>
<span class="inline">                   <span class="tag">&lt;code&gt;</span>
                       givenName?.norm[0] + familyName?.norm + iterationToken
                   <span class="tag">&lt;/code&gt;</span></span>
                <span class="tag">&lt;/script&gt;</span>
            <span class="tag">&lt;/expression&gt;</span>
        <span class="tag">&lt;/mapping&gt;</span>
    <span class="tag">&lt;/item&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When this mapping is evaluated for the first time, the iteration token is empty.<br><span class="segmentSeparator"></span>Therefore it will make no difference for the normal processing.<br><span class="segmentSeparator"></span>But when the mappings are re-iterated, the token is set to <code>1</code>.<br><span class="segmentSeparator"></span>Result of this mapping will be <code>aanderson1</code>.<br><span class="segmentSeparator"></span>Which is unique username.<br><span class="segmentSeparator"></span>Therefore iteration stops there and normal processing continues.<br><span class="segmentSeparator"></span>In case that even <code>aanderson1</code> is not unique, the iteration continues.<br><span class="segmentSeparator"></span>Usernames <code>aanderson2</code>, <code>aanderson3</code> and other variants are tried.<br><span class="segmentSeparator"></span>The iteration continues until a unique username is found or until iteration limit is reached.</p>
</div>
<div class="paragraph">
<p>Iteration functionality is disabled by default.<br><span class="segmentSeparator"></span>Therefore any conflict in username will result in hard error.<br><span class="segmentSeparator"></span>This makes sense, as no amount of iterations will make any difference until the iteration token is used in the expressions.<br><span class="segmentSeparator"></span>We also want to set maximum number of iterations.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>there may be a bug in the mappings that may cause endless iterations.<br><span class="segmentSeparator"></span>The iteration functionality can be enabled by specifying <code>iterationSpecification</code> element and setting iteration limit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;iterationSpecification&gt;</span>
        <span class="tag">&lt;maxIterations&gt;</span>5<span class="tag">&lt;/maxIterations&gt;</span>
    <span class="tag">&lt;/iterationSpecification&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Iteration tokens are strings that are created from iteration number.<br><span class="segmentSeparator"></span>It is the iteration number that really matters for midPoint.<br><span class="segmentSeparator"></span>Iteration token can take variety of forms, it can be numeric, it may be alphanumeric, fixed length, variable length or anything else.<br><span class="segmentSeparator"></span>Some mappings will not use the token at all.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>mappings that subsequently add letters from given name to the username.<br><span class="segmentSeparator"></span>Therefore, both iteration number and iteration token are exposed to the mappings.<br><span class="segmentSeparator"></span>There are two variables:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>iteration</code> variable contains iteration number.<br><span class="segmentSeparator"></span>It is always numeric, starting with zero (<code>0</code>).<br><span class="segmentSeparator"></span>Iteration zero means normal processing.<br><span class="segmentSeparator"></span>Iteration one happens after the first conflict.</p>
</li>
<li>
<p><code>iterationToken</code> variable contains a string that is derived from the iteration number.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is default algorithm that derives iteration tokens from iteration number.<br><span class="segmentSeparator"></span>The algorithm is illustrated in following table.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Iteration</th>
<th class="tableblock halign-left valign-top">The value of <code>iteration</code> variable</th>
<th class="tableblock halign-left valign-top">The value of <code>iterationToken</code> variable</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Normal processing</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>0</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>""</code> <em>(empty string)</em></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">First iteration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"1"</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Second iteration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>"2"</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The algorithm is designed to put empty value in the <code>iterationToken</code> during normal processing.<br><span class="segmentSeparator"></span>The idea is that <code>iterationToken</code> variable can be safely used for both the normal processing and the iterations.<br><span class="segmentSeparator"></span>This is just a default algorithm and it will not fit all the deployments.<br><span class="segmentSeparator"></span>Therefore, a custom mechanism to derive iteration token can be specified.<br><span class="segmentSeparator"></span>For example, we may not like to have <code>aanderson</code> and <code>aanderson1</code>.<br><span class="segmentSeparator"></span>Which one of these is number one and which is number two anyway?<br><span class="segmentSeparator"></span>Let’s skip <code>aanderson1</code> and let’s use <code>aanderson2</code> for the first iteration.<br><span class="segmentSeparator"></span>The iteration number cannot be changed as the iteration sequence is fixed.<br><span class="segmentSeparator"></span>But there is no problem for iteration 1 to produce iteration token <code>"2"</code>.<br><span class="segmentSeparator"></span>This can be achieved by specifying a custom algorithm for the token:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;iterationSpecification&gt;</span>
        <span class="tag">&lt;maxIterations&gt;</span>5<span class="tag">&lt;/maxIterations&gt;</span>
        <span class="tag">&lt;tokenExpression&gt;</span>
            <span class="tag">&lt;script&gt;</span>
<span class="inline">                <span class="tag">&lt;code&gt;</span>
                    if (iteration == 0) {
                        return ''
                    } else {
                        return iteration + 1
                    }
                <span class="tag">&lt;/code&gt;</span></span>
            <span class="tag">&lt;/script&gt;</span>
        <span class="tag">&lt;/tokenExpression&gt;</span>
    <span class="tag">&lt;/iterationSpecification&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This algorithm will produce sequence of <code>aanderson</code>, <code>aanderson2</code>, <code>aanderson3</code> and so on.</p>
</div>
<div class="paragraph">
<p>Iteration number and iteration token is the same for the entire object template.<br><span class="segmentSeparator"></span>All the mappings will see the same value and all the mappings are recomputed when there is a need to re-iterate.<br><span class="segmentSeparator"></span>This means that iteration token can be used in other mappings.<br><span class="segmentSeparator"></span>For example, use of the token in e-mail address is a very common case:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;item&gt;</span>
        <span class="tag">&lt;ref&gt;</span>emailAddress<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;mapping&gt;</span>
            <span class="tag">&lt;source&gt;</span>
                <span class="tag">&lt;path&gt;</span>givenName<span class="tag">&lt;/path&gt;</span>
            <span class="tag">&lt;/source&gt;</span>
            <span class="tag">&lt;source&gt;</span>
                <span class="tag">&lt;path&gt;</span>familyName<span class="tag">&lt;/path&gt;</span>
            <span class="tag">&lt;/source&gt;</span>
            <span class="tag">&lt;expression&gt;</span>
                <span class="tag">&lt;script&gt;</span>
<span class="inline">                   <span class="tag">&lt;code&gt;</span>
                       givenName?.norm + '.' + familyName?.norm
                           + iterationToken + '@example.com'
                   <span class="tag">&lt;/code&gt;</span></span>
                <span class="tag">&lt;/script&gt;</span>
            <span class="tag">&lt;/expression&gt;</span>
        <span class="tag">&lt;/mapping&gt;</span>
    <span class="tag">&lt;/item&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This mapping will produce a sequence of <code>albert.anderson@example.com</code>, <code>albert.anderson2@example.com</code> and so on (assuming that customized token expression is also applied).<br><span class="segmentSeparator"></span>Shared value of <code>iterationToken</code> means that the values of e-mail address are consistent with the values of username.<br><span class="segmentSeparator"></span>If username of <code>aanderson2</code> is generated then the e-mail address will be <code>albert.anderson2@example.com</code>.<br><span class="segmentSeparator"></span>The same iteration token is used.</p>
</div>
<div class="paragraph">
<p>However, it all becomes interesting when it comes to e-mail addresses and other identifiers that are publicly exposed.<br><span class="segmentSeparator"></span>It is one thing to have username <code>aanderson2</code>.<br><span class="segmentSeparator"></span>That username is used to log into the system.<br><span class="segmentSeparator"></span>But otherwise is it not very visible outside of the system.<br><span class="segmentSeparator"></span>However, an e-mail address is exposed to a lot of people.<br><span class="segmentSeparator"></span>It may be strange to have e-mail address of <code>albert.anderson2@example.com</code> while there is no <code>albert.anderson@example.com</code> in the company.<br><span class="segmentSeparator"></span>This can be solved by making the mapping for e-mail address smarter.<br><span class="segmentSeparator"></span>It can ignore the iteration token and try to create an e-mail address without the token.<br><span class="segmentSeparator"></span>But in that case it needs to explicitly check for uniqueness.<br><span class="segmentSeparator"></span>There are two ways to do that.<br><span class="segmentSeparator"></span>First method is to check for e-mail address uniqueness inside the e-mail mapping.<br><span class="segmentSeparator"></span>There is a <code>isUniquePropertyValue(…​)</code> method in midPoint function library that is designed for this purpose:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;item&gt;</span>
        <span class="tag">&lt;ref&gt;</span>name<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;mapping&gt;</span>
            <span class="tag">&lt;source&gt;</span>
                <span class="tag">&lt;path&gt;</span>givenName<span class="tag">&lt;/path&gt;</span>
            <span class="tag">&lt;/source&gt;</span>
            <span class="tag">&lt;source&gt;</span>
                <span class="tag">&lt;path&gt;</span>familyName<span class="tag">&lt;/path&gt;</span>
            <span class="tag">&lt;/source&gt;</span>
            <span class="tag">&lt;expression&gt;</span>
                <span class="tag">&lt;script&gt;</span>
<span class="inline">                   <span class="tag">&lt;code&gt;</span>
                       def plainAddress = givenName?.norm + '.' + familyName?.norm
                                         + '@example.com'
                       if (midpoint.isUniquePropertyValue(focus, 'emailAddress',
                                         plainAddress)) {
                           // Bingo! We have unique address
                       } else {
                           // Address not unique.<br><span class="segmentSeparator"></span>                           // We have to use iteration token here.<br><span class="segmentSeparator"></span>                       }
                   <span class="tag">&lt;/code&gt;</span></span>
                <span class="tag">&lt;/script&gt;</span>
            <span class="tag">&lt;/expression&gt;</span>
        <span class="tag">&lt;/mapping&gt;</span>
    <span class="tag">&lt;/item&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The problem with this approach is that there may be corner cases.<br><span class="segmentSeparator"></span>We might need to force another iteration even if the username is unique.<br><span class="segmentSeparator"></span>MidPoint checks only for uniqueness of username by default.<br><span class="segmentSeparator"></span>But is possible that even if <code>aanderson2</code> username is available, the <code>albert.anderson2@example.com</code> address is already taken.<br><span class="segmentSeparator"></span>This may be an error in the data, administrator’s mistake or it may be a remain of retired Albert Anderson senior that worked in the company years ago, but his e-mail address was never deprovisioned.<br><span class="segmentSeparator"></span>The e-mail address mapping can detect this situation.<br><span class="segmentSeparator"></span>But what it is supposed to do with that.<br><span class="segmentSeparator"></span>It makes no sense to have username <code>aanderson2</code> and e-mail address <code>albert.anderson3@example.com</code> or <code>albert.anderson.X@example.com</code> or anything similar.<br><span class="segmentSeparator"></span>What would make sense is to re-iterate and produce username <code>aanderson3</code> and e-mail address <code>albert.anderson3@example.com</code>.<br><span class="segmentSeparator"></span>That would be consistent.<br><span class="segmentSeparator"></span>But the mapping cannot do that.<br><span class="segmentSeparator"></span>Therefore, there is another iteration expression for this purpose: <em>post-iteration condition</em>.<br><span class="segmentSeparator"></span>It is a condition that will be executed after the iteration is completed.<br><span class="segmentSeparator"></span>If the condition returns <code>true</code>, then the iteration will be accepted as valid and the generated values will be used.<br><span class="segmentSeparator"></span>If the condition returns <code>false</code>, then midPoint will re-iterate and yet another iteration will be tried.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;iterationSpecification&gt;</span>
        ...<br><span class="segmentSeparator"></span>        <span class="tag">&lt;postIterationCondition&gt;</span>
            <span class="tag">&lt;script&gt;</span>
<span class="inline">                <span class="tag">&lt;code&gt;</span>
                    def email = ...<br><span class="segmentSeparator"></span>// Code to generate or retrieve e-mail
                    return midpoint.isUniquePropertyValue(focus,
                            'emailAddress', email)
                <span class="tag">&lt;/code&gt;</span></span>
            <span class="tag">&lt;/script&gt;</span>
    <span class="tag">&lt;/iterationSpecification&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The code above does not do much in case the e-mail address is unique.<br><span class="segmentSeparator"></span>It returns <code>true</code>, the iteration is accepted an everything goes as usual.<br><span class="segmentSeparator"></span>But in case that the e-mail address is not unique, the code returns <code>false</code>.<br><span class="segmentSeparator"></span>In that case, midPoint will discard all the results of the iteration, increment iteration counter and re-try the iteration.</p>
</div>
<div class="paragraph">
<p>There is yet another mechanism that can be used here: <em>pre-iteration condition</em>.<br><span class="segmentSeparator"></span>It is a condition that will be executed prior to iteration.<br><span class="segmentSeparator"></span>If it returns <code>true</code>, then the iteration will continue.<br><span class="segmentSeparator"></span>If it returns <code>false</code>, then midPoint will re-iterate.<br><span class="segmentSeparator"></span>The difference here is that this condition will be executed before all the other mappings are evaluated.<br><span class="segmentSeparator"></span>Therefore, it may be used to avoid evaluation of expensive mappings just to discard the values that they produce.</p>
</div>
<div class="paragraph">
<p>Finding identifier values and uniqueness checks are messy stuff.<br><span class="segmentSeparator"></span>And they are not entirely reliable.<br><span class="segmentSeparator"></span>There is a delay between the time when uniqueness is checked and the time when the record is actually written into database.<br><span class="segmentSeparator"></span>Therefore strange things can happen.<br><span class="segmentSeparator"></span>Duplicate identifiers may be generated or attempt to create a user may end up with an error.<br><span class="segmentSeparator"></span>Especially under high loads.<br><span class="segmentSeparator"></span>The delay between check and write cannot be entirely avoided.<br><span class="segmentSeparator"></span>We could lock the data during that time, but that would have significant impact on system performance.<br><span class="segmentSeparator"></span>What we can do to improve the situation is to check the uniqueness on database level and gracefully handle the errors.<br><span class="segmentSeparator"></span>This is currently implemented only for usernames and even for that the implementation is not perfect.<br><span class="segmentSeparator"></span>Implementation of strict uniqueness constraints for other properties is possible, but it is no easy endeavor.<br><span class="segmentSeparator"></span>The values need to be normalized, this can influence database schema and so on.<br><span class="segmentSeparator"></span>But it is feasible.<br><span class="segmentSeparator"></span>In case you are interested, midPoint platform subscription is the best approach for you.</p>
</div>
<div class="paragraph">
<p>When it comes to human-friendly identifiers, there is yet another trouble.<br><span class="segmentSeparator"></span>People tend to change their minds.<br><span class="segmentSeparator"></span>And then they have all kinds of crazy ideas such as the urge to get married.<br><span class="segmentSeparator"></span>The result is that the names of people change.<br><span class="segmentSeparator"></span>And in fact they change surprisingly often.<br><span class="segmentSeparator"></span>When user-friendly identifiers are used, change in user’s name usually means a change in the identifiers.<br><span class="segmentSeparator"></span>This is known as the <em>rename problem</em> and you can observe a glimpse of fear in the eyes of all experienced IDM engineers every time it is mentioned.<br><span class="segmentSeparator"></span>Overall, midPoint handles renames very well.<br><span class="segmentSeparator"></span>Primary identifier of any midPoint object is an OID, not a name.<br><span class="segmentSeparator"></span>And OIDs do not change.<br><span class="segmentSeparator"></span>Therefore, as long as midPoint is concerned, nothing special happens when user’s name is changed.<br><span class="segmentSeparator"></span>The change is picked up by mappings, recomputed and stored.<br><span class="segmentSeparator"></span>However, iterations and uniqueness checks may complicate the things here.<br><span class="segmentSeparator"></span>MidPoint remembers the iteration number for all objects that went through an iteration process.<br><span class="segmentSeparator"></span>This is necessary to get the same results from the mappings every time that they are recomputed.<br><span class="segmentSeparator"></span>Otherwise the identifiers may get re-generated on every recompute.<br><span class="segmentSeparator"></span>But there is a drawback to this approach.<br><span class="segmentSeparator"></span>Let’s suppose that Carol Cooper had username <code>ccooper2</code>.<br><span class="segmentSeparator"></span>She got married and now her name is Carol Cunningham.<br><span class="segmentSeparator"></span>Even though there is no <code>ccunningham</code> in the system, her generated user name will be <code>ccunningham2</code>.<br><span class="segmentSeparator"></span>The iteration token is remembered.<br><span class="segmentSeparator"></span>The rename scenarios can be very treacherous.<br><span class="segmentSeparator"></span>We always recommend to test them thoroughly in any project where user renames are possible.</p>
</div>
<div class="paragraph">
<p>Another drawback of those iterating algorithms is scalability and performance.<br><span class="segmentSeparator"></span>Every time there is a conflict the algorithm need to go through all the iterations.<br><span class="segmentSeparator"></span>How many people named John Smith can be in a large user population?<br><span class="segmentSeparator"></span>We can easily get to <code>jsmith42</code>.<br><span class="segmentSeparator"></span>This means that the next John Smith will need to go through 42 iterations before the system figures out that the next available username is <code>jsmith43</code>.<br><span class="segmentSeparator"></span>And this gets worse with every John Smith added to the system.<br><span class="segmentSeparator"></span>Therefore, this iterative approach is not suitable for generating identifiers that are likely to require a lot of iterations.<br><span class="segmentSeparator"></span>Generating UNIX user and group numbers is a good example for identifiers that would surely cause a disaster if an iterative approach is used.<br><span class="segmentSeparator"></span>Fortunately, there is another mechanism in midPoint that can support generation of such identifiers: sequences.<br><span class="segmentSeparator"></span>But more on that later.</p>
</div>
<div class="paragraph">
<p>Overall, the best strategy is to avoid using those generated human-friendly identifiers altogether.<br><span class="segmentSeparator"></span>The best choice would be something that is already unique, immutable and reasonably short.<br><span class="segmentSeparator"></span>Something like employee number, student identifier or partner ID are usually suitable.<br><span class="segmentSeparator"></span>If that is not acceptable, then the second best approach is to keep the algorithms simple.<br><span class="segmentSeparator"></span>The simpler it is the less likely it is to fail.</p>
</div>
</div>
<div class="sect2">
<h3 id="_includes">Includes</h3>
<div class="paragraph">
<p>There are many ways to apply an object template to an object.<br><span class="segmentSeparator"></span>The template can be set globally in system configuration, it can be set by an archetype or even by an organizational unit.<br><span class="segmentSeparator"></span>However, only one object template can be active for any particular object at one time.<br><span class="segmentSeparator"></span>Yet, there are often mappings that need to apply universally.<br><span class="segmentSeparator"></span>For example, we may want to generate full name using the same algorithm for all users, regardless of their archetype.<br><span class="segmentSeparator"></span>Or we may want to automatically assign some roles to all users regardless of their organizational units.<br><span class="segmentSeparator"></span>For that reason there is mechanism to include one object template in another:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">22f83022-b76d-11e9-8a30-6ffc11b23016</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Default User Template<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;item&gt;</span>
        <span class="tag">&lt;ref&gt;</span>fullName<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;mapping&gt;</span>
            ...<br><span class="segmentSeparator"></span>        <span class="tag">&lt;/mapping&gt;</span>
    <span class="tag">&lt;/item&gt;</span>
<span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">60eab6a8-ba87-11e9-b9a3-bbb8418de4d5</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Special User Template<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;includeRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">22f83022-b76d-11e9-8a30-6ffc11b23016</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;item&gt;</span>
        <span class="tag">&lt;ref&gt;</span>employeeNumber<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;mapping&gt;</span>
            ...<br><span class="segmentSeparator"></span>        <span class="tag">&lt;/mapping&gt;</span>
    <span class="tag">&lt;/item&gt;</span>
<span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case, the special user template includes all the mappings from default user template.<br><span class="segmentSeparator"></span>Therefore both mapping for <code>employeeNumber</code> and mapping for <code>fullName</code> will be processed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_combining_the_ingredients">Combining the Ingredients</h3>
<div class="paragraph">
<p>It is time to put all the bits and pieces together.<br><span class="segmentSeparator"></span>So far we have been talking about provisioning, inbound synchronization, schema, RBAC and object templates.<br><span class="segmentSeparator"></span>Let’s see how all the parts fit together:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/08-01-big-picture.png" alt="Big picture">
</div>
</div>
<div class="paragraph">
<p>Everything starts with a synchronization process, whether it is reconciliation or live synchronization.<br><span class="segmentSeparator"></span>Synchronization process invoked the connector for the source resource (Resource A).<br><span class="segmentSeparator"></span>The connector retrieves the data from the source system.<br><span class="segmentSeparator"></span>Shadow objects are created for all the source accounts as soon as the data set foot in midPoint.<br><span class="segmentSeparator"></span>Correlation expression is evaluated for all new accounts to find their owners.<br><span class="segmentSeparator"></span>Once we have owner of the account, we can execute inbound mappings.<br><span class="segmentSeparator"></span>This is the way how account data are reflected to midPoint user object, which is a <em>focus</em> of the computation.</p>
</div>
<div class="paragraph">
<p>Next couple of steps is all about the <em>focus</em>.<br><span class="segmentSeparator"></span>This is the part where object templates are executed, assignment and roles are evaluated.<br><span class="segmentSeparator"></span>Assignments and roles may contain <em>construction</em> statements.<br><span class="segmentSeparator"></span>Those are just collected at this stage.<br><span class="segmentSeparator"></span>They are not evaluated yet.<br><span class="segmentSeparator"></span>This focus policy phase of computation is all about the focus.<br><span class="segmentSeparator"></span>Which means that user object is both the input and output of this computation.</p>
</div>
<div class="paragraph">
<p>Outbound phase takes place next.<br><span class="segmentSeparator"></span>In this phase the focus of the computation (user) is projected to accounts.<br><span class="segmentSeparator"></span>This is the time when <em>constructions</em> are processed and the mappings inside them are evaluated.<br><span class="segmentSeparator"></span>Those constructions were collected from the assignments in the previous phase.<br><span class="segmentSeparator"></span>They are combined with outbound mappings specified in resource <em>schema handling</em>.<br><span class="segmentSeparator"></span>All of that is mixed together, sorted to resource accounts, all the values are computed.<br><span class="segmentSeparator"></span>This is also the time when attribute-level reconciliation takes place.<br><span class="segmentSeparator"></span>We know what attributes the account should have, therefore we can compare that with the values that the attributes have in reality.<br><span class="segmentSeparator"></span>When all of that is computed and processed, then a connector is used to update the target resource (Resource B).</p>
</div>
<div class="paragraph">
<p>This picture is still not entirely complete.<br><span class="segmentSeparator"></span>It does not show policy rules, existence mappings, approval processes, hooks and good deal of other advanced features.<br><span class="segmentSeparator"></span>But this picture is good enough for now.<br><span class="segmentSeparator"></span>It is good enough to create a simple solution.</p>
</div>
</div>
<div class="sect2">
<h3 id="_complete_deployment_example">Complete Deployment Example</h3>
<div class="paragraph">
<p>We have all that we need to create a simple but mostly complete identity management solution.<br><span class="segmentSeparator"></span>Our environment and solution outline:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>HR system is a data input.<br><span class="segmentSeparator"></span>It exports employee data into a CSV file.<br><span class="segmentSeparator"></span>Employee number is a primary key, there is employee first and last name and job code.<br><span class="segmentSeparator"></span>There is no username or password.</p>
</li>
<li>
<p>We need to feed employee data into midPoint.<br><span class="segmentSeparator"></span>Which means that we need to configure synchronization.</p>
</li>
<li>
<p>We need to generate unique and user-friendly username, compute full name and generate a random initial password.</p>
</li>
<li>
<p>We need to automatically assign roles based on job code from the HR system.</p>
</li>
<li>
<p>We need to automatically provision account to LDAP server and CRM database table.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We can do that if we put together all that we have learned so far.<br><span class="segmentSeparator"></span>Even though this is still quite a simple example, the complete configuration is too large to put all of it into this book.<br><span class="segmentSeparator"></span>It will take too much space.<br><span class="segmentSeparator"></span>And after all the detailed explanation in the previous chapters it will also get a bit boring.<br><span class="segmentSeparator"></span>Therefore we will show only the interesting pieces of the configuration here.<br><span class="segmentSeparator"></span>Complete configuration can be found in the usual place.<br><span class="segmentSeparator"></span>Please see <a href="https://docs.evolveum.com/book/practical-identity-management-with-midpoint.html#92-additional-information">Additional Information</a> chapter for details.<br><span class="segmentSeparator"></span>These files represent the final configuration, the expected state at the end of this chapter.<br><span class="segmentSeparator"></span>Therefore, if you want to follow instructions in this chapter step-by-step you have to choose appropriate parts of the files to import.<br><span class="segmentSeparator"></span>Or you can just import everything and use the following text as an explanation of the effects that you see.</p>
</div>
<div class="paragraph">
<p>Let us start with an HR resource.<br><span class="segmentSeparator"></span>This is mostly the same resource definition as we have seen in the <a href="https://docs.evolveum.com/book/practical-identity-management-with-midpoint.html#05-synchronization">Synchronization</a> chapter.<br><span class="segmentSeparator"></span>But there are few differences.<br><span class="segmentSeparator"></span>First of all, the data feed is a bit different.<br><span class="segmentSeparator"></span>We have a new <code>jobcode</code> column there.<br><span class="segmentSeparator"></span>It looks like this:</p>
</div>
<div class="listingblock">
<div class="title">hr.csv</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="csv">"empno","firstname","lastname","jobcode"
"001","Alice","Anderson","S006"
"002","Bob","Brown","S007"
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, the HR resource definition has to reflect those changes.<br><span class="segmentSeparator"></span>We have defined a new custom user property <code>jobCode</code> in our extension schema:</p>
</div>
<div class="listingblock">
<div class="title">extension-example.xsd</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;xsd:schema</span> <span class="attribute-name">...</span><span class="tag">&gt;</span>
    <span class="tag">&lt;xsd:complexType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">UserExtensionType</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;xsd:annotation&gt;</span>
            <span class="tag">&lt;xsd:appinfo&gt;</span>
                <span class="tag">&lt;a:extension</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">"</span><span class="content">c:UserType</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/xsd:appinfo&gt;</span>
        <span class="tag">&lt;/xsd:annotation&gt;</span>
        <span class="tag">&lt;xsd:sequence&gt;</span>
            ...<br><span class="segmentSeparator"></span>            <span class="tag">&lt;xsd:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">jobCode</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">xsd:string</span><span class="delimiter">"</span></span>
                                        <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">"</span><span class="content">0</span><span class="delimiter">"</span></span> <span class="attribute-name">maxOccurs</span>=<span class="string"><span class="delimiter">"</span><span class="content">1</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
                ...<br><span class="segmentSeparator"></span>            <span class="tag">&lt;/xsd:element&gt;</span>
        <span class="tag">&lt;/xsd:sequence&gt;</span>
    <span class="tag">&lt;/xsd:complexType&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/xsd:schema&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The jobcode column is mapped to jobCode extension property in HR resource inbound mapping:</p>
</div>
<div class="listingblock">
<div class="title">resource-csv-hr.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;resource</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">03c3ceea-78e2-11e6-954d-dfdfa9ace0cf</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;schemaHandling&gt;</span>
        <span class="tag">&lt;objectType&gt;</span>
            ...<br><span class="segmentSeparator"></span>            <span class="tag">&lt;attribute&gt;</span>
                <span class="tag">&lt;ref&gt;</span>ri:jobcode<span class="tag">&lt;/ref&gt;</span>
                <span class="tag">&lt;displayName&gt;</span>Job code<span class="tag">&lt;/displayName&gt;</span>
                <span class="tag">&lt;inbound&gt;</span>
                    <span class="tag">&lt;target&gt;</span>
                        <span class="tag">&lt;path&gt;</span>$focus/extension/jobCode<span class="tag">&lt;/path&gt;</span>
                    <span class="tag">&lt;/target&gt;</span>
                <span class="tag">&lt;/inbound&gt;</span>
            <span class="tag">&lt;/attribute&gt;</span>
            ...<br><span class="segmentSeparator"></span>        <span class="tag">&lt;/objectType&gt;</span>
    <span class="tag">&lt;/schemaHandling&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/resource&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The rest of the mappings that are defined in the HR resource is a bit boring.<br><span class="segmentSeparator"></span>The interesting thing is the mapping that is not there at all.<br><span class="segmentSeparator"></span>The mapping for username (property name of the user object) is missing.<br><span class="segmentSeparator"></span>We will not generate username in the inbound phase.<br><span class="segmentSeparator"></span>We just do not have enough data to responsibly generate username just yet.<br><span class="segmentSeparator"></span>Inbound phase is still running, user object is not fully populate yet.<br><span class="segmentSeparator"></span>Let’s postpone the decision about username for later.</p>
</div>
<div class="paragraph">
<p>Synchronization part of the HR resource definition is also a pretty standard one.<br><span class="segmentSeparator"></span>This resource is an authoritative source.<br><span class="segmentSeparator"></span>Accounts will be correlated by the <code>empno</code> column matching the <code>employeeNumber</code> user property.<br><span class="segmentSeparator"></span>Linked accounts will be updated and new users will be created for unmatched accounts.<br><span class="segmentSeparator"></span>It is all the same routine as we have already described in <a href="https://docs.evolveum.com/book/practical-identity-management-with-midpoint.html#05-synchronization">Synchronization</a> chapter.</p>
</div>
<div class="paragraph">
<p>Perhaps the most interesting part of this setup is object template.<br><span class="segmentSeparator"></span>The template has several responsibilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Compute full name from first name and last name.</p>
</li>
<li>
<p>Generate unique username.</p>
</li>
<li>
<p>Generate e-mail address.</p>
</li>
<li>
<p>Automatically assign basic employee role.</p>
</li>
<li>
<p>Automatically assign the roles based on job code.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let’s start with the simple thing: generating full name.<br><span class="segmentSeparator"></span>At this point this is probably a no-brainer:</p>
</div>
<div class="listingblock">
<div class="title">object-template-user.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">22f83022-b76d-11e9-8a30-6ffc11b23016</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;item&gt;</span>
        <span class="tag">&lt;ref&gt;</span>fullName<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;mapping&gt;</span>
            <span class="tag">&lt;source&gt;</span>
                <span class="tag">&lt;path&gt;</span>givenName<span class="tag">&lt;/path&gt;</span>
            <span class="tag">&lt;/source&gt;</span>
            <span class="tag">&lt;source&gt;</span>
                <span class="tag">&lt;path&gt;</span>familyName<span class="tag">&lt;/path&gt;</span>
            <span class="tag">&lt;/source&gt;</span>
            <span class="tag">&lt;expression&gt;</span>
                <span class="tag">&lt;script&gt;</span>
<span class="inline">                    <span class="tag">&lt;code&gt;</span>givenName + ' ' + familyName<span class="tag">&lt;/code&gt;</span></span>
                <span class="tag">&lt;/script&gt;</span>
            <span class="tag">&lt;/expression&gt;</span>
        <span class="tag">&lt;/mapping&gt;</span>
    <span class="tag">&lt;/item&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is really simple.<br><span class="segmentSeparator"></span>But it is much harder for username.<br><span class="segmentSeparator"></span>We want to generate a user-friendly username.<br><span class="segmentSeparator"></span>We could simply use user’s last name.<br><span class="segmentSeparator"></span>But this is very likely to create conflicts.<br><span class="segmentSeparator"></span>Therefore let’s combine last name with the first letter of first name.<br><span class="segmentSeparator"></span>We will get nice usernames such as aanderson, bbrown and so on.<br><span class="segmentSeparator"></span>But there is still a chance of username conflict.<br><span class="segmentSeparator"></span>So let’s add iteration tokens into the mix.<br><span class="segmentSeparator"></span>Like this:</p>
</div>
<div class="listingblock">
<div class="title">object-template-user.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">22f83022-b76d-11e9-8a30-6ffc11b23016</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;item&gt;</span>
        <span class="tag">&lt;ref&gt;</span>name<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;mapping&gt;</span>
            <span class="tag">&lt;source&gt;</span>
                <span class="tag">&lt;path&gt;</span>givenName<span class="tag">&lt;/path&gt;</span>
            <span class="tag">&lt;/source&gt;</span>
            <span class="tag">&lt;source&gt;</span>
                <span class="tag">&lt;path&gt;</span>familyName<span class="tag">&lt;/path&gt;</span>
            <span class="tag">&lt;/source&gt;</span>
            <span class="tag">&lt;expression&gt;</span>
                <span class="tag">&lt;script&gt;</span>
<span class="inline">                    <span class="tag">&lt;code&gt;</span>
                        if ( givenName == null <span class="entity">&amp;amp;</span><span class="entity">&amp;amp;</span> familyName == null ) {
                            return null
                        }
                        if ( familyName == null ) {
                            return givenName?.norm + iterationToken
                        }
                        if ( givenName == null ) {
                            return familyName?.norm + iterationToken
                        }
                        givenName?.norm[0] + familyName?.norm + iterationToken
                    <span class="tag">&lt;/code&gt;</span></span>
                <span class="tag">&lt;/script&gt;</span>
            <span class="tag">&lt;/expression&gt;</span>
        <span class="tag">&lt;/mapping&gt;</span>
    <span class="tag">&lt;/item&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This looks a bit more complicated that your have expected, doesn’t it?<br><span class="segmentSeparator"></span>The basic idea is simple, so why won’t equally simple expression work?<br><span class="segmentSeparator"></span>Maybe something like this?</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">givenName[<span class="integer">0</span>] + familyName + iterationToken</code></pre>
</div>
</div>
<div class="paragraph">
<p>The devil is, as usual, in the details.</p>
</div>
<div class="paragraph">
<p>Firstly, good part of any programming is error handling.<br><span class="segmentSeparator"></span>Hence all the if-then statements.<br><span class="segmentSeparator"></span>It may look like those situations cannot happen in our little example.<br><span class="segmentSeparator"></span>All the HR records have both first and last name set, anyway.<br><span class="segmentSeparator"></span>Therefore they will never be <code>null</code> in the expression, will they?<br><span class="segmentSeparator"></span>In fact, they will.<br><span class="segmentSeparator"></span>This is one small peculiarity of midPoint expressions.<br><span class="segmentSeparator"></span>MidPoint works in a relative way.<br><span class="segmentSeparator"></span>Therefore midPoint often evaluates <em>old</em> values of attributes and properties to figure out which values to remove.<br><span class="segmentSeparator"></span>The old values for any new user are <code>null</code>.<br><span class="segmentSeparator"></span>Therefore it may happen that the expression is evaluated with <code>null</code> inputs.<br><span class="segmentSeparator"></span>This may seem a bit annoying at the beginning.<br><span class="segmentSeparator"></span>But you will be more than grateful that your expressions are properly sanitized and null-safe when you get to work with real data.<br><span class="segmentSeparator"></span>Reality always finds a way to bring surprises.</p>
</div>
<div class="paragraph">
<p>Secondly, midPoint is built with multi-national environment in mind.<br><span class="segmentSeparator"></span>It is 21<sup>st</sup> century already and unicode is everywhere.<br><span class="segmentSeparator"></span><em>Almost</em> everywhere, that is.<br><span class="segmentSeparator"></span>It is expected that the HR system stores names with full national characters, such as <code>Radovan Semančík</code>.<br><span class="segmentSeparator"></span>But it is still not a common practice to use national characters in usernames, e-mail addresses and so on.<br><span class="segmentSeparator"></span>Therefore we usually want to normalize the national characters to their ASCII-7 equivalents.<br><span class="segmentSeparator"></span>That is what PolyString is for and that is what the <code>norm()</code> methods are doing.<br><span class="segmentSeparator"></span>The result is that the generated username will be <code>rsemancik</code> instead of <code>RSemančík</code>.</p>
</div>
<div class="paragraph">
<p>But there is still one piece missing.<br><span class="segmentSeparator"></span>We want to enable iteration to resolve naming conflicts.<br><span class="segmentSeparator"></span>Otherwise poor Arnold Anderson won’t have his accounts created because <code>aanderson</code> username is already taken by Alice.<br><span class="segmentSeparator"></span>We can enable iterations like this:</p>
</div>
<div class="listingblock">
<div class="title">object-template-user.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">22f83022-b76d-11e9-8a30-6ffc11b23016</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;iterationSpecification&gt;</span>
        <span class="tag">&lt;maxIterations&gt;</span>5<span class="tag">&lt;/maxIterations&gt;</span>
        <span class="tag">&lt;tokenExpression&gt;</span>
            <span class="tag">&lt;script&gt;</span>
<span class="inline">                <span class="tag">&lt;code&gt;</span>
                    if (iteration == 0) {
                        return ''
                    } else {
                        return iteration + 1
                    }
                <span class="tag">&lt;/code&gt;</span></span>
            <span class="tag">&lt;/script&gt;</span>
        <span class="tag">&lt;/tokenExpression&gt;</span>
    <span class="tag">&lt;/iterationSpecification&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>maxIteration</code> part up there is quite straightforward.<br><span class="segmentSeparator"></span>We want to have some limit on the number of iterations as we do not want to iterate forever.<br><span class="segmentSeparator"></span>Most iteration sequences are short in practice.<br><span class="segmentSeparator"></span>If the iterative approach cannot find a match in several steps, then perhaps the iteration is not a good method anyway.<br><span class="segmentSeparator"></span>Therefore the limit is usually not a problem.<br><span class="segmentSeparator"></span>But having a limit makes a huge difference for troubleshooting.<br><span class="segmentSeparator"></span>Most infinite iteration loops are caused by configuration errors.<br><span class="segmentSeparator"></span>And it is much better to get an error after a couple of seconds than to wait forever.</p>
</div>
<div class="paragraph">
<p>The second part of the iteration configuration is also quite clear for people that read this chapter carefully.<br><span class="segmentSeparator"></span>The default iteration token sequence is <code>""</code>, <code>"1"</code>, <code>"2"</code>, <code>"3"</code> and so on.<br><span class="segmentSeparator"></span>But that would give us <code>aanderson</code>, <code>aanderson1</code>, <code>aanderson2</code> and so on.<br><span class="segmentSeparator"></span>We do not want to have <code>aanderson</code> and <code>aanderson1</code> as that would be confusing.<br><span class="segmentSeparator"></span>Therefore we chose to skip the <code>"1"</code> token and start with <code>"2"</code>.<br><span class="segmentSeparator"></span>The custom iteration token expression does just that.</p>
</div>
<div class="paragraph">
<p>As soon as we have the mapping for name in place we can start testing the configuration.<br><span class="segmentSeparator"></span>Therefore go ahead and import the HR resource, import object template, set the object template in the configuration and do not forget to replace the HR CSV file.<br><span class="segmentSeparator"></span>If you did experiments with previous configuration, it can be helpful to clean up midPoint by using the “delete all identities” process.<br><span class="segmentSeparator"></span>When everything is set up, you can try to manually import a single account from the HR resource by using the “import” button on the page where you can list resource accounts.<br><span class="segmentSeparator"></span>Once the basic configuration works, you can test iterations by adding Arnold Anderson to the HR CSV file and importing the account.<br><span class="segmentSeparator"></span>Do not forget to switch from repository to resource view by clicking on the <em>Resource</em> button on the top-left side of the page.<br><span class="segmentSeparator"></span>There is no synchronization task running, therefore MidPoint haven’t see Arnold’s account yet.<br><span class="segmentSeparator"></span>You have to instruct midPoint to explicitly look at the resource.<br><span class="segmentSeparator"></span>Once Arnold’s account is imported a non-conflicting username should be selected for him:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/08-02-users-andersons.png" alt="Users">
</div>
</div>
<div class="paragraph">
<p>We need to determine e-mail address next.<br><span class="segmentSeparator"></span>In our case the mapping for e-mail address is quite similar to username mapping:</p>
</div>
<div class="listingblock">
<div class="title">object-template-user.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">22f83022-b76d-11e9-8a30-6ffc11b23016</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;item&gt;</span>
        <span class="tag">&lt;ref&gt;</span>emailAddress<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;mapping&gt;</span>
            <span class="tag">&lt;source&gt;</span>
                <span class="tag">&lt;path&gt;</span>givenName<span class="tag">&lt;/path&gt;</span>
            <span class="tag">&lt;/source&gt;</span>
            <span class="tag">&lt;source&gt;</span>
                <span class="tag">&lt;path&gt;</span>familyName<span class="tag">&lt;/path&gt;</span>
            <span class="tag">&lt;/source&gt;</span>
            <span class="tag">&lt;expression&gt;</span>
                <span class="tag">&lt;script&gt;</span>
<span class="inline">                    <span class="tag">&lt;code&gt;</span>
                        if ( givenName == null <span class="entity">&amp;amp;</span><span class="entity">&amp;amp;</span> familyName == null ) {
                            return null
                        }
                        if ( familyName == null ) {
                            return givenName?.norm + iterationToken +
                                                     '@example.com'
                        }
                        if ( givenName == null ) {
                            return familyName?.norm + iterationToken +
                                                      '@example.com'
                        }
                        givenName?.norm + '.' + familyName?.norm +
                                                iterationToken + '@example.com'
                    <span class="tag">&lt;/code&gt;</span></span>
                <span class="tag">&lt;/script&gt;</span>
            <span class="tag">&lt;/expression&gt;</span>
        <span class="tag">&lt;/mapping&gt;</span>
    <span class="tag">&lt;/item&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This mapping should be quite understandable now.<br><span class="segmentSeparator"></span>There are the same checks for special cases.<br><span class="segmentSeparator"></span>Then the main expression at the end combines given name and family name in a slightly different way to get an e-mail address.<br><span class="segmentSeparator"></span>This is just a simple example for e-mail address that is a good fit for a book.<br><span class="segmentSeparator"></span>However, dealing with e-mail address is a bit more difficult in practice.<br><span class="segmentSeparator"></span>A clever reader can surely discover a couple of obvious issues.<br><span class="segmentSeparator"></span>Firstly, the expression is using the same iteration token than the username mapping is using.<br><span class="segmentSeparator"></span>Therefore the e-mail address for Arnold Anderson will be <code>arnold.anderson2@example.com</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/08-03-users-andersons-email.png" alt="Users">
</div>
</div>
<div class="paragraph">
<p>This is not exactly what we want.<br><span class="segmentSeparator"></span>Ideally, we would like to use much simpler versions <code>arnold.anderson@example.com</code>.<br><span class="segmentSeparator"></span>In this case there is no conflict with <code>alice.anderson@example.com</code>.<br><span class="segmentSeparator"></span>But midPoint does not consider e-mail address to be an identifier, therefore it does not check for its uniqueness.<br><span class="segmentSeparator"></span>Also, there is only one iteration token that is reused for all the expressions in all object template mappings.<br><span class="segmentSeparator"></span>There are also primary e-mail accounts and account aliases, dealing with account renames and temporary assignment of e-mail aliases and so on.<br><span class="segmentSeparator"></span>Overall, dealing with e-mail addresses is far from easy.<br><span class="segmentSeparator"></span>Some of those issues can be solved with pre-iteration or post-iteration conditions.<br><span class="segmentSeparator"></span>But it is quite likely that a completely custom code will be needed for a more complex cases.</p>
</div>
<div class="paragraph">
<p>Role autoassignment is the next step.<br><span class="segmentSeparator"></span>Let’s start with something simple.<br><span class="segmentSeparator"></span>All the records that come from the HR resource are employee records.<br><span class="segmentSeparator"></span>Therefore let’s assign Employee role to all of them.<br><span class="segmentSeparator"></span>The easiest way to do that is to use inbound mapping of HR resource:</p>
</div>
<div class="listingblock">
<div class="title">resource-csv-hr.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;resource</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">03c3ceea-78e2-11e6-954d-dfdfa9ace0cf</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;schemaHandling&gt;</span>
        <span class="tag">&lt;objectType&gt;</span>
            ...<br><span class="segmentSeparator"></span>            <span class="tag">&lt;attribute&gt;</span>
                <span class="tag">&lt;ref&gt;</span>ri:empno<span class="tag">&lt;/ref&gt;</span>
                ...<br><span class="segmentSeparator"></span>                <span class="tag">&lt;inbound&gt;</span>
                    <span class="tag">&lt;expression&gt;</span>
                        <span class="tag">&lt;value&gt;</span>
                            <span class="comment">&lt;!-- Employee role --&gt;</span>
                            <span class="tag">&lt;targetRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">86d3b462-2334-11ea-bbac-13d84ce0a1df</span><span class="delimiter">"</span></span>
                                       <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">RoleType</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
                        <span class="tag">&lt;/value&gt;</span>
                    <span class="tag">&lt;/expression&gt;</span>
                    <span class="tag">&lt;target&gt;</span>
                        <span class="tag">&lt;path&gt;</span>assignment<span class="tag">&lt;/path&gt;</span>
                    <span class="tag">&lt;/target&gt;</span>
                <span class="tag">&lt;/inbound&gt;</span>
            <span class="tag">&lt;/attribute&gt;</span>
            ...<br><span class="segmentSeparator"></span>        <span class="tag">&lt;/objectType&gt;</span>
    <span class="tag">&lt;/schemaHandling&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/resource&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This mapping is quite straightforward.<br><span class="segmentSeparator"></span>Its expression produces a static <code>targetRef</code> value that is placed in user’s assignment.<br><span class="segmentSeparator"></span>The strange thing here is the placement of this mapping.<br><span class="segmentSeparator"></span>It is placed in the section that corresponds to <code>empno</code> attribute.<br><span class="segmentSeparator"></span>This is inbound mapping and it just has to be placed somewhere.<br><span class="segmentSeparator"></span>Any reasonable attribute would do.<br><span class="segmentSeparator"></span>It does not really matter into which attribute it is placed as it ignores attribute value anyway.</p>
</div>
<div class="paragraph">
<p>That was a very simple static mapping.<br><span class="segmentSeparator"></span>It is perhaps too simple for practical use as there not many cases when a role is assigned both automatically and unconditionally.<br><span class="segmentSeparator"></span>The mapping above can be slightly improved by adding a <em>condition</em> to the mapping.<br><span class="segmentSeparator"></span>But that still has some limitations.<br><span class="segmentSeparator"></span>For example, inbound mappings cannot have more than one input.<br><span class="segmentSeparator"></span>And being an inbound mapping, this can only work with account attributes and therefore its behavior cannot be influenced by user data changed in the user interface.</p>
</div>
<div class="paragraph">
<p>Autoassignment in inbound mapping is still useful and in fact it is also used quite often.<br><span class="segmentSeparator"></span>But there is another way that is much more popular: autoassignment in object template mapping.<br><span class="segmentSeparator"></span>That is what we are going to do next.<br><span class="segmentSeparator"></span>We are going to handle role autoassignment based on job code.</p>
</div>
<div class="paragraph">
<p>We want to demonstrate autoassignment in object template.<br><span class="segmentSeparator"></span>Our object template works with user object both as input and output.<br><span class="segmentSeparator"></span>It cannot (or rather <em>should not</em>) reach out to the HR account to get the value of <code>jobcode</code> attribute.<br><span class="segmentSeparator"></span>We have to do that the other way around.<br><span class="segmentSeparator"></span>We have to map HR account attribute <code>jobcode</code> to midPoint user property <code>jobCode</code> by using an inbound mapping:</p>
</div>
<div class="listingblock">
<div class="title">resource-csv-hr.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;resource</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">03c3ceea-78e2-11e6-954d-dfdfa9ace0cf</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;schemaHandling&gt;</span>
        <span class="tag">&lt;objectType&gt;</span>
            ...<br><span class="segmentSeparator"></span>            <span class="tag">&lt;attribute&gt;</span>
                <span class="tag">&lt;ref&gt;</span>ri:jobcode<span class="tag">&lt;/ref&gt;</span>
                <span class="tag">&lt;inbound&gt;</span>
                    <span class="tag">&lt;target&gt;</span>
                        <span class="tag">&lt;path&gt;</span>$focus/extension/jobCode<span class="tag">&lt;/path&gt;</span>
                    <span class="tag">&lt;/target&gt;</span>
                <span class="tag">&lt;/inbound&gt;</span>
            <span class="tag">&lt;/attribute&gt;</span>
            ...<br><span class="segmentSeparator"></span>        <span class="tag">&lt;/objectType&gt;</span>
    <span class="tag">&lt;/schemaHandling&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/resource&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can easily use the job code in object template mapping now:</p>
</div>
<div class="listingblock">
<div class="title">object-template-user.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;objectTemplate</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">22f83022-b76d-11e9-8a30-6ffc11b23016</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;item&gt;</span>
        <span class="tag">&lt;ref&gt;</span>assignment<span class="tag">&lt;/ref&gt;</span>
        <span class="tag">&lt;mapping&gt;</span>
            <span class="tag">&lt;strength&gt;</span>strong<span class="tag">&lt;/strength&gt;</span>
            <span class="tag">&lt;source&gt;</span>
                <span class="tag">&lt;path&gt;</span>extension/jobCode<span class="tag">&lt;/path&gt;</span>
            <span class="tag">&lt;/source&gt;</span>
            <span class="tag">&lt;expression&gt;</span>
                <span class="tag">&lt;assignmentTargetSearch&gt;</span>
                    <span class="tag">&lt;targetType&gt;</span>RoleType<span class="tag">&lt;/targetType&gt;</span>
                    <span class="tag">&lt;filter&gt;</span>
                        <span class="tag">&lt;q:equal&gt;</span>
                            <span class="tag">&lt;q:path&gt;</span>extension/autoassignJobCode<span class="tag">&lt;/q:path&gt;</span>
                            <span class="tag">&lt;expression&gt;</span>
                                <span class="tag">&lt;path&gt;</span>$jobCode<span class="tag">&lt;/path&gt;</span>
                            <span class="tag">&lt;/expression&gt;</span>
                        <span class="tag">&lt;/q:equal&gt;</span>
                    <span class="tag">&lt;/filter&gt;</span>
                <span class="tag">&lt;/assignmentTargetSearch&gt;</span>
            <span class="tag">&lt;/expression&gt;</span>
        <span class="tag">&lt;/mapping&gt;</span>
    <span class="tag">&lt;/item&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/objectTemplate&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the same principle as we have used earlier in this chapter.<br><span class="segmentSeparator"></span>The mapping is using <code>assignmentTargetSearch</code> expression to look for roles where user’s <code>jobCode</code> and role’s <code>autoassignJobCode</code> match.<br><span class="segmentSeparator"></span>This mapping is strong as we want to recompute the mapping and set the value all the times.<br><span class="segmentSeparator"></span>If the mapping would be normal-strength, then the values are recomputed only when <code>jobCode</code> changes.<br><span class="segmentSeparator"></span>Which actually might be enough during normal operation of the system.<br><span class="segmentSeparator"></span>But making this mapping strong makes things much easier during testing.<br><span class="segmentSeparator"></span>That is all for the mapping.<br><span class="segmentSeparator"></span>Now we need to prepare the roles for this mapping to work.<br><span class="segmentSeparator"></span>We need to extend role schema first:</p>
</div>
<div class="listingblock">
<div class="title">extension-example.xsd</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;xsd:schema</span> <span class="attribute-name">...</span><span class="tag">&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;xsd:complexType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">RoleExtensionType</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;xsd:annotation&gt;</span>
            <span class="tag">&lt;xsd:appinfo&gt;</span>
                <span class="tag">&lt;a:extension</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">"</span><span class="content">c:RoleType</span><span class="delimiter">"</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/xsd:appinfo&gt;</span>
        <span class="tag">&lt;/xsd:annotation&gt;</span>
        <span class="tag">&lt;xsd:sequence&gt;</span>
            <span class="tag">&lt;xsd:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">"</span><span class="content">autoassignJobCode</span><span class="delimiter">"</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">"</span><span class="content">xsd:string</span><span class="delimiter">"</span></span>
                                                  <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">"</span><span class="content">0</span><span class="delimiter">"</span></span> <span class="attribute-name">maxOccurs</span>=<span class="string"><span class="delimiter">"</span><span class="content">1</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
                ...<br><span class="segmentSeparator"></span>            <span class="tag">&lt;/xsd:element&gt;</span>
        <span class="tag">&lt;/xsd:sequence&gt;</span>
    <span class="tag">&lt;/xsd:complexType&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/xsd:schema&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we need a couple of roles with job codes in their extension:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">a1572de4-b9b9-11e9-af3e-5f68b3207f97</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Sales Manager<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;extension&gt;</span>
        <span class="tag">&lt;exmpl:autoassignJobCode&gt;</span>S006<span class="tag">&lt;/exmpl:autoassignJobCode&gt;</span>
    <span class="tag">&lt;/extension&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/role&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">b93af850-b9b9-11e9-8c2c-dfb9a89635a0</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Sales Agent<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;extension&gt;</span>
        <span class="tag">&lt;exmpl:autoassignJobCode&gt;</span>S007<span class="tag">&lt;/exmpl:autoassignJobCode&gt;</span>
    <span class="tag">&lt;/extension&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/role&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">b9d2b604-b9b9-11e9-bbc4-17d8e85623b4</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Sales Assistant<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;extension&gt;</span>
        <span class="tag">&lt;exmpl:autoassignJobCode&gt;</span>S008<span class="tag">&lt;/exmpl:autoassignJobCode&gt;</span>
    <span class="tag">&lt;/extension&gt;</span>
    ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/role&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That is all the configuration needed for autoassignment to work.<br><span class="segmentSeparator"></span>The roles should be automatically assigned to users when the users are recomputed.<br><span class="segmentSeparator"></span>Just make sure that the users have their <code>jobCode</code> properly set in the user object.<br><span class="segmentSeparator"></span>If they do not have it then re-import them or run a reconciliation task.<br><span class="segmentSeparator"></span>Then go ahead and create some more roles for the missing job codes.<br><span class="segmentSeparator"></span>No change in any of the mappings is needed to support more job codes.<br><span class="segmentSeparator"></span>Just create the roles and recompute.<br><span class="segmentSeparator"></span>That is the beauty of this solution.<br><span class="segmentSeparator"></span>It is easy to maintain.</p>
</div>
<div class="paragraph">
<p>So far we have tackled the inbound phase and focus policy phase.<br><span class="segmentSeparator"></span>But we have not talked about the outbound (provisioning) phase much.<br><span class="segmentSeparator"></span>Now it is the right time to have a look at that.</p>
</div>
<div class="paragraph">
<p>We are going to reuse the LDAP and CRM resources from previous chapters.<br><span class="segmentSeparator"></span>Those resources are used here pretty much unchanged.<br><span class="segmentSeparator"></span>There is no need to change them.<br><span class="segmentSeparator"></span>Outbound mappings in the resource definitions specify the basic framework of the account.<br><span class="segmentSeparator"></span>The key to provisioning flexibility is usually not in the resource definition.<br><span class="segmentSeparator"></span>The key is in the roles.<br><span class="segmentSeparator"></span>But let’s start in the simplest way possible with the <code>Employee</code> role.<br><span class="segmentSeparator"></span>Example company policy states that every employee should have a very basic LDAP account.<br><span class="segmentSeparator"></span>Therefore all we need is a very simple LDAP account <em>construction</em> that we place into an <em>inducement</em> in the <code>Employee</code> role:</p>
</div>
<div class="listingblock">
<div class="title">role-employee.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">86d3b462-2334-11ea-bbac-13d84ce0a1df</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Employee<span class="tag">&lt;/name&gt;</span>
    <span class="tag">&lt;inducement&gt;</span>
        <span class="tag">&lt;construction&gt;</span>
            <span class="comment">&lt;!-- OpenLDAP --&gt;</span>
            <span class="tag">&lt;resourceRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">8a83b1a4-be18-11e6-ae84-7301fdab1d7c</span><span class="delimiter">"</span></span> <span class="tag">/&gt;</span>
            <span class="comment">&lt;!-- just basic account.<br><span class="segmentSeparator"></span>Nothing special here.<br><span class="segmentSeparator"></span>--&gt;</span>
        <span class="tag">&lt;/construction&gt;</span>
    <span class="tag">&lt;/inducement&gt;</span>
<span class="tag">&lt;/role&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All employees get this role by the means of inbound mapping on HR resource.<br><span class="segmentSeparator"></span>Therefore all employees will automatically get basic LDAP account.<br><span class="segmentSeparator"></span>As simple as that.<br><span class="segmentSeparator"></span>Put the construction in the role and the reconcile HR resource or just recompute the users.<br><span class="segmentSeparator"></span>LDAP accounts will be created.</p>
</div>
<div class="paragraph">
<p>But we want something that is a bit more fancy.<br><span class="segmentSeparator"></span>Salespeople are a bit sensitive when it comes to their professional image.<br><span class="segmentSeparator"></span>Therefore, they insist on having proper titles set up in company directory.<br><span class="segmentSeparator"></span>Not a problem.<br><span class="segmentSeparator"></span>We can do that easily in their "job" roles.<br><span class="segmentSeparator"></span>This is how it looks like for a sales manager:</p>
</div>
<div class="listingblock">
<div class="title">role-sales-manager.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">a1572de4-b9b9-11e9-af3e-5f68b3207f97</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Sales Manager<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;inducement&gt;</span>
        <span class="tag">&lt;construction&gt;</span>
            <span class="comment">&lt;!-- OpenLDAP --&gt;</span>
            <span class="tag">&lt;resourceRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">8a83b1a4-be18-11e6-ae84-7301fdab1d7c</span><span class="delimiter">"</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;attribute&gt;</span>
                <span class="tag">&lt;ref&gt;</span>ri:title<span class="tag">&lt;/ref&gt;</span>
                <span class="tag">&lt;outbound&gt;</span>
                    <span class="tag">&lt;expression&gt;</span>
                        <span class="tag">&lt;value&gt;</span>Sales Manager<span class="tag">&lt;/value&gt;</span>
                    <span class="tag">&lt;/expression&gt;</span>
                <span class="tag">&lt;/outbound&gt;</span>
            <span class="tag">&lt;/attribute&gt;</span>
        <span class="tag">&lt;/construction&gt;</span>
    <span class="tag">&lt;/inducement&gt;</span>
<span class="tag">&lt;/role&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This construction refers to the same account as the Employee role.<br><span class="segmentSeparator"></span>MidPoint knows that, therefore it does not attempt to create a new account.<br><span class="segmentSeparator"></span>It just updates existing account with appropriate title.<br><span class="segmentSeparator"></span>But that is still not enough.<br><span class="segmentSeparator"></span>We need to provide access to CRM system for the salespeople.<br><span class="segmentSeparator"></span>Should we create a new role for that?<br><span class="segmentSeparator"></span>Absolutely not.<br><span class="segmentSeparator"></span>We do not want to have too many roles as every role is a maintenance burden.<br><span class="segmentSeparator"></span>Let’s just add new construction to an existing job role:</p>
</div>
<div class="listingblock">
<div class="title">role-sales-manager.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;role</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">a1572de4-b9b9-11e9-af3e-5f68b3207f97</span><span class="delimiter">"</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;name&gt;</span>Sales Manager<span class="tag">&lt;/name&gt;</span>
    ...<br><span class="segmentSeparator"></span>    <span class="tag">&lt;inducement&gt;</span>
        <span class="tag">&lt;construction&gt;</span>
            <span class="comment">&lt;!-- OpenLDAP --&gt;</span>
            ...<br><span class="segmentSeparator"></span>        <span class="tag">&lt;/construction&gt;</span>
    <span class="tag">&lt;/inducement&gt;</span>
    <span class="tag">&lt;inducement&gt;</span>
        <span class="tag">&lt;construction&gt;</span>
            <span class="comment">&lt;!-- CRM --&gt;</span>
            <span class="tag">&lt;resourceRef</span> <span class="attribute-name">oid</span>=<span class="string"><span class="delimiter">"</span><span class="content">04afeda6-394b-11e6-8cbe-abf7ff430056</span><span class="delimiter">"</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;attribute&gt;</span>
                <span class="tag">&lt;ref&gt;</span>ri:accesslevel<span class="tag">&lt;/ref&gt;</span>
                <span class="tag">&lt;outbound&gt;</span>
                    <span class="tag">&lt;expression&gt;</span>
                        <span class="tag">&lt;value&gt;</span>MANAGER<span class="tag">&lt;/value&gt;</span>
                    <span class="tag">&lt;/expression&gt;</span>
                <span class="tag">&lt;/outbound&gt;</span>
            <span class="tag">&lt;/attribute&gt;</span>
        <span class="tag">&lt;/construction&gt;</span>
    <span class="tag">&lt;/inducement&gt;</span>
<span class="tag">&lt;/role&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is the only role that gives access to the CRM system for a sales manager.<br><span class="segmentSeparator"></span>MidPoint knows that and it automatically creates a new CRM account when the role is assigned.<br><span class="segmentSeparator"></span>Outbound mappings from the CRM resource definition are used to set basic properties of CRM account, such as account identifiers and password.<br><span class="segmentSeparator"></span>In addition to that, the Sales Manager role sets appropriate access level to the CRM system.</p>
</div>
<div class="paragraph">
<p>Our setup is almost complete now.<br><span class="segmentSeparator"></span>We have inbound synchronization, object template, roles and outbound mappings.<br><span class="segmentSeparator"></span>This is the right time to test everything.<br><span class="segmentSeparator"></span>Select few representative HR accounts and try to import them.<br><span class="segmentSeparator"></span>Check that everything is provisioned correctly.<br><span class="segmentSeparator"></span>If it works, then it is the time for roll-out.<br><span class="segmentSeparator"></span>Set up a synchronization task for the HR resource and we are done.<br><span class="segmentSeparator"></span>We have running system:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/08-03-users-final.png" alt="Users">
</div>
</div>
<div class="paragraph">
<p>This is nice little identity management deployment.<br><span class="segmentSeparator"></span>But there is still a lot of things to do here.<br><span class="segmentSeparator"></span>Maybe we want to set up a formalized organizational structure.<br><span class="segmentSeparator"></span>Maybe we need delegated administration.<br><span class="segmentSeparator"></span>Maybe we have several object types and we want to set up archetypes for them.<br><span class="segmentSeparator"></span>We almost certainly want to manage groups, privileges and other entitlements.<br><span class="segmentSeparator"></span>This is still just a beginning.</p>
</div>
</div>
<div class="sect2">
<h3 id="_conclusion_3">Conclusion</h3>
<div class="paragraph">
<p>This chapter concludes one whole part of the book.<br><span class="segmentSeparator"></span>If you have followed the book so far, you should be able to set up a simple working IDM deployment at this point.<br><span class="segmentSeparator"></span>We have covered all the basic mechanisms: resources, mappings, roles, schema and object templates.<br><span class="segmentSeparator"></span>This is a good time to stop reading and get your hands dirty.<br><span class="segmentSeparator"></span>Take the examples from this book and play a bit with them.<br><span class="segmentSeparator"></span>Explore the examples that come with midPoint distribution.<br><span class="segmentSeparator"></span>Now it is time for experiments.<br><span class="segmentSeparator"></span>You will surely do a lot of things that are suboptimal or even outright wrong.<br><span class="segmentSeparator"></span>But never mind.<br><span class="segmentSeparator"></span>This is part of the learning process.<br><span class="segmentSeparator"></span>If you get to dead end, just scrap everything and start over.<br><span class="segmentSeparator"></span>Or maybe rework everything from the ground up.<br><span class="segmentSeparator"></span>MidPoint is designed for this.<br><span class="segmentSeparator"></span>Evolutionary approach is deeply embedded in midPoint philosophy and design.<br><span class="segmentSeparator"></span>Just go ahead, have fun, conduct experiments and explore.<br><span class="segmentSeparator"></span>Such experience will help a lot when you get back and read through following chapters.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="90-troubleshooting">9.<br><span class="segmentSeparator"></span>Troubleshooting</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
The problem is not that there are problems.<br><span class="segmentSeparator"></span>The problem is expecting otherwise and thinking that having problems is a problem.<br><span class="segmentSeparator"></span></blockquote>
<div class="attribution">
— Theodore Rubin
</div>
</div>
<div class="paragraph">
<p>MidPoint is one big and comprehensive system.<br><span class="segmentSeparator"></span>Generally speaking, identity management systems tend to be big and complex.<br><span class="segmentSeparator"></span>They have a lot of things to do.<br><span class="segmentSeparator"></span>There is a lot of data mapping, synchronization, policies, access control models, expressions and all such stuff.<br><span class="segmentSeparator"></span>While each individual mechanism in itself is relatively simple, the combination of those mechanisms often creates something that would put the famous labyrinth of Knossos to shame.<br><span class="segmentSeparator"></span>Especially junior engineers tend to create configurations that are unnecessarily complex.<br><span class="segmentSeparator"></span>Those configurations may work for common cases.<br><span class="segmentSeparator"></span>But then there comes a corner case and the result is a puzzled look at junior engineer’s face and a mysterious smile of his senior colleagues.<br><span class="segmentSeparator"></span>At that point junior engineers tend to panic and switch to high-energy trial-and-error mode.<br><span class="segmentSeparator"></span>Which usually does even more harm.<br><span class="segmentSeparator"></span>What is really needed here is to stand back, to think about the situation and start to troubleshoot the problem in a systematic way.</p>
</div>
<div class="paragraph">
<p>But even senior engineers often get into trouble.<br><span class="segmentSeparator"></span>This is no weakness.<br><span class="segmentSeparator"></span>MidPoint is really flexible and sometimes it is hard to figure out what exactly is going on.<br><span class="segmentSeparator"></span>In fact, midPoint has surprised even its authors on more than one occasion.<br><span class="segmentSeparator"></span>When midPoint misbehaves, then the cause is almost always a configuration problem.<br><span class="segmentSeparator"></span>But there are usually thousands upon thousands of users, roles, policies and expressions.<br><span class="segmentSeparator"></span>There is a lot of places where a little treacherous problem can hide and live happily ever after.</p>
</div>
<div class="paragraph">
<p>All of that was perfectly clear to midPoint developers even before midPoint project started.<br><span class="segmentSeparator"></span>MidPoint developers are more than just programmers.<br><span class="segmentSeparator"></span>Writing midPoint code takes a good part of developer’s day.<br><span class="segmentSeparator"></span>But there is also testing, diagnostics of bugs and helping our colleagues and partners to figure out what is going on when the things get really tough.<br><span class="segmentSeparator"></span>The developers would be lost without an efficient method to diagnose the behavior of midPoint.<br><span class="segmentSeparator"></span>Therefore diagnostic systems were an integral part of midPoint design.</p>
</div>
<div class="paragraph">
<p>This chapter will provide an overview of the diagnostics mechanisms in midPoint.<br><span class="segmentSeparator"></span>But even more importantly, it will describe the method that can help to find the problem in a systematic and reliable way.<br><span class="segmentSeparator"></span>That is what every engineer should learn and use every day.<br><span class="segmentSeparator"></span>In fact, troubleshooting is perhaps the most important skill for smooth deployment of any software system.</p>
</div>
<div class="sect2">
<h3 id="_designed_for_visibility">Designed for Visibility</h3>
<div class="paragraph">
<p>MidPoint is designed, developed and maintained by a very unique team.<br><span class="segmentSeparator"></span>What is really unique in midPoint core team is the presence of identity management engineers very early in midPoint design.<br><span class="segmentSeparator"></span>Several key people that took part in midPoint design were involved in IDM projects since early 2000s.<br><span class="segmentSeparator"></span>That experience was crucial – especially bad experience from the use of the technologies that were available at the time.<br><span class="segmentSeparator"></span>One of the most important lessons that can be learned from fist-generation IDM systems is a lesson of visibility.<br><span class="segmentSeparator"></span>All those systems were closed, their vendors jealously guarding all the secrets of inner workings of those systems.<br><span class="segmentSeparator"></span>This made troubleshooting a very demanding task.<br><span class="segmentSeparator"></span>Engineers often had to resort to desperate measures, such as calling vendor’s support help desk.<br><span class="segmentSeparator"></span>But even such drastic actions usually did not help much.<br><span class="segmentSeparator"></span>It was a real struggle.</p>
</div>
<div class="paragraph">
<p>When midPoint project started, the team agreed to take a different approach.<br><span class="segmentSeparator"></span>MidPoint is radically open.<br><span class="segmentSeparator"></span>It is an open source project from the day one.<br><span class="segmentSeparator"></span>There is a reasonable documentation, even including architectural documentation and design notes.<br><span class="segmentSeparator"></span>All of that is public.<br><span class="segmentSeparator"></span>And most importantly, the visibility goes deep down in midPoint implementation.<br><span class="segmentSeparator"></span>Great attention was paid for proper logging as that is the primary troubleshooting mechanism.<br><span class="segmentSeparator"></span>There are various diagnostic mechanisms in midPoint user interface, performance metrics and so on.<br><span class="segmentSeparator"></span>And all of that is improved in every midPoint release.</p>
</div>
<div class="paragraph">
<p>However, the most important thing is to know how to use those mechanisms properly.<br><span class="segmentSeparator"></span>Even the best diagnostics mechanism will not do any good for you if it shows the data that you do not need at the moment.<br><span class="segmentSeparator"></span>It is important to know where to start, where to look and what to look for.<br><span class="segmentSeparator"></span>And that are the questions that this chapter should answer.</p>
</div>
</div>
<div class="sect2">
<h3 id="_systematic_approach">Systematic Approach</h3>
<div class="paragraph">
<p>Where to start?<br><span class="segmentSeparator"></span>That is a question that troubles most engineers that are new to midPoint.<br><span class="segmentSeparator"></span>Senior engineers would probably think that this is a silly question and the answer is obvious.<br><span class="segmentSeparator"></span>But it is not.<br><span class="segmentSeparator"></span>And it gets even harder to figure out how to follow the trace of the problem deeper into midPoint configuration.</p>
</div>
<div class="paragraph">
<p>Start with the obvious.<br><span class="segmentSeparator"></span>Maybe there is an error message right in front of your eyes.<br><span class="segmentSeparator"></span>MidPoint usually provides a lot of details that come with error message.<br><span class="segmentSeparator"></span>Then there are log files.<br><span class="segmentSeparator"></span>MidPoint logs a huge amount of information, it just needs to be enabled.</p>
</div>
<div class="paragraph">
<p>The usual troubleshooting sequence goes like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>What exactly is the problem?</strong>
What are the symptoms?<br><span class="segmentSeparator"></span>Does the operation fail?<br><span class="segmentSeparator"></span>Is there an error message?<br><span class="segmentSeparator"></span>Does it crash?<br><span class="segmentSeparator"></span>Did it produce wrong results?<br><span class="segmentSeparator"></span>Or are there no results at all?<br><span class="segmentSeparator"></span>What was the supposed result?<br><span class="segmentSeparator"></span>Can this me an error in the input data?</p>
</li>
<li>
<p>If there is an <strong>error message</strong>, what is that message saying?<br><span class="segmentSeparator"></span>Is there any additional information in the message or in the operation result that comes with the message?<br><span class="segmentSeparator"></span>Where is the error coming from?<br><span class="segmentSeparator"></span>It is an error from a connector?<br><span class="segmentSeparator"></span>Or an error from an expression?</p>
</li>
<li>
<p>Is there any additional information in the <strong>log file</strong>?<br><span class="segmentSeparator"></span>Are there any errors or warnings in the log file that may cause the problem?</p>
</li>
<li>
<p><strong>What was midPoint doing</strong>, exactly?<br><span class="segmentSeparator"></span>Is there any information about the operation progress when log level is set to DEBUG?<br><span class="segmentSeparator"></span>What are the intermediary results of the processing?<br><span class="segmentSeparator"></span>Are those correct?<br><span class="segmentSeparator"></span>At which point in the operation are data getting wrong?</p>
</li>
<li>
<p><strong>Where exactly is the problem?</strong>
Which component, configuration, mapping or expression are causing it?<br><span class="segmentSeparator"></span>What are the details of the operation?<br><span class="segmentSeparator"></span>Are there any hints if you set logging level of that component to <code>TRACE</code>?</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The first step is perhaps obvious – even though too many people fail to see what is right in front of their eyes.<br><span class="segmentSeparator"></span>But once you have opened your eyes and checked for the obvious causes, then there is time to go deeper.</p>
</div>
<div class="paragraph">
<p>Once you have ruled out the obvious cases you will need to have a look at midPoint log files.<br><span class="segmentSeparator"></span>You will need to follow the trace and examine the operations that midPoint was doing.<br><span class="segmentSeparator"></span>The best strategy here is one of <em>divide and conquer</em>.<br><span class="segmentSeparator"></span>In other words, start in the middle.<br><span class="segmentSeparator"></span>Find a convenient starting point in the middle of the processing.<br><span class="segmentSeparator"></span>Where exactly that middle is depends on the nature of the problem.<br><span class="segmentSeparator"></span>If the problem is related to a connector, then the best starting point is probably a connector framework.<br><span class="segmentSeparator"></span>Does the operation make sense?<br><span class="segmentSeparator"></span>Are the values correct?<br><span class="segmentSeparator"></span>If the answer is "yes", then the problem is probably in the connector.<br><span class="segmentSeparator"></span>If the answer is "no" then the problem is in midPoint configuration.<br><span class="segmentSeparator"></span>Either way you know where you should focus your investigation.<br><span class="segmentSeparator"></span>If that problem is in midPoint, then in which part it is?<br><span class="segmentSeparator"></span>Are data in the user object correct?<br><span class="segmentSeparator"></span>If they are, then the problem is probably in the outbound mappings.<br><span class="segmentSeparator"></span>Have a look at those.<br><span class="segmentSeparator"></span>And so on.<br><span class="segmentSeparator"></span>Start with a big thing.<br><span class="segmentSeparator"></span>And then follow the clues and dive into the details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_error_messages_and_operation_results">Error Messages and Operation Results</h3>
<div class="paragraph">
<p>Error messages are the most obvious troubleshooting mechanisms.<br><span class="segmentSeparator"></span>MidPoint error messages usually provide enough information to diagnose and fix trivial problems right away.</p>
</div>
<div class="paragraph">
<p>MidPoint error messages are in fact part of a more complex system of <em>operation results</em>.<br><span class="segmentSeparator"></span>Operation result is a data structure that accompanies every midPoint operation.<br><span class="segmentSeparator"></span>The operation records important points during the processing in the operation result.<br><span class="segmentSeparator"></span>Operation result is hierarchical.<br><span class="segmentSeparator"></span>There is one big operation at the top.<br><span class="segmentSeparator"></span>But that usually consists of smaller operations which in turn consist of even smaller operations.<br><span class="segmentSeparator"></span>Connector operations are somewhere at the bottom.<br><span class="segmentSeparator"></span>If the top-level message does not provide information about the problem, then dig deeper.<br><span class="segmentSeparator"></span>Expand the sub-operations until you find the root cause.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/90-01-operation-result-expanded.png" alt="Operation result">
</div>
</div>
<div class="paragraph">
<p>Operation result can be used to get a rough idea what midPoint was doing and what are the results.<br><span class="segmentSeparator"></span>Each of the operations in the result has a status:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Status</th>
<th class="tableblock halign-left valign-top">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SUCCESS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operation completed.<br><span class="segmentSeparator"></span>The operation has finished successfully.<br><span class="segmentSeparator"></span>There are no errors.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>WARNING</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operation completed.<br><span class="segmentSeparator"></span>But there are warnings.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PARTIAL_ERROR</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operation completed.<br><span class="segmentSeparator"></span>Some parts of the operation were successful, other parts of the operations resulted in an error.<br><span class="segmentSeparator"></span>However, the operation was not stopped and the execution continued despite the errors.</p>
<p class="tableblock">Partial error is often indicated in case that user modification is successful but account modification fails.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FATAL_ERROR</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operation was interrupted due to an error.<br><span class="segmentSeparator"></span>The error prohibited completion of the operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>HANDLED_ERROR</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operation completed.<br><span class="segmentSeparator"></span>An error was experienced during execution of the operation.<br><span class="segmentSeparator"></span>However, the error was handled and the system was able to compensate the effects of the error.<br><span class="segmentSeparator"></span>The results should be equivalent to a successful operation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NOT_APPLICABLE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operation was not even started because the operation is not applicable to the inputs.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>IN_PROGRESS</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Operation is in progress.<br><span class="segmentSeparator"></span>The operation was started, but it was not yet finished.</p>
<p class="tableblock">This status is seen for operations that execute “in the background”, in running tasks and so on.<br><span class="segmentSeparator"></span>But it may also be used for operations that are waiting for an external event, such as approval operations or operation retries.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UNKNOWN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Status of the operation is not known.</p>
<p class="tableblock">This status code should not be normally seen.<br><span class="segmentSeparator"></span>However, it may happen under special circumstances.<br><span class="segmentSeparator"></span>For example, if a bug in midPoint or a connector leaves the operation in an uncertain state or in case that unforeseen error appeared and it was not handled properly.<br><span class="segmentSeparator"></span>This status usually indicates a programming bug.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Operation result is a very useful data structure.<br><span class="segmentSeparator"></span>It has many purposes.<br><span class="segmentSeparator"></span>For example, it is stored in the tasks and provides data for later diagnostics.<br><span class="segmentSeparator"></span>It can summarize the operations, provide performance data and so on.<br><span class="segmentSeparator"></span>But that means that the operation result cannot be too big.<br><span class="segmentSeparator"></span>And therefore the granularity of the operation result is usually quite rough to pinpoint serious issues.<br><span class="segmentSeparator"></span>Issues that are really tricky usually cannot be resolved by examination of operation results.<br><span class="segmentSeparator"></span>For that we need to go deeper still.</p>
</div>
</div>
<div class="sect2">
<h3 id="_logging_2">Logging</h3>
<div class="paragraph">
<p>Logging is the best tool in the troubleshooting toolbox.<br><span class="segmentSeparator"></span>Logging provides information about the important things that happen in the system.<br><span class="segmentSeparator"></span>But it also goes very deep and it can provide very fine details about midPoint operations.<br><span class="segmentSeparator"></span>Logging is universal and very powerful.<br><span class="segmentSeparator"></span>It is the best hope to find the cause even for the trickiest of problems.</p>
</div>
<div class="paragraph">
<p>As for every other tool, the most important thing is to know how to use it properly.<br><span class="segmentSeparator"></span>This is especially important for midPoint logging.<br><span class="segmentSeparator"></span>The default logging setting logs only a very little information.<br><span class="segmentSeparator"></span>This is a reasonable detail for a production system that has been properly configured and tested.<br><span class="segmentSeparator"></span>But it is not enough in case that you are chasing a configuration.<br><span class="segmentSeparator"></span>In that case the logging system needs to be reconfigured to log more information.<br><span class="segmentSeparator"></span>But beware, if logging system is set to its full power you will get a huge stream of data that is likely to completely overwhelm you.<br><span class="segmentSeparator"></span>The important information will surely be there.<br><span class="segmentSeparator"></span>But they will be lost in the flood of other data.<br><span class="segmentSeparator"></span>Therefore logging need some skill and experience to manage it correctly.</p>
</div>
<div class="paragraph">
<p>MidPoint is using logging approach that is well established in the industry.<br><span class="segmentSeparator"></span>MidPoint logging principles should be quite familiar to any deployment engineer.<br><span class="segmentSeparator"></span>However, it is perhaps worth to provide a quick overview of those basic principles.</p>
</div>
<div class="paragraph">
<p>MidPoint log files are located in midPoint home directory.<br><span class="segmentSeparator"></span>This is usually var sub-directory of midPoint installation directory.<br><span class="segmentSeparator"></span>MidPoint home directory contains sub-directory logs and midPoint logfiles are there.<br><span class="segmentSeparator"></span>There are usually several files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>midpoint.log</code> is the primary midPoint log file.<br><span class="segmentSeparator"></span>Almost all of log messages from midPoint will be recorded here.<br><span class="segmentSeparator"></span>This is the right file to examine.<br><span class="segmentSeparator"></span>The truth is in there.</p>
</li>
<li>
<p><code>midpoint.out</code> is file where the standard output of midPoint process is recorded.<br><span class="segmentSeparator"></span>Only a very few things are usually logged here.<br><span class="segmentSeparator"></span>Those are the things that happen before midPoint logging system is enabled, therefore midPoint cannot control and redirect logging of those messages.<br><span class="segmentSeparator"></span>Which that the messages usually describe events that happen before midPoint starts and after it stops.<br><span class="segmentSeparator"></span>This file does not need to be inspected routinely.<br><span class="segmentSeparator"></span>However, it is a useful place to look while experiencing startup issues.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Log files are usually rotated.<br><span class="segmentSeparator"></span>Which means that when there is too much data in one log file the file is renamed.<br><span class="segmentSeparator"></span>Oldest files are removed.<br><span class="segmentSeparator"></span>Otherwise the log files would fill all available disk space.</p>
</div>
<div class="paragraph">
<p>Log messages have a structured format.<br><span class="segmentSeparator"></span>They look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>2019-08-16 16:40:25,863 [PROVISIONING] [main] INFO (com.evolveum.midpoint.provisioning.impl.ProvisioningServiceImpl): Discovered local connector connector: ConnId com.evolveum.polygon.connector.ldap.LdapConnector v2.3 (OID:268678c0-b5b3-4b13-a399-c2fbd903e51d)</pre>
</div>
</div>
<div class="paragraph">
<p>The fields are described in the following table.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Field</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timestamp</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Timestamp of a moment when the message was generated.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>2019-08-16 16:40:25,863</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Component name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of the component where the message originated.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[PROVISIONING]</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Thread name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name of thread in which the message originated.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[main]</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Log level</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Severity level of the message.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>INFO</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logger name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is usually package name or a fully-qualified name of the class that produced the message.<br><span class="segmentSeparator"></span>But there may be special-purpose loggers with special names.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.evolveum.midpoint.provisioning.impl.ProvisioningServiceImpl</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Content of log message.<br><span class="segmentSeparator"></span>This is usually single-line message.<br><span class="segmentSeparator"></span>But multi-line messages are common on finer log levels.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Discovered local connector connector: ConnId com.evolveum.polygon.connector.ldap.LdapConnector v2.3 (OID:268678c0-b5b3-4b13-a399-c2fbd903e51d)</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>As midPoint takes advantage of parallel processing, the thread name is often useful to filter out messages that belong to a single operation.<br><span class="segmentSeparator"></span>The logger name is sometimes abbreviated, therefore <code>com.evolveum.midpoint.provisioning.impl.ProvisioningServiceImpl</code> becomes <code>c.e.m.provisioning.impl.ProvisioningServiceImpl</code>.<br><span class="segmentSeparator"></span>Otherwise the log message format is similar to message formats of other products and it should be quite familiar to most system engineers.<br><span class="segmentSeparator"></span>This is the default log message format.<br><span class="segmentSeparator"></span>The log format can be customized if needed.</p>
</div>
<div class="paragraph">
<p>The most important aspect of efficient usage of logging as a diagnostic tool is to control granularity of logging.<br><span class="segmentSeparator"></span>This is both a science and an art.<br><span class="segmentSeparator"></span>It requires some instincts and experience.<br><span class="segmentSeparator"></span>The granularity can be controlled in two "dimensions":</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Log level</strong> determines the level of details that is logged.<br><span class="segmentSeparator"></span><code>INFO</code> log level will log only the important events.<br><span class="segmentSeparator"></span><code>TRACE</code> level will log huge amount of information that is primarily interesting for developers.<br><span class="segmentSeparator"></span>This controls <em>depth</em> of logging.</p>
</li>
<li>
<p><strong>Package</strong> determines which midPoint components will log their messages.<br><span class="segmentSeparator"></span>Setting a log level for a particular package also enables logging of all sub-packages and classes.<br><span class="segmentSeparator"></span>This controls the <em>breadth</em> of logging.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Logging setting is a combination of a package and level.<br><span class="segmentSeparator"></span>Therefore, it is possible to get a very detailed logging from a single package while keeping logging of other packages at a very rough-grained level.<br><span class="segmentSeparator"></span>And this is exactly what is needed when chasing a bug.<br><span class="segmentSeparator"></span>We want to have a very precise look at the component where the problem occurs without being overwhelmed by a flood of data from other parts of midPoint.<br><span class="segmentSeparator"></span>The trick is to know which package and level to use.</p>
</div>
<div class="paragraph">
<p>Let’s start with log levels.<br><span class="segmentSeparator"></span>Each level has a precise definition of the amount of details it provides.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Level</th>
<th class="tableblock halign-left valign-top">Circumstances</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>FATAL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Critical errors.<br><span class="segmentSeparator"></span>The system cannot continue operation, will crash or stop working</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This is bad.<br><span class="segmentSeparator"></span>The system is going down.<br><span class="segmentSeparator"></span>There is not way that the system can run.<br><span class="segmentSeparator"></span>Big problem.<br><span class="segmentSeparator"></span>This should not happen.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ERROR</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Error that seriously affects the system, but the system as a whole can recover.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Typically caused by errors in the data, network errors and so on.<br><span class="segmentSeparator"></span>This is not good.<br><span class="segmentSeparator"></span>Sometimes the system can recover just by itself.<br><span class="segmentSeparator"></span>But manual intervention of system administrator is usually needed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>WARNING</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Suspicious situation.<br><span class="segmentSeparator"></span>System may be able to operate normally, but there may be a hidden or temporary problem or an indication of future error.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Important messages that should not occur in a well-configured and tuned systems.<br><span class="segmentSeparator"></span>If they appear they should be investigated.<br><span class="segmentSeparator"></span>However, the investigation can wait.<br><span class="segmentSeparator"></span>Immediate action is usually not required.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>INFO</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Important changes in system state, start/stop of important system tasks, etc.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Those events occur normally in almost all running systems.<br><span class="segmentSeparator"></span>Unless you have a very busy system this log level can be enabled all the time in production.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DEBUG</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Execution messages, state changes, expression evaluation messages and similar messages for system administrator.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This log level is dedicated for system administrators to debug the configuration.<br><span class="segmentSeparator"></span>It will provide reasonable amount of messages that can be used to find configuration problems.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TRACE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fine-grained messages about execution details.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This log level will provide a lot of data, lot of details.<br><span class="segmentSeparator"></span>Its primary purpose is to allow developers to find a bug in production systems.<br><span class="segmentSeparator"></span>However, this can also provide precious details for system administrators when troubleshooting really tricky problems.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The levels are organized in a hierarchy.<br><span class="segmentSeparator"></span>When <code>DEBUG</code> level is set for a particular package, the package will also log all messages with higher (rough-grain) levels.<br><span class="segmentSeparator"></span>The usual log level to start with when chasing a bug is <code>DEBUG</code> log level.<br><span class="segmentSeparator"></span>This may be too much for some packages or too little for other packages.<br><span class="segmentSeparator"></span>But it is a good overall starting point.</p>
</div>
<div class="paragraph">
<p>Log levels are simple and well defined.<br><span class="segmentSeparator"></span>However, figuring out proper package name is much harder.<br><span class="segmentSeparator"></span>Engineers that understand midPoint architecture and source code have a huge advantage here.<br><span class="segmentSeparator"></span>Logging package names are directly derived from Java packages and classes used in midPoint source code.<br><span class="segmentSeparator"></span>But even non-developers can learn how to use the package names efficiently.</p>
</div>
<div class="paragraph">
<p>The first thing to keep in mind is that midPoint is composed from subsystems and components.<br><span class="segmentSeparator"></span>Each subsystem and component has its own package name.<br><span class="segmentSeparator"></span>Those can be used to control logging of individual parts of midPoint.<br><span class="segmentSeparator"></span>Following table provides an overview of those architectural blocks.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Subsystem/component</th>
<th class="tableblock halign-left valign-top">Package name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">GUI</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.evolveum.midpoint.gui</code><br>
<code>com.evolveum.midpoint.web</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">User interface.<br><span class="segmentSeparator"></span>This subsystem drives all interaction with the user.</p>
<p class="tableblock"><strong>Note:</strong> the <code>*.web</code> package is legacy, but it is still used by a lot of code.<br><span class="segmentSeparator"></span>Both packages are needed for complete GUI logging.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Model</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.evolveum.midpoint.model</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">This subsystem implements most of the IDM logic in midPoint.<br><span class="segmentSeparator"></span>User processing, RBAC, organizational structure, policies – everything is processed here.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Provisioning</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.evolveum.midpoint.provisioning</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Communication with external systems.<br><span class="segmentSeparator"></span>This subsystem is responsible for communication with the connectors, management of shadow objects, driving live synchronization, manual connectors, operation retries, management of resources and connectors and so on.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ConnId</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.identityconnectors.framework</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ConnId connector framework.<br><span class="segmentSeparator"></span>This is responsible for running the connectors and passing operation to the connectors.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Repository</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.evolveum.midpoint.repo</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Primary responsibility is to store midPoint objects in the database.<br><span class="segmentSeparator"></span>But there is also task management, authorization processing, expression evaluation and so on.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Schema</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.evolveum.midpoint.schema</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definition of midPoint data model and various utilities.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Prism</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.evolveum.midpoint.prism</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Library that is parsing and storing objects in representation data formats (XML/JSON/YAML).</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Those package names can provide rough boundaries for logging.<br><span class="segmentSeparator"></span>Enabling <code>TRACE</code> level on an entire subsystem can still provide a lot of data, but it is better than enabling <code>TRACE</code> for whole midPoint.<br><span class="segmentSeparator"></span>The best approach here involves a look at midPoint source code.<br><span class="segmentSeparator"></span>But there is a still a way to do it without a source code:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Enable <code>DEBUG</code> level on the entire subsystem.<br><span class="segmentSeparator"></span>This is likely to provide a log of data, but it should not be overwhelming.</p>
</li>
<li>
<p>Look at the log file and try to figure out in which part the interesting things happen.<br><span class="segmentSeparator"></span>Where the things are getting out of control.<br><span class="segmentSeparator"></span>Observe name of the packages that are used in those messages.</p>
</li>
<li>
<p>Set <code>TRACE</code> level only for those packages or classes where interesting things happen.<br><span class="segmentSeparator"></span>You will get much more details.</p>
</li>
<li>
<p>Optionally mute some packages that show too much data by setting their log level to <code>INFO</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This is a good overall approach.<br><span class="segmentSeparator"></span>But there are few very specific packages that tend to attract problems.<br><span class="segmentSeparator"></span>Therefore they are often set to finer log levels.<br><span class="segmentSeparator"></span>Below is a list of those packages.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Package name</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Clockwork</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.evolveum.midpoint.model.impl.lens.Clockwork</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The "controller" that drives computation of all changes in midPoint.<br><span class="segmentSeparator"></span>Change of every object is passing through clockwork (unless it is "raw").</p>
<p class="tableblock">Enabling logging on clockwork will provide rough overview of the processing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Projector</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.evolveum.midpoint.model.impl.lens.projector.Projector</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The "brain" that computes all effects of the change.<br><span class="segmentSeparator"></span>It is invoked as part of the clockwork.</p>
<p class="tableblock">Enabling logging will provide overview of the computation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Change Executor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.evolveum.midpoint.model.impl.lens.ChangeExecutor</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The "hand" that executes all the computed changes.</p>
<p class="tableblock">Enabling logging will provide an overview of computed changes and the result of their application (success or failure).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Lens</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.evolveum.midpoint.model.impl.lens</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sub-component responsible for computing and processing all ordinary changes on objects.<br><span class="segmentSeparator"></span>It includes clockwork, projector and executor.</p>
<p class="tableblock">Setting <code>TRACE</code> level here will provide all the gory details about the processing.<br><span class="segmentSeparator"></span>Lots of data.<br><span class="segmentSeparator"></span>Use only in deep despair.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mappings</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.evolveum.midpoint.model.common.mapping.Mapping</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Code that is processing mappings.</p>
<p class="tableblock">Enabling logging will provide a short overview of mapping inputs and outputs with some insights into the inner processing.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expressions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.evolveum.midpoint.model.common.expression.Expression</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expression evaluation code.<br><span class="segmentSeparator"></span>Enabling logging will provide a lot of details about expression evaluation.<br><span class="segmentSeparator"></span>This is likely to produce a log of data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Script expressions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.evolveum.midpoint.model.common.expression.script.ScriptExpression</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logs a lot of details about script expression evaluation (Groovy, JavaScript, …​).</p>
<p class="tableblock">Provides a lot of details.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ConnId API Operations</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.identityconnectors.framework.api.operations</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Special package used to log summary of all connector operations that go through ConnId framework.<br><span class="segmentSeparator"></span>This is the API side of the framework (midPoint-ConnId boundary).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ConnId SPI Operations</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.identityconnectors.framework.spi.operations</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Special package used to log summary of all connector operations that go through ConnId framework.<br><span class="segmentSeparator"></span>This is the SPI side of the framework (ConnId-connector boundary).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Security</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.evolveum.midpoint.security</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Package that contains security-related components.</p>
<p class="tableblock">This is especially useful for debugging authorizations.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Setting <code>DEBUG</code> log level to clockwork, projector or change executor is a good starting point for diagnostics of problems related to mappings and assignments.<br><span class="segmentSeparator"></span>The ConnId operation log is a good starting point for connector related problems.<br><span class="segmentSeparator"></span>And security package is perhaps the only really efficient mechanism to debug misbehaving authorizations.</p>
</div>
<div class="paragraph">
<p>Logging is the best troubleshooting tool to handle even the most complex issues.<br><span class="segmentSeparator"></span>Therefore make sure you take full advantage of this tool.<br><span class="segmentSeparator"></span>The importance of logging can hardly be overstated.<br><span class="segmentSeparator"></span>Make sure you know how to set up logging properly and how to interpret log messages.<br><span class="segmentSeparator"></span>This is a skill that takes some time to learn.<br><span class="segmentSeparator"></span>But it is a crucial investment to make.<br><span class="segmentSeparator"></span>The time will be repaid many times over.<br><span class="segmentSeparator"></span>Therefore, if you have any problem that looks strange, remember one simple rule: <strong>always look at the log files</strong>.<br><span class="segmentSeparator"></span>The answer will be there.</p>
</div>
</div>
<div class="sect2">
<h3 id="_auditing">Auditing</h3>
<div class="paragraph">
<p>Purpose of the auditing mechanism is to record all operations in midPoint for accountability purposes.<br><span class="segmentSeparator"></span>Auditing will be used by security officers to inspect system activity, it may be used for forensic purposes or it can simply provide a data for statistical analyses.<br><span class="segmentSeparator"></span>However, the fact that auditing records all operations in the system can be a significant benefit for troubleshooting.</p>
</div>
<div class="paragraph">
<p>MidPoint user interface is quite comprehensive.<br><span class="segmentSeparator"></span>Despite that complexity, most operations of the user interface should be easily understandable in an intuitive way.<br><span class="segmentSeparator"></span>However, there are cases when it is not clear what exactly is user interface trying to do.<br><span class="segmentSeparator"></span>And some operations can even be quite counter-intuitive.<br><span class="segmentSeparator"></span>For example, designation of a deputy is an operation on a different user than most people would intuitively expect.<br><span class="segmentSeparator"></span>It is always an advantage to see all the details of an operation that user interface tries to initiate.<br><span class="segmentSeparator"></span>And that is where auditing mechanism comes in.<br><span class="segmentSeparator"></span>The auditing subsystem records all the operations in a precise, structured way.<br><span class="segmentSeparator"></span>Maybe midPoint does unexpected thing just because the operation request itself does not make sense.<br><span class="segmentSeparator"></span>Audit trail can be examined to make sure that the operation is correct.<br><span class="segmentSeparator"></span>Also, the results of the operation are recorded in the audit trail.<br><span class="segmentSeparator"></span>Audit may be a quick and efficient way to get an overview about the operation as a whole.</p>
</div>
<div class="paragraph">
<p>Audit may also be very handy when exploring bulk operations, such as results of synchronization or reconciliation runs.<br><span class="segmentSeparator"></span>The tasks in which those operations run will provide overview of the results, e.g.<br><span class="segmentSeparator"></span>they will provide the number of errors.<br><span class="segmentSeparator"></span>But the task data structure cannot hold the details of each operation.<br><span class="segmentSeparator"></span>Such data structures would be huge.<br><span class="segmentSeparator"></span>However, there are audit records for each of those operations.<br><span class="segmentSeparator"></span>Those records can be used to figure out what went wrong exactly: which objects have failed, what operations were attempted, what exactly is the outcome.</p>
</div>
<div class="paragraph">
<p>Audit trail is one of the few places in midPoint where historical data are kept.<br><span class="segmentSeparator"></span>All other parts of midPoint are concerned about <em>here and now</em>, historical data are usually kept only for informational purposes.<br><span class="segmentSeparator"></span>But audit log is different.<br><span class="segmentSeparator"></span>Audit log stores historical data, therefore it can be used to get an overview of midPoint operations in the past.<br><span class="segmentSeparator"></span>Common use of audit trail is to get overview of daily operations.<br><span class="segmentSeparator"></span>For example, audit records can provide data on how many operations were processed during the past day, which operations have failed during last few hours and so on.<br><span class="segmentSeparator"></span>There is a special type of report to show such information.<br><span class="segmentSeparator"></span>There is also a dashboard widget that is designed to show such audit-based information for monitoring purposes.</p>
</div>
<div class="paragraph">
<p>However, please keep in mind that midPoint is an identity management system.<br><span class="segmentSeparator"></span>It is not a SIEM system or a data warehouse.<br><span class="segmentSeparator"></span>MidPoint is not designed to keep and process massive amount of historical data.<br><span class="segmentSeparator"></span>Therefore even the use of audit trails has its limits.<br><span class="segmentSeparator"></span>Keeping audit trail in midPoint database for a short period of time is usually perfectly acceptable.<br><span class="segmentSeparator"></span>However, a more suitable system should be used for a long-term storage and processing of audit trail data.</p>
</div>
<div class="paragraph">
<p>Typical midPoint deployment records audit trails in the database table.<br><span class="segmentSeparator"></span>This is the right method to use for production deployment.<br><span class="segmentSeparator"></span>However, there is another option.<br><span class="segmentSeparator"></span>Audit records can be also recorded in the log files.<br><span class="segmentSeparator"></span>This is not something that is recommended for a production deployment.<br><span class="segmentSeparator"></span>In that case it is quite likely to flood the logs and it may even disclose sensitive data.<br><span class="segmentSeparator"></span>However, directing audit records into system logs may provide interesting benefits in development environments.<br><span class="segmentSeparator"></span>For example, in case that a detailed debug logging is used, audit records will provide summary of operation and the outcome in the same log together with all the details.<br><span class="segmentSeparator"></span>It makes it easier to analyze the log files.<br><span class="segmentSeparator"></span>As audit data is recorded close to the operation start and operation end, audit log entries also provide a “frame” for the operation.<br><span class="segmentSeparator"></span>It may be easier to find start and end of the operation in the logfile.</p>
</div>
<div class="paragraph">
<p>Recording audit messages can be enabled in user interface, in the part where ordinary logging is configured.<br><span class="segmentSeparator"></span>There is an “Audit” section on that page.<br><span class="segmentSeparator"></span>Audit log message looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>2019-08-19 15:02:05,367 [MODEL] [pool-3-thread-6] INFO (com.evolveum.midpoint.audit.log): 2019-08-19T15:02:05.367+0200 eid=1566219725367-0-1, et=MODIFY_OBJECT, es=REQUEST, sid=DF97547B47BC6795D941B8C28AFB6089, rid=d0c90fdf-d101-457b-baf9-ea0371637a1d, tid=1566219725331-0-1, toid=null, hid=localhost, nid=DefaultNode, raddr=127.0.0.1, I=FocusType:00000000-0000-0000-0000-000000000002(user), T=PRV(oid=df2210ad-3eec-4f59-9b11-46479b9ebc7c, targetType={.../common/common-3}UserType, targetName=alice, relation={.../common/org-3}default), TO=null, D=[df2210ad-3eec-4f59-9b11-46479b9ebc7c:MODIFY], ch=http://midpoint.evolveum.com/xml/ns/public/gui/channels-3#user, o=null, p=null, m=</pre>
</div>
</div>
<div class="paragraph">
<p>This is a semi-structure message that provides summary of significant fields of the audit record.<br><span class="segmentSeparator"></span>Detailed audit logging can also be enabled.<br><span class="segmentSeparator"></span>In that case the deltas will be dumped in the log files.</p>
</div>
</div>
<div class="sect2">
<h3 id="_troubleshooting_clockwork_and_projector">Troubleshooting Clockwork and Projector</h3>
<div class="paragraph">
<p>MidPoint has many components that have diverse responsibilities.<br><span class="segmentSeparator"></span>But there is one set of components that can be described as a heart (or rather a brain) of midPoint.<br><span class="segmentSeparator"></span>It is the set of components known as "lens".<br><span class="segmentSeparator"></span>Clockwork and Projector are two most prominent classes in that set.<br><span class="segmentSeparator"></span>Projector is responsible for computing the values, running the mappings, processing assignment and almost anything else related to the computation of identity data.<br><span class="segmentSeparator"></span>Clockwork is responsible for controlling the process.<br><span class="segmentSeparator"></span>It invokes Projector as many times as is needed to complete the computation.<br><span class="segmentSeparator"></span>Clockwork also invokes <code>ChangeExecutor</code> to carry out the changes.</p>
</div>
<div class="paragraph">
<p>The overall request processing in midPoint works like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User clicks on <em>Save</em> button in midPoint user interface.<br><span class="segmentSeparator"></span>User interface code computes what operation needs to be done.</p>
</li>
<li>
<p>Operation on <code>ModelService</code> is invoked.<br><span class="segmentSeparator"></span>This is usually <code>executeChanges(…​)</code> operation.<br><span class="segmentSeparator"></span>Deltas that describe requested changes are passed as a parameter of this operation.</p>
</li>
<li>
<p>The operation is passed to <code>Clockwork</code> to control the operation.</p>
</li>
<li>
<p><code>Projector</code> is invoked to compute all the changes.<br><span class="segmentSeparator"></span>The changes are recorded in <em>model context</em>.<br><span class="segmentSeparator"></span>The changes are computed, but not executed yet.<br><span class="segmentSeparator"></span>Mappings and expressions are evaluated at this point.</p>
</li>
<li>
<p><code>Clockwork</code> figures out what to do with the operation.<br><span class="segmentSeparator"></span>There may be a need to drive the operation through approval process.<br><span class="segmentSeparator"></span>Or a special hooks may be invoked.<br><span class="segmentSeparator"></span>Maybe the operation violates the policy rules therefore it needs to be stopped.<br><span class="segmentSeparator"></span><code>Clockwork</code> does what needs to be done.</p>
</li>
<li>
<p><code>ChangeExecutor</code> is invoked to carry out the changes.<br><span class="segmentSeparator"></span>Changes to users, roles and other focal objects are carried out by changing the data in midPoint repository.<br><span class="segmentSeparator"></span>That is quite straightforward.<br><span class="segmentSeparator"></span>However, changes to projections (objects that reside in resources) are much more complicated.</p>
</li>
<li>
<p><code>Provisioning</code> service is invoked to carry out changes to projections.<br><span class="segmentSeparator"></span>The changes are expressed as changes to shadow objects (<code>ShadowType</code>).<br><span class="segmentSeparator"></span>Some of those changes are recorded in midPoint database, such as changes in identifier or metadata.<br><span class="segmentSeparator"></span>However, most of the changes need to be carried out on a resource by using a connector.</p>
</li>
<li>
<p>Connector framework (ConnId) is invoked to initiate resource operation by using appropriate connector.</p>
</li>
<li>
<p>Connector is invoked.<br><span class="segmentSeparator"></span>Connector initiates the operation on resources and gets the results.</p>
</li>
<li>
<p>Operation results get back to <code>ChangeExecutor</code> and then to <code>Clockwork</code>.<br><span class="segmentSeparator"></span>Results are summarized.<br><span class="segmentSeparator"></span>If there is an error it is decided whether to continue or whether to stop the operation.<br><span class="segmentSeparator"></span>At the end <code>Clockwork</code> records the final audit record and returns control back to the caller.<br><span class="segmentSeparator"></span>Operation is finished.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Sometimes it is not possible to compute everything in a single pass.<br><span class="segmentSeparator"></span>There may be dependencies between resources, result of one operation may be an input to another operation.<br><span class="segmentSeparator"></span>For that reason clockwork and projector work in <em>waves</em>.<br><span class="segmentSeparator"></span>Therefore several steps described above may be repeated in each wave.<br><span class="segmentSeparator"></span>Clockwork and projector exchange control in each wave until the operation is done.</p>
</div>
<div class="paragraph">
<p>Following picture provides a structural view of this setup.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/90-02-lens-provisioning-structure.png" alt="Model and provisioning structure">
</div>
</div>
<div class="paragraph">
<p>This process is moving around a lot of data.<br><span class="segmentSeparator"></span>Those data are recorded in <em>model context</em>.<br><span class="segmentSeparator"></span>It is a data structure that describes the operations, it holds all related objects, intermediary computation results and all other important data.<br><span class="segmentSeparator"></span>This data structure is absolutely crucial for the entire process.<br><span class="segmentSeparator"></span>But it also provides valuable troubleshooting information.<br><span class="segmentSeparator"></span>When appropriate log packages and levels are enabled, the model context is dumped to log files at important moments during the computation.<br><span class="segmentSeparator"></span>Often the best way how to find a problem is to watch how the model contest changes during the computation.</p>
</div>
<div class="paragraph">
<p>The model context is putting together the <em>focus</em> and <em>projections</em> that belong together.<br><span class="segmentSeparator"></span>Focus is usually a user, projections are accounts.<br><span class="segmentSeparator"></span>In such case, the model context groups together a user with all the accounts are associated with that accounts.<br><span class="segmentSeparator"></span>These are usually accounts that are linked to the user.<br><span class="segmentSeparator"></span>But it also may be a new account that was not yet created, an old account that was recently deleted, etc.<br><span class="segmentSeparator"></span>MidPoint groups all these objects together to allow efficient computation of assignments and mappings and other policies.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./Practical Identity Management With MidPoint_files/90-03-model-context.png" alt="Model context">
</div>
</div>
<div class="paragraph">
<p>Model Context has three parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <strong>context</strong> itself contains information about the entire computation (such as computation state and wave number).</p>
</li>
<li>
<p><strong>Focus</strong> part which contains information about focal object.<br><span class="segmentSeparator"></span>There is at most one focus.</p>
</li>
<li>
<p><strong>Projection</strong> part which contains information about each projection.<br><span class="segmentSeparator"></span>There may be multiple projections.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Focus and projection parts have similar structure.<br><span class="segmentSeparator"></span>Both of these parts contain:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Old object:</strong> the object (focus or projection) as it was before the computation.<br><span class="segmentSeparator"></span>This means really the beginning of computation.<br><span class="segmentSeparator"></span>Please note that the computation can take several days e.g.<br><span class="segmentSeparator"></span>if the request waits for approval.</p>
</li>
<li>
<p><strong>Current object:</strong> the object as it was last time the Projector loaded the object.<br><span class="segmentSeparator"></span>This is usually quite recent information (at most few seconds old).</p>
</li>
<li>
<p><strong>New object:</strong> the expected form of new object after the computation.<br><span class="segmentSeparator"></span>This item is here mostly for informational purposes and for diagnostics.<br><span class="segmentSeparator"></span>The actual value of the result may be slightly different (e.g.<br><span class="segmentSeparator"></span>if two operations are carried out over the same object in parallel).</p>
</li>
<li>
<p><strong>Primary delta:</strong> The request delta.<br><span class="segmentSeparator"></span>This is the delta that was explicitly entered in the GUI, supplied to the web service or otherwise specified in IDM Model Interface invocation.<br><span class="segmentSeparator"></span>This is the "command" that midPoint should execute.<br><span class="segmentSeparator"></span>This defines what user wants.<br><span class="segmentSeparator"></span>This delta will be executed exactly as it was specified.</p>
</li>
<li>
<p><strong>Secondary delta:</strong> The computed delta.<br><span class="segmentSeparator"></span>Secondary delta originates from execution of mappings or hooks or other automated mechanisms.<br><span class="segmentSeparator"></span>This describes what midPoint has computed.<br><span class="segmentSeparator"></span>This delta will be executed, but it can be recomputed several times during the process.</p>
</li>
<li>
<p><strong>Synchronization delta:</strong> The detected delta.<br><span class="segmentSeparator"></span>The delta that was detected by synchronization.<br><span class="segmentSeparator"></span>MidPoint assumes that this delta was already executed and all it can do is to react to this.<br><span class="segmentSeparator"></span>It is used as an input to the computation.<br><span class="segmentSeparator"></span>This delta will not be executed again.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This description is slightly simplified.<br><span class="segmentSeparator"></span>The real thing is more complex.<br><span class="segmentSeparator"></span>However, this description should be sufficient to understand the overall process.</p>
</div>
<div class="paragraph">
<p>Model context is dumped at strategic places during clockwork and projector computation.<br><span class="segmentSeparator"></span>The dumps look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>---[ PROJECTOR (INITIAL) context projection values and credentials of resource:10000000-0000-0000-0000-000000000204(Dummy Resource Blue)(default) ]--------------------------------
LensContext: state=INITIAL, Wave(e=0,p=0,max=0), focus, 1 projections, 2 changes, fresh=true
  Channel: null
  Options: null
  Settings: assignments=FULL
  FOCUS:
    User, oid=c0c010c0-d34d-b33f-f00d-111111111116, syncIntent=null
      User old:
        user: (c0c010c0-d34d-b33f-f00d-111111111116, v5, UserType) name: guybrush .....</code></pre>
</div>
</div>
<div class="paragraph">
<p>Those dumps provide crucial information for troubleshooting.<br><span class="segmentSeparator"></span>Their importance for diagnosing really hard problems cannot be overstated.<br><span class="segmentSeparator"></span>It is more than recommended to get used to read and follow those dumps through the computation process.<br><span class="segmentSeparator"></span>It will save a huge amount of time.</p>
</div>
<div class="paragraph">
<p>Why is it so important to know all of this?<br><span class="segmentSeparator"></span>You need to know this to find your way through this labyrinth.<br><span class="segmentSeparator"></span>MidPoint provides quite a lot of diagnostic data for each step and each sub-step of each step.<br><span class="segmentSeparator"></span>You can try to enable full logging to get all the details.<br><span class="segmentSeparator"></span>But what you get is a digital equivalent of a flash flood and you are very likely to get drowned.<br><span class="segmentSeparator"></span>The information that you are looking for will be almost certainly there, but it will be lost among all the innocent-looking data.<br><span class="segmentSeparator"></span>This is a good way how to spend a lot of time and lose your sanity in the process.<br><span class="segmentSeparator"></span>But it is not an efficient debugging method.</p>
</div>
<div class="paragraph">
<p>The efficient debugging method is to proceed in steps.<br><span class="segmentSeparator"></span>Start with high-level information.<br><span class="segmentSeparator"></span>Then focus your eyes a bit deeper.<br><span class="segmentSeparator"></span>Try to figure out which steps of the processing are working well and which steps are wrong.<br><span class="segmentSeparator"></span>The have a closer look at those steps by enabling more detailed logging.<br><span class="segmentSeparator"></span>The look deeper and deeper until the problem is found.</p>
</div>
<div class="paragraph">
<p>The process usually goes like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Have a look at input and output of the operation as a whole.<br><span class="segmentSeparator"></span>There are several ways to do that.<br><span class="segmentSeparator"></span>You can use "preview" operation of user interface to see the input.<br><span class="segmentSeparator"></span>You can examine the operation result in the user interface to see the outcome of the operation.<br><span class="segmentSeparator"></span>Or you may have a look at the audit trail.<br><span class="segmentSeparator"></span>Enabling auditing to a log files may also help.</p>
</li>
<li>
<p>Have a look at clockwork.<br><span class="segmentSeparator"></span>Clockwork can provide a summary of the operation when <code>DEBUG</code> log level on <code>com.evolveum.midpoint.model.impl.lens.Clockwork</code> package is enabled.<br><span class="segmentSeparator"></span>The summary is an important branch in the troubleshooting process.<br><span class="segmentSeparator"></span>The summary may suggest whether the problem with the operation is in the computation (Projector) or whether it is in the connectors and resources (Provisioning).</p>
</li>
<li>
<p>Have a detailed look at the Clockwork process.<br><span class="segmentSeparator"></span>Clockwork summary provides only a brief summary in a very compact form.<br><span class="segmentSeparator"></span>That information may not be detailed enough to figure out what is going on.<br><span class="segmentSeparator"></span>Therefore you may need to go deeper.<br><span class="segmentSeparator"></span>Enabling <code>TRACE</code> log level on Clockwork will provide detailed data about all the stages of clockwork processing.<br><span class="segmentSeparator"></span>Model context is dumped in each step.<br><span class="segmentSeparator"></span>And it is this dump of model context that provides valuable troubleshooting data.<br><span class="segmentSeparator"></span>Have a look at those dumps and try to figure out where exactly the operation goes wrong.<br><span class="segmentSeparator"></span>After that you should be able to decide whether the problem is in computation (Projector) or execution (Provisioning).</p>
</li>
<li>
<p>In case you suspect provisioning issues but you are not sure it may be helpful to have a detailed look at ChangeExecutor.<br><span class="segmentSeparator"></span>This component is responsible to carry out all the changes from Projector and Clockwork.<br><span class="segmentSeparator"></span>Enabling <code>DEBUG</code> or <code>TRACE</code> logging on <code>com.evolveum.midpoint.model.impl.lens.ChangeExecutor</code> will provide details about each operation and its outcome.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Overall, clockwork summary is a good starting point.<br><span class="segmentSeparator"></span>The summary looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>###[ CLOCKWORK SUMMARY ]######################################
Triggered by focus primary delta ObjectDelta(UserType:c0c010c0-d34d-b33f-f00d-111111111111,MODIFY:&nbsp;PropertyDelta(&nbsp;/&nbsp;{.../common/common-3}organizationalUnit,&nbsp;REPLACE),&nbsp;PropertyDelta(metadata&nbsp;/&nbsp;{.../common/common-3}modifyTimestamp,&nbsp;REPLACE))
Focus: focus(user:c0c010c0-d34d-b33f-f00d-111111111111(jack))
Projections (1):&nbsp;account(ID {.../connector/icf-1/resource-schema-3}uid = [ jack ], type 'default', resource:10000000-0000-0000-0000-000000000104(Dummy Resource Red)): KEEP
Executed:
 ObjectDelta(UserType:c0c010c0-d34d-b33f-f00d-111111111111,MODIFY:&nbsp;PropertyDelta(&nbsp;/&nbsp;{.../common/common-3}organizationalUnit,&nbsp;REPLACE),&nbsp;PropertyDelta(metadata&nbsp;/&nbsp;{.../common/common-3}modifyTimestamp, REPLACE)): SUCCESS
 ObjectDelta(ShadowType:a3ebbe89-227b-42ff-9d00-f42bee3cf151,MODIFY:&nbsp;PropertyDelta(attributes&nbsp;/&nbsp;{.../resource/instance-3}ship,&nbsp;REPLACE),&nbsp;PropertyDelta(metadata&nbsp;/&nbsp;{.../common/common-3}modifyTimestamp, REPLACE)): SUCCESS
##############################################################</code></pre>
</div>
</div>
<div class="paragraph">
<p>At this point you should know the rough outline of the problem.<br><span class="segmentSeparator"></span>At the very least you should know whether the problem is in:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Projector:</strong> the problem is that midPoint does not compute the values correctly.</p>
</li>
<li>
<p><strong>Provisioning:</strong> the values are computed correctly, but there is a problem when midPoint tries to execute the operation.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If the problem is in the computation then you need to have a closer look at Projector.<br><span class="segmentSeparator"></span>The first step should be to enable <code>DEBUG</code> logging of <code>com.evolveum.midpoint.model.impl.lens.projector.Projector</code>.<br><span class="segmentSeparator"></span>The output of this logging is similar to the output of Clockwork trace.<br><span class="segmentSeparator"></span>Each step of Projector computation is recorded and model context is dumped.<br><span class="segmentSeparator"></span>Watch the changes in model context closely and try to figure out where wrong results occur.<br><span class="segmentSeparator"></span>This is usually all that is needed to figure out the nature of the problem.<br><span class="segmentSeparator"></span>The problem is often in the mappings.<br><span class="segmentSeparator"></span>In that case, follow the instructions in the next section to debug the mappings.<br><span class="segmentSeparator"></span>If you still cannot figure out what is going on there are still finer details that can be enabled.<br><span class="segmentSeparator"></span>The projector consists of many "processor" classes, such as <code>ActivationProcessor</code> or <code>AssignmentProcessor</code>.<br><span class="segmentSeparator"></span>Each of those are responsible for one part of the computation.<br><span class="segmentSeparator"></span>Enabling <code>TRACE</code> logging on them provides a very fine details about the computation.<br><span class="segmentSeparator"></span>Package names of those classes can be found in midPoint source code.<br><span class="segmentSeparator"></span>But it is usually more convenient to enable <code>TRACE</code> logging on the entire <code>com.evolveum.midpoint.model.impl.lens</code> package at this point.<br><span class="segmentSeparator"></span>Doing so will also show all the names of all the "processors" that take place during the computation.<br><span class="segmentSeparator"></span>Those names can be used to focus the logging output only to specific parts of computation.</p>
</div>
<div class="paragraph">
<p>The things may get quite messy if the problem is in the execution of the operation.<br><span class="segmentSeparator"></span>There are many components to consider.<br><span class="segmentSeparator"></span>There is midPoint provisioning code, ConnId connector framework, connector and then the target system itself.<br><span class="segmentSeparator"></span>There is almost uncountable number of combinations, configurations, network conditions and other circumstances where things may go wrong.<br><span class="segmentSeparator"></span>The first step should be to figure out whether the problem is on midPoint side or on the resource side.<br><span class="segmentSeparator"></span>Once again the best strategy is to find a suitable point in the entire process and to check operation status here.<br><span class="segmentSeparator"></span>Connector framework is such a suitable point.<br><span class="segmentSeparator"></span>There is special logger that can be used to record summary of all the operations of connector framework: <code>org.identityconnectors.framework.spi.operations</code>.<br><span class="segmentSeparator"></span>Enabling <code>TRACE</code> logging on this logger will record all the operation requests and results that pass between ConnId framework and the connector.<br><span class="segmentSeparator"></span>Some connectors provide similar facility that can provide even more details.<br><span class="segmentSeparator"></span>For example, LDAP and AD connectors can log details of all LDAP operations by enabling <code>TRACE</code> logging on <code>com.evolveum.polygon.connector.ldap.OperationLog</code>.<br><span class="segmentSeparator"></span>This method is usually preferable as it can clearly indicate whether the problem is caused by wrong operation request or whether the problem occurs on the LDAP or AD server.<br><span class="segmentSeparator"></span>If case that the problem is in the connector or somewhere on the resource side there is a separate troubleshooting guide below.<br><span class="segmentSeparator"></span>In case that the problem is in midPoint, then the best strategy would be to enable logging of midPoint provisioning components: <code>com.evolveum.midpoint.provisioning</code>.<br><span class="segmentSeparator"></span>Setting the logging to <code>DEBUG</code> level should provide enough information to locate the problem.<br><span class="segmentSeparator"></span>Desperate engineers can try to use <code>TRACE</code> level here.<br><span class="segmentSeparator"></span>But in that case, it is perhaps a good idea to leave some provisioning classes to <code>DEBUG</code> level (such as <code>ResourceManager</code>) as they are usually too loud at <code>TRACE</code> level.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<em>Lens</em>, <em>Clockwork</em> and <em>Projector</em>.<br><span class="segmentSeparator"></span>Where do those names come from?<br><span class="segmentSeparator"></span>Naming is a notoriously hard thing.<br><span class="segmentSeparator"></span>Software engineers create things that are not alike anything in the real world.<br><span class="segmentSeparator"></span>Therefore it is often very hard to find good names for components.<br><span class="segmentSeparator"></span>The recommended practice is to find appropriate metaphor for the system.<br><span class="segmentSeparator"></span>In other words: find something in the real world that something similar as you do.<br><span class="segmentSeparator"></span>When midPoint was young we were implementing a component that mapped user data to accounts.<br><span class="segmentSeparator"></span>However, this component was supposed to be generic.<br><span class="segmentSeparator"></span>It mapped user to accounts, but also role to entitlements, org to OUs and so on.<br><span class="segmentSeparator"></span>The obvious name "Mapper" was problematic, as we had a concept of "mapping" already.<br><span class="segmentSeparator"></span>Such name would be confusing.<br><span class="segmentSeparator"></span>Therefore, we have chosen a concept of <em>projecting</em> user data to accounts in the same way as movie is projected to a screen in a theater.<br><span class="segmentSeparator"></span>That was also a reason for "focus" and "projection" and to use name "lens" for the whole package.<br><span class="segmentSeparator"></span>Some time later we needed a name for a controller that will drive the projector.<br><span class="segmentSeparator"></span>We though about a planetarium or a telescope driven by a clockwork mechanism.<br><span class="segmentSeparator"></span>MidPoint has evolved since then and those names may no longer be a perfect metaphor.<br><span class="segmentSeparator"></span>But they are there and we got used to them.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_troubleshooting_mappings_and_expressions">Troubleshooting Mappings and Expressions</h3>
<div class="paragraph">
<p>Mappings and expressions often contain custom scripting code.<br><span class="segmentSeparator"></span>This means that midPoint is very flexible and can satisfy diverse requirements.<br><span class="segmentSeparator"></span>But it also means that mappings and expressions are often the source of problems.<br><span class="segmentSeparator"></span>Especially some scripting expressions tend to be quite complex.<br><span class="segmentSeparator"></span>Creating, testing and maintaining those expressions would be almost impossible without any debugging and troubleshooting facilities.</p>
</div>
<div class="paragraph">
<p>MidPoint contains code that can be used to trace execution of mappings and expressions on a very detailed level.<br><span class="segmentSeparator"></span>The trace shows inputs and outputs and deltas that are taken into consideration when the expression or mapping is evaluated.<br><span class="segmentSeparator"></span>There are two options how to enable this tracing.</p>
</div>
<div class="paragraph">
<p>First option is to enable the tracing globally for all expressions and mappings by setting one or more of the following loggers to <code>TRACE</code> level:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Component</th>
<th class="tableblock halign-left valign-top">Package name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Verbosity</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Mappings</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.evolveum.midpoint.model.common.mapping.Mapping</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Code that is processing mappings.</p>
<p class="tableblock">Enabling logging will provide a short overview of mapping inputs and outputs with some insights into the inner processing.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Medium</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expressions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.evolveum.midpoint.model.common.expression.Expression</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expression evaluation code.</p>
<p class="tableblock">Enabling logging will provide a lot of details about expression evaluation.<br><span class="segmentSeparator"></span>This is likely to produce a log of data.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Script expressions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>com.evolveum.midpoint.model.common.expression.script.ScriptExpression</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logs a lot of details about script expression evaluation (Groovy, JavaScript, …​).</p>
<p class="tableblock">Provides a lot of details.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Very high</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Setting logger levels to <code>TRACE</code> will log all execution of mappings and expressions.<br><span class="segmentSeparator"></span>However, this may be a huge amount of information, especially in complex deployments with many mappings and expressions.<br><span class="segmentSeparator"></span>Therefore, there is an alternative way that can be used to trace mappings and expressions individually.<br><span class="segmentSeparator"></span>There is a special-purpose trace property in the mapping:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;mapping&gt;</span>
      ...<br><span class="segmentSeparator"></span>      <span class="tag">&lt;trace&gt;</span>true<span class="tag">&lt;/trace&gt;</span>
      ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/mapping&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And there is a similar property in expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;mapping&gt;</span>
      ...<br><span class="segmentSeparator"></span>      <span class="tag">&lt;expression&gt;</span>
          <span class="tag">&lt;trace&gt;</span>true<span class="tag">&lt;/trace&gt;</span>
          ...<br><span class="segmentSeparator"></span>      <span class="tag">&lt;/expression&gt;</span>
      ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/mapping&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a nice method to look at one particular troublesome mapping without flooding the log files with traces of all the mappings in the system.<br><span class="segmentSeparator"></span>However, it still may not be entirely easy to locate the dump of the mapping in the log files.<br><span class="segmentSeparator"></span>Therefore it is a good practice to name your mappings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;mapping&gt;</span>
      <span class="tag">&lt;name&gt;</span>my-pretty-mapping<span class="tag">&lt;/name&gt;</span>
      ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/mapping&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Mapping name will be recorded in the mapping and expression dumps, therefore it can be easily located in the log files.<br><span class="segmentSeparator"></span>Mapping names are also used in error messages and they are likely to be used in diagnostic outputs that will be developed in midPoint in the future.<br><span class="segmentSeparator"></span>Therefore it is a very good practice to put names to mappings.<br><span class="segmentSeparator"></span>It is probably an overkill to name all the mappings in the system.<br><span class="segmentSeparator"></span>However, naming complex mappings can make a lot of difference in troubleshooting.</p>
</div>
<div class="paragraph">
<p>Dumping a mapping or expression will provide overview of inputs and outputs.<br><span class="segmentSeparator"></span>But that alone may not be enough to figure out what is wrong inside the expression.<br><span class="segmentSeparator"></span>Therefore script expressions can explicitly invoke a logging facility.<br><span class="segmentSeparator"></span>MidPoint has script expression functions that can be used to log messages from the scripting code.<br><span class="segmentSeparator"></span>It works like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;mapping&gt;</span>
      ...<br><span class="segmentSeparator"></span>      <span class="tag">&lt;expression&gt;</span>
          <span class="tag">&lt;script&gt;</span>
<span class="inline">              <span class="tag">&lt;code&gt;</span>
                  ...<br><span class="segmentSeparator"></span>                  log.error('The {} is broken, {} is to blame', thing, reason)
                  ...<br><span class="segmentSeparator"></span>              <span class="tag">&lt;/code&gt;</span></span>
          <span class="tag">&lt;/script&gt;</span>
      <span class="tag">&lt;/expression&gt;</span>
      ...<br><span class="segmentSeparator"></span><span class="tag">&lt;/mapping&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Such messages are recorded in the system log using special-purpose logger <code>com.evolveum.midpoint.expression</code> and the appropriate level.<br><span class="segmentSeparator"></span>The message itself is composed from several parts using <code>{}</code> placeholders.</p>
</div>
</div>
<div class="sect2">
<h3 id="_troubleshooting_connectors">Troubleshooting Connectors</h3>
<div class="paragraph">
<p>MidPoint is using the ConnId connector framework to manage identity connectors.<br><span class="segmentSeparator"></span>All ordinary connectors are running under the control of this framework.<br><span class="segmentSeparator"></span>It means that midPoint calls the ConnId framework and the framework calls the connector.<br><span class="segmentSeparator"></span>Therefore, when it comes to troubleshooting connector problems there are several places where a problem can occur and also several places where you can get diagnostic data:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>MidPoint:</strong> midPoint may invoke wrong operation at the first place.<br><span class="segmentSeparator"></span>This may be caused by a misconfiguration or a bug.<br><span class="segmentSeparator"></span>We have already covered most of those cases.</p>
</li>
<li>
<p><strong>ConnId:</strong> the framework may misinterpret the operation.<br><span class="segmentSeparator"></span>The framework also simulates some operations and it may post-process the results.</p>
</li>
<li>
<p><strong>Connector:</strong> this is the tricky part of the story.<br><span class="segmentSeparator"></span>Each connector is different.<br><span class="segmentSeparator"></span>Very different.<br><span class="segmentSeparator"></span>But there are ways.<br><span class="segmentSeparator"></span>More on this below.</p>
</li>
<li>
<p><strong>Resource:</strong> it is possible that the problem is caused by resource misconfiguration.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>the connector is not allowed to see all data, there are some limits, etc.<br><span class="segmentSeparator"></span>We will not go into details here.<br><span class="segmentSeparator"></span>See the documentation that goes with the resource for troubleshooting details.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The ConnId connector framework stands between midPoint and the connectors.<br><span class="segmentSeparator"></span>It knows about every operation that midPoint invokes on every connector and it knows about all the return values.<br><span class="segmentSeparator"></span>This can be easily enabled by using the following log configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>org.identityconnectors.framework.api.operations: TRACE
org.identityconnectors.framework.spi.operations: TRACE
org.identityconnectors.framework.common.objects.ResultsHandler: TRACE</pre>
</div>
</div>
<div class="paragraph">
<p>The ConnId operation traces look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>TRACE (org.identityconnectors.framework.api.operations.SearchApiOp): method: search msg:Enter: search(ObjectClass: inetOrgPerson, null, com.evolveum.midpoint.provisioning.ucf.impl.ConnectorInstanceIcfImpl$2@643dc940, OperationOptions: {ALLOW_PARTIAL_ATTRIBUTE_VALUES:true,PAGED_RESULTS_OFFSET:1,PAGE_SIZE:20})
...<br><span class="segmentSeparator"></span>TRACE (org.identityconnectors.framework.api.operations.SearchApiOp): method: search msg:Return: org.identityconnectors.framework.common.objects.SearchResult@a90221a</pre>
</div>
</div>
<div class="paragraph">
<p>This is a very useful mechanism.<br><span class="segmentSeparator"></span>It will log every operation of every connector.<br><span class="segmentSeparator"></span>If you suspect that the connector is not executing the right operation this is the right place to check it.<br><span class="segmentSeparator"></span>You can see what is the operation that midPoint is passing to the connector.<br><span class="segmentSeparator"></span>If that operation looks good then the problem is most likely in the connector (see below).<br><span class="segmentSeparator"></span>If the operation does not make sense, then the problem is usually in the provisioning (see above).</p>
</div>
<div class="paragraph">
<p>However, the operation is logged by the ConnId framework on relatively high level and the operation is still quite abstract.<br><span class="segmentSeparator"></span>If you need more details about what really gets executed you have to rely on the connector logging.</p>
</div>
<div class="paragraph">
<p>Please note that the ConnId framework has two "faces": API and SPI.<br><span class="segmentSeparator"></span>The API is facing midPoint.<br><span class="segmentSeparator"></span>MidPoint invokes ConnId API operations.<br><span class="segmentSeparator"></span>The SPI is facing the connector.<br><span class="segmentSeparator"></span>Connector implements SPI operations and ConnId framework is invoking them.<br><span class="segmentSeparator"></span>You can see the distinction in the class names that are written in the logfiles, e.g.<br><span class="segmentSeparator"></span><code>SearchApiOp</code> vs <code>SearchOp</code> (if there is no <code>Api</code> or <code>Spi</code> in the operation name then it is assumed to be SPI).<br><span class="segmentSeparator"></span>There is also similar distinction in the package name of the logger.<br><span class="segmentSeparator"></span>Most API and SPI operations are direct equivalents.<br><span class="segmentSeparator"></span>But there may be subtle differences.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>The get API operation is executed as search (<code>executeQuery</code>) SPI operation.</p>
</div>
<div class="paragraph">
<p>Most connector operations are "pure" request-response operations: there is one request and one response.<br><span class="segmentSeparator"></span>These are operations such as create, modify, delete.<br><span class="segmentSeparator"></span>In this case you will see one request in the log files and one response.<br><span class="segmentSeparator"></span>And that is the whole operation.<br><span class="segmentSeparator"></span>Like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>2017-02-01 10:44:16,622 [main] TRACE (o.i.framework.api.operations.CreateApiOp): method: create msg:Enter: create(ObjectClass: inetOrgPerson, [Attribute: {Name=uid, Value=[will]}, Attribute: {Name=__NAME__, Value=[uid=will,ou=People,dc=example,dc=com]}, Attribute: {Name=cn, Value=[Will Turner]}, Attribute: {Name=sn, Value=[Turner]}, Attribute: {Name=givenName, Value=[Will]}], OperationOptions: {})
2017-02-01 10:44:16,623 [main] TRACE (o.i.framework.spi.operations.CreateOp): method: create msg:Enter: create(ObjectClass: inetOrgPerson, [Attribute: {Name=uid, Value=[will]}, Attribute: {Name=__NAME__, Value=[uid=will,ou=People,dc=example,dc=com]}, Attribute: {Name=cn, Value=[Will Turner]}, Attribute: {Name=sn, Value=[Turner]}, Attribute: {Name=givenName, Value=[Will]}], OperationOptions: {})
...<br><span class="segmentSeparator"></span>2017-02-01 10:44:16,641 [main] TRACE (o.i.framework.spi.operations.CreateOp): method: create msg:Return: Attribute: {Name=__UID__, Value=[675f7e48-c0ee-4eaf-9273-39e67df4cd2c]}
2017-02-01 10:44:16,641 [main] TRACE (o.i.framework.api.operations.CreateApiOp): method: create msg:Return: Attribute: {Name=__UID__, Value=[675f7e48-c0ee-4eaf-9273-39e67df4cd2c]}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above example illustrates a very common <code>create</code> operation.<br><span class="segmentSeparator"></span>It should be interpreted like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>…​api.operations.CreateApiOp Enter</code>: MidPoint invokes ConnId API.<br><span class="segmentSeparator"></span>The object to create is logged as an operation parameter.<br><span class="segmentSeparator"></span>This is what midPoint sends.</p>
</li>
<li>
<p><code>…​spi.operations.CreateOp Enter</code>: ConnId invokes the connector.<br><span class="segmentSeparator"></span>This is what the connector receives.</p>
</li>
<li>
<p>Connector executes the operation.<br><span class="segmentSeparator"></span>Logs from the connector will be here (if connector logging is enabled).</p>
</li>
<li>
<p><code>…​spi.operations.CreateOp Return</code>: Connector operation is finished.<br><span class="segmentSeparator"></span>The connector returns the result to ConnId.</p>
</li>
<li>
<p><code>…​api.operations.CreateApiOp Return</code>: Operation is finished and post-processed by the framework.<br><span class="segmentSeparator"></span>Framework returns the result to midPoint.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This is quite straightforward and it applies to vast majority of connector operations.<br><span class="segmentSeparator"></span>However, there are some peculiarities.<br><span class="segmentSeparator"></span>For example, there are four update operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>update(…​)</code> in <code>UpdateOp</code>: This replaces attribute values.<br><span class="segmentSeparator"></span>It is (roughly) an equivalent to midPoint modify/replace deltas.</p>
</li>
<li>
<p><code>addAttributeValues(…​)</code> and <code>removeAttributeValues(…​)</code> in <code>UpdateAttributeValuesOp</code>.<br><span class="segmentSeparator"></span>This adds or deletes attribute values.<br><span class="segmentSeparator"></span>&nbsp;It is (roughly) an equivalent to midPoint modify/add and modify/delete deltas.</p>
</li>
<li>
<p><code>updateDelta(…​)</code> in <code>UpdateDeltaOp</code>: This operation allows complex combinations of add,delete and replace values.<br><span class="segmentSeparator"></span>This is a new operation designed to replace older operations above.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>New connectors implement <code>updateDelta(…​) </code>operation only.<br><span class="segmentSeparator"></span>Other update operations are considered to be obsolete.<br><span class="segmentSeparator"></span>However, they are still used by many connectors.</p>
</div>
<div class="paragraph">
<p>Search operations are also a bit strange.<br><span class="segmentSeparator"></span>First of all, the SPI provides only one operation for all search and get operation and that operation is <code>executeQuery(…​)</code>.<br><span class="segmentSeparator"></span>Then the results of each object found by the search operations is passed back to midPoint by using a callback method: <code>handle(…​)</code>.<br><span class="segmentSeparator"></span>Therefore interpreting search operations takes a keen eye and a bit of practice.</p>
</div>
<div class="paragraph">
<p>ConnId framework logs should indicate whether the problem is on the "connector-side".<br><span class="segmentSeparator"></span>Which means that the problem is either in the connector or that the resource itself is not behaving according to expectations.<br><span class="segmentSeparator"></span>The next step should be to have a look inside the connector.<br><span class="segmentSeparator"></span>But each connector is different.<br><span class="segmentSeparator"></span>The connectors have to adapt to the resource communication protocol and therefore they are expected to use variety of client and protocol libraries.<br><span class="segmentSeparator"></span>Each library may have its own method of troubleshooting.<br><span class="segmentSeparator"></span>Therefore there is no universal way troubleshoot a connector.<br><span class="segmentSeparator"></span>However, there is (almost) always some way.<br><span class="segmentSeparator"></span>Connector documentation should provide some details about troubleshooting.<br><span class="segmentSeparator"></span>But unfortunately, most connectors do not.<br><span class="segmentSeparator"></span>The best way is to have a look at connector source code.<br><span class="segmentSeparator"></span>Enabling logging by using the connector package name is usually quite a safe bet.<br><span class="segmentSeparator"></span>The logger name is usually the same as the package name of the connector classes.<br><span class="segmentSeparator"></span>Look in the documentation or directly inside the connector JAR file to find out the package name.<br><span class="segmentSeparator"></span>You may also need to enable logging of the libraries that come with the connector.<br><span class="segmentSeparator"></span>You can examine these if you look in the <code>lib</code> directory inside the connector JAR file.</p>
</div>
<div class="paragraph">
<p>Some connectors have really good logging, such as the connectors in the LDAP connector family.<br><span class="segmentSeparator"></span>The LDAP connector will log all the LDAP operations if you set the <code>com.evolveum.polygon.connector.ldap.OperationLog</code> logger to <code>DEBUG</code> level.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight nowrap"><code>2016-08-30 17:14:20,043 [main] DEBUG [](c.evolveum.polygon.connector.ldap.OperationLog): method: null msg:ldap://localhost:10389/ Add REQ Entry:
Entry
    dn: uid=jack,ou=People,dc=example,dc=com
    objectClass: inetOrgPerson
    uid: jack
    userPassword: deadmentellnotales
    sn: Sparrow
    cn: Jack Sparrow
    description: Created by IDM
    givenName: Jack
    l: Black Pearl
    displayName: Jack Sparrow

2016-08-30 17:14:20,091 [main] DEBUG [](c.evolveum.polygon.connector.ldap.OperationLog): method: null msg:ldap://localhost:10389/ Add RES uid=jack,ou=People,dc=example,dc=com:         Ldap Result
            Result code : (SUCCESS) success
            Matched Dn : ''
            Diagnostic message : ''</code></pre>
</div>
</div>
<div class="paragraph">
<p>This logging can be used in two connectors that are used in majority of midPoint deployments: LDAP connector and Active Directory connector.<br><span class="segmentSeparator"></span>This logging is much more natural and easier to understand than the ConnId framework logging.<br><span class="segmentSeparator"></span>Therefore, a look at this log should be the first thing to do when there are problems with LDAP and AD connectors.</p>
</div>
<div class="paragraph">
<p>However, not all connectors are built with troubleshooting in mind.<br><span class="segmentSeparator"></span>Some connectors will barely log anything.<br><span class="segmentSeparator"></span>This is all connector-dependent.<br><span class="segmentSeparator"></span>If the connector author did a good job you will get what you are looking for.<br><span class="segmentSeparator"></span>If the author did a poor job, you are mostly out of luck.<br><span class="segmentSeparator"></span>But one way or another, this is the best chance to learn what the connector is doing.<br><span class="segmentSeparator"></span>If that fails, you have to resort to packet sniffer and similar tools.</p>
</div>
</div>
<div class="sect2">
<h3 id="_troubleshooting_authorizations">Troubleshooting Authorizations</h3>
<div class="paragraph">
<p>MidPoint authorizations provide a very powerful mechanism for a fine-grained access control.<br><span class="segmentSeparator"></span>This mechanism is quite simple in principle.<br><span class="segmentSeparator"></span>But the configuration can get very complex especially if a sophisticated RBAC structure is in place.<br><span class="segmentSeparator"></span>Setting the authorization up is not entirely easy task.<br><span class="segmentSeparator"></span>It is often quite difficult to tell why the user is not authorized for a specific action or why the user can access more than he is supposed to.<br><span class="segmentSeparator"></span>Therefore this page describes basic mechanisms how to troubleshoot authorizations.</p>
</div>
<div class="paragraph">
<p>The basic troubleshooting steps are simple in theory:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Enable logging of authorization processing.</p>
</li>
<li>
<p>Repeat the operation.</p>
</li>
<li>
<p>Figure out which authorization is wrong.</p>
</li>
<li>
<p>Fix it.</p>
</li>
<li>
<p>Rinse and repeat.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Yet, the practice is much more complex.<br><span class="segmentSeparator"></span>As always.</p>
</div>
<div class="paragraph">
<p>The authorizations are processed in midPoint security component.<br><span class="segmentSeparator"></span>The processing of every authorization is logged.<br><span class="segmentSeparator"></span>Therefore, to see the authorization processing trace simply enable the logging of security component:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>com.evolveum.midpoint.security: TRACE</pre>
</div>
</div>
<div class="paragraph">
<p>However, please keep in mind that this is quite intense logging.<br><span class="segmentSeparator"></span>It can easily impact the system performance and flood the logs on a busy system with a lot of authorization.<br><span class="segmentSeparator"></span>It is better to troubleshoot the configuration in a development or testing environment.</p>
</div>
<div class="paragraph">
<p>When the security logging is enabled then you can see following messages in the logs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>2017-01-23 14:32:37,824 [main] TRACE (c.e.m.security.impl.SecurityEnforcerImpl): AUTZ: evaluating security constraints principal=MidPointPrincipal(user:c0c010c0-d34d-b33f-f00d-111111111111(jack), autz=[[http://midpoint.evolveum.com/xml/ns/public/security/authorization-model-3#read])]), object=user:c0c010c0-d34d-b33f-f00d-111111111111(jack)
2017-01-23 14:32:37,824 [main] TRACE (c.e.m.security.impl.SecurityEnforcerImpl): Evaluating authorization 'read-some-roles' in role:7b4a3880-e167-11e6-b38b-2b6a550a03e7(Read some roles)
....<br><span class="segmentSeparator"></span>2017-01-23 14:32:37,824 [main] DEBUG (c.evolveum.midpoint.security.api.SecurityUtil): Denied access to user:c0c010c0-d34d-b33f-f00d-111111111111(null) by jack because the subject has not access to any item</pre>
</div>
</div>
<div class="paragraph">
<p>There is a set of similar messages for every operation that midPoint attempts.<br><span class="segmentSeparator"></span>First message describes the operations and its "context": who has executed it (principal), what was the object and target of the operation (if applicable).<br><span class="segmentSeparator"></span>The last line usually summarizes the decision: allow or deny.<br><span class="segmentSeparator"></span>The lines between describe the processing of each individual authorization.<br><span class="segmentSeparator"></span>If you examine that part carefully, then you can figure out which authorizations were used.<br><span class="segmentSeparator"></span>The result of authorization evaluation can be one of these:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Authorization <strong>denies</strong> the operation.<br><span class="segmentSeparator"></span>That’s a dead end.<br><span class="segmentSeparator"></span>If any authorization denies the operation then the operation is denied.<br><span class="segmentSeparator"></span>No other authorizations need to be evaluated.</p>
</li>
<li>
<p>Authorization <strong>allows</strong> the operation.<br><span class="segmentSeparator"></span>That’s a green light.<br><span class="segmentSeparator"></span>However, other authorizations are still evaluated to make sure that there is no other authorization that denies the operation.</p>
</li>
<li>
<p>Authorization is <strong>not applicable</strong>.<br><span class="segmentSeparator"></span>The authorization does not match the constraint for object or target.<br><span class="segmentSeparator"></span>Or it is not applicable for other reasons.<br><span class="segmentSeparator"></span>Such authorization is skipped.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If there is a single <em>deny</em> then the evaluation is done.<br><span class="segmentSeparator"></span>The operation is denied.<br><span class="segmentSeparator"></span>Deny is also a default decision.<br><span class="segmentSeparator"></span>I.e.<br><span class="segmentSeparator"></span>if there is no decision at the end of the evaluation, then the operation is denied.<br><span class="segmentSeparator"></span>At least one explicit <em>allow</em> is needed to allow the operation.</p>
</div>
<div class="paragraph">
<p>All authorization processing is recorded in the log.<br><span class="segmentSeparator"></span>There is a record of processing of every operation, every authorization, evaluation of every authorization clause, whether the authorization is applicable or not, whether it denies or allows the operation.</p>
</div>
<div class="paragraph">
<p>Authorization of operations such as <em>add</em> or <em>delete</em> is quite easy.<br><span class="segmentSeparator"></span>The result is simple: the operation is either allowed or denied.<br><span class="segmentSeparator"></span>But it is a bit different for <em>get</em> operations.<br><span class="segmentSeparator"></span>The entire get operation can still be denied if the user does not have any access to the object that he is trying to retrieve.<br><span class="segmentSeparator"></span>But the common case is that the user has some access to the object, but not all the items (properties).<br><span class="segmentSeparator"></span>In such a case the operation must be allowed.<br><span class="segmentSeparator"></span>But the retrieved object needs to be post-processed to remove the fields that are not accessible to the user.<br><span class="segmentSeparator"></span>This is done in two steps.</p>
</div>
<div class="paragraph">
<p>Firstly, the set of <em>object security constraints</em> is compiled from the authorizations.<br><span class="segmentSeparator"></span>The <em>object security constraints</em> is a data structure that describes which properties of an object are accessible to the user.<br><span class="segmentSeparator"></span>There is a map (<code>itemConstraintMap</code>) with an entry for every item (property) which is explicitly mentioned in the authorizations.<br><span class="segmentSeparator"></span>This entry contains explicit decisions given by the authorizations for every basic access operation (read, add, modify, delete).<br><span class="segmentSeparator"></span>And then there are default decisions (<code>actionDecisionMap</code>).<br><span class="segmentSeparator"></span>These decisions are applied if there is no explicit entry for the item.<br><span class="segmentSeparator"></span>This <em>object security constraints</em> data structure is usually logged when it is compiled.</p>
</div>
<div class="paragraph">
<p>Secondly, the <em>object security constraints</em> are applied to the retrieved object.<br><span class="segmentSeparator"></span>The constraints are used to remove the properties that are not accessible to the user.<br><span class="segmentSeparator"></span>This process is not easy to follow in the logs.<br><span class="segmentSeparator"></span>Therefore it is better to inspect the <em>object security constraints</em> structure.<br><span class="segmentSeparator"></span>If it is correct then also the resulting object will be most likely correct.</p>
</div>
<div class="admonitionblock tip">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Object security constraints and the user interface.</div>
The <em>object security constraints</em> has much broader application than just authorization of the read operations.<br><span class="segmentSeparator"></span>This data structure is (indirectly) used by midPoint user interface when displaying edit forms for objects.<br><span class="segmentSeparator"></span>The data from this structure are used to figure out which fields are displayed as read-write, which fields are read only and which fields are not displayed at all.<br><span class="segmentSeparator"></span>The <em>object security constraints</em> structure is always produced by the same algorithm in the security component.<br><span class="segmentSeparator"></span>Therefore, the interaction of authorizations and GUI forms can be diagnosed in the same way as the <em>get</em> operations.<br><span class="segmentSeparator"></span></td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Search operations are very different than common operations such as <em>add</em> or <em>delete</em> and they are also different than <em>get</em> operations.<br><span class="segmentSeparator"></span>Search operations will <strong>not</strong> result in an access denied error (except for few special cases).<br><span class="segmentSeparator"></span>If the user that is searching has access only to some objects, then only those objects will be returned.<br><span class="segmentSeparator"></span>There is no error, because this is a perfectly normal situation.<br><span class="segmentSeparator"></span>The extreme case is that user has access to no object at all.<br><span class="segmentSeparator"></span>But although this situation is not entirely "normal" it is also not in any way special.<br><span class="segmentSeparator"></span>The search will simply return empty result and there is also no error.<br><span class="segmentSeparator"></span>You need to keep this in mind when troubleshooting the <em>read</em> authorizations.<br><span class="segmentSeparator"></span>Attempt to <em>get</em> inaccessible objects will result in a security violation error.<br><span class="segmentSeparator"></span>But <em>searching</em> for them will simply return empty result and there is no error.</p>
</div>
<div class="paragraph">
<p>The <em>search</em> operations are interesting for another reason.<br><span class="segmentSeparator"></span>Operations such as <em>get</em>, <em>add</em> or <em>delete</em> have precise specification of object: the object that is being retrieved, added or modified.<br><span class="segmentSeparator"></span>But it is entirely different for search operations.<br><span class="segmentSeparator"></span>The <em>object</em> is a result of the search operation, not the parameter.<br><span class="segmentSeparator"></span>We cannot examine the <em>object</em> before the search and decide whether we allow or deny the operation.<br><span class="segmentSeparator"></span>There is no <em>object</em> before search operation.<br><span class="segmentSeparator"></span>Also, we cannot simply search all objects and then filter out those that are denied.<br><span class="segmentSeparator"></span>That would be totally inefficient and it will completely ruin paging mechanisms.<br><span class="segmentSeparator"></span>A completely different strategy is needed for search operations.</p>
</div>
<div class="paragraph">
<p>Search authorizations work the other way around: at first, the authorizations statements are compiled to a search filter.<br><span class="segmentSeparator"></span>For example, if the authorization allows access only to active roles the authorization is compiled to a filter <code>activation/effectiveStatus=enabled</code>.<br><span class="segmentSeparator"></span>Then this filter is appended to the normal search filter and the search operation is performed.<br><span class="segmentSeparator"></span>This approach ensures that the search returns only the objects that the user is authorized to see.<br><span class="segmentSeparator"></span>It also makes the search as efficient as possible and maintains page boundaries.<br><span class="segmentSeparator"></span>But that is not all.<br><span class="segmentSeparator"></span>Another round of post processing is needed to filter out only the items that are not visible to the user.<br><span class="segmentSeparator"></span>This is the same filter as is applied to get operations.</p>
</div>
<div class="paragraph">
<p>Finally, there is a couple of things to keep in mind:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The authorizations are designed to be <strong>additive</strong>.<br><span class="segmentSeparator"></span>Each role should allow the minimum set of operations needed for the users to complete their job.<br><span class="segmentSeparator"></span>MidPoint will "merge" all the authorizations from all the roles.<br><span class="segmentSeparator"></span>Use allow operations, avoid deny operations if possible.<br><span class="segmentSeparator"></span>It is much better not to allow an operation than to deny it.</p>
</li>
<li>
<p><strong>Deny always wins.</strong> If there is a single deny in any applicable authorization in any roles, then the operation is denied.<br><span class="segmentSeparator"></span>It does not matter if there are thousands of allow authorizations, deny always wins.<br><span class="segmentSeparator"></span>What was once denied cannot be allowed again.<br><span class="segmentSeparator"></span>We need this approach because we do not have any way how to order the authorization in many roles.<br><span class="segmentSeparator"></span>Do not use deny unless really needed.</p>
</li>
<li>
<p>There are two phases: <strong>request and execution</strong>.<br><span class="segmentSeparator"></span>The operation needs to be allowed in both phases to proceed.<br><span class="segmentSeparator"></span>Please keep in mind that object may be changed between request and execution due to mappings, metadata and properties that are maintained by midPoint.<br><span class="segmentSeparator"></span>This is also the reason why we have separate authorizations for request and execution.</p>
</li>
<li>
<p><strong>Name</strong> the authorizations.<br><span class="segmentSeparator"></span>Each authorization statement can have an optional name.<br><span class="segmentSeparator"></span>Specify a reasonably unique name there.<br><span class="segmentSeparator"></span>Then use that name as a string to find the appropriate trace in the log files.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Authorization traces are quite verbose and there is quite a lot of them.<br><span class="segmentSeparator"></span>Many traces need to be examined to figure out what exactly is going on.<br><span class="segmentSeparator"></span>Troubleshooting is a hard work.<br><span class="segmentSeparator"></span>This mechanism of recording authorization processing in the log is the best way that we have figured out to troubleshoot the authorizations.<br><span class="segmentSeparator"></span>But we know that it is not ideal.<br><span class="segmentSeparator"></span>If you have any better idea we are more than open to suggestions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_reporting_a_bug">Reporting a Bug</h3>
<div class="paragraph">
<p>MidPoint is perfect.<br><span class="segmentSeparator"></span>There are no bugs.<br><span class="segmentSeparator"></span>Therefore you can skip this section entirely.</p>
</div>
<div class="paragraph">
<p>No, that is not really the case.<br><span class="segmentSeparator"></span>MidPoint is a real software deployed in a real world.<br><span class="segmentSeparator"></span>And while we spend a huge amount of time and effort to maintain midPoint, test it and fix the bugs, the bugs have a way to always get in.<br><span class="segmentSeparator"></span>This is also given by the very nature of midPoint.<br><span class="segmentSeparator"></span>MidPoint is flexible and comprehensive.<br><span class="segmentSeparator"></span>It is nearly impossible to test midPoint for all the conceivable configurations and use cases.<br><span class="segmentSeparator"></span>Whenever you deploy midPoint there is a chance that some parts of your configuration or usage patterns are unique.<br><span class="segmentSeparator"></span>Those parts might not be used by anybody else yet.<br><span class="segmentSeparator"></span>Therefore there may be bugs that nobody ever experienced yet.<br><span class="segmentSeparator"></span>That is the fate of all flexible software products that live in the real world.</p>
</div>
<div class="paragraph">
<p>In case that you find a bug that needs to be fixed you have several options:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Fix the bug yourself.</strong> MidPoint is an open source product.<br><span class="segmentSeparator"></span>We will gladly accept bugfixes.<br><span class="segmentSeparator"></span>However, midPoint is also a substantial product and we need to keep it maintainable.<br><span class="segmentSeparator"></span>Therefore all contributions including the bug fixes have to be reviewed.<br><span class="segmentSeparator"></span>The fixes need to be good enough to be accepted.<br><span class="segmentSeparator"></span>Writing an automated test for the bug is usually required as part of the bugfix contribution.</p>
</li>
<li>
<p><strong>Report the bug and wait.</strong> The bug will be fixed by someone eventually.<br><span class="segmentSeparator"></span>However, there is no telling how long you will need to wait.<br><span class="segmentSeparator"></span>If it is a security-related bug, then it will be fixed as soon as possible.<br><span class="segmentSeparator"></span>If the bug is severe and it affects a lot of users then it is likely to be fixed soon.<br><span class="segmentSeparator"></span>However, such bugs are very rare.<br><span class="segmentSeparator"></span>It is likely that your bug will be quite exotic and it can only be reproduced in your deployment.<br><span class="segmentSeparator"></span>In that case, it is almost certain that you will need to wait for a very long time.<br><span class="segmentSeparator"></span>Several years may pass before someone finds the time to have a look at your problem.<br><span class="segmentSeparator"></span>Those issues are known as <em>community issues</em> and they are usually seen at the very tail of developer’s work queues.<br><span class="segmentSeparator"></span>Except for one case: security issues.<br><span class="segmentSeparator"></span>Security issues are always prioritized regardless of who the reporter is.</p>
</li>
<li>
<p><strong>Purchase midPoint support from Evolveum.</strong> This will dramatically increase the priority of your bug report.<br><span class="segmentSeparator"></span>Software development cannot be easily predicted, therefore we still cannot guarantee precise time period to fix the bug.<br><span class="segmentSeparator"></span>However, typical fix time will be counted in days, weeks or in very rare and complicated cases in months.<br><span class="segmentSeparator"></span>Those issues are known as <em>subscriber issues</em> and they are always prioritized over community issues.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In any of those cases, there is a recommended procedure for bug diagnostics and reporting.<br><span class="segmentSeparator"></span>There are bug reporting standards that apply to anybody, even midPoint subscribers.<br><span class="segmentSeparator"></span>Evolveum provides 3<sup>rd</sup>-line support only.<br><span class="segmentSeparator"></span>This means that it is expected that the issues has already passed through 1<sup>st</sup> and 2<sup>nd</sup> lines of support.<br><span class="segmentSeparator"></span>The bug report should be really a report of midPoint bug.<br><span class="segmentSeparator"></span>It should not be a configuration issue.<br><span class="segmentSeparator"></span>Proper diagnostics techniques should be employed to investigate the issue before it is reported.<br><span class="segmentSeparator"></span>The rest of this section will describe the recommended procedure.</p>
</div>
<div class="paragraph">
<p><strong>Diagnostics</strong> is the first step that is absolutely mandatory.<br><span class="segmentSeparator"></span>Troubleshooting techniques described in this chapter should be used to find out what is going on.<br><span class="segmentSeparator"></span>MidPoint is a very flexible product and vast majority of midPoint issues are caused by wrong configuration.<br><span class="segmentSeparator"></span>Therefore, please make sure that the problem is not one of those.<br><span class="segmentSeparator"></span>Simple mis-configuration may easily look like a bug.<br><span class="segmentSeparator"></span>Try to go through midPoint documentation and understand how midPoint works.<br><span class="segmentSeparator"></span>Re-read relevant parts of this book.<br><span class="segmentSeparator"></span>MidPoint development team invests a huge amount of time and effort to make the error messages and log entries are understandable.<br><span class="segmentSeparator"></span>Then please make sure you use those facilities.<br><span class="segmentSeparator"></span>Please follow the troubleshooting guides above.<br><span class="segmentSeparator"></span>They are usually very helpful.</p>
</div>
<div class="paragraph">
<p><strong>Reproducing the problem</strong> is a second step.<br><span class="segmentSeparator"></span>The easiest way for us to fix a problem is being able to reproduce it.<br><span class="segmentSeparator"></span>In such case, we do not just blindly fix the problem but we can also make sure it is really gone.<br><span class="segmentSeparator"></span>In most cases we create a test case in our automated test suite to make sure the problem will gone and it will not appear again.<br><span class="segmentSeparator"></span>Therefore, your best strategy to make sure that the problem is fixed quickly and does not appear again is to show us how to reproduce the problem in our environment.<br><span class="segmentSeparator"></span>Saying that “this and that does not work” usually does not help as the same use case will work perfectly in other configurations.<br><span class="segmentSeparator"></span>Please describe your configuration in the report.</p>
</div>
<div class="paragraph">
<p>Try to figure out what is the minimal configuration necessary to reproduce the problem.<br><span class="segmentSeparator"></span>We appreciate if you could reproduce the problem using our sample resources and objects with minimal customization.<br><span class="segmentSeparator"></span>This saves you a lot of time describing your environment to us and it also saves us a lot of time to try to re-create your environment in our lab.<br><span class="segmentSeparator"></span>This approach also helps you to check your configuration and to make sure you are not reporting mis-configuration as a bug.</p>
</div>
<div class="paragraph">
<p>In a very rare cases the problem cannot be easily reproduced using samples or similar simple setup.<br><span class="segmentSeparator"></span>In that case we need to work with what we have.<br><span class="segmentSeparator"></span>Therefore, we either need to know quite a lot about your environment to be able to set it up in our lab.<br><span class="segmentSeparator"></span>Or we need access to your environment or your cooperation with diagnosing the problem.<br><span class="segmentSeparator"></span>In such case, please use your common sense in what comes into the bug report.<br><span class="segmentSeparator"></span>Please keep in mind that midPoint is open source project and the bug reports are public, therefore please be careful when providing sensitive information in bug reports.</p>
</div>
<div class="paragraph">
<p>When you are sure that the problem is not caused by mis-configuration, it is time to <strong>report the issue</strong>.<br><span class="segmentSeparator"></span>The best way to submit a bug report is to use Evolveum bug tracking system.<br><span class="segmentSeparator"></span>The registration is open to everybody.<br><span class="segmentSeparator"></span>This is also the only bug reporting method available for community issues.<br><span class="segmentSeparator"></span>Using Evolveum tracker allows you to track the progress of issue resolution, add additional information, etc.<br><span class="segmentSeparator"></span>Just please keep in mind that the tracker is public and open to anyone following the spirit of open source.<br><span class="segmentSeparator"></span>Therefore, be careful about submitting a sensitive information.</p>
</div>
<div class="paragraph">
<p>Please note that security issues revealing a potential security vulnerability should <strong>not</strong> be reported by using the tracker.<br><span class="segmentSeparator"></span>Information in the tracker is public and this may lead to unintentional disclosure of sensitive information.<br><span class="segmentSeparator"></span>Special e-mail address is provided for responsible disclosure of security-related issues:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>security@evolveum.com</pre>
</div>
</div>
<div class="paragraph">
<p>Typical bug report contains following information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What operation have you tried or what do you want to achieve.<br><span class="segmentSeparator"></span>Some "bugs" may be caused by trying to achieve something using the wrong mechanism.<br><span class="segmentSeparator"></span>Having a broader perspective helps us to help you.</p>
</li>
<li>
<p>If there is a form or other input to the operation, then please describe how it was set up or filled in.<br><span class="segmentSeparator"></span>E.g.<br><span class="segmentSeparator"></span>an XML snippet used to import, data entered into input field, request deltas retrieved from an audit log and so on.</p>
</li>
<li>
<p>What kind of resource definition was used, how it was modified, etc.<br><span class="segmentSeparator"></span>We need to know only the relevant parts.<br><span class="segmentSeparator"></span>We prefer if you reproduce the problem with the simplest configuration possible (see above).</p>
</li>
<li>
<p>Any other special configuration that you feel can influence the outcome, such as custom schema, strange things in expressions, etc.</p>
</li>
<li>
<p>If the operation produced an error message in GUI, include that error message as well.</p>
</li>
<li>
<p>If there is an exception in the log files, please make sure that you include full stack trace of the exception.<br><span class="segmentSeparator"></span>The exception stack trace is usually a very efficient pointer to likely cause of the problem.</p>
</li>
<li>
<p>Relevant part of the log files.<br><span class="segmentSeparator"></span>You may want to have a look at the list of useful loggers above to correctly setup your logging to get the most useful data in the logs.</p>
</li>
<li>
<p>Your environment: operating system, Java platform version, target system version.<br><span class="segmentSeparator"></span>You do not need to bother with this if the bug is obviously not environment-specific.</p>
</li>
<li>
<p>Indication of midPoint version (release) or git branch/revision that was used.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Not all of the above is required in a bug report.<br><span class="segmentSeparator"></span>Use your common sense.<br><span class="segmentSeparator"></span>As a rule of the thumb too much information is usually better than too little information.<br><span class="segmentSeparator"></span>But sometimes too much non-relevant information may obscure the tiny problem that would be obvious if just the right amount of information is provided.</p>
</div>
</div>
<div class="sect2">
<h3 id="_useful_troubleshooting_tips">Useful Troubleshooting Tips</h3>
<div class="paragraph">
<p>Finally, there are some generic troubleshooting tips.<br><span class="segmentSeparator"></span>Those are not specific to midPoint and those tips should be a second nature to any experienced engineer.<br><span class="segmentSeparator"></span>Some of those were already covered.<br><span class="segmentSeparator"></span>However, it may still be useful to summarize.</p>
</div>
<div class="paragraph">
<p>First of all, try to keep your troubleshooting effort methodical and systematic.<br><span class="segmentSeparator"></span>It makes very little sense to just randomly poke around and hope that the bug will show its ugly head.<br><span class="segmentSeparator"></span>Even though such random methods may work occasionally, they will require a lot of effort in the end.<br><span class="segmentSeparator"></span>Try to follow a divide-and-conquer method.<br><span class="segmentSeparator"></span>Find a boundary in the middle of midPoint, e.g.<br><span class="segmentSeparator"></span>Clockwork component.<br><span class="segmentSeparator"></span>Examination of clockwork traces will show you whether the problem is in the mappings or it is in the provisioning.<br><span class="segmentSeparator"></span>Is the problem in provisioning?<br><span class="segmentSeparator"></span>Then select another boundary.<br><span class="segmentSeparator"></span>LDAP connector operation traces may be a good bet in that case.<br><span class="segmentSeparator"></span>That will show you whether the problem is in midPoint or it is in the LDAP server.<br><span class="segmentSeparator"></span>Are operation parameters wrong?<br><span class="segmentSeparator"></span>It means that problem is in midPoint, somewhere between model and the connector.<br><span class="segmentSeparator"></span>Have a look at debug logs of provisioning component.<br><span class="segmentSeparator"></span>Maybe there is wrong object class in the resource definition.<br><span class="segmentSeparator"></span>Have a look at debug logs on the connector.<br><span class="segmentSeparator"></span>Maybe connector configuration is wrong?<br><span class="segmentSeparator"></span>The log files will guide you to the problem.</p>
</div>
<div class="paragraph">
<p>MidPoint log files may look like a maze.<br><span class="segmentSeparator"></span>But it all makes sense.<br><span class="segmentSeparator"></span>MidPoint has good component structure and the log files reflect that.<br><span class="segmentSeparator"></span>You just need to understand how midPoint works and you will not get lost.<br><span class="segmentSeparator"></span>Just make sure that you never forget to look at the log files.<br><span class="segmentSeparator"></span>Always look at the log files.<br><span class="segmentSeparator"></span>When it comes to troubleshooting logfiles are your best friends.</p>
</div>
<div class="paragraph">
<p>There is one troubleshooting method that is universally applicable to almost any problem.<br><span class="segmentSeparator"></span>The method involves some specialist equipment.<br><span class="segmentSeparator"></span>However, this methods provides surprising, almost unbelievable results.<br><span class="segmentSeparator"></span>To make this method work you have to strictly follow those steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Describe your problem to a rubber duck.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Yes, a rubber duck.<br><span class="segmentSeparator"></span>That strange object that usually floats in bubble baths.<br><span class="segmentSeparator"></span>The duck is a good listener.<br><span class="segmentSeparator"></span>Therefore just go ahead and describe you problem to the duck.<br><span class="segmentSeparator"></span>Step by step.<br><span class="segmentSeparator"></span>Talk about every detail that you have explored.<br><span class="segmentSeparator"></span>Every possible solution that you have tried.<br><span class="segmentSeparator"></span>Do not hurry.<br><span class="segmentSeparator"></span>The duck has unlimited patience.<br><span class="segmentSeparator"></span>You have to literally talk to the duck.<br><span class="segmentSeparator"></span>Doing it just in your head does not work.<br><span class="segmentSeparator"></span>Talk to the duck.<br><span class="segmentSeparator"></span>The duck will help.<br><span class="segmentSeparator"></span>It is a wise animal.</p>
</div>
<div class="paragraph">
<p>As ridiculous as this process might sound, it really works.<br><span class="segmentSeparator"></span>It does wonders.<br><span class="segmentSeparator"></span>It is known as <em>rubber duck debugging</em> method.<br><span class="segmentSeparator"></span>Of course, it does not have to be a rubber duck.<br><span class="segmentSeparator"></span>Any object will work as long as you really talk to it.<br><span class="segmentSeparator"></span>However, choosing an object with eyes make you feel less stupid while you talk to it.<br><span class="segmentSeparator"></span>Rubber duck is a popular choice.</p>
</div>
<div class="paragraph">
<p>That is it.<br><span class="segmentSeparator"></span>Troubleshooting is not an easy work to do.<br><span class="segmentSeparator"></span>Although it may sometime resemble witchcraft, it is in fact a science.<br><span class="segmentSeparator"></span>And an art.<br><span class="segmentSeparator"></span>It needs some time to find your way.<br><span class="segmentSeparator"></span>But it is a time well spent.<br><span class="segmentSeparator"></span>It will be repaid many times over.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="91-devel">10.<br><span class="segmentSeparator"></span>MidPoint Development, Maintenance and Support</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
Those who do nothing but observe from the shadows cannot complain about the brightness of the sun.<br><span class="segmentSeparator"></span></blockquote>
<div class="attribution">
— Frank Herbert
</div>
</div>
<div class="paragraph">
<p>MidPoint is a <em>professional open source project</em>.<br><span class="segmentSeparator"></span>This means that midPoint is developed by using professional methods, but the product is still available under open source license.</p>
</div>
<div class="sect2">
<h3 id="_professional_development">Professional Development</h3>
<div class="paragraph">
<p>MidPoint is developed by a professional developers.<br><span class="segmentSeparator"></span>The development is lead by senior developers in the midPoint core team that have decades of software engineering experience.<br><span class="segmentSeparator"></span>There are also few younger developers in early stages of their careers.<br><span class="segmentSeparator"></span>MidPoint development team is first of all a community of developers that enjoy working together on a next-generation software.<br><span class="segmentSeparator"></span>Professionalism is a strict requirement for all midPoint development, but it is mostly the engineering passion that really moves the project forward.</p>
</div>
<div class="paragraph">
<p>All midPoint core developers work for Evolveum.<br><span class="segmentSeparator"></span>Evolveum is the company that created midPoint.<br><span class="segmentSeparator"></span>Evolveum also maintains midPoint.<br><span class="segmentSeparator"></span>Vast majority of work on midPoint is being done by midPoint core team.<br><span class="segmentSeparator"></span>All the core developers are paid for their work on midPoint.<br><span class="segmentSeparator"></span>The developers can pay their bills from the income that midPoint generates.<br><span class="segmentSeparator"></span>Evolveum income from midPoint is necessary to make sure that the developers have all their time available for midPoint development.<br><span class="segmentSeparator"></span>This means that midPoint can be properly maintained.</p>
</div>
<div class="paragraph">
<p>Professional development also means that professional software engineering methods are used to develop and maintain midPoint.<br><span class="segmentSeparator"></span>MidPoint development is firmly founded on principles of continuous integrations.<br><span class="segmentSeparator"></span>There are literally thousands of automated integration tests that are part of midPoint build process.<br><span class="segmentSeparator"></span>Thousands of additional automated tests are running every day.<br><span class="segmentSeparator"></span>There are tests that closely reflect real-world configurations and use cases.<br><span class="segmentSeparator"></span>There are tests with real resources.<br><span class="segmentSeparator"></span>All of that is an integral part of midPoint development.<br><span class="segmentSeparator"></span>MidPoint is a comprehensive and very flexible system.<br><span class="segmentSeparator"></span>Professional quality assurance is essential for midPoint to work reliably.</p>
</div>
</div>
<div class="sect2">
<h3 id="_open_source">Open Source</h3>
<div class="paragraph">
<p>MidPoint is an open source project.<br><span class="segmentSeparator"></span>All of midPoint source code is available under two open source licenses.<br><span class="segmentSeparator"></span>We have chosen Apache License 2.0 as this is one of the most liberal licenses out there.<br><span class="segmentSeparator"></span>We are also based in European Union and therefore midPoint is also under the terms of European Union Public License (EUPL).<br><span class="segmentSeparator"></span>But there is much more to open source than just a license.<br><span class="segmentSeparator"></span>Evolveum is fully committed to the open source approach.<br><span class="segmentSeparator"></span>MidPoint is completely developed in public.<br><span class="segmentSeparator"></span>Entire history of midPoint source code is public.<br><span class="segmentSeparator"></span>Every commit of every developer is immediately available to anyone.<br><span class="segmentSeparator"></span>Complete midPoint source code is available.<br><span class="segmentSeparator"></span>There are no private parts that are held back by purpose.<br><span class="segmentSeparator"></span>There are no private branches with extra features.<br><span class="segmentSeparator"></span>Even all the support branches are completely public.<br><span class="segmentSeparator"></span>When it comes to the source code midPoint is as true to the open source methods as it gets.</p>
</div>
<div class="paragraph">
<p>Even though vast majority of midPoint development is done by Evolveum, open source approach is absolutely critical for the success of midPoint.<br><span class="segmentSeparator"></span>Open source is the only way that allows midPoint users to understand midPoint completely.<br><span class="segmentSeparator"></span>All non-trivial software needs to be customized in some way and open source brings the ultimate power of customization.<br><span class="segmentSeparator"></span>Open source allows participation.<br><span class="segmentSeparator"></span>Open source is great approach to avoid vendor lock-in.<br><span class="segmentSeparator"></span>Open source brings longevity to the project.<br><span class="segmentSeparator"></span>Open source has so much advantages.<br><span class="segmentSeparator"></span>Evolveum is completely committed to the open source approach.</p>
</div>
<div class="paragraph">
<p>MidPoint has started as an open source project.<br><span class="segmentSeparator"></span>MidPoint source code was available from the day one.<br><span class="segmentSeparator"></span>And as far as we have something to say about it midPoint will remain open source forever.</p>
</div>
</div>
<div class="sect2">
<h3 id="_midpoint_release_cycle">MidPoint Release Cycle</h3>
<div class="paragraph">
<p>MidPoint has stable development cycle.<br><span class="segmentSeparator"></span>There are two <em>feature releases</em> every year.<br><span class="segmentSeparator"></span>As the name suggests, those releases are bringing new features and major improvements.</p>
</div>
<div class="paragraph">
<p>In addition to that, there are several <em>maintenance releases</em>.<br><span class="segmentSeparator"></span>Those releases bring bugfixes and minor improvements.<br><span class="segmentSeparator"></span>Maintenance releases are published as needed, there is no strict schedule.<br><span class="segmentSeparator"></span>Timing of maintenance releases is influenced by midPoint subscribers.</p>
</div>
<div class="paragraph">
<p>Every couple of years there is a special long-term support (LTS) release.<br><span class="segmentSeparator"></span>This release is supported for a longer time than usual.<br><span class="segmentSeparator"></span>This release is ideal for people that prefer stability over new features.</p>
</div>
</div>
<div class="sect2">
<h3 id="_midpoint_support_and_subscriptions">MidPoint Support and Subscriptions</h3>
<div class="paragraph">
<p>MidPoint support and subscription is a service provided by Evolveum.<br><span class="segmentSeparator"></span>There are several service offerings with different scope and service level.<br><span class="segmentSeparator"></span>But generally speaking, the most common service is 3<sup>rd</sup>-line support.<br><span class="segmentSeparator"></span>Which basically means that we will fix midPoint bugs.<br><span class="segmentSeparator"></span>Obviously this includes assistance with diagnostics of difficult issues where it is not entirely clear whether it is a bug or configuration issue.<br><span class="segmentSeparator"></span>Simply speaking, midPoint support service is a way how to make sure that your midPoint deployment will run without any problems.<br><span class="segmentSeparator"></span>There are also subscription offerings designed to help you deploy midPoint in the first place.<br><span class="segmentSeparator"></span>Some subscription offerings also contain feature development and improvements (a.k.a.<br><span class="segmentSeparator"></span>4<sup>th</sup>-line support).<br><span class="segmentSeparator"></span>Those subscriptions are ideal way to make sure midPoint will be able to do anything that you need for your project.</p>
</div>
<div class="paragraph">
<p>MidPoint support and subscription services provide significant funding for midPoint development and maintenance.<br><span class="segmentSeparator"></span>Therefore, it is perfectly natural that midPoint subscribers get high priority for resolution of their issues, feature requests and so on.<br><span class="segmentSeparator"></span>This limits the time that midPoint core team has available for other tasks.<br><span class="segmentSeparator"></span>Therefore there are some rules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Every new midPoint feature must be <em>sponsored</em>.<br><span class="segmentSeparator"></span>This means that a customer with an active midPoint subscription has endorsed the feature.<br><span class="segmentSeparator"></span>Of course, this has to be a high-end subscription that includes feature development.<br><span class="segmentSeparator"></span>Or, alternatively, someone have to pay for the development cost of that feature.<br><span class="segmentSeparator"></span>However, direct feature sponsoring is very limited as most of the midPoint development capacity is reserved for subscribers.</p>
</li>
<li>
<p>MidPoint architecture and quality is the primary responsibility of Evolveum team.<br><span class="segmentSeparator"></span>Part of Evolveum income is reserved to maintain midPoint - to keep the architecture up to date, to make systemic quality improvements, to maintain midPoint in the long run and so on.<br><span class="segmentSeparator"></span>In some cases Evolveum will sponsor feature development.<br><span class="segmentSeparator"></span>Those are usually strategic features that lead midPoint development in the right direction.<br><span class="segmentSeparator"></span>Or those may be experimental features aimed at exploring a particularly interesting functionality.<br><span class="segmentSeparator"></span>However, Evolveum will not sponsor any "customer" features.<br><span class="segmentSeparator"></span>Those need to be covered by subscriptions.</p>
</li>
<li>
<p>Evolveum will eventually fix any bugs in midPoint.<br><span class="segmentSeparator"></span>Those bugfixes will be committed to midPoint primary development branch (<em>master branch</em>).<br><span class="segmentSeparator"></span>The fixes that make it into development branch will be part of the next feature release.<br><span class="segmentSeparator"></span>However, as midPoint release cycle is fixed, not all of the bugs will be fixed in each release.<br><span class="segmentSeparator"></span>The bugs that were reported as part of subscription or support service will be fixed first.<br><span class="segmentSeparator"></span>If there is still some time, then other (non-subscriber) bugs will be fixed as well.<br><span class="segmentSeparator"></span>But there are no guarantees for that.<br><span class="segmentSeparator"></span>If the time before the release runs out, bugs reported by non-subscribers will not get fixed.<br><span class="segmentSeparator"></span>In fact, such non-subscriber fixes may have to wait for several releases until they finally get fixed.</p>
</li>
<li>
<p>Every feature release has a <em>support branch</em>.<br><span class="segmentSeparator"></span>This is where the maintenance releases come from.<br><span class="segmentSeparator"></span>However, every bugfix or improvement is developed on master branch first.<br><span class="segmentSeparator"></span>It has to be backported to the support branch.<br><span class="segmentSeparator"></span>Which takes time.<br><span class="segmentSeparator"></span>Therefore, there are very strict rules for backporting.<br><span class="segmentSeparator"></span>Any bugfix, improvement or any other update will go to the support branch only if:</p>
<div class="ulist">
<ul>
<li>
<p>Backport to support branch is explicitly requested by customer with active support or subscription service.</p>
</li>
<li>
<p>The target release is still in its active support period (i.e.<br><span class="segmentSeparator"></span>it is not after "end of life").</p>
</li>
<li>
<p>It is a security issue.<br><span class="segmentSeparator"></span>Security issues have absolute priority.<br><span class="segmentSeparator"></span>Those will be fixed immediately regardless of who reported them (subscriber or non-subscriber).<br><span class="segmentSeparator"></span>Fixes for severe security issues will also get automatically backported to all active support branches.</p>
</li>
<li>
<p>It fixes a severe issue that affect large number of users.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Simply speaking, if you want to make sure that midPoint works for you, then purchase a support or subscription.<br><span class="segmentSeparator"></span>Those services will help you, that is what they are for.<br><span class="segmentSeparator"></span>But the money from support and subscription services also enable long-term midPoint maintenance and new feature development.<br><span class="segmentSeparator"></span>Getting midPoint support or subscription is the right thing to do.</p>
</div>
</div>
<div class="sect2">
<h3 id="_midpoint_community">MidPoint Community</h3>
<div class="paragraph">
<p>MidPoint is a proper open source project.<br><span class="segmentSeparator"></span>And as all good open source projects midPoint has a vibrant community.<br><span class="segmentSeparator"></span>This is both engineering community and business community.<br><span class="segmentSeparator"></span>The primary communication channel of the engineering community is midPoint mailing list.<br><span class="segmentSeparator"></span>Mailing list is used to discuss midPoint futures, announce new releases, discuss configuration issues, provide feedback to the development team and so on.<br><span class="segmentSeparator"></span>MidPoint community is open to anyone.</p>
</div>
<div class="paragraph">
<p>Business community is formed mostly from Evolveum partners.<br><span class="segmentSeparator"></span>Evolveum partners deliver midPoint solutions, provide 1<sup>st</sup>-line and 2<sup>nd</sup>-line support services, provide professional services, customized solutions based on midPoint and so on.<br><span class="segmentSeparator"></span>The possibilities are endless.<br><span class="segmentSeparator"></span>Even the business community is open.<br><span class="segmentSeparator"></span>Entry-level partnership is open to anyone.<br><span class="segmentSeparator"></span>However, there are several partnership levels and it takes some effort for a partner to level up.<br><span class="segmentSeparator"></span>There is a rich (and growing) network of midPoint partners.<br><span class="segmentSeparator"></span>The partners can deliver solutions based on midPoint almost anywhere on planet Earth.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="92-additional-information">11.<br><span class="segmentSeparator"></span>Additional Information</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
Logic’s useless unless it’s armed with essential data.<br><span class="segmentSeparator"></span></blockquote>
<div class="attribution">
— Leto II<br>
<cite>Children of Dune by Frank Herbert</cite>
</div>
</div>
<div class="paragraph">
<p>We have tried to make this book as comprehensive as possible.<br><span class="segmentSeparator"></span>But no book can possibly include all the information that an IDM engineer would ever need.<br><span class="segmentSeparator"></span>Therefore, this chapter describes the sources of additional information about midPoint.</p>
</div>
<div class="sect2">
<h3 id="_midpoint_wiki">MidPoint Wiki</h3>
<div class="paragraph">
<p>MidPoint wiki is the most comprehensive information about midPoint.<br><span class="segmentSeparator"></span>This is where all the midPoint documentation is stored.<br><span class="segmentSeparator"></span>But there is much more.<br><span class="segmentSeparator"></span>There is connector documentation, midPoint architecture, developer documentation, midPoint internals and all kinds of information including midPoint release planning and roadmap.<br><span class="segmentSeparator"></span>Everything is public.</p>
</div>
<div class="paragraph">
<p>However, the wiki is so comprehensive that it is often not entirely easy to find the right page.<br><span class="segmentSeparator"></span>We have done what we could to organize the information.<br><span class="segmentSeparator"></span>The pages are organized hierarchically.<br><span class="segmentSeparator"></span>Many pages have "See Also" section that points to additional information.<br><span class="segmentSeparator"></span>Yet, the practice shows that if you want to find something in the wiki, you need to have at least a faint idea what you are looking for.<br><span class="segmentSeparator"></span>This book should give you that idea.<br><span class="segmentSeparator"></span>If you know what you are looking for, then the wiki search bar is your friend.<br><span class="segmentSeparator"></span>If you enter the correct search term, then there is high probability that you will quickly find the right page.</p>
</div>
<div class="paragraph">
<p>URL: <a href="https://wiki.evolveum.com/" class="bare">https://wiki.evolveum.com/</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_samples">Samples</h3>
<div class="paragraph">
<p>The midPoint projects maintains quite a rich collection of samples.<br><span class="segmentSeparator"></span>These are sample resource definitions, role and organizational structure examples and other various samples.<br><span class="segmentSeparator"></span>They are usually provided in the XML form.<br><span class="segmentSeparator"></span>The samples are maintained in a separate project on GitHub.<br><span class="segmentSeparator"></span>Those samples are also part of midPoint distribution package.</p>
</div>
<div class="paragraph">
<p>URL (latest version): <a href="https://github.com/Evolveum/midpoint-samples/tree/master/samples" class="bare">https://github.com/Evolveum/midpoint-samples/tree/master/samples</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_book_samples">Book Samples</h3>
<div class="paragraph">
<p>This book contains many examples and configuration snippets that are taken from various places.<br><span class="segmentSeparator"></span>Some of the smaller snippets are taken from midPoint wiki or from the sample files (see above).</p>
</div>
<div class="paragraph">
<p>Some chapters contain mostly complete configurations of the midPoint deployment.<br><span class="segmentSeparator"></span>These configurations have a separate folder in the midPoint samples.<br><span class="segmentSeparator"></span>Look for a folder <code>book</code> in midPoint samples.<br><span class="segmentSeparator"></span>All the important files used in this book are there, sorted by chapter number.</p>
</div>
<div class="paragraph">
<p>URL: <a href="https://github.com/Evolveum/midpoint-samples/tree/master/samples/book" class="bare">https://github.com/Evolveum/midpoint-samples/tree/master/samples/book</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_story_tests">Story Tests</h3>
<div class="paragraph">
<p>MidPoint developers like to create and maintain complete end-to-end automated tests.<br><span class="segmentSeparator"></span>These tests are usually inspired by real-world midPoint deployments.<br><span class="segmentSeparator"></span>We call them story tests.<br><span class="segmentSeparator"></span>These tests are important to maintain midPoint quality and continuity.<br><span class="segmentSeparator"></span>However, they are also excellent source of inspiration and they have often proved useful as examples of midPoint configuration.</p>
</div>
<div class="paragraph">
<p>Wiki description: <a href="https://wiki.evolveum.com/display/midPoint/Story+Tests" class="bare">https://wiki.evolveum.com/display/midPoint/Story+Tests</a><br>
Code&nbsp;and&nbsp;configuration:&nbsp;<a href="https://github.com/Evolveum/midpoint/tree/master/testing/story" class="bare">https://github.com/Evolveum/midpoint/tree/master/testing/story</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_midpoint_mailing_list">MidPoint Mailing List</h3>
<div class="paragraph">
<p>MidPoint project attracted a vibrant community during the years.<br><span class="segmentSeparator"></span>The main community communication channel is midPoint mailing list.<br><span class="segmentSeparator"></span>The mailing list is used for announcements, user suggestions and also what we at Evolveum call <em>community support</em>.<br><span class="segmentSeparator"></span>The mailing list is used to ask questions about midPoint.<br><span class="segmentSeparator"></span>Experienced community members usually answer these questions and provide pointers to additional information.<br><span class="segmentSeparator"></span>The whole midPoint development team is also subscribed to the mailing list and they provide answers when needed.<br><span class="segmentSeparator"></span>However, this is a best effort service.<br><span class="segmentSeparator"></span>Please do not abuse this communication channel and try to keep the following community guidelines:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Be polite.</strong> Mailing list is a best effort service.<br><span class="segmentSeparator"></span>Nobody is (directly) paid to answer mailing list questions.<br><span class="segmentSeparator"></span>The engineers that answer the questions are doing that in addition to their day-to-day responsibilities and they are doing that because they want to help the community.<br><span class="segmentSeparator"></span>Therefore, if you are asking for help, do so politely.<br><span class="segmentSeparator"></span>If you are answering a question please respect other members.<br><span class="segmentSeparator"></span>Everybody started somewhere and it is natural that novice users do not know everything.<br><span class="segmentSeparator"></span>Please tolerate the differences in skill sets.</p>
</li>
<li>
<p><strong>Do some research before asking a question.</strong> Do not ask trivial question that can be easily answered by googling the question, by searching for it in the midPoint wiki or mailing list archive.<br><span class="segmentSeparator"></span>If you are getting an error try to read error message very carefully and try to think about the possible causes.<br><span class="segmentSeparator"></span>Try to experiment with the configuration a bit.<br><span class="segmentSeparator"></span>Look at troubleshooting section of this wiki.<br><span class="segmentSeparator"></span>Spend at least a couple of minutes to make your own research before asking the question.<br><span class="segmentSeparator"></span>If that research does not provide the answer, then it is a good question for the mailing list.</p>
</li>
<li>
<p><strong>Provide context.</strong> If your post looks like "<em>my midpoint is broken, please help</em>" then it is very unlikely that you will get any answers.<br><span class="segmentSeparator"></span>Try to describe your problem in more details.<br><span class="segmentSeparator"></span>Make sure to describe relevant bits of your configuration.<br><span class="segmentSeparator"></span>Be sure to include error message.<br><span class="segmentSeparator"></span>Look in the log files if necessary.<br><span class="segmentSeparator"></span>And most importantly: describe what you are trying to achieve.<br><span class="segmentSeparator"></span>Maybe the root of your problem is that you are using completely wrong approach.<br><span class="segmentSeparator"></span>The community may point your nose in the right direction - but only if they know what is your goal.</p>
</li>
<li>
<p><strong>Give back.</strong> Mailing list is not one way communication channel where users ask questions and developers answer them.<br><span class="segmentSeparator"></span>There is already a significant body of knowledge distributed among community members that are not midPoint developers.<br><span class="segmentSeparator"></span>If you adhere to these guidelines and ask a question it will most likely be answered.<br><span class="segmentSeparator"></span>But for that there needs to be someone who is answering.<br><span class="segmentSeparator"></span>Therefore do not just ask the questions.<br><span class="segmentSeparator"></span>If you know the answer to the question that someone else asks then please go ahead and answer it.<br><span class="segmentSeparator"></span>Do not worry that your answer may not be perfect.<br><span class="segmentSeparator"></span>Even a partial answer will be greatly appreciated by any novice user.<br><span class="segmentSeparator"></span>Simply speaking: Do not only take from the community.<br><span class="segmentSeparator"></span>Try to repay what the community gave you.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You may also be tempted to send your questions directly to Evolveum or midPoint developers.<br><span class="segmentSeparator"></span>However, the developers have many midPoint users, partners, customers and contributors to deal with in their day-to-day job.<br><span class="segmentSeparator"></span>The first responsibility of any midPoint core developer is to make sure that midPoint development will continue.<br><span class="segmentSeparator"></span>The developers naturally prefer to spend time doing tasks that bring funding to the midPoint project.<br><span class="segmentSeparator"></span>Therefore, the developers will strictly prioritize the communication.<br><span class="segmentSeparator"></span>Answers to midPoint subscribers are highest priority, mailing list is second and answers to private messages from the community are absolutely lowest priority.<br><span class="segmentSeparator"></span>We prefer efficient spread of knowledge about midPoint.<br><span class="segmentSeparator"></span>Mailing list is good for that, but private communication is not.<br><span class="segmentSeparator"></span>That’s the primary reason for this priority setup.<br><span class="segmentSeparator"></span>Besides, if you contact a developer directly, then only that developer can answer your question.<br><span class="segmentSeparator"></span>But if you send the question to the mailing list there are more people that can potentially answer the question.<br><span class="segmentSeparator"></span>Therefore, unless you have active subscription the mailing list is your best option.</p>
</div>
<div class="paragraph">
<p>Mailing list URL: <a href="http://lists.evolveum.com/mailman/listinfo/midpoint" class="bare">http://lists.evolveum.com/mailman/listinfo/midpoint</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_evolveum_blog">Evolveum Blog</h3>
<div class="paragraph">
<p>Vast majority of midPoint development and maintenance is conducted by Evolveum team.<br><span class="segmentSeparator"></span>The people of Evolveum present their professional opinions by the means of Evolveum blog.<br><span class="segmentSeparator"></span>The blog is very technology-friendly.<br><span class="segmentSeparator"></span>The information provided on the blog goes often quite deep.<br><span class="segmentSeparator"></span>This is also a channel how Evolveum shares information about midPoint development plans and business activities related to midPoint.<br><span class="segmentSeparator"></span>It is a very valuable resource for anyone that has a professional interest in midPoint.</p>
</div>
<div class="paragraph">
<p>URL: <a href="https://evolveum.com/blog/" class="bare">https://evolveum.com/blog/</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="98-to-be-continued">To Be Continued</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
Hanc marginis exiguitas non caperet.<br>
(There is not enough space in the margin to write it.)
</blockquote>
<div class="attribution">
— Pierre de Fermat
</div>
</div>
<div class="paragraph">
<p>This is it then.<br><span class="segmentSeparator"></span>That was the last real chapter of this book.<br><span class="segmentSeparator"></span>But we have not yet covered all capabilities of midPoint.<br><span class="segmentSeparator"></span>In fact, we are not even close.<br><span class="segmentSeparator"></span>We have only scratched the surface of what midPoint can provide.<br><span class="segmentSeparator"></span>The other chapters are not written yet.<br><span class="segmentSeparator"></span>There is still so much to write about:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Organizational structure:</strong> Organizations, divisions, departments, but also projects, teams, ad-hoc workgroups, realms, tenants and in fact anything else that you can imagine.<br><span class="segmentSeparator"></span>This is all about organizing people in groups and applying policies.<br><span class="segmentSeparator"></span>But midPoint organizational structure is even more flexible than that.<br><span class="segmentSeparator"></span>Even roles and other midPoint objects can be organized.<br><span class="segmentSeparator"></span>Organizational structures in all their forms are fundamental building blocks that can be used to create really interesting configurations.</p>
</li>
<li>
<p><strong>Authorizations:</strong> MidPoint works with sensitive data and there is a need to strictly control access to that data.<br><span class="segmentSeparator"></span>Therefore, midPoint has a fine-grained authorization system for controlling access to itself.<br><span class="segmentSeparator"></span>Authorization mechanisms are very powerful allowing many scenarios from delegated administration to partial multi-tenancy.</p>
</li>
<li>
<p><strong>Archetypes:</strong> Users, roles, orgs and services are the four basic object types of midPoint.<br><span class="segmentSeparator"></span>They are quite powerful.<br><span class="segmentSeparator"></span>But there is often a need to define special behavior for employees, agents, students, academic staff, partners and other types of persons.<br><span class="segmentSeparator"></span>We would also like to see business roles, application roles, system roles.<br><span class="segmentSeparator"></span>And the enterprises would be lost without their divisions, departments and sections.<br><span class="segmentSeparator"></span>There are always shades, flavors and subtypes to objects.<br><span class="segmentSeparator"></span>And that is what <em>archetypes</em> do.<br><span class="segmentSeparator"></span>They can be used to create subtle flavors of functionality suitable for individual object types.</p>
</li>
<li>
<p><strong>MidPoint queries:</strong> MidPoint often needs to find objects in the repository.<br><span class="segmentSeparator"></span>There is an special-purpose query language that is used in many places in midPoint.</p>
</li>
<li>
<p><strong>Security:</strong> MidPoint works with quite a sensitive data, therefore it is quite important to keep midPoint secure.<br><span class="segmentSeparator"></span>There are many security-related settings, ranging from the usual network security mechanisms, through authentication to a midPoint-specific settings.</p>
</li>
<li>
<p><strong>Identity management miscellanea:</strong> There are various interesting features that were not mentioned yet: iteration, password policies, notifications, auxiliary object classes, provisioning dependencies, deputies, constants, function libraries, provisioning scripts and so on.<br><span class="segmentSeparator"></span>Those may be little features, but they are essential pieces of the puzzle.<br><span class="segmentSeparator"></span>It is almost impossible to have a complete identity management solution and not to use any of those features.</p>
</li>
<li>
<p><strong>Requests and approvals:</strong> Browse available roles, select role, request role, approve role, assign role, provision accounts.<br><span class="segmentSeparator"></span>That is the basic mantra of many identity management deployments.<br><span class="segmentSeparator"></span>Of course this is easy to do in midPoint.<br><span class="segmentSeparator"></span>But there is much more: multi level approvals, optional approval steps, dynamic approver selection, escalation and so on.<br><span class="segmentSeparator"></span>MidPoint has most of the features already built-in, you just need to configure them.</p>
</li>
<li>
<p><strong>Entitlements:</strong> Managing accounts if fine.<br><span class="segmentSeparator"></span>But it is not the whole story.<br><span class="segmentSeparator"></span>There is huge difference between a regular account and an administrator account.<br><span class="segmentSeparator"></span>Fortunately, midPoint can easily manage membership in groups, roles, assignment of privileges and other entitlements.<br><span class="segmentSeparator"></span>In this case we really mean entitlements on the resources, such as Active Directory groups, distribution lists, Unix groups and so on.<br><span class="segmentSeparator"></span>MidPoint is designed to this quite easily.</p>
</li>
<li>
<p><strong>Generic synchronization:</strong> Any self-respecting identity management system can synchronize accounts and users.<br><span class="segmentSeparator"></span>But what about roles, organizational units, groups and things like that?<br><span class="segmentSeparator"></span>You guessed it, midPoint can do it.<br><span class="segmentSeparator"></span>In fact, the same principles that are used for user-account synchronization can be directly reused.<br><span class="segmentSeparator"></span>Do you want your departments to automatically appear as OU objects in Active Directory?<br><span class="segmentSeparator"></span>Here you go.<br><span class="segmentSeparator"></span>Do you want to place the users there.<br><span class="segmentSeparator"></span>That is easy.<br><span class="segmentSeparator"></span>Do you also want to create nested LDAP groups for the departments?<br><span class="segmentSeparator"></span>No problem.<br><span class="segmentSeparator"></span>MidPoint can do it all.</p>
</li>
<li>
<p><strong>Manual resources:</strong> Obviously, you want most of the resource to be connected to midPoint by a connector so they can be automatically managed.<br><span class="segmentSeparator"></span>But there are always few bothersome resources that just won’t comply.<br><span class="segmentSeparator"></span>Maybe they are too small to justify the cost of building a connector.<br><span class="segmentSeparator"></span>Maybe there is just no good way for the connector to manage the resource.<br><span class="segmentSeparator"></span>But midPoint one again comes to the rescue.<br><span class="segmentSeparator"></span>MidPoint has a concept of <em>manual resource</em> where the work is done by system administrator instead of connector.<br><span class="segmentSeparator"></span>There is even a way how to create semi-manual resource that can read the data, but provisioning is still manual.<br><span class="segmentSeparator"></span>And there is a way how to integrate this with ITSM system.</p>
</li>
<li>
<p><strong>Auditing and history:</strong> No identity management system can be complete without an auditing facility.<br><span class="segmentSeparator"></span>MidPoint can store every operation to the audit trail: changes in users, accounts, roles - even internal configuration changes.<br><span class="segmentSeparator"></span>This is stored in a format that can be used to integrate midPoint with a data warehouse or a SIEM system.<br><span class="segmentSeparator"></span>Also midPoint user interface has a facility to display the audit trail.<br><span class="segmentSeparator"></span>And it can even look into the past: it can reconstruct the objects as they were at a certain point in time.</p>
</li>
<li>
<p><strong>Policy rules:</strong> MidPoint is much more than just an identity management system.<br><span class="segmentSeparator"></span>The identity governance features of midPoint are based on a powerful and universal concept of <em>policy rules</em>.<br><span class="segmentSeparator"></span>The rules can be used to express role exclusions, thus defining a segregation of duties (SoD) policy.<br><span class="segmentSeparator"></span>The rules can be used to define policy-based approval.<br><span class="segmentSeparator"></span>The rules can control role lifecycle.<br><span class="segmentSeparator"></span>The rules can define compliance policies.<br><span class="segmentSeparator"></span>The rules can do it all.<br><span class="segmentSeparator"></span>The rules are here to <em>govern</em> the identities.</p>
</li>
<li>
<p><strong>Access certification:</strong> This is known by many names: certification, re-certification, attestation, …​ but whatever the name is it is still the same process.<br><span class="segmentSeparator"></span>Simply speaking, this is a method to review roles assigned to the users to make sure the users still need the roles that they have.<br><span class="segmentSeparator"></span>This is a method how to get a grip on the <em>principle of least privilege</em> even in environments that are naturally inclined to ad-hoc operation.<br><span class="segmentSeparator"></span>But it is very useful mechanism in almost all environments.<br><span class="segmentSeparator"></span>And midPoint provides many flavors of certification mechanisms from a scheduled mass recertification campaigns focused on roles assignments to an ad-hoc recertification of a single used after he is moved to a new organization.</p>
</li>
<li>
<p><strong>Data protection:</strong> Identity management is no longer a wild west where anybody can do anything.<br><span class="segmentSeparator"></span>Now there are strict data protection rules, regulations and legislation.<br><span class="segmentSeparator"></span>Being a good identity governance system midPoint can assist in managing the data protection and privacy policies.<br><span class="segmentSeparator"></span>MidPoint can be really helpful in managing compliance to the data protection regulations such as European GDPR legislation.</p>
</li>
<li>
<p><strong>User interface customizations:</strong> MidPoint has a general-purpose user interface that can be used for user self-service, identity administration and system configuration.<br><span class="segmentSeparator"></span>The user interface is designed to be dynamic.<br><span class="segmentSeparator"></span>It will automatically adapt to resource schemas, extension of midPoint schema, authorizations and so on.<br><span class="segmentSeparator"></span>Therefore, usually there is no need to customize user interface at all.<br><span class="segmentSeparator"></span>But there are cases when the deployment need to deviate from the default behavior.<br><span class="segmentSeparator"></span>And midPoint is prepared to that.<br><span class="segmentSeparator"></span>There are many ways how to customize user interface: colors, stylesheets, localization, custom forms, tabs, whole new custom pages.<br><span class="segmentSeparator"></span>In extreme cases midPoint can be customized beyond recognition.</p>
</li>
<li>
<p><strong>Integration with midPoint services:</strong> MidPoint is a great system.<br><span class="segmentSeparator"></span>But even great software does not live in isolation.<br><span class="segmentSeparator"></span>There is always need to integrate the systems together.<br><span class="segmentSeparator"></span>Integration runs through midPoint veins, because that is what the connectors really do.<br><span class="segmentSeparator"></span>But often there is a need to integrate midPoint with other systems that is beyond the capabilities of a connector.<br><span class="segmentSeparator"></span>Maybe there is a password reset application that needs to interact with midPoint.<br><span class="segmentSeparator"></span>Maybe there is a analytic software that needs to get midPoint data.<br><span class="segmentSeparator"></span>MidPoint was designed from the day one to be a service-based application.<br><span class="segmentSeparator"></span>Therefore there are REST and SOAP services packed with features.<br><span class="segmentSeparator"></span>Actually almost anything that midPoint does can be controlled by using those services.</p>
</li>
<li>
<p><strong>Advanced concepts:</strong> There are still some features that were not explained in previous chapters: consistency mechanisms, personas, multi-connector resources and so on.<br><span class="segmentSeparator"></span>Some of those features are seldom used, but they may save your project.<br><span class="segmentSeparator"></span>Other features are used all the times, but they are a natural part of midPoint and therefore they are almost invisible.<br><span class="segmentSeparator"></span>But all those features deserve explanation.<br><span class="segmentSeparator"></span>And there is also a need to describe how midPoint itself is developed – as there is a lot of experimental and incomplete features.<br><span class="segmentSeparator"></span>But, as this is midPoint, even those features may be extremely useful.<br><span class="segmentSeparator"></span>This chapter may also be interesting to people who would like to extended midPoint in an unusual way or those that want to contribute to midPoint development.</p>
</li>
<li>
<p><strong>MidPoint Deployment:</strong> There are many path from downloading midPoint packages to a working system.<br><span class="segmentSeparator"></span>Some of those paths are easier than other.<br><span class="segmentSeparator"></span>MidPoint design was build on many years of practical identity management experience.<br><span class="segmentSeparator"></span>Therefore, midPoint has mechanisms that can be used to efficiently overcome some of the notorious problems in identity management – provided that midPoint is used correctly.<br><span class="segmentSeparator"></span>This chapter aims at giving advice how midPoint should be used in practical projects.<br><span class="segmentSeparator"></span>How to plan the project, what information to gather, how to design the deployment, how to prepare the environment, plan the migration, handle project extensions and changes and so on.</p>
</li>
<li>
<p><strong>Management of IAM program:</strong> Identity management is very similar to information security: Identity management has no end.<br><span class="segmentSeparator"></span>Identity management is not a project.<br><span class="segmentSeparator"></span>It is a program.<br><span class="segmentSeparator"></span>It is an endless cycle of gathering data, planning and execution.<br><span class="segmentSeparator"></span>The environment around identity management is always changing, therefore identity management must change as well.<br><span class="segmentSeparator"></span>But midPoint is designed for this kind of longevity.<br><span class="segmentSeparator"></span>This chapter will describe how to handle this endless cycle.<br><span class="segmentSeparator"></span>How to make midPoint configuration open to extensions.<br><span class="segmentSeparator"></span>How to gather data.<br><span class="segmentSeparator"></span>How to handle new feature requests.<br><span class="segmentSeparator"></span>How to do upgrades.<br><span class="segmentSeparator"></span>How to keep identity management solution sustainable.</p>
</li>
<li>
<p><strong>Deployment examples:</strong> This book uses a lot of examples in all the chapters.<br><span class="segmentSeparator"></span>But those are examples designed to demonstrate one specific aspect of midPoint functionality.<br><span class="segmentSeparator"></span>This chapter will be different.<br><span class="segmentSeparator"></span>There will be complete examples of practical midPoint solutions.<br><span class="segmentSeparator"></span>After all, the way that copying and pasting is one the best ways how to learn.</p>
</li>
<li>
<p><strong>Glossary:</strong> Identity management and governance parlance may sound like an alien language to a newcomer.<br><span class="segmentSeparator"></span>Therefore, perhaps preparing IDMimsh-to-english dictionary might be a good idea.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Those chapters are still missing.<br><span class="segmentSeparator"></span>They are not written yet.<br><span class="segmentSeparator"></span>Obviously, the best people to write those chapters are the people from the Evolveum team: people that designed and implemented midPoint, people that support midPoint deployments, people that work with midPoint every day, people that eat, breathe and sleep midPoint.<br><span class="segmentSeparator"></span>But those people are just engineers.<br><span class="segmentSeparator"></span>They need to pay their bills.<br><span class="segmentSeparator"></span>They cannot put away their day-to-day responsibilities to work on this book.<br><span class="segmentSeparator"></span>Obviously, funding is needed to finish the book.<br><span class="segmentSeparator"></span>As this book is available for free there is no direct income that could provide the funding for next chapters.<br><span class="segmentSeparator"></span>There is only one way: sponsoring.</p>
</div>
<div class="paragraph">
<p>If you like this book, then please consider sponsoring some of the next chapters.<br><span class="segmentSeparator"></span>You can use Evolveum crowdfunding portal at <a href="https://wanted.evolveum.com/">wanted.evolveum.com</a>.<br><span class="segmentSeparator"></span>Or in case you are considering a larger-scale sponsoring, please contact Evolveum team directly.<br><span class="segmentSeparator"></span>The market economy is, unfortunately, quite ruthless.<br><span class="segmentSeparator"></span>Therefore, it is pretty straightforward: if there are no sponsors, it is very unlikely that there will be any new chapters.<br><span class="segmentSeparator"></span>Therefore, please sponsor this book if you can.<br><span class="segmentSeparator"></span>If you cannot afford to sponsor this book, then please at least help us to spread the word: a word about midPoint and a word about this book.<br><span class="segmentSeparator"></span>Any form of help is more than appreciated.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion_4">Conclusion</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
A conclusion is the place where you get tired of thinking.<br><span class="segmentSeparator"></span></blockquote>
<div class="attribution">
— Steven Wright
</div>
</div>
<div class="paragraph">
<p>This book is not finished yet.<br><span class="segmentSeparator"></span>In fact it is just a beginning.<br><span class="segmentSeparator"></span>The books is written continually in an incremental and iterative fashion as fast as time an money allow.</p>
</div>
<div class="paragraph">
<p>Your contributions and donations will surely speed up completion of this book.<br><span class="segmentSeparator"></span>Also consider getting midPoint subscription.<br><span class="segmentSeparator"></span>That is the source of funding for midPoint development.<br><span class="segmentSeparator"></span>Evolveum is no mega-corporation that can fund open source development from huge profits in other areas.<br><span class="segmentSeparator"></span>There are no other areas.<br><span class="segmentSeparator"></span>Evolveum is open-source-only company.<br><span class="segmentSeparator"></span>Everything we do is focused on open source projects.<br><span class="segmentSeparator"></span>Evolveum is not a start-up either.<br><span class="segmentSeparator"></span>We are not funded by venture capital and we do not have millions to spend.<br><span class="segmentSeparator"></span>Evolveum is a self-funded company.<br><span class="segmentSeparator"></span>We can spend only what we earn on subscriptions, sponsored features and services.<br><span class="segmentSeparator"></span>There is no other income.<br><span class="segmentSeparator"></span>MidPoint development can only go as fast as the money allow.<br><span class="segmentSeparator"></span>The same principle applies to midPoint documentation and this book.<br><span class="segmentSeparator"></span>It will grow proportionally to the Evolveum income.<br><span class="segmentSeparator"></span>Therefore, if you liked this book please consider supporting us.<br><span class="segmentSeparator"></span>Both money and your time are more than appreciated.</p>
</div>
<div class="paragraph">
<p>We hope that you enjoyed reading this book at least as much as we enjoyed writing it – and as we enjoy creating midPoint in the first place.<br><span class="segmentSeparator"></span>MidPoint is quite a unique software project and it would not be possible without you.<br><span class="segmentSeparator"></span>The whole Evolveum team would like to thank all past, present and future midPoint supporters for making this exciting project a reality.<br><span class="segmentSeparator"></span>Together we have created interesting and useful software product.<br><span class="segmentSeparator"></span>We hope that together we can make midPoint even better.</p>
</div>
<div class="paragraph">
<p>Thank you all.</p>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 2.0<br>
Last updated 2020-01-30 11:27:44 +0100
</div>
</div>
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid currentColor;opacity:.35;padding:0 .5em 0 0}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>

<iframe id="nr-ext-rsicon" style="position: absolute; display: none; width: 50px; height: 50px; z-index: 2147483647; border-style: none; background: transparent;" src="./Practical Identity Management With MidPoint_files/saved_resource.html"></iframe><div id="eJOY__extension_root" style="all: unset;"></div></body><div class="XTranslate"></div></html>